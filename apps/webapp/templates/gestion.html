<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gestión • {{ gym_name }}</title>
  <link rel="stylesheet" href="/static/style.css" />
  <link rel="stylesheet" href="/theme.css" />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
  <script>
    (function(){
      function loadScript(src){
        return new Promise(function(resolve, reject){
          try {
            var s = document.createElement('script');
            s.src = src; s.async = true;
            s.onload = function(){ resolve(true); };
            s.onerror = function(){ reject(new Error('Failed to load ' + src)); };
            document.head.appendChild(s);
          } catch(e){ reject(e); }
        });
      }
      // Cargador dinámico de SheetJS (XLSX)
      async function loadSheetJSLib(){
        if (window.XLSX) return true;
        var sources = [
          'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js',
          'https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js',
          '/static/libs/xlsx.full.min.js'
        ];
        for (var i=0; i<sources.length; i++){
          try {
            await loadScript(sources[i]);
            if (window.XLSX) return true;
          } catch(_){ }
        }
        return false;
      }
      async function loadQRCodeLib(){
        if (window.QRCode) return true;
        var sources = [
          'https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js',
          'https://unpkg.com/qrcode@1.5.1/build/qrcode.min.js',
          'https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.1/qrcode.min.js',
          '/static/libs/qrcode.min.js'
        ];
        for (var i=0; i<sources.length; i++){
          try {
            await loadScript(sources[i]);
            if (window.QRCode) return true;
          } catch(_){}
        }
        return false;
      }
      try { window.loadQRCodeLib = loadQRCodeLib; window.loadSheetJSLib = loadSheetJSLib; } catch(_){}
      // Intento inicial de carga (no bloqueante)
      try { loadQRCodeLib(); } catch(_){}
    })();
  </script>
  <script>
    // Interceptar guardado de rutina/plantilla para confirmar cuando se crea desde cero
    document.addEventListener('DOMContentLoaded', () => {
      // Ocultar y desactivar acciones de asignar/desasignar en panel lateral
      const sideAssign = document.getElementById('rutina-side-assign');
      const sideUnassign = document.getElementById('rutina-side-unassign');
      if(sideAssign){ sideAssign.style.display='none'; sideAssign.disabled = true; }
      if(sideUnassign){ sideUnassign.style.display='none'; sideUnassign.disabled = true; }

      const saveBtnEl = document.getElementById('rutina-preview-save');
      if(saveBtnEl){
        saveBtnEl.addEventListener('click', (e) => {
          try{
            const d = (window.state && (window.state.rutinaPreviewDraft || window.state.rutinaPreview)) || {};
            if(d && !d.id && d._createdFromScratch){
              const ok = window.confirm('Guardar como plantilla?');
              if(!ok){
                showToast('Guardado cancelado', 'info', 2500);
                e.preventDefault();
                e.stopImmediatePropagation();
              }
            }
          }catch(_){/* noop */}
        }, true);
      }
    });
  </script>
    <script src="/static/js/toast.js"></script>
    <script src="/static/js/ui.js"></script>
  <script>
    (function(){
      window.addEventListener('DOMContentLoaded', async function(){
        try{
          var r = await fetch('/api/admin/reminder', { credentials: 'same-origin' });
          if(!r.ok) return; var j = await r.json();
          if(j && j.active && j.message && typeof window.showToast === 'function'){
            window.showToast(String(j.message), 'info', 9000, 'Cerrar');
          }
        }catch(_){ }
      });
    })();
  </script>
  <script>
    (function(){
      window.addEventListener('DOMContentLoaded', async function(){
        try{
          var r = await fetch('/api/gym/subscription', { credentials: 'same-origin' });
          if(!r.ok) return; var j = await r.json();
          var s = j && j.subscription; if(!s) return;
          var nd = s.next_due_date; if(!nd) return;
          var days = j.days_until_due; if(typeof days !== 'number'){ try{ var d = new Date(nd + 'T00:00:00Z'); var now = new Date(); days = Math.ceil((d - now) / 86400000); }catch(_){ days = null; } }
          if(days !== null && days <= 7){ if(typeof window.showToast === 'function'){ window.showToast('La suscripción del sistema vence el ' + nd + '.', 'warning', 8000, 'Cerrar'); } }
          if(days !== null && days < 0){ if(typeof window.showToast === 'function'){ window.showToast('La suscripción del sistema está vencida desde ' + nd + '.', 'error', 9000, 'Cerrar'); } }
        }catch(_){ }
      });
    })();
  </script>
    <script>
      (function () {
        const TODAY_KEY = new Date().toISOString().slice(0, 10);
        const STORAGE_KEY = "delinq_alerts_checked_date";
        if (sessionStorage.getItem(STORAGE_KEY) === TODAY_KEY) return;

        window.addEventListener("DOMContentLoaded", async () => {
          try {
            const resp = await fetch("/api/delinquency_alerts_recent", { credentials: "same-origin" });
            if (!resp.ok) return;
            const data = await resp.json();
            const alerts = Array.isArray(data?.alerts) ? data.alerts : [];
            if (alerts.length === 0) {
              sessionStorage.setItem(STORAGE_KEY, TODAY_KEY);
              return;
            }

            const names = alerts.map(a => a.usuario_nombre || a.usuario_id).filter(Boolean);
            const uniqueNames = Array.from(new Set(names));
            const listed = uniqueNames.slice(0, 5).join(", ");
            const more = uniqueNames.length > 5 ? ` y ${uniqueNames.length - 5} más` : "";
            const msg = uniqueNames.length
              ? `Usuarios desactivados por morosidad hoy: Se registraron ${alerts.length} alertas. Afectados: ${listed}${more}.`
              : `Usuarios desactivados por morosidad hoy: Se registraron ${alerts.length} alertas.`;

            if (typeof window.showToast === "function") {
              window.showToast(msg, "warning", 8000, "Cerrar");
            }
            sessionStorage.setItem(STORAGE_KEY, TODAY_KEY);
          } catch (err) {
            // Silencioso: no bloquear la UI por errores en el toast
          }
        });
      })();
    </script>
  <link rel="icon" href="{{ logo_url }}" />
  <meta name="theme-color" content="{{ theme['--primary'] if theme and '--primary' in theme else '#2b8a3e' }}">
  <meta name="color-scheme" content="dark light">
  <style>
    .layout { display:flex; flex-direction:column; min-height:100vh; min-height: 100dvh; }
    header { display:flex; flex-direction:column; gap:8px; padding:16px 24px; border-bottom:1px solid var(--border); backdrop-filter: blur(8px); position: sticky; top:0; z-index:10; background: rgba(17,24,39,0.75); transition: transform 160ms ease; }
    .brand { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .brand .info { display:flex; align-items:center; gap:8px; }
    .brand img { width:32px; height:32px; }
    .nav-actions { display:flex; gap:8px; align-items:center; }
    /* Logout más compacto */
    .nav-actions .btn.icon-only { padding: 4px; }
    .nav-actions img { width: 20px; height: 20px; }
    .tabs { display:flex; align-items:center; gap: 4px; padding: 6px 24px; border-bottom: 1px solid var(--border); overflow-x:auto; -webkit-overflow-scrolling: touch; }
    .tab { appearance:none; background: transparent; border: none; color: var(--muted); padding: 10px 14px; border-radius: 10px 10px 0 0; cursor:pointer; font-weight: 600; position: relative; transition: color .15s ease, background .15s ease; }
    .tab:hover { color: var(--text); background: rgba(255,255,255,0.04); }
    .tab.active { color: var(--text); }
    .tab.active::after { content: ""; position: absolute; left: 10px; right: 10px; bottom: -1px; height: 3px; background: linear-gradient(90deg, var(--primary), var(--accent)); border-radius: 2px; }

    /* Subtabs - segmented control */
    .subtabs { display:flex; gap:6px; padding:6px; border-radius: 12px; border:1px solid var(--border); background: rgba(17,24,39,0.6); }
    .subtabs .btn.tertiary { background: transparent; color: var(--muted); border: none; padding: 8px 10px; border-radius: 10px; transition: background .15s ease, color .15s ease, box-shadow .15s ease; }
    .subtabs .btn.tertiary:hover { background: rgba(255,255,255,0.05); color: var(--text); }
    .subtabs .btn.tertiary.active { background: rgba(37,99,235,0.15); color: var(--text); box-shadow: inset 0 0 0 1px var(--primary); }

    /* Chips */
    .chips { display:flex; gap:6px; flex-wrap:wrap; }
    .chip { display:inline-flex; align-items:center; gap:6px; padding: 6px 10px; border-radius: 999px; background: rgba(255,255,255,0.06); border: 1px solid var(--border); transition: background .15s ease, border-color .15s ease; }
    .chip-remove { background: transparent; border: none; color: var(--muted); cursor: pointer; padding: 0; }
    .chip-remove:hover { color: var(--accent); }

     .chip:hover { background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.25); }
     .chips .chip[data-suggest] { cursor: pointer; }
     .chips .chip[data-suggest]:hover { background: rgba(37,99,235,0.18); border-color: rgba(37,99,235,0.35); }

    /* Badge por categoría de rutina */
    .badge.cat-badge { display:inline-block; padding:2px 8px; border-radius:12px; border:1px solid var(--border); font-size:12px; line-height:1; }
    .badge.cat-badge[data-cat="general"] { background: rgba(99,102,241,0.16); color: var(--text); }
    .badge.cat-badge[data-cat="fuerza"], .badge.cat-badge[data-cat="strength"] { background: rgba(34,197,94,0.16); color: var(--text); }
    .badge.cat-badge[data-cat="hipertrofia"], .badge.cat-badge[data-cat="hypertrophy"] { background: rgba(236,72,153,0.16); color: var(--text); }
    .badge.cat-badge[data-cat="cardio"] { background: rgba(59,130,246,0.16); color: var(--text); }
    .badge.cat-badge[data-cat="rehabilitacion"], .badge.cat-badge[data-cat="rehab"] { background: rgba(245,158,11,0.18); color: var(--text); }

    /* States list */
    .state-item { display:flex; align-items:center; justify-content: space-between; gap: 8px; padding: 8px 10px; border: 1px dashed var(--border); border-radius: 10px; transition: background .15s ease, border-color .15s ease; }
    .state-item .left { display:flex; align-items:center; gap:8px; }
    .state-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--accent); flex: 0 0 auto; }
    .state-name { font-weight: 600; }
    .state-meta { color: var(--muted); margin-left: 6px; font-size: 12px; }
    .state-item.expired { opacity: 0.75; }
    .state-item:hover { background: rgba(255,255,255,0.03); border-color: var(--border); }
    .counter { font-size: 12px; color: var(--muted); }
    .empty-hint { color: var(--muted); font-size: 13px; }
    .hl { background: rgba(37,99,235,0.25); border-radius: 4px; padding: 0 2px; }
    .btn.small { padding: 6px 10px; font-size: 12px; border-radius: 8px; }
    main { flex: 1; padding: 16px 24px; width: 100%; max-width: 100%; min-height: 0; overflow-x: hidden; overflow-y: auto; }
    .panel { display:none; }
    .panel.active { display:block; }
    .panel-controls { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom: 12px; }
    .panel-controls > * { min-width: 0; max-width: 100%; flex: 1 1 auto; }
    .panel-controls input[type="date"],
    .panel-controls input[type="text"],
    .panel-controls select { background: #0b1220; color: var(--text); border: 1px solid var(--border); border-radius: 10px; padding: 8px 10px; }
    table { width:100%; border-collapse: collapse; }
    th, td { padding: 10px; border-bottom: 1px solid var(--border); text-align: left; }
    th { color: var(--muted); font-weight: 600; }
    .muted { color: var(--muted); }
    *, *::before, *::after { box-sizing: border-box; }
    html, body { width: 100%; max-width: 100%; }
    /* Tarjetas y tablas mejoradas */
    .cards { display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 16px; align-items: stretch; max-width: 100%; }
    .cards > * { min-width: 0; }
    .card { padding: 12px; background: var(--card); border: 1px solid var(--border); border-radius: 12px; min-width: 0; }
    .card-title { font-size: 12px; color: var(--muted); }
    .card-value { font-size: 20px; font-weight: 600; margin-top: 6px; }
    .table-scroll { overflow:auto; overflow-x:auto; overflow-y:auto; width:100%; max-width:100%; max-height:60vh; border: 1px solid var(--border); border-radius: 12px; -webkit-overflow-scrolling: touch; }
     .table-scroll thead th { position: sticky; top: 0; background: rgba(17,24,39,0.9); backdrop-filter: blur(4px); }
     .table-scroll table { table-layout: auto; width: max-content; min-width: 100%; }
     .table-scroll th, .table-scroll td { overflow-wrap: normal; word-break: normal; white-space: normal; }
     .table-actions { display:flex; gap:8px; justify-content:flex-end; flex-wrap: nowrap; white-space: nowrap; min-width: max-content; }
     .table-actions .btn { margin: 0; flex: 0 0 auto; }
    /* Modales */
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: var(--z-modal-backdrop); }
    /* Elevar el modal de configuración de numeración por encima del de vista previa */
    #modal-recibo-config { z-index: calc(var(--z-modal-backdrop) + 1); }
    .modal { width: 640px; max-width: 95vw; background: var(--card); border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 20px 30px rgba(0,0,0,0.35); overflow: hidden; display:flex; flex-direction:column; }
    .modal-header { display:flex; align-items:center; justify-content:space-between; padding: 12px 16px; border-bottom: 1px solid var(--border); }
    .modal-body { padding: 16px; flex: 1 1 auto; overflow-y: auto; }
    .modal-footer { display:flex; gap:8px; padding: 12px 16px; border-top: 1px solid var(--border); justify-content: flex-end; }
    .modal-backdrop.active { display:flex; }
    .input-row { display:flex; gap:8px; flex-wrap:wrap; }
    .input-row > * { min-width: 0; }
    /* Split panel layout */
    .split { display:grid; grid-template-columns: minmax(0,1fr) 380px; gap:16px; align-items:start; }
    .split-main { min-width: 0; }
    .split-side { position: sticky; top: 96px; height: auto; overflow: visible; }
    .block { background: var(--card); border: 1px solid var(--border); border-radius: 12px; max-width: 100%; }
    .block-header { display:flex; align-items:center; justify-content:space-between; gap:8px; padding: 10px 12px; border-bottom: 1px solid var(--border); }
    .block-body { padding:12px; }
    .side-empty { color: var(--muted); padding: 16px; }
    .row-selectable tr:hover { background: rgba(255,255,255,.04); cursor: pointer; }
    .table-compact th, .table-compact td { padding: 8px; word-break: break-word; }
    @media (max-width: 960px){ .split { grid-template-columns: 1fr; } .split-side { position: static; height:auto; } }
    @media (max-width: 640px){
      header { padding: 12px; }
      main { padding: 12px; }
      .brand { flex-direction: column; align-items: flex-start; gap: 10px; }
      .nav-actions { width: 100%; justify-content: flex-end; }
      .modal { width: 95vw; margin: 0 8px; max-height: 90vh; }
      .input-row { flex-direction: column; }
      .input-row > * { flex: 1 1 100%; width: 100%; }
      .panel-controls { flex-direction: column; align-items: stretch; }
      .panel-controls > * { width: 100%; }
      .tabs { flex-wrap: wrap; width: 100%; }
      .table-scroll { max-height: 60vh; }
    }
    @media (max-width: 768px){
      .cards { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 480px){
      .cards { grid-template-columns: 1fr; }
    }
    /* Botón pequeño y variantes */
    .btn.sm { padding: 6px 10px; font-size: 12px; border-radius: 8px; }
    .btn.icon-only { padding: 6px; border-radius: 8px; background: transparent; }
    .btn.icon-only:hover { background: rgba(255,255,255,0.06); }
    .btn[disabled] { opacity: 0.55; cursor: not-allowed; }
    /* Toasts */
    .toast-container { position: fixed; top: 16px; right: 16px; display: flex; flex-direction: column; gap: 8px; z-index: var(--z-toast); pointer-events: none; }
    /* Centrar toasts cuando el modal de QR está activo */
    .qr-toast-open #toast-container { left: 50%; transform: translateX(-50%); right: auto; }
    .toast { pointer-events: all; background: var(--card); border: 1px solid var(--border); border-left: 4px solid var(--accent); border-radius: 10px; padding: 10px 12px; min-width: 240px; max-width: 400px; box-shadow: 0 12px 24px rgba(0,0,0,0.35); display: flex; align-items: center; justify-content: space-between; gap: 8px; }
    .toast .message { flex: 1; }
    .toast .actions { display: flex; gap: 8px; }
    .toast.success { border-left-color: var(--accent); }
    .toast.warning { border-left-color: #f59e0b; }
    .toast.error { border-left-color: #ef4444; }
    /* Tabs hover */
    .tab:hover { background: rgba(255,255,255,.12); }
    .header--hidden { transform: translateY(-100%); }

    /* Zebra stripes y selección */
    .table-scroll tbody tr:nth-child(odd){ background: rgba(255,255,255,.03); }
    .row-selectable tr.selected{ background: rgba(139,120,185,.16); outline: 1px solid rgba(139,120,185,.45); }
    /* Handle visual para filas arrastrables */
    .handle{ font-weight: 600; letter-spacing: 1px; }
    .handle:active{ cursor: grabbing; }
    /* Indicador de zona de drop en el bloque de ejercicios */
    #clase-ej-bloque-table tbody.drag-over{ background: rgba(89,160,255,0.08); outline: 2px dashed rgba(89,160,255,0.6); transition: background .18s ease; }
    /* Indicador cuando se suelta sobre el mensaje vacío del bloque */
    #clase-ej-bloque-empty.drag-over{ background: rgba(89,160,255,0.08); outline: 2px dashed rgba(89,160,255,0.6); transition: background .18s ease; }
    /* Indicadores simétricos para el catálogo (tabla izquierda) */
    #clase-ej-list-table tbody.drag-over{ background: rgba(89,160,255,0.08); outline: 2px dashed rgba(89,160,255,0.6); transition: background .18s ease; }
    #clase-ej-list-empty.drag-over{ background: rgba(89,160,255,0.08); outline: 2px dashed rgba(89,160,255,0.6); transition: background .18s ease; }
    /* Pulso suave para drop-zones (ambas tablas) */
    @keyframes dropPulse { 0% { box-shadow: inset 0 0 0 0 rgba(89,160,255,0.0); } 50% { box-shadow: inset 0 0 0 6px rgba(89,160,255,0.12); } 100% { box-shadow: inset 0 0 0 0 rgba(89,160,255,0.0); } }
    #clase-ej-bloque-table tbody.drag-over,
    #clase-ej-bloque-empty.drag-over,
    #clase-ej-list-table tbody.drag-over,
    #clase-ej-list-empty.drag-over { animation: dropPulse 1.2s ease-in-out infinite; }
    @media (prefers-reduced-motion: reduce){
      #clase-ej-bloque-table tbody.drag-over,
      #clase-ej-bloque-empty.drag-over,
      #clase-ej-list-table tbody.drag-over,
      #clase-ej-list-empty.drag-over { animation: none; }
    }
    /* Animación sutil al insertar/reordenar filas del bloque */
    @keyframes fadeSlideIn { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; transform: translateY(0); } }
    #clase-ej-bloque-table tbody tr.animate-in{ animation: fadeSlideIn 180ms ease-out; }
    @media (prefers-reduced-motion: reduce){ #clase-ej-bloque-table tbody tr.animate-in{ animation: none; } }
    /* Animaciones toast */
    @keyframes toast-in { from { opacity: 0; transform: translateY(-6px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes toast-out { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-6px); } }
    /* Animaciones modal */
    @keyframes modal-in { from { opacity: 0; transform: translateY(-6px) scale(.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
    @keyframes modal-out { from { opacity: 1; transform: translateY(0) scale(1); } to { opacity: 0; transform: translateY(-6px) scale(.98); } }
    .modal-backdrop.active .modal{ animation: modal-in 180ms ease-out; }
    .modal.closing{ animation: modal-out 160ms ease-in forwards; }
    /* Mini loader overlay */
    #usuario-side{ position: relative; }
    .loader-overlay{ position:absolute; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,0.35); backdrop-filter: blur(2px); z-index: 5; }
    .loader-overlay.active{ display:flex; }
    .loader-overlay .spinner{ width:24px; height:24px; border:3px solid var(--border); border-top-color: var(--info); border-radius:50%; animation: spin .8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Spinner pequeño para botones */
    .btn-spinner{ display:inline-block; width:14px; height:14px; border:2px solid var(--border); border-top-color: var(--info); border-radius:50%; animation: spin .8s linear infinite; vertical-align: middle; }

    /* Overrides: hover chips border accent unificado */
    .chip:hover { border-color: var(--accent); }

    /* Microajuste: chips sugeridos con fondo cálido y borde de acento */
    .chips .chip[data-suggest]:hover { background: rgba(176,125,93,0.18); border-color: var(--accent); }

    /* Overrides de layout para scroll: sidebar fijo y main desplazable */
    .layout { overflow: hidden; }
    .app-shell { display: grid; grid-template-columns: 280px 1fr; gap: 0; flex: 1 1 auto; min-height: 0; overflow: hidden; }
    .sidebar { position: sticky; top: 0; height: 100%; overflow: hidden; }
    .main { overflow: auto; height: 100%; min-height: 0; -webkit-overflow-scrolling: touch; }
    /* Modo móvil: ocultar sidebar y usar una sola columna */
    @media (max-width: 960px){
      .app-shell { grid-template-columns: 1fr; }
      .sidebar { display: none; }
    }

    /* Indicador de sesión tipo "pill" con pulso cuando está activa */
.session-indicator { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background: rgba(139,120,185,0.12); color: var(--info); border:1px solid rgba(139,120,185,0.35); transition: background .2s ease, color .2s ease, box-shadow .2s ease; }
.session-indicator::before { content:""; width:8px; height:8px; border-radius:50%; background: var(--info); }
.session-indicator.active { animation: pulse-glow 2s ease-in-out infinite; }
.session-indicator.inactive { background: rgba(239,68,68,0.12); color:#ef4444; border-color: rgba(239,68,68,0.35); }
.session-indicator.inactive::before { background:#ef4444; }
.session-chip { display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; background: rgba(255,255,255,0.08); border:1px solid var(--border); color: inherit; }
.session-chip i { opacity:.85; }
.session-state { opacity:.9; }
    @keyframes pulse-glow { 0% { box-shadow: 0 0 0 0 rgba(139,120,185,0.0);} 50% { box-shadow: 0 0 0 8px rgba(139,120,185,0.12);} 100% { box-shadow: 0 0 0 0 rgba(139,120,185,0.0);} }

    /* Reloj de duración con flip ligero y dos puntos parpadeantes */
    .duration-timer { display:inline-flex; align-items: baseline; gap:6px; font-variant-numeric: tabular-nums; }
    .duration-group { display:inline-flex; align-items:center; gap:4px; }
    .duration-digit { display:inline-block; min-width:.85em; padding:2px 6px; border-radius:8px; background: rgba(255,255,255,0.06); border:1px solid var(--border); transform-origin: top; }
    .duration-digit.flip { animation: flipIn .6s ease; }
    @keyframes flipIn { 0% { transform: rotateX(-90deg); opacity:0; } 50% { transform: rotateX(15deg); opacity:.85; } 100% { transform: rotateX(0deg); opacity:1; } }
    .duration-sep { opacity:.6; animation: blink 1s steps(1,end) infinite; }
    @keyframes blink { 50% { opacity:.2; } }

  </style>
  <style>
    /* Ocultar acciones de asignar/desasignar según nuevo flujo */
    button[data-action="assign-template"],
    button[data-action="assign"],
    button[data-action="unassign"],
    #rutina-side-assign,
    #rutina-side-unassign {
      display: none !important;
    }
    /* Ocultar subtabs de rutinas en escritorio; mostrar en móvil como selector superior */
    #rutinas-subtabs { display: none; }
    @media (max-width: 960px){
      #rutinas-subtabs { display: flex !important; gap: 8px; align-items: center; }
    }
    /* Barra superior móvil que replica la sidebar (todas las subpestañas) */
    #mobile-subtabs { display: none; }
    @media (max-width: 960px){
      .mobile-subtabs-open #mobile-subtabs { display:flex; gap:8px; align-items:center; padding:8px 12px; border-bottom:1px solid var(--border); background: var(--bg); position: sticky; top: 0; z-index: var(--z-header); overflow-x: auto; -webkit-overflow-scrolling: touch; animation: mobileSubtabsFade .18s ease-out; }
      @media (prefers-reduced-motion: reduce){ .mobile-subtabs-open #mobile-subtabs { animation: none; } }
      .mobile-subtabs-open #mobile-subtabs.compact { padding:4px 8px; gap:6px; }
      #mobile-subtabs .btn { white-space: nowrap; font-size: 14px; padding:6px 10px; position: relative; flex: 0 0 auto; touch-action: manipulation; }
      .mobile-subtabs-open #mobile-subtabs.compact .btn { font-size: 13px; padding:4px 8px; }
      #mobile-subtabs .btn.active { background: rgba(139,120,185,0.12); border-color: var(--info); color: var(--info); }
      #mobile-subtabs .btn.active::after { content: ""; position: absolute; left:8px; right:8px; bottom:0; height:2px; background: var(--info); border-radius: 2px; }
      /* Peek semitransparente cuando barra está oculta */
      #mobile-subtabs-peek { display:none; position: sticky; top: 0; z-index: var(--z-header); padding:6px 12px; background: var(--bg); border-bottom:1px solid var(--border); }
      body:not(.mobile-subtabs-open) #mobile-subtabs-peek { display:flex; gap:8px; align-items:center; justify-content:flex-start; opacity: 0.7; }
      body:not(.mobile-subtabs-open) #mobile-subtabs-peek:hover { opacity: 1; }
      #mobile-subtabs-peek .btn { font-size: 13px; padding:4px 8px; }
      @keyframes mobileSubtabsFade { from { opacity: 0; transform: translateY(-6px); } to { opacity: 1; transform: translateY(0); } }
    }
    /* Ocultar selector móvil de módulos en escritorio explícitamente */
    @media (min-width: 961px){
      #mobile-subtabs,
      #mobile-subtabs-peek { display: none !important; }
    }
  </style>
</head>
<body>
  <a href="#main-content" class="skip-link">Saltar al contenido</a>
  <div class="layout">
    <header id="main-header" class="app-header">
      <div class="brand">
        <div class="info">
          <img src="{{ logo_url }}" alt="Logo" />
          <div>
            <h1 style="margin:0; font-size: 18px;">Gestión • {{ gym_name }}</h1>
            <p class="muted" style="margin:2px 0 0 0">Gestión centralizada</p>
          </div>
        </div>
        <div class="nav-actions">
          <span id="login-current" class="muted" style="margin-right:12px"
                data-role="{{ 'profesor' if (request.session.get('gestion_profesor_id') or request.session.get('gestion_profesor_user_id')) else ('dueño' if request.session.get('logged_in') else '') }}"
                data-prof-id="{{ request.session.get('gestion_profesor_id') or '' }}"
                data-prof-uid="{{ request.session.get('gestion_profesor_user_id') or '' }}">Sesión: —</span>
          <button class="btn outline neutral icon-only" data-sidebar-toggle aria-label="Mostrar/ocultar navegación" aria-controls="mobile-subtabs" aria-expanded="false" title="Mostrar/ocultar navegación">
            <i class="bi bi-layout-sidebar" aria-hidden="true"></i>
          </button>
          <a id="logout-link" class="btn outline neutral icon-only" href="/gestion/logout" title="Cerrar sesión" aria-label="Salir" onclick="try{var el=document.getElementById('login-current');var r=(el&&(el.getAttribute('data-role')||'').trim())||'';if(r==='profesor'){try{populateSesionFinModal();}catch(_){ }try{openModal('modal-sesion-fin');}catch(_){ }setTimeout(function(){try{var m=document.getElementById('modal-sesion-fin');var cs=m?window.getComputedStyle(m):null;var visible=!!(m && cs && cs.display!=='none' && cs.visibility!=='hidden' && m.getClientRects && m.getClientRects().length>0);if(!visible && m && m.parentElement && m.parentElement.tagName && m.parentElement.tagName.toLowerCase()!=='body'){ try{ document.body.appendChild(m); m.classList.add('active'); m.setAttribute('aria-hidden','false'); visible=!!(m.getClientRects && m.getClientRects().length>0); }catch(__){} }if(!visible){fetch('/api/profesor_sesion_fin',{method:'POST',headers:{'Accept':'application/json','Content-Type':'application/json'}}).finally(function(){try{window.location.href='/gestion/logout';}catch(__){}});} }catch(__){ try{window.location.href='/gestion/logout';}catch(__){} }},160);return false;}}catch(__){return true;}">
          <i class="bi bi-box-arrow-right" aria-hidden="true"></i>
          </a>
        </div>
      </div>
      <nav class="breadcrumbs" aria-label="Breadcrumbs" style="padding: 0 24px 6px;">
        <a href="/">Inicio</a>
        <span class="sep">/</span>
        <span>Gestión</span>
      </nav>
      <nav class="tabs">
        <button class="tab active" data-tab="usuarios">Usuarios</button>
        {% if request.session.get('logged_in') %}
        <button class="tab" data-tab="profesores" id="tab-btn-profesores">Profesores</button>
        {% endif %}
        <button class="tab" data-tab="clases">Clases</button>
        <button class="tab" data-tab="pagos">Pagos</button>
        <button class="tab" data-tab="ejercicios">Ejercicios</button>
        <button class="tab" data-tab="rutinas">Rutinas</button>
        <button class="tab" data-tab="configuracion">Configuración</button>
      </nav>
    </header>

    <div class="app-shell">
      <aside class="sidebar" aria-label="Navegación lateral">
        <div class="sidebar-header">
          <span class="nav-label">Módulos</span>
          <button class="btn icon-only ghost" data-sidebar-toggle aria-label="Colapsar barra" aria-controls="mobile-subtabs" aria-expanded="false" title="Colapsar barra"><i class="bi bi-layout-sidebar" aria-hidden="true"></i></button>
        </div>
        <nav class="nav-group">
          <a href="#" class="nav-item active" data-tab="usuarios"><i class="bi bi-people" aria-hidden="true"></i><span>Usuarios</span></a>
          {% if request.session.get('logged_in') %}
          <a href="#" class="nav-item" data-tab="profesores"><i class="bi bi-person-badge" aria-hidden="true"></i><span>Profesores</span></a>
          {% endif %}
          <a href="#" class="nav-item" data-tab="clases"><i class="bi bi-calendar-event" aria-hidden="true"></i><span>Clases</span></a>
          <a href="#" class="nav-item" data-tab="pagos"><i class="bi bi-cash-coin" aria-hidden="true"></i><span>Pagos</span></a>
          <a href="#" class="nav-item" data-tab="ejercicios"><i class="bi bi-bar-chart" aria-hidden="true"></i><span>Ejercicios</span></a>
          <a href="#" class="nav-item" data-tab="rutinas"><i class="bi bi-list-check" aria-hidden="true"></i><span>Rutinas</span></a>
          <a href="#" class="nav-item" data-tab="configuracion"><i class="bi bi-gear" aria-hidden="true"></i><span>Configuración</span></a>
        </nav>
      </aside>
      <main class="main" id="main-content">
      <nav id="mobile-subtabs" class="panel-controls" aria-label="Navegación móvil" aria-hidden="true">
        <button class="btn ghost" data-tab="usuarios" aria-controls="panel-usuarios">Usuarios</button>
        {% if request.session.get('logged_in') %}
        <button class="btn ghost" data-tab="profesores" aria-controls="panel-profesores">Profesores</button>
        {% endif %}
        <button class="btn ghost" data-tab="clases" aria-controls="panel-clases">Clases</button>
        <button class="btn ghost" data-tab="pagos" aria-controls="panel-pagos">Pagos</button>
        <button class="btn ghost" data-tab="ejercicios" aria-controls="panel-ejercicios">Ejercicios</button>
        <button class="btn ghost" data-tab="rutinas" aria-controls="panel-rutinas">Rutinas</button>
        <button class="btn ghost" data-tab="configuracion" aria-controls="panel-configuracion">Configuración</button>
      </nav>
      <div id="mobile-subtabs-peek" aria-hidden="false" aria-label="Abrir módulos">
        <button class="btn ghost" type="button"><i class="bi bi-chevron-down" aria-hidden="true"></i><span id="mobile-subtabs-peek-label" style="margin-left:6px">Módulos</span></button>
      </div>
      <section id="panel-pagos" class="panel">
        <div class="split">
          <div class="split-main">
            <div class="panel-controls">
              <label>Desde</label>
              <input type="date" id="pagos-start" />
              <label>Hasta</label>
              <input type="date" id="pagos-end" />
              <label>Búsqueda</label>
              <input type="text" id="pagos-q" placeholder="Nombre / DNI / Método / Concepto" />
              <select id="pagos-usuario" title="Filtrar por usuario"></select>
              <select id="pagos-limit">
                <option value="25">25</option>
                <option value="50" selected>50</option>
                <option value="100">100</option>
              </select>
              <button class="btn info" id="pagos-refresh">Actualizar</button>
              <button class="btn outline neutral" id="pagos-filtros-btn">Filtros avanzados</button>
              <button class="btn success" id="pagos-new">Nuevo Pago</button>
              <button class="btn info" id="pagos-export-csv">Exportar CSV</button>
              <div id="recibo-controls" style="margin-left:auto; display:flex; align-items:center; gap:10px">
                <span id="recibo-next" class="muted" title="Próximo número de recibo" style="padding:2px 8px; border:1px solid var(--border); border-radius:12px;">Recibo #—</span>
                <button class="btn outline neutral" id="recibo-config-btn" title="Configurar numeración" style="padding:6px 10px; display:inline-flex; align-items:center; gap:8px">
                  <i class="bi bi-gear" aria-hidden="true"></i>
                  <span style="font-size:12px">Numeración</span>
                </button>
                <span id="pagos-count" class="muted"></span>
              </div>
            </div>
            <div class="cards" id="pagos-cards">
              <div class="card"><div class="card-title">Pagos mostrados</div><div class="card-value" id="pagos-card-count">0</div></div>
              <div class="card"><div class="card-title">Monto total</div><div class="card-value" id="pagos-card-monto">$0</div></div>
              <div class="card"><div class="card-title">Pagadores únicos</div><div class="card-value" id="pagos-card-unique">0</div></div>
              <div class="card"><div class="card-title">Promedio por pago</div><div class="card-value" id="pagos-card-average">$0</div></div>
            </div>
            <div class="table-scroll row-selectable">
              <table id="pagos-table">
                <thead>
                  <tr>
                    <th>Fecha</th>
                    <th>Usuario</th>
                    <th>DNI</th>
                    <th>Método</th>
                    <th>Concepto</th>
                    <th>Monto</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
          <aside class="split-side">
            <div class="block">
              <div class="block-header">
                <div style="display:flex; align-items:center; gap:8px">
                  <h3 style="margin:0; font-size:16px;">Pago seleccionado</h3>
                  <span id="pago-side-id" class="muted"></span>
                </div>
                <button class="btn outline neutral" id="pagos-clear-selection">Limpiar</button>
              </div>
              <div class="block-body">
                <div id="pago-side-empty" class="side-empty">Selecciona un pago para ver detalles.</div>
                <div id="pago-side" style="display:none">
                  <div class="input-row">
                    <div style="flex:1"><label class="muted">Fecha</label><div id="pago-side-fecha"></div></div>
                    <div style="flex:1"><label class="muted">Monto</label><div id="pago-side-monto"></div></div>
                  </div>
                  <div class="input-row">
                    <div style="flex:1"><label class="muted">Usuario</label><div id="pago-side-nombre"></div></div>
                    <div style="flex:1"><label class="muted">DNI</label><div id="pago-side-dni"></div></div>
                  </div>
                  <div class="input-row">
                    <div style="flex:1"><label class="muted">Método</label><div id="pago-side-metodo"></div></div>
                    <div style="flex:1"><label class="muted">Concepto</label><div id="pago-side-concepto"></div></div>
                  </div>
                  <div style="margin-top:12px">
                    <h4 style="margin:0 0 8px 0; font-size:14px;">Items</h4>
                    <div class="table-scroll table-compact">
                      <table id="pago-detalles-table">
                        <thead><tr><th>Concepto</th><th>Cantidad</th><th>Precio</th><th>Subtotal</th></tr></thead>
                        <tbody></tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="block" style="margin-top:12px">
              <div class="block-header"><h3 style="margin:0; font-size:16px;">Acciones rápidas</h3></div>
              <div class="block-body">
                <div class="input-row">
                  <button class="btn info" id="pago-side-ver-usuario">Ver usuario</button>
                  <button class="btn info" id="pago-side-ver-detalle">Ver detalle</button>
                  <button class="btn info" id="pago-side-recibo">Ver recibo</button>
                  <button class="btn neutral" id="pago-side-editar">Editar pago</button>
                  <button class="btn danger" id="pago-side-eliminar">Eliminar pago</button>
                </div>
              </div>
            </div>
            <div class="block" style="margin-top:12px">
              <div class="block-header"><h3 style="margin:0; font-size:16px;">Notas</h3></div>
              <div class="block-body"><div id="pago-side-notas" class="muted">—</div></div>
            </div>
          </aside>
        </div>
      </section>

      <section id="panel-ejercicios" class="panel">
  <div class="split">
    <div class="split-main" style="flex:1 1 100%; width:100%">
      <div class="panel-controls">
        <label for="ejercicios-q">Búsqueda</label>
        <input type="text" id="ejercicios-q" placeholder="Nombre o descripción" />
        <label for="ejercicios-objetivo">Objetivo</label>
        <select id="ejercicios-objetivo">
          <option value="Todos">Todos</option>
          <option value="general" selected>General</option>
          <option value="fuerza">Fuerza</option>
          <option value="hipertrofia">Hipertrofia</option>
          <option value="resistencia">Resistencia</option>
          <option value="cardio">Cardio</option>
          <option value="flexibilidad">Flexibilidad</option>
        </select>
        <label for="ejercicios-grupo">Grupo</label>
        <select id="ejercicios-grupo">
          <option value="Todos">Todos</option>
          <option value="Pecho">Pecho</option>
          <option value="Espalda">Espalda</option>
          <option value="Hombros">Hombros</option>
          <option value="Brazos">Brazos</option>
          <option value="Piernas">Piernas</option>
          <option value="Glúteos">Glúteos</option>
          <option value="Core">Core</option>
          <option value="Full Body">Full Body</option>
        </select>
        <button class="btn" id="ejercicios-refresh">Actualizar</button>
        <button class="btn" id="ejercicios-new">Nuevo Ejercicio</button>
        <span id="ejercicios-count" class="muted" style="margin-left:auto"></span>
      </div>
      <div class="table-scroll row-selectable">
        <table id="ejercicios-table">
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Grupo muscular</th>
              <th>Objetivo</th>
              <th>Descripción</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <aside class="split-side">
      <div class="block">
        <div class="block-header"><h3 style="margin:0; font-size:16px;">Resumen del ejercicio</h3></div>
        <div class="block-body">
          <div><strong>Nombre:</strong> <span id="ejercicio-side-nombre">—</span></div>
          <div><strong>Objetivo:</strong> <span id="ejercicio-side-objetivo">—</span></div>
          <div><strong>Grupo:</strong> <span id="ejercicio-side-grupo">—</span></div>
          <div><strong>Descripción:</strong>
            <div id="ejercicio-side-descripcion" class="muted">—</div>
          </div>
          <div style="margin-top:8px">
        <button class="btn neutral" id="ejercicio-side-edit" disabled>Editar</button>
            <button class="btn" id="ejercicio-side-delete" disabled>Eliminar</button>
          </div>
        </div>
      </div>
      <div class="block">
        <div class="block-header"><h3 style="margin:0; font-size:16px;">Vista previa multimedia</h3></div>
        <div class="block-body">
          <div id="ejercicio-side-media"><p class="muted">Sin video</p></div>
        </div>
      </div>
      <div class="block">
        <div class="block-header"><h3 style="margin:0; font-size:16px;">Consejos de ejecución</h3></div>
        <div class="block-body">
          <ul id="ejercicio-side-tips" style="padding-left:18px; margin:0"><li class="muted">Selecciona un ejercicio para ver consejos</li></ul>
        </div>
      </div>
      <div class="block">
        <div class="block-header">
          <h3 style="margin:0; font-size:16px;">Equipamiento sugerido</h3>
          <div class="panel-controls" style="margin-left:auto">
            <button class="btn small" id="ejercicio-side-edit-extras" disabled>Editar extras</button>
          </div>
        </div>
        <div class="block-body">
          <ul id="ejercicio-side-equipos" style="padding-left:18px; margin:0"><li class="muted">—</li></ul>
        </div>
      </div>
      <div class="block">
        <div class="block-header"><h3 style="margin:0; font-size:16px;">Variantes útiles</h3></div>
        <div class="block-body">
          <ul id="ejercicio-side-variantes" style="padding-left:18px; margin:0"><li class="muted">—</li></ul>
        </div>
      </div>
    </aside>
  </div>
</section>

<section id="panel-rutinas" class="panel">
  <div class="split" style="grid-template-columns: 1fr;">
    <div class="split-main">
      <div class="panel-controls" id="rutinas-subtabs" style="margin-bottom:8px; display:flex; gap:8px; align-items:center">
        <button class="btn small" data-rutinas-tab="plantillas" id="rutinas-tab-plantillas">Plantillas</button>
        <button class="btn small secondary" data-rutinas-tab="usuario" id="rutinas-tab-usuario">Rutinas de usuario</button>
      </div>
      <div class="panel-controls" style="display:flex; align-items:center; gap:8px">
        <button class="btn" id="rutinas-refresh">Actualizar</button>
        <button class="btn info" id="rutinas-export-csv">Exportar CSV</button>
        <div style="display:flex; align-items:center; gap:6px">
          <div style="display:flex; align-items:center; gap:6px">
            <label for="rutinas-q" class="muted" style="white-space:nowrap">Búsqueda</label>
            <input type="text" id="rutinas-q" placeholder="Nombre o descripción" />
          </div>
          <div style="display:flex; align-items:center; gap:6px">
            <label for="rutinas-categoria" class="muted" style="white-space:nowrap">Categoría</label>
            <select id="rutinas-categoria">
              <option value="">Todas</option>
              <option value="general" selected>General</option>
              <option value="fuerza">Fuerza</option>
              <option value="hipertrofia">Hipertrofia</option>
              <option value="resistencia">Resistencia</option>
              <option value="fullbody">Full body</option>
            </select>
          </div>
        </div>
        <button class="btn" id="rutinas-new">Nueva</button>
        <button class="btn secondary" id="rutinas-new-template">Nueva Plantilla</button>
        <span id="rutinas-count" class="muted" style="margin-left:auto"></span>
      </div>
      <div class="table-scroll row-selectable">
        <table id="rutinas-table">
          <thead>
            <tr>
              <th class="th-sortable" data-sort="nombre">Nombre</th>
              <th class="th-sortable" data-sort="descripcion">Descripción</th>
              <th class="th-sortable" data-sort="dias">Días</th>
              <th class="th-sortable" data-sort="categoria">Categoría</th>
              <th class="th-sortable" data-sort="ejercicios"># Ejercicios</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="block" id="rutinas-usuario-block" style="margin-top:12px; display:none">
        <div class="block-header" style="display:flex; align-items:center; gap:12px">
          <h3 style="margin:0; font-size:16px;">Rutinas</h3>
          <div class="panel-controls" style="margin-left:auto; display:flex; gap:8px; align-items:center">
            <label for="rutinas-usuario" id="rutinas-usuario-label" style="white-space:nowrap">Usuario</label>
            <select id="rutinas-usuario"><option value="">Todos</option></select>
          </div>
        </div>
        <div class="block-body">
          <div class="table-scroll">
            <table id="rutinas-usuario-table">
              <thead>
                <tr>
                  <th>Rutina</th>
                  <th>Días</th>
                  <th>Categoría</th>
                  <th>Fecha de creación</th>
                  <th>Activa</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<section id="panel-usuarios" class="panel active">
        <div class="split">
          <div class="split-main">
            <div class="cards" id="usuarios-cards">
              <div class="card"><div class="card-title">Total usuarios mostrados</div><div class="card-value" id="usuarios-card-count">0</div></div>
              <div class="card"><div class="card-title">Activos</div><div class="card-value" id="usuarios-card-activos">0</div></div>
              <div class="card"><div class="card-title">Inactivos</div><div class="card-value" id="usuarios-card-inactivos">0</div></div>
              <div class="card"><div class="card-title">Profesores</div><div class="card-value" id="usuarios-card-profesores">0</div></div>
              <div class="card"><div class="card-title">Sin teléfono</div><div class="card-value" id="usuarios-card-sin-telefono">0</div></div>
              <div class="card"><div class="card-title">Con notas</div><div class="card-value" id="usuarios-card-con-notas">0</div></div>
            </div>
            <div class="panel-controls">
              <label>Búsqueda</label>
              <input type="text" id="usuarios-q" placeholder="Nombre o DNI" />
              <select id="usuarios-limit">
                <option value="25">25</option>
                <option value="50" selected>50</option>
                <option value="100">100</option>
              </select>
              <button class="btn" id="usuarios-refresh">Actualizar</button>
              <button class="btn" id="usuarios-new">Nuevo Usuario</button>
        <button class="btn info" id="usuarios-export-csv">Exportar CSV</button>
              <span id="usuarios-count" class="muted" style="margin-left:auto"></span>
            </div>
            <div class="table-scroll row-selectable">
              <table id="usuarios-table">
                <thead>
                  <tr>
                    <th>Nombre</th>
                    <th>DNI</th>
                    <th>Teléfono</th>
                    <th>Rol</th>
                    <th>Tipo Cuota</th>
                    <th>Activo</th>
                    <th>Asistencia</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
          <aside class="split-side">
            <div class="block">
              <div class="block-header">
                <div style="display:flex; align-items:center; gap:8px">
                  <h3 style="margin:0; font-size:16px;">Usuario seleccionado</h3>
                  <span id="usuario-side-id" class="muted"></span>
                </div>
        <button class="btn outline neutral" id="usuarios-clear-selection">Limpiar</button>
              </div>
              <div class="block-body">
                <div id="usuario-side-empty" class="side-empty">Selecciona un usuario para ver sus datos y pagos.</div>
                <div id="usuario-side" style="display:none">
                  <div id="usuario-side-loader" class="loader-overlay"><div class="spinner"></div><span style="margin-left:8px">Cargando…</span></div>
                  <div class="cards" style="grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));">
                    <div class="card"><div class="card-title">Estado</div><div class="card-value" id="usuario-side-estado">—</div></div>
                    <div class="card"><div class="card-title">Próximo vencimiento</div><div class="card-value" id="usuario-side-vencimiento">—</div></div>
                    <div class="card"><div class="card-title">Cuotas vencidas</div><div class="card-value" id="usuario-side-cuotas-vencidas">—</div></div>
                    <div class="card"><div class="card-title">Asistencias recientes (30d)</div><div class="card-value" id="usuario-side-asistencias-recientes">—</div></div>
                  </div>
                  <div class="input-row" style="margin-top:8px">
                    <div style="flex:1"><label class="muted">Nombre</label><div id="usuario-side-nombre"></div></div>
                    <div style="flex:1"><label class="muted">DNI</label><div id="usuario-side-dni"></div></div>
                  </div>
                  <div class="input-row">
                    <div style="flex:1"><label class="muted">Teléfono</label><div id="usuario-side-telefono"></div></div>
                    <div style="flex:1"><label class="muted">Rol</label><div id="usuario-side-rol"></div></div>
                  </div>
                  <div class="input-row">
                    <div style="flex:1"><label class="muted">Tipo de cuota</label><div id="usuario-side-tipo-cuota"></div></div>
                    <div style="flex:1"><label class="muted">Último pago</label><div id="usuario-side-ultimo-pago"></div></div>
                  </div>
                  <div style="margin-top:12px">
                    <h4 style="margin:0 0 8px 0; font-size:14px;">Historial de pagos</h4>
                    <div class="table-scroll table-compact">
                      <table id="usuario-historial-table">
                        <thead><tr><th>Fecha</th><th>Método</th><th>Concepto</th><th>Monto</th></tr></thead>
                        <tbody></tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="block" style="margin-top:12px">
              <div class="block-header"><h3 style="margin:0; font-size:16px;">Acciones rápidas</h3></div>
              <div class="block-body">
                <div class="input-row">
                  <button class="btn" id="usuario-side-editar">Editar usuario</button>
        <button class="btn danger" id="usuario-side-eliminar">Eliminar</button>
                  <button class="btn" id="usuario-side-ver-pagos">Ver pagos</button>
        <button class="btn warning" id="usuario-side-toggle-activo">Activar/Inactivar</button>
                  <button class="btn" id="usuario-side-registrar">Registrar pago</button>
                  <button class="btn" id="usuario-side-qr">Emitir QR Check-in</button>
        <button class="btn success" id="usuario-side-asistencia">Registrar asistencia</button>
                  <button class="btn" id="usuario-side-ficha">Ver ficha</button>
                  <button class="btn info" id="usuario-side-rutina-new">Crear rutina</button>
                  
                  
                </div>
              </div>
            </div>
            
            <div class="block" style="margin-top:12px">
              <div class="block-header"><h3 style="margin:0; font-size:16px;">Notas, Etiquetas y Estados</h3></div>
              <div class="block-body">
                <div id="usuario-tabs" class="subtabs" style="display:flex; gap:8px; margin-bottom:8px;">
                  <button class="btn tertiary active" data-tab="notas">Notas</button>
                  <button class="btn tertiary" data-tab="etiquetas">Etiquetas</button>
                  <button class="btn tertiary" data-tab="estados">Estados</button>
                </div>
                <div id="usuario-tab-notas" class="tab-panel">
                  <label class="muted">Notas</label>
                  <textarea id="usuario-notas-textarea" rows="5" style="width:100%" aria-label="Notas del usuario" placeholder="Apunta comentarios, lesiones, preferencias, objetivos, etc."></textarea>
                  <div class="input-row" style="margin-top:6px; align-items:center; justify-content: space-between;">
                    <span id="usuario-notas-counter" class="counter">0 caracteres</span>
                    <div style="display:flex; gap:8px; align-items:center">
                      <span id="usuario-notas-status" class="muted" role="status" aria-live="polite"></span>
                      <button class="btn success" id="usuario-notas-save">Guardar notas</button>
                    </div>
                  </div>
                </div>
                <div id="usuario-tab-etiquetas" class="tab-panel" style="display:none">
                  <div class="input-row">
                    <input id="usuario-etiqueta-input" type="text" placeholder="Nombre de etiqueta" style="flex:2" aria-label="Nombre de etiqueta">
                    <button class="btn success" id="usuario-etiqueta-add">Añadir etiqueta</button>
                  </div>
                  <div class="input-row" style="margin-top:6px">
                    <input id="usuario-etiqueta-filter" type="text" placeholder="Filtrar etiquetas" style="flex:1" aria-label="Filtrar etiquetas">
                    <button id="usuario-etiqueta-filter-clear" class="btn outline neutral sm" title="Limpiar filtro">Limpiar</button>
                  </div>
                  <div id="usuario-etiqueta-suggests" class="chips" style="margin-top:6px; display:none"></div>
                  <div id="usuario-etiquetas-list" class="chips" style="margin-top:8px"></div>
                  <div id="usuario-etiquetas-empty" class="empty-hint" role="status" aria-live="polite" style="display:none;margin-top:8px">Sin etiquetas</div>
                </div>
                <div id="usuario-tab-estados" class="tab-panel" style="display:none">
                  <div class="input-row">
                    <select id="usuario-estado-template" style="flex:1" aria-label="Plantilla de estado"></select>
                    <input id="usuario-estado-descripcion" type="text" placeholder="Descripción" style="flex:2" aria-label="Descripción del estado">
                    <input id="usuario-estado-vencimiento" type="date" style="flex:1" aria-label="Fecha de vencimiento">
                    <button class="btn success" id="usuario-estado-add">Añadir estado</button>
                  </div>
                  <div class="input-row" style="margin-top:6px; align-items:center">
                    <input id="usuario-estados-filter" type="text" placeholder="Filtrar estados" style="flex:2" aria-label="Filtrar estados">
                    <button id="usuario-estados-filter-clear" class="btn outline neutral sm" title="Limpiar filtro">Limpiar</button>
                    <label style="display:flex; align-items:center; gap:6px"><input id="usuario-estados-show-expired" type="checkbox" checked>Mostrar vencidos</label>
                  </div>
                  <div id="usuario-estados-list" style="margin-top:8px"></div>
                  <div id="usuario-estados-empty" class="empty-hint" role="status" aria-live="polite" style="display:none;margin-top:8px">Sin estados</div>
                </div>
              </div>
            </div>
          </aside>
        </div>
  </section>
  <section id="panel-profesores" class="panel">
  <div class="split">
    <div class="split-main">
      <div class="panel-controls">
        <select id="profesor-select" title="Seleccionar profesor" style="min-width:220px"></select>
        <button class="btn info" id="prof-refresh">Actualizar</button>
        <button class="btn success" id="sesion-iniciar" title="Iniciar sesión de trabajo">Iniciar sesión</button>
        <button class="btn danger" id="sesion-finalizar" title="Finalizar sesión de trabajo">Finalizar sesión</button>
        <span id="prof-sesion-estado" class="muted" style="margin-left:auto">Sesión: —</span>
      </div>
      <div class="subtabs" id="prof-subtabs" style="margin:8px 0">
        <button class="btn tertiary active" data-subtab="resumen">Resumen</button>
        <button class="btn tertiary" data-subtab="horarios">Horarios</button>
        <button class="btn tertiary" data-subtab="sesiones">Sesiones</button>
      </div>
      <div id="prof-tab-resumen" style="display:block">
        <div class="block">
          <div class="block-header">
            <h3>Datos del profesor</h3>
            <div class="panel-controls" style="margin-left:auto; gap:8px">
              <button class="btn success" id="prof-datos-save">Guardar</button>
            </div>
          </div>
          <div class="block-body">
            <div class="input-row">
              <input id="prof-dato-nombre" type="text" placeholder="Nombre" style="flex:2" />
              <input id="prof-dato-dni" type="text" placeholder="DNI" style="flex:1" />
              <input id="prof-dato-telefono" type="text" placeholder="Teléfono" style="flex:1" />
            </div>
            <div class="input-row" style="margin-top:8px; align-items:center">
              <input id="prof-dato-pin" type="text" placeholder="PIN" style="flex:1" />
              <label style="display:flex; align-items:center; gap:6px"><input id="prof-dato-activo" type="checkbox" />Activo</label>
              <span class="muted" id="prof-dato-rol-label" style="margin-left:auto">Rol: Profesor</span>
            </div>
            <div class="input-row" style="margin-top:8px; align-items:center">
              <span class="muted" style="flex:1">Estado de sesión:</span>
              <span id="sesion-estado" role="status" aria-live="polite" style="flex:1">—</span>
              <span class="muted" style="flex:1">Duración:</span>
              <span id="sesion-duracion" role="status" aria-live="polite" style="flex:1">—</span>
            </div>
          </div>
        </div>
        <div class="block">
          <div class="block-header">
            <h3>Resumen del mes actual</h3>
          </div>
          <div class="block-body">
            <div class="cards">
  <div class="card"><div class="card-title">Trabajadas (h)</div><div class="card-value" id="prof-m-horas-trabajadas">0</div></div>
  <div class="card"><div class="card-title">Proyectadas (h)</div><div class="card-value" id="prof-m-horas-proyectadas">0</div></div>
  <div class="card"><div class="card-title">Extras (h)</div><div class="card-value" id="prof-m-horas-extra">0</div></div>
  <div class="card"><div class="card-title">Totales (h)</div><div class="card-value" id="prof-m-horas-totales">0</div></div>
            </div>
          </div>
        </div>
        <div class="block" style="margin-top:12px">
          <div class="block-header">
            <h3>Resumen semanal</h3>
            <div class="panel-controls" style="margin-left:auto; gap:8px">
              <label>Semana <input type="date" id="prof-week-date" /></label>
              <label>Inicio
                <select id="prof-week-start"><option value="mon" selected>Lunes</option><option value="sun">Domingo</option></select>
              </label>
              <span class="muted" id="prof-week-range">—</span>
            </div>
          </div>
          <div class="block-body">
            <div class="cards">
  <div class="card"><div class="card-title">Trabajadas (h)</div><div class="card-value" id="prof-w-horas-trabajadas">0</div></div>
  <div class="card"><div class="card-title">Proyectadas (h)</div><div class="card-value" id="prof-w-horas-proyectadas">0</div></div>
  <div class="card"><div class="card-title">Extras (h)</div><div class="card-value" id="prof-w-horas-extra">0</div></div>
  <div class="card"><div class="card-title">Totales (h)</div><div class="card-value" id="prof-w-horas-totales">0</div></div>
            </div>
          </div>
        </div>
      </div>
      <div id="prof-tab-horarios" style="display:none">
      <div class="block">
        <div class="block-header">
          <h3>Horarios de disponibilidad</h3>
          <div class="panel-controls" style="margin-left:auto; gap:8px">
            <select id="horario-dia" title="Día">
              <option value="Lunes">Lunes</option>
              <option value="Martes">Martes</option>
              <option value="Miércoles">Miércoles</option>
              <option value="Jueves">Jueves</option>
              <option value="Viernes">Viernes</option>
              <option value="Sábado">Sábado</option>
              <option value="Domingo">Domingo</option>
            </select>
            <input type="time" id="horario-inicio" title="Inicio" />
            <input type="time" id="horario-fin" title="Fin" />
            <label style="display:flex; align-items:center; gap:6px"><input type="checkbox" id="horario-disponible" checked />Disponible</label>
            <button class="btn" id="horario-add">Añadir</button>
        <button class="btn outline neutral" id="horario-cancel" style="display:none">Cancelar edición</button>
            <span id="horarios-count" class="muted"></span>
          </div>
        </div>
        <div class="block-body">
          <div class="table-scroll table-compact">
            <table id="prof-horarios-table">
              <thead>
                <tr>
                  <th>Día</th>
                  <th>Inicio</th>
                  <th>Fin</th>
                  <th>Disponible</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
      </div>
      <div id="prof-tab-sesiones" style="display:none">
        <div class="block">
          <div class="block-header">
            <h3>Sesiones trabajadas</h3>
            <div class="panel-controls" style="margin-left:auto; gap:8px">
              <label>Inicio <input type="date" id="prof-ses-start" /></label>
              <label>Fin <input type="date" id="prof-ses-end" /></label>
        <button class="btn tertiary" id="prof-ses-week">Semana actual</button>
        <button class="btn tertiary" id="prof-ses-month">Mes actual</button>
              <button class="btn" id="prof-ses-refresh">Actualizar</button>
            </div>
          </div>
          <div class="block-body">
            <div class="table-scroll">
              <table id="prof-sesiones-table">
                <thead>
                  <tr>
                    <th>Fecha</th>
                    <th>Inicio</th>
                    <th>Fin</th>
                    <th>Minutos</th>
                    <th>Horas</th>
                    <th>Tipo</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
    <aside class="split-side" id="prof-config-side">
      <div class="block">
        <div class="block-header">
          <h3 style="margin:0; font-size:16px;">Configuración del profesor</h3>
          <div class="panel-controls" style="margin-left:auto; gap:8px">
            <button class="btn success" id="prof-config-save">Guardar</button>
          </div>
        </div>
        <div class="block-body">
          <div class="input-row">
            <label for="prof-config-usuario" style="display:block; margin-bottom:4px; color:var(--muted);">Usuario vinculado</label>
            <input id="prof-config-usuario" title="Usuario vinculado" style="width:100%" type="text" readonly disabled />
          </div>
          <div class="input-row" style="margin-top:8px">
            <label for="prof-config-salario" id="prof-config-salario-label" style="display:block; margin-bottom:4px; color:var(--muted);">Monto (ARS)</label>
            <div class="currency-input" style="display:flex; align-items:center; gap:8px">
              <span class="prefix" style="color:var(--muted); font-size:12px; padding:4px 8px; border:1px solid var(--border); border-radius:10px;">ARS</span>
              <input type="number" id="prof-config-salario" placeholder="Monto en ARS" step="0.01" min="0" inputmode="decimal" />
              <select id="prof-monto-tipo" title="Tipo de monto" style="margin-left:auto">
                <option value="mensual">Mensual</option>
                <option value="hora">Por hora</option>
              </select>
            </div>
          </div>
          <div class="input-row" style="margin-top:8px">
            <label for="prof-config-notas" style="display:block; margin-bottom:4px; color:var(--muted);">Notas</label>
            <textarea id="prof-config-notas" placeholder="Notas" rows="4" style="width:100%"></textarea>
          </div>
          <div class="input-row" style="margin-top:8px">
            <label for="prof-config-especialidad" style="display:block; margin-bottom:4px; color:var(--muted);">Especialidad</label>
            <input type="text" id="prof-config-especialidad" placeholder="Ej. Musculación" />
          </div>
          <div class="input-row" style="margin-top:8px">
            <label for="prof-config-experiencia" style="display:block; margin-bottom:4px; color:var(--muted);">Experiencia (años)</label>
            <input type="number" id="prof-config-experiencia" placeholder="Ej. 3" step="1" min="0" />
          </div>
          <!-- Tarifa por hora eliminada: unificado con Monto (ARS) -->
          <div class="input-row" style="margin-top:8px">
            <label for="prof-config-certificaciones" style="display:block; margin-bottom:4px; color:var(--muted);">Certificaciones</label>
            <textarea id="prof-config-certificaciones" placeholder="Certificaciones" rows="3" style="width:100%"></textarea>
          </div>
          <div style="margin-top:12px; font-size:12px; color:var(--muted); line-height:1.4">
            <strong>Inicio y fin de sesión:</strong> Inicia y termina sesiones desde Gestión. Si la hora de fin es anterior a la de inicio, se mostrará "(+1d)" solo cuando el cálculo de minutos indique cruce real de medianoche; de lo contrario se mostrará la hora sin la marca.
          </div>
        </div>
      </div>
    </aside>
  </div>
  </section>
  
  <section id="panel-clases" class="panel">
    <div class="split" style="grid-template-columns: 1fr">
      <div class="split-main">
        <div class="panel-controls">
          <label>Búsqueda</label>
          <input type="text" id="clases-q" placeholder="Nombre de clase" aria-label="Buscar clase" />
          <select id="clases-tipo-filter" title="Tipo de clase" aria-label="Tipo de clase" style="min-width:200px"></select>
          <button class="btn" id="clases-refresh">Actualizar</button>
          <button class="btn" id="clases-new">Nueva clase</button>
          <button class="btn outline neutral" id="clases-edit">Editar clase</button>
          <button class="btn secondary" id="clases-ejercicios">Ver ejercicios</button>
          <span id="clases-count" class="muted" style="margin-left:auto"></span>
        </div>
        <div class="table-scroll row-selectable">
          <table id="clases-table">
            <thead>
              <tr>
                <th>Nombre</th>
                <th>Descripción</th>
                <th>Tipo</th>
                <th>Activa</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="block" style="margin-top:16px">
          <div class="block-header">
            <h3 style="margin:0; font-size:16px;">Horarios de la clase seleccionada</h3>
            <div class="panel-controls" style="margin-left:auto; gap:8px">
              <select id="clase-horario-select" title="Ver horarios" aria-label="Ver horarios guardados" style="min-width:240px"><option value="">Ver horarios guardados…</option></select>
              <select id="clase-horario-dia" title="Día" aria-label="Día">
                <option value="Lunes">Lunes</option>
                <option value="Martes">Martes</option>
                <option value="Miércoles">Miércoles</option>
                <option value="Jueves">Jueves</option>
                <option value="Viernes">Viernes</option>
                <option value="Sábado">Sábado</option>
                <option value="Domingo">Domingo</option>
              </select>
              <input type="time" id="clase-horario-inicio" aria-label="Inicio" />
              <input type="time" id="clase-horario-fin" aria-label="Fin" />
              <input type="number" id="clase-horario-cupo" placeholder="Cupo máximo" aria-label="Cupo máximo" min="1" step="1" style="max-width:160px" />
              <select id="clase-horario-profesor" title="Profesor" aria-label="Profesor" style="min-width:200px"></select>
              <button class="btn" id="clase-horario-add">Añadir horario</button>
            </div>
          </div>
          <div class="block-body">
            <div class="table-scroll table-compact">
              <table id="clase-horarios-table">
                <thead>
                  <tr>
                    <th>Día</th>
                    <th>Inicio</th>
                    <th>Fin</th>
                    <th>Profesor</th>
                    <th>Cupo</th>
                    <th>Inscriptos</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div id="clase-horarios-empty" class="empty-hint" role="status" aria-live="polite" style="display:none; margin-top:8px">Sin horarios</div>
            <div class="block" style="margin-top:16px">
              <div class="block-header" style="gap:8px">
                <h3 style="margin:0; font-size:16px;">Inscriptos (horario seleccionado)</h3>
                <div class="panel-controls" style="margin-left:auto; gap:8px; flex-wrap:wrap">
                  <input type="text" id="horario-usuario-search" placeholder="Buscar usuario por nombre, DNI o teléfono" aria-label="Buscar usuario" style="min-width:240px" />
                  <select id="horario-usuario-select" title="Usuario" aria-label="Usuario" style="min-width:240px"><option value="">Selecciona usuario…</option></select>
                  <button class="btn" id="horario-inscribir-btn">Inscribir usuario</button>
                  <button class="btn outline neutral" id="horario-notify-btn">Notificar primer en espera (WhatsApp)</button>
                </div>
              </div>
              <div class="block-body" style="display:grid; grid-template-columns: 1fr; gap:16px">
                <div class="table-scroll table-compact">
                  <table id="horario-usuarios-table">
                    <thead>
                      <tr>
                        <th>ID</th>
                        <th>Usuario</th>
                        <th>WhatsApp</th>
                        <th>Acciones</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
                <div id="horario-usuarios-empty" class="empty-hint" role="status" aria-live="polite" style="display:none;">Sin inscriptos para este horario</div>
              </div>
            </div>
            <div class="block" style="margin-top:16px">
              <div class="block-header" style="gap:8px">
                <h3 style="margin:0; font-size:16px;">Lista de espera (horario seleccionado)</h3>
              </div>
              <div class="block-body" style="display:grid; grid-template-columns: 1fr; gap:16px">
                <div class="table-scroll table-compact">
                  <table id="horario-waitlist-table">
                    <thead>
                      <tr>
                        <th>ID</th>
                        <th>Usuario</th>
                        <th>Posición</th>
                        <th>Acciones</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
                <div id="horario-waitlist-empty" class="empty-hint" role="status" aria-live="polite" style="display:none;">Sin lista de espera</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Panel lateral de clase eliminado: edición se realiza exclusivamente con modal-clase -->
    </div>
  </section>

  <!-- Modal: Clase (Crear/Editar con ejercicios) -->
  <div class="modal-backdrop" id="modal-clase" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-clase-title" style="width: 70vw; max-width: 900px">
      <div class="modal-header">
        <h3 id="modal-clase-title" style="margin:0; font-size:16px;">Clase</h3>
        <button class="modal-close" id="modal-clase-close" aria-label="Cerrar">×</button>
      </div>
      <div class="modal-body">
        <div class="form-grid" style="display:grid; grid-template-columns: 1fr 1fr; gap:12px">
          <div class="form-row" style="grid-column: 1 / 3">
            <label for="modal-clase-nombre">Nombre</label>
            <input id="modal-clase-nombre" type="text" placeholder="Nombre de la clase" aria-label="Nombre de la clase" />
          </div>
          <div class="form-row" style="display:flex; gap:8px; align-items:flex-end">
            <div style="flex:1">
              <label for="modal-clase-tipo">Tipo</label>
              <select id="modal-clase-tipo" aria-label="Tipo de clase" style="width:100%"></select>
            </div>
            <div>
              <label class="muted" style="visibility:hidden">Nuevo tipo</label>
              <button class="btn secondary sm" id="modal-clase-tipo-new" title="Crear nuevo tipo">Nuevo</button>
            </div>
          </div>
          <div class="form-row">
            <label style="display:flex; align-items:center; gap:8px"><input id="modal-clase-activa" type="checkbox" /> Activa</label>
          </div>
          <div class="form-row" style="grid-column: 1 / 3">
            <label for="modal-clase-descripcion">Descripción</label>
            <textarea id="modal-clase-descripcion" rows="3" placeholder="Descripción" aria-label="Descripción de la clase"></textarea>
          </div>
          <div class="form-row" style="grid-column: 1 / 3">
            <div style="display:flex; align-items:center; gap:8px; justify-content:space-between">
              <label for="modal-clase-ejercicios">Ejercicios asociados</label>
              <button class="btn sm" id="modal-clase-open-ejercicios" title="Gestionar ejercicios de la clase">Gestionar ejercicios…</button>
            </div>
            <div>
              <input type="text" id="modal-clase-ejercicios-search" placeholder="Buscar ejercicio" aria-label="Buscar ejercicio" style="margin-bottom:8px; width:100%" />
              <select id="modal-clase-ejercicios" multiple size="8" aria-label="Seleccionar ejercicios" style="width:100%; display:none"></select>
              <div id="modal-clase-ejercicios-chips" aria-live="polite" style="display:flex; flex-wrap:wrap; gap:6px"></div>
            </div>
            <div class="hint muted" style="font-size:12px">Usa el buscador para ver, y el botón "Gestionar ejercicios…" para editar el bloque con más detalles.</div>
          </div>
          <!-- Horarios integrados en el modal -->
          <div class="form-row" style="grid-column: 1 / 3">
            <label>Horarios</label>
            <div class="input-row" style="gap:8px">
              <select id="modal-clase-horarios-select" aria-label="Horarios guardados"><option value="">Selecciona un horario…</option></select>
              <select id="modal-clase-horario-dia" title="Día" aria-label="Día">
                <option value="Lunes">Lunes</option>
                <option value="Martes">Martes</option>
                <option value="Miércoles">Miércoles</option>
                <option value="Jueves">Jueves</option>
                <option value="Viernes">Viernes</option>
                <option value="Sábado">Sábado</option>
                <option value="Domingo">Domingo</option>
              </select>
              <input type="time" id="modal-clase-horario-inicio" aria-label="Inicio" />
              <input type="time" id="modal-clase-horario-fin" aria-label="Fin" />
              <input type="number" id="modal-clase-horario-cupo" placeholder="Cupo máximo" aria-label="Cupo máximo" min="1" step="1" style="max-width:160px" />
              <select id="modal-clase-horario-profesor" title="Profesor" aria-label="Profesor" style="min-width:200px"></select>
              <button class="btn" id="modal-clase-horario-add">Añadir</button>
              <button class="btn outline neutral" id="modal-clase-horario-refresh">Actualizar</button>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn success" id="modal-clase-save">Guardar</button>
        <button class="btn outline neutral" id="modal-clase-cancel">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal: Ejercicios asignados a la clase -->
  <div class="modal-backdrop" id="modal-ejercicios-clase" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-ejercicios-title" style="width: 92vw; max-width: 1200px; max-height: 90vh; overflow:hidden">
      <div class="modal-header">
        <h3 id="modal-ejercicios-title" style="margin:0; font-size:16px;">Ejercicios de la clase</h3>
        <button class="modal-close" id="modal-ejercicios-close" aria-label="Cerrar">×</button>
      </div>
      <div class="modal-body" style="display:flex; flex-direction:column; gap:12px; overflow:auto">
        <div class="form-row" style="display:flex; flex-direction:column; gap:8px">
          <label for="clase-ej-q">Agregar y gestionar ejercicios</label>
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
            <input id="clase-ej-q" type="text" placeholder="Buscar ejercicio..." aria-label="Buscar ejercicio" style="flex:2; min-width:240px" />
            <select id="clase-ej-group" title="Filtrar por grupo" aria-label="Filtrar por grupo" style="min-width:180px">
              <option value="">Grupo: Todos</option>
            </select>
            <select id="clase-ej-objetivo" title="Filtrar por objetivo" aria-label="Filtrar por objetivo" style="min-width:180px">
              <option value="">Objetivo: Todos</option>
            </select>
            <label style="display:flex; gap:6px; align-items:center"><input id="clase-ej-multi" type="checkbox" /> <span>Selección múltiple</span></label>
          </div>
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
            <label class="muted" for="clase-ej-bloque-select" style="min-width:120px">Bloque</label>
            <select id="clase-ej-bloque-select" title="Seleccionar bloque de ejercicios" aria-label="Seleccionar bloque" style="min-width:220px"></select>
            <label for="clase-ej-bloque-name" class="sr-only">Nombre del bloque</label>
            <input id="clase-ej-bloque-name" type="text" placeholder="Nombre del bloque" aria-label="Nombre del bloque" style="min-width:220px" />
            <button class="btn sm" id="clase-ej-bloque-save" title="Guardar como nuevo bloque">Guardar bloque</button>
            <button class="btn sm" id="clase-ej-bloque-update" title="Actualizar bloque seleccionado">Actualizar bloque</button>
            <button class="btn outline neutral sm" id="clase-ej-bloque-delete" title="Eliminar bloque seleccionado">Eliminar</button>
          </div>
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
            <button class="btn" id="clase-ej-add">Agregar a la clase</button>
            <button class="btn danger" id="clase-ej-remove-selected">Quitar del bloque</button>
            <span class="muted" id="clase-ej-status" style="margin-left:auto">—</span>
          </div>
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
            <button class="btn secondary sm" id="clase-ej-new" title="Crear nuevo ejercicio">Nuevo</button>
            <button class="btn secondary sm" id="clase-ej-edit" title="Editar ejercicio seleccionado">Editar</button>
            <button class="btn secondary sm" id="clase-ej-delete" title="Eliminar ejercicio seleccionado">Eliminar</button>
          </div>
        </div>

        <div id="clase-ej-columns" style="display:grid; grid-template-columns: 1.6fr 1fr; gap:16px; align-items:start">
          <div>
            <div class="table-scroll row-selectable" style="border:1px solid var(--border); border-radius:8px; overflow:auto">
              <table id="clase-ej-list-table">
                <thead>
                  <tr>
                    <th style="width:28px;" title="Mover" aria-label="Mover"></th>
                    <th>Ejercicio</th>
                    <th>Grupo</th>
                    <th>Objetivo</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div id="clase-ej-list-empty" class="empty-hint" role="status" aria-live="polite" style="display:none; padding:8px">Sin ejercicios disponibles</div>
          </div>
          <div>
            <div class="table-scroll" style="border:1px solid var(--border); border-radius:8px; overflow:auto">
              <table id="clase-ej-bloque-table">
                <thead>
                  <tr>
                    <th style="width:28px;" title="Mover" aria-label="Mover"></th>
                    <th>Orden</th>
                    <th>Ejercicio</th>
                    <th>Series</th>
                    <th>Repeticiones</th>
                    <th>Descanso (seg)</th>
                    <th>Notas</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div id="clase-ej-bloque-empty" class="empty-hint" role="status" aria-live="polite" style="display:none; padding:8px">Sin ejercicios asociados</div>
          </div>
        </div>
      </div>
      <div class="modal-footer" style="display:flex; gap:8px; align-items:center">
        <button class="btn success" id="clase-ej-save">Guardar cambios</button>
        <button class="btn outline neutral" id="modal-ejercicios-cerrar">Cerrar</button>
      </div>
    </div>
  </div>
  <!-- Modal: Recordatorio de clase por WhatsApp -->
  <div class="modal-backdrop" id="modal-wa-clase" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="wa-clase-title">
      <div class="modal-header">
        <h3 id="wa-clase-title">Recordatorio de clase (WhatsApp)</h3>
        <button class="modal-close" id="wa-clase-close" aria-label="Cerrar">×</button>
      </div>
      <div class="modal-body">
        <div class="input-row" style="align-items:center">
          <label class="muted">Usuario</label>
          <div id="wa-clase-user-name">—</div>
        </div>
        <div class="input-row" style="margin-top:8px">
          <input type="text" id="wa-clase-tipo" placeholder="Tipo de clase" style="flex:1" aria-label="Tipo de clase" />
          <input type="date" id="wa-clase-fecha" style="flex:1" aria-label="Fecha de clase" />
          <input type="time" id="wa-clase-hora" style="flex:1" aria-label="Hora de clase" />
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn outline neutral" id="wa-clase-cancel">Cancelar</button>
        <button class="btn" id="wa-clase-send">Enviar</button>
      </div>
    </div>
  </div>

<section id="panel-configuracion" class="panel">
        <div class="split" style="grid-template-columns: 1fr;">
          <div class="split-main" style="flex:1 1 100%; width:100%">
            <div class="block">
              <div class="block-header">
                <h3 style="margin:0; font-size:16px;">Tipos de cuota</h3>
                <div class="panel-controls" style="margin-left:auto">
                  <button class="btn" id="config-tipos-refresh">Actualizar</button>
                  <button class="btn" id="config-tipos-new">Nuevo</button>
                </div>
              </div>
              <div class="block-body">
                <div class="table-scroll row-selectable">
                  <table id="config-tipos-table">
                    <thead>
                      <tr>
                        <th>Nombre</th>
                        <th>Precio</th>
                        <th>Duración (días)</th>
                        <th>Activo</th>
                        <th>Acciones</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>

            <div class="block" style="margin-top:16px">
              <div class="block-header">
                <h3 style="margin:0; font-size:16px;">Conceptos de pago</h3>
                <div class="panel-controls" style="margin-left:auto">
                  <button class="btn" id="config-conceptos-refresh">Actualizar</button>
                  <button class="btn" id="config-conceptos-new">Nuevo</button>
                </div>
              </div>
              <div class="block-body">
                <div class="table-scroll row-selectable">
                  <table id="config-conceptos-table">
                    <thead>
                      <tr>
                        <th>Nombre</th>
                        <th>Precio base</th>
                        <th>Tipo</th>
                        <th>Activo</th>
                        <th>Categoría</th>
                        <th>Acciones</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>

            <div class="block" style="margin-top:16px">
              <div class="block-header">
                <h3 style="margin:0; font-size:16px;">Métodos de pago</h3>
                <div class="panel-controls" style="margin-left:auto">
                  <button class="btn" id="config-metodos-refresh">Actualizar</button>
                  <button class="btn" id="config-metodos-new">Nuevo</button>
                </div>
              </div>
              <div class="block-body">
                <div class="table-scroll row-selectable">
                  <table id="config-metodos-table">
                    <thead>
                      <tr>
                        <th>Nombre</th>
                        <th>Comisión (%)</th>
                        <th>Color</th>
                        <th>Activo</th>
                        <th>Acciones</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>

            <div class="block" style="margin-top:16px" id="branding-block">
              <div class="block-header">
                <h3 style="margin:0; font-size:16px;">Datos del gimnasio</h3>
                <div class="panel-controls" style="margin-left:auto; gap:8px">
                  <button class="btn" id="gym-branding-save">Guardar</button>
                </div>
              </div>
              <div class="block-body">
                <div class="input-row" style="gap:12px; flex-wrap:wrap">
                  <div style="flex:1 1 280px">
                    <label class="muted" for="gym-name-input">Nombre del gimnasio</label>
                    <input id="gym-name-input" type="text" placeholder="Ej: \"Gimnasio Central\"" style="width:100%" aria-label="Nombre del gimnasio" />
                  </div>
                  <div style="flex:1 1 280px">
                    <label class="muted" for="gym-logo-input">Logo (PNG o SVG)</label>
                    <input id="gym-logo-input" type="file" accept=".png,.svg,image/png,image/svg+xml" style="width:100%" aria-label="Logo del gimnasio" />
                  </div>
                </div>
                <div class="input-row" style="gap:12px; flex-wrap:wrap; margin-top:8px">
                  <div style="flex:1 1 280px">
                    <label class="muted">Logo actual</label>
                    <img id="gym-logo-preview" src="{{ logo_url }}" alt="Logo del gimnasio" style="height:64px; width:auto; border-radius:8px; background:rgba(255,255,255,0.04); border:1px solid var(--border); padding:8px" />
                  </div>
                </div>
                <div class="input-row" style="align-items:center; margin-top:12px">
                  <span id="gym-branding-status" class="muted" role="status" aria-live="polite">—</span>
                </div>
              </div>
            </div>

            <div class="block" style="margin-top:16px">
              <div class="block-header">
                <h3 style="margin:0; font-size:16px;">Mantenimiento</h3>
                <div class="panel-controls" style="margin-left:auto">
                  <input id="config-renum-start" type="number" min="1" step="1" value="2" placeholder="ID inicial (ej. 2)" style="width:160px" aria-label="ID inicial" />
        <button class="btn warning" id="config-renum-run">Renumerar IDs</button>
        <button class="btn info" id="config-secure-owner">Asegurar Dueño</button>
                </div>
              </div>
              <div class="block-body">
                <p class="muted">Acción avanzada: renumera todos los IDs de usuarios consecutivamente desde el ID inicial. Solo dueño. Actualiza referencias en pagos, asistencias, rutinas, clases, notificaciones, etc. Operación irreversible; se recomienda respaldo previo.</p>
                <p class="muted">Acción avanzada: asegura la existencia del Dueño en ID 1, crea si falta y restablece protecciones (RLS y triggers). Solo dueño.</p>
              </div>
            </div>

            <div class="input-row" id="config-wa-row" style="margin-top:16px; align-items:flex-start; gap:12px;">
              <div style="flex:1 1 100%">
                {% if request.session.get('logged_in') %}
                <div class="block" id="wa-config-block">
                  <div class="block-header">
                    <h3 style="margin:0; font-size:16px;">WhatsApp — Configuración</h3>
                    <div class="panel-controls" style="margin-left:auto; gap:8px; flex-wrap:wrap">
                      <button class="btn" id="config-wa-save" aria-label="Guardar configuración">Guardar</button>
                      <button class="btn info" id="config-wa-check-state" aria-label="Verificar estado">Verificar estado</button>
                      <button class="btn success" id="config-wa-server-toggle" aria-label="Iniciar servidor" aria-pressed="false">Iniciar servidor</button>
                    </div>
                  </div>
                  <div class="block-body">
                    <div class="input-row" style="gap:12px; flex-wrap:wrap; margin-top:8px">
                      <div style="flex:1 1 420px">
                        <label class="muted" for="wa-config-allowlist-text">Allowlist (teléfonos separados por coma)</label>
                        <textarea id="wa-config-allowlist-text" rows="2" placeholder="Ej. +5491112345678, +5491123456789" style="width:100%" aria-label="Lista de teléfonos permitidos"></textarea>
                        <p class="muted" id="wa-config-allowlist-help" style="margin-top:4px">Formato: prefijo país + número. Se aceptan espacios, guiones y paréntesis, que serán normalizados.</p>
                      </div>
                      <div style="flex:1 1 220px; display:flex; flex-direction:column; gap:8px">
                        <label class="muted" style="display:flex; align-items:center; gap:8px"><input id="wa-config-allowlist-enabled" type="checkbox" aria-label="Habilitar Allowlist" /> Habilitar Allowlist</label>
                        <label class="muted" style="display:flex; align-items:center; gap:8px"><input id="wa-config-enable-webhook" type="checkbox" aria-label="Habilitar Webhook" /> Habilitar Webhook</label>
                      </div>
                    </div>
                    <div id="wa-config-errors" role="alert" aria-live="polite" style="display:none; color:#b00020; margin-top:8px"></div>
                    <div id="wa-config-save-status" class="muted" role="status" aria-live="polite" style="margin-top:6px">—</div>
                  </div>
                </div>
                {% endif %}
                <div class="block" id="wa-gestion-block">
                  <div class="block-header">
                    <h3 style="margin:0; font-size:16px;">WhatsApp — Gestión</h3>
                    <div class="panel-controls" style="margin-left:auto; gap:8px; flex-wrap:wrap">
                      <button class="btn" id="config-wa-refresh" aria-label="Actualizar">Actualizar</button>
        <button class="btn warning" id="config-wa-retry-all" aria-label="Reintentar todos">Reintentar todos</button>
        <button class="btn outline neutral" id="config-wa-clear-all" aria-label="Limpiar fallidos">Limpiar fallidos</button>
                      <select id="usuario-wa-user-select" title="Usuario" aria-label="Usuario">
                        <option value="">Todos</option>
                      </select>
                      <select id="usuario-wa-filter" title="Tipo de mensaje" aria-label="Tipo de mensaje">
                        <option value="">Todos</option>
                        <option value="welcome">Bienvenida</option>
                        <option value="payment">Confirmación de pago</option>
                        <option value="deactivation">Desactivación</option>
                        <option value="overdue">Recordatorio vencimiento</option>
                        <option value="class_reminder">Recordatorio de clase</option>
                      </select>
                    </div>
                  </div>
                  <div class="block-body">
                    <div class="cards" style="margin-bottom:8px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
                      <div class="card" id="config-wa-state-card" aria-live="polite">
                        <div class="card-title">Estado WhatsApp</div>
                        <div class="card-value" style="display:flex; flex-direction:column; gap:4px">
                          <span>Disponible: <strong id="config-wa-state-available">—</strong></span>
                          <span>Habilitado: <strong id="config-wa-state-enabled">—</strong></span>
                          <span>Servidor: <strong id="config-wa-state-server">—</strong></span>
                          <span>Config válida: <strong id="config-wa-state-config">—</strong></span>
                        </div>
                      </div>
                      <div class="card" id="config-wa-last-card" aria-live="polite">
                        <div class="card-title">Último envío del usuario</div>
                        <div class="card-value" style="display:flex; flex-direction:column; gap:4px">
                          <span>Usuario: <strong id="config-wa-last-user">—</strong></span>
                          <span>Tipo: <strong id="config-wa-last-type">—</strong></span>
                          <span>Fecha: <strong id="config-wa-last-date">—</strong></span>
                          <span>Estado: <strong id="config-wa-last-status">—</strong></span>
                          <span>Detalle: <strong id="config-wa-last-detail">—</strong></span>
                        </div>
                      </div>
                    </div>
                    <div style="display:flex; gap:16px; align-items:flex-start; flex-wrap:wrap">
                      <div style="flex:1 1 480px">
                        <h4 style="margin:0 0 6px 0; font-size:14px;">Pendientes</h4>
                        <div class="table-scroll row-selectable">
                          <table id="config-wa-pendings-table" aria-label="Tabla de envíos pendientes de WhatsApp">
                            <thead>
                              <tr>
                                <th>Usuario</th>
                                <th>Teléfono</th>
                                <th>Último envío</th>
                                <th>Tipo</th>
                                <th>Acciones</th>
                              </tr>
                            </thead>
                            <tbody></tbody>
                          </table>
                        </div>
                      </div>
                      <div style="flex:1 1 420px">
                        <h4 style="margin:0 0 6px 0; font-size:14px;">Por usuario</h4>
                        <div class="cards" id="usuario-wa-cards" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));">
                          <div class="card" id="usuario-wa-card-welcome">
                            <div class="card-title">Bienvenida</div>
                            <div class="card-value" id="usuario-wa-status-welcome">—</div>
                            <div class="muted" id="usuario-wa-date-welcome">Fecha: —</div>
                            <div style="margin-top:6px; display:flex; gap:6px; align-items:center; flex-wrap:wrap">
                              <button class="btn sm" data-type="welcome">Forzar envío</button>
                            </div>
                          </div>
                          <div class="card" id="usuario-wa-card-payment">
                            <div class="card-title">Confirmación de pago</div>
                            <div class="card-value" id="usuario-wa-status-payment">—</div>
                            <div class="muted" id="usuario-wa-date-payment">Fecha: —</div>
                            <div style="margin-top:6px; display:flex; gap:6px; align-items:center; flex-wrap:wrap">
                              <button class="btn sm" data-type="payment">Forzar envío</button>
                            </div>
                          </div>
                          <div class="card" id="usuario-wa-card-deactivation">
                            <div class="card-title">Desactivación</div>
                            <div class="card-value" id="usuario-wa-status-deactivation">—</div>
                            <div class="muted" id="usuario-wa-date-deactivation">Fecha: —</div>
                            <div style="margin-top:6px; display:flex; gap:6px; align-items:center; flex-wrap:wrap">
                              <button class="btn sm" data-type="deactivation">Forzar envío</button>
                            </div>
                          </div>
                          <div class="card" id="usuario-wa-card-overdue">
                            <div class="card-title">Recordatorio vencimiento</div>
                            <div class="card-value" id="usuario-wa-status-overdue">—</div>
                            <div class="muted" id="usuario-wa-date-overdue">Fecha: —</div>
                            <div style="margin-top:6px; display:flex; gap:6px; align-items:center; flex-wrap:wrap">
                              <button class="btn sm" data-type="overdue">Forzar envío</button>
                            </div>
                          </div>
                        </div>
                        <div style="margin-top:10px">
                          <h4 style="margin:0 0 6px 0; font-size:14px;">Historial de WhatsApp</h4>
                          <div class="table-scroll table-compact">
                            <table id="usuario-wa-historial-table" aria-label="Historial de WhatsApp del usuario">
                              <thead>
                                <tr>
                                  <th>Fecha</th>
                                  <th>Tipo</th>
                                  <th>Estado</th>
                                  <th>Contenido</th>
                                  <th>Acciones</th>
                                </tr>
                              </thead>
                              <tbody id="usuario-wa-historial-body"></tbody>
                            </table>
                          </div>
                          <div id="usuario-wa-historial-empty" class="empty-hint" role="status" aria-live="polite" style="display:none; margin-top:6px">Sin historial</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

    <!-- Modal: Confirmar Asegurar Dueño -->
    <div class="modal-backdrop" id="modal-secure-owner-confirm" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-secure-owner-title">
        <div class="modal-header">
          <h3 id="modal-secure-owner-title" style="margin:0; font-size:16px;">Confirmar Asegurar Dueño</h3>
          <button class="modal-close" id="secure-owner-close" aria-label="Cerrar">×</button>
        </div>
        <div class="modal-body">
          <p class="muted">Esta acción:</p>
          <ul class="muted">
            <li>Garantiza que el Dueño exista con ID 1.</li>
            <li>Restablece RLS y triggers de protección del Dueño.</li>
            <li>No afecta otros usuarios ni configuraciones.</li>
          </ul>
          <p class="muted">Requiere sesión de Dueño.</p>
        </div>
        <div class="modal-footer">
          <button class="btn" id="secure-owner-confirm">Asegurar</button>
        <button class="btn outline neutral" id="secure-owner-cancel">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- Modal: Confirmación de salida para Profesor -->
    <div class="modal-backdrop" id="modal-sesion-fin" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-sesion-fin-title">
        <div class="modal-header">
          <div style="display:flex; align-items:center; gap:8px;">
            <h3 id="modal-sesion-fin-title" style="margin:0; font-size:16px;">Confirmar finalización</h3>
            <span class="muted" style="font-size:12px;">Tu sesión se guardará al salir</span>
          </div>
          <button class="modal-close" id="sesion-fin-close" aria-label="Cerrar">×</button>
        </div>
        <div class="modal-body">
          <div style="display:flex; flex-direction:column; gap:12px;">
            <p class="muted" style="margin:0">Antes de salir, confirma la finalización de tu sesión.</p>
        <div class="input-row">
          <div style="flex:1; border:1px solid var(--border); border-radius:10px; padding:12px;">
            <label class="muted" style="display:block; margin-bottom:6px;">Tiempo trabajado</label>
            <span id="modal-sesion-fin-duracion" class="duration-timer" aria-live="polite" style="font-size:20px; font-weight:600;">—</span>
          </div>
          <div style="flex:1; border:1px solid var(--border); border-radius:10px; padding:12px;">
            <label class="muted" style="display:block; margin-bottom:6px;">Tipo de sesión</label>
            <span id="modal-sesion-fin-tipo" style="display:inline-block; padding:6px 10px; border:1px solid var(--border); border-radius:999px; font-size:12px;">—</span>
            <p class="muted" style="margin-top:8px; font-size:12px;">Si no coincide con tus horarios asignados, se registrará como horas extra.</p>
          </div>
        </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn danger" id="sesion-fin-confirm">Finalizar y salir</button>
          <button class="btn outline neutral" id="sesion-fin-cancel">Cancelar</button>
        </div>
      </div>
    </div>

          </div>
        </div>
      </section>

      </main>
    </div>


    <!-- Modal: Eliminar sesión -->
    <div class="modal-backdrop" id="modal-sesion-delete" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-sesion-delete-title">
        <div class="modal-header">
          <h3 id="modal-sesion-delete-title" style="margin:0; font-size:16px;">Eliminar sesión</h3>
          <button class="modal-close" id="sesion-delete-close" aria-label="Cerrar">×</button>
        </div>
        <div class="modal-body">
          <p class="muted">¿Deseas eliminar esta sesión? Esta acción no se puede deshacer.</p>
        </div>
        <div class="modal-footer">
          <button class="btn danger" id="sesion-delete-confirm">Eliminar</button>
        <button class="btn outline neutral" id="sesion-delete-cancel">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- Modal: Filtros avanzados de Pagos -->
    <div class="modal-backdrop" id="modal-pagos-filtros" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-pagos-filtros-title">
        <div class="modal-header">
          <h3 id="modal-pagos-filtros-title" style="margin:0; font-size:16px;">Filtros avanzados</h3>
          <button class="modal-close" id="pagos-filtros-close" aria-label="Cerrar">×</button>
        </div>
        <div class="modal-body">
          <div class="input-row">
            <div style="flex:1">
              <label class="muted">Método de pago</label>
              <select id="pagos-metodo" style="width:100%"></select>
            </div>
            <div style="flex:1">
              <label class="muted">Concepto</label>
              <select id="pagos-concepto" style="width:100%"></select>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn" id="pagos-filtros-aplicar">Aplicar</button>
        <button class="btn outline neutral" id="pagos-filtros-cancelar">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- Modal: Configuración de Numeración de Recibos -->
    <div class="modal-backdrop" id="modal-recibo-config" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-recibo-config-title">
        <div class="modal-header">
          <h3 id="modal-recibo-config-title" style="margin:0; font-size:16px;">Numeración de recibos</h3>
          <button class="modal-close" id="recibo-config-close" aria-label="Cerrar">×</button>
        </div>
        <div class="modal-body">
          <div class="input-row">
            <div style="flex:1">
              <label class="muted" for="recibo-prefijo">Prefijo</label>
              <input id="recibo-prefijo" type="text" placeholder="REC" style="width:100%" />
            </div>
            <div style="flex:1">
              <label class="muted" for="recibo-separador">Separador</label>
              <input id="recibo-separador" type="text" placeholder="-" style="width:100%" />
            </div>
          </div>
          <div class="input-row">
            <div style="flex:1">
              <label class="muted" for="recibo-numero-inicial">Número inicial</label>
              <input id="recibo-numero-inicial" type="number" min="1" step="1" placeholder="1" style="width:100%" />
            </div>
            <div style="flex:1">
              <label class="muted" for="recibo-longitud-numero">Longitud del número</label>
              <input id="recibo-longitud-numero" type="number" min="1" step="1" placeholder="6" style="width:100%" />
            </div>
          </div>
          <div class="input-row">
            <div style="flex:1">
              <label class="muted" for="recibo-reiniciar-anual">Reiniciar anual</label>
              <input id="recibo-reiniciar-anual" type="checkbox" />
            </div>
            <div style="flex:1">
              <label class="muted">Incluir fecha</label>
              <div style="display:flex; gap:12px; align-items:center">
                <label style="display:flex; align-items:center; gap:6px"><input id="recibo-incluir-anio" type="checkbox" /> <span>Año</span></label>
                <label style="display:flex; align-items:center; gap:6px"><input id="recibo-incluir-mes" type="checkbox" /> <span>Mes</span></label>
              </div>
            </div>
          </div>
          <div style="margin-top:8px">
            <div class="muted" id="recibo-config-preview">Próximo ejemplo: —</div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn success" id="recibo-config-save">Guardar</button>
        <button class="btn outline neutral" id="recibo-config-cancel">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- Modal: Vista previa de Recibo -->
    <div class="modal-backdrop" id="modal-recibo-preview" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-recibo-preview-title">
        <div class="modal-header">
          <h3 id="modal-recibo-preview-title" style="margin:0; font-size:16px;">Vista previa del recibo</h3>
          <button class="modal-close" id="recibo-preview-close" aria-label="Cerrar">×</button>
        </div>
        <div class="modal-body" style="max-height:72vh; overflow-y:auto;">
          <div class="input-row" style="align-items:flex-end">
            <div style="flex:1">
              <label class="muted" for="recibo-preview-numero">Número de recibo (opcional)</label>
              <input id="recibo-preview-numero" type="text" placeholder="Ej: REC-2025-000123" style="width:100%" />
              <div id="recibo-preview-periodo-label" class="muted" style="margin-top:6px; font-size:12px; display:none"></div>
            </div>
            <div>
              <button class="btn" id="recibo-preview-apply" title="Actualizar vista previa">Aplicar</button>
            </div>
          </div>

          <details id="recibo-advanced" style="border:1px solid var(--border); border-radius:6px; padding:10px;">
            <summary style="cursor:pointer; user-select:none; font-weight:600">Opciones avanzadas del recibo</summary>
            <div class="input-row">
              <div style="flex:1">
                <label class="muted" for="recibo-preview-titulo">Título</label>
                <input id="recibo-preview-titulo" type="text" placeholder="RECIBO DE PAGO" style="width:100%" />
              </div>
              <div style="flex:1">
                <label class="muted" for="recibo-preview-fecha">Fecha de emisión</label>
                <input id="recibo-preview-fecha" type="date" style="width:100%" />
              </div>
            </div>
            <div class="input-row">
              <div style="flex:1">
                <label class="muted" for="recibo-preview-gym-nombre">Nombre del gimnasio</label>
                <input id="recibo-preview-gym-nombre" type="text" placeholder="Nombre del gimnasio" style="width:100%" />
              </div>
              <div style="flex:1">
                <label class="muted" for="recibo-preview-gym-direccion">Dirección del gimnasio</label>
                <input id="recibo-preview-gym-direccion" type="text" placeholder="Dirección" style="width:100%" />
              </div>
            </div>
            <div class="input-row">
              <div style="flex:1">
                <label class="muted" for="recibo-preview-usuario-nombre">Facturar a</label>
                <input id="recibo-preview-usuario-nombre" type="text" placeholder="Nombre del cliente" style="width:100%" />
              </div>
              <div style="flex:1">
                <label class="muted" for="recibo-preview-usuario-dni">DNI (opcional)</label>
                <input id="recibo-preview-usuario-dni" type="text" placeholder="DNI" style="width:100%" />
              </div>
            </div>
            <div class="input-row" style="align-items:flex-end">
              <div style="flex:1">
                <label class="muted" for="recibo-preview-metodo">Método de pago (opcional)</label>
                <input id="recibo-preview-metodo" type="text" placeholder="Efectivo / Tarjeta ..." style="width:100%" />
              </div>
              <div style="flex:1; display:flex; gap:16px; align-items:flex-end">
                <label class="muted" style="display:flex; align-items:center; gap:6px"><input id="recibo-preview-mostrar-logo" type="checkbox" checked /> <span>Mostrar logo</span></label>
                <label class="muted" style="display:flex; align-items:center; gap:6px"><input id="recibo-preview-mostrar-metodo" type="checkbox" checked /> <span>Mostrar método</span></label>
                <label class="muted" style="display:flex; align-items:center; gap:6px"><input id="recibo-preview-mostrar-dni" type="checkbox" checked /> <span>Mostrar DNI</span></label>
              </div>
            </div>
            <div class="input-row" style="align-items:flex-end">
              <div style="flex:2">
                <label class="muted" for="recibo-preview-observaciones">Observaciones (opcional)</label>
                <input id="recibo-preview-observaciones" type="text" placeholder="Notas u observaciones" style="width:100%" />
              </div>
              <div style="flex:1">
                <label class="muted" for="recibo-preview-emitidopor">Emitido por (opcional)</label>
                <input id="recibo-preview-emitidopor" type="text" placeholder="Nombre del emisor" style="width:100%" />
              </div>
            </div>
            <div class="input-row" style="align-items:flex-start">
              <div style="flex:1">
                <label class="muted">Ítems del recibo</label>
                <div id="recibo-items-list" style="border:1px solid var(--border); border-radius:6px; padding:8px; display:flex; flex-direction:column; gap:8px">
                  <div style="display:grid; grid-template-columns: 1fr 100px 140px 40px; gap:8px; align-items:center">
                    <div class="muted">Descripción</div>
                    <div class="muted">Cantidad</div>
                    <div class="muted">Precio</div>
                    <div></div>
                  </div>
                  <div id="recibo-items-rows" style="display:flex; flex-direction:column; gap:8px"></div>
                  <div>
        <button class="btn success" id="recibo-item-add" type="button">Agregar ítem</button>
                  </div>
                </div>
              </div>
            </div>
            <div class="input-row">
              <div style="flex:1"><label class="muted" for="recibo-total-subtotal">Subtotal</label><input id="recibo-total-subtotal" type="number" step="0.01" inputmode="decimal" placeholder="0.00" style="width:100%" /></div>
              <div style="flex:1"><label class="muted" for="recibo-total-comision">Comisión</label><input id="recibo-total-comision" type="number" step="0.01" inputmode="decimal" placeholder="0.00" style="width:100%" /></div>
              <div style="flex:1"><label class="muted" for="recibo-total-total">Total</label><input id="recibo-total-total" type="number" step="0.01" inputmode="decimal" placeholder="0.00" style="width:100%" /></div>
              <div style="flex:1"><label class="muted" for="recibo-total-items">Total de ítems</label><input id="recibo-total-items" type="number" step="1" inputmode="numeric" placeholder="0" style="width:100%" /></div>
            </div>
          </details>
          <div class="input-row">
              <div style="flex:1">
                <div id="recibo-preview-frame-wrap" style="width:100%; height:72vh; max-height:640px; min-height:360px; border:1px solid var(--border); border-radius:6px; overflow:auto; position:relative">
                  <iframe id="recibo-preview-frame" title="Vista previa del recibo" style="width:100%; height:100%; border:0; transform-origin: center top" src=""></iframe>
                </div>
              </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn" id="recibo-preview-download">Descargar PDF</button>
        <button class="btn outline neutral" id="recibo-preview-config">Configurar numeración</button>
        <button class="btn outline neutral" id="recibo-preview-close-btn">Cerrar</button>
        </div>
      </div>
    </div>

    <!-- Modal: Confirmar guardado de cambios del recibo -->
    <div class="modal-backdrop" id="modal-recibo-save" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-recibo-save-title">
        <div class="modal-header">
          <h3 id="modal-recibo-save-title" style="margin:0; font-size:16px;">Guardar cambios del recibo</h3>
          <button class="modal-close" id="recibo-save-close" aria-label="Cerrar">×</button>
        </div>
        <div class="modal-body">
          <p class="muted">Se detectaron cambios en fecha o total. ¿Quieres aplicar estos cambios al pago?</p>
          <div class="input-row">
            <div style="flex:1"><label class="muted">Fecha nueva</label><div id="recibo-save-fecha">—</div></div>
        <div style="flex:1"><label class="muted">Total nuevo</label><div><span id="recibo-save-total">—</span></div></div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn success" id="recibo-save-apply">Guardar en pago</button>
          <button class="btn outline neutral" id="recibo-save-discard">Descartar</button>
        </div>
      </div>
    </div>

    <!-- Modal: Detalle de Pago -->
    <div class="modal-backdrop" id="modal-pago-detalle" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-pago-detalle-title">
        <div class="modal-header">
          <h3 id="modal-pago-detalle-title" style="margin:0; font-size:16px;">Detalle de pago</h3>
          <button class="modal-close" id="pago-detalle-close" aria-label="Cerrar">×</button>
        </div>
        <div class="modal-body">
          <div class="input-row">
            <div style="flex:1"><label class="muted">Fecha</label><div id="pago-detalle-fecha"></div></div>
            <div style="flex:1"><label class="muted">Usuario</label><div id="pago-detalle-nombre"></div></div>
          </div>
          <div class="input-row">
            <div style="flex:1"><label class="muted">DNI</label><div id="pago-detalle-dni"></div></div>
            <div style="flex:1"><label class="muted">Monto</label><div id="pago-detalle-monto"></div></div>
          </div>
          <div class="input-row">
            <div style="flex:1"><label class="muted">Método</label><div id="pago-detalle-metodo"></div></div>
            <div style="flex:1"><label class="muted">Concepto</label><div id="pago-detalle-concepto"></div></div>
          </div>
          <div style="margin-top:12px">
            <h4 style="margin:0 0 8px 0; font-size:14px;">Items</h4>
            <div class="table-scroll table-compact">
              <table id="pago-detalle-items-table">
                <thead><tr><th>Concepto</th><th>Cantidad</th><th>Precio</th><th>Subtotal</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
          <div class="input-row" style="margin-top:8px">
            <div style="flex:1"><label class="muted">Total de ítems</label><div id="pago-detalle-total-items">0</div></div>
          </div>
          <div style="margin-top:12px">
            <h4 style="margin:0 0 8px 0; font-size:14px;">Notas</h4>
            <div id="pago-detalle-notas" class="muted">—</div>
          </div>
        </div>
        <div class="modal-footer">
        <button class="btn outline neutral" id="pago-detalle-cerrar">Cerrar</button>
        </div>
      </div>
    </div>

    <!-- Modal: Usuario (Crear/Editar) -->
    <div class="modal-backdrop" id="modal-usuario" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-usuario-title">
        <div class="modal-header">
          <h3 id="modal-usuario-title" style="margin:0; font-size:16px;">Usuario</h3>
          <button class="modal-close" id="usuarios-modal-close" aria-label="Cerrar">×</button>
        </div>
        <div class="modal-body">
          <div class="input-row">
            <div style="flex:1">
              <label class="muted" for="u-id">ID de usuario</label>
              <input id="u-id" type="number" placeholder="ID (solo dueño)" style="width:100%" min="1" step="1" aria-label="ID de usuario" />
            </div>
          </div>
          <div class="input-row">
            <div style="flex:1">
              <label class="muted" for="u-nombre">Nombre completo</label>
              <input id="u-nombre" type="text" placeholder="Ej. Juan Pérez" style="width:100%" aria-label="Nombre completo" />
            </div>
            <div style="flex:1">
              <label class="muted" for="u-dni">DNI</label>
              <input id="u-dni" type="text" placeholder="Ej. 12345678" style="width:100%" aria-label="DNI" />
            </div>
          </div>
          <div class="input-row">
            <div style="flex:1">
              <label class="muted" for="u-telefono">Teléfono</label>
              <input id="u-telefono" type="text" placeholder="Ej. +54 9 11 1234-5678" style="width:100%" aria-label="Teléfono" />
            </div>
            <div style="flex:1">
              <label class="muted" for="u-pin">PIN de acceso</label>
              <input id="u-pin" type="text" placeholder="Opcional" style="width:100%" aria-label="PIN de acceso" />
            </div>
          </div>
          <div class="input-row">
            <div style="flex:1">
              <label class="muted" for="u-rol">Rol</label>
              <select id="u-rol" style="width:100%" aria-label="Rol">
                <option value="socio" selected>Socio</option>
                <option value="profesor">Profesor</option>
              </select>
            </div>
            <div style="flex:1">
              <label class="muted" for="u-tipo-cuota">Tipo de cuota</label>
              <select id="u-tipo-cuota" style="width:100%" aria-label="Tipo de cuota">
                <option value="">Seleccionar tipo de cuota</option>
              </select>
            </div>
            <div style="flex:1">
              <label class="muted" for="u-activo">Estado</label>
              <label style="display:flex; align-items:center; gap:6px">
                <input id="u-activo" type="checkbox" checked aria-label="Activo" /> Activo
              </label>
            </div>
          </div>
          <div class="input-row" style="margin-top:8px">
            <div style="flex:1">
              <label class="muted" for="u-notas">Notas</label>
              <textarea id="u-notas" rows="3" placeholder="Observaciones, preferencias y restricciones" style="width:100%" aria-label="Notas"></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn success" id="usuarios-save">Guardar</button>
        <button class="btn outline neutral" id="usuarios-cancel">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- Modal: Confirmar eliminación de Usuario -->
    <div class="modal-backdrop" id="modal-usuarios-delete" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-usuarios-delete-title">
        <div class="modal-header">
          <h3 id="modal-usuarios-delete-title" style="margin:0; font-size:16px;">Eliminar usuario</h3>
          <button class="modal-close" id="usuarios-delete-close" aria-label="Cerrar">×</button>
        </div>
        <div class="modal-body">
          <p>¿Estás seguro? Esta acción es permanente.</p>
        </div>
        <div class="modal-footer">
          <button class="btn" id="usuarios-delete-confirm">Eliminar</button>
        <button class="btn outline neutral" id="usuarios-delete-cancel">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- Modal: Confirmar renumeración de IDs -->
    <div class="modal-backdrop" id="modal-renum-confirm" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-renum-confirm-title">
        <div class="modal-header">
          <h3 id="modal-renum-confirm-title" style="margin:0; font-size:16px;">Renumerar IDs de usuarios</h3>
          <button class="modal-close" id="renum-close" aria-label="Cerrar">×</button>
        </div>
        <div class="modal-body">
          <p>Esta operación es irreversible y actualizará todas las referencias.</p>
          <p>Inicio: <strong id="renum-start-display">—</strong></p>
          <p class="muted">El ID 1 está reservado para el Dueño y no será modificado.</p>
        </div>
        <div class="modal-footer">
          <button class="btn" id="renum-confirm">Renumerar</button>
        <button class="btn outline neutral" id="renum-cancel">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- Modal: Confirmar eliminación de Pago -->
    <div class="modal-backdrop" id="modal-pagos-delete" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-pagos-delete-title">
        <div class="modal-header">
          <h3 id="modal-pagos-delete-title" style="margin:0; font-size:16px;">Eliminar pago</h3>
          <button class="modal-close" id="pagos-delete-close" aria-label="Cerrar">×</button>
        </div>
        <div class="modal-body">
          <p>¿Estás seguro? Esta acción es permanente.</p>
        </div>
        <div class="modal-footer">
          <button class="btn" id="pagos-delete-confirm">Eliminar</button>
        <button class="btn outline neutral" id="pagos-delete-cancel">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- Modal: Confirmar eliminación de Mensaje de WhatsApp -->
    <div class="modal-backdrop" id="modal-wa-delete" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-wa-delete-title">
        <div class="modal-header">
          <h3 id="modal-wa-delete-title" style="margin:0; font-size:16px;">Eliminar mensaje de WhatsApp</h3>
          <button class="modal-close" id="wa-delete-close" aria-label="Cerrar">×</button>
        </div>
        <div class="modal-body">
          <p>¿Estás seguro? Esta acción es permanente.</p>
          <div id="wa-delete-preview" class="muted" style="margin-top:8px"></div>
        </div>
        <div class="modal-footer">
          <button class="btn" id="wa-delete-confirm">Eliminar</button>
          <button class="btn outline neutral" id="wa-delete-cancel">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- Modal: Pago (Crear/Editar) -->
    <div class="modal-backdrop" id="modal-pago-form" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="pago-form-title">
        <div class="modal-header">
          <h3 id="pago-form-title" style="margin:0; font-size:16px;">Pago</h3>
          <button class="modal-close" id="pago-form-close" aria-label="Cerrar">×</button>
        </div>
        <div class="modal-body">
          <div class="input-row">
            <div style="flex:1">
              <label class="muted" for="pago-usuario">Usuario</label>
              <select id="pago-usuario" style="width:100%" aria-label="Usuario">
                <option value="">Seleccionar usuario</option>
              </select>
            </div>
            <div style="flex:1">
              <label class="muted" for="pago-monto">Monto</label>
              <input id="pago-monto" type="number" step="0.01" placeholder="Calculado automáticamente" style="width:100%" readonly aria-label="Monto" />
            </div>
          </div>
          <div class="input-row">
            <div style="flex:1">
              <label class="muted" for="pago-fecha">Fecha del pago</label>
              <input id="pago-fecha" type="date" style="width:100%" aria-label="Fecha del pago" />
            </div>
            <div style="flex:1">
              <label class="muted" for="pago-mes">Mes</label>
              <input id="pago-mes" type="number" min="1" max="12" placeholder="Ej. 7" style="width:100%" aria-label="Mes del período" />
            </div>
            <div style="flex:1">
              <label class="muted" for="pago-año">Año</label>
              <input id="pago-año" type="number" min="2000" max="2100" placeholder="Ej. 2025" style="width:100%" aria-label="Año del período" />
            </div>
          </div>
          <div class="input-row">
            <div style="flex:1">
              <label class="muted" for="pago-metodo">Método de pago</label>
              <select id="pago-metodo" style="width:100%" aria-label="Método de pago">
                <option value="">Seleccionar (opcional)</option>
              </select>
            </div>
            <div style="flex:1">
              <label class="muted" for="pago-concepto">Concepto</label>
              <select id="pago-concepto" style="width:100%" aria-label="Concepto">
                <option value="">Seleccionar concepto</option>
              </select>
            </div>
          </div>
          <details id="pago-items-advanced" style="border:1px solid var(--border); border-radius:6px; padding:10px; margin-top:8px;">
            <summary style="cursor:pointer"><strong>Ítems del pago</strong> <span class="muted">(opcional)</span></summary>
            <div id="pago-items-list" style="border:1px solid var(--border); border-radius:6px; padding:8px; display:flex; flex-direction:column; gap:8px; margin-top:8px;">
              <div id="pago-items-rows" style="display:flex; flex-direction:column; gap:8px"></div>
              <button class="btn success" id="pago-item-add" type="button">Agregar ítem</button>
            </div>
            <div class="input-row" style="margin-top:8px;">
              <div style="flex:1"><label class="muted" for="pago-items-subtotal">Subtotal</label><input id="pago-items-subtotal" type="number" step="0.01" inputmode="decimal" placeholder="0.00" style="width:100%" readonly /></div>
              <div style="flex:1"><label class="muted" for="pago-items-total">Total</label><input id="pago-items-total" type="number" step="0.01" inputmode="decimal" placeholder="0.00" style="width:100%" readonly /></div>
              <div style="flex:1"><label class="muted" for="pago-items-count">Total de ítems</label><input id="pago-items-count" type="number" step="1" inputmode="numeric" placeholder="0" style="width:100%" readonly /></div>
            </div>
          </details>
          <div id="pago-resumen" class="calc-summary" style="margin-top:8px; font-size:12px; color:#555">
            <div><strong>Concepto:</strong> <span id="pago-resumen-concepto">Cuota Mensual</span></div>
            <div><strong>Base:</strong> $<span id="pago-resumen-base">—</span></div>
            <div><strong>Comisión:</strong> $<span id="pago-resumen-comision">—</span> <span id="pago-resumen-comision-porcentaje"></span></div>
            <div><strong>Total:</strong> $<span id="pago-resumen-total">—</span></div>
            <div><strong>Ítems:</strong> <span id="pago-resumen-items">0</span></div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn success" id="pago-save">Guardar</button>
        <button class="btn outline neutral" id="pago-form-cancel">Cancelar</button>
        </div>
      </div>
    </div>

  </div>

  <!-- Backdrop para side-sheets -->
  <div class="side-sheet-backdrop" aria-hidden="true"></div>

  <!-- Side‑sheet: Wizard Nuevo Pago -->
  <div class="side-sheet" id="pago-wizard" role="dialog" aria-modal="true" aria-labelledby="pago-wizard-title" data-step="1">
    <div class="side-sheet-header">
      <h3 id="pago-wizard-title">Nuevo Pago</h3>
      <button class="btn icon-only" data-close-sheet="#pago-wizard" aria-label="Cerrar">×</button>
    </div>
    <div class="side-sheet-body">
      
      <div class="wizard-step" data-step="1">
        <div class="input-row">
          <div style="flex:1">
            <label class="muted" for="wiz-usuario">Usuario</label>
            <select id="wiz-usuario" style="width:100%" aria-label="Usuario" required title="Selecciona el usuario para asociar el pago">
              <option value="">Seleccionar usuario</option>
            </select>
            <div id="wiz-usuario-error" role="alert" aria-live="polite" style="display:none;color:#b00020;margin-top:4px;">Debes seleccionar un usuario.</div>
          </div>
        </div>
        <div class="input-row">
          <div style="flex:1">
            <label class="muted" for="wiz-fecha">Fecha del pago</label>
            <input id="wiz-fecha" type="date" style="width:100%" aria-label="Fecha del pago" />
          </div>
          <div style="flex:1">
            <label class="muted" for="wiz-mes">Mes</label>
            <input id="wiz-mes" type="number" min="1" max="12" placeholder="Ej. 7" style="width:100%" aria-label="Mes del período" />
          </div>
          <div style="flex:1">
            <label class="muted" for="wiz-año">Año</label>
            <input id="wiz-año" type="number" min="2000" max="2100" placeholder="Ej. 2025" style="width:100%" aria-label="Año del período" />
          </div>
        </div>
      </div>
      <div class="wizard-step" data-step="2">
        <div class="input-row">
          <div style="flex:1">
            <label class="muted" for="wiz-concepto">Concepto</label>
            <select id="wiz-concepto" style="width:100%" aria-label="Concepto" title="Opcional: si no se selecciona, se usa \"Cuota Mensual\"">
              <option value="">Seleccionar concepto</option>
            </select>
          </div>
        </div>
        <details id="wiz-items-advanced" style="border:1px solid var(--border); border-radius:6px; padding:10px; margin-top:8px;">
          <summary style="cursor:pointer"><strong>Ítems del pago</strong> <span class="muted">(opcional)</span></summary>
          <div id="wiz-items-list" style="border:1px solid var(--border); border-radius:6px; padding:8px; display:flex; flex-direction:column; gap:8px; margin-top:8px;">
            <div id="wiz-items-rows" style="display:flex; flex-direction:column; gap:8px"></div>
            <button class="btn success" id="wiz-item-add" type="button">Agregar ítem</button>
          </div>
          <div class="input-row" style="margin-top:8px;">
            <div style="flex:1"><label class="muted" for="wiz-items-subtotal">Subtotal</label><input id="wiz-items-subtotal" type="number" step="0.01" inputmode="decimal" placeholder="0.00" style="width:100%" readonly /></div>
            <div style="flex:1"><label class="muted" for="wiz-items-total">Total</label><input id="wiz-items-total" type="number" step="0.01" inputmode="decimal" placeholder="0.00" style="width:100%" readonly /></div>
            <div style="flex:1"><label class="muted" for="wiz-items-count">Total de ítems</label><input id="wiz-items-count" type="number" step="1" inputmode="numeric" placeholder="0" style="width:100%" readonly /></div>
          </div>
        </details>
      </div>
      <div class="wizard-step" data-step="3">
        <div class="input-row">
          <div style="flex:1">
            <label class="muted" for="wiz-metodo">Método de pago</label>
            <select id="wiz-metodo" style="width:100%" aria-label="Método de pago" title="Opcional: afecta comisión y total">
              <option value="">Seleccionar (opcional)</option>
            </select>
          </div>
        </div>
      </div>
      <div class="wizard-step" data-step="4">
        <div class="input-row">
          <div style="flex:1">
            <label class="muted" for="wiz-monto">Monto</label>
            <input id="wiz-monto" type="number" step="0.01" placeholder="Calculado automáticamente" style="width:100%" readonly aria-label="Monto" required title="Se calcula automáticamente según concepto y método" />
            <div id="wiz-monto-error" role="alert" aria-live="polite" style="display:none;color:#b00020;margin-top:4px;">El monto no puede ser vacío.</div>
          </div>
        </div>
        <div id="pago-wizard-resumen" class="calc-summary" style="margin-top:8px; font-size:12px; color:#555">
          <div><strong>Concepto:</strong> <span id="wiz-resumen-concepto">Cuota Mensual</span></div>
          <div><strong>Base:</strong> $<span id="wiz-resumen-base">—</span></div>
          <div><strong>Comisión:</strong> $<span id="wiz-resumen-comision">—</span> <span id="wiz-resumen-comision-porcentaje"></span></div>
          <div><strong>Total:</strong> $<span id="wiz-resumen-total">—</span></div>
          <div><strong>Ítems:</strong> <span id="wiz-resumen-items">0</span></div>
        </div>
      </div>
    </div>
    <div class="side-sheet-footer">
      <button class="btn outline neutral" data-close-sheet="#pago-wizard">Cancelar</button>
      <div style="flex:1"></div>
      <button class="btn success" id="pago-wizard-save" aria-keyshortcuts="Control+Enter" title="Atajo: Ctrl+Enter para guardar">Guardar</button>
    </div>
  </div>

  <!-- Side‑sheet: Ficha de Usuario -->
  <div class="side-sheet" id="usuario-sheet" role="dialog" aria-modal="true" aria-labelledby="usuario-sheet-title">
    <div class="side-sheet-header">
      <h3 id="usuario-sheet-title">Ficha de Usuario</h3>
      <button class="btn icon-only" data-close-sheet="#usuario-sheet" aria-label="Cerrar">×</button>
    </div>
    <div class="side-sheet-body">
      <div class="grid two-cols" style="gap:12px">
        <div class="card"><div class="card-title">Estado</div><div class="card-value" id="usuario-sheet-estado">—</div></div>
        <div class="card"><div class="card-title">Próximo vencimiento</div><div class="card-value" id="usuario-sheet-vencimiento">—</div></div>
        <div class="card"><div class="card-title">Cuotas vencidas</div><div class="card-value" id="usuario-sheet-cuotas-vencidas">—</div></div>
        <div class="card"><div class="card-title">Último pago</div><div class="card-value" id="usuario-sheet-ultimo-pago">—</div></div>
      </div>
      <div class="input-row" style="margin-top:12px">
        <div style="flex:1"><label class="muted">Nombre</label><div id="usuario-sheet-nombre"></div></div>
        <div style="flex:1"><label class="muted">DNI</label><div id="usuario-sheet-dni"></div></div>
      </div>
      <div class="input-row">
        <div style="flex:1"><label class="muted">Teléfono</label><div id="usuario-sheet-telefono"></div></div>
        <div style="flex:1"><label class="muted">Rol</label><div id="usuario-sheet-rol"></div></div>
      </div>
      <div class="input-row">
        <div style="flex:1"><label class="muted">Tipo de cuota</label><div id="usuario-sheet-tipo-cuota"></div></div>
      </div>
    </div>
    <div class="side-sheet-footer">
      <button class="btn" id="usuario-sheet-registrar">Registrar pago</button>
      <button class="btn" id="usuario-sheet-ver-pagos">Ver pagos</button>
      <div style="flex:1"></div>
      <button class="btn outline neutral" data-close-sheet="#usuario-sheet">Cerrar</button>
    </div>
  </div>

  <!-- Modal: Sesión (Editar) -->
  <div class="modal-backdrop" id="modal-sesion-form" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="sesion-form-title">
      <div class="modal-header">
        <h3 id="sesion-form-title" style="margin:0; font-size:16px;">Editar sesión</h3>
        <button class="modal-close" id="sesion-form-close" aria-label="Cerrar">×</button>
      </div>
      <div class="modal-body">
        <div class="input-row">
          <div style="flex:1">
            <label class="muted" for="sesion-fecha">Fecha</label>
            <input id="sesion-fecha" type="date" style="width:100%" aria-label="Fecha" />
            <div id="sesion-fecha-dia" class="muted" style="margin-top:4px; font-size:12px;">—</div>
          </div>
          <div style="flex:1">
            <label class="muted" for="sesion-inicio">Inicio</label>
            <input id="sesion-inicio" type="time" style="width:100%" aria-label="Inicio" />
          </div>
          <div style="flex:1">
            <label class="muted" for="sesion-fin">Fin</label>
            <input id="sesion-fin" type="time" style="width:100%" aria-label="Fin" />
          </div>
        </div>
        <div class="input-row">
          <div style="flex:1">
            <label class="muted" for="sesion-tipo">Tipo</label>
            <select id="sesion-tipo" style="width:100%" aria-label="Tipo de actividad" title="Clasificación de la sesión">
              <option value="Auto">Automático (según horario)</option>
              <option value="En horario">En horario</option>
              <option value="Horas extra">Horas extra</option>
              <option value="Trabajo">Trabajo</option>
            </select>
            <div id="sesion-tipo-hint" class="calc-summary" style="margin-top:6px; font-size:12px; color:#555">Sugerencia según horarios: <span id="sesion-tipo-sugerido">—</span></div>
            <div id="sesion-tipo-warning" style="display:none; margin-top:6px; font-size:12px; color:#8a6d3b; background:#fff9e6; border:1px solid #ffecb3; border-radius:4px; padding:6px;">
              Advertencia: la selección "En horario" no coincide con el cálculo y se corregirá al guardar.
            </div>
          </div>
        </div>
        <div class="input-row">
          <div style="flex:1">
            <label class="muted" for="sesion-minutos">Minutos</label>
            <input id="sesion-minutos" type="number" min="0" step="1" placeholder="Ej. 60" style="width:100%" aria-label="Minutos trabajados" disabled />
          </div>
          <div style="flex:0; display:flex; align-items:flex-end; justify-content:flex-end; gap:8px; min-width:180px;">
            <label class="muted" for="sesion-auto" style="margin:0;">Cálculo automático</label>
            <input id="sesion-auto" type="checkbox" checked aria-label="Calcular minutos automáticamente" />
          </div>
        </div>
        <div id="sesion-resumen" class="calc-summary" style="margin-top:8px; font-size:12px; color:#555">
          <div><strong>Minutos calculados:</strong> <span id="sesion-resumen-min">—</span></div>
          <div><strong>Horas:</strong> <span id="sesion-resumen-horas">—</span></div>
        </div>
        <div id="sesion-extra-info" class="calc-summary" style="margin-top:8px; font-size:12px; display:flex; gap:8px; align-items:center; flex-wrap:wrap">
          <span id="sesion-chip-cobertura" class="chip success" title="Minutos dentro de horario">En horario: —</span>
          <span id="sesion-chip-extra" class="chip danger" title="Minutos fuera de horario">Horas extra: —</span>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn success" id="sesion-save">Guardar</button>
        <button class="btn outline neutral" id="sesion-form-cancel">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal: Tipo de Cuota (Crear/Editar) -->
  <div class="modal-backdrop" id="modal-tipo-cuota" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-tipo-cuota-title">
      <div class="modal-header">
        <h3 id="modal-tipo-cuota-title">Tipo de Cuota</h3>
        <button class="modal-close" id="close-modal-tipo-cuota" aria-label="Cerrar">×</button>
      </div>
      <div class="modal-body">
        <div class="form-grid">
          <div class="form-row">
            <label>Nombre</label>
            <input type="text" id="tipo-nombre" placeholder="Mensual, Trimestral, ...">
          </div>
          <div class="form-row">
            <label>Precio</label>
            <input type="number" id="tipo-precio" min="0" step="0.01">
          </div>
          <div class="form-row">
            <label>Duración (días)</label>
            <input type="number" id="tipo-duracion" min="1" step="1">
          </div>
          <div class="form-row">
            <label>Activo</label>
            <select id="tipo-activo">
              <option value="true">Sí</option>
              <option value="false">No</option>
            </select>
          </div>
          <div class="form-row">
            <label>Descripción</label>
            <textarea id="tipo-descripcion"></textarea>
          </div>
          <div class="form-row">
            <label>Icono (ruta opcional)</label>
            <input type="text" id="tipo-icono" placeholder="/static/icons/monthly.svg">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn success" id="save-tipo-cuota">Guardar</button>
        <button class="btn outline neutral" id="cancel-tipo-cuota">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal: Concepto de Pago (Crear/Editar) -->
  <div class="modal-backdrop" id="modal-concepto" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-concepto-title">
      <div class="modal-header">
        <h3 id="modal-concepto-title">Concepto de Pago</h3>
        <button class="modal-close" id="close-modal-concepto" aria-label="Cerrar">×</button>
      </div>
      <div class="modal-body">
        <div class="form-grid">
          <div class="form-row">
            <label>Nombre</label>
            <input type="text" id="concepto-nombre" placeholder="Cuota Mensual, Matrícula, ...">
          </div>
          <div class="form-row">
            <label>Precio base</label>
            <input type="number" id="concepto-precio-base" min="0" step="0.01">
          </div>
          <div class="form-row">
            <label>Tipo</label>
            <input type="text" id="concepto-tipo" placeholder="cuota, servicio">
          </div>
          <div class="form-row">
            <label>Activo</label>
            <select id="concepto-activo">
              <option value="true">Sí</option>
              <option value="false">No</option>
            </select>
          </div>
          <div class="form-row">
            <label>Categoría</label>
            <input type="text" id="concepto-categoria" placeholder="mensualidad, inscripción">
          </div>
          <div class="form-row">
            <label>Descripción</label>
            <textarea id="concepto-descripcion"></textarea>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn success" id="save-concepto">Guardar</button>
        <button class="btn outline neutral" id="cancel-concepto">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal: Método de Pago (Crear/Editar) -->
  <div class="modal-backdrop" id="modal-metodo" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-metodo-title">
      <div class="modal-header">
        <h3 id="modal-metodo-title">Método de Pago</h3>
        <button class="modal-close" id="close-modal-metodo" aria-label="Cerrar">×</button>
      </div>
      <div class="modal-body">
        <div class="form-grid">
          <div class="form-row">
            <label>Nombre</label>
            <input type="text" id="metodo-nombre" placeholder="Efectivo, Tarjeta, ...">
          </div>
          <div class="form-row">
            <label>Comisión (%)</label>
            <input type="number" id="metodo-comision" min="0" step="0.01">
          </div>
          <div class="form-row">
            <label>Color</label>
            <input type="text" id="metodo-color" placeholder="#00AA66">
          </div>
          <div class="form-row">
            <label>Activo</label>
            <select id="metodo-activo">
              <option value="true">Sí</option>
              <option value="false">No</option>
            </select>
          </div>
          <div class="form-row">
            <label>Descripción</label>
            <textarea id="metodo-descripcion"></textarea>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn success" id="save-metodo">Guardar</button>
        <button class="btn outline neutral" id="cancel-metodo">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modales: Ejercicios -->
<div class="modal-backdrop" id="modal-ejercicio-form" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-ejercicio-title">
    <div class="modal-header">
      <h3 id="modal-ejercicio-title" style="margin:0; font-size:16px;">Ejercicio</h3>
      <button class="modal-close" id="close-modal-ejercicio" aria-label="Cerrar">×</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-row">
          <label for="ejercicio-nombre">Nombre</label>
          <input id="ejercicio-nombre" type="text" placeholder="Ej. Press banca" />
        </div>
        <div class="form-row">
          <label for="ejercicio-grupo">Grupo muscular</label>
          <input id="ejercicio-grupo" type="text" placeholder="Pecho, Espalda, etc." />
        </div>
        <div class="form-row">
          <label for="ejercicio-objetivo">Objetivo</label>
          <select id="ejercicio-objetivo">
            <option value="general">General</option>
            <option value="fuerza">Fuerza</option>
            <option value="hipertrofia">Hipertrofia</option>
            <option value="resistencia">Resistencia</option>
            <option value="cardio">Cardio</option>
            <option value="flexibilidad">Flexibilidad</option>
          </select>
        </div>
        <div class="form-row">
          <label for="ejercicio-descripcion">Descripción</label>
          <textarea id="ejercicio-descripcion" placeholder="Instrucciones, técnica y variantes"></textarea>
        </div>
        <div class="form-row">
          <label for="ejercicio-video-file">Video/GIF</label>
          <div class="ej-video-field" style="display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap; width:100%">
            <div class="ej-video-pane" style="flex:1 1 420px; min-width:320px">
              <div id="ejercicio-video-dropzone" tabindex="0" role="button" aria-label="Arrastra y suelta un video o GIF, o haz clic para seleccionar" aria-describedby="ejercicio-video-hint" style="border:2px dashed #ccc; border-radius:10px; padding:14px; text-align:center; cursor:pointer; user-select:none; min-height:220px; display:flex; flex-direction:column; justify-content:center; gap:10px">
                <div id="ejercicio-video-preview" class="muted" aria-live="polite">Sin video</div>
                <div id="ejercicio-video-msg" style="font-size:13px">Arrastra y suelta un video o GIF aquí, o haz clic para seleccionar</div>
              </div>
              <input id="ejercicio-video-file" type="file" accept="video/*,image/gif" style="display:none" />
            </div>
            <div class="ej-video-actions" style="flex:0 0 240px; display:flex; flex-direction:column; gap:8px">
              <button class="btn outline neutral" id="ejercicio-video-select" type="button">Seleccionar archivo</button>
              <button class="btn danger" id="ejercicio-video-remove" type="button">Eliminar video</button>
              <span id="ejercicio-video-remove-flag" style="display:none">0</span>
              <div id="ejercicio-video-hint" class="hint muted" style="font-size:12px">Tipos admitidos: Video (MP4/WebM) o GIF. Tamaño máximo recomendado 50MB.</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" id="save-ejercicio">Guardar</button>
      <button class="btn" id="cancel-ejercicio">Cancelar</button>
    </div>
  </div>
</div>

  <!-- Modales: Rutinas -->
<div class="modal-backdrop" id="modal-plantilla-new" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-plantilla-new-title" style="width: 60vw; max-width: 720px">
    <div class="modal-header">
      <h3 id="modal-plantilla-new-title" style="margin:0; font-size:16px;">Nueva plantilla</h3>
      <button class="modal-close" id="plantilla-new-close" aria-label="Cerrar">×</button>
    </div>
    <div class="modal-body">
      <div class="form-grid" style="display:grid; grid-template-columns: 1fr; gap:12px">
        <div class="form-row" style="display:grid; grid-template-columns: 1fr; gap:8px">
          <label for="plantilla-new-nombre">Nombre</label>
          <input id="plantilla-new-nombre" type="text" placeholder="Ej: Fuerza 1" aria-label="Nombre de plantilla" />
        </div>
        <div class="form-row" style="display:grid; grid-template-columns: 1fr; gap:8px">
          <label for="plantilla-new-descripcion">Descripción</label>
          <textarea id="plantilla-new-descripcion" placeholder="Estructura y objetivos" aria-label="Descripción de plantilla"></textarea>
        </div>
        <div class="form-row" style="display:grid; grid-template-columns: 1fr 1fr; gap:12px">
          <div>
            <label for="plantilla-new-categoria">Categoría</label>
            <select id="plantilla-new-categoria" aria-label="Categoría de plantilla">
              <option value="general" selected>General</option>
              <option value="fuerza">Fuerza</option>
              <option value="hipertrofia">Hipertrofia</option>
              <option value="resistencia">Resistencia</option>
              <option value="fullbody">Full body</option>
            </select>
          </div>
          <div>
            <label for="plantilla-new-dias">Días</label>
            <select id="plantilla-new-dias" aria-label="Días por semana">
              <option value="2">2</option>
              <option value="3" selected>3</option>
              <option value="4">4</option>
              <option value="5">5</option>
            </select>
          </div>
        </div>
        <div class="form-row" style="display:grid; grid-template-columns: 1fr; gap:8px">
          <div>
            <label for="plantilla-new-semanas">Semanas</label>
            <select id="plantilla-new-semanas" aria-label="Cantidad de semanas">
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4" selected>4</option>
            </select>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" id="plantilla-new-confirm">Continuar</button>
      <button class="btn outline neutral" id="plantilla-new-cancel">Cancelar</button>
    </div>
  </div>
</div>
<!-- Modal: Elección de creación de rutina/plantilla -->
<div class="modal-backdrop" id="modal-rutina-new-choice" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-rutina-new-choice-title" style="width: 65vw; max-width: 780px">
    <div class="modal-header">
      <h3 id="modal-rutina-new-choice-title" style="margin:0; font-size:16px;">Crear rutina</h3>
      <button class="modal-close" id="rutina-new-choice-close" aria-label="Cerrar">×</button>
    </div>
    <div class="modal-body" style="max-height: 70vh; overflow:auto">
      <div class="form-grid" style="gap:16px">
        <div class="form-row" style="display:flex; flex-direction:column; align-items:flex-start; border:1px solid var(--border); border-radius:12px; padding:12px; background:var(--card)">
          <strong style="display:block; font-size:14px; margin-bottom:8px; color: var(--primary)">Asignar a usuario</strong>
          <div style="display:grid; grid-template-columns: 1fr; gap:8px">
            <div>
              <label for="rutina-choice-user-search">Buscar usuario</label>
              <input id="rutina-choice-user-search" type="text" placeholder="Nombre, DNI o teléfono" aria-label="Buscar usuario" />
            </div>
            <div>
              <label for="rutina-choice-user">Usuario</label>
              <select id="rutina-choice-user" aria-label="Usuario"></select>
            </div>
          </div>
        </div>
        <div class="form-row" style="display:flex; flex-direction:column; align-items:flex-start; border:1px solid var(--border); border-radius:12px; padding:12px; background:var(--card)">
          <strong style="display:block; font-size:14px; margin-bottom:8px; color: var(--primary)">Desde plantilla</strong>
          <div style="display:grid; grid-template-columns: 1fr; gap:8px">
            <div>
              <label for="rutina-choice-template-search">Buscar plantilla</label>
              <input id="rutina-choice-template-search" type="text" placeholder="Buscar plantilla" aria-label="Buscar plantilla" />
            </div>
            <div>
              <label for="rutina-choice-template">Plantilla</label>
              <select id="rutina-choice-template" aria-label="Plantilla"></select>
            </div>
            <div style="display:flex; justify-content:flex-start">
              <button class="btn" id="rutina-choice-template-confirm">Continuar</button>
            </div>
          </div>
        </div>
        <div class="form-row" style="display:flex; flex-direction:column; align-items:flex-start; border:1px solid var(--border); border-radius:12px; padding:12px; background:var(--card)">
          <strong style="display:block; font-size:14px; margin-bottom:8px; color: var(--primary)">Desde cero</strong>
          <p class="muted" style="margin:6px 0 12px 0">Comenzar con rutina vacía y agregar ejercicios manualmente.</p>
          <div style="display:flex; justify-content:flex-start">
            <button class="btn" id="rutina-choice-scratch-confirm">Comenzar desde cero</button>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn outline neutral" id="rutina-new-choice-cancel">Cancelar</button>
    </div>
  </div>
</div>
<div class="modal-backdrop" id="modal-rutina-form" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-rutina-title" style="width: 75vw; max-width: 900px">
    <div class="modal-header">
      <h3 id="modal-rutina-title" style="margin:0; font-size:16px;">Rutina</h3>
      <button class="modal-close" id="close-modal-rutina" aria-label="Cerrar">×</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-row">
          <label for="rutina-nombre">Nombre</label>
          <input id="rutina-nombre" type="text" placeholder="Ej. Rutina Full Body" />
        </div>
        <div class="form-row">
          <label for="rutina-descripcion">Descripción</label>
          <textarea id="rutina-descripcion" placeholder="Estructura, objetivos y notas"></textarea>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" id="save-rutina">Guardar</button>
      <button class="btn" id="cancel-rutina">Cancelar</button>
    </div>
  </div>
</div>

<div class="modal-backdrop" id="modal-rutina-delete" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-rutina-del-title" style="width: 65vw; max-width: 780px">
    <div class="modal-header">
      <h3 id="modal-rutina-del-title" style="margin:0; font-size:16px;">Eliminar rutina</h3>
      <button class="modal-close" id="rutina-delete-close" aria-label="Cerrar">×</button>
    </div>
    <div class="modal-body">
      <p>¿Seguro que deseas eliminar esta rutina?</p>
    </div>
    <div class="modal-footer">
      <button class="btn" id="rutina-delete-confirm">Eliminar</button>
      <button class="btn" id="rutina-delete-cancel">Cancelar</button>
    </div>
</div>
</div>

<div class="modal-backdrop" id="modal-rutina-assign" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-rutina-assign-title" style="width: 70vw; max-width: 900px">
    <div class="modal-header">
      <h3 id="modal-rutina-assign-title" style="margin:0; font-size:16px;">Asignar rutina a usuario</h3>
      <button class="modal-close" id="rutina-assign-close" aria-label="Cerrar">×</button>
    </div>
    <div class="modal-body" style="max-height: 70vh; overflow:auto">
      <div class="form-grid">
        <div class="form-row"><div id="rutina-assign-summary" style="font-size: 13px; color: var(--text-muted)">Rutina seleccionada: <span id="rutina-assign-rutina-name">—</span> • Usuario actual: <span id="rutina-assign-current-user">—</span></div></div>
        <div class="form-row">
          <label for="rutina-assign-search">Buscar usuario</label>
          <input id="rutina-assign-search" type="text" placeholder="Nombre, DNI o teléfono" />
        </div>
        <div class="form-row">
          <label for="rutina-assign-user">Usuario</label>
          <select id="rutina-assign-user"></select>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" id="rutina-assign-confirm">Asignar</button>
      <button class="btn" id="rutina-assign-cancel">Cancelar</button>
    </div>
</div>
</div>

<!-- (El modal de Resumen de Rutina fue removido; se usa un toast no bloqueante) -->

<div class="modal-backdrop" id="modal-rutina-unassign" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-rutina-unassign-title" style="width: 70vw; max-width: 900px">
    <div class="modal-header">
      <h3 id="modal-rutina-unassign-title" style="margin:0; font-size:16px;">Desasignar rutina</h3>
      <button class="modal-close" id="rutina-unassign-close" aria-label="Cerrar">×</button>
    </div>
    <div class="modal-body" style="max-height: 70vh; overflow:auto">
      <div class="form-grid">
        <div class="form-row"><div id="rutina-unassign-summary" style="font-size: 13px; color: var(--text-muted)">Rutina seleccionada: <span id="rutina-unassign-rutina-name">—</span> • Usuario asignado: <span id="rutina-unassign-current-user">—</span></div></div>
        <div class="form-row">
          <label for="rutina-unassign-search">Buscar usuario</label>
          <input id="rutina-unassign-search" type="text" placeholder="Nombre, DNI o teléfono" />
        </div>
        <div class="form-row">
          <label for="rutina-unassign-user">Usuario</label>
          <select id="rutina-unassign-user"></select>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" id="rutina-unassign-confirm">Desasignar</button>
      <button class="btn" id="rutina-unassign-cancel">Cancelar</button>
    </div>
  </div>
</div>

<!-- Modal: Previsualización y edición avanzada de Rutina -->
<div class="modal-backdrop" id="modal-rutina-preview" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-rutina-preview-title" style="width: 99vw; max-width: 1600px; max-height: 95vh; overflow: auto; overscroll-behavior: contain">
    <div class="modal-header">
      <h3 id="modal-rutina-preview-title" style="margin:0; font-size:16px;">Vista previa de rutina</h3>
      <div id="rutina-preview-status" class="muted" aria-live="polite" style="margin-left:auto; margin-right:8px"></div>
      <button class="modal-close" id="rutina-preview-close" aria-label="Cerrar">×</button>
    </div>
    <div class="modal-body" style="max-height: 82vh; overflow:auto; overscroll-behavior: contain">
    <div class="form-grid" id="rutina-preview-form" style="margin-bottom:12px; padding:12px; background:var(--card); border:1px solid var(--border); border-radius:12px; gap:12px">
        <div class="form-row" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:12px; align-items:end">
          <div>
            <label for="rutina-preview-nombre">Nombre</label>
            <input id="rutina-preview-nombre" type="text" placeholder="Nombre de la rutina" style="width:100%" />
          </div>
          <div>
            <label for="rutina-preview-usuario-nombre">Usuario (encabezado)</label>
            <input id="rutina-preview-usuario-nombre" type="text" placeholder="Dejar vacío para usar asignado/Plantilla" style="width:100%" />
          </div>
        </div>
        <div class="form-row" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:12px; align-items:end">
          <div>
            <label for="rutina-preview-dias">Días</label>
            <select id="rutina-preview-dias" style="min-width:88px; width:auto">
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
            </select>
          </div>
          <div>
          <label for="rutina-preview-semanas">Semanas</label>
      <select id="rutina-preview-semanas" style="min-width:100px; width:auto">
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4" selected>4</option>
          </select>
          </div>
        </div>
        <div id="rutina-preview-advanced" style="margin-top:4px">
          <div class="form-row" style="display:grid; grid-template-columns: 1.6fr 1fr; gap:12px; align-items:end">
            <div>
              <label for="rutina-preview-descripcion">Descripción</label>
              <textarea id="rutina-preview-descripcion" placeholder="Estructura y objetivos"></textarea>
            </div>
            <div>
              <label for="rutina-preview-categoria">Categoría</label>
              <select id="rutina-preview-categoria">
                <option value="general">General</option>
                <option value="fuerza">Fuerza</option>
                <option value="hipertrofia">Hipertrofia</option>
                <option value="resistencia">Resistencia</option>
                <option value="fullbody">Full body</option>
              </select>
            </div>
          </div>
        </div>
        <!-- Control de ubicación del QR dentro del modal (no en controles flotantes) -->
        <div class="form-row" style="display:flex; gap:12px; align-items:center; flex-wrap:wrap">
          <label for="preview-qr-placement" style="display:flex; gap:6px; align-items:center"><span class="muted">QR</span>
            <select id="preview-qr-placement" aria-label="Ubicación del QR" style="min-width:160px">
              <option value="inline" selected>Segunda hoja (QR)</option>
              <option value="sheet">Debajo de la rutina</option>
              <option value="none">Sin QR</option>
            </select>
          </label>
          <!-- Input oculto para gestionar la hoja activa cuando QR=sheet -->
          <input id="preview-sheet-name" type="text" value="" style="display:none" aria-hidden="true" />
        </div>
        <div class="form-row" style="display:flex; flex-direction:column; gap:8px; align-items:flex-start">
          <label for="rutina-preview-add-ej">Agregar ejercicio</label>
          <div style="display:grid; grid-template-columns: 1fr; gap:8px; width:100%">
            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
              <input id="rutina-preview-ejercicio-search" type="text" placeholder="Buscar ejercicio..." aria-label="Buscar ejercicio" style="flex:2; min-width:220px" />
              <select id="rutina-preview-filter-group" title="Filtrar por grupo" aria-label="Filtrar por grupo" style="min-width:180px">
                <option value="">Grupo: Todos</option>
              </select>
              <select id="rutina-preview-filter-objetivo" title="Filtrar por objetivo" aria-label="Filtrar por objetivo" style="min-width:180px">
                <option value="">Objetivo: Todos</option>
              </select>
            </div>
            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
              <select id="rutina-preview-ejercicio" aria-label="Ejercicio" style="flex:2; min-width:240px"></select>
              <select id="rutina-preview-dia" aria-label="Día">
                <option value="1">Día 1</option>
                <option value="2">Día 2</option>
                <option value="3">Día 3</option>
                <option value="4">Día 4</option>
                <option value="5">Día 5</option>
              </select>
              <button class="btn" id="rutina-preview-add">Agregar</button>
              <button class="btn secondary sm" id="rutina-preview-new-ej" title="Crear nuevo ejercicio">Nuevo</button>
              <button class="btn secondary sm" id="rutina-preview-edit-ej" title="Editar ejercicio seleccionado">Editar</button>
              <button class="btn secondary sm" id="rutina-preview-toggle-advanced">Opciones avanzadas</button>
            </div>
          </div>
        </div>
      </div>

      <div id="rutina-preview-tools" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px">
        <label style="display:flex; gap:6px; align-items:center"><input id="rutina-preview-select-mode" type="checkbox" /> <span>Selección múltiple</span></label>
        <button class="btn secondary sm" id="rutina-preview-select-all">Seleccionar todo</button>
        <button class="btn tertiary" id="rutina-preview-collapse-days">Colapsar días</button>
      </div>

      <div id="rutina-preview-columns" style="display:grid; grid-template-columns: 1.6fr 1fr; gap:16px; align-items:start">
          <div>
            <div id="rutina-preview-grid" class="grid" style="display:grid; gap:8px"></div>
          </div>
          <div>
            <!-- Vista previa PDF integrada -->
            <div id="rutina-preview-pdf" class="table-scroll" style="border:1px solid var(--border); border-radius:8px; overflow:auto; position:relative">
              <div id="rutina-preview-pdf-status" class="muted" role="status" aria-live="polite" style="display:none; padding:8px; border-bottom:1px solid var(--border)">Actualizando vista previa…</div>
              <div id="rutina-preview-pdf-empty" class="muted" style="padding:12px">Genera la vista previa guardando la rutina; se mostrará el Excel en el visor automáticamente.</div>
              <iframe id="rutina-preview-frame" title="Vista previa de la rutina" style="display:none; width:100%; height:80vh; min-height:480px; border:0; transform-origin: center top" src=""></iframe>
            </div>
          </div>
        </div>
      <div id="rutina-preview-float" class="floating-panel" style="position:absolute; display:none; z-index:1000; background:#fff; border:1px solid #ddd; border-radius:8px; padding:12px; box-shadow:0 8px 24px rgba(0,0,0,0.22); min-width:560px">
        <div style="display:flex; flex-direction:column; gap:6px">
          <div><strong id="rutina-preview-float-title">Ejercicio</strong></div>
          <div id="rutina-preview-float-weekly-inputs" style="display:block">
            <table id="rutina-preview-weekly-table" style="width:100%; border-collapse:collapse;">
              <thead>
                <tr>
                  <th class="muted" style="text-align:left; padding:6px; border-bottom:1px solid #eee">&nbsp;</th>
                  <th style="padding:6px; border-bottom:1px solid #eee">Semana 1</th>
                  <th style="padding:6px; border-bottom:1px solid #eee">Semana 2</th>
                  <th style="padding:6px; border-bottom:1px solid #eee">Semana 3</th>
                  <th style="padding:6px; border-bottom:1px solid #eee">Semana 4</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="muted" style="padding:6px">Repeticiones</td>
                  <td style="padding:6px"><input id="rutina-preview-float-r1" type="number" min="1" style="width:100%" /></td>
                  <td style="padding:6px"><input id="rutina-preview-float-r2" type="number" min="1" style="width:100%" /></td>
                  <td style="padding:6px"><input id="rutina-preview-float-r3" type="number" min="1" style="width:100%" /></td>
                  <td style="padding:6px"><input id="rutina-preview-float-r4" type="number" min="1" style="width:100%" /></td>
                </tr>
                <tr>
                  <td class="muted" style="padding:6px">Series</td>
                  <td style="padding:6px"><input id="rutina-preview-float-s1" type="number" min="1" style="width:100%" /></td>
                  <td style="padding:6px"><input id="rutina-preview-float-s2" type="number" min="1" style="width:100%" /></td>
                  <td style="padding:6px"><input id="rutina-preview-float-s3" type="number" min="1" style="width:100%" /></td>
                  <td style="padding:6px"><input id="rutina-preview-float-s4" type="number" min="1" style="width:100%" /></td>
                </tr>
              </tbody>
            </table>
          </div>
          <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap">
            <label style="display:flex; gap:8px; align-items:center; justify-content:space-between"><span>Orden</span><input id="rutina-preview-float-orden" type="number" min="1" max="8" style="width:120px" /></label>
            <label style="display:flex; gap:8px; align-items:center; justify-content:space-between"><span>Día</span>
              <select id="rutina-preview-float-dia">
                <option value="1">Día 1</option>
                <option value="2">Día 2</option>
                <option value="3">Día 3</option>
                <option value="4">Día 4</option>
                <option value="5">Día 5</option>
              </select>
            </label>
          </div>
          <div style="display:flex; gap:8px; margin-top:6px; align-items:center; flex-wrap:wrap">
            <button class="btn" id="rutina-preview-float-up" title="Subir orden">↑</button>
            <button class="btn" id="rutina-preview-float-down" title="Bajar orden">↓</button>
        <button class="btn info" id="rutina-preview-float-dup" title="Duplicar ejercicio">Duplicar</button>
          </div>
          <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap">
            <button class="btn" id="rutina-preview-float-apply">Aplicar</button>
        <button class="btn danger" id="rutina-preview-float-remove">Eliminar</button>
            <button class="btn" id="rutina-preview-float-close">Cerrar</button>
          </div>
        </div>
      </div>
      <div class="table-scroll" id="rutina-preview-excel" style="margin-top:12px; border:1px solid var(--border); border-radius:12px; background:var(--card); padding:8px; overscroll-behavior: contain;"
          <table id="rutina-preview-excel-table">
          <thead>
            <tr>
              <th>Día</th>
              <th>Ejercicio</th>
              <th>Series</th>
              <th>Repeticiones</th>
              <th>Orden</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <div class="modal-footer">
        <button class="btn success" id="rutina-preview-save">Guardar cambios</button>
        <button class="btn info" id="rutina-preview-export">Exportar Excel</button>
        <button class="btn outline neutral" id="rutina-preview-cancel">Cancelar</button>
    </div>
  </div>
  
</div>

<!-- Modal: Exportar Excel de Rutina (previsualización y edición rápida) -->
<div class="modal-backdrop" id="modal-rutina-export" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-rutina-export-title" style="width: 95vw; max-width: 1200px">
    <div class="modal-header">
      <h3 id="modal-rutina-export-title" style="margin:0; font-size:16px;">Exportar a Excel</h3>
      <button class="modal-close" id="rutina-export-close" aria-label="Cerrar">×</button>
    </div>
    <div class="modal-body" style="max-height: 70vh; overflow:auto">
      <div class="form-grid" style="margin-bottom:8px">
        <div class="form-row">
          <label for="rutina-export-filename">Nombre de archivo</label>
          <input id="rutina-export-filename" type="text" placeholder="rutina.xlsx" />
        </div>
        <div class="form-row">
          <label for="rutina-export-weeks">Semanas a exportar (1-4)</label>
          <input id="rutina-export-weeks" type="number" min="1" max="4" value="1" aria-describedby="rutina-export-weeks-help" />
          <small id="rutina-export-weeks-help" class="muted">Elige cuántas semanas incluir en el Excel.</small>
        </div>
        <div class="form-row">
          <label for="rutina-export-usuario-nombre">Usuario (encabezado)</label>
          <input id="rutina-export-usuario-nombre" type="text" placeholder="Dejar vacío para usar asignado/Plantilla" />
        </div>
        <div class="form-row">
          <label for="rutina-export-qr-mode">Ubicación del QR</label>
          <select id="rutina-export-qr-mode" aria-describedby="rutina-export-qr-help">
            <option value="inline" selected>Debajo de la rutina</option>
            <option value="sheet">Segunda hoja (QR)</option>
            <option value="none">Sin QR</option>
          </select>
          <small id="rutina-export-qr-help" class="muted">Elige dónde colocar el QR en el Excel.</small>
        </div>
        <div class="form-row">
          <label for="rutina-export-sheet-name">Hoja activa (opcional)</label>
          <input id="rutina-export-sheet-name" type="text" placeholder="Ej: Día 1 o QR" aria-describedby="rutina-export-sheet-help" />
          <small id="rutina-export-sheet-help" class="muted">Deja vacío para usar la hoja predeterminada.</small>
        </div>
      </div>
      <div class="form-grid" style="margin:8px 0;">
        <div class="form-row">
          <label>Aplicar a todas</label>
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
            <input id="rutina-export-all-series" type="number" min="1" placeholder="Series" style="width:120px" />
            <input id="rutina-export-all-reps" type="number" min="1" placeholder="Repeticiones" style="width:140px" />
        <button class="btn success" id="rutina-export-apply-all">Aplicar a todas</button>
          </div>
        </div>
      </div>
      <div class="table-scroll">
        <table id="rutina-export-table">
          <thead>
            <tr>
              <th>Día</th>
              <th>Ejercicio</th>
              <th>Series</th>
              <th>Repeticiones</th>
              <th>Orden</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <p class="muted">Puedes editar Series y Repeticiones directamente en la tabla. La previsualización se genera desde el archivo final del backend.</p>
      <div style="margin-top:12px">
        <div style="display:flex; align-items:center; gap:8px; justify-content:space-between; flex-wrap:wrap">
          <span class="muted">Vista previa literal del Excel generado</span>
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
            <label for="rutina-export-sheet" class="muted" style="font-size:13px">Hoja</label>
            <select id="rutina-export-sheet" aria-label="Seleccionar hoja" style="min-width:140px"><option value="0">Hoja 1</option></select>
            <label for="rutina-export-zoom" class="muted" style="font-size:13px">Zoom</label>
            <input id="rutina-export-zoom" type="range" min="50" max="200" step="10" value="100" aria-label="Zoom de vista previa" />
            <span id="rutina-export-zoom-label" class="muted" aria-live="polite">100%</span>
            <button class="btn info" id="rutina-export-preview-btn">Actualizar vista previa</button>
            <button class="btn success" id="rutina-export-save-btn">Guardar cambios</button>
          </div>
        </div>
        <div id="rutina-export-preview" class="table-scroll" style="margin-top:8px"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn info" id="rutina-export-download">Descargar Excel</button>
      <button class="btn outline neutral" id="rutina-export-close-btn">Cerrar</button>
    </div>
  </div>
</div>
<div class="modal-backdrop" id="modal-ejercicio-delete" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-ejercicio-del-title">
    <div class="modal-header">
      <h3 id="modal-ejercicio-del-title" style="margin:0; font-size:16px;">Eliminar ejercicio</h3>
      <button class="modal-close" id="ejercicio-delete-close" aria-label="Cerrar">×</button>
    </div>
    <div class="modal-body">
      <p>¿Seguro que deseas eliminar este ejercicio?</p>
    </div>
    <div class="modal-footer">
      <button class="btn" id="ejercicio-delete-confirm">Eliminar</button>
      <button class="btn" id="ejercicio-delete-cancel">Cancelar</button>
    </div>
  </div>
</div>

<!-- Modal: Ejercicio Extras (Equipamiento y Variantes) -->
<div class="modal-backdrop" id="modal-ejercicio-extras" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-ejercicio-extras-title">
    <div class="modal-header">
      <h3 id="modal-ejercicio-extras-title" style="margin:0; font-size:16px;">Editar equipamiento y variantes</h3>
      <button class="modal-close" id="close-modal-extras" aria-label="Cerrar">×</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-row">
          <label for="extras-equipamiento">Equipamiento sugerido</label>
          <textarea id="extras-equipamiento" placeholder="Un ítem por línea o separados por ;"></textarea>
        </div>
        <div class="form-row">
          <label for="extras-variantes">Variantes útiles</label>
          <textarea id="extras-variantes" placeholder="Un ítem por línea o separados por ;"></textarea>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn success" id="save-extras">Guardar</button>
      <button class="btn outline neutral" id="cancel-extras">Cancelar</button>
    </div>
  </div>
</div>

<!-- Modal: QR Check-in Toast -->
  <div class="modal-backdrop" id="modal-qr-toast" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-qr-title" aria-describedby="modal-qr-desc" style="max-width: 380px;">
      <div class="modal-header">
        <h3 id="modal-qr-title" style="margin:0; font-size:16px; font-weight:600;">QR de Check-in</h3>
        <button class="modal-close" id="qr-close-btn" aria-label="Cerrar" style="border:none; background:transparent; font-size:20px; line-height:1; cursor:pointer;">×</button>
      </div>
      <div class="modal-body" style="text-align:center;">
        <p id="modal-qr-desc" class="sr-only" style="position:absolute;left:-9999px;">Escanea este código QR para registrar la asistencia. El token expira en pocos minutos.</p>
        <div id="qr-user-name" style="margin-bottom:8px; color: var(--text); font-weight:600;">—</div>
        <div style="display:inline-flex; align-items:center; justify-content:center; padding:10px; border-radius:12px; background: var(--card); border: 1px solid var(--border); box-shadow: 0 8px 20px rgba(0,0,0,0.35);">
          <canvas id="qr-canvas" width="240" height="240" style="display:block; margin:0 auto; border-radius:8px; background: var(--card);"></canvas>
        </div>
        <div id="qr-token-masked" style="margin-top:10px; color: var(--muted); font-size:13px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;">token: —</div>
        <div style="margin-top:12px; font-size:13px; color: var(--text)">
          <span style="font-weight:600">Tiempo restante:</span> <span id="qr-countdown" aria-live="polite">—</span>
        </div>
        <div style="margin-top:8px; height:8px; width:100%; background: rgba(139,120,185,0.22); border-radius:999px; overflow:hidden;" aria-label="Progreso de tiempo restante">
          <div id="qr-progress" style="display:block; height:100%; width:0%; background:#8b78b9; transition: width 180ms ease; border-radius:999px; will-change: width;" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" aria-valuetext="0%"></div>
        </div>
        <div id="qr-status-msg" style="margin-top:12px; display:inline-block; padding:6px 10px; border-radius:999px; background: rgba(255,255,255,0.06); color: var(--text); font-size:12px;" aria-live="polite" aria-atomic="true">Esperando confirmación…</div>
      </div>
      <div class="modal-footer">
        <button class="btn outline neutral" id="qr-close-footer">Cerrar</button>
      </div>
    </div>
  </div>

    <div id="toast-container" class="toast-container" role="status" aria-live="polite" aria-atomic="true"></div>

  <script>
    let editingUserId = null;
    let editingPagoId = null;
    const state = { pagos: [], pagosFilters: { metodo: '', concepto: '' }, deleteUserId: null, deletePagoId: null, selectedPago: null, selectedUsuario: null, usuarioHistorial: [], usuarioWAHistorial: [], configTipos: [], configConceptos: [], configMetodos: [], editingTipoId: null, editingConceptoId: null, editingMetodoId: null, deleteTipoId: null, deleteConceptoId: null, deleteMetodoId: null, tiposCuotaActivos: [], tiposCuotaMap: {}, metodosPago: [], metodosPagoMap: {}, ejercicios: [], editingEjercicioId: null, deleteEjercicioId: null, selectedEjercicio: null, ejercicioVideoFile: null, ejercicioVideoRemove: false, editingEjercicioOriginalVideoUrl: null, rutinas: [], plantillas: [], activeRutinaTab: 'plantillas', assignPlantillaId: null, editingRutinaId: null, deleteRutinaId: null, selectedRutina: null, renumStartId: null, estadoPlantillas: [], estadoPlantillasMap: {}, rutinaSelectMode: false, rutinaSelected: [], rutinaCompact: false, rutinaDayCollapsed: {}, rutinaAutoSaveTimer: null, rutinaPreviewDirty: false, lastAutoSaveTs: 0, ejFilter: { q:'', group:'', objetivo:'' }, ejerciciosFiltered: null };

    function fmtDate(d){
      if(!d) return '';
      if (typeof d === 'string') {
        const s = d.trim();
        const m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
        if (m) {
          return `${m[1]}-${m[2]}-${m[3]}`;
        }
      }
      const dt = new Date(d);
      if(isNaN(dt.getTime())) return String(d);
      const y = dt.getFullYear();
      const m = String(dt.getMonth()+1).padStart(2,'0');
      const day = String(dt.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }
    // Formateo de fecha para display en español (DD/MM/YYYY) sin afectar valores de inputs
    function fmtDateEs(d){
      if(!d) return '';
      try{
        if(typeof d === 'string'){
          const s = d.trim();
          // ISO YYYY-MM-DD
          const m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
          if(m){ return `${m[3]}/${m[2]}/${m[1]}`; }
          // Intentar parsear por Date
          const dt = new Date(s);
          if(!isNaN(dt.getTime())){
            const dd = String(dt.getDate()).padStart(2,'0');
            const mm = String(dt.getMonth()+1).padStart(2,'0');
            const yy = String(dt.getFullYear());
            return `${dd}/${mm}/${yy}`;
          }
          return s;
        }
        const dt = new Date(d);
        if(isNaN(dt.getTime())) return String(d);
        const dd = String(dt.getDate()).padStart(2,'0');
        const mm = String(dt.getMonth()+1).padStart(2,'0');
        const yy = String(dt.getFullYear());
        return `${dd}/${mm}/${yy}`;
      }catch(_){ return String(d); }
    }

    // ===== WhatsApp por usuario — tarjetas y historial =====
    function mapWATitle(type){
      switch(String(type||'').trim()){
        case 'welcome': return 'Bienvenida';
        case 'payment': return 'Confirmación de pago';
        case 'deactivation': return 'Desactivación';
        case 'overdue': return 'Recordatorio vencimiento';
        case 'class_reminder': return 'Recordatorio de clase';
        default: return String(type||'');
      }
    }
    async function loadUsuarioWAUsersOptions(selectedId){
      try{
        const sel = document.getElementById('usuario-wa-user-select');
        if(!sel) return;
        // Mantener opción "Todos"
        sel.innerHTML = '<option value="">Todos</option>';
        const r = await fetch('/api/usuarios?limit=300', { headers: { 'Accept':'application/json' } });
        const list = await r.json().catch(()=> []);
        if(Array.isArray(list)){
          // Ordenar por nombre para facilitar búsqueda visual
          list.sort((a,b) => String(a.nombre||'').localeCompare(String(b.nombre||'')) || Number(a.id||a.usuario_id||0) - Number(b.id||b.usuario_id||0));
          for(const u of list){
            const id = u.id ?? u.usuario_id;
            const opt = document.createElement('option');
            opt.value = String(id);
            const nombre = (u.nombre && String(u.nombre).trim() !== '') ? String(u.nombre) : `Usuario ${id}`;
            const dni = u.dni ? ` (${u.dni})` : '';
            opt.textContent = nombre + dni;
            sel.appendChild(opt);
          }
        }
        if(selectedId){ sel.value = String(selectedId); }
      }catch(_){ /* silencioso */ }
    }
    function mapWAStatusText(st){
      const s = String(st||'').trim().toLowerCase();
      if(!s) return '—';
      if(s === 'sent') return 'Enviado';
      if(s === 'delivered') return 'Entregado';
      if(s === 'read') return 'Leído';
      if(s === 'failed') return 'Fallido';
      if(s === 'received') return 'Recibido';
      return st;
    }
    function getLastWAByType(items, type){
      const normalize = (t) => {
        const v = String(t||'').trim().toLowerCase();
        if(v === 'bienvenida') return 'welcome';
        if(v === 'confirmacion_pago' || v === 'payment_confirmation') return 'payment';
        if(v === 'desactivacion' || v === 'deactivation') return 'deactivation';
        if(v === 'recordatorio_vencida' || v === 'payment_reminder' || v === 'pago_recordatorio') return 'overdue';
        if(v === 'recordatorio_clase' || v === 'class_reminder') return 'class_reminder';
        return v;
      };
      const target = normalize(type);
      const arr = (Array.isArray(items) ? items : []).filter(m => normalize(m.message_type) === target);
      if(arr.length === 0) return null;
      arr.sort((a,b) => {
        const ad = new Date(a.sent_at || a.created_at || 0).getTime();
        const bd = new Date(b.sent_at || b.created_at || 0).getTime();
        return bd - ad;
      });
      return arr[0] || null;
    }
    function renderUsuarioWACards(items){
      const types = ['welcome','payment','deactivation','overdue'];
      types.forEach(t => {
        const last = getLastWAByType(items, t);
        const stEl = document.getElementById(`usuario-wa-status-${t}`);
        const dtEl = document.getElementById(`usuario-wa-date-${t}`);
        const cardEl = document.getElementById(`usuario-wa-card-${t}`);
        if(stEl) stEl.textContent = last ? mapWAStatusText(last.status) : 'Sin envío';
      if(dtEl) dtEl.textContent = `Fecha: ${last ? fmtDateEs(last.sent_at || last.created_at) : '—'}`;
        const btn = cardEl ? cardEl.querySelector('button[data-type]') : null;
        const isSent = last && ['sent','delivered','read'].includes(String(last.status||'').toLowerCase());
        if(btn){ btn.disabled = !!isSent; btn.title = isSent ? 'Ya enviado' : 'Forzar envío'; }
      });
    }
    function renderUsuarioWAHistoryTable(items){
      const tbody = document.getElementById('usuario-wa-historial-body');
      const empty = document.getElementById('usuario-wa-historial-empty');
      if(!tbody) return;
      tbody.innerHTML = '';
      const filter = document.getElementById('usuario-wa-filter');
      const ft = filter ? String(filter.value||'').trim().toLowerCase() : '';
      const normalize = (t) => {
        const v = String(t||'').trim().toLowerCase();
        if(v === 'bienvenida') return 'welcome';
        if(v === 'confirmacion_pago' || v === 'payment_confirmation') return 'payment';
        if(v === 'desactivacion') return 'deactivation';
        if(v === 'recordatorio_vencida' || v === 'payment_reminder' || v === 'pago_recordatorio') return 'overdue';
        if(v === 'recordatorio_clase') return 'class_reminder';
        return v;
      };
      const data = (Array.isArray(items)?items:[]).filter(m => !ft || normalize(m.message_type) === ft);
      if(data.length === 0){ if(empty) empty.style.display = 'block'; return; }
      if(empty) empty.style.display = 'none';
      data.forEach(m => {
        const tr = document.createElement('tr');
        const fecha = m.sent_at || m.created_at || '';
        const tipo = mapWATitle(m.message_type || '');
        const estado = mapWAStatusText(m.status || '');
        const contenido = String(m.message_content||'').slice(0, 100);
        const canRetry = ['welcome','payment','deactivation','overdue','class_reminder'].includes(String(m.message_type||'')) && String(m.status||'').toLowerCase() === 'failed';
        const midAttr = String(m.message_id||'');
        const actions = [
          canRetry ? '<button class="btn sm" data-retry="'+String(m.message_type||'')+'">Reintentar</button>' : '',
          '<button class="btn sm" data-delete-id="'+String(m.id||'')+'" data-delete-mid="'+midAttr+'">Borrar</button>'
        ].filter(Boolean).join(' ');
        tr.innerHTML = `<td>${fmtDateEs(fecha)}</td><td>${tipo}</td><td>${estado}</td><td>${contenido}</td><td>${actions}</td>`;
        // Guardar info en dataset para preview
        try {
          tr.dataset.fecha = String(fecha||'');
          tr.dataset.tipo = String(tipo||'');
          tr.dataset.estado = String(estado||'');
          tr.dataset.contenido = String(contenido||'');
        } catch(_){ }
        tbody.appendChild(tr);
      });
    }
    async function loadUsuarioWhatsApp(usuario_id){
      if(!usuario_id){ return; }
      try {
        const res = await fetch(`/api/usuarios/${usuario_id}/whatsapp/historial?limit=50`, { headers:{ 'Accept':'application/json' } });
        if(!res.ok){ const err = await res.json().catch(()=>({})); showToast(err.detail || err.error || 'No se pudo cargar historial de WhatsApp', 'error', 4500); return; }
        const json = await res.json();
        const items = Array.isArray(json?.items) ? json.items : (Array.isArray(json) ? json : []);
        state.usuarioWAHistorial = items;
        renderUsuarioWACards(items);
        renderUsuarioWAHistoryTable(items);
      } catch(e){ showToast('Error de red al cargar historial WA', 'error', 4500); }
    }
    async function forceSendWA(type){
      const u = state.selectedUsuario; if(!u || !u.id){ showToast('Selecciona un usuario', 'warning', 4000); return; }
      let url = '';
      let body = {};
      const t = String(type||'').trim();
      if(t === 'welcome') url = `/api/usuarios/${u.id}/whatsapp/bienvenida`;
      else if(t === 'payment') url = `/api/usuarios/${u.id}/whatsapp/confirmacion_pago`;
      else if(t === 'deactivation'){ url = `/api/usuarios/${u.id}/whatsapp/desactivacion`; body = { motivo: 'cuotas vencidas' }; }
      else if(t === 'overdue') url = `/api/usuarios/${u.id}/whatsapp/recordatorio_vencida`;
      else if(t === 'class_reminder') url = `/api/usuarios/${u.id}/whatsapp/recordatorio_clase`;
      else { showToast('Tipo de mensaje no soportado', 'warning', 3800); return; }
      try {
        const res = await fetch(url, { method:'POST', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: Object.keys(body).length ? JSON.stringify(body) : undefined });
        const data = await res.json().catch(()=>({}));
        if(!res.ok){
          const code = res.status;
          let msg = data?.detail || data?.error || data?.message || '';
          const metaText = String(data?.meta_detail || data?.meta_error || (data?.error && data.error.message) || '').toLowerCase();
          let metaMsg = '';
          if(metaText.includes('rate limit') || metaText.includes('too many')) metaMsg = 'Límite de mensajes de Meta alcanzado';
          else if(metaText.includes('not allowed') || metaText.includes('policy')) metaMsg = 'Bloqueado por política o plantilla no aprobada';
          else if(metaText.includes('could not be found') || metaText.includes('not found')) metaMsg = 'Número no registrado en WhatsApp';
          else if(metaText.includes('unsupported')) metaMsg = 'Tipo de mensaje no soportado por plantilla';
          if(code === 401){ msg = 'Falta WHATSAPP_ACCESS_TOKEN o token inválido'; }
          else if(code === 403){ msg = 'No autorizado para enviar WhatsApp'; }
          else if(code === 404){ msg = 'Usuario o recurso no encontrado'; }
          else if(code === 408){ msg = 'Tiempo de espera al contactar API de WhatsApp'; }
          else if(code === 429){ msg = 'Anti-spam: límite de envío alcanzado'; }
          else if(code >= 500){ msg = 'Error del servidor al enviar WhatsApp'; }
          else if(code === 400){ msg = msg || 'Datos incompletos o número inválido'; }
          const finalMsg = (msg || 'No se pudo enviar el mensaje') + (metaMsg ? ` — ${metaMsg}` : '');
          showToast(finalMsg, 'error', 5000);
        } else {
          const ok = (data && (data.success === true || data.ok === true)) || res.status < 300;
          if(!ok){ showToast('Envío bloqueado o no exitoso', 'warning', 4500); }
          else { showToast('Mensaje enviado', 'success', 3000); }
        }
      } catch(e){ showToast('Fallo de red al enviar mensaje', 'error', 5000); }
      // Refrescar tarjetas e historial tras enviar
      try { await loadUsuarioWhatsApp(u.id); } catch(_){ }
      try { await loadWALastForUser(u.id); } catch(_){ }
    }
    function defaultRange(){
      const end = new Date();
      const start = new Date(end);
      start.setDate(end.getDate() - 30);
      return { start: fmtDate(start), end: fmtDate(end) };
    }
    function switchTab(tab){
      // Cerrar cualquier side-sheet abierto al cambiar de módulo
      try {
        const opened = document.querySelectorAll('.side-sheet.open');
        opened.forEach(s => {
          try {
            if (window.UI && typeof UI.closeSideSheet === 'function') {
              UI.closeSideSheet(s);
            } else {
              s.classList.remove('open');
            }
          } catch(_){}
        });
        const backdrop = document.querySelector('.side-sheet-backdrop');
        if(backdrop) backdrop.classList.remove('open');
      } catch(_){}
      // Activar pestaña en el header y actualizar accesibilidad
      document.querySelectorAll('.tab').forEach(t => {
        const isActive = (t.dataset.tab === tab);
        t.classList.toggle('active', isActive);
        t.setAttribute('aria-selected', isActive ? 'true' : 'false');
      });
      // Activar panel correspondiente
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
      const panel = document.getElementById(`panel-${tab}`);
      if(panel) panel.classList.add('active');
      // Sincronizar estado activo en el sidebar
      const sidebarItems = document.querySelectorAll('.sidebar .nav-item[data-tab]');
      sidebarItems.forEach(item => {
        const isActive = (item.getAttribute('data-tab') || '') === String(tab);
        item.classList.toggle('active', isActive);
        if(isActive) item.setAttribute('aria-current', 'page');
        else item.removeAttribute('aria-current');
      });
      // Sincronizar estado activo en subtabs móviles
      const mobileItems = document.querySelectorAll('#mobile-subtabs [data-tab]');
      mobileItems.forEach(item => {
        const isActive = (item.getAttribute('data-tab') || '') === String(tab);
        item.classList.toggle('active', isActive);
        if(isActive) item.setAttribute('aria-current', 'page');
        else item.removeAttribute('aria-current');
      });
      // Persistir módulo activo
      try { localStorage.setItem('gestion-active-tab', String(tab)); } catch(_){}
      // Reordenar barra móvil (solo móvil) para coincidir con sidebar
      try { reorderMobileSubtabs(); } catch(_){}
      // Actualizar etiqueta del peek con el módulo activo
      try { updatePeekLabel(); } catch(_){}
    }

    // --- Toggle de barra móvil (usa mismo botón que sidebar) ---
    function isMobile(){ try{ return (window.innerWidth || document.documentElement.clientWidth || 0) <= 960; }catch(_){ return false; } }
    function openMobileSubtabs(){
      try{
        if(!isMobile()) return;
        document.body.classList.add('mobile-subtabs-open');
        const nav = document.getElementById('mobile-subtabs');
        if(nav){ nav.setAttribute('aria-hidden','false'); }
        document.querySelectorAll('[data-sidebar-toggle]').forEach(btn => { try{ btn.setAttribute('aria-expanded','true'); }catch(_){} });
        startMobileSubtabsAutoHide();
      }catch(_){ }
    }
    function closeMobileSubtabs(){
      try{
        document.body.classList.remove('mobile-subtabs-open');
        const nav = document.getElementById('mobile-subtabs');
        if(nav){ nav.setAttribute('aria-hidden','true'); }
        document.querySelectorAll('[data-sidebar-toggle]').forEach(btn => { try{ btn.setAttribute('aria-expanded','false'); }catch(_){} });
        stopMobileSubtabsAutoHide();
      }catch(_){ }
    }
    function toggleMobileSubtabs(){ try{ if(document.body.classList.contains('mobile-subtabs-open')) closeMobileSubtabs(); else openMobileSubtabs(); }catch(_){} }
    function startMobileSubtabsAutoHide(){ try{ window.clearTimeout(state._mobileSubtabsTimer); state._mobileSubtabsTimer = window.setTimeout(() => { try{ if(document.body.classList.contains('mobile-subtabs-open')) closeMobileSubtabs(); }catch(_){} }, 8000); }catch(_){} }
    function stopMobileSubtabsAutoHide(){ try{ window.clearTimeout(state._mobileSubtabsTimer); }catch(_){} }

    // Etiqueta dinámica del "peek" con el módulo activo
    function getActiveTabName(){
      try{
        const m = document.querySelector('#mobile-subtabs [data-tab].active');
        if(m){ return (m.textContent || '').trim(); }
        const h = document.querySelector('.tab.active');
        if(h){ return (h.textContent || '').trim(); }
        const s = document.querySelector('.sidebar .nav-item.active');
        if(s){ return (s.textContent || '').trim(); }
        return '';
      }catch(_){ return ''; }
    }
    function updatePeekLabel(){
      try{
        const labelEl = document.getElementById('mobile-subtabs-peek-label');
        if(!labelEl) return;
        const name = getActiveTabName();
        labelEl.textContent = name ? ('Módulos — ' + name) : 'Módulos';
      }catch(_){ }
    }

    // --- Mejoras móviles: orden consistente con sidebar ---
    function reorderMobileSubtabs(){
      try{
        if((window.innerWidth || document.documentElement.clientWidth || 0) > 960) return; // solo móvil
        const nav = document.getElementById('mobile-subtabs');
        const sidebar = document.querySelector('.sidebar .nav-group');
        if(!nav || !sidebar) return;
        const sidebarOrder = Array.from(sidebar.querySelectorAll('.nav-item[data-tab]')).map(el => el.getAttribute('data-tab') || '');
        const mobileItems = Array.from(nav.querySelectorAll('[data-tab]'));
        const map = new Map();
        mobileItems.forEach((el) => { map.set(el.getAttribute('data-tab') || '', el); });
        // Reconstruir en orden de sidebar; añadir los que no estén al final
        const fragment = document.createDocumentFragment();
        sidebarOrder.forEach(t => { const el = map.get(t); if(el) fragment.appendChild(el); map.delete(t); });
        // Resto en su orden actual
        map.forEach((el) => fragment.appendChild(el));
        nav.appendChild(fragment);
      }catch(_){ }
    }

    function openModal(id){
      const el = document.getElementById(id);
      if(el){
        // Cerrar overlays que podrían cubrir el modal y asegurar stacking por encima
        try {
          const sheetBackdrop = document.querySelector('.side-sheet-backdrop');
          if(sheetBackdrop) sheetBackdrop.classList.remove('open');
          const cmdkBackdrop = document.querySelector('.cmdk-backdrop');
          if(cmdkBackdrop) cmdkBackdrop.classList.remove('open');
          const cmdk = document.querySelector('.cmdk');
          if(cmdk) cmdk.classList.remove('open');
        } catch(_){ }
        try {
          const rootStyles = getComputedStyle(document.documentElement);
          const zModal = parseInt((rootStyles.getPropertyValue('--z-modal-backdrop')||'1000').trim(), 10) || 1000;
          const zSheet = parseInt((rootStyles.getPropertyValue('--z-sheet-backdrop')||'1001').trim(), 10) || 1001;
          const zCmdkB = parseInt((rootStyles.getPropertyValue('--z-cmdk-backdrop')||'1003').trim(), 10) || 1003;
          const base = Math.max(zModal, zSheet, zCmdkB) + 2;
          state._modalZBase = (state._modalZBase || base) + 1;
          el.style.zIndex = String(state._modalZBase);
        } catch(_){ }
        el.classList.add('active');
        el.setAttribute('aria-hidden','false');
        const modalEl = el.querySelector('.modal');
        if(modalEl){
          const labelId = modalEl.getAttribute('aria-labelledby');
          if(labelId){ const labelEl = document.getElementById(labelId); if(labelEl){ labelEl.setAttribute('tabindex','-1'); labelEl.focus(); } }
        }
      }
    }
    function closeModal(id){
      const el = document.getElementById(id);
      if(!el) return;
      const m = el.querySelector('.modal');
      if(m){
        m.classList.add('closing');
        setTimeout(() => { el.classList.remove('active'); m.classList.remove('closing'); el.setAttribute('aria-hidden','true'); }, 160);
      } else {
        el.classList.remove('active'); el.setAttribute('aria-hidden','true');
      }
    }

    // Toasts de notificación — centralizado en /static/js/toast.js
    // Usa showToast(message, type='info', duration=3500, actionText='OK');
    if (typeof window.showToast !== 'function') {
      window.showToast = function(message, type = 'info', duration = 3500, actionText = 'OK') {
        try {
          const cont = document.getElementById('toast-container');
          if (!cont) { console[type === 'error' ? 'error' : 'log'](message); return; }
          const toast = document.createElement('div');
          toast.className = `toast ${type}`;
          toast.textContent = message;
          cont.appendChild(toast);
          setTimeout(() => { toast.classList.add('visible'); }, 10);
          setTimeout(() => { toast.classList.remove('visible'); toast.remove(); }, duration);
        } catch (e) { console.error(message); }
      };
    }

    // ===== QR Check-in (Gestión) =====
    let qrState = { token: null, expiresTs: 0, totalMs: 0, countdownInt: null, pollInt: null };
    function stopQRTimers(){ if(qrState.countdownInt){ clearInterval(qrState.countdownInt); qrState.countdownInt=null; } if(qrState.pollInt){ clearInterval(qrState.pollInt); qrState.pollInt=null; } }
    function formatCountdown(ms){ if(ms<=0) return '0:00'; const total = Math.floor(ms/1000); const m = Math.floor(total/60); const s = String(total%60).padStart(2,'0'); return `${m}:${s}`; }
    function updateQRCountdown(){
      const el = document.getElementById('qr-countdown');
      const now = Date.now();
      const rem = Math.max(0, qrState.expiresTs - now);
      if(el) el.textContent = formatCountdown(rem);
      // Actualizar barra de progreso visual
      const prog = document.getElementById('qr-progress');
      if (prog) {
        const total = qrState.totalMs || (5 * 60 * 1000);
        const used = Math.max(0, total - rem);
        const pctBase = Math.round((used / total) * 100);
        const minWhenActive = rem > 0 ? 3 : 0;
        const pct = Math.min(100, Math.max(minWhenActive, pctBase));
        prog.style.width = pct + '%';
        prog.setAttribute('aria-valuenow', String(pct));
        prog.setAttribute('aria-valuetext', 'Restante ' + formatCountdown(rem));
      }
      if(rem<=0){
        const status = document.getElementById('qr-status-msg');
        if(status) status.textContent = 'Token expirado';
        stopQRTimers();
        setTimeout(() => closeQRModal(), 1200);
      }
    }
    function pollTokenStatus(){ if(!qrState.token) return; fetch(`/api/checkin/token_status?token=${encodeURIComponent(qrState.token)}`, { headers:{ 'Accept':'application/json' } })
      .then(r => r.json()).then(j => {
        const status = document.getElementById('qr-status-msg');
        if(j && j.exists){
          const used = !!j.used; const expired = !!j.expired;
          if(status){ status.textContent = used ? '¡Asistencia registrada!' : (expired ? 'Token expirado' : 'Esperando confirmación…'); }
          if(used){
            // Refrescar la tabla de usuarios y mantener la selección actual
            const u = state.selectedUsuario;
            (async () => {
              try {
                await loadUsers();
                if (u && u.id) {
                  const idx = (state.usuarios || []).findIndex(x => x.id === u.id);
                  if (idx >= 0) selectUsuarioByIndex(idx);
                }
              } catch(_) {}
            })();
            // Sincronizar set local para evitar re-emisión inmediata
            try { if (u && u.id && state.asistenciasHoySet instanceof Set) { state.asistenciasHoySet.add(Number(u.id)); } } catch(_){ }
          }
          if(used || expired){ stopQRTimers(); setTimeout(() => closeQRModal(), 1200); }
        } else {
          if(status) status.textContent = 'Token inválido o inexistente';
        }
      }).catch(() => {});
    }
    function closeQRModal(){ stopQRTimers(); qrState.token=null; qrState.expiresTs=0; qrState.totalMs=0; const un = document.getElementById('qr-user-name'); if(un) un.textContent='—'; const tm = document.getElementById('qr-token-masked'); if(tm) tm.textContent='token: —'; const prog = document.getElementById('qr-progress'); if(prog){ prog.style.width='0%'; prog.setAttribute('aria-valuenow','0'); } try{ document.body.classList.remove('qr-toast-open'); }catch(_){ } closeModal('modal-qr-toast'); }
    async function emitirQRCheckin(){ const u = state.selectedUsuario; if(!u || !u.id){ showToast('Selecciona un usuario primero para emitir el QR.', 'warning', 4000); return; }
      const set = state.asistenciasHoySet;
      if(set && set.has(Number(u.id))){
        showToast('El usuario ya asistió hoy. No se emite QR.', 'info', 3500);
        return;
      }
    const btnQR = document.getElementById('usuario-side-qr');
    const prevHTML = btnQR ? btnQR.innerHTML : '';
    if(btnQR){
      btnQR.disabled = true;
      btnQR.innerHTML = '<span class="btn-spinner" aria-hidden="true"></span><span>Generando QR…</span>';
    }
      const expires_minutes = 5;
      try{
        const res = await fetch('/api/checkin/create_token', { method:'POST', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify({ usuario_id: u.id, expires_minutes }) });
        if(!res.ok){ const err = await res.json().catch(() => ({})); throw new Error(err.detail || err.error || `Error ${res.status}`); }
        const data = await res.json();
        const token = String(data.token || '').trim(); if(!token){ throw new Error('No se generó token'); }
        qrState.token = token; qrState.totalMs = Number(data.expires_minutes||expires_minutes) * 60 * 1000; qrState.expiresTs = Date.now() + qrState.totalMs;
        const un = document.getElementById('qr-user-name'); if(un) un.textContent = String(u.nombre || `Usuario #${u.id}`);
        const tm = document.getElementById('qr-token-masked'); if(tm) tm.textContent = `token: ${token}`;
        try{ document.body.classList.add('qr-toast-open'); }catch(_){ }
        openModal('modal-qr-toast');
        showToast('QR de check-in generado correctamente.', 'success', 2500);
        const statusEl = document.getElementById('qr-status-msg'); if(statusEl) statusEl.textContent = 'Escanea el QR para registrar asistencia.';
        const canvasEl = document.getElementById('qr-canvas');
        if(canvasEl){ const ctx = canvasEl.getContext('2d'); if(ctx){ ctx.clearRect(0,0,canvasEl.width,canvasEl.height); ctx.fillStyle='#f5f5f5'; ctx.fillRect(0,0,canvasEl.width,canvasEl.height); ctx.strokeStyle='#ddd'; for(let i=0;i<=12;i++){ ctx.beginPath(); ctx.moveTo(i*20,0); ctx.lineTo(i*20,240); ctx.stroke(); ctx.beginPath(); ctx.moveTo(0,i*20); ctx.lineTo(240,i*20); ctx.stroke(); } } }
        let qrLibReady = false;
        try{
          if(typeof window.loadQRCodeLib === 'function'){
            qrLibReady = await window.loadQRCodeLib();
          } else {
            qrLibReady = !!window.QRCode;
          }
        }catch(_){ qrLibReady = !!window.QRCode; }
        const canvas = document.getElementById('qr-canvas');
        if(canvas && qrLibReady && window.QRCode && typeof window.QRCode.toCanvas === 'function'){
          try { window.QRCode.toCanvas(canvas, token, { width: 240 }); } catch(_){}
        } else {
          const status = document.getElementById('qr-status-msg'); if(status) status.textContent = 'No se pudo cargar la librería de QR. Usa ingreso manual.';
          if(tm) tm.textContent = `token: ${token}`;
        }
        updateQRCountdown(); stopQRTimers(); qrState.countdownInt = setInterval(updateQRCountdown, 1000); qrState.pollInt = setInterval(pollTokenStatus, 2000);
      }catch(e){ showToast(`No se pudo generar el QR: ${e.message}`, 'error', 4500); }
    finally {
      if(btnQR){
        btnQR.disabled = false;
        btnQR.innerHTML = prevHTML || 'Emitir QR Check-in';
      }
    }
    }

    // Accesibilidad: cerrar modal con botones, clic fuera y Escape
    try {
      const qrCloseBtn = document.getElementById('qr-close-btn');
      if(qrCloseBtn) qrCloseBtn.addEventListener('click', () => closeQRModal());
      const qrCloseFooter = document.getElementById('qr-close-footer');
      if(qrCloseFooter) qrCloseFooter.addEventListener('click', () => closeQRModal());
      const qrBackdrop = document.getElementById('modal-qr-toast');
      if(qrBackdrop) qrBackdrop.addEventListener('click', (ev) => { if(ev.target === qrBackdrop) closeQRModal(); });
      document.addEventListener('keydown', (ev) => { if(ev.key === 'Escape'){ const el = document.getElementById('modal-qr-toast'); if(el && el.classList.contains('active')){ ev.preventDefault(); closeQRModal(); } } });
    } catch(_){ }
    async function registrarAsistenciaQuick(){ const u = state.selectedUsuario; if(!u || !u.id){ showToast('Selecciona un usuario primero', 'warning', 4000); return; }
      try{
        const res = await fetch('/api/asistencias/registrar', { method:'POST', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify({ usuario_id: u.id }) });
        if(!res.ok){ const err = await res.json().catch(() => ({})); throw new Error(err.detail || err.error || `Error ${res.status}`); }
        const j = await res.json().catch(() => ({}));
        showToast('Asistencia registrada', 'success', 3000);
        await loadUsers(); const idx = (state.usuarios || []).findIndex(x => x.id === u.id); if(idx >= 0) selectUsuarioByIndex(idx);
      }catch(e){ showToast(`No se pudo registrar asistencia: ${e.message}`, 'error', 4500); }
    }

    async function eliminarAsistenciaQuick(){ const u = state.selectedUsuario; if(!u || !u.id){ showToast('Selecciona un usuario primero', 'warning', 4000); return; } const hoy = fmtDate(new Date()); try{ const res = await fetch('/api/asistencias/eliminar', { method:'DELETE', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify({ usuario_id: u.id, fecha: hoy }) }); if(!res.ok){ const err = await res.json().catch(() => ({})); throw new Error(err.detail || err.error || `Error ${res.status}`); } await res.json().catch(() => ({})); showToast('Asistencia eliminada', 'success', 3000); await loadUsers(); const idx = (state.usuarios || []).findIndex(x => x.id === u.id); if(idx >= 0) selectUsuarioByIndex(idx); }catch(e){ showToast(`No se pudo eliminar asistencia: ${e.message}`, 'error', 4500); } }

  async function handleAsistenciaClick(){ const u = state.selectedUsuario; if(!u || !u.id){ showToast('Selecciona un usuario primero', 'warning', 4000); return; } const btn = document.getElementById('usuario-side-asistencia'); const hoy = fmtDate(new Date()); const arr = Array.isArray(state.usuarioAsistencias) ? state.usuarioAsistencias : []; const hasHoy = arr.some(a => { const f = a.fecha || a.fecha_asistencia || a.fechaAsistencia || ''; return fmtDate(f) === hoy; }); const prevHTML = btn ? btn.innerHTML : ''; if(btn){ btn.disabled = true; btn.innerHTML = '<span class="btn-spinner" aria-hidden="true"></span><span>Procesando…</span>'; } try{ if(hasHoy){ await eliminarAsistenciaQuick(); } else { await registrarAsistenciaQuick(); } } finally { if(btn){ btn.disabled = false; btn.innerHTML = hasHoy ? 'Eliminar asistencia de hoy' : 'Registrar asistencia'; } } }

    function pagosAplicaFiltros(items){
      const metodo = (state.pagosFilters.metodo || '').trim().toLowerCase();
      const concepto = (state.pagosFilters.concepto || '').trim().toLowerCase();
      if(!metodo && !concepto) return items;
      return items.filter(row => {
        const m = String(row.metodo_pago || row.metodo || '').toLowerCase();
        const c = String(row.concepto_pago || row.concepto || '').toLowerCase();
        return (!metodo || m === metodo || m.includes(metodo)) && (!concepto || c === concepto || c.includes(concepto));
      });
    }

    // Helpers: debounce y skeleton loaders para mejorar UX con latencia
    function debounce(fn, ms = 300){ let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); }; }
    function showTableSkeleton(selector, colCount, rows = 8){
      try {
        const tbody = document.querySelector(`${selector} tbody`);
        if(!tbody) return;
        tbody.innerHTML = '';
        for(let i = 0; i < rows; i++){
          const tr = document.createElement('tr');
          let html = '';
          for(let j = 0; j < colCount; j++){
            html += '<td><div class="skeleton" style="height:14px;width:100%"></div></td>';
          }
          tr.innerHTML = html;
          tbody.appendChild(tr);
        }
      } catch(_){ /* noop */ }
    }

    async function loadPayments(){
      const start = document.getElementById('pagos-start').value || '';
      const end = document.getElementById('pagos-end').value || '';
      const q = document.getElementById('pagos-q').value || '';
      const limit = parseInt(document.getElementById('pagos-limit').value || '50', 10);
      const params = new URLSearchParams();
      if(start) params.append('start', start);
      if(end) params.append('end', end);
      if(q) params.append('q', q);
      params.append('limit', String(limit));
      params.append('offset', '0');
      const url = `/api/pagos_detalle?${params.toString()}`;
      // Mostrar skeleton mientras se carga
      try { showTableSkeleton('#pagos-table', 7, Math.max(5, limit)); } catch(_){}
      try {
        const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
        const data = await res.json().catch(() => ({}));
        const itemsRaw = Array.isArray(data.items) ? data.items : (Array.isArray(data) ? data : []);
        state.pagos = itemsRaw;
        const items = pagosAplicaFiltros(itemsRaw);
        const tbody = document.querySelector('#pagos-table tbody');
        tbody.innerHTML = '';
        items.forEach((row, idx) => {
          const tr = document.createElement('tr');
          tr.setAttribute('data-index', String(idx));
          const fecha = row.fecha_pago || row.fecha || row.fechaPago || null;
          const nombre = row.usuario_nombre || row.nombre || '';
          const dni = row.dni || '';
          const metodo = row.metodo_pago || row.metodo || '';
          const concepto = row.concepto_pago || row.concepto || '';
          const monto = row.monto != null ? row.monto : '';
          const loginEl = document.getElementById('login-current');
          const role = loginEl ? (loginEl.getAttribute('data-role') || '').trim() : '';
          const actionsHTML = (role === 'dueño')
            ? `<button class="btn info" data-action="recibo" data-id="${row.id || row.pago_id || ''}" data-index="${idx}">Recibo</button>
               <button class="btn neutral" data-action="editar" data-id="${row.id || row.pago_id || ''}" data-index="${idx}">Editar</button>
               <button class="btn danger" data-action="eliminar" data-id="${row.id || row.pago_id || ''}" data-index="${idx}">Borrar</button>`
            : `<button class="btn info" data-action="recibo" data-id="${row.id || row.pago_id || ''}" data-index="${idx}">Recibo</button>`;
          tr.innerHTML = `
            <td>${fecha ? fmtDate(fecha) : ''}</td>
            <td>${nombre}</td>
            <td>${dni}</td>
            <td>${metodo}</td>
            <td>${concepto}</td>
            <td>${fmtCurrency(monto)}</td>
            <td class="table-actions">${actionsHTML}</td>
          `;
          tbody.appendChild(tr);
        });
        const count = (data && typeof data.count === 'number') ? data.count : items.length;
        document.getElementById('pagos-count').textContent = `${count} pagos`;
        // Tarjetas
        const totalMonto = items.reduce((acc, r) => acc + (parseFloat(r.monto || 0) || 0), 0);
        const uniqueDni = new Set(items.map(r => String(r.dni || '')));
        document.getElementById('pagos-card-count').textContent = String(items.length);
    document.getElementById('pagos-card-monto').textContent = fmtCurrency(totalMonto);
        document.getElementById('pagos-card-unique').textContent = String(Array.from(uniqueDni).filter(v => v).length);
        const avg = items.length ? (totalMonto / items.length) : 0;
    const avgEl = document.getElementById('pagos-card-average');
    if(avgEl) avgEl.textContent = fmtCurrency(avg);
      } catch(err){
        console.error('Error cargando pagos:', err);
      }
    }

    async function loadMetodosPago(){
      try {
        const res = await fetch('/api/metodos_pago', { headers: { 'Accept': 'application/json' } });
        const met = await res.json();
        const items = Array.isArray(met) ? met : (Array.isArray(met?.metodos) ? met.metodos : []);
        // Actualiza estado para que el wizard pueda poblar selects por ID
        state.metodosPago = items;
        state.metodosPagoMap = Object.fromEntries(items.map(m => [String(m.id), m]));
        // Pobla el filtro por nombre (valor = nombre en minúsculas)
        const sel = document.getElementById('pagos-metodo');
        if(sel){
          sel.innerHTML = '<option value="">Todos</option>';
          items.forEach(m => {
            const opt = document.createElement('option');
            const nombre = m.nombre ?? '';
            opt.value = String(nombre).toLowerCase();
            opt.textContent = nombre;
            sel.appendChild(opt);
          });
          if(state.pagosFilters.metodo){ sel.value = state.pagosFilters.metodo; }
        }
      } catch(e){ console.warn('No se pudieron cargar métodos de pago:', e); }
    }
    async function loadConceptosPago(){
      try {
        const res = await fetch('/api/conceptos_pago', { headers: { 'Accept': 'application/json' } });
        const conc = await res.json();
        const items = Array.isArray(conc?.items) ? conc.items : (Array.isArray(conc) ? conc : []);
        // Actualiza estado para el wizard (map por ID)
        state.conceptosPago = items;
        state.conceptosPagoMap = Object.fromEntries(items.map(c => [String(c.id), c]));
        // Pobla el filtro por nombre (valor = nombre en minúsculas)
        const sel = document.getElementById('pagos-concepto');
        if(sel){
          sel.innerHTML = '<option value="">Todos</option>';
          items.forEach(c => {
            const nombre = c.nombre ?? '';
            const opt = document.createElement('option');
            opt.value = String(nombre).toLowerCase();
            opt.textContent = nombre;
            sel.appendChild(opt);
          });
          if(state.pagosFilters.concepto){ sel.value = state.pagosFilters.concepto; }
        }
      } catch(e){ console.warn('No se pudieron cargar conceptos:', e); }
    }

    async function loadTiposCuotaActivos(){
      try {
        const res = await fetch('/api/tipos_cuota_activos', { headers: { 'Accept': 'application/json' } });
        const tipos = await res.json();
        const lista = Array.isArray(tipos) ? tipos : [];
        state.tiposCuotaActivos = lista;
        state.tiposCuotaMap = Object.fromEntries(lista.map(t => [String(t.id ?? t.nombre ?? ''), t]));
        const sel = document.getElementById('u-tipo-cuota');
        if(sel){
          sel.innerHTML = '<option value="">Tipo de cuota</option>' + lista.map(t => `<option value="${t.id ?? t.nombre ?? ''}">${t.nombre ?? String(t.id ?? '')}</option>`).join('');
        }
      } catch(e){ console.warn('No se pudieron cargar tipos de cuota activos:', e); }
    }

    function updateUsuariosCards(rows){
      const count = (Array.isArray(rows) ? rows.length : 0);
      const activos = (Array.isArray(rows) ? rows.filter(u => (u.activo === true || u.activo === 'true')).length : 0);
      const inactivos = (Array.isArray(rows) ? rows.filter(u => !(u.activo === true || u.activo === 'true')).length : 0);
      const profesores = (Array.isArray(rows) ? rows.filter(u => String(u.rol || '').toLowerCase() === 'profesor').length : 0);
      const sinTelefono = (Array.isArray(rows) ? rows.filter(u => !(u.telefono && String(u.telefono).trim())).length : 0);
      const conNotas = (Array.isArray(rows) ? rows.filter(u => !!(u.notas && String(u.notas).trim())).length : 0);
      const c1 = document.getElementById('usuarios-card-count');
      const c2 = document.getElementById('usuarios-card-activos');
      const c3 = document.getElementById('usuarios-card-inactivos');
      const c4 = document.getElementById('usuarios-card-profesores');
      const c5 = document.getElementById('usuarios-card-sin-telefono');
      const c6 = document.getElementById('usuarios-card-con-notas');
      if(c1) c1.textContent = String(count);
      if(c2) c2.textContent = String(activos);
      if(c3) c3.textContent = String(inactivos);
      if(c4) c4.textContent = String(profesores);
      if(c5) c5.textContent = String(sinTelefono);
      if(c6) c6.textContent = String(conNotas);
    }

    async function loadUsers(){
      const q = document.getElementById('usuarios-q').value || '';
      const limit = parseInt(document.getElementById('usuarios-limit').value || '50', 10);
      const params = new URLSearchParams();
      if(q) params.append('q', q);
      params.append('limit', String(limit));
      params.append('offset', '0');
      const url = `/api/usuarios?${params.toString()}`;
      // Mostrar skeleton mientras se carga
      try { showTableSkeleton('#usuarios-table', 8, Math.max(5, limit)); } catch(_){}
      try {
        const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
        const rows = await res.json().catch(() => []);
        state.usuarios = Array.isArray(rows) ? rows : [];
        // Obtener set de IDs con asistencia hoy
        const hoySet = await (async () => {
          try {
            const r = await fetch('/api/asistencias_hoy_ids', { headers: { 'Accept': 'application/json' } });
            const arr = await r.json().catch(() => []);
            const list = Array.isArray(arr) ? arr : [];
            return new Set(list.map(x => Number(x)));
          } catch(e) { return new Set(); }
        })();
        state.asistenciasHoySet = hoySet;
        // Obtener set de IDs desactivados por morosidad (estado activo)
        const morosSet = await (async () => {
          try {
            const r = await fetch('/api/usuarios_morosidad_ids', { headers: { 'Accept': 'application/json' } });
            const arr = await r.json().catch(() => []);
            const list = Array.isArray(arr) ? arr : [];
            return new Set(list.map(x => Number(x)));
          } catch(e) { return new Set(); }
        })();
        state.morosidadSet = morosSet;
        const tbody = document.querySelector('#usuarios-table tbody');
        tbody.innerHTML = '';
        (Array.isArray(rows) ? rows : []).forEach((u, idx) => {
          const tr = document.createElement('tr');
          tr.setAttribute('data-index', String(idx));
          const activo = (u.activo === true || u.activo === 'true');
          const asistioHoy = hoySet.has(Number(u.id));
          const esMoroso = state.morosidadSet && state.morosidadSet.has(Number(u.id));
          const tipoObj = resolveTipoCuota(u.tipo_cuota ?? (u.tipo_cuota_nombre || u.tipo || ''));
          const tipoNombre = tipoObj ? (tipoObj.nombre || '') : (u.tipo_cuota_nombre || u.tipo_cuota || '');
          const activoLabel = esMoroso ? 'No (morosidad)' : (activo ? 'Sí' : 'No');
          tr.innerHTML = `
            <td>${u.nombre || ''}</td>
            <td>${u.dni || ''}</td>
            <td>${u.telefono || ''}</td>
            <td>${(u.rol || '').toString().toLowerCase()}</td>
            <td>${tipoNombre}</td>
            <td>${activoLabel}</td>
            <td>${asistioHoy ? '<span style="padding:2px 8px;border-radius:10px;background:#27ae60;color:#fff;">Asistió</span>' : '<span style="padding:2px 8px;border-radius:10px;background:#e74c3c;color:#fff;">No asistió</span>'}</td>
            <td>
              <button class="btn neutral" data-action="edit" data-id="${u.id}">Editar</button>
              <button class="btn danger" data-action="delete" data-id="${u.id}">Borrar</button>
            </td>
          `;
          if (esMoroso) { try { tr.style.borderLeft = '4px solid var(--warning)'; tr.setAttribute('data-moroso', 'true'); } catch(_){ /* noop */ } }
          tbody.appendChild(tr);
        });
        document.getElementById('usuarios-count').textContent = `${(Array.isArray(rows) ? rows.length : 0)} usuarios`;
        updateUsuariosCards(rows);
        try { populatePagosUsuarioSelector(); } catch {}
        // Actualizar selector de usuario en Rutinas
        try { renderRutinasUsuarioFilter(); } catch {}
      } catch(err){
        console.error('Error cargando usuarios:', err);
      }
    }

    function showUserForm(user){
      editingUserId = user && user.id ? user.id : null;
      const f = (id) => document.getElementById(id);
      f('u-nombre').value = (user && user.nombre) || '';
      f('u-dni').value = (user && user.dni) || '';
      f('u-telefono').value = (user && user.telefono) || '';
      // Prefijo por defecto si no hay teléfono
      if(!user || !user.telefono){ const telEl = f('u-telefono'); if(telEl && !telEl.value) telEl.value = '+54'; }
      f('u-pin').value = (user && user.pin) || '';
      // Aplicar restricción: un profesor no puede ver/editar el PIN de otro profesor
      try {
        const loginEl = document.getElementById('login-current');
        const sessionRole = (loginEl && loginEl.getAttribute('data-role') || '').trim();
        const sessionProfUid = (loginEl && loginEl.getAttribute('data-prof-uid') || '').trim();
        const isProfSession = (sessionRole === 'profesor') && !!sessionProfUid;
        const isEditingProfessor = user && String(user.rol || '').toLowerCase() === 'profesor';
        const isOtherProfessor = !!(isProfSession && isEditingProfessor && String(user.id || '') !== String(sessionProfUid));
        const pinEl = f('u-pin');
        if(pinEl){
          pinEl.disabled = false;
          pinEl.placeholder = '';
          if(isOtherProfessor){
            pinEl.value = '';
            pinEl.disabled = true;
            pinEl.placeholder = 'PIN oculto (no editable)';
          }
        }
        // ID editable solo para dueño y no para usuario con rol 'dueño'
        const idEl = f('u-id');
        if(idEl){
          idEl.value = (user && user.id != null) ? String(user.id) : '';
          const isOwnerSession = (sessionRole === 'dueño');
          const isEditingOwner = user && String(user.rol || '').toLowerCase() === 'dueño';
          idEl.disabled = true;
          idEl.placeholder = 'ID (no editable)';
          if(isOwnerSession && user && !isEditingOwner){
            idEl.disabled = false;
            idEl.placeholder = 'Nuevo ID (entero positivo)';
          }
        }
      } catch(e) {}
      f('u-rol').value = (user && user.rol) ? String(user.rol).toLowerCase() : 'socio';
      f('u-activo').checked = user ? !!user.activo : true;
      f('u-notas').value = (user && user.notas) || '';
      loadTiposCuotaActivos().then(() => {
        const sel = f('u-tipo-cuota');
        const v = user ? (user.tipo_cuota ?? '') : '';
        if(sel && v !== undefined && v !== null){ sel.value = String(v); }
      });
      openModal('modal-usuario');
    }
    function hideUserForm(){
      editingUserId = null;
      ['u-id','u-nombre','u-dni','u-telefono','u-pin','u-notas'].forEach(id => { const el = document.getElementById(id); if(el) el.value=''; });
      const sel = document.getElementById('u-tipo-cuota'); if(sel) sel.value='';
      const rol = document.getElementById('u-rol'); if(rol) rol.value='socio';
      const act = document.getElementById('u-activo'); if(act) act.checked=true;
      closeModal('modal-usuario');
    }

    // Banner de salud del sistema: muestra estado de /healthz y actualiza periódicamente
    

    async function saveUser(){
      const f = (id) => document.getElementById(id);
      const pinEl = f('u-pin');
      const payload = {
        nombre: f('u-nombre').value.trim().toUpperCase(),
        dni: f('u-dni').value.trim(),
        telefono: f('u-telefono').value.trim(),
        pin: pinEl && !pinEl.disabled ? pinEl.value.trim() : undefined,
        rol: f('u-rol').value,
        activo: f('u-activo').checked,
        tipo_cuota: f('u-tipo-cuota').value || null,
        notas: f('u-notas').value || null,
      };
      // Si el dueño cambió el ID, enviar new_id
      try {
        const idEl = f('u-id');
        const loginEl = document.getElementById('login-current');
        const sessionRole = (loginEl && loginEl.getAttribute('data-role') || '').trim();
        const isOwnerSession = (sessionRole === 'dueño');
        if(editingUserId && idEl && !idEl.disabled && isOwnerSession){
          const newIdVal = Number(idEl.value || '');
          if(Number.isFinite(newIdVal) && newIdVal > 0 && newIdVal !== Number(editingUserId)){
            payload.new_id = newIdVal;
          }
        }
      } catch(_) {}
      if(pinEl && pinEl.disabled){ delete payload.pin; }
      if(!payload.nombre || !payload.dni){ showToast('Nombre y DNI son obligatorios', 'warning', 3000); return; }
      try {
        const url = editingUserId ? `/api/usuarios/${editingUserId}` : '/api/usuarios';
        const method = editingUserId ? 'PUT' : 'POST';
        const res = await fetch(url, { method, headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' }, body: JSON.stringify(payload) });
        if(!res.ok){ const err = await res.json().catch(() => ({})); throw new Error(err.detail || err.error || `Error ${res.status}`); }
        hideUserForm();
        await loadUsers();
      } catch(e){ showToast(`No se pudo guardar: ${e.message}`, 'error', 4500); }
    }

    async function deleteUser(id){
      if(!id) return;
      try {
        const res = await fetch(`/api/usuarios/${id}`, { method: 'DELETE', headers: { 'Accept': 'application/json' } });
        if(!res.ok){ const err = await res.json().catch(() => ({})); throw new Error(err.detail || err.error || `Error ${res.status}`); }
        await loadUsers();
      } catch(e){ showToast(`No se pudo eliminar: ${e.message}`, 'error', 4500); }
    }

    function renderPagoSide(pago, detalles){
      const fecha = pago.fecha_pago || pago.fecha || pago.fechaPago || '';
      const nombre = pago.usuario_nombre || pago.nombre || '';
      const dni = pago.dni || '';
      const metodo = pago.metodo_pago || pago.metodo || '';
      const concepto = pago.concepto_pago || pago.concepto || '';
      const monto = pago.monto != null ? pago.monto : '';
      document.getElementById('pago-side-fecha').textContent = fecha ? fmtDateEs(fecha) : '';
      document.getElementById('pago-side-nombre').textContent = nombre;
      document.getElementById('pago-side-dni').textContent = dni;
      document.getElementById('pago-side-metodo').textContent = metodo;
      document.getElementById('pago-side-concepto').textContent = concepto;
      document.getElementById('pago-side-monto').textContent = fmtCurrency(monto);
      const notasEl = document.getElementById('pago-side-notas');
      if(notasEl) notasEl.textContent = (pago.notas && String(pago.notas).trim()) ? pago.notas : '—';
      const tbody = document.querySelector('#pago-detalles-table tbody');
      if(tbody){
        tbody.innerHTML = '';
        (Array.isArray(detalles) ? detalles : []).forEach(d => {
          const tr = document.createElement('tr');
          const concepto = d.concepto_nombre || d.concepto || d.descripcion || '';
          const cantidad = d.cantidad ?? 1;
          const precio = d.precio_unitario ?? d.precio ?? 0;
          const subtotal = d.subtotal ?? (cantidad * precio);
          tr.innerHTML = `<td>${concepto}</td><td>${cantidad}</td><td>${fmtCurrency(precio)}</td><td>${fmtCurrency(subtotal)}</td>`;
          tbody.appendChild(tr);
        });
      }
    }

    async function selectPagoByIndex(idx){
      const row = (state.pagos || [])[idx];
      if(!row) return;
      state.selectedPago = row;
      const id = row.id || row.pago_id || null;
      document.getElementById('pago-side-empty').style.display = 'none';
      document.getElementById('pago-side').style.display = 'block';
      document.getElementById('pago-side-id').textContent = id ? `#${id}` : '';
      try {
        if(id){
          const res = await fetch(`/api/pagos/${id}`, { headers: { 'Accept': 'application/json' } });
          const data = await res.json();
          const pago = data.pago || row;
          const detalles = Array.isArray(data.detalles) ? data.detalles : [];
          renderPagoSide(pago, detalles);
        } else {
          renderPagoSide(row, []);
        }
      } catch(e){
        console.warn('No se pudo cargar detalles del pago:', e);
        renderPagoSide(row, []);
      }
      const ptbody = document.querySelector('#pagos-table tbody');
      if(ptbody){ ptbody.querySelectorAll('tr').forEach(t => t.classList.remove('selected')); const tr = ptbody.querySelector(`tr[data-index="${idx}"]`); if(tr) tr.classList.add('selected'); }
    }

    function clearPagoSelection(){
      state.selectedPago = null;
      document.getElementById('pago-side-id').textContent = '';
      document.getElementById('pago-side').style.display = 'none';
      document.getElementById('pago-side-empty').style.display = 'block';
      const tbody = document.querySelector('#pago-detalles-table tbody');
      if(tbody) tbody.innerHTML = '';
    }

    function renderPagoDetalleModal(pago, detalles){
      const fecha = pago.fecha_pago || pago.fecha || pago.fechaPago || '';
      const nombre = pago.usuario_nombre || pago.nombre || '';
      const dni = pago.dni || '';
      const metodo = pago.metodo_pago || pago.metodo || '';
      const concepto = pago.concepto_pago || pago.concepto || '';
      const monto = pago.monto != null ? Number(pago.monto) : 0;
      document.getElementById('pago-detalle-fecha').textContent = fecha ? fmtDateEs(fecha) : '';
      document.getElementById('pago-detalle-nombre').textContent = nombre;
      document.getElementById('pago-detalle-dni').textContent = dni;
      document.getElementById('pago-detalle-metodo').textContent = metodo;
      document.getElementById('pago-detalle-concepto').textContent = concepto;
      document.getElementById('pago-detalle-monto').textContent = fmtCurrency(monto);
      const notasEl = document.getElementById('pago-detalle-notas');
      if(notasEl) notasEl.textContent = (pago.notas && String(pago.notas).trim()) ? pago.notas : '—';
      const tbody = document.querySelector('#pago-detalle-items-table tbody');
      if(tbody){
        tbody.innerHTML = '';
        const list = Array.isArray(detalles) ? detalles : [];
        if(list.length === 0){
          const tr = document.createElement('tr');
          tr.innerHTML = '<td colspan="4" class="muted">No hay items</td>';
          tbody.appendChild(tr);
        } else {
          list.forEach(d => {
            const tr = document.createElement('tr');
            const c = d.concepto_nombre || d.concepto || d.descripcion || '';
            const cantidad = d.cantidad ?? 1;
            const precio = d.precio_unitario ?? d.precio ?? 0;
            const subtotal = d.subtotal ?? (Number(cantidad||0) * Number(precio||0));
            tr.innerHTML = `<td>${c}</td><td>${cantidad}</td><td>${fmtCurrency(precio)}</td><td>${fmtCurrency(subtotal)}</td>`;
            tbody.appendChild(tr);
          });
        }
        // Total de ítems
        try{ const cntEl = document.getElementById('pago-detalle-total-items'); if(cntEl) cntEl.textContent = String(list.length); }catch(_){}
      }
    }

    async function openPagoDetalleModal(){
      const p = state.selectedPago;
      if(!p){ showToast('Selecciona un pago primero', 'warning', 4000); return; }
      let pago = p; let detalles = [];
      try {
        const id = p.id || p.pago_id;
        if(id){
          const res = await fetch(`/api/pagos/${id}`, { headers: { 'Accept': 'application/json' } });
          let data = null; try{ data = await res.json(); }catch(_){ data = null; }
          if(res.ok && data){
            pago = data.pago || p;
            detalles = Array.isArray(data.detalles) ? data.detalles : [];
          }
        }
      } catch(_){ /* ignorar */ }
      renderPagoDetalleModal(pago, detalles);
      openModal('modal-pago-detalle');
    }

    async function navigateToUsuarioDesdePago(){
      const pago = state.selectedPago;
      if(!pago){ showToast('Selecciona un pago primero', 'warning', 4000); return; }
      const dni = pago.dni ? String(pago.dni).trim() : '';
      if(!dni){ showToast('No se encuentra DNI del pago', 'error', 4500); return; }
      const findByDni = () => (state.usuarios || []).findIndex(u => String(u.dni || '').trim() === dni);
      let idx = findByDni();
      switchTab('usuarios');
      if(idx >= 0){ selectUsuarioByIndex(idx); return; }
      await loadUsers();
      idx = findByDni();
      if(idx >= 0) selectUsuarioByIndex(idx);
      else showToast('No se encontró el usuario del pago en la lista.', 'warning', 4000);
    }

    function bindPagosEvents(){
      const tbody = document.querySelector('#pagos-table tbody');
      tbody.addEventListener('click', async (ev) => {
        const btn = ev.target.closest('button');
        if(btn){
          const action = btn.getAttribute('data-action');
          if(action === 'ver'){
            const idx = parseInt(btn.getAttribute('data-index') || '0', 10);
            if(isNaN(idx)) return;
            selectPagoByIndex(idx);
            return;
          }
          if(action === 'editar'){
            const idx = parseInt(btn.getAttribute('data-index') || '0', 10);
            if(isNaN(idx)) return;
            const row = (state.pagos || [])[idx];
            const id = btn.getAttribute('data-id');
            if(id){
              fetch(`/api/pagos/${id}`, { headers:{ 'Accept':'application/json' } })
                .then(r => r.json())
                .then(data => showPagoForm(data.pago || row))
                .catch(() => showToast('No se pudo cargar el pago', 'error', 4500));
            } else {
              showPagoForm(row);
            }
            return;
          }
          if(action === 'eliminar'){
            const id = btn.getAttribute('data-id');
            if(!id){ showToast('Pago inválido', 'error', 4500); return; }
            state.deletePagoId = parseInt(id, 10);
            openModal('modal-pagos-delete');
            return;
          }
      if(action === 'recibo'){
        const id = btn.getAttribute('data-id');
        if(!id){ showToast('Pago inválido', 'error', 4500); return; }
        const prevHTML = btn.innerHTML;
        btn.disabled = true; btn.setAttribute('aria-busy','true');
        btn.innerHTML = '<span class="btn-spinner" aria-hidden="true"></span><span style="margin-left:6px">Abriendo…</span>';
        try { await openReciboPreview(id); }
        finally { btn.disabled = false; btn.removeAttribute('aria-busy'); btn.innerHTML = prevHTML; }
        return;
      }
        }
        const tr = ev.target.closest('tr');
        if(!tr) return;
        const idx = parseInt(tr.getAttribute('data-index') || 'NaN', 10);
        if(isNaN(idx)) return;
        selectPagoByIndex(idx);
      });
      const filtrosBtn = document.getElementById('pagos-filtros-btn');
      filtrosBtn.addEventListener('click', async () => {
        await Promise.all([loadMetodosPago(), loadConceptosPago()]);
        openModal('modal-pagos-filtros');
      });
      document.getElementById('pagos-filtros-close').addEventListener('click', () => closeModal('modal-pagos-filtros'));
      document.getElementById('pagos-filtros-cancelar').addEventListener('click', () => closeModal('modal-pagos-filtros'));
      document.getElementById('pagos-filtros-aplicar').addEventListener('click', () => {
        const metodo = document.getElementById('pagos-metodo').value || '';
        const concepto = document.getElementById('pagos-concepto').value || '';
        state.pagosFilters.metodo = metodo;
        state.pagosFilters.concepto = concepto;
        closeModal('modal-pagos-filtros');
        loadPayments();
      });
      document.getElementById('pagos-clear-selection').addEventListener('click', clearPagoSelection);
      const verUsuarioBtn = document.getElementById('pago-side-ver-usuario');
      if(verUsuarioBtn) verUsuarioBtn.addEventListener('click', navigateToUsuarioDesdePago);
      const verDetalleBtn = document.getElementById('pago-side-ver-detalle');
      if(verDetalleBtn) verDetalleBtn.addEventListener('click', openPagoDetalleModal);
      // Cierres del modal de detalle de pago
      const pagoDetClose = document.getElementById('pago-detalle-close'); if(pagoDetClose) pagoDetClose.addEventListener('click', () => closeModal('modal-pago-detalle'));
      const pagoDetCerrar = document.getElementById('pago-detalle-cerrar'); if(pagoDetCerrar) pagoDetCerrar.addEventListener('click', () => closeModal('modal-pago-detalle'));
      const exportBtn = document.getElementById('pagos-export-csv');
      if(exportBtn) exportBtn.addEventListener('click', exportPagosCSV);
      const editarPagoBtn = document.getElementById('pago-side-editar');
      if(editarPagoBtn) editarPagoBtn.addEventListener('click', () => {
        const p = state.selectedPago; if(!p) { showToast('Selecciona un pago primero', 'warning', 4000); return; }
        const id = p.id || p.pago_id;
        if(id){
          fetch(`/api/pagos/${id}`, { headers:{ 'Accept':'application/json' } })
            .then(r => r.json())
            .then(data => showPagoForm(data.pago || p))
            .catch(() => showToast('No se pudo cargar el pago', 'error', 4500));
        } else {
          showPagoForm(p);
        }
      });
      const reciboBtn = document.getElementById('pago-side-recibo');
      if(reciboBtn) reciboBtn.addEventListener('click', async () => {
        const p = state.selectedPago; if(!p || !(p.id || p.pago_id)) { showToast('Selecciona un pago válido', 'warning', 4000); return; }
        const id = p.id || p.pago_id;
        const prevHTML = reciboBtn.innerHTML;
        reciboBtn.disabled = true; reciboBtn.setAttribute('aria-busy','true');
        reciboBtn.innerHTML = '<span class="btn-spinner" aria-hidden="true"></span><span style="margin-left:6px">Abriendo…</span>';
        try { await openReciboPreview(id); }
        finally { reciboBtn.disabled = false; reciboBtn.removeAttribute('aria-busy'); reciboBtn.innerHTML = prevHTML; }
      });
      // Modal recibo preview controls
      const reciboPrevClose = document.getElementById('recibo-preview-close'); if(reciboPrevClose) reciboPrevClose.addEventListener('click', handleReciboPreviewClose);
      const reciboPrevCloseBtn = document.getElementById('recibo-preview-close-btn'); if(reciboPrevCloseBtn) reciboPrevCloseBtn.addEventListener('click', handleReciboPreviewClose);
      const reciboPrevDownload = document.getElementById('recibo-preview-download'); if(reciboPrevDownload) reciboPrevDownload.addEventListener('click', () => {
        const id = state.previewPagoId; if(!id) { showToast('No hay recibo para descargar', 'warning', 3500); return; }
        const params = buildReciboParams();
        const url = `/api/pagos/${id}/recibo.pdf${params.toString() ? ('?' + params.toString()) : ''}`;
        try { window.open(url, '_blank'); } catch(_) { showToast('No se pudo descargar el recibo', 'error', 4500); }
      });
      const reciboPrevConfig = document.getElementById('recibo-preview-config'); if(reciboPrevConfig) reciboPrevConfig.addEventListener('click', async () => {
        await loadReciboConfig();
        openModal('modal-recibo-config');
      });
      const fechaEl = document.getElementById('recibo-preview-fecha'); if(fechaEl){
        const handler = () => { updatePeriodoLabel(); try{ refreshReciboPreview(); }catch(_){} };
        fechaEl.addEventListener('input', handler);
        fechaEl.addEventListener('change', handler);
      }
      // Auto refresh al editar campos del recibo
      ['recibo-preview-numero','recibo-preview-titulo','recibo-preview-gym-nombre','recibo-preview-gym-direccion','recibo-preview-usuario-nombre','recibo-preview-usuario-dni','recibo-preview-metodo','recibo-preview-observaciones','recibo-preview-emitidopor','recibo-preview-mostrar-logo','recibo-preview-mostrar-metodo','recibo-preview-mostrar-dni'].forEach(id => {
        const el = document.getElementById(id); if(el){ const h = () => { try{ refreshReciboPreview(); }catch(_){} }; el.addEventListener('input', h); el.addEventListener('change', h); }
      });
      const reciboPrevApply = document.getElementById('recibo-preview-apply'); if(reciboPrevApply) reciboPrevApply.addEventListener('click', () => {
        const id = state.previewPagoId; if(!id) { showToast('No hay pago seleccionado', 'warning', 3500); return; }
        const frame = document.getElementById('recibo-preview-frame');
        if(frame){
          const params = buildReciboParams();
          params.set('preview','1');
          const url = `/api/pagos/${id}/recibo.pdf?${params.toString()}#toolbar=0&navpanes=0`;
          frame.src = url;
          try{ attachWheelZoom('recibo-preview-frame-wrap','recibo-preview-frame'); }catch(_){ }
        }
      });
      const itemAddBtn = document.getElementById('recibo-item-add'); if(itemAddBtn) itemAddBtn.addEventListener('click', () => { addItemRow({ descripcion:'', cantidad:1, precio_unitario:0 }); recalcTotalsFromItems(); });
      const comInput = document.getElementById('recibo-total-comision'); if(comInput) comInput.addEventListener('input', recalcTotalsFromItems);
      // Modal de confirmación de guardado desde vista previa
      const rscClose = document.getElementById('recibo-save-close'); if(rscClose) rscClose.addEventListener('click', () => closeModal('modal-recibo-save'));
      const rscDiscard = document.getElementById('recibo-save-discard'); if(rscDiscard) rscDiscard.addEventListener('click', () => { closeModal('modal-recibo-save'); closeModal('modal-recibo-preview'); });
      const rscApply = document.getElementById('recibo-save-apply'); if(rscApply) rscApply.addEventListener('click', applyReciboChangesToPago);
      const eliminarPagoBtn = document.getElementById('pago-side-eliminar');
      if(eliminarPagoBtn) eliminarPagoBtn.addEventListener('click', () => {
        const p = state.selectedPago; if(!p || !(p.id || p.pago_id)) { showToast('Selecciona un pago válido', 'warning', 4000); return; }
        state.deletePagoId = p.id || p.pago_id;
        openModal('modal-pagos-delete');
      });
      const nuevoPagoBtn = document.getElementById('pagos-new');
      if(nuevoPagoBtn) nuevoPagoBtn.addEventListener('click', () => showPagoWizard());
      const registrarPagoQuick = document.getElementById('usuario-side-registrar');
      if(registrarPagoQuick) registrarPagoQuick.addEventListener('click', () => { try{ hidePagoWizard(); }catch(_){ } showPagoWizard(); });
      // Modal pago form controls
      const pagoClose = document.getElementById('pago-form-close'); if(pagoClose) pagoClose.addEventListener('click', hidePagoForm);
      const pagoCancel = document.getElementById('pago-form-cancel'); if(pagoCancel) pagoCancel.addEventListener('click', hidePagoForm);
      const pagoSave = document.getElementById('pago-save'); if(pagoSave) pagoSave.addEventListener('click', savePago);
      // Recalcular al cambiar usuario o método de pago
      const uSel = document.getElementById('pago-usuario'); if(uSel) uSel.addEventListener('change', () => { 
        try{
          recalcPagoTotal();
          const rows = document.getElementById('pago-items-rows'); if(!rows) return;
          const conceptoEl = document.getElementById('pago-concepto');
          const conceptoId = conceptoEl && conceptoEl.value ? String(conceptoEl.value) : '';
          const conceptoSel = conceptoId ? (state.conceptosPagoMap ? state.conceptosPagoMap[conceptoId] : null) : null;
          const uid = uSel && uSel.value ? Number(uSel.value) : null;
          let pu = 0;
          try{
            const u = (state.usuarios || []).find(x => Number(x.id) === uid);
            const tipoVal = u ? (u.tipo_cuota ?? null) : null; const tipoObj = resolveTipoCuota(tipoVal);
            if(conceptoSel && normalizeStr(conceptoSel.nombre) === normalizeStr('Cuota Mensual')){ pu = tipoObj ? Number(tipoObj.precio ?? tipoObj.precio_base ?? 0) : 0; }
            else { pu = conceptoSel ? Number(conceptoSel.precio_base ?? 0) : (tipoObj ? Number(tipoObj.precio ?? tipoObj.precio_base ?? 0) : 0); }
          }catch(_){ pu = 0; }
          // Aplicar comisión/descuento del método al precio del primer ítem
          const metodoEl = document.getElementById('pago-metodo');
          const metodoId = metodoEl && metodoEl.value ? String(metodoEl.value) : '';
          const metodo = metodoId ? (state.metodosPagoMap ? state.metodosPagoMap[metodoId] : null) : null;
          const pct = metodo ? Number(metodo.comision_porcentaje ?? metodo.comision ?? 0) : 0;
          const puFinal = Number((Number(pu||0) * (1 + (Number(pct||0)/100))).toFixed(2));
          let firstRow = rows.children && rows.children[0] ? rows.children[0] : null;
          if(firstRow){ try{ const inputs = firstRow.querySelectorAll('input'); if(inputs[2]) inputs[2].value = String(Number(puFinal||0).toFixed(2)); }catch(_){ } }
          rows.setAttribute('data-price-includes-commission', pct ? '1' : '0');
          recalcPagoTotal();
        }catch(_){ }
      });
      const mSel = document.getElementById('pago-metodo'); if(mSel) mSel.addEventListener('change', () => { 
        try{
          recalcPagoTotal();
          const rows = document.getElementById('pago-items-rows'); if(!rows) return;
          const cEl = document.getElementById('pago-concepto');
          const cId = cEl && cEl.value ? String(cEl.value) : '';
          const conceptoSel = cId ? (state.conceptosPagoMap ? state.conceptosPagoMap[cId] : null) : null;
          const uEl = document.getElementById('pago-usuario'); const uid = uEl && uEl.value ? Number(uEl.value) : null;
          let puBase = 0;
          try{
            const u = (state.usuarios || []).find(x => Number(x.id) === uid);
            const tipoVal = u ? (u.tipo_cuota ?? null) : null; const tipoObj = resolveTipoCuota(tipoVal);
            if(conceptoSel && normalizeStr(conceptoSel.nombre) === normalizeStr('Cuota Mensual')){ puBase = tipoObj ? Number(tipoObj.precio ?? tipoObj.precio_base ?? 0) : 0; }
            else { puBase = conceptoSel ? Number(conceptoSel.precio_base ?? 0) : (tipoObj ? Number(tipoObj.precio ?? tipoObj.precio_base ?? 0) : 0); }
          }catch(_){ puBase = 0; }
          const metodoId = mSel && mSel.value ? String(mSel.value) : '';
          const metodo = metodoId ? (state.metodosPagoMap ? state.metodosPagoMap[metodoId] : null) : null;
          const pct = metodo ? Number(metodo.comision_porcentaje ?? metodo.comision ?? 0) : 0;
          const puFinal = Number((Number(puBase||0) * (1 + (Number(pct||0)/100))).toFixed(2));
          let firstRow = rows.children && rows.children[0] ? rows.children[0] : null;
          const desc = conceptoSel ? (String(conceptoSel.nombre||'').trim() || 'Concepto') : 'Concepto';
          if(!firstRow){ addPagoItemRow({ descripcion: desc, cantidad: 1, precio_unitario: puFinal }); }
          else { try{ const inputs = firstRow.querySelectorAll('input'); if(inputs[1]) inputs[1].value = '1'; if(inputs[2]) inputs[2].value = String(Number(puFinal||0).toFixed(2)); }catch(_){ } }
          rows.setAttribute('data-price-includes-commission', pct ? '1' : '0');
          const adv = document.getElementById('pago-items-advanced'); if(adv) adv.open = true;
          recalcPagoTotal();
        }catch(_){ }
      });
      const cSel = document.getElementById('pago-concepto'); if(cSel) cSel.addEventListener('change', () => { 
        try{
          recalcPagoTotal();
          const rows = document.getElementById('pago-items-rows'); if(!rows) return;
          const conceptoId = cSel && cSel.value ? String(cSel.value) : '';
          const conceptoSel = conceptoId ? (state.conceptosPagoMap ? state.conceptosPagoMap[conceptoId] : null) : null;
          const uSel2 = document.getElementById('pago-usuario'); const uid2 = uSel2 && uSel2.value ? Number(uSel2.value) : null;
          let pu = 0; 
          try{
            const u = (state.usuarios || []).find(x => Number(x.id) === uid2);
            const tipoVal = u ? (u.tipo_cuota ?? null) : null; const tipoObj = resolveTipoCuota(tipoVal);
            if(conceptoSel && normalizeStr(conceptoSel.nombre) === normalizeStr('Cuota Mensual')){ pu = tipoObj ? Number(tipoObj.precio ?? tipoObj.precio_base ?? 0) : 0; }
            else { pu = conceptoSel ? Number(conceptoSel.precio_base ?? 0) : (tipoObj ? Number(tipoObj.precio ?? tipoObj.precio_base ?? 0) : 0); }
          }catch(_){ pu = 0; }
          const desc = conceptoSel ? (String(conceptoSel.nombre||'').trim() || 'Concepto') : 'Concepto';
          // Aplicar comisión/descuento del método al precio del primer ítem
          const metodoEl2 = document.getElementById('pago-metodo');
          const metodoId2 = metodoEl2 && metodoEl2.value ? String(metodoEl2.value) : '';
          const metodo2 = metodoId2 ? (state.metodosPagoMap ? state.metodosPagoMap[metodoId2] : null) : null;
          const pct2 = metodo2 ? Number(metodo2.comision_porcentaje ?? metodo2.comision ?? 0) : 0;
          const puFinal2 = Number((Number(pu||0) * (1 + (Number(pct2||0)/100))).toFixed(2));
          let firstRow = rows.children && rows.children[0] ? rows.children[0] : null;
          if(!firstRow){
            addPagoItemRow({ descripcion: desc, cantidad: 1, precio_unitario: puFinal2 });
          } else {
            try{
              const inputs = firstRow.querySelectorAll('input');
              if(inputs[0]) inputs[0].value = desc;
              if(inputs[1]) inputs[1].value = '1';
              if(inputs[2]) inputs[2].value = String(Number(puFinal2||0).toFixed(2));
            }catch(_){ }
          }
          rows.setAttribute('data-price-includes-commission', pct2 ? '1' : '0');
          const adv = document.getElementById('pago-items-advanced'); if(adv) adv.open = true;
          recalcPagoTotal();
        }catch(_){ }
      });
      // Editor de ítems en modal de pago
      const pagoItemAdd = document.getElementById('pago-item-add'); if(pagoItemAdd) pagoItemAdd.addEventListener('click', () => { addPagoItemRow({ descripcion:'', cantidad:1, precio_unitario:0 }); recalcPagoTotal(); });
      // Modal delete pago controls
      document.getElementById('pagos-delete-close').addEventListener('click', () => closeModal('modal-pagos-delete'));
      document.getElementById('pagos-delete-cancel').addEventListener('click', () => closeModal('modal-pagos-delete'));
      document.getElementById('pagos-delete-confirm').addEventListener('click', deletePago);
    }

    async function populatePagoUsuarioSelect(selectedId){
      const sel = document.getElementById('pago-usuario');
      if(!sel) return;
      if(!Array.isArray(state.usuarios) || state.usuarios.length === 0){
        await loadUsers();
      }
      const usuarios = Array.isArray(state.usuarios) ? state.usuarios : [];
      sel.innerHTML = '<option value="">Seleccionar usuario</option>' + usuarios.map(u => `<option value="${u.id}">${u.nombre} (${u.dni || ''})</option>`).join('');
      const target = selectedId || (state.selectedUsuario && state.selectedUsuario.id) || '';
      if(target) sel.value = String(target);
    }

    async function populatePagosUsuarioSelector(selectedId){
      const sel = document.getElementById('pagos-usuario');
      if(!sel) return;
      try {
        if(!Array.isArray(state.usuarios) || state.usuarios.length === 0){
          await loadUsers();
        }
        const usuarios = Array.isArray(state.usuarios) ? state.usuarios : [];
        sel.innerHTML = '<option value="">Usuario (opcional)</option>' + usuarios.map(u => `<option value="${u.id}">${u.nombre} (${u.dni || ''})</option>`).join('');
        const target = selectedId || (state.selectedUsuario && state.selectedUsuario.id) || '';
        if(target) sel.value = String(target);
      } catch(e) {}
    }

    async function populatePagoMetodoSelect(selectedId){
      const sel = document.getElementById('pago-metodo'); if(!sel) return;
      try {
        const res = await fetch('/api/metodos_pago', { headers:{ 'Accept':'application/json' } });
        const data = await res.json();
        const items = Array.isArray(data) ? data : (Array.isArray(data.metodos) ? data.metodos : []);
        state.metodosPago = items;
        state.metodosPagoMap = Object.fromEntries(items.map(m => [String(m.id), m]));
        sel.innerHTML = '<option value="">Método de pago (opcional)</option>' + items.map(m => `<option value="${m.id}">${m.nombre}</option>`).join('');
        if(selectedId) sel.value = String(selectedId);
      } catch(e) { console.warn('No se pudieron cargar métodos de pago:', e); }
    }

    async function populatePagoConceptoSelect(selectedId){
      const sel = document.getElementById('pago-concepto'); if(!sel) return;
      try{
        const res = await fetch('/api/conceptos_pago', { headers:{ 'Accept':'application/json' } });
        const data = await res.json();
        const items = Array.isArray(data?.items) ? data.items : (Array.isArray(data) ? data : []);
        state.conceptosPago = items;
        state.conceptosPagoMap = Object.fromEntries(items.map(c => [String(c.id), c]));
        sel.innerHTML = '<option value="">Concepto</option>' + items.map(c => `<option value="${c.id}">${c.nombre}</option>`).join('');
        let target = selectedId || '';
        if(!target){
          const monthly = items.find(c => String(c.nombre||'').trim().toLowerCase() === 'cuota mensual');
          if(monthly) target = String(monthly.id);
        }
        if(target) sel.value = String(target);
      } catch(e){ console.warn('No se pudieron cargar conceptos de pago:', e); }
    }

    // ---- cálculo dinámico de monto según tipo de cuota y comisión ----
    async function ensureMonthlyQuotaConceptVariableActive(){
      try {
        const res = await fetch('/api/conceptos_pago', { headers:{ 'Accept':'application/json' } });
        const conceptos = await res.json();
        const items = Array.isArray(conceptos) ? conceptos : [];
        const existing = items.find(c => String(c.nombre || '').trim().toLowerCase() === 'cuota mensual');
        if(!existing){
          await fetch('/api/conceptos_pago', {
            method:'POST', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' },
            body: JSON.stringify({ nombre: 'Cuota Mensual', descripcion: 'Pago mensual según tipo de cuota del usuario', precio_base: 0, tipo: 'variable', activo: true, categoria: 'cuota' })
          }).catch(()=>null);
        } else if(existing && (String(existing.tipo).toLowerCase() !== 'variable' || existing.activo === false)){
          await fetch(`/api/conceptos_pago/${existing.id}`, {
            method:'PUT', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' },
            body: JSON.stringify({ tipo: 'variable', activo: true })
          }).catch(()=>null);
        }
      } catch(e){ console.warn('No se pudo asegurar concepto Cuota Mensual variable/activo:', e); }
    }

    async function ensureTiposCuotaCatalogo(){
      try{
        if(Array.isArray(state.tiposCuotaCatalogo) && state.tiposCuotaCatalogo.length > 0){ return; }
        const res = await fetch('/api/tipos_cuota_catalogo', { headers:{ 'Accept':'application/json' } });
        const full = await res.json();
        const rows = Array.isArray(full.items) ? full.items : (Array.isArray(full) ? full : []);
        state.tiposCuotaCatalogo = rows;
        state.tiposCuotaCatalogoMap = Object.fromEntries(rows.map(t => [String(t.id ?? t.nombre ?? ''), t]));
      }catch(e){ console.warn('No se pudo cargar catálogo de tipos de cuota:', e); }
    }

    function normalizeStr(s){
      try {
        return String(s || '').normalize('NFD').replace(/[\u0300-\u036f]/g, '').trim().toLowerCase();
      } catch (_) {
        return String(s || '').trim().toLowerCase();
      }
    }
    function resolveTipoCuota(val){
      if(val == null) return null;
      // Manejar objetos directamente {id, nombre, precio}
      if(typeof val === 'object'){
        try{
          const obj = val;
          const activos = Array.isArray(state.tiposCuotaActivos) ? state.tiposCuotaActivos : [];
          const catalogo = Array.isArray(state.tiposCuotaCatalogo) ? state.tiposCuotaCatalogo : [];
          const id = obj.id ?? obj.tipo_id ?? obj.tipoCuotaId ?? null;
          const nombre = obj.nombre ?? obj.tipo_nombre ?? obj.tipoCuotaNombre ?? null;
          let tipo = null;
          if(id != null){
            const idStr = String(id);
            tipo = activos.find(t => String(t.id) === idStr) || catalogo.find(t => String(t.id) === idStr) || null;
          }
          if(!tipo && nombre){
            const normNombre = normalizeStr(nombre);
            tipo = activos.find(t => normalizeStr(t.nombre||'') === normNombre) || catalogo.find(t => normalizeStr(t.nombre||'') === normNombre) || null;
          }
          if(tipo) return tipo;
          // Si el objeto ya trae precio, devolverlo como fallback
          if(obj && (obj.precio != null || obj.precio_base != null)) return obj;
        }catch(_){ /* noop */ }
      }
      const raw = String(val).trim();
      if(!raw) return null;
      const norm = normalizeStr(raw);
      const activos = Array.isArray(state.tiposCuotaActivos) ? state.tiposCuotaActivos : [];
      let tipo = null;
      // Permitir IDs con decimales o texto adicional (p.ej. "1", "1.0", "ID 1")
      const idMatch = norm.match(/^([0-9]+)/);
      if(idMatch){
        const idStr = idMatch[1];
        tipo = activos.find(t => String(t.id) === idStr);
      }
      if(!tipo){
        tipo = activos.find(t => normalizeStr(t.nombre || '') === norm);
      }
      if(tipo) return tipo;
      const catalogo = Array.isArray(state.tiposCuotaCatalogo) ? state.tiposCuotaCatalogo : [];
      if(idMatch && !tipo){
        const idStr = idMatch[1];
        tipo = catalogo.find(t => String(t.id) === idStr);
      }
      if(!tipo){
        tipo = catalogo.find(t => normalizeStr(t.nombre || '') === norm);
      }
      if(!tipo && state.tiposCuotaMap){
        tipo = state.tiposCuotaMap[raw] || state.tiposCuotaMap[norm] || (idMatch ? state.tiposCuotaMap[idMatch[1]] : null) || null;
      }
      return tipo || null;
    }

    function round2(v){ const n = Number(v) || 0; return Math.round(n * 100) / 100; }

    // Helpers de formato monetario (configurable por locale)
    function fmtAmount(n){
      try{ return (window.fmtAmount ? window.fmtAmount(n) : Number(n||0).toLocaleString('es-AR', { minimumFractionDigits:2, maximumFractionDigits:2 })); }
      catch(e){ return (Number(n)||0).toFixed(2); }
    }
    function fmtCurrency(n){
      try{ return (window.fmtCurrency ? window.fmtCurrency(n) : new Intl.NumberFormat('es-AR', { style:'currency', currency:'ARS' }).format(Number(n||0))); }
      catch(e){ return `$${(Number(n)||0).toFixed(2)}`; }
    }

    function updatePagoResumen({ conceptoNombre, base, pct, comision, total }){
      const elConcepto = document.getElementById('pago-resumen-concepto'); if(elConcepto) elConcepto.textContent = conceptoNombre || 'Cuota Mensual';
      const elBase = document.getElementById('pago-resumen-base'); if(elBase) elBase.textContent = (base != null ? fmtAmount(round2(base)) : '—');
      const elCom = document.getElementById('pago-resumen-comision'); if(elCom) elCom.textContent = (comision != null ? fmtAmount(round2(comision)) : '—');
      const elPct = document.getElementById('pago-resumen-comision-porcentaje'); if(elPct) elPct.textContent = (pct ? `(${round2(pct)}%)` : '');
      const elTot = document.getElementById('pago-resumen-total'); if(elTot) elTot.textContent = (total != null ? fmtAmount(round2(total)) : '—');
    }

    async function recalcPagoTotal(){
      try{
        await ensureMonthlyQuotaConceptVariableActive();
        if(!Array.isArray(state.tiposCuotaActivos) || state.tiposCuotaActivos.length === 0){
          await loadTiposCuotaActivos();
        }
        await ensureTiposCuotaCatalogo();
        const usuarioEl = document.getElementById('pago-usuario');
        const metodoEl = document.getElementById('pago-metodo');
        const conceptoEl = document.getElementById('pago-concepto');
        const montoEl = document.getElementById('pago-monto');
        const uid = usuarioEl && usuarioEl.value ? Number(usuarioEl.value) : null;
        const conceptoId = conceptoEl && conceptoEl.value ? String(conceptoEl.value) : '';
        const concepto = conceptoId ? (state.conceptosPagoMap ? state.conceptosPagoMap[conceptoId] : null) : null;
        let base = 0; let conceptoNombre = 'Cuota Mensual';
        // Si hay ítems en el editor, usar ese subtotal como base y construir etiqueta de concepto
        const pagoItems = (function(){
          try{
            const rows = document.getElementById('pago-items-rows');
            if(!rows) return [];
            const arr = [];
            Array.from(rows.children || []).forEach((row) => {
              try{
                const inputs = row.querySelectorAll('input');
                const desc = (inputs[0]?.value || '').trim();
                const qty = parseFloat(inputs[1]?.value || '1');
                const price = parseFloat(inputs[2]?.value || '0');
                if(desc){ arr.push({ descripcion: desc, cantidad: isNaN(qty)?1:qty, precio_unitario: isNaN(price)?0:price }); }
              }catch(_){ }
            });
            return arr;
          }catch(_){ return []; }
        })();
        if(Array.isArray(pagoItems) && pagoItems.length){
          let subtotal = 0.0; for(const it of pagoItems){ subtotal += ((it.cantidad||1) * (it.precio_unitario||0)); }
          base = subtotal;
          const agg = buildItemsConceptLabel(pagoItems);
          if(agg.label){ conceptoNombre = agg.label; }
          // Actualizar campos de subtotal/total de ítems (total se completará luego)
          try{ const subEl = document.getElementById('pago-items-subtotal'); if(subEl) subEl.value = Number(subtotal||0).toFixed(2); }catch(_){}
          try{ const cntEl = document.getElementById('pago-items-count'); if(cntEl) cntEl.value = String(pagoItems.length||0); }catch(_){}
        } else {
          if(concepto){ conceptoNombre = concepto.nombre || conceptoNombre; }
        }
        if(uid){
          const u = (state.usuarios || []).find(x => Number(x.id) === uid);
          const tipoVal = u ? (u.tipo_cuota ?? null) : null;
          const tipoObj = resolveTipoCuota(tipoVal);
          if(!(Array.isArray(pagoItems) && pagoItems.length)){
            if(concepto && String(concepto.nombre||'').trim().toLowerCase() === 'cuota mensual'){
              base = tipoObj ? Number(tipoObj.precio ?? tipoObj.precio_base ?? 0) : 0;
            } else {
              base = concepto ? Number(concepto.precio_base ?? 0) : (tipoObj ? Number(tipoObj.precio ?? tipoObj.precio_base ?? 0) : 0);
            }
          }
        } else {
          if(!(Array.isArray(pagoItems) && pagoItems.length)){
            base = concepto ? Number(concepto.precio_base ?? 0) : 0;
          }
        }
        const metodoId = metodoEl && metodoEl.value ? String(metodoEl.value) : '';
        const metodo = metodoId ? (state.metodosPagoMap ? state.metodosPagoMap[metodoId] : null) : null;
        const pct = metodo ? Number(metodo.comision_porcentaje ?? metodo.comision ?? 0) : 0;
        const rowsEl = document.getElementById('pago-items-rows');
        const includeInPrice = !!(rowsEl && rowsEl.getAttribute('data-price-includes-commission') === '1');
        const pctEffective = includeInPrice ? 0 : pct;
        const comision = round2(base * pctEffective / 100);
        const total = round2(base + comision);
        if(montoEl){ montoEl.value = total > 0 ? String(total) : ''; }
        updatePagoResumen({ conceptoNombre, base, pct, comision, total });
        // Actualizar tooltip y totales de ítems con fallback: si no hay filas, tratar el concepto como un ítem único
        try{
          const elConcepto = document.getElementById('pago-resumen-concepto');
          const itemsSubtotalEl = document.getElementById('pago-items-subtotal');
          const itemsTotalEl = document.getElementById('pago-items-total');
          const itemsCountEl = document.getElementById('pago-resumen-items');
          const cpEl = document.getElementById('pago-concepto');
          const effectiveItems = (Array.isArray(pagoItems) && pagoItems.length) ? pagoItems : (
            concepto ? [{ descripcion: conceptoNombre, cantidad: 1, precio_unitario: Number(base||0) }] : []
          );
          if(elConcepto && Array.isArray(effectiveItems) && effectiveItems.length){
            const agg = buildItemsConceptLabel(effectiveItems);
            elConcepto.setAttribute('title', agg.tooltip || '');
          }
          if(itemsSubtotalEl && Array.isArray(effectiveItems) && effectiveItems.length){
            const subt = effectiveItems.reduce((acc, it) => acc + Number(it.cantidad||1)*Number(it.precio_unitario||0), 0);
            itemsSubtotalEl.value = Number(subt||0).toFixed(2);
          }
          if(itemsTotalEl && Array.isArray(effectiveItems) && effectiveItems.length){ itemsTotalEl.value = Number(total||0).toFixed(2); }
          if(itemsCountEl){ itemsCountEl.textContent = String((effectiveItems||[]).length||0); }
          // Solo convertir el concepto en personalizado si hay ítems explícitos cargados en el editor
          if(cpEl && Array.isArray(pagoItems) && pagoItems.length){
            const agg = buildItemsConceptLabel(pagoItems);
            if(agg.label){
              let opt = Array.from(cpEl.options || []).find(o => String(o.value) === '__custom__');
              if(!opt){ opt = document.createElement('option'); opt.value='__custom__'; cpEl.appendChild(opt); }
              opt.textContent = agg.label; opt.title = agg.tooltip || ''; cpEl.value = '__custom__'; cpEl.title = agg.tooltip || '';
            }
          }
        }catch(_){}
      } catch(e){ console.warn('No se pudo recalcular el total del pago:', e); }
    }

    // ---- Editor de ítems para el modal de pago ----
    function addPagoItemRow(data){
      try{
        const rows = document.getElementById('pago-items-rows'); if(!rows) return;
        const row = document.createElement('div');
        row.style.display = 'grid';
        row.style.gridTemplateColumns = '1fr 100px 140px 40px';
        row.style.gap = '8px';
        row.style.alignItems = 'center';
        const desc = document.createElement('input'); desc.type='text'; desc.placeholder='Descripción'; desc.style.width='100%'; desc.value = (data && (data.descripcion || data.concepto_nombre || data.nombre)) || '';
        const qty = document.createElement('input'); qty.type='number'; qty.step='1'; qty.inputMode='numeric'; qty.placeholder='1'; qty.value = (data && (data.cantidad != null) ? data.cantidad : 1);
        const price = document.createElement('input'); price.type='number'; price.step='0.01'; price.inputMode='decimal'; price.placeholder='0.00'; price.value = (data && (data.precio_unitario != null ? data.precio_unitario : (data.precio ?? 0))) || 0;
        const del = document.createElement('button'); del.type='button'; del.className='btn icon-only'; del.textContent='×'; del.title='Quitar';
        row.appendChild(desc); row.appendChild(qty); row.appendChild(price); row.appendChild(del);
        rows.appendChild(row);
        const onChange = () => { try{ recalcPagoTotal(); }catch(_){} };
        desc.oninput = onChange; qty.oninput = onChange; price.oninput = onChange;
        del.onclick = () => { try{ rows.removeChild(row); }catch(_){} try{ recalcPagoTotal(); }catch(_){} };
      }catch(_){ }
    }

    function resetPagoForm(){
      const f = document.getElementById('pago-fecha'); if(f) f.value = '';
      const m = document.getElementById('pago-mes'); if(m) m.value = '';
      const a = document.getElementById('pago-año'); if(a) a.value = '';
      const monto = document.getElementById('pago-monto'); if(monto) monto.value = '';
      const u = document.getElementById('pago-usuario'); if(u) u.value = '';
      const mp = document.getElementById('pago-metodo'); if(mp) mp.value = '';
      const cp = document.getElementById('pago-concepto'); if(cp) cp.value = '';
    }

    async function showPagoForm(p){
      editingPagoId = null;
      resetPagoForm();
      const titleEl = document.getElementById('pago-form-title');
      const now = new Date();
      // Limpiar ítems del editor
      try{ const rows = document.getElementById('pago-items-rows'); if(rows) rows.innerHTML = ''; }catch(_){}
      await populatePagoUsuarioSelect(p && (p.usuario_id || (p.usuario && p.usuario.id)));
      await populatePagoMetodoSelect(p && (p.metodo_pago_id || p.metodo_id));
      await populatePagoConceptoSelect(p && p.concepto_id ? p.concepto_id : null);
      if(p && (p.id || p.pago_id)){
        editingPagoId = p.id || p.pago_id;
        if(titleEl) titleEl.textContent = `Editar pago #${editingPagoId}`;
        const montoEl = document.getElementById('pago-monto'); if(montoEl) montoEl.value = (p.monto != null ? p.monto : '');
        const fechaSrc = p.fecha_pago || p.fecha || p.fechaPago || null;
        const fechaEl = document.getElementById('pago-fecha'); if(fechaEl) fechaEl.value = fechaSrc ? fmtDate(fechaSrc) : '';
        const mesEl = document.getElementById('pago-mes'); const añoEl = document.getElementById('pago-año');
        if(mesEl && añoEl){
          const dt = fechaSrc ? new Date(fechaSrc) : now;
          mesEl.value = String(dt.getMonth()+1);
          añoEl.value = String(dt.getFullYear());
        }
        const uSel = document.getElementById('pago-usuario'); if(uSel && (p.usuario_id || (p.usuario && p.usuario.id))) uSel.value = String(p.usuario_id || (p.usuario && p.usuario.id));
        const mpSel = document.getElementById('pago-metodo'); if(mpSel && (p.metodo_pago_id || p.metodo_id)) mpSel.value = String(p.metodo_pago_id || p.metodo_id);
        // Pre-cargar ítems desde conceptos si existen
        try{
          const rows = document.getElementById('pago-items-rows');
          if(rows && Array.isArray(p.conceptos) && p.conceptos.length){
            p.conceptos.forEach(c => addPagoItemRow({ descripcion: (c.descripcion || c.concepto_nombre || c.nombre || ''), cantidad: (c.cantidad != null ? c.cantidad : 1), precio_unitario: (c.precio_unitario != null ? c.precio_unitario : (c.precio ?? 0)) }));
            const adv = document.getElementById('pago-items-advanced'); if(adv) adv.open = true;
          }
        }catch(_){}
        // Fallback: si no hay conceptos explícitos, inicializar una fila con el concepto seleccionado
        try{
          const rows = document.getElementById('pago-items-rows');
          if(rows && (!Array.isArray(p.conceptos) || p.conceptos.length === 0)){
            const conceptoEl = document.getElementById('pago-concepto');
            const uSel2 = document.getElementById('pago-usuario');
            const conceptoId = conceptoEl && conceptoEl.value ? String(conceptoEl.value) : '';
            const conceptoSel = conceptoId ? (state.conceptosPagoMap ? state.conceptosPagoMap[conceptoId] : null) : null;
            const uid2 = uSel2 && uSel2.value ? Number(uSel2.value) : null;
            let pu = 0;
            if(p && p.monto != null){ pu = Number(p.monto||0); }
            else {
              try{
                const u = (state.usuarios || []).find(x => Number(x.id) === uid2);
                const tipoVal = u ? (u.tipo_cuota ?? null) : null; const tipoObj = resolveTipoCuota(tipoVal);
                if(conceptoSel && normalizeStr(conceptoSel.nombre) === normalizeStr('Cuota Mensual')){ pu = tipoObj ? Number(tipoObj.precio ?? tipoObj.precio_base ?? 0) : 0; }
                else { pu = conceptoSel ? Number(conceptoSel.precio_base ?? 0) : (tipoObj ? Number(tipoObj.precio ?? tipoObj.precio_base ?? 0) : 0); }
              }catch(_){ pu = 0; }
            }
            const desc = conceptoSel ? (String(conceptoSel.nombre||'').trim() || 'Concepto') : (p && (p.concepto_pago || p.concepto) ? String(p.concepto_pago || p.concepto) : 'Concepto');
            addPagoItemRow({ descripcion: desc, cantidad: 1, precio_unitario: pu });
            const adv = document.getElementById('pago-items-advanced'); if(adv) adv.open = true;
          }
        }catch(_){}
      } else {
        if(titleEl) titleEl.textContent = 'Registrar pago';
        const mesEl = document.getElementById('pago-mes'); const añoEl = document.getElementById('pago-año');
        if(mesEl) mesEl.value = String(now.getMonth()+1);
        if(añoEl) añoEl.value = String(now.getFullYear());
        const uSel = document.getElementById('pago-usuario'); if(uSel && state.selectedUsuario && state.selectedUsuario.id) uSel.value = String(state.selectedUsuario.id);
        // Fallback de creación: añadir fila inicial representando el concepto seleccionado (Cuota Mensual por defecto)
        try{
          const rows = document.getElementById('pago-items-rows');
          if(rows){
            const conceptoEl = document.getElementById('pago-concepto');
            const conceptoId = conceptoEl && conceptoEl.value ? String(conceptoEl.value) : '';
            const conceptoSel = conceptoId ? (state.conceptosPagoMap ? state.conceptosPagoMap[conceptoId] : null) : null;
            const uid = uSel && uSel.value ? Number(uSel.value) : null;
            let pu = 0;
            try{
              const u = (state.usuarios || []).find(x => Number(x.id) === uid);
              const tipoVal = u ? (u.tipo_cuota ?? null) : null; const tipoObj = resolveTipoCuota(tipoVal);
              if(conceptoSel && normalizeStr(conceptoSel.nombre) === normalizeStr('Cuota Mensual')){ pu = tipoObj ? Number(tipoObj.precio ?? tipoObj.precio_base ?? 0) : 0; }
              else { pu = conceptoSel ? Number(conceptoSel.precio_base ?? 0) : (tipoObj ? Number(tipoObj.precio ?? tipoObj.precio_base ?? 0) : 0); }
            }catch(_){ pu = 0; }
            const desc = conceptoSel ? (String(conceptoSel.nombre||'').trim() || 'Concepto') : 'Concepto';
            addPagoItemRow({ descripcion: desc, cantidad: 1, precio_unitario: pu });
            const adv = document.getElementById('pago-items-advanced'); if(adv) adv.open = true;
          }
        }catch(_){}
      }
      await recalcPagoTotal();
      openModal('modal-pago-form');
    }

    function hidePagoForm(){
      editingPagoId = null;
      closeModal('modal-pago-form');
    }

    async function savePago(){
      const usuarioEl = document.getElementById('pago-usuario');
      const montoEl = document.getElementById('pago-monto');
      const fechaEl = document.getElementById('pago-fecha');
      const mesEl = document.getElementById('pago-mes');
      const añoEl = document.getElementById('pago-año');
      const metodoEl = document.getElementById('pago-metodo');
      const usuario_id = usuarioEl && usuarioEl.value ? Number(usuarioEl.value) : null;
      const monto = montoEl && montoEl.value ? Number(montoEl.value) : null;
      const fecha_str = fechaEl && fechaEl.value ? fechaEl.value : null;
      let mes = mesEl && mesEl.value ? Number(mesEl.value) : null;
      let año = añoEl && añoEl.value ? Number(añoEl.value) : null;
      const metodo_pago_id = metodoEl && metodoEl.value ? Number(metodoEl.value) : null;
      // Leer ítems del editor del modal de pago
      let pagoItems = [];
      try{
        const rows = document.getElementById('pago-items-rows');
        if(rows){
          pagoItems = Array.from(rows.children || []).map(r => {
            const c = r.children || [];
            const desc = c[0] ? String(c[0].value || '').trim() : '';
            const qty = c[1] ? Number(c[1].value || 1) : 1;
            const pu = c[2] ? Number(c[2].value || 0) : 0;
            return { descripcion: desc, cantidad: qty, precio_unitario: pu };
          }).filter(it => String(it.descripcion||'').trim());
        }
      }catch(_){}
      const itemsSubtotal = Array.isArray(pagoItems) ? pagoItems.reduce((acc, it) => acc + Number(it.cantidad||1)*Number(it.precio_unitario||0), 0) : 0;
      const itemsAgg = buildItemsConceptLabel(pagoItems);
      if(!usuario_id || !monto){ showToast('Usuario y monto son obligatorios', 'warning', 4000); return; }
      let url = '/api/pagos'; let method = 'POST'; let body = {};
      const conceptoEl = document.getElementById('pago-concepto');
      const conceptoIdRaw = conceptoEl && conceptoEl.value ? String(conceptoEl.value) : '';
      const conceptoSel = conceptoIdRaw ? (state.conceptosPagoMap ? state.conceptosPagoMap[conceptoIdRaw] : null) : null;
    if(editingPagoId){
      url = `/api/pagos/${editingPagoId}`; method = 'PUT';
      // Construir conceptos desde el editor y añadir SIEMPRE el ítem del concepto original al inicio
      let conceptos = Array.isArray(pagoItems) ? pagoItems.filter(it => String(it.descripcion||'').trim()).map(it => ({ descripcion: String(it.descripcion||'').trim(), cantidad: Number(it.cantidad||1), precio_unitario: Number(it.precio_unitario||0) })) : [];
      // Recalcular precio unitario del concepto seleccionado (cuota mensual usa precio de tipo de cuota)
      let precio_concepto = 0;
      try {
        const u = (state.usuarios || []).find(x => Number(x.id) === usuario_id);
        const tipoVal = u ? (u.tipo_cuota ?? null) : null;
        const tipoObj = resolveTipoCuota(tipoVal);
        if(conceptoSel && String(conceptoSel.nombre||'').trim().toLowerCase() === 'cuota mensual'){
          precio_concepto = tipoObj ? Number(tipoObj.precio ?? tipoObj.precio_base ?? 0) : 0;
        } else {
          precio_concepto = conceptoSel ? Number(conceptoSel.precio_base ?? 0) : (tipoObj ? Number(tipoObj.precio ?? tipoObj.precio_base ?? 0) : 0);
        }
      } catch(_){ precio_concepto = 0; }
      const desc = conceptoSel ? (String(conceptoSel.nombre||'').trim() || 'Concepto') : ((itemsAgg && itemsAgg.label) ? itemsAgg.label : 'Concepto');
      const pu = Number.isFinite(precio_concepto) && precio_concepto>0 ? precio_concepto : Number(monto||0);
      if(conceptoSel && conceptoSel.id != null){ conceptos.unshift({ concepto_id: Number(conceptoSel.id), cantidad: 1, precio_unitario: pu }); }
      else { conceptos.unshift({ descripcion: desc, cantidad: 1, precio_unitario: pu }); }
      body = { usuario_id, monto, metodo_pago_id, conceptos };
      // Enviar concepto agregado para visualización rápida
      if(itemsAgg && itemsAgg.label){ body['concepto'] = itemsAgg.label; body['concepto_pago'] = itemsAgg.label; }
      if(fecha_str && fecha_str.trim()){ body['fecha_pago'] = fecha_str; }
      else if(mes != null && año != null){ body['mes'] = mes; body['año'] = año; }
    } else {
        // Crear pago avanzado con conceptos detallados + fecha/mes-año
        let concepto_id_final = conceptoSel ? Number(conceptoSel.id) : null;
        if(!concepto_id_final){
          const items = Array.isArray(state.conceptosPago) ? state.conceptosPago : [];
          const monthly = items.find(c => String(c.nombre||'').trim().toLowerCase() === 'cuota mensual');
          if(monthly) concepto_id_final = Number(monthly.id);
        }
        // Determinar precio unitario del concepto seleccionado (sin mezclar ítems)
        let precio_concepto = 0;
        const u = (state.usuarios || []).find(x => Number(x.id) === usuario_id);
        const tipoVal = u ? (u.tipo_cuota ?? null) : null;
        const tipoObj = resolveTipoCuota(tipoVal);
        if(conceptoSel && String(conceptoSel.nombre||'').trim().toLowerCase() === 'cuota mensual'){
          precio_concepto = tipoObj ? Number(tipoObj.precio ?? tipoObj.precio_base ?? 0) : 0;
        } else {
          precio_concepto = conceptoSel ? Number(conceptoSel.precio_base ?? 0) : (tipoObj ? Number(tipoObj.precio ?? tipoObj.precio_base ?? 0) : 0);
        }
        // Construir arreglo de conceptos: primero el concepto seleccionado (si existe), luego los ítems personalizados
        const conceptos = [];
        if(concepto_id_final){ conceptos.push({ concepto_id: concepto_id_final, cantidad: 1, precio_unitario: precio_concepto }); }
        if(Array.isArray(pagoItems) && pagoItems.length){
          pagoItems.forEach(it => {
            const desc = String(it.descripcion||'').trim();
            const qty = Number(it.cantidad||1);
            const pu = Number(it.precio_unitario||0);
            if(desc && qty > 0 && pu >= 0){ conceptos.push({ descripcion: desc, cantidad: qty, precio_unitario: pu }); }
          });
        }
        body = { usuario_id, metodo_pago_id, conceptos };
        // Enviar etiqueta agregada para visualización
        if(itemsAgg && itemsAgg.label){ body['concepto'] = itemsAgg.label; body['concepto_pago'] = itemsAgg.label; }
        if(fecha_str && fecha_str.trim()){ body['fecha_pago'] = fecha_str; }
        else {
          if(!mes || !año){ const now = new Date(); mes = now.getMonth()+1; año = now.getFullYear(); }
          body['mes'] = mes; body['año'] = año;
        }
      }
      try{
        const res = await fetch(url, { method, headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(body) });
        if(!res.ok){ const err = await res.json().catch(()=>({})); showToast(err.detail || err.error || 'Error al guardar el pago', 'error', 4500); return; }
        await res.json().catch(()=>null);
        hidePagoForm();
        await loadPayments();
        try{ document.dispatchEvent(new CustomEvent('pagos:updated')); }catch(_){}
      } catch(e){ showToast('Error de red al guardar', 'error', 4500); }
    }

    // ==== Wizard Nuevo Pago (Side‑sheet) ====
    function wizardSetStep(n){
      try{
        const root = document.getElementById('pago-wizard'); if(!root) return;
        // Simplificado: mostrar todos los bloques a la vez y ocultar navegación
        root.setAttribute('data-step', '4');
        root.querySelectorAll('.wizard-step').forEach(s => { s.classList.add('active'); });
        const stepsHeader = root.querySelector('.wizard-steps'); if(stepsHeader) stepsHeader.style.display = 'none';
        const prevBtn = root.querySelector('#pago-wizard-prev'); const nextBtn = root.querySelector('#pago-wizard-next'); const saveBtn = root.querySelector('#pago-wizard-save');
        if(prevBtn) prevBtn.style.display = 'none';
        if(nextBtn) nextBtn.style.display = 'none';
        if(saveBtn) saveBtn.style.display = '';
      }catch(e){}
    }
    async function recalcPagoTotalWizard(){
      try{
        // Asegurar catálogos necesarios para resolver tipo de cuota y concepto mensual
        try {
          await ensureMonthlyQuotaConceptVariableActive();
        } catch(_){ }
        try {
          if(!Array.isArray(state.tiposCuotaActivos) || state.tiposCuotaActivos.length === 0){
            await loadTiposCuotaActivos();
          }
        } catch(_){ }
        try { await ensureTiposCuotaCatalogo(); } catch(_){ }
        const usuarioEl = document.getElementById('wiz-usuario');
        const metodoEl = document.getElementById('wiz-metodo');
        const conceptoEl = document.getElementById('wiz-concepto');
        const montoEl = document.getElementById('wiz-monto');
        const uid = usuarioEl && usuarioEl.value ? Number(usuarioEl.value) : null;
        const conceptoId = conceptoEl && conceptoEl.value ? String(conceptoEl.value) : '';
        const concepto = conceptoId ? (state.conceptosPagoMap ? state.conceptosPagoMap[conceptoId] : null) : null;
        let base = 0; let conceptoNombre = 'Cuota Mensual';
        // Ítems del wizard: si existen, dominan el cálculo del base
        let wizItems = [];
        try{
          const rows = document.getElementById('wiz-items-rows');
          if(rows){
            Array.from(rows.children || []).forEach(row => {
              try{
                const inputs = row.querySelectorAll('input');
                const desc = (inputs[0]?.value || '').trim();
                const qty = parseFloat(inputs[1]?.value || '1');
                const price = parseFloat(inputs[2]?.value || '0');
                if(desc){ wizItems.push({ descripcion: desc, cantidad: isNaN(qty)?1:qty, precio_unitario: isNaN(price)?0:price }); }
              }catch(_){ }
            });
          }
        }catch(_){ }
        if(Array.isArray(wizItems) && wizItems.length){
          let subtotal = 0.0; for(const it of wizItems){ subtotal += ((it.cantidad||1) * (it.precio_unitario||0)); }
          base = subtotal;
          const agg = buildItemsConceptLabel(wizItems);
          if(agg.label){ conceptoNombre = agg.label; }
          // Actualizar UI de ítems
          try{ const subEl = document.getElementById('wiz-items-subtotal'); if(subEl) subEl.value = Number(subtotal||0).toFixed(2); }catch(_){}
          try{ const cntEl = document.getElementById('wiz-items-count'); if(cntEl) cntEl.value = String(wizItems.length||0); }catch(_){}
          // Actualizar select concepto con etiqueta personalizada
          try{
            if(conceptoEl){
              let opt = Array.from(conceptoEl.options || []).find(o => String(o.value) === '__custom__');
              if(!opt){ opt = document.createElement('option'); opt.value='__custom__'; conceptoEl.appendChild(opt); }
              opt.textContent = agg.label || 'Personalizado'; opt.title = agg.tooltip || '';
              conceptoEl.value = '__custom__'; conceptoEl.title = agg.tooltip || '';
            }
          }catch(_){}
        } else {
          if(concepto){ conceptoNombre = concepto.nombre || conceptoNombre; }
          if(uid){
            const u = (state.usuarios || []).find(x => Number(x.id) === uid);
            const tipoValCandidates = [u ? u.tipo_cuota : null, u ? (u.tipo_cuota_nombre ?? null) : null, u ? (u.tipo ?? null) : null, u ? (u.tipo_cuota_id ?? null) : null];
            let tipoObj = null;
            for(const cand of tipoValCandidates){
              if(cand == null) continue;
              const r = resolveTipoCuota(cand);
              if(r){ tipoObj = r; break; }
            }
            if(concepto && normalizeStr(concepto.nombre) === normalizeStr('Cuota Mensual')){
              base = tipoObj ? Number(tipoObj.precio ?? tipoObj.precio_base ?? 0) : 0;
            } else {
              base = concepto ? Number(concepto.precio_base ?? 0) : (tipoObj ? Number(tipoObj.precio ?? tipoObj.precio_base ?? 0) : 0);
            }
          } else {
            base = concepto ? Number(concepto.precio_base ?? 0) : 0;
          }
        }
        const metodoId = metodoEl && metodoEl.value ? String(metodoEl.value) : '';
        const metodo = metodoId ? (state.metodosPagoMap ? state.metodosPagoMap[metodoId] : null) : null;
        const pct = metodo ? Number(metodo.comision_porcentaje ?? metodo.comision ?? 0) : 0;
        const comision = round2(base * pct / 100);
        const total = round2(base + comision);
        if(montoEl){ montoEl.value = total > 0 ? String(total) : ''; }
        // Si hay ítems, completar total de ítems
        try{ const itemsTotalEl = document.getElementById('wiz-items-total'); if(itemsTotalEl && Array.isArray(wizItems)){ itemsTotalEl.value = Number(total||0).toFixed(2); } }catch(_){}
        const root = document.getElementById('pago-wizard'); if(root){
          const effectiveItems = (Array.isArray(wizItems) && wizItems.length) ? wizItems : (
            concepto ? [{ descripcion: (concepto.nombre || 'Cuota Mensual'), cantidad: 1, precio_unitario: Number(base||0) }] : []
          );
          const cEl = root.querySelector('#wiz-resumen-concepto'); if(cEl){ cEl.textContent = conceptoNombre; try{ const itemsAgg = buildItemsConceptLabel(effectiveItems); cEl.setAttribute('title', itemsAgg.tooltip || ''); }catch(_){ } }
          const bEl = root.querySelector('#wiz-resumen-base'); if(bEl) bEl.textContent = base>0 ? Number(base).toFixed(2) : '—';
          const comEl = root.querySelector('#wiz-resumen-comision'); if(comEl) comEl.textContent = comision>0 ? Number(comision).toFixed(2) : '—';
          const pctEl = root.querySelector('#wiz-resumen-comision-porcentaje'); if(pctEl) pctEl.textContent = pct>0 ? `(${pct}% del método)` : '';
          const tEl = root.querySelector('#wiz-resumen-total'); if(tEl) tEl.textContent = total>0 ? Number(total).toFixed(2) : '—';
          const iEl = root.querySelector('#wiz-resumen-items'); if(iEl) iEl.textContent = String((effectiveItems||[]).length||0);
        }
      } catch(e){ console.warn('No se pudo recalcular total en wizard:', e); }
    }
    async function populateWizardUsuarioSelect(selectedId){ const sel = document.getElementById('wiz-usuario'); if(!sel) return; sel.innerHTML = '<option value="">Seleccionar usuario</option>'; const arr = Array.isArray(state.usuarios) ? state.usuarios : []; arr.forEach(u => { const opt = document.createElement('option'); opt.value = String(u.id); opt.textContent = (u.nombre || '') + (u.dni ? ` • DNI ${u.dni}` : ''); sel.appendChild(opt); }); if(selectedId){ sel.value = String(selectedId); } }
    async function populateWizardMetodoSelect(selectedId){ const sel = document.getElementById('wiz-metodo'); if(!sel) return; sel.innerHTML = '<option value="">Seleccionar (opcional)</option>'; if(!Array.isArray(state.metodosPago) || state.metodosPago.length===0){ try{ await loadMetodosPago(); }catch(_){} }
      (Array.isArray(state.metodosPago) ? state.metodosPago : []).forEach(m => { const opt = document.createElement('option'); opt.value = String(m.id); opt.textContent = m.nombre || (`Método ${m.id}`); sel.appendChild(opt); }); if(selectedId){ sel.value = String(selectedId); } }
    async function populateWizardConceptoSelect(selectedId){ const sel = document.getElementById('wiz-concepto'); if(!sel) return; sel.innerHTML = '<option value="">Seleccionar concepto</option>'; if(!Array.isArray(state.conceptosPago) || state.conceptosPago.length===0){ try{ await loadConceptosPago(); }catch(_){} }
      const arr = (Array.isArray(state.conceptosPago) ? state.conceptosPago : []);
      arr.forEach(c => { const opt = document.createElement('option'); opt.value = String(c.id); opt.textContent = c.nombre || (`Concepto ${c.id}`); sel.appendChild(opt); });
      if(selectedId){ sel.value = String(selectedId); }
      else {
        const monthly = arr.find(c => normalizeStr(c.nombre) === normalizeStr('Cuota Mensual'));
        if(monthly){ sel.value = String(monthly.id); }
      }
    }
    function addWizardItemRow(){
      try{
        const rows = document.getElementById('wiz-items-rows'); if(!rows) return;
        const row = document.createElement('div'); row.className = 'input-row'; row.style.gap = '8px';
        const colDesc = document.createElement('div'); colDesc.style.flex = '2'; const lblDesc = document.createElement('label'); lblDesc.className = 'muted'; lblDesc.textContent = 'Descripción'; const inpDesc = document.createElement('input'); inpDesc.type = 'text'; inpDesc.placeholder = 'Ej. Producto, servicio, etc.'; inpDesc.style.width = '100%'; colDesc.appendChild(lblDesc); colDesc.appendChild(inpDesc);
        const colQty = document.createElement('div'); colQty.style.flex = '1'; const lblQty = document.createElement('label'); lblQty.className = 'muted'; lblQty.textContent = 'Cantidad'; const inpQty = document.createElement('input'); inpQty.type = 'number'; inpQty.step = '1'; inpQty.inputMode = 'numeric'; inpQty.placeholder = '1'; inpQty.style.width = '100%'; colQty.appendChild(lblQty); colQty.appendChild(inpQty);
        const colPU = document.createElement('div'); colPU.style.flex = '1'; const lblPU = document.createElement('label'); lblPU.className = 'muted'; lblPU.textContent = 'Precio unitario'; const inpPU = document.createElement('input'); inpPU.type = 'number'; inpPU.step = '0.01'; inpPU.inputMode = 'decimal'; inpPU.placeholder = '0.00'; inpPU.style.width = '100%'; colPU.appendChild(lblPU); colPU.appendChild(inpPU);
        const colActions = document.createElement('div'); colActions.style.display = 'flex'; colActions.style.alignItems = 'flex-end'; const delBtn = document.createElement('button'); delBtn.className = 'btn danger'; delBtn.type='button'; delBtn.textContent = 'Eliminar'; colActions.appendChild(delBtn);
        row.appendChild(colDesc); row.appendChild(colQty); row.appendChild(colPU); row.appendChild(colActions);
        rows.appendChild(row);
        const onChange = () => { try{ recalcPagoTotalWizard(); }catch(_){ } };
        [inpDesc, inpQty, inpPU].forEach(inp => { inp.addEventListener('input', onChange); inp.addEventListener('change', onChange); });
        delBtn.onclick = () => { try{ rows.removeChild(row); }catch(_){ } onChange(); };
        onChange();
      }catch(_){ /* noop */ }
    }
    async function showPagoWizard(){ try{
      const root = document.getElementById('pago-wizard'); if(!root){ console.warn('No existe #pago-wizard'); return; }
      // Defaults
      const now = new Date(); const mesEl = document.getElementById('wiz-mes'); const añoEl = document.getElementById('wiz-año'); if(mesEl) mesEl.value = String(now.getMonth()+1); if(añoEl) añoEl.value = String(now.getFullYear());
      const fechaEl = document.getElementById('wiz-fecha'); if(fechaEl) fechaEl.value = fmtDate(now);
      await populateWizardUsuarioSelect(state.selectedUsuario && state.selectedUsuario.id ? state.selectedUsuario.id : null);
      await populateWizardMetodoSelect(null);
      await populateWizardConceptoSelect(null);
      await recalcPagoTotalWizard();
      // Preparar editor de ítems
      try{ const wizRows = document.getElementById('wiz-items-rows'); if(wizRows) wizRows.innerHTML = ''; }catch(_){}
      try{ const addBtn = document.getElementById('wiz-item-add'); if(addBtn) addBtn.onclick = () => addWizardItemRow(); }catch(_){}
      // Precargar una fila vacía por conveniencia
      try{ addWizardItemRow(); }catch(_){}
      // Bind events (idempotente)
      const usuarioEl = document.getElementById('wiz-usuario'); if(usuarioEl){ usuarioEl.addEventListener('change', recalcPagoTotalWizard); usuarioEl.addEventListener('change', () => { try{ clearFieldError('wiz-usuario'); }catch(_){ } }); }
      const conceptoEl = document.getElementById('wiz-concepto'); if(conceptoEl) conceptoEl.addEventListener('change', recalcPagoTotalWizard);
      const metodoEl = document.getElementById('wiz-metodo'); if(metodoEl) metodoEl.addEventListener('change', recalcPagoTotalWizard);
      const nextBtn = root.querySelector('#pago-wizard-next'); const prevBtn = root.querySelector('#pago-wizard-prev'); const saveBtn = root.querySelector('#pago-wizard-save');
      if(nextBtn){ nextBtn.onclick = async function(){ const step = Number(root.getAttribute('data-step')||'1'); if(step===1){ const uid = usuarioEl && usuarioEl.value ? Number(usuarioEl.value) : null; if(!uid){ showToast('Selecciona un usuario', 'warning', 3000); return; } wizardSetStep(2); }
        else if(step===2){ const cid = conceptoEl && conceptoEl.value ? String(conceptoEl.value) : ''; if(!cid){ showToast('Selecciona un concepto', 'warning', 3000); return; } wizardSetStep(3); }
        else if(step===3){ await recalcPagoTotalWizard(); wizardSetStep(4); }
      }; }
      if(prevBtn){ prevBtn.onclick = function(){ const step = Number(root.getAttribute('data-step')||'1'); wizardSetStep(Math.max(1, step-1)); }; }
      if(saveBtn){ saveBtn.onclick = savePagoWizard; }
      wizardSetStep(4);
      try {
        if (window.UI && typeof UI.openSideSheet === 'function') {
          UI.openSideSheet('pago-wizard');
          // Foco inicial para accesibilidad
          setTimeout(() => { try{ document.getElementById('wiz-usuario')?.focus(); }catch(_){} }, 10);
        } else {
          const sheet = document.getElementById('pago-wizard');
          const backdrop = document.querySelector('.side-sheet-backdrop');
          if (sheet) sheet.classList.add('open');
          if (backdrop) backdrop.classList.add('open');
        }
      } catch(_){ /* noop */ }
      // Guardado rápido con Ctrl+Enter
      try{ root.addEventListener('keydown', (ev) => { if((ev.ctrlKey || ev.metaKey) && ev.key === 'Enter'){ ev.preventDefault(); savePagoWizard(); } }); }catch(_){}
    }catch(e){ console.warn('No se pudo abrir wizard:', e); }}
    function hidePagoWizard(){
      try {
        if (window.UI && typeof UI.closeSideSheet === 'function') {
          UI.closeSideSheet('pago-wizard');
        } else {
          const sheet = document.getElementById('pago-wizard');
          const backdrop = document.querySelector('.side-sheet-backdrop');
          if (sheet) sheet.classList.remove('open');
          if (backdrop) backdrop.classList.remove('open');
        }
      } catch(_){ /* noop */ }
    }
    // Helpers de validación visual
    function setFieldError(fieldId, message){ try{ const el = document.getElementById(fieldId); const err = document.getElementById(fieldId+'-error'); if(el){ el.setAttribute('aria-invalid','true'); el.classList.add('input-error'); } if(err){ err.textContent = message || err.textContent || 'Campo inválido'; err.style.display = ''; } }catch(_){ } }
    function clearFieldError(fieldId){ try{ const el = document.getElementById(fieldId); const err = document.getElementById(fieldId+'-error'); if(el){ el.removeAttribute('aria-invalid'); el.classList.remove('input-error'); } if(err){ err.style.display = 'none'; } }catch(_){ } }
    async function savePagoWizard(){
      const usuarioEl = document.getElementById('wiz-usuario');
      const montoEl = document.getElementById('wiz-monto');
      const fechaEl = document.getElementById('wiz-fecha');
      const mesEl = document.getElementById('wiz-mes');
      const añoEl = document.getElementById('wiz-año');
      const metodoEl = document.getElementById('wiz-metodo');
      const conceptoEl = document.getElementById('wiz-concepto');
      const usuario_id = usuarioEl && usuarioEl.value ? Number(usuarioEl.value) : null;
      const monto = montoEl && montoEl.value ? Number(montoEl.value) : null;
      const fecha_str = fechaEl && fechaEl.value ? fechaEl.value : null;
      let mes = mesEl && mesEl.value ? Number(mesEl.value) : null;
      let año = añoEl && añoEl.value ? Number(añoEl.value) : null;
      const metodo_pago_id = metodoEl && metodoEl.value ? Number(metodoEl.value) : null;
      const conceptoIdRaw = conceptoEl && conceptoEl.value ? String(conceptoEl.value) : '';
      const conceptoSel = conceptoIdRaw ? (state.conceptosPagoMap ? state.conceptosPagoMap[conceptoIdRaw] : null) : null;
      // Validación visual
      clearFieldError('wiz-usuario');
      clearFieldError('wiz-monto');
      if(!usuario_id){ setFieldError('wiz-usuario', 'Debes seleccionar un usuario.'); showToast('Selecciona un usuario', 'warning', 3000); try{ usuarioEl?.focus(); }catch(_){ } return; }
      // El monto es calculado automáticamente a partir del concepto y método; no exigir valor manual
      let url = '/api/pagos'; let method = 'POST'; let body = {};
      // Leer ítems del wizard
      let pagoItems = [];
      try{
        const rows = document.getElementById('wiz-items-rows');
        if(rows){ Array.from(rows.children || []).forEach(row => {
          try{
            const inputs = row.querySelectorAll('input');
            const desc = (inputs[0]?.value || '').trim();
            const qty = parseFloat(inputs[1]?.value || '1');
            const price = parseFloat(inputs[2]?.value || '0');
            if(desc){ pagoItems.push({ descripcion: desc, cantidad: isNaN(qty)?1:qty, precio_unitario: isNaN(price)?0:price }); }
          }catch(_){ }
        }); }
      }catch(_){ }
      const itemsAgg = buildItemsConceptLabel(pagoItems);
      // Si hay ítems, sólo enviar esos conceptos; si no, enviar el concepto seleccionado (o mensual por defecto)
      let conceptos = [];
      if(Array.isArray(pagoItems) && pagoItems.length){
        conceptos = pagoItems.filter(it => String(it.descripcion||'').trim()).map(it => ({ descripcion: String(it.descripcion||'').trim(), cantidad: Number(it.cantidad||1), precio_unitario: Number(it.precio_unitario||0) }));
      } else {
        let concepto_id_final = conceptoSel ? Number(conceptoSel.id) : null;
        if(!concepto_id_final){ const items = Array.isArray(state.conceptosPago) ? state.conceptosPago : []; const monthly = items.find(c => normalizeStr(c.nombre) === normalizeStr('Cuota Mensual')); if(monthly) concepto_id_final = Number(monthly.id); }
        let precio_unitario = 0; const u = (state.usuarios || []).find(x => Number(x.id) === usuario_id); const tipoValCandidates = [u ? u.tipo_cuota : null, u ? (u.tipo_cuota_nombre ?? null) : null, u ? (u.tipo ?? null) : null, u ? (u.tipo_cuota_id ?? null) : null]; let tipoObj = null; for(const cand of tipoValCandidates){ if(cand == null) continue; const r = resolveTipoCuota(cand); if(r){ tipoObj = r; break; } }
        if(conceptoSel && normalizeStr(conceptoSel.nombre) === normalizeStr('Cuota Mensual')){ precio_unitario = tipoObj ? Number(tipoObj.precio ?? tipoObj.precio_base ?? 0) : 0; }
        else { precio_unitario = conceptoSel ? Number(conceptoSel.precio_base ?? 0) : (tipoObj ? Number(tipoObj.precio ?? tipoObj.precio_base ?? 0) : 0); }
        if(concepto_id_final){ conceptos.push({ concepto_id: concepto_id_final, cantidad: 1, precio_unitario }); }
      }
      body = { usuario_id, metodo_pago_id, conceptos };
      // Etiqueta de concepto agregada para visualización cuando hay ítems
      if(Array.isArray(pagoItems) && pagoItems.length && itemsAgg && itemsAgg.label){ body['concepto'] = itemsAgg.label; body['concepto_pago'] = itemsAgg.label; }
      if(fecha_str && fecha_str.trim()){ body['fecha_pago'] = fecha_str; }
      else { if(!mes || !año){ const now = new Date(); mes = now.getMonth()+1; año = now.getFullYear(); } body['mes'] = mes; body['año'] = año; }
      try{
        const res = await fetch(url, { method, headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(body) });
        if(!res.ok){ const err = await res.json().catch(()=>({})); showToast(err.detail || err.error || 'Error al guardar el pago', 'error', 4500); return; }
        await res.json().catch(()=>null);
        hidePagoWizard();
        await loadPayments();
        try{ document.dispatchEvent(new CustomEvent('pagos:updated')); }catch(_){}
      }catch(e){ showToast('Error de red al guardar', 'error', 4500); }
    }

    async function deletePago(){
      const id = state.deletePagoId; if(!id){ closeModal('modal-pagos-delete'); return; }
      try{
        const res = await fetch(`/api/pagos/${id}`, { method:'DELETE', headers:{ 'Accept':'application/json' } });
        if(!res.ok){ const err = await res.json().catch(()=>({})); showToast(err.detail || err.error || 'No se pudo eliminar el pago', 'error', 4500); return; }
        await res.json().catch(()=>null);
        closeModal('modal-pagos-delete');
        if(state.selectedPago && (state.selectedPago.id === id || state.selectedPago.pago_id === id)) clearPagoSelection();
        await loadPayments();
        try{ document.dispatchEvent(new CustomEvent('pagos:updated')); }catch(_){}
      } catch(e){ showToast('Error de red al eliminar', 'error', 4500); }
    }

    function exportPagosCSV(){
      const items = Array.isArray(state.pagos) ? state.pagos : [];
      const headers = ['Fecha','Usuario','DNI','Método','Concepto','Monto'];
      const rows = items.map(p => [
        (p.fecha_pago || p.fecha || p.fechaPago) ? fmtDate(p.fecha_pago || p.fecha || p.fechaPago) : '',
        String(p.usuario_nombre || p.nombre || ''),
        String(p.dni || ''),
        String(p.metodo_pago || p.metodo || ''),
        String(p.concepto_pago || p.concepto || ''),
        String(p.monto != null ? p.monto : '')
      ]);
      const csv = [headers.join(','), ...rows.map(cols => cols.map(v => {
        const s = String(v ?? '');
        return /[",\n]/.test(s) ? '"' + s.replace(/"/g,'""') + '"' : s;
      }).join(','))].join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'pagos.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function renderUsuarioSide(u, historial){
      const estado = (u.activo === true || u.activo === 'true') ? 'Activo' : 'Inactivo';
      document.getElementById('usuario-side-estado').textContent = estado;
      const venc = u.fecha_proximo_vencimiento || u.proximo_vencimiento || null;
      document.getElementById('usuario-side-vencimiento').textContent = venc ? fmtDateEs(venc) : '—';
      document.getElementById('usuario-side-cuotas-vencidas').textContent = (u.cuotas_vencidas != null ? u.cuotas_vencidas : '—');
      document.getElementById('usuario-side-nombre').textContent = u.nombre || '';
      document.getElementById('usuario-side-dni').textContent = u.dni || '';
      document.getElementById('usuario-side-telefono').textContent = u.telefono || '';
      document.getElementById('usuario-side-rol').textContent = (u.rol || '').toString().toLowerCase();
      const tipoObj = resolveTipoCuota(u.tipo_cuota);
      document.getElementById('usuario-side-tipo-cuota').textContent = tipoObj ? (tipoObj.nombre ?? String(tipoObj.id ?? '')) : (u.tipo_cuota ?? '');
      const up = u.ultimo_pago || u.fecha_ultimo_pago || null;
      document.getElementById('usuario-side-ultimo-pago').textContent = up ? fmtDateEs(up) : '—';
      const notasTextarea = document.getElementById('usuario-notas-textarea');
      if(notasTextarea) notasTextarea.value = (u.notas && String(u.notas).trim()) ? String(u.notas) : '';
      const tbody = document.querySelector('#usuario-historial-table tbody');
      if(tbody){
        tbody.innerHTML = '';
        (Array.isArray(historial) ? historial : []).forEach(p => {
          const tr = document.createElement('tr');
          const fecha = p.fecha_pago || p.fecha || p.fechaPago || null;
          const metodo = p.metodo_pago || p.metodo || '';
          const concepto = p.concepto_pago || p.concepto || '';
          const monto = p.monto != null ? p.monto : '';
          tr.innerHTML = `<td>${fecha ? fmtDateEs(fecha) : ''}</td><td>${metodo}</td><td>${concepto}</td><td>${fmtCurrency(monto)}</td>`;
          tbody.appendChild(tr);
        });
      }
    }

    function syncUsuarioSheetFromSide(){
      try{
        const copyText = (srcId, dstId) => { const src = document.getElementById(srcId); const dst = document.getElementById(dstId); if(dst) dst.textContent = src ? src.textContent : '—'; };
        copyText('usuario-side-estado','usuario-sheet-estado');
        copyText('usuario-side-vencimiento','usuario-sheet-vencimiento');
        copyText('usuario-side-cuotas-vencidas','usuario-sheet-cuotas-vencidas');
        copyText('usuario-side-ultimo-pago','usuario-sheet-ultimo-pago');
        copyText('usuario-side-nombre','usuario-sheet-nombre');
        copyText('usuario-side-dni','usuario-sheet-dni');
        copyText('usuario-side-telefono','usuario-sheet-telefono');
        copyText('usuario-side-rol','usuario-sheet-rol');
        copyText('usuario-side-tipo-cuota','usuario-sheet-tipo-cuota');
        const idEl = document.getElementById('usuario-side-id'); const title = document.getElementById('usuario-sheet-title'); if(title){ const base = 'Ficha de Usuario'; title.textContent = idEl && idEl.textContent ? (base + ' ' + idEl.textContent) : base; }
      }catch(e){}
    }

    function openUsuarioSheet(){
      const u = state.selectedUsuario;
      if(!u || !u.id){ showToast('Selecciona un usuario primero', 'warning', 3500); return; }
      syncUsuarioSheetFromSide();
      try{ UI.openSideSheet('usuario-sheet'); } catch(_){ /* noop */ }
    }

    async function selectUsuarioByIndex(idx){
      const u = (state.usuarios || [])[idx];
      if(!u) return;
      state.selectedUsuario = u;
      const id = u.id || null;
      document.getElementById('usuario-side-empty').style.display = 'none';
      document.getElementById('usuario-side').style.display = 'block';
      document.getElementById('usuario-side-id').textContent = id ? `#${id}` : '';
      const btnQR = document.getElementById('usuario-side-qr'); if(btnQR) btnQR.disabled = false;
      const btnAsis = document.getElementById('usuario-side-asistencia'); if(btnAsis) btnAsis.disabled = false;
      const btnRutinaNew = document.getElementById('usuario-side-rutina-new'); if(btnRutinaNew) btnRutinaNew.disabled = false;
      const loader = document.getElementById('usuario-side-loader'); if(loader) loader.classList.add('active');
      try {
        const [detRes, histRes] = await Promise.all([
          id ? fetch(`/api/usuarios/${id}`, { headers: { 'Accept': 'application/json' } }) : Promise.resolve(null),
          id ? fetch(`/api/usuarios/${id}/pagos?limit=50&offset=0`, { headers: { 'Accept': 'application/json' } }) : Promise.resolve(null),
        ]);
        const det = detRes ? await detRes.json() : u;
        const histJson = histRes ? await histRes.json() : [];
        const historial = Array.isArray(histJson.items) ? histJson.items : (Array.isArray(histJson) ? histJson : []);
        state.usuarioHistorial = historial;
        // Asegurar tipos de cuota cargados para resolver nombre
        if(!Array.isArray(state.tiposCuotaActivos) || state.tiposCuotaActivos.length === 0){ await loadTiposCuotaActivos(); }
        try { await ensureTiposCuotaCatalogo(); } catch {}
        renderUsuarioSide(det || u, historial);
        if(id){ try { await loadUsuarioWhatsApp(id); } catch(_){} }
        if(id){ try { await loadUsuarioEtiquetas(id); await loadUsuarioEstados(id); } catch(_){} }
        let recent = '—';
        let hasHoy = false;
        if(id){
          try{
            const aRes = await fetch(`/api/usuario_asistencias?usuario_id=${id}&limit=200&offset=0`, { headers: { 'Accept': 'application/json' } });
            const aData = await aRes.json();
            const arr = Array.isArray(aData) ? aData : (Array.isArray(aData?.items) ? aData.items : []);
            state.usuarioAsistencias = arr;
            const now = new Date(); const start = new Date(now); start.setDate(now.getDate()-30);
            recent = arr.filter(a => { const d = new Date(a.fecha||''); return !isNaN(d.getTime()) && d >= start && d <= now; }).length;
            const todayStr = fmtDate(new Date());
            hasHoy = arr.some(a => { const f = a.fecha || a.fecha_asistencia || a.fechaAsistencia || ''; return fmtDate(f) === todayStr; });
          }catch(_){ state.usuarioAsistencias = []; }
        }
        const asEl = document.getElementById('usuario-side-asistencias-recientes'); if(asEl) asEl.textContent = recent === '—' ? '—' : String(recent);
        const asBtn = document.getElementById('usuario-side-asistencia'); if(asBtn) asBtn.textContent = hasHoy ? 'Eliminar asistencia de hoy' : 'Registrar asistencia';
        const utbody = document.querySelector('#usuarios-table tbody'); if(utbody){ utbody.querySelectorAll('tr').forEach(t => t.classList.remove('selected')); const tr = utbody.querySelector(`tr[data-index="${idx}"]`); if(tr) tr.classList.add('selected'); }
      } catch(e){
        console.warn('No se pudo cargar detalles/historial del usuario:', e);
        renderUsuarioSide(u, []);
      } finally { if(loader) loader.classList.remove('active'); }
    }

    function clearUsuarioSelection(){
      state.selectedUsuario = null;
      document.getElementById('usuario-side-id').textContent = '';
      document.getElementById('usuario-side').style.display = 'none';
      document.getElementById('usuario-side-empty').style.display = 'block';
      const btnQR = document.getElementById('usuario-side-qr'); if(btnQR) btnQR.disabled = true;
      const btnAsis = document.getElementById('usuario-side-asistencia'); if(btnAsis) btnAsis.disabled = true;
      const btnRutinaNew = document.getElementById('usuario-side-rutina-new'); if(btnRutinaNew) btnRutinaNew.disabled = true;
      const tbody = document.querySelector('#usuario-historial-table tbody');
      if(tbody) tbody.innerHTML = '';
      const wtbody = document.getElementById('usuario-wa-historial-body'); if(wtbody) wtbody.innerHTML = '';
      const wempty = document.getElementById('usuario-wa-historial-empty'); if(wempty) wempty.style.display = 'block';
      ['welcome','payment','deactivation','overdue','class_reminder'].forEach(t => {
        const stEl = document.getElementById(`usuario-wa-status-${t}`); if(stEl) stEl.textContent = '—';
        const dtEl = document.getElementById(`usuario-wa-date-${t}`); if(dtEl) dtEl.textContent = 'Fecha: —';
        const cardEl = document.getElementById(`usuario-wa-card-${t}`); const btn = cardEl ? cardEl.querySelector('button[data-type]') : null; if(btn) btn.disabled = false;
      });
    }

    function bindUsuariosEvents(){
      const tbody = document.querySelector('#usuarios-table tbody');
      tbody.addEventListener('click', (ev) => {
        const btn = ev.target.closest('button');
        if(btn){
          const id = btn.getAttribute('data-id');
          const action = btn.getAttribute('data-action');
          if(action === 'edit'){
            fetch(`/api/usuarios/${id}`, { headers:{ 'Accept':'application/json' } })
              .then(r => r.json())
              .then(u => showUserForm(u))
              .catch(() => showToast('No se pudo cargar el usuario', 'error', 4500));
          } else if(action === 'delete'){
            state.deleteUserId = id;
            openModal('modal-usuarios-delete');
          }
          return;
        }
        const tr = ev.target.closest('tr');
        if(!tr) return;
        const idx = parseInt(tr.getAttribute('data-index') || 'NaN', 10);
        if(isNaN(idx)) return;
        selectUsuarioByIndex(idx);
      });
      document.getElementById('usuarios-clear-selection').addEventListener('click', clearUsuarioSelection);
      document.getElementById('usuarios-refresh').addEventListener('click', loadUsers);
      document.getElementById('usuarios-q').addEventListener('keydown', (e) => { if(e.key === 'Enter') loadUsers(); });
      // Búsqueda con debounce para Usuarios
      try {
        const uq = document.getElementById('usuarios-q');
        if(uq){ uq.addEventListener('input', debounce(() => { loadUsers(); }, 300)); }
        const ul = document.getElementById('usuarios-limit');
        if(ul){ ul.addEventListener('change', () => { loadUsers(); }); }
      } catch(_){}
      document.getElementById('usuarios-new').addEventListener('click', () => showUserForm(null));
      document.getElementById('usuarios-save').addEventListener('click', saveUser);
      document.getElementById('usuarios-cancel').addEventListener('click', hideUserForm);
      document.getElementById('usuarios-modal-close').addEventListener('click', hideUserForm);
      const waCards = document.getElementById('usuario-wa-cards');
      if(waCards){ waCards.addEventListener('click', (ev) => { const btn = ev.target.closest('button[data-type]'); if(btn){ const type = btn.getAttribute('data-type'); forceSendWA(type); } }); }
      const waRefresh = document.getElementById('usuario-wa-refresh'); if(waRefresh){ waRefresh.addEventListener('click', () => { const u = state.selectedUsuario; if(u && u.id) loadUsuarioWhatsApp(u.id); }); }
      const waFilter = document.getElementById('usuario-wa-filter'); if(waFilter){ waFilter.addEventListener('change', () => renderUsuarioWAHistoryTable(state.usuarioWAHistorial || [])); }
      const waTbody = document.getElementById('usuario-wa-historial-body');
      if(waTbody){
        waTbody.addEventListener('click', async (ev) => {
          const btnDel = ev.target.closest('button[data-delete-id]');
          const btnRetry = ev.target.closest('button[data-retry]');
          const u = state.selectedUsuario;
          if(btnDel){
            const id = btnDel.getAttribute('data-delete-id');
            const mid = btnDel.getAttribute('data-delete-mid');
            if(!u || !u.id){ showToast('Selecciona un usuario', 'warning', 3800); return; }
            // Preparar preview
            const tr = btnDel.closest('tr');
            const fecha = tr ? (tr.dataset.fecha || '') : '';
            const tipo = tr ? (tr.dataset.tipo || '') : '';
            const estado = tr ? (tr.dataset.estado || '') : '';
            const contenido = tr ? (tr.dataset.contenido || '') : '';
            state.deleteWAMessage = { id: String(id||''), mid: String(mid||''), usuarioId: u.id, fecha, tipo, estado, contenido };
            const prev = document.getElementById('wa-delete-preview');
            if(prev){
              prev.innerHTML = `Fecha: ${fecha || '—'}<br>Tipo: ${tipo || '—'}<br>Estado: ${estado || '—'}<br>Contenido: ${contenido || ''}`;
            }
            openModal('modal-wa-delete');
            return;
          }
          if(btnRetry){
            const type = btnRetry.getAttribute('data-retry');
            forceSendWA(type);
            return;
          }
        });
      }
      // Eventos del modal de borrado WA
      const waClose = document.getElementById('wa-delete-close'); if(waClose){ waClose.addEventListener('click', () => closeModal('modal-wa-delete')); }
      const waCancel = document.getElementById('wa-delete-cancel'); if(waCancel){ waCancel.addEventListener('click', () => closeModal('modal-wa-delete')); }
      const waConfirm = document.getElementById('wa-delete-confirm');
      if(waConfirm){
        waConfirm.addEventListener('click', async () => {
          const payload = state.deleteWAMessage || {};
          state.deleteWAMessage = null;
          closeModal('modal-wa-delete');
          const u = state.selectedUsuario;
          if(!u || !u.id){ showToast('Selecciona un usuario', 'warning', 3800); return; }
          const id = String(payload.id||'');
          const mid = String(payload.mid||'');
          let url = '';
          if(mid){ url = `/api/usuarios/${u.id}/whatsapp/by-mid/${encodeURIComponent(mid)}`; }
          else if(id){ url = `/api/usuarios/${u.id}/whatsapp/${encodeURIComponent(id)}`; }
          else { showToast('Mensaje inválido para borrar', 'error', 4000); return; }
          try{
            const res = await fetch(url, { method:'DELETE', headers:{ 'Accept':'application/json' } });
            const data = await res.json().catch(()=>({}));
            if(!res.ok || data.success === false){
              const code = res.status;
              let msg = data?.detail || data?.error || data?.message || 'No se pudo borrar el mensaje';
              if(code === 401){ msg = 'Acceso restringido a dueño. Inicie sesión.'; try{ window.location.href = '/gestion/login'; }catch(e){} }
              else if(code === 403){ msg = 'No autorizado para borrar'; }
              else if(code === 404){ msg = 'Mensaje no encontrado'; }
              else if(code >= 500){ msg = 'Error del servidor al borrar mensaje'; }
              showToast(msg, 'error', 5000);
            } else {
              showToast('Mensaje borrado', 'success', 3000);
              try{ await loadUsuarioWhatsApp(u.id); }catch(_){}
              try{ await loadWALastForUser(u.id); }catch(_){}
            }
          }catch(e){ showToast('Error de red al borrar mensaje', 'error', 4500); }
        });
      }
      document.getElementById('usuarios-delete-close').addEventListener('click', () => closeModal('modal-usuarios-delete'));
      document.getElementById('usuarios-delete-cancel').addEventListener('click', () => closeModal('modal-usuarios-delete'));
      document.getElementById('usuarios-delete-confirm').addEventListener('click', async () => {
        const id = state.deleteUserId;
        state.deleteUserId = null;
        closeModal('modal-usuarios-delete');
        await deleteUser(id);
      });
      const editarQuick = document.getElementById('usuario-side-editar');
      if(editarQuick){ editarQuick.addEventListener('click', async () => { const u = state.selectedUsuario; if(!u || !u.id) return; try{ const res = await fetch(`/api/usuarios/${u.id}`, { headers:{ 'Accept':'application/json' } }); const full = await res.json().catch(()=>({})); if(full && full.id){ showUserForm(full); } else { showUserForm(u); } }catch(_){ showUserForm(u); } }); }
      const eliminarQuick = document.getElementById('usuario-side-eliminar');
      if(eliminarQuick){ eliminarQuick.addEventListener('click', () => { const u = state.selectedUsuario; if(!u || !u.id) return; state.deleteUserId = u.id; openModal('modal-usuarios-delete'); }); }
      const verPagosQuick = document.getElementById('usuario-side-ver-pagos');
      if(verPagosQuick) verPagosQuick.addEventListener('click', verPagosDeUsuario);
      const toggleActivoQuick = document.getElementById('usuario-side-toggle-activo');
      if(toggleActivoQuick) toggleActivoQuick.addEventListener('click', toggleUsuarioActivo);
      const exportUsuariosBtn = document.getElementById('usuarios-export-csv');
      if(exportUsuariosBtn) exportUsuariosBtn.addEventListener('click', exportUsuariosCSV);
      const qrBtn = document.getElementById('usuario-side-qr');
      if(qrBtn) qrBtn.addEventListener('click', emitirQRCheckin);
      const asisBtn = document.getElementById('usuario-side-asistencia');
      if(asisBtn) asisBtn.addEventListener('click', handleAsistenciaClick);
      const fichaBtn = document.getElementById('usuario-side-ficha');
      if(fichaBtn) fichaBtn.addEventListener('click', openUsuarioSheet);
      const rutinaNewBtn = document.getElementById('usuario-side-rutina-new');
      if(rutinaNewBtn){ rutinaNewBtn.addEventListener('click', () => { const u = state.selectedUsuario; if(!u || !u.id){ showToast('Selecciona un usuario primero', 'warning', 3000); return; } state.rutinaQuickAssignFlow = true; try{ openRutinaBuilderNew(); }catch(_){ state.rutinaQuickAssignFlow = false; } }); }
      const sheetRegistrar = document.getElementById('usuario-sheet-registrar');
      if(sheetRegistrar) sheetRegistrar.addEventListener('click', function(){ try{ hidePagoWizard(); }catch(_){} showPagoWizard(); });
      const sheetVerPagos = document.getElementById('usuario-sheet-ver-pagos');
      if(sheetVerPagos) sheetVerPagos.addEventListener('click', function(){ try{ const tab = document.querySelector('.tab[data-tab="pagos"], [data-tab="pagos"]'); if(tab){ tab.dispatchEvent(new MouseEvent('click', { bubbles:true })); } } catch(_){ } });
      const qrCloseBtn = document.getElementById('qr-close-btn');
      if(qrCloseBtn) qrCloseBtn.addEventListener('click', closeQRModal);
      const qrCloseFooter = document.getElementById('qr-close-footer');
      if(qrCloseFooter) qrCloseFooter.addEventListener('click', closeQRModal);
      // Acciones rápidas — WhatsApp eliminadas
      // Subpestañas y acciones de usuario
      const tabs = document.querySelectorAll('#usuario-tabs button');
      tabs.forEach(btn => btn.addEventListener('click', () => {
        const tab = btn.getAttribute('data-tab');
        try{ localStorage.setItem('usuario:subtab', tab); }catch(_){}
        document.querySelectorAll('#usuario-tabs button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('#usuario-tab-notas, #usuario-tab-etiquetas, #usuario-tab-estados').forEach(panel => {
          panel.style.display = panel.id === `usuario-tab-${tab}` ? 'block' : 'none';
        });
        if(tab === 'notas'){ document.getElementById('usuario-notas-textarea')?.focus(); }
        if(tab === 'etiquetas'){ document.getElementById('usuario-etiqueta-input')?.focus(); }
        if(tab === 'estados'){ document.getElementById('usuario-estado-template')?.focus(); }
      }));
      // Restaurar subtab Persistido
      try{
        const persistedSub = localStorage.getItem('usuario:subtab') || 'notas';
        const btnInit = document.querySelector(`#usuario-tabs button[data-tab="${persistedSub}"]`);
        if(btnInit){ btnInit.click(); }
      }catch(_){}
      document.addEventListener('keydown', (ev) => {
        if((ev.ctrlKey || ev.metaKey) && ev.key.toLowerCase() === 'f'){
          ev.preventDefault();
          const active = document.querySelector('#usuario-tabs button.active')?.getAttribute('data-tab');
          if(active === 'etiquetas'){ document.getElementById('usuario-etiqueta-filter')?.focus(); }
          else if(active === 'estados'){ document.getElementById('usuario-estados-filter')?.focus(); }
          else { document.getElementById('usuario-notas-textarea')?.focus(); }
        }
      });
      const notasSave = document.getElementById('usuario-notas-save');
      if(notasSave){ notasSave.addEventListener('click', saveUsuarioNotas); }
      const notasTextarea = document.getElementById('usuario-notas-textarea');
      const notasCounter = document.getElementById('usuario-notas-counter');
      const notasStatus = document.getElementById('usuario-notas-status');
      if(notasTextarea){
        const updateCounter = () => { if(notasCounter) notasCounter.textContent = `${notasTextarea.value.length} caracteres`; };
        updateCounter();
        let notasSaveTimer = null;
        notasTextarea.addEventListener('input', () => {
          updateCounter();
          if(notasStatus) notasStatus.textContent = 'Editado';
          if(notasSaveTimer) clearTimeout(notasSaveTimer);
          notasSaveTimer = setTimeout(() => { try { saveUsuarioNotas(); } catch(_){} }, 1200);
        });
        notasTextarea.addEventListener('keydown', (ev) => {
          if((ev.ctrlKey || ev.metaKey) && ev.key.toLowerCase() === 's'){
            ev.preventDefault();
            if(notasSaveTimer) clearTimeout(notasSaveTimer);
            saveUsuarioNotas();
          }
        });
      }
      const etiquetaAdd = document.getElementById('usuario-etiqueta-add');
      if(etiquetaAdd){ etiquetaAdd.addEventListener('click', addUsuarioEtiqueta); }
      const etiquetaInput = document.getElementById('usuario-etiqueta-input');
      const etiquetaFilter = document.getElementById('usuario-etiqueta-filter');
      const etiquetaSuggests = document.getElementById('usuario-etiqueta-suggests');
      if(etiquetaInput){
        etiquetaInput.addEventListener('keydown', (ev) => { if(ev.key === 'Enter'){ ev.preventDefault(); addUsuarioEtiqueta(); } });
        etiquetaInput.addEventListener('input', () => { renderEtiquetaSuggests(etiquetaInput.value); });
      }
      if(etiquetaFilter){
        etiquetaFilter.addEventListener('input', renderUsuarioEtiquetas);
        etiquetaFilter.addEventListener('keydown', (ev) => { if(ev.key==='Escape'){ ev.preventDefault(); etiquetaFilter.value=''; renderUsuarioEtiquetas(); } });
      }
      const etiquetaFilterClear = document.getElementById('usuario-etiqueta-filter-clear');
      if(etiquetaFilterClear){ etiquetaFilterClear.addEventListener('click', () => { if(etiquetaFilter) etiquetaFilter.value=''; renderUsuarioEtiquetas(); }); }
      if(etiquetaSuggests){
        etiquetaSuggests.addEventListener('click', (ev) => {
          const chip = ev.target.closest('.chip[data-suggest]');
          if(!chip) return;
          const name = chip.getAttribute('data-suggest');
          const inp = document.getElementById('usuario-etiqueta-input');
          if(inp) inp.value = name;
          addUsuarioEtiqueta();
        });
      }
      const etiquetasList = document.getElementById('usuario-etiquetas-list');
      if(etiquetasList){
        etiquetasList.addEventListener('click', (ev) => {
          const btn = ev.target.closest('button[data-action="remove"]');
          if(!btn) return;
          const eid = parseInt(btn.getAttribute('data-id')||'NaN',10);
          const u = state.selectedUsuario; if(!u || !u.id || isNaN(eid)) return;
          if(!confirm('¿Quitar etiqueta?')) return;
          removeUsuarioEtiqueta(u.id, eid);
        });
      }
      const estadoAdd = document.getElementById('usuario-estado-add');
      if(estadoAdd){ estadoAdd.addEventListener('click', addUsuarioEstado); }
      const estadoDesc = document.getElementById('usuario-estado-descripcion');
      const estadoVenc = document.getElementById('usuario-estado-vencimiento');
      if(estadoDesc){ estadoDesc.addEventListener('keydown', (ev) => { if(ev.key==='Enter'){ ev.preventDefault(); addUsuarioEstado(); } }); }
      if(estadoVenc){ estadoVenc.addEventListener('keydown', (ev) => { if(ev.key==='Enter'){ ev.preventDefault(); addUsuarioEstado(); } }); }
      const estadosList = document.getElementById('usuario-estados-list');
      if(estadosList){
        estadosList.addEventListener('click', (ev) => {
          const btn = ev.target.closest('button[data-action="remove"]');
          if(!btn) return;
          const sid = parseInt(btn.getAttribute('data-id')||'NaN',10);
          const u = state.selectedUsuario; if(!u || !u.id || isNaN(sid)) return;
          if(!confirm('¿Eliminar estado?')) return;
          deleteUsuarioEstado(u.id, sid);
        });
      }
      const estadosFilter = document.getElementById('usuario-estados-filter');
      const estadosExpiredToggle = document.getElementById('usuario-estados-show-expired');
      if(estadosFilter){
        estadosFilter.addEventListener('input', renderUsuarioEstados);
        estadosFilter.addEventListener('keydown', (ev) => { if(ev.key==='Escape'){ ev.preventDefault(); estadosFilter.value=''; renderUsuarioEstados(); } });
      }
      const estadosFilterClear = document.getElementById('usuario-estados-filter-clear');
      if(estadosFilterClear){ estadosFilterClear.addEventListener('click', () => { if(estadosFilter) estadosFilter.value=''; renderUsuarioEstados(); }); }
      if(estadosExpiredToggle){ estadosExpiredToggle.addEventListener('change', renderUsuarioEstados); }
    }

    function verPagosDeUsuario(){
      const u = state.selectedUsuario;
      if(!u){ showToast('Selecciona un usuario primero', 'warning', 4000); return; }
      const dni = String(u.dni || '').trim();
      switchTab('pagos');
      try { populatePagosUsuarioSelector(); } catch {}
      const sel = document.getElementById('pagos-usuario');
      if(sel) sel.value = String(u.id);
      const input = document.getElementById('pagos-q');
      if(input) input.value = dni || (u.nombre || '');
      state.pagosFilters.metodo = '';
      state.pagosFilters.concepto = '';
      loadPayments();
    }

    function toggleUsuarioActivo(){
      const u = state.selectedUsuario;
      if(!u || !u.id){ showToast('Selecciona un usuario válido', 'warning', 3500); return; }
      const nombre = (document.getElementById('usuario-side-nombre').textContent || '').trim().toUpperCase();
      const dni = (document.getElementById('usuario-side-dni').textContent || '').trim();
      const telefono = (document.getElementById('usuario-side-telefono').textContent || '').trim();
      const rol = (document.getElementById('usuario-side-rol').textContent || '').trim().toLowerCase() || 'socio';
      const tipo_cuota_text = (document.getElementById('usuario-side-tipo-cuota').textContent || '').trim();
      const tipo_cuota = tipo_cuota_text || null;
      const notasText = (document.getElementById('usuario-notas-textarea')?.value || '').trim();
      const notas = notasText ? notasText : null;
      if(!nombre || !dni){ showToast('Nombre y DNI son obligatorios', 'warning', 3000); return; }
      const nuevoActivo = !(u.activo === true || u.activo === 'true');
      const payload = { nombre, dni, telefono: telefono || null, rol, activo: nuevoActivo, tipo_cuota, notas };
      fetch(`/api/usuarios/${u.id}`, { method:'PUT', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(payload) })
        .then(async res => { if(!res.ok){ const err = await res.json().catch(() => ({})); throw new Error(err.detail || err.error || `Error ${res.status}`); } return res; })
        .then(async () => { await loadUsers(); const idx = (state.usuarios || []).findIndex(x => x.id === u.id); if(idx >= 0) selectUsuarioByIndex(idx); })
        .catch(e => showToast(`No se pudo actualizar estado: ${e.message}`, 'error', 4500));
    }

    function exportUsuariosCSV(){
      const items = Array.isArray(state.usuarios) ? state.usuarios : [];
      const headers = ['Nombre','DNI','Teléfono','Rol','TipoCuota','Activo'];
      const rows = items.map(u => [
        String(u.nombre || '').trim(),
        String(u.dni || ''),
        String(u.telefono || ''),
        String((u.rol || '').toString().toLowerCase()),
        String(u.tipo_cuota ?? ''),
        String((u.activo === true || u.activo === 'true') ? 'SI' : 'NO')
      ]);
      const csv = [headers.join(','), ...rows.map(cols => cols.map(v => {
        const s = String(v ?? '');
        return /[",\n]/.test(s) ? '"' + s.replace(/"/g,'""') + '"' : s;
      }).join(','))].join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'usuarios.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // --- Subpestañas Usuarios: Notas, Etiquetas y Estados ---
    async function loadUsuarioEtiquetas(usuario_id){
      const cont = document.getElementById('usuario-etiquetas-list');
      const empty = document.getElementById('usuario-etiquetas-empty');
      if(cont) cont.innerHTML = '';
      try{
        const res = await fetch(`/api/usuarios/${usuario_id}/etiquetas`, { headers:{ 'Accept':'application/json' } });
        const data = await res.json();
        const items = Array.isArray(data.items) ? data.items : (Array.isArray(data) ? data : []);
        state.usuarioEtiquetas = items;
        const names = items.map(e => String(e.nombre || '').trim()).filter(Boolean);
        state.tagsSuggest = Array.from(new Set([...(state.tagsSuggest || []), ...names]));
        renderUsuarioEtiquetas();
        if(empty) empty.style.display = items.length ? 'none' : 'block';
      }catch(e){ /* silencioso */ }
    }
    function renderUsuarioEtiquetas(){
      const cont = document.getElementById('usuario-etiquetas-list'); if(!cont) return;
      const qRaw = (document.getElementById('usuario-etiqueta-filter')?.value || '').trim();
      const q = qRaw.toLowerCase();
      const esc = (s) => s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
      const hl = (text, q) => {
        if(!q) return esc(text);
        const idx = text.toLowerCase().indexOf(q.toLowerCase());
        if(idx === -1) return esc(text);
        const before = esc(text.slice(0, idx));
        const match = esc(text.slice(idx, idx + q.length));
        const after = esc(text.slice(idx + q.length));
        return `${before}<span class="hl">${match}</span>${after}`;
      };
      cont.innerHTML = '';
      (state.usuarioEtiquetas || []).forEach(e => {
        const name = String(e.nombre || '').trim();
        if(q && !name.toLowerCase().includes(q)) return;
        const span = document.createElement('span');
        span.className = 'chip';
        if(e.color) span.style.backgroundColor = e.color;
        const nameHTML = hl(name, qRaw);
        span.innerHTML = `${nameHTML}<button class="chip-remove" data-action="remove" data-id="${e.id}" title="Quitar">×</button>`;
        cont.appendChild(span);
      });
    }
    function renderEtiquetaSuggests(prefix){
      const cont = document.getElementById('usuario-etiqueta-suggests'); if(!cont) return;
      const list = (state.tagsSuggest || []).filter(n => n && (!prefix || n.toLowerCase().startsWith(prefix.toLowerCase())));
      cont.innerHTML = list.slice(0,8).map(n => `<span class="chip" data-suggest="${n}">${n}</span>`).join('');
      cont.style.display = list.length ? 'flex' : 'none';
    }
    async function removeUsuarioEtiqueta(usuario_id, etiqueta_id){
      try{
        const res = await fetch(`/api/usuarios/${usuario_id}/etiquetas/${etiqueta_id}`, { method:'DELETE', headers:{ 'Accept':'application/json' } });
        if(!res.ok){ const err = await res.json().catch(()=>({})); showToast(err.detail || err.error || 'No se pudo quitar la etiqueta', 'error', 4500); return; }
        await res.json().catch(()=>null);
        await loadUsuarioEtiquetas(usuario_id);
      }catch(e){ showToast('Error de red al quitar etiqueta', 'error', 4500); }
    }
    async function addUsuarioEtiqueta(){
      const u = state.selectedUsuario;
      if(!u || !u.id){ showToast('Selecciona un usuario válido', 'warning', 3500); return; }
      const nombre = (document.getElementById('usuario-etiqueta-input').value || '').trim();
      if(!nombre){ showToast('Ingrese el nombre de la etiqueta', 'warning', 3000); return; }
      try{
        const res = await fetch(`/api/usuarios/${u.id}/etiquetas`, { method:'POST', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify({ nombre }) });
        if(!res.ok){ const err = await res.json().catch(()=>({})); showToast(err.detail || err.error || 'No se pudo añadir la etiqueta', 'error', 4500); return; }
        await res.json().catch(()=>null);
        document.getElementById('usuario-etiqueta-input').value = '';
        await loadUsuarioEtiquetas(u.id);
      }catch(e){ showToast('Error de red al añadir etiqueta', 'error', 4500); }
    }

    async function loadEstadoPlantillas(){
      const sel = document.getElementById('usuario-estado-template');
      if(!sel) return;
      try{
        const res = await fetch('/api/estados/plantillas', { headers:{ 'Accept':'application/json' } });
        const data = await res.json().catch(() => ({}));
        const items = Array.isArray(data.items) ? data.items : (Array.isArray(data) ? data : []);
        state.estadoPlantillas = items;
        state.estadoPlantillasMap = {};
        items.forEach(p => { if(p && p.nombre) state.estadoPlantillasMap[p.nombre] = p; });
        sel.innerHTML = '<option value="">Seleccione estado…</option>' + items.map(p => `<option value="${p.nombre}">${p.nombre}</option>`).join('');
      }catch(e){ sel.innerHTML = '<option value="">Seleccione estado…</option>'; }
    }
    async function loadUsuarioEstados(usuario_id){
      const cont = document.getElementById('usuario-estados-list');
      const empty = document.getElementById('usuario-estados-empty');
      if(cont) cont.innerHTML = '';
      try{
        const res = await fetch(`/api/usuarios/${usuario_id}/estados`, { headers:{ 'Accept':'application/json' } });
        const data = await res.json();
        const items = Array.isArray(data.items) ? data.items : (Array.isArray(data) ? data : []);
        state.usuarioEstados = items;
        renderUsuarioEstados();
        if(empty) empty.style.display = items.length ? 'none' : 'block';
      }catch(e){ /* silencioso */ }
    }
    function renderUsuarioEstados(){
      const cont = document.getElementById('usuario-estados-list'); if(!cont) return;
      const qRaw = (document.getElementById('usuario-estados-filter')?.value || '').trim();
      const q = qRaw.toLowerCase();
      const showExpired = !!(document.getElementById('usuario-estados-show-expired')?.checked);
      const esc = (s) => s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
      const hl = (text, q) => {
        if(!q) return esc(text);
        const idx = text.toLowerCase().indexOf(q.toLowerCase());
        if(idx === -1) return esc(text);
        const before = esc(text.slice(0, idx));
        const match = esc(text.slice(idx, idx + q.length));
        const after = esc(text.slice(idx + q.length));
        return `${before}<span class="hl">${match}</span>${after}`;
      };
      cont.innerHTML = '';
      (state.usuarioEstados || []).forEach(s => {
        const nombre = String(s.estado || s.nombre || '').trim();
        const desc = String(s.descripcion || '').trim();
        const match = !q || nombre.toLowerCase().includes(q) || desc.toLowerCase().includes(q);
        let expired = false; let meta = '';
        if(s.fecha_vencimiento){
          try{
            const dt = new Date(s.fecha_vencimiento);
            const today = new Date();
            dt.setHours(0,0,0,0); today.setHours(0,0,0,0);
            const diffDays = Math.floor((dt - today)/86400000);
            if(diffDays < 0){ expired = true; meta = `Vencido hace ${Math.abs(diffDays)}d`; }
            else if(diffDays === 0){ meta = 'Vence hoy'; }
            else { meta = `Vence en ${diffDays}d`; }
          }catch{}
        }
        if(!match || (!showExpired && expired)) return;
        const div = document.createElement('div');
        div.className = 'state-item' + (expired ? ' expired' : '');
        const venc = s.fecha_vencimiento ? fmtDate(s.fecha_vencimiento) : '';
        const tpl = state.estadoPlantillasMap ? state.estadoPlantillasMap[nombre] : null;
        const color = tpl && tpl.color ? tpl.color : '';
        const nombreHTML = hl(nombre, qRaw);
        const descHTML = desc ? hl(desc, qRaw) : '';
        div.innerHTML = `<div class="left"><span class="state-dot" style="${color ? `background:${color}` : ''}"></span><span class="state-name">${nombreHTML}</span>${desc ? ` — <span class="state-desc">${descHTML}</span>`:''}${venc ? ` — <span class="state-date">${venc}</span>`:''}${meta ? ` <span class="state-meta">(${meta})</span>`:''}</div> <button class="btn small secondary" data-action="remove" data-id="${s.id}">Eliminar</button>`;
        cont.appendChild(div);
      });
    }
    async function deleteUsuarioEstado(usuario_id, estado_id){
      try{
        const res = await fetch(`/api/usuarios/${usuario_id}/estados/${estado_id}`, { method:'DELETE', headers:{ 'Accept':'application/json' } });
        if(!res.ok){ const err = await res.json().catch(()=>({})); showToast(err.detail || err.error || 'No se pudo eliminar el estado', 'error', 4500); return; }
        await res.json().catch(()=>null);
        await loadUsuarioEstados(usuario_id);
      }catch(e){ showToast('Error de red al eliminar estado', 'error', 4500); }
    }
    async function addUsuarioEstado(){
      const u = state.selectedUsuario;
      if(!u || !u.id){ showToast('Selecciona un usuario válido', 'warning', 3500); return; }
      const nombre = (document.getElementById('usuario-estado-template').value || '').trim();
      const descripcion = (document.getElementById('usuario-estado-descripcion').value || '').trim();
      const venc = (document.getElementById('usuario-estado-vencimiento').value || '').trim();
      if(!nombre){ showToast('Seleccione un estado', 'warning', 3000); return; }
      const body = { estado: nombre, descripcion: descripcion || null, fecha_vencimiento: venc || null };
      try{
        const res = await fetch(`/api/usuarios/${u.id}/estados`, { method:'POST', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(body) });
        if(!res.ok){ const err = await res.json().catch(()=>({})); showToast(err.detail || err.error || 'No se pudo añadir el estado', 'error', 4500); return; }
        await res.json().catch(()=>null);
        document.getElementById('usuario-estado-descripcion').value = '';
        document.getElementById('usuario-estado-vencimiento').value = '';
        await loadUsuarioEstados(u.id);
      }catch(e){ showToast('Error de red al añadir estado', 'error', 4500); }
    }
    function saveUsuarioNotas(){
      const u = state.selectedUsuario;
      if(!u || !u.id){ showToast('Selecciona un usuario válido', 'warning', 3500); return; }
      const nombre = (document.getElementById('usuario-side-nombre').textContent || '').trim().toUpperCase();
      const dni = (document.getElementById('usuario-side-dni').textContent || '').trim();
      const telefono = (document.getElementById('usuario-side-telefono').textContent || '').trim();
      const rol = (document.getElementById('usuario-side-rol').textContent || '').trim().toLowerCase() || 'socio';
      const tipo_cuota_text = (document.getElementById('usuario-side-tipo-cuota').textContent || '').trim();
      const tipo_cuota = tipo_cuota_text || null;
      const notasText = (document.getElementById('usuario-notas-textarea')?.value || '').trim();
      const notas = notasText ? notasText : null;
      const activo = (u.activo === true || u.activo === 'true');
      if(!nombre || !dni){ showToast('Nombre y DNI son obligatorios', 'warning', 3000); return; }
      const payload = { nombre, dni, telefono: telefono || null, rol, activo, tipo_cuota, notas };
      const st = document.getElementById('usuario-notas-status'); if(st) st.textContent = 'Guardando…';
      fetch(`/api/usuarios/${u.id}`, { method:'PUT', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(payload) })
        .then(async res => { if(!res.ok){ const err = await res.json().catch(() => ({})); throw new Error(err.detail || err.error || `Error ${res.status}`); } return res; })
        .then(async () => { await loadUsers(); const idx = (state.usuarios || []).findIndex(x => x.id === u.id); if(idx >= 0) selectUsuarioByIndex(idx); showToast('Notas guardadas', 'success', 2500); const st2 = document.getElementById('usuario-notas-status'); if(st2) st2.textContent = 'Guardado'; })
        .catch(e => { showToast(`No se pudo guardar notas: ${e.message}`, 'error', 4500); const st2 = document.getElementById('usuario-notas-status'); if(st2) st2.textContent = 'Error'; });
    }

    // ===== Configuración: Tipos de cuota, Conceptos y Métodos =====
    async function loadTiposCuotaAdmin(){
      try{
        const res = await fetch('/api/tipos_cuota_catalogo', { headers:{ 'Accept':'application/json' } });
        const data = await res.json();
        const rows = Array.isArray(data.items) ? data.items : (Array.isArray(data) ? data : []);
        state.configTipos = rows;
        state.configTiposMap = Object.fromEntries(rows.map(t => [String(t.id ?? t.nombre ?? ''), t]));
        renderTiposCuotaTable(rows);
      }catch(e){ console.warn('No se pudieron cargar tipos de cuota:', e); }
    }
    function renderTiposCuotaTable(rows){
      const tbody = document.querySelector('#config-tipos-table tbody');
      if(!tbody) return;
      tbody.innerHTML = '';
      (Array.isArray(rows) ? rows : []).forEach((t) => {
        const tr = document.createElement('tr');
        tr.setAttribute('data-id', String(t.id ?? ''));
        const isActivo = (t.activo === true || t.activo === 'true');
        const roleEl = document.getElementById('login-current');
        const isOwner = (roleEl && (roleEl.getAttribute('data-role') || '').trim()) === 'dueño';
        const actionsHTML = isOwner
          ? `<button class="btn neutral" data-action="edit-tipo" data-id="${t.id ?? ''}">Editar</button>
             <button class="btn warning" data-action="toggle-tipo-activo" data-id="${t.id ?? ''}">${isActivo ? 'Desactivar' : 'Activar'}</button>
             <button class="btn danger" data-action="delete-tipo" data-id="${t.id ?? ''}">Borrar</button>`
          : `<span class="muted">Solo dueño</span>`;
        tr.innerHTML = `
          <td>${t.nombre ?? ''}</td>
          <td>${t.precio != null ? t.precio : ''}</td>
          <td>${t.duracion_dias != null ? t.duracion_dias : ''}</td>
          <td>${isActivo ? 'Sí' : 'No'}</td>
          <td class="table-actions">${actionsHTML}</td>`;
        tbody.appendChild(tr);
      });
    }
    function showTipoForm(t){
      state.editingTipoId = t && t.id ? t.id : null;
      document.getElementById('modal-tipo-cuota-title').textContent = t && t.id ? `Editar tipo #${t.id}` : 'Nuevo tipo de cuota';
      const nombre = document.getElementById('tipo-nombre'); if(nombre) nombre.value = t?.nombre ?? '';
      const precio = document.getElementById('tipo-precio'); if(precio) precio.value = t?.precio ?? '';
      const dur = document.getElementById('tipo-duracion'); if(dur) dur.value = t?.duracion_dias ?? '';
      const activo = document.getElementById('tipo-activo'); if(activo) activo.value = (t && (t.activo === true || t.activo === 'true')) ? 'true' : 'false';
      const desc = document.getElementById('tipo-descripcion'); if(desc) desc.value = t?.descripcion ?? '';
      const icono = document.getElementById('tipo-icono'); if(icono) icono.value = t?.icono_path ?? '';
      openModal('modal-tipo-cuota');
    }
    function hideTipoForm(){ state.editingTipoId = null; closeModal('modal-tipo-cuota'); }
    async function saveTipoCuota(){
      const nombre = (document.getElementById('tipo-nombre').value || '').trim();
      const precio = Number(document.getElementById('tipo-precio').value || '0');
      const duracion_dias = Number(document.getElementById('tipo-duracion').value || '0');
      const activoVal = document.getElementById('tipo-activo').value || 'true';
      const activo = (String(activoVal).toLowerCase() === 'true');
      const descripcion = (document.getElementById('tipo-descripcion').value || '').trim() || null;
      const icono_path = (document.getElementById('tipo-icono').value || '').trim() || null;
      if(!nombre){ showToast('El nombre es obligatorio', 'warning', 3000); return; }
      if(!(duracion_dias > 0)){ showToast('Duración debe ser mayor a 0', 'warning', 3000); return; }
      if(precio < 0){ showToast('Precio no puede ser negativo', 'warning', 3000); return; }
      let url = '/api/tipos_cuota'; let method = 'POST';
      const body = { nombre, precio, duracion_dias, activo, descripcion, icono_path };
      if(state.editingTipoId){ url = `/api/tipos_cuota/${state.editingTipoId}`; method = 'PUT'; }
      try{
        const res = await fetch(url, { method, headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(body) });
        if(!res.ok){ const err = await res.json().catch(()=>({})); showToast(err.detail || err.error || 'Error al guardar el tipo', 'error', 4500); return; }
        await res.json().catch(()=>null);
        hideTipoForm();
        showToast('Tipo de cuota guardado', 'success', 2500);
        await loadTiposCuotaAdmin();
      }catch(e){ showToast('Error de red al guardar tipo', 'error', 4500); }
    }

    async function deleteTipoCuota(id){
      if(!id) return;
      const conf = confirm('¿Eliminar tipo de cuota?'); if(!conf) return;
      try{
        const res = await fetch(`/api/tipos_cuota/${id}`, { method:'DELETE', headers:{ 'Accept':'application/json' } });
        if(!res.ok){ const err = await res.json().catch(()=>({})); showToast(err.detail || err.error || 'No se pudo eliminar', 'error', 4500); return; }
        await res.json().catch(()=>null);
        showToast('Tipo de cuota eliminado', 'success', 2500);
        await loadTiposCuotaAdmin();
      }catch(e){ showToast('Error de red al eliminar tipo', 'error', 4500); }
    }

    async function toggleTipoActivo(id){
      if(!id) return;
      const t = (state.configTipos || []).find(x => String(x.id) === String(id));
      if(!t){ showToast('Tipo no encontrado', 'warning', 3000); return; }
      const body = {
        nombre: t.nombre ?? '',
        precio: t.precio ?? 0,
        duracion_dias: t.duracion_dias ?? 0,
        activo: !(t.activo === true || t.activo === 'true'),
        descripcion: t.descripcion ?? null,
        icono_path: t.icono_path ?? null,
      };
      try{
        const res = await fetch(`/api/tipos_cuota/${id}`, { method:'PUT', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(body) });
        if(!res.ok){ const err = await res.json().catch(()=>({})); showToast(err.detail || err.error || 'No se pudo actualizar', 'error', 4500); return; }
        await res.json().catch(()=>null);
        showToast(body.activo ? 'Tipo activado' : 'Tipo desactivado', 'success', 2500);
        await loadTiposCuotaAdmin();
      }catch(e){ showToast('Error de red al actualizar tipo', 'error', 4500); }
    }

    async function loadConceptosAdmin(){
      try{
        const res = await fetch('/api/conceptos_pago', { headers:{ 'Accept':'application/json' } });
        const data = await res.json();
        const rows = Array.isArray(data.items) ? data.items : (Array.isArray(data) ? data : []);
        state.configConceptos = rows;
        renderConceptosTable(rows);
      }catch(e){ console.warn('No se pudieron cargar conceptos:', e); }
    }
    function renderConceptosTable(rows){
      const tbody = document.querySelector('#config-conceptos-table tbody'); if(!tbody) return;
      tbody.innerHTML = '';
      (Array.isArray(rows) ? rows : []).forEach(c => {
        const tr = document.createElement('tr');
        tr.setAttribute('data-id', String(c.id ?? ''));
        const isActivo = (c.activo === true || c.activo === 'true');
        const isDefaultMonthly = (String(c.nombre || '').trim().toLowerCase() === 'cuota mensual');
        const roleEl = document.getElementById('login-current');
        const isOwner = (roleEl && (roleEl.getAttribute('data-role') || '').trim()) === 'dueño';
        const actionsHTML = isOwner
          ? `<button class="btn neutral" data-action="edit-concepto" data-id="${c.id ?? ''}">Editar</button>
             <button class="btn warning" data-action="toggle-concepto-activo" data-id="${c.id ?? ''}">${isActivo ? 'Desactivar' : 'Activar'}</button>
             ${isDefaultMonthly ? '' : `<button class="btn danger" data-action="delete-concepto" data-id="${c.id ?? ''}">Borrar</button>`}`
          : `<span class="muted">Solo dueño</span>`;
        tr.innerHTML = `
          <td>${c.nombre ?? ''}</td>
          <td>${c.precio_base != null ? c.precio_base : ''}</td>
          <td>${c.tipo ?? ''}</td>
          <td>${isActivo ? 'Sí' : 'No'}</td>
          <td>${c.categoria ?? ''}</td>
          <td class="table-actions">
            ${actionsHTML}
          </td>`;
        tbody.appendChild(tr);
      });
    }
    function showConceptoForm(c){
      state.editingConceptoId = c && c.id ? c.id : null;
      document.getElementById('modal-concepto-title').textContent = c && c.id ? `Editar concepto #${c.id}` : 'Nuevo concepto de pago';
      const nombre = document.getElementById('concepto-nombre'); if(nombre) nombre.value = c?.nombre ?? '';
      const precio = document.getElementById('concepto-precio-base'); if(precio) precio.value = c?.precio_base ?? '';
      const tipo = document.getElementById('concepto-tipo'); if(tipo) tipo.value = c?.tipo ?? '';
      const activo = document.getElementById('concepto-activo'); if(activo) activo.value = (c && (c.activo === true || c.activo === 'true')) ? 'true' : 'false';
      const cat = document.getElementById('concepto-categoria'); if(cat) cat.value = c?.categoria ?? '';
      const desc = document.getElementById('concepto-descripcion'); if(desc) desc.value = c?.descripcion ?? '';
      openModal('modal-concepto');
    }
    function hideConceptoForm(){ state.editingConceptoId = null; closeModal('modal-concepto'); }
    async function saveConcepto(){
      const nombre = (document.getElementById('concepto-nombre').value || '').trim();
      const precio_base = Number(document.getElementById('concepto-precio-base').value || '0');
      const tipo = (document.getElementById('concepto-tipo').value || '').trim();
      const activoVal = document.getElementById('concepto-activo').value || 'true';
      const activo = (String(activoVal).toLowerCase() === 'true');
      const categoria = (document.getElementById('concepto-categoria').value || '').trim() || null;
      const descripcion = (document.getElementById('concepto-descripcion').value || '').trim() || null;
      if(!nombre){ showToast('El nombre es obligatorio', 'warning', 3000); return; }
      if(precio_base < 0){ showToast('Precio base no puede ser negativo', 'warning', 3000); return; }
      const body = { nombre, precio_base, tipo, activo, categoria, descripcion };
      let url = '/api/conceptos_pago'; let method = 'POST';
      if(state.editingConceptoId){ url = `/api/conceptos_pago/${state.editingConceptoId}`; method = 'PUT'; }
      try{
        const res = await fetch(url, { method, headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(body) });
        if(!res.ok){ const err = await res.json().catch(()=>({})); showToast(err.detail || err.error || 'Error al guardar concepto', 'error', 4500); return; }
        await res.json().catch(()=>null);
        hideConceptoForm();
        showToast('Concepto guardado', 'success', 2500);
        await loadConceptosAdmin();
      }catch(e){ showToast('Error de red al guardar concepto', 'error', 4500); }
    }
    async function deleteConcepto(id){
      if(!id) return;
      const c = (state.configConceptos || []).find(x => String(x.id) === String(id));
      const isDefaultMonthly = c && String(c.nombre || '').trim().toLowerCase() === 'cuota mensual';
      if(isDefaultMonthly){
        showToast('No se puede eliminar el concepto "Cuota Mensual"', 'warning', 3500);
        return;
      }
      const conf = confirm('¿Eliminar concepto de pago?'); if(!conf) return;
      try{
        const res = await fetch(`/api/conceptos_pago/${id}`, { method:'DELETE', headers:{ 'Accept':'application/json' } });
        if(!res.ok){ const err = await res.json().catch(()=>({})); showToast(err.detail || err.error || 'No se pudo eliminar', 'error', 4500); return; }
        await res.json().catch(()=>null);
        showToast('Concepto eliminado', 'success', 2500);
        await loadConceptosAdmin();
      }catch(e){ showToast('Error de red al eliminar concepto', 'error', 4500); }
    }

    async function toggleConceptoActivo(id){
      if(!id) return;
      const c = (state.configConceptos || []).find(x => String(x.id) === String(id));
      if(!c){ showToast('Concepto no encontrado', 'warning', 3000); return; }
      const body = {
        nombre: c.nombre ?? '',
        precio_base: c.precio_base ?? 0,
        tipo: c.tipo ?? '',
        activo: !(c.activo === true || c.activo === 'true'),
        categoria: c.categoria ?? null,
        descripcion: c.descripcion ?? null,
      };
      try{
        const res = await fetch(`/api/conceptos_pago/${id}`, { method:'PUT', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(body) });
        if(!res.ok){ const err = await res.json().catch(()=>({})); showToast(err.detail || err.error || 'No se pudo actualizar', 'error', 4500); return; }
        await res.json().catch(()=>null);
        showToast(body.activo ? 'Concepto activado' : 'Concepto desactivado', 'success', 2500);
        await loadConceptosAdmin();
      }catch(e){ showToast('Error de red al actualizar concepto', 'error', 4500); }
    }

    async function loadMetodosAdmin(){
      try{
        const res = await fetch('/api/metodos_pago', { headers:{ 'Accept':'application/json' } });
        const data = await res.json();
        const rows = Array.isArray(data.items) ? data.items : (Array.isArray(data) ? data : []);
        state.configMetodos = rows;
        renderMetodosTable(rows);
      }catch(e){ console.warn('No se pudieron cargar métodos:', e); }
    }
    function renderMetodosTable(rows){
      const tbody = document.querySelector('#config-metodos-table tbody'); if(!tbody) return;
      tbody.innerHTML = '';
      (Array.isArray(rows) ? rows : []).forEach(m => {
        const tr = document.createElement('tr');
        const colorBadge = m.color ? `<span style=\"background:${m.color};display:inline-block;width:12px;height:12px;border-radius:3px;\"></span>` : '';
        tr.setAttribute('data-id', String(m.id ?? ''));
        const isActivo = (m.activo === true || m.activo === 'true');
        tr.innerHTML = `
          <td>${m.nombre ?? ''}</td>
          <td>${m.comision != null ? m.comision : ''}</td>
          <td>${m.color ?? ''} ${colorBadge}</td>
          <td>${isActivo ? 'Sí' : 'No'}</td>
          <td class="table-actions">
            <button class="btn neutral" data-action="edit-metodo" data-id="${m.id ?? ''}">Editar</button>
            <button class="btn warning" data-action="toggle-metodo-activo" data-id="${m.id ?? ''}">${isActivo ? 'Desactivar' : 'Activar'}</button>
            <button class="btn danger" data-action="delete-metodo" data-id="${m.id ?? ''}">Borrar</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }
    function showMetodoForm(m){
      state.editingMetodoId = m && m.id ? m.id : null;
      document.getElementById('modal-metodo-title').textContent = m && m.id ? `Editar método #${m.id}` : 'Nuevo método de pago';
      const nombre = document.getElementById('metodo-nombre'); if(nombre) nombre.value = m?.nombre ?? '';
      const comision = document.getElementById('metodo-comision'); if(comision) comision.value = m?.comision ?? '';
      const color = document.getElementById('metodo-color'); if(color) color.value = m?.color ?? '';
      const activo = document.getElementById('metodo-activo'); if(activo) activo.value = (m && (m.activo === true || m.activo === 'true')) ? 'true' : 'false';
      const desc = document.getElementById('metodo-descripcion'); if(desc) desc.value = m?.descripcion ?? '';
      openModal('modal-metodo');
    }
    function hideMetodoForm(){ state.editingMetodoId = null; closeModal('modal-metodo'); }
    async function saveMetodo(){
      const nombre = (document.getElementById('metodo-nombre').value || '').trim();
      const comision = Number(document.getElementById('metodo-comision').value || '0');
      const color = (document.getElementById('metodo-color').value || '').trim() || null;
      const activoVal = document.getElementById('metodo-activo').value || 'true';
      const activo = (String(activoVal).toLowerCase() === 'true');
      const descripcion = (document.getElementById('metodo-descripcion').value || '').trim() || null;
      if(!nombre){ showToast('El nombre es obligatorio', 'warning', 3000); return; }
      if(comision < 0){ showToast('La comisión no puede ser negativa', 'warning', 3000); return; }
      const body = { nombre, comision, color, activo, descripcion };
      let url = '/api/metodos_pago'; let method = 'POST';
      if(state.editingMetodoId){ url = `/api/metodos_pago/${state.editingMetodoId}`; method = 'PUT'; }
      try{
        const res = await fetch(url, { method, headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(body) });
        if(!res.ok){ const err = await res.json().catch(()=>({})); showToast(err.detail || err.error || 'Error al guardar método', 'error', 4500); return; }
        await res.json().catch(()=>null);
        hideMetodoForm();
        showToast('Método de pago guardado', 'success', 2500);
        await loadMetodosAdmin();
      }catch(e){ showToast('Error de red al guardar método', 'error', 4500); }
    }
    async function deleteMetodo(id){
      if(!id) return; const conf = confirm('¿Eliminar método de pago?'); if(!conf) return;
      try{
        const res = await fetch(`/api/metodos_pago/${id}`, { method:'DELETE', headers:{ 'Accept':'application/json' } });
        if(!res.ok){ const err = await res.json().catch(()=>({})); showToast(err.detail || err.error || 'No se pudo eliminar', 'error', 4500); return; }
        await res.json().catch(()=>null);
        showToast('Método de pago eliminado', 'success', 2500);
        await loadMetodosAdmin();
      }catch(e){ showToast('Error de red al eliminar método', 'error', 4500); }
    }

    async function toggleMetodoActivo(id){
      if(!id) return;
      const m = (state.configMetodos || []).find(x => String(x.id) === String(id));
      if(!m){ showToast('Método no encontrado', 'warning', 3000); return; }
      const body = {
        nombre: m.nombre ?? '',
        comision: m.comision ?? 0,
        color: m.color ?? null,
        activo: !(m.activo === true || m.activo === 'true')
      };
      try{
        const res = await fetch(`/api/metodos_pago/${id}`, { method:'PUT', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(body) });
        if(!res.ok){ const err = await res.json().catch(()=>({})); showToast(err.detail || err.error || 'No se pudo actualizar', 'error', 4500); return; }
        await res.json().catch(()=>null);
        showToast(body.activo ? 'Método activado' : 'Método desactivado', 'success', 2500);
        await loadMetodosAdmin();
      }catch(e){ showToast('Error de red al actualizar método', 'error', 4500); }
    }

    // ===== Configuración: Envíos pendientes (WhatsApp) =====
    async function loadWAPendings(){
      try{
        const res = await fetch('/api/whatsapp/pendings', { headers:{ 'Accept':'application/json' } });
        if(res.status === 401){ showToast('Acceso restringido a Gestión. Inicie sesión.', 'error', 4500); try{ window.location.href = '/gestion/login'; }catch(e){} return; }
        const data = await res.json();
        const rows = Array.isArray(data.items) ? data.items : (Array.isArray(data) ? data : []);
        if(!window.state) window.state = {};
        state.waPendings = rows;
        renderWAPendingsTable(rows);
      }catch(e){ console.warn('No se pudieron cargar envíos pendientes:', e); showToast('No se pudieron cargar envíos pendientes', 'error', 4500); }
    }
    function renderWAPendingsTable(rows){
      const tbody = document.querySelector('#config-wa-pendings-table tbody'); if(!tbody) return;
      tbody.innerHTML = '';
      const mapType = (t) => {
        const v = String(t || '').toLowerCase();
        if(v === 'welcome' || v === 'bienvenida') return 'Bienvenida';
        if(v === 'payment_confirmation' || v === 'confirmacion_pago') return 'Confirmación de pago';
        if(v === 'deactivation' || v === 'desactivacion') return 'Desactivación';
        if(v === 'overdue' || v === 'payment_reminder' || v === 'pago_recordatorio' || v === 'recordatorio_vencida') return 'Recordatorio vencimiento';
        if(v === 'class_reminder' || v === 'recordatorio_clase') return 'Recordatorio de clase';
        return t || '—';
      };
      (Array.isArray(rows) ? rows : []).forEach(r => {
        const tr = document.createElement('tr');
        const nombre = String(r.usuario_nombre || r.nombre || (r.user_id != null ? `Usuario #${r.user_id}` : '—'));
        const tel = String(r.phone_number || r.telefono || '—');
        const fechaRaw = r.fecha_envio || r.sent_at || r.fecha || '';
      const fecha = fechaRaw ? fmtDateEs(fechaRaw) : '—';
        const tipo = mapType(r.message_type || r.tipo || '—');
        tr.innerHTML = `
          <td>${nombre}</td>
          <td>${tel}</td>
          <td>${fecha}</td>
          <td>${tipo}</td>
          <td class="table-actions">
            <button class="btn warning" data-action="wa-retry" data-phone="${tel}" data-user-id="${r.user_id ?? ''}">Reintentar</button>
            <button class="btn outline neutral" data-action="wa-clear" data-phone="${tel}">Limpiar</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }
    async function retryWAPending(phone, userId){
      try{
        const body = {};
        if(phone) body.telefono = phone;
        if(userId != null && String(userId).trim() !== '') body.usuario_id = userId;
        const res = await fetch('/api/whatsapp/retry', { method:'POST', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(body) });
        const data = await res.json().catch(() => ({}));
        if(!res.ok || data.success === false){ showToast(data.detail || data.error || 'No se pudo reintentar', 'error', 4500); return; }
        showToast('Reintento enviado', 'success', 2500);
        await loadWAPendings();
      }catch(e){ showToast('Error de red al reintentar', 'error', 4500); }
    }
    async function clearWAPending(phone){
      if(!phone){ showToast('Teléfono inválido', 'warning', 3000); return; }
      const conf = confirm('¿Limpiar mensajes fallidos de este teléfono?'); if(!conf) return;
      try{
        const res = await fetch('/api/whatsapp/clear_failures', { method:'POST', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify({ telefono: phone }) });
        const data = await res.json().catch(() => ({}));
        if(!res.ok || data.success === false){ showToast(data.detail || data.error || 'No se pudo limpiar', 'error', 4500); return; }
        showToast('Mensajes fallidos limpiados', 'success', 2500);
        await loadWAPendings();
      }catch(e){ showToast('Error de red al limpiar', 'error', 4500); }
    }
    async function retryAllWAPendings(){
      const btn = document.getElementById('config-wa-retry-all'); if(btn) btn.disabled = true;
      try{
        const items = Array.isArray(state.waPendings) ? state.waPendings : [];
        for(const r of items){
          const tel = r.phone_number || r.telefono || '';
          const uid = r.user_id != null ? r.user_id : null;
          if(tel || uid != null){ await retryWAPending(tel, uid); }
        }
        showToast('Reintentos completados', 'success', 3000);
      }catch(e){ showToast('Error al reintentar en lote', 'error', 4500); }
      finally{ if(btn) btn.disabled = false; }
    }
    async function clearWAFailuresAll(){
      const conf = confirm('¿Limpiar mensajes fallidos de todos los teléfonos?'); if(!conf) return;
      const btn = document.getElementById('config-wa-clear-all'); if(btn) btn.disabled = true;
      try{
        const res = await fetch('/api/whatsapp/clear_failures', { method:'POST', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify({}) });
        const data = await res.json().catch(() => ({}));
        if(!res.ok || data.success === false){ showToast(data.detail || data.error || 'No se pudo limpiar', 'error', 4500); return; }
        showToast('Mensajes fallidos limpiados', 'success', 3000);
        await loadWAPendings();
      }catch(e){ showToast('Error al limpiar en lote', 'error', 4500); }
      finally{ if(btn) btn.disabled = false; }
    }

    // ===== WhatsApp: Estado y último envío =====
    async function loadWAState(){
      try{
        const res = await fetch('/api/whatsapp/state', { headers:{ 'Accept':'application/json' } });
        const data = await res.json().catch(() => ({}));
        const yesNo = (v) => (v ? 'Sí' : 'No');
        const elAvail = document.getElementById('config-wa-state-available');
        const elEnabled = document.getElementById('config-wa-state-enabled');
        const elServer = document.getElementById('config-wa-state-server');
        const elConfig = document.getElementById('config-wa-state-config');
        if(elAvail) elAvail.textContent = yesNo(Boolean(data?.disponible));
        if(elEnabled) elEnabled.textContent = yesNo(Boolean(data?.habilitado));
        if(elServer) elServer.textContent = Boolean(data?.servidor_activo) ? 'Activo' : 'Inactivo';
        if(elConfig) elConfig.textContent = yesNo(Boolean(data?.configuracion_valida));
        // Actualizar botón toggle según estado del servidor
        try {
          updateWAServerToggleUI(Boolean(data?.servidor_activo));
          const btnToggle = document.getElementById('config-wa-server-toggle');
          if(btnToggle){
            const cfgValid = Boolean(data?.configuracion_valida);
            btnToggle.disabled = !cfgValid;
            btnToggle.title = cfgValid ? '' : 'Configuración inválida';
          }
        } catch(_) {}
        // Rellenar inputs si el estado trae config actual (si está disponible)
        try{
          const cfg = (data && data.config) ? data.config : null;
          if(cfg){
            const allowEl = document.getElementById('wa-config-allowlist-text'); if(allowEl && (cfg.allowlist_numbers != null)){
              const arr = Array.isArray(cfg.allowlist_numbers) ? cfg.allowlist_numbers : String(cfg.allowlist_numbers || '').split(',');
              allowEl.value = (arr || []).map(x => String(x||'').trim()).filter(x => x).join(', ');
            }
            const allowChk = document.getElementById('wa-config-allowlist-enabled'); if(allowChk && (cfg.allowlist_enabled != null)) allowChk.checked = !!cfg.allowlist_enabled && String(cfg.allowlist_enabled).toLowerCase() !== 'false';
            const hookChk = document.getElementById('wa-config-enable-webhook'); if(hookChk && (cfg.enable_webhook != null)) hookChk.checked = !!cfg.enable_webhook && String(cfg.enable_webhook).toLowerCase() !== 'false';
          }
        }catch(_){ }
      }catch(e){ console.warn('No se pudo cargar estado WA:', e); }
    }

    function updateWAServerToggleUI(active){
      const btn = document.getElementById('config-wa-server-toggle');
      if(!btn) return;
      const isActive = !!active;
      btn.dataset.active = isActive ? 'true' : 'false';
      btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
      // Cambiar estilo y texto
      if(isActive){
        btn.textContent = 'Detener servidor';
        btn.setAttribute('aria-label', 'Detener servidor');
        btn.classList.remove('success');
        btn.classList.add('warning');
      } else {
        btn.textContent = 'Iniciar servidor';
        btn.setAttribute('aria-label', 'Iniciar servidor');
        btn.classList.remove('warning');
        btn.classList.add('success');
      }
    }

    function normalizePhones(text){
      const raw = String(text || '').split(',');
      const cleaned = raw.map(s => String(s||'').trim())
        .filter(s => s.length > 0)
        .map(s => s.replace(/[\s\-()]/g, ''))
        .map(s => (s.startsWith('+') ? s : ('+' + s)))
        .map(s => s.replace(/\+\+/g, '+'));
      // Eliminar duplicados preservando orden
      const seen = new Set();
      const out = [];
      cleaned.forEach(s => { const k = s; if(!seen.has(k)){ seen.add(k); out.push(k); } });
      return out;
    }

    function collectWAConfigFromForm(){
      const phone = '';
      const acct = '';
      const token = '';
      const allowText = (document.getElementById('wa-config-allowlist-text')||{}).value || '';
      const allowEnabled = !!(document.getElementById('wa-config-allowlist-enabled')||{}).checked;
      const hookEnabled = !!(document.getElementById('wa-config-enable-webhook')||{}).checked;
      const allowArr = normalizePhones(allowText);
      const payload = {
        allowlist_numbers: allowArr.join(', '),
        allowlist_enabled: allowEnabled,
        enable_webhook: hookEnabled
      };
      return payload;
    }

    function validateWAConfig(cfg){
      const errors = [];
      const setInvalid = (id, invalid) => { const el = document.getElementById(id); if(!el) return; if(invalid){ el.setAttribute('aria-invalid','true'); el.classList.add('input-error'); } else { el.removeAttribute('aria-invalid'); el.classList.remove('input-error'); } };
      const phoneOk = true;
      const errsEl = document.getElementById('wa-config-errors'); if(errsEl){ errsEl.style.display='none'; errsEl.textContent=''; }
      return { valid: errors.length === 0, errors };
    }

    async function saveWAConfig(){
      const statusEl = document.getElementById('wa-config-save-status'); if(statusEl) statusEl.textContent = 'Guardando configuración…';
      const btn = document.getElementById('config-wa-save'); if(btn){ btn.disabled = true; btn.setAttribute('aria-busy','true'); }
      try{
        const cfg = collectWAConfigFromForm();
        const val = validateWAConfig(cfg);
        if(!val.valid){ if(statusEl) statusEl.textContent = 'Corrige los errores e intenta nuevamente.'; return; }
        const res = await fetch('/api/whatsapp/config', { method:'POST', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(cfg) });
        if(res.status === 401){ showToast('Acceso restringido a dueño. Inicie sesión.', 'error', 4500); try{ window.location.href = '/gestion/login'; }catch(e){} return; }
        const data = await res.json().catch(()=>({}));
        if(!res.ok || data.success === false){ showToast(data.detail || data.error || data.message || 'No se pudo guardar configuración', 'error', 5000); if(statusEl) statusEl.textContent = 'Error al guardar configuración.'; return; }
        showToast('Configuración de WhatsApp guardada', 'success', 3500);
        if(statusEl) statusEl.textContent = 'Configuración guardada correctamente.';
        try{ await loadWAState(); }catch(_){ }
      }catch(e){ showToast('Error de red al guardar configuración', 'error', 4500); if(statusEl) statusEl.textContent = 'Error de red.'; }
      finally{ if(btn){ btn.disabled = false; btn.removeAttribute('aria-busy'); } }
    }

    async function toggleWAServer(){
      const btn = document.getElementById('config-wa-server-toggle');
      if(!btn) return;
      btn.disabled = true; btn.setAttribute('aria-busy','true');
      const isActive = String(btn.dataset.active || 'false') === 'true';
      try{
        const url = isActive ? '/api/whatsapp/server/stop' : '/api/whatsapp/server/start';
        const res = await fetch(url, { method:'POST', headers:{ 'Accept':'application/json' } });
        if(res.status === 401){ showToast('Acceso restringido a dueño. Inicie sesión.', 'error', 4500); try{ window.location.href = '/gestion/login'; }catch(e){} return; }
        const data = await res.json().catch(()=>({}));
        if(!res.ok || data.success === false){
          showToast(data.detail || data.error || data.message || (isActive ? 'No se pudo detener servidor de WhatsApp' : 'No se pudo iniciar servidor de WhatsApp'), 'error', 5000);
          return;
        }
        showToast(isActive ? 'Servidor de WhatsApp detenido' : 'Servidor de WhatsApp iniciado', 'success', 3500);
        try{ await loadWAState(); }catch(_){ }
      }catch(e){
        showToast(isActive ? 'Error de red al detener servidor' : 'Error de red al iniciar servidor', 'error', 4500);
      } finally {
        btn.disabled = false; btn.removeAttribute('aria-busy');
      }
    }
    async function loadWALastForUser(uid){
      const elUser = document.getElementById('config-wa-last-user');
      const elType = document.getElementById('config-wa-last-type');
      const elDate = document.getElementById('config-wa-last-date');
      const elStatus = document.getElementById('config-wa-last-status');
      const elDetail = document.getElementById('config-wa-last-detail');
      const mapType = (t) => {
        const v = String(t || '').toLowerCase();
        if(v === 'welcome' || v === 'bienvenida') return 'Bienvenida';
        if(v === 'payment_confirmation' || v === 'confirmacion_pago') return 'Confirmación de pago';
        if(v === 'deactivation' || v === 'desactivacion') return 'Desactivación';
        if(v === 'overdue' || v === 'payment_reminder' || v === 'pago_recordatorio' || v === 'recordatorio_vencida') return 'Recordatorio vencimiento';
        return t || '—';
      };
      const setDash = () => { if(elUser) elUser.textContent = '—'; if(elType) elType.textContent = '—'; if(elDate) elDate.textContent = '—'; if(elStatus) elStatus.textContent = '—'; if(elDetail) elDetail.textContent = '—'; };
      const u = Number(uid);
      if(!Number.isFinite(u) || u < 1){ setDash(); return; }
      try{
        const res = await fetch(`/api/usuarios/${encodeURIComponent(u)}/whatsapp/ultimo`, { headers:{ 'Accept':'application/json' } });
        const data = await res.json().catch(() => null);
        const item = (data && typeof data === 'object' && 'item' in data) ? data.item : data;
        if(!item){ setDash(); return; }
        if(elUser) elUser.textContent = `Usuario #${u}`;
        if(elType) elType.textContent = mapType(item.message_type ?? item.tipo ?? '—');
      if(elDate) elDate.textContent = (fmtDateEs(item.fecha_envio ?? item.sent_at) ?? '—');
        if(elStatus) elStatus.textContent = (item.status ?? '—');
        if(elDetail){
          const raw = String(item.message_content || '').trim();
          let det = '—';
          const st = String(item.status || '').toLowerCase();
          if(st === 'failed'){
            const m = raw.match(/Error:\s*(.+)$/i);
            det = (m && m[1]) ? m[1].trim() : (raw || '—');
          } else if(st === 'received'){
            det = raw || '—';
          } else if(item.template_name){
            det = String(item.template_name);
          } else {
            det = raw ? raw.slice(0, 200) : '—';
          }
          elDetail.textContent = det || '—';
        }
      }catch(e){ console.warn('No se pudo cargar último WA:', e); setDash(); }
    }
    async function loadConfigData(){
      await Promise.all([loadTiposCuotaAdmin(), loadConceptosAdmin(), loadMetodosAdmin(), loadWAPendings(), loadWAState()]).catch(()=>{});
      try{ await loadUsuarioWAUsersOptions((state.selectedUsuario && state.selectedUsuario.id) || null); }catch(_){}
    }
    // ===== Branding del gimnasio =====
    async function refreshBranding(){
      try{
        const r = await fetch('/api/gym/data');
        const j = await r.json();
        const nameInput = document.getElementById('gym-name-input');
        const preview = document.getElementById('gym-logo-preview');
        if (nameInput && typeof j.gym_name === 'string') nameInput.value = j.gym_name;
        if (preview && typeof j.logo_url === 'string') preview.src = j.logo_url;
        // Actualizar encabezado y título de la página para reflejar el nuevo nombre
        try {
          const headerTitle = document.querySelector('#main-header .brand h1');
          const gname = (typeof j.gym_name === 'string') ? j.gym_name.trim() : '';
          if (headerTitle && gname) headerTitle.textContent = 'Gestión • ' + gname;
          if (gname) { document.title = 'Gestión • ' + gname; }
        } catch(_){ /* silencioso */ }
      }catch(_){ /* silencioso */ }
    }
    async function saveBranding(){
      const statusEl = document.getElementById('gym-branding-status');
      const nameInput = document.getElementById('gym-name-input');
      const logoInput = document.getElementById('gym-logo-input');
      if (statusEl) statusEl.textContent = 'Guardando...';
      try{
        const name = (nameInput && nameInput.value ? nameInput.value : '').trim();
        if (name){
          const r = await fetch('/api/gym/update', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ gym_name: name }) });
          if (!r.ok){
            const e = await r.json().catch(() => ({ error: r.statusText }));
            throw new Error(e.error || 'Error guardando nombre');
          }
        }
        let file = logoInput && logoInput.files ? logoInput.files[0] : undefined;
        async function maybeCompressLogo(f){
          try{
            if(!f || String(f.type).toLowerCase() !== 'image/png') return f;
            const MAX_BYTES = 1000000;
            if(f.size <= MAX_BYTES) return f;
            const imgDataUrl = await new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = () => resolve(reader.result);
              reader.onerror = () => reject(new Error('No se pudo leer imagen'));
              reader.readAsDataURL(f);
            });
            const img = await new Promise((resolve, reject) => {
              const i = new Image();
              i.onload = () => resolve(i);
              i.onerror = () => reject(new Error('Imagen inválida'));
              i.src = String(imgDataUrl);
            });
            const w = img.naturalWidth || img.width || 0;
            const h = img.naturalHeight || img.height || 0;
            const maxDim = 1024;
            const scale = Math.min(1, maxDim / Math.max(w, h));
            const tw = Math.max(1, Math.round(w * scale));
            const th = Math.max(1, Math.round(h * scale));
            const canvas = document.createElement('canvas');
            canvas.width = tw; canvas.height = th;
            const ctx = canvas.getContext('2d');
            if(!ctx) return f;
            ctx.clearRect(0,0,tw,th);
            ctx.drawImage(img, 0, 0, tw, th);
            let blob = await new Promise((resolve) => canvas.toBlob(resolve, 'image/png'));
            if(!blob) return f;
            if(blob.size >= f.size) return f;
            if(blob.size > MAX_BYTES){
              const s = Math.max(0.5, MAX_BYTES / blob.size);
              const tw2 = Math.max(1, Math.round(tw * Math.sqrt(s)));
              const th2 = Math.max(1, Math.round(th * Math.sqrt(s)));
              const c2 = document.createElement('canvas');
              c2.width = tw2; c2.height = th2;
              const c2ctx = c2.getContext('2d');
              if(c2ctx){
                c2ctx.clearRect(0,0,tw2,th2);
                c2ctx.drawImage(canvas, 0, 0, tw2, th2);
                const b2 = await new Promise((resolve) => c2.toBlob(resolve, 'image/png'));
                if(b2 && b2.size < blob.size) blob = b2;
              }
            }
            const out = new File([blob], String(f.name || 'logo').replace(/\.png$/i,'') + '.png', { type: 'image/png' });
            return out;
          }catch(_){ return f; }
        }
        if (file){
          file = await maybeCompressLogo(file);
          const fd = new FormData();
          fd.append('file', file);
          const r2 = await fetch('/api/gym/logo', { method: 'POST', body: fd });
          if (!r2.ok){
            const e = await r2.json().catch(() => ({ error: r2.statusText }));
            throw new Error(e.error || 'Error subiendo logo');
          }
        }
        await refreshBranding();
        try {
          localStorage.setItem('gym_branding_update', JSON.stringify({ gym_name: name, ts: Date.now() }));
        } catch(_){ /* noop */ }
        try {
          window.dispatchEvent(new CustomEvent('gym-branding-updated', { detail: { gym_name: name } }));
        } catch(_){ /* noop */ }
        if (statusEl) statusEl.textContent = 'Guardado correctamente';
        if (logoInput) logoInput.value = '';
      }catch(err){
        if (statusEl) statusEl.textContent = 'Error: ' + (err && err.message ? err.message : 'operación fallida');
      }
    }
    function bindBrandingEvents(){
      const saveBtn = document.getElementById('gym-branding-save');
      if (saveBtn){ saveBtn.addEventListener('click', saveBranding); }
    }
    function initBrandingAdmin(){
      refreshBranding();
      bindBrandingEvents();
    }
    function bindConfiguracionEvents(){
      const roleEl = document.getElementById('login-current');
      const role = roleEl ? (roleEl.getAttribute('data-role') || '').trim() : '';
      if(role === 'profesor'){
        // Ocultar solo el bloque "Mantenimiento" para profesores
        try {
          const renumBtn = document.getElementById('config-renum-run');
          const maintenanceBlock = renumBtn ? renumBtn.closest('.block') : null;
          if(maintenanceBlock){ maintenanceBlock.style.display = 'none'; }
          const secureOwnerBtn = document.getElementById('config-secure-owner');
          if(secureOwnerBtn){ const blk = secureOwnerBtn.closest('.block') || maintenanceBlock; if(blk) blk.style.display = 'none'; }
        } catch(_) {}
      }
      const tiposTbody = document.querySelector('#config-tipos-table tbody');
      if(tiposTbody){
        tiposTbody.addEventListener('click', (ev) => {
          const btn = ev.target.closest('button'); if(!btn) return;
          const id = btn.getAttribute('data-id'); const action = btn.getAttribute('data-action');
          if(action === 'edit-tipo'){
            const t = (state.configTipos || []).find(x => String(x.id) === String(id));
            showTipoForm(t || null);
          } else if(action === 'delete-tipo'){
            deleteTipoCuota(id);
          } else if(action === 'toggle-tipo-activo'){
            toggleTipoActivo(id);
          }
        });
      }
      const concTbody = document.querySelector('#config-conceptos-table tbody');
      if(concTbody){
        concTbody.addEventListener('click', (ev) => {
          const btn = ev.target.closest('button'); if(!btn) return;
          const id = btn.getAttribute('data-id'); const action = btn.getAttribute('data-action');
          if(action === 'edit-concepto'){
            const c = (state.configConceptos || []).find(x => String(x.id) === String(id));
            showConceptoForm(c || null);
          } else if(action === 'delete-concepto'){
            deleteConcepto(id);
          } else if(action === 'toggle-concepto-activo'){
            toggleConceptoActivo(id);
          }
        });
      }
      const metTbody = document.querySelector('#config-metodos-table tbody');
      if(metTbody){
        metTbody.addEventListener('click', (ev) => {
          const btn = ev.target.closest('button'); if(!btn) return;
          const id = btn.getAttribute('data-id'); const action = btn.getAttribute('data-action');
          if(action === 'edit-metodo'){
            const m = (state.configMetodos || []).find(x => String(x.id) === String(id));
            showMetodoForm(m || null);
          } else if(action === 'delete-metodo'){
            deleteMetodo(id);
          } else if(action === 'toggle-metodo-activo'){
            toggleMetodoActivo(id);
          }
        });
      }
      const btnTiposRefresh = document.getElementById('config-tipos-refresh'); if(btnTiposRefresh) btnTiposRefresh.addEventListener('click', loadTiposCuotaAdmin);
      const btnTiposNew = document.getElementById('config-tipos-new'); if(btnTiposNew) btnTiposNew.addEventListener('click', () => showTipoForm(null));
      const btnSaveTipo = document.getElementById('save-tipo-cuota'); if(btnSaveTipo) btnSaveTipo.addEventListener('click', saveTipoCuota);
      const btnCancelTipo = document.getElementById('cancel-tipo-cuota'); if(btnCancelTipo) btnCancelTipo.addEventListener('click', hideTipoForm);
      const btnCloseTipo = document.getElementById('close-modal-tipo-cuota'); if(btnCloseTipo) btnCloseTipo.addEventListener('click', hideTipoForm);

      const btnConcRefresh = document.getElementById('config-conceptos-refresh'); if(btnConcRefresh) btnConcRefresh.addEventListener('click', loadConceptosAdmin);
      const btnConcNew = document.getElementById('config-conceptos-new'); if(btnConcNew) btnConcNew.addEventListener('click', () => showConceptoForm(null));
      const btnSaveConc = document.getElementById('save-concepto'); if(btnSaveConc) btnSaveConc.addEventListener('click', saveConcepto);
      const btnCancelConc = document.getElementById('cancel-concepto'); if(btnCancelConc) btnCancelConc.addEventListener('click', hideConceptoForm);
      const btnCloseConc = document.getElementById('close-modal-concepto'); if(btnCloseConc) btnCloseConc.addEventListener('click', hideConceptoForm);

      const btnMetRefresh = document.getElementById('config-metodos-refresh'); if(btnMetRefresh) btnMetRefresh.addEventListener('click', loadMetodosAdmin);
      const btnMetNew = document.getElementById('config-metodos-new'); if(btnMetNew) btnMetNew.addEventListener('click', () => showMetodoForm(null));
      const btnSaveMet = document.getElementById('save-metodo'); if(btnSaveMet) btnSaveMet.addEventListener('click', saveMetodo);
      const btnCancelMet = document.getElementById('cancel-metodo'); if(btnCancelMet) btnCancelMet.addEventListener('click', hideMetodoForm);
      const btnCloseMet = document.getElementById('close-modal-metodo'); if(btnCloseMet) btnCloseMet.addEventListener('click', hideMetodoForm);

      const btnRenum = document.getElementById('config-renum-run');
      if(btnRenum) btnRenum.addEventListener('click', () => {
        const startEl = document.getElementById('config-renum-start');
        const startVal = parseInt(((startEl && startEl.value) || '1'), 10);
        if(!Number.isFinite(startVal) || startVal < 1){ showToast('ID inicial inválido', 'warning', 3000); return; }
        if(startVal === 1){ showToast('El ID 1 está reservado para Dueño. Usa 2 o mayor.', 'warning', 4000); return; }
        state.renumStartId = startVal;
        const disp = document.getElementById('renum-start-display'); if(disp) disp.textContent = String(startVal);
        openModal('modal-renum-confirm');
      });
      const renumClose = document.getElementById('renum-close'); if(renumClose) renumClose.addEventListener('click', () => closeModal('modal-renum-confirm'));
      const renumCancel = document.getElementById('renum-cancel'); if(renumCancel) renumCancel.addEventListener('click', () => closeModal('modal-renum-confirm'));
      const renumConfirm = document.getElementById('renum-confirm'); if(renumConfirm) renumConfirm.addEventListener('click', async () => {
        const btn = document.getElementById('renum-confirm'); const trigger = document.getElementById('config-renum-run');
        if(btn) btn.disabled = true; if(trigger) trigger.disabled = true;
        try{
          const startVal = Number(state.renumStartId || 0);
          const res = await fetch('/api/admin/renumerar_usuarios', { method:'POST', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify({ start_id: startVal }) });
          if(res.status === 401){ showToast('Acceso restringido a dueño. Inicie sesión.', 'error', 4500); try{ window.location.href = '/gestion/login'; }catch(e){} return; }
          const data = await res.json().catch(() => ({}));
          if(!res.ok || data.success === false){ showToast(data.detail || data.error || data.message || 'No se pudo renumerar IDs', 'error', 5000); return; }
          showToast('Renumeración completada', 'success', 3500);
          closeModal('modal-renum-confirm');
          try{ if(typeof loadUsers === 'function'){ await loadUsers(); } }catch(e){}
        }catch(e){ showToast('Error de red al renumerar', 'error', 4500); }
        finally{ if(btn) btn.disabled = false; if(trigger) trigger.disabled = false; }
      });
      const btnSecureOwner = document.getElementById('config-secure-owner');
      if(btnSecureOwner) btnSecureOwner.addEventListener('click', () => {
        openModal('modal-secure-owner-confirm');
      });
      const soClose = document.getElementById('secure-owner-close'); if(soClose) soClose.addEventListener('click', () => closeModal('modal-secure-owner-confirm'));
      const soCancel = document.getElementById('secure-owner-cancel'); if(soCancel) soCancel.addEventListener('click', () => closeModal('modal-secure-owner-confirm'));
      const soConfirm = document.getElementById('secure-owner-confirm'); if(soConfirm) soConfirm.addEventListener('click', async () => {
        const trigger = document.getElementById('config-secure-owner');
        const btn = document.getElementById('secure-owner-confirm');
        if(trigger) trigger.disabled = true; if(btn) btn.disabled = true;
        try{
          const res = await fetch('/api/admin/secure_owner', { method:'POST', headers:{ 'Accept':'application/json' } });
          if(res.status === 401){ showToast('Acceso restringido a dueño. Inicie sesión.', 'error', 4500); try{ window.location.href = '/gestion/login'; }catch(e){} return; }
          const data = await res.json().catch(() => ({}));
          if(!res.ok || data.success === false){ showToast(data.detail || data.error || data.message || 'No se pudo asegurar al Dueño', 'error', 5000); return; }
          showToast('Dueño asegurado', 'success', 3500);
          closeModal('modal-secure-owner-confirm');
          try{ if(typeof loadUsers === 'function'){ await loadUsers(); } }catch(e){}
        }catch(e){ showToast('Error de red al asegurar Dueño', 'error', 4500); }
        finally{ if(trigger) trigger.disabled = false; if(btn) btn.disabled = false; }
      });
      // WhatsApp: Envíos pendientes
      const waTbody = document.querySelector('#config-wa-pendings-table tbody');
      if(waTbody){
        waTbody.addEventListener('click', (ev) => {
          const btn = ev.target.closest('button'); if(!btn) return;
          const action = btn.getAttribute('data-action');
          const phone = btn.getAttribute('data-phone') || '';
          const userIdRaw = btn.getAttribute('data-user-id') || '';
          const userId = userIdRaw ? parseInt(userIdRaw, 10) : null;
          if(action === 'wa-retry'){
            retryWAPending(phone, userId);
          } else if(action === 'wa-clear'){
            clearWAPending(phone);
          }
        });
      }
      const btnWaRefresh = document.getElementById('config-wa-refresh');
      if(btnWaRefresh) btnWaRefresh.addEventListener('click', async () => {
        await loadWAPendings();
        await loadWAState();
        const uidEl = document.getElementById('usuario-wa-user-select');
        const uid = uidEl ? uidEl.value : '';
        if(uid) await loadWALastForUser(uid);
      });
      const btnWaSave = document.getElementById('config-wa-save'); if(btnWaSave) btnWaSave.addEventListener('click', saveWAConfig);
      const btnWaCheck = document.getElementById('config-wa-check-state'); if(btnWaCheck) btnWaCheck.addEventListener('click', loadWAState);
      const btnWaToggle = document.getElementById('config-wa-server-toggle'); if(btnWaToggle) btnWaToggle.addEventListener('click', toggleWAServer);
      const btnWaRetryAll = document.getElementById('config-wa-retry-all'); if(btnWaRetryAll) btnWaRetryAll.addEventListener('click', retryAllWAPendings);
      const btnWaClearAll = document.getElementById('config-wa-clear-all'); if(btnWaClearAll) btnWaClearAll.addEventListener('click', clearWAFailuresAll);
      // WhatsApp por usuario: selector de usuario en Configuración
      const waUserSel = document.getElementById('usuario-wa-user-select');
      if(waUserSel){
        waUserSel.addEventListener('change', async () => {
          const val = waUserSel.value || '';
          if(!val){
            clearUsuarioSelection();
            return;
          }
          try{
            const res = await fetch(`/api/usuarios/${encodeURIComponent(val)}`, { headers: { 'Accept':'application/json' } });
            const u = await res.json().catch(()=> null);
            if(!u){ showToast('No se pudo cargar el usuario', 'error', 4500); return; }
            state.selectedUsuario = u;
            await loadUsuarioWhatsApp(val);
            // Actualizar también la tarjeta "Último envío" en Configuración
            await loadWALastForUser(val);
          }catch(e){ showToast('Error de red al cargar usuario', 'error', 4500); }
        });
      }
      // Inicializar branding
      initBrandingAdmin();
    }

    // ===== Ejercicios: funciones =====
    function loadEjercicios(){
      const q = (document.getElementById('ejercicios-q') || {}).value || '';
      const objetivo = (document.getElementById('ejercicios-objetivo') || {}).value || '';
      const grupo = (document.getElementById('ejercicios-grupo') || {}).value || '';
      const params = new URLSearchParams();
      if(q) params.append('filtro', q);
      if(objetivo && objetivo !== 'Todos') params.append('objetivo', objetivo);
      if(grupo && grupo !== 'Todos') params.append('grupo_muscular', grupo);
      const url = params.toString() ? `/api/ejercicios?${params.toString()}` : '/api/ejercicios';
      // Retornar la promesa para permitir await loadEjercicios()
      return fetch(url, { headers: { 'Accept': 'application/json' } })
        .then(async (r) => {
          if(!r.ok){
            if(r.status === 401){
              showToast('Acceso restringido a Gestión. Inicie sesión.', 'error', 4500);
              try{ window.location.href = '/gestion/login'; }catch(e){}
              return [];
            }
            const d = await r.json().catch(() => ({}));
            showToast(d.detail || 'No se pudieron cargar ejercicios', 'error', 4500);
            return [];
          }
          return r.json().catch(() => []);
        })
        .then(items => { 
          state.ejercicios = Array.isArray(items) ? items : []; 
          updateEjerciciosTable(); 
          const sel = state.selectedEjercicio ? (state.ejercicios || []).find(x => String(x.id) === String(state.selectedEjercicio.id)) : null;
          updateEjercicioSidePanel(sel || null);
          return state.ejercicios;
        })
        .catch(() => { showToast('No se pudieron cargar ejercicios', 'error', 4500); return []; });
    }

    // ===== Rutinas: funciones =====
    function renderRutinasUsuarioFilter(){
      const sel = document.getElementById('rutinas-usuario'); if(!sel) return;
      const items = Array.isArray(state.usuarios) ? state.usuarios : [];
      const current = sel.value || '';
      sel.innerHTML = '<option value="">Todos</option>';
      items.forEach(u => {
        const opt = document.createElement('option');
        opt.value = String(u.id);
        opt.textContent = u.nombre || u.email || `Usuario ${u.id}`;
        sel.appendChild(opt);
      });
      if(current){ sel.value = current; }
    }

    function loadRutinas(){
      // Mantener para compatibilidad cuando se necesite ver todas (no default)
      const q = (document.getElementById('rutinas-q') || {}).value || '';
      fetch('/api/rutinas', { headers: { 'Accept': 'application/json' } })
        .then(async (r) => {
          if(!r.ok){
            if(r.status === 401){ showToast('Acceso restringido a Gestión. Inicie sesión.', 'error', 4500); try{ window.location.href = '/gestion/login'; }catch(e){} return []; }
            const d = await r.json().catch(() => ({})); showToast(d.detail || 'No se pudieron cargar rutinas', 'error', 4500); return [];
          }
          return r.json().catch(() => []);
        })
        .then(items => {
          const arr = Array.isArray(items) ? items : [];
          // Filtro simple por nombre
          const ql = q.trim().toLowerCase();
          state.rutinas = ql ? arr.filter(x => String((x.nombre||x.nombre_rutina||'')) .toLowerCase().includes(ql)) : arr;
          updateRutinasTable();
          const sel = state.selectedRutina ? (state.rutinas || []).find(x => String(x.id) === String(state.selectedRutina.id)) : null;
          updateRutinaSidePanel(sel || null);
        })
        .catch(() => showToast('No se pudieron cargar rutinas', 'error', 4500));
    }

    function loadRutinasPlantillas(){
      const q = (document.getElementById('rutinas-q') || {}).value || '';
      fetch('/api/rutinas/plantillas', { headers: { 'Accept': 'application/json' } })
        .then(async (r) => {
          if(!r.ok){
            if(r.status === 401){ showToast('Acceso restringido a Gestión. Inicie sesión.', 'error', 4500); try{ window.location.href = '/gestion/login'; }catch(e){} return []; }
            const d = await r.json().catch(() => ({})); showToast(d.detail || 'No se pudieron cargar plantillas', 'error', 4500); return [];
          }
          return r.json().catch(() => []);
        })
        .then(items => {
          const arr = Array.isArray(items) ? items : [];
          const ql = q.trim().toLowerCase();
          state.plantillas = ql ? arr.filter(x => String((x.nombre||x.nombre_rutina||'')).toLowerCase().includes(ql)) : arr;
          // En vista de plantillas, actualizar tabla con plantillas
          updateRutinasTable();
          const sel = state.selectedRutina ? (state.plantillas || []).find(x => String(x.id) === String(state.selectedRutina.id)) : null;
          updateRutinaSidePanel(sel || null);
        })
        .catch(() => showToast('No se pudieron cargar plantillas', 'error', 4500));
    }

    function applyRutinasFilters(){
      const cat = ((document.getElementById('rutinas-categoria')||{}).value || '').toLowerCase();
      // Plantillas
      const rowsPlant = document.querySelectorAll('#rutinas-table tbody tr');
      rowsPlant.forEach(r => {
        const rc = (r.querySelector('td[data-col="categoria"]')?.textContent || '').toLowerCase();
        const catOk = !cat || rc === cat;
        r.style.display = catOk ? '' : 'none';
      });
      const countEl = document.getElementById('rutinas-count'); if(countEl){
        const visibleRows = Array.from(document.querySelectorAll('#rutinas-table tbody tr')).filter(tr => tr.style.display !== 'none').length;
        countEl.textContent = `${visibleRows} mostradas`;
      }
      // Rutinas por usuario/todas
      try{
        const rowsUsr = document.querySelectorAll('#rutinas-usuario-table tbody tr');
        rowsUsr.forEach(r => {
          const rc = (r.querySelector('td[data-col="categoria"]')?.textContent || '').toLowerCase();
          const catOk = !cat || rc === cat;
          r.style.display = catOk ? '' : 'none';
        });
      }catch(_){ }
    }

    function updateRutinasTable(){
      const tbody = document.querySelector('#rutinas-table tbody'); if(!tbody) return;
      tbody.innerHTML = '';
      const itemsBase = Array.isArray(state.plantillas) ? state.plantillas : [];
      // Sorting
      const sortKey = state.rutinasSortKey || (typeof localStorage !== 'undefined' ? (localStorage.getItem('rutinas-sort-key') || '') : '') || 'nombre';
      const sortDir = state.rutinasSortDir || (typeof localStorage !== 'undefined' ? (localStorage.getItem('rutinas-sort-dir') || '') : '') || 'asc';
      // Listado principal: solo plantillas; no mostrar asignación
      const decorated = (Array.isArray(itemsBase) ? itemsBase : []).map((r) => {
        const diasStr = r.dias_semana != null ? String(r.dias_semana) : (r.dias != null ? String(r.dias) : '0');
        const categoriaStr = r.categoria ? String(r.categoria) : 'Todas';
        const ejerciciosCountNum = Array.isArray(r.ejercicios) ? r.ejercicios.length : Number(r.ejercicios_count || 0) || 0;
        return {
          r,
          nombre: String(r.nombre || r.nombre_rutina || ''),
          descripcion: String(r.descripcion || ''),
          dias: Number(diasStr) || 0,
          categoria: String(categoriaStr || ''),
          ejercicios: Number(ejerciciosCountNum) || 0
        };
      });
      const cmp = (a, b) => {
        const key = String(sortKey || 'nombre');
        let va = a[key]; let vb = b[key];
        const isNum = typeof va === 'number' && typeof vb === 'number';
        if(!isNum){ va = String(va || '').toLowerCase(); vb = String(vb || '').toLowerCase(); return sortDir === 'desc' ? vb.localeCompare(va) : va.localeCompare(vb); }
        return sortDir === 'desc' ? (vb - va) : (va - vb);
      };
      const items = decorated.sort(cmp).map(d => d.r);
      // Update sort header styles
      try{
        const ths = document.querySelectorAll('#rutinas-table thead th.th-sortable');
        ths.forEach(th => {
          const k = th.getAttribute('data-sort') || '';
          th.classList.toggle('th-sorted-asc', k === sortKey && sortDir === 'asc');
          th.classList.toggle('th-sorted-desc', k === sortKey && sortDir === 'desc');
        });
      }catch(_){ }
      items.forEach((r, idx) => {
        const tr = document.createElement('tr');
        tr.setAttribute('data-index', String(idx));
        tr.setAttribute('data-id', String(r.id || ''));
        const dias = r.dias_semana != null ? String(r.dias_semana) : (r.dias != null ? String(r.dias) : '—');
        const categoria = r.categoria ? String(r.categoria) : 'general';
        const ejerciciosCount = Array.isArray(r.ejercicios) ? r.ejercicios.length : (r.ejercicios_count != null ? String(r.ejercicios_count) : '—');
        const actionsHTML = `<button class="btn" data-action="preview" data-id="${r.id}">Abrir</button>
             <button class="btn" data-action="delete" data-id="${r.id}">Eliminar</button>`;
      const catBadge = `<span class="badge cat-badge" data-cat="${categoria}">${categoria}</span>`;
        tr.innerHTML = `
          <td data-col="nombre">${r.nombre || r.nombre_rutina || ''}</td>
          <td data-col="descripcion">${r.descripcion || ''}</td>
          <td data-col="dias">${dias}</td>
          <td data-col="categoria">${catBadge}</td>
          <td data-col="ejercicios">${ejerciciosCount}</td>
          <td>${actionsHTML}</td>`;
        tr.addEventListener('click', (ev) => {
          const isBtn = !!ev.target.closest('button'); if(isBtn) return;
          state.selectedRutina = r;
          openPlantillaSummaryToast(r);
        });
        tbody.appendChild(tr);
      });
      applyRutinasFilters();
      const countEl = document.getElementById('rutinas-count'); if(countEl) {
        const visibleRows = Array.from(document.querySelectorAll('#rutinas-table tbody tr')).filter(tr => tr.style.display !== 'none').length;
        countEl.textContent = `${visibleRows} mostradas`;
      }
    }

    // Toast flotante: resumen de plantilla (no bloqueante)
    function openPlantillaSummaryToast(r){
      try{
        const prev = document.getElementById('plantilla-summary-toast'); if(prev) prev.remove();
        const nombre = String(r?.nombre || r?.nombre_rutina || '');
        const descripcion = String(r?.descripcion || '');
        const categoria = String(r?.categoria || 'general');
        const ejerciciosCount = Array.isArray(r?.ejercicios) ? r.ejercicios.length : Number(r?.ejercicios_count || 0) || 0;

        const wrap = document.createElement('div');
        wrap.id = 'plantilla-summary-toast';
        wrap.setAttribute('role', 'status');
        wrap.setAttribute('aria-live', 'polite');
        wrap.style.position = 'fixed';
        wrap.style.right = '16px';
        wrap.style.bottom = '16px';
        wrap.style.zIndex = '1000';
        wrap.style.maxWidth = '520px';
        wrap.style.boxShadow = '0 8px 24px rgba(0,0,0,0.18)';
        wrap.style.border = '1px solid var(--border)';
        wrap.style.background = 'var(--card)';
        wrap.style.color = 'var(--text)';
        wrap.style.borderRadius = '12px';
        wrap.style.padding = '12px 14px';
        wrap.style.pointerEvents = 'auto';
        wrap.style.opacity = '0';
        wrap.style.transform = 'translateY(8px)';
        wrap.style.transition = 'opacity 180ms ease, transform 180ms ease';

        const closeBtn = document.createElement('button');
        closeBtn.type = 'button';
        closeBtn.setAttribute('aria-label', 'Cerrar');
        closeBtn.textContent = '×';
        closeBtn.style.position = 'absolute';
        closeBtn.style.right = '10px';
        closeBtn.style.top = '8px';
        closeBtn.style.border = 'none';
        closeBtn.style.background = 'transparent';
        closeBtn.style.color = 'var(--text-muted)';
        closeBtn.style.cursor = 'pointer';
        closeBtn.style.fontSize = '18px';
        closeBtn.addEventListener('click', () => {
          wrap.style.opacity = '0';
          wrap.style.transform = 'translateY(8px)';
          setTimeout(() => { try{ wrap.remove(); }catch(_){ } }, 180);
        });

        const title = document.createElement('div');
        title.style.fontWeight = '600';
        title.style.fontSize = '14px';
        title.style.marginRight = '24px';
        title.textContent = nombre || 'Plantilla';

        const desc = document.createElement('div');
        desc.style.fontSize = '13px';
        desc.style.marginTop = '6px';
        desc.style.color = 'var(--text-muted)';
        desc.textContent = descripcion || 'Sin descripción';

        const meta = document.createElement('div');
        meta.style.display = 'flex';
        meta.style.gap = '12px';
        meta.style.flexWrap = 'wrap';
        meta.style.alignItems = 'center';
        meta.style.marginTop = '10px';

        const cat = document.createElement('span');
        cat.textContent = `Categoría: ${categoria}`;
        cat.style.fontSize = '12px';
        cat.style.padding = '2px 8px';
        cat.style.borderRadius = '12px';
        cat.style.background = '#eef';
        cat.style.color = '#334';

        const cnt = document.createElement('span');
        cnt.textContent = `Ejercicios: ${ejerciciosCount}`;
        cnt.style.fontSize = '12px';
        cnt.style.color = 'var(--text-muted)';

        meta.appendChild(cat);
        meta.appendChild(cnt);

        wrap.appendChild(title);
        wrap.appendChild(desc);
        wrap.appendChild(meta);
        wrap.appendChild(closeBtn);

        document.body.appendChild(wrap);
        requestAnimationFrame(() => {
          wrap.style.opacity = '1';
          wrap.style.transform = 'translateY(0)';
        });
        setTimeout(() => {
          wrap.style.opacity = '0';
          wrap.style.transform = 'translateY(8px)';
          setTimeout(() => { try{ wrap.remove(); }catch(_){ } }, 180);
        }, 30000);
      }catch(_){ }
    }

    function bindRutinasEvents(){
      if(!document.getElementById('panel-rutinas')) return;
      renderRutinasUsuarioFilter();
      const btnRefresh = document.getElementById('rutinas-refresh'); if(btnRefresh) btnRefresh.addEventListener('click', () => { loadRutinasPlantillas(); const uid = (document.getElementById('rutinas-usuario')||{}).value || ''; loadRutinasPorUsuario(uid); });
      const qInput = document.getElementById('rutinas-q'); if(qInput) qInput.addEventListener('keydown', (e) => { if(e.key === 'Enter') { loadRutinasPlantillas(); const uid = (document.getElementById('rutinas-usuario')||{}).value || ''; loadRutinasPorUsuario(uid); } });
      const uSel = document.getElementById('rutinas-usuario'); if(uSel) uSel.addEventListener('change', () => {
        applyRutinasFilters();
        const uid = uSel.value || '';
        loadRutinasPorUsuario(uid);
      });
      const catSel = document.getElementById('rutinas-categoria'); if(catSel) catSel.addEventListener('change', () => { applyRutinasFilters(); });
      const btnNew = document.getElementById('rutinas-new'); if(btnNew) btnNew.addEventListener('click', () => { openRutinaBuilderNew(); });
      const btnNewTpl = document.getElementById('rutinas-new-template'); if(btnNewTpl) btnNewTpl.addEventListener('click', () => { try{ openModal('modal-plantilla-new'); }catch(_){ showToast('No se pudo abrir nueva plantilla', 'error', 3000); } });
      // (Resumen modal eliminado) — se usa toast de resumen al clicar filas

      // Persist and restore filters
      try{
        const qInput2 = document.getElementById('rutinas-q'); if(qInput2){ const prevQ = localStorage.getItem('rutinas-q') || ''; if(prevQ) qInput2.value = prevQ; qInput2.addEventListener('input', () => { localStorage.setItem('rutinas-q', qInput2.value || ''); }); }
        const catSel2 = document.getElementById('rutinas-categoria'); if(catSel2){ const prevC = localStorage.getItem('rutinas-categoria'); if(prevC != null) catSel2.value = prevC; catSel2.addEventListener('change', () => { localStorage.setItem('rutinas-categoria', catSel2.value || ''); }); }
        const uSel3 = document.getElementById('rutinas-usuario'); if(uSel3){ const prevU = localStorage.getItem('rutinas-usuario'); if(prevU != null) uSel3.value = prevU; uSel3.addEventListener('change', () => { localStorage.setItem('rutinas-usuario', uSel3.value || ''); }); }
      }catch(_){ }

      // Subtabs toggling
      function applyRutinasTabUI(){
        // Vista unificada: mostrar ambas secciones y controles de usuario
        const lab = document.getElementById('rutinas-usuario-label'); if(lab) lab.style.display = '';
        const uSel2 = document.getElementById('rutinas-usuario'); if(uSel2) uSel2.style.display = '';
        const tbl = document.getElementById('rutinas-table'); if(tbl) tbl.parentElement.style.display = '';
        const block = document.getElementById('rutinas-usuario-block'); if(block) block.style.display = '';
        const btnNewEl = document.getElementById('rutinas-new'); if(btnNewEl) btnNewEl.textContent = 'Nueva';
        // Cargar datos de ambas secciones
        loadRutinasPlantillas();
        const uid = (document.getElementById('rutinas-usuario')||{}).value || '';
        loadRutinasPorUsuario(uid);
        // Mostrar/ocultar subtabs según viewport: visibles en móvil como selector superior
        const tabBar = document.getElementById('rutinas-subtabs');
        if(tabBar){
          const isMobile = window.matchMedia('(max-width: 960px)').matches;
          tabBar.style.display = isMobile ? 'flex' : 'none';
        }
        applyRutinasFilters();
      }
      const tabBar = document.getElementById('rutinas-subtabs');
      if(tabBar){
        tabBar.addEventListener('click', (ev) => {
          const btn = ev.target.closest('button'); if(!btn) return;
          const tab = btn.getAttribute('data-rutinas-tab'); if(!tab) return;
          state.activeRutinaTab = tab === 'usuario' ? 'usuario' : 'plantillas';
          applyRutinasTabUI();
        });
        // Apply default
        applyRutinasTabUI();
      }

      // Header sorting events
      const sortHeaders = document.querySelectorAll('#rutinas-table thead th.th-sortable');
      sortHeaders.forEach(th => {
        th.addEventListener('click', () => {
          const key = th.getAttribute('data-sort') || 'nombre';
          const curKey = state.rutinasSortKey || (localStorage.getItem('rutinas-sort-key') || 'nombre');
          const curDir = state.rutinasSortDir || (localStorage.getItem('rutinas-sort-dir') || 'asc');
          const nextDir = (key === curKey) ? (curDir === 'asc' ? 'desc' : 'asc') : 'asc';
          state.rutinasSortKey = key; state.rutinasSortDir = nextDir;
          try{ localStorage.setItem('rutinas-sort-key', key); localStorage.setItem('rutinas-sort-dir', nextDir); }catch(_){ }
          updateRutinasTable();
        });
      });

      const tbody = document.querySelector('#rutinas-table tbody');
      if(tbody){
        tbody.addEventListener('click', (ev) => {
          const btn = ev.target.closest('button'); if(!btn) return;
          const action = btn.getAttribute('data-action');
          if(action === 'edit'){
            const idx = parseInt(btn.getAttribute('data-index') || '0', 10);
            const row = (state.rutinas || [])[idx]; showRutinaForm(row || null);
          } else if(action === 'builder'){
            const id = btn.getAttribute('data-id'); if(id) openRutinaPreview(Number(id));
          } else if(action === 'preview'){
            const id = btn.getAttribute('data-id'); if(id) openRutinaPreview(Number(id));
          } else if(action === 'delete'){
            const id = btn.getAttribute('data-id'); deleteRutina(id);
          }
        });
      }

      // Modal form bindings
      const btnSave = document.getElementById('save-rutina'); if(btnSave) btnSave.addEventListener('click', saveRutina);
      const btnCancel = document.getElementById('cancel-rutina'); if(btnCancel) btnCancel.addEventListener('click', hideRutinaForm);
      const btnClose = document.getElementById('close-modal-rutina'); if(btnClose) btnClose.addEventListener('click', hideRutinaForm);

      // Delete modal bindings
      const delCancel = document.getElementById('rutina-delete-cancel'); if(delCancel) delCancel.addEventListener('click', () => closeModal('modal-rutina-delete'));
      const delConfirm = document.getElementById('rutina-delete-confirm'); if(delConfirm) delConfirm.addEventListener('click', confirmDeleteRutina);
      const delClose = document.getElementById('rutina-delete-close'); if(delClose) delClose.addEventListener('click', () => closeModal('modal-rutina-delete'));

      // Assign modal bindings
      const asClose = document.getElementById('rutina-assign-close'); if(asClose) asClose.addEventListener('click', () => closeModal('modal-rutina-assign'));
      const asCancel = document.getElementById('rutina-assign-cancel'); if(asCancel) asCancel.addEventListener('click', () => closeModal('modal-rutina-assign'));
      const asConfirm = document.getElementById('rutina-assign-confirm'); if(asConfirm) asConfirm.addEventListener('click', performAssignRutina);

      // Unassign modal bindings
      const unClose = document.getElementById('rutina-unassign-close'); if(unClose) unClose.addEventListener('click', () => closeModal('modal-rutina-unassign'));
      const unCancel = document.getElementById('rutina-unassign-cancel'); if(unCancel) unCancel.addEventListener('click', () => closeModal('modal-rutina-unassign'));
      const unConfirm = document.getElementById('rutina-unassign-confirm'); if(unConfirm) unConfirm.addEventListener('click', performUnassignRutina);

      // Side actions
      const sEdit = document.getElementById('rutina-side-edit'); if(sEdit) sEdit.addEventListener('click', () => { if(state.selectedRutina) openRutinaPreview(Number(state.selectedRutina.id)); });
      const sPrev = document.getElementById('rutina-side-preview'); if(sPrev) sPrev.addEventListener('click', () => { if(state.selectedRutina) openRutinaPreview(Number(state.selectedRutina.id)); });
      const sDel = document.getElementById('rutina-side-delete'); if(sDel) sDel.addEventListener('click', () => { if(state.selectedRutina) deleteRutina(state.selectedRutina.id); });
      const sAssign = document.getElementById('rutina-side-assign'); if(sAssign) sAssign.addEventListener('click', () => { if(state.selectedRutina) openAssignPlantilla(state.selectedRutina.id); });
      const sUnassign = document.getElementById('rutina-side-unassign'); if(sUnassign) sUnassign.addEventListener('click', () => { if(state.selectedRutina) openUnassignRutina(state.selectedRutina.id); });

      // CSV export of visible routines
      const btnCsv = document.getElementById('rutinas-export-csv');
      if(btnCsv){
        btnCsv.addEventListener('click', () => {
          try{
            const rows = Array.from(document.querySelectorAll('#rutinas-table tbody tr')).filter(tr => tr.style.display !== 'none');
            const headers = ['Nombre','Descripcion','Dias','Categoria','#Ejercicios'];
            const lines = [headers.join(',')];
            rows.forEach(tr => {
              const cNombre = tr.querySelector('td[data-col="nombre"]')?.textContent || '';
              const cDesc = tr.querySelector('td[data-col="descripcion"]')?.textContent || '';
              const cDias = tr.querySelector('td[data-col="dias"]')?.textContent || '';
              const cCat = tr.querySelector('td[data-col="categoria"]')?.textContent || '';
              const cEjs = tr.querySelector('td[data-col="ejercicios"]')?.textContent || '';
              const esc = (s) => {
                const t = String(s || '');
                if(/[",\n]/.test(t)) return '"' + t.replace(/"/g,'""') + '"';
                return t;
              };
              lines.push([esc(cNombre), esc(cDesc), esc(cDias), esc(cCat), esc(cEjs)].join(','));
            });
            const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'rutinas.csv';
            document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
            showToast('CSV exportado', 'success', 2500);
          }catch(_){ showToast('No se pudo exportar CSV', 'error', 3000); }
        });
      }

      // Preview modal extra actions
      // Nombre automático: "rutina_NombreRutina_Nombre_Apellido_FechaCreación(dd-mm-aaaa)"
      function standardizeNombre(base, user){
        const b = String(base||'').trim();
        const u = String(user||'').trim();
        // Limpia sufijo previo "- algo" si existe en base
        const cleanedBase = b.replace(/\s*-\s*[^-]+$/, '').trim();
        // Normaliza para underscores y caracteres seguros
        const safeSlug = (s) => String(s||'')
          .normalize('NFKD')
          .replace(/[\u0300-\u036f]/g, '')
          .replace(/[^\w\s-]/g, '')
          .trim()
          .replace(/\s+/g, '_');
        const formatDate = (dt) => {
          const d = String(dt.getDate()).padStart(2,'0');
          const m = String(dt.getMonth()+1).padStart(2,'0');
          const y = dt.getFullYear();
          return `${d}-${m}-${y}`;
        };
        const parts = u.split(/\s+/).filter(Boolean);
        const first = parts[0] || '';
        const last = parts.length > 1 ? parts[parts.length - 1] : '';
        const baseSeg = safeSlug(cleanedBase || '');
        const userFirst = safeSlug(first);
        const userLast = safeSlug(last);
        const dateSeg = formatDate(new Date());
        const nombreRutina = baseSeg || 'Rutina';
        const usuarioSeg = userLast ? `${userFirst}_${userLast}` : (userFirst || 'Usuario');
        return `rutina_${nombreRutina}_${usuarioSeg}_${dateSeg}`;
      }
      // Exponer helper global y agregar alias con fallback unificado
      try{ if(typeof window !== 'undefined'){ window.standardizeNombre = window.standardizeNombre || standardizeNombre; } }catch(_){ }
      try{
        if(typeof window !== 'undefined' && typeof window.computeRoutineName !== 'function'){
          window.computeRoutineName = function(base, user){
            try{ if(typeof standardizeNombre === 'function') return standardizeNombre(base, user); }catch(_){ }
            const b = String(base||'Rutina').trim();
            const u = String(user||'Usuario').trim();
            const cleanedBase = b.replace(/\s*-\s*[^-]+$/, '').trim();
            const safeSlug = (s) => String(s||'')
              .normalize('NFKD')
              .replace(/[\u0300-\u036f]/g, '')
              .replace(/[^\w\s-]/g, '')
              .trim()
              .replace(/\s+/g, '_');
            const formatDate = (dt) => { const d = String(dt.getDate()).padStart(2,'0'); const m = String(dt.getMonth()+1).padStart(2,'0'); const y = dt.getFullYear(); return `${d}-${m}-${y}`; };
            const parts = u.split(/\s+/).filter(Boolean);
            const first = parts[0] || '';
            const last = parts.length > 1 ? parts[parts.length - 1] : '';
            const baseSeg = safeSlug(cleanedBase || '');
            const userFirst = safeSlug(first);
            const userLast = safeSlug(last);
            const usuarioSeg = userLast ? `${userFirst}_${userLast}` : (userFirst || 'Usuario');
            const dateSeg = formatDate(new Date());
            const nombreRutina = baseSeg || 'Rutina';
            return `rutina_${nombreRutina}_${usuarioSeg}_${dateSeg}`;
          };
        }
      }catch(_){ }
      // Eventos del modal "Nueva plantilla"
      const pnClose = document.getElementById('plantilla-new-close'); if(pnClose) pnClose.addEventListener('click', () => closeModal('modal-plantilla-new'));
      const pnCancel = document.getElementById('plantilla-new-cancel'); if(pnCancel) pnCancel.addEventListener('click', () => closeModal('modal-plantilla-new'));
      const pnConfirm = document.getElementById('plantilla-new-confirm'); if(pnConfirm) pnConfirm.addEventListener('click', async () => {
        try{
          const n = (document.getElementById('plantilla-new-nombre')||{}).value || '';
          const d = (document.getElementById('plantilla-new-descripcion')||{}).value || '';
          closeModal('modal-plantilla-new');
          await openRutinaPreview(null);
          try{
            const titleEl = document.getElementById('modal-rutina-preview-title'); if(titleEl){ titleEl.textContent = 'Vista previa de plantilla'; }
          }catch(_){}
          const nameInput = document.getElementById('rutina-preview-nombre'); if(nameInput) nameInput.value = n;
          const descInput = document.getElementById('rutina-preview-descripcion'); if(descInput) descInput.value = d;
          const draft = state.rutinaPreviewDraft || state.rutinaPreview || {};
          draft.nombre_rutina = String(n||'');
          draft.descripcion = String(d||'');
          draft._is_template = true;
          state.rutinaPreviewDraft = draft;
          state.rutinaNombreBase = String(n||'');
          renderRutinaPreview();
          try{
            const c = (document.getElementById('plantilla-new-categoria')||{}).value || 'general';
            const diasSel = Number((document.getElementById('plantilla-new-dias')||{}).value || 3);
            const semanasSel = Number((document.getElementById('plantilla-new-semanas')||{}).value || 4);
            const catSel = document.getElementById('rutina-preview-categoria'); if(catSel){ catSel.value = String(c); catSel.disabled = false; }
            const diasInput = document.getElementById('rutina-preview-dias'); if(diasInput) diasInput.value = String(Math.max(2, Math.min(5, diasSel)));
            const semSel = document.getElementById('rutina-preview-semanas'); if(semSel) semSel.value = String(Math.max(1, Math.min(4, semanasSel)));
            const d2 = state.rutinaPreviewDraft || state.rutinaPreview || {};
            d2.categoria = String(c||'general');
            d2.dias_semana = Math.max(2, Math.min(5, diasSel||3));
            d2._weeks = Math.max(1, Math.min(4, semanasSel||4));
            state.rutinaPreviewDraft = d2;
            refreshPreviewDayOptions(Number(d2.dias_semana||3));
            renderRutinaPreview();
          }catch(__){}
        }catch(_){ showToast('No se pudo abrir la previsualización', 'error', 3000); }
      });
      const btnPrevNewEj = document.getElementById('rutina-preview-new-ej'); if(btnPrevNewEj) btnPrevNewEj.addEventListener('click', () => { try{ showEjercicioForm(null); }catch(_){ showToast('No se pudo abrir el formulario', 'error', 3000); } });
      const btnPrevEditEj = document.getElementById('rutina-preview-edit-ej'); if(btnPrevEditEj) btnPrevEditEj.addEventListener('click', () => {
        const float = document.getElementById('rutina-preview-float');
        let eid = float ? (float.dataset.eid || '') : '';
        if(!eid){
          const selIds = Array.isArray(state.rutinaSelected) ? state.rutinaSelected : [];
          if(selIds.length > 0) eid = String(selIds[0]).split('#')[0];
        }
        if(!eid){
          const sel = document.getElementById('rutina-preview-ejercicio');
          const val = sel ? String(sel.value||'') : '';
          if(val) eid = val;
        }
        if(!eid){
          showToast('Selecciona un ejercicio con clic, en la lista o activa selección múltiple', 'info', 3000);
          return;
        }
        const ej = (Array.isArray(state.ejercicios) ? state.ejercicios : []).find(x => String(x.id) === String(eid));
        if(!ej){ showToast('Ejercicio no encontrado', 'warning', 2500); return; }
        try{ showEjercicioForm(ej); }catch(_){ showToast('No se pudo abrir edición', 'error', 3000); }
      });
      const btnPrevToggle = document.getElementById('rutina-preview-toggle-advanced'); if(btnPrevToggle) btnPrevToggle.addEventListener('click', () => {
        const adv = document.getElementById('rutina-preview-advanced'); if(!adv) return;
        const hidden = !!state.rutinaPreviewAdvancedHidden;
        adv.style.display = hidden ? '' : 'none';
        state.rutinaPreviewAdvancedHidden = !hidden;
        btnPrevToggle.textContent = state.rutinaPreviewAdvancedHidden ? 'Mostrar opciones avanzadas' : 'Ocultar opciones avanzadas';
      });
      const btnPrevExport = document.getElementById('rutina-preview-export'); if(btnPrevExport) btnPrevExport.addEventListener('click', directExportExcelFromPreview);
    }

    function showRutinaForm(r){
      state.editingRutinaId = r && r.id ? Number(r.id) : null;
      openModal('modal-rutina-form');
      const nombreEl = document.getElementById('rutina-nombre'); if(nombreEl) nombreEl.value = r && (r.nombre || r.nombre_rutina) ? String(r.nombre || r.nombre_rutina) : '';
      const descEl = document.getElementById('rutina-descripcion'); if(descEl) descEl.value = r && r.descripcion ? String(r.descripcion) : '';
    }
    function hideRutinaForm(){ closeModal('modal-rutina-form'); }

    async function saveRutina(){
      const nombre = (document.getElementById('rutina-nombre') || {}).value || '';
      const descripcion = (document.getElementById('rutina-descripcion') || {}).value || '';
      if(!nombre.trim()){ showToast('El nombre es obligatorio', 'warning', 3000); return; }
      const body = { nombre_rutina: nombre, descripcion };
      let url = '/api/rutinas'; let method = 'POST';
      if(state.editingRutinaId){ url = `/api/rutinas/${state.editingRutinaId}`; method = 'PUT'; }
      try{
        const res = await fetch(url, { method, headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(body) });
        if(res.status === 401){ showToast('Acceso restringido; inicie sesión en Gestión.', 'error', 4500); try{ window.location.href = '/gestion/login'; }catch(e){} return; }
        const data = await res.json().catch(() => ({}));
        if(!res.ok){ showToast(data.detail || data.error || 'No se pudo guardar', 'error', 4500); return; }
        closeModal('modal-rutina-form');
        showToast('Rutina guardada', 'success', 2500);
        await loadRutinas();
        try{ document.dispatchEvent(new CustomEvent('rutinas:updated')); }catch(_){}
      }catch(e){ showToast('Error de red al guardar', 'error', 4500); }
    }

    function deleteRutina(id){
      if(!id){ showToast('Rutina no encontrada', 'warning', 3000); return; }
      state.deleteRutinaId = Number(id);
      openModal('modal-rutina-delete');
    }
    async function confirmDeleteRutina(){
      const id = state.deleteRutinaId; if(!id) return;
      try{
        const res = await fetch(`/api/rutinas/${id}`, { method:'DELETE', headers:{ 'Accept':'application/json' } });
        if(res.status === 401){ showToast('Acceso restringido; inicie sesión en Gestión.', 'error', 4500); try{ window.location.href = '/gestion/login'; }catch(e){} return; }
        const data = await res.json().catch(() => ({}));
        if(!res.ok){ showToast(data.detail || data.error || 'No se pudo eliminar', 'error', 4500); return; }
        closeModal('modal-rutina-delete');
        showToast('Rutina eliminada', 'success', 2500);
        await loadRutinas();
        try{ document.dispatchEvent(new CustomEvent('rutinas:updated')); }catch(_){}
      }catch(e){ showToast('Error de red al eliminar', 'error', 4500); }
    }

function openAssignRutina(id){
  state.editingRutinaId = id ? Number(id) : null;
  renderRutinasUsuarioFilter();
  const sel = document.getElementById('rutina-assign-user');
  const search = document.getElementById('rutina-assign-search');
  const summaryName = document.getElementById('rutina-assign-rutina-name');
  const summaryUser = document.getElementById('rutina-assign-current-user');
  if(summaryName){
    const r = state.selectedRutina; summaryName.textContent = r ? (r.nombre || r.nombre_rutina || `Rutina ${r.id}`) : '—';
  }
  if(sel){
    sel.innerHTML = '';
    const def = document.createElement('option'); def.value = ''; def.textContent = 'Selecciona usuario'; sel.appendChild(def);
    const fill = (users) => { (Array.isArray(users) ? users : []).forEach(u => { const opt = document.createElement('option'); opt.value = String(u.id); opt.textContent = u.nombre || u.email || `Usuario ${u.id}`; sel.appendChild(opt); }); };
    const users = Array.isArray(state.usuarios) ? state.usuarios : [];
    if(users.length){
      fill(users);
    } else {
      try{ loadUsers().then(() => { const u2 = Array.isArray(state.usuarios) ? state.usuarios : []; fill(u2); }).catch(() => {}); }catch(_){ }
    }
    // Preseleccionar el usuario actualmente seleccionado en la vista
    try{ const cur = (document.getElementById('rutinas-usuario')||{}).value || ''; if(cur){ sel.value = String(cur); } }catch(_){ }
    // Mostrar usuario actual de la rutina
    if(summaryUser){
      const r = state.selectedRutina;
      const uid = r && r.usuario_id != null ? Number(r.usuario_id) : null;
      let name = '—';
      if(uid){
        const arr = Array.isArray(state.usuarios) ? state.usuarios : [];
        const u = arr.find(x => Number(x.id) === Number(uid));
        if(u) name = u.nombre || `Usuario ${uid}`;
        else name = String(uid);
      }
      summaryUser.textContent = name;
    }
    // Filtro de búsqueda por texto
    if(search){
      search.oninput = () => {
        const q = (search.value || '').toLowerCase();
        Array.from(sel.options).forEach(opt => {
          if(!opt.value) return; // deja 'Selecciona usuario'
          opt.hidden = q.length > 0 && !(opt.textContent || '').toLowerCase().includes(q);
        });
      };
    }
  }
  openModal('modal-rutina-assign');
}
function openAssignPlantilla(id){
  state.assignPlantillaId = id ? Number(id) : null;
  renderRutinasUsuarioFilter();
  const sel = document.getElementById('rutina-assign-user');
  const search = document.getElementById('rutina-assign-search');
  const summaryName = document.getElementById('rutina-assign-rutina-name');
  const summaryUser = document.getElementById('rutina-assign-current-user');
  if(summaryName){
    // Cargar detalle de plantilla para mostrar nombre
    try{
      fetch(`/api/rutinas/${id}`, { headers:{ 'Accept':'application/json' } })
        .then(r => r.ok ? r.json() : {})
        .then(data => { summaryName.textContent = data && (data.nombre_rutina || data.nombre) ? String(data.nombre_rutina || data.nombre) : `Rutina ${id}`; })
        .catch(()=>{ summaryName.textContent = `Rutina ${id}`; });
    }catch(_){ summaryName.textContent = `Rutina ${id}`; }
  }
  if(sel){
    sel.innerHTML = '';
    const def = document.createElement('option'); def.value = ''; def.textContent = 'Selecciona usuario'; sel.appendChild(def);
    const fill = (users) => { (Array.isArray(users) ? users : []).forEach(u => { const opt = document.createElement('option'); opt.value = String(u.id); opt.textContent = u.nombre || u.email || `Usuario ${u.id}`; sel.appendChild(opt); }); };
    const users = Array.isArray(state.usuarios) ? state.usuarios : [];
    if(users.length){
      fill(users);
    } else {
      try{ loadUsers().then(() => { const u2 = Array.isArray(state.usuarios) ? state.usuarios : []; fill(u2); }).catch(() => {}); }catch(_){ }
    }
    // Preseleccionar el usuario actualmente seleccionado en la vista
    try{ const cur = (document.getElementById('rutinas-usuario')||{}).value || ''; if(cur){ sel.value = String(cur); } }catch(_){ }
    // Mostrar usuario actual (no aplica para plantilla, deja en —)
    if(summaryUser){ summaryUser.textContent = '—'; }
    // Filtro de búsqueda
    if(search){
      search.oninput = () => {
        const q = (search.value || '').toLowerCase();
        Array.from(sel.options).forEach(opt => {
          if(!opt.value) return;
          opt.hidden = q.length > 0 && !(opt.textContent || '').toLowerCase().includes(q);
        });
      };
    }
  }
  openModal('modal-rutina-assign');
}
    async function performAssignRutina(){
      const plantillaId = state.assignPlantillaId;
      const id = state.editingRutinaId;
      const userSel = document.getElementById('rutina-assign-user'); const userId = userSel ? (userSel.value || '') : '';
      if(!userId){ showToast('Selecciona usuario', 'warning', 3000); return; }
      try{
        if(plantillaId){
          // Clonar plantilla para el usuario
          const detRes = await fetch(`/api/rutinas/${plantillaId}`, { headers:{ 'Accept':'application/json' } });
          const det = await detRes.json().catch(() => ({}));
          if(!detRes.ok){ showToast(det.detail || det.error || 'No se pudo cargar plantilla', 'error', 4500); return; }
          const selectedLabel = (() => { try{ const selIdx = userSel ? userSel.selectedIndex : -1; if(selIdx >= 0){ return String(userSel.options[selIdx].textContent||''); } }catch(_){ } return ''; })();
          const baseNombre = det.nombre_rutina || det.nombre || 'Rutina';
          const nombreAuto = window.computeRoutineName(baseNombre, selectedLabel);
          const payload = {
            usuario_id: Number(userId),
            nombre_rutina: nombreAuto,
            descripcion: det.descripcion || null,
            dias_semana: Math.max(2, Math.min(5, Number(det.dias_semana || 3))),
            categoria: det.categoria || 'general',
            ejercicios: (Array.isArray(det.ejercicios)? det.ejercicios: []).map(x => {
              const diasMax = Math.max(2, Math.min(5, Number(det.dias_semana || 3)));
              const dia = Number(x.dia_semana || 1);
              const diaClamped = Math.max(1, Math.min(diasMax, dia));
              return { ejercicio_id: Number(x.ejercicio_id), dia_semana: diaClamped, series: x.series, repeticiones: x.repeticiones, orden: Number(x.orden||1) };
            })
          };
          const res = await fetch('/api/rutinas', { method:'POST', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(payload) });
          const data = await res.json().catch(() => ({})); if(!res.ok){ showToast(data.detail || data.error || 'No se pudo asignar plantilla', 'error', 4500); return; }
          // Fallback robusto: si la rutina creada quedó sin usuario, forzar asignación
          try{
            const createdId = Number((data && data.id) ? data.id : (data && data.ok ? data.id : 0));
            if(createdId){
              const detCreated = await fetch(`/api/rutinas/${createdId}`, { headers:{ 'Accept':'application/json' } });
              const detData = await detCreated.json().catch(() => ({}));
              if(detCreated.ok && (!detData || detData.usuario_id == null)){
                const assignRes = await fetch(`/api/rutinas/${createdId}/assign`, { method:'POST', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify({ usuario_id: Number(userId) }) });
                if(assignRes.status === 401){ showToast('Acceso restringido; inicie sesión en Gestión.', 'error', 4500); try{ window.location.href = '/gestion/login'; }catch(e){} return; }
                if(!assignRes.ok){ const ad = await assignRes.json().catch(()=>({})); showToast(ad.detail || ad.error || 'No se pudo asignar la rutina al usuario', 'warning', 3500); }
              }
            }
          }catch(_){ /* No bloquear si falla el fallback */ }
          closeModal('modal-rutina-assign'); state.assignPlantillaId = null; showToast('Plantilla clonada y asignada', 'success', 2500);
          // Refrescar vista de usuario si está activa, si no, las plantillas
          if(state.activeRutinaTab === 'usuario'){ const uid = (document.getElementById('rutinas-usuario')||{}).value || ''; await loadRutinasPorUsuario(uid); } else { await loadRutinasPlantillas(); }
          try{ document.dispatchEvent(new CustomEvent('rutinas:updated', { detail:{ action:'assign', usuarioId: Number(userId) } })); }catch(_){}
        } else if(id){
          // Asignar rutina existente
          const res = await fetch(`/api/rutinas/${id}/assign`, { method:'POST', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify({ usuario_id: Number(userId) }) });
          if(res.status === 401){ showToast('Acceso restringido; inicie sesión en Gestión.', 'error', 4500); try{ window.location.href = '/gestion/login'; }catch(e){} return; }
          const data = await res.json().catch(() => ({})); if(!res.ok){ showToast(data.detail || data.error || 'No se pudo asignar', 'error', 4500); return; }
          closeModal('modal-rutina-assign'); showToast('Rutina asignada', 'success', 2500);
          if(state.activeRutinaTab === 'usuario'){ const uid = (document.getElementById('rutinas-usuario')||{}).value || ''; await loadRutinasPorUsuario(uid); } else { await loadRutinasPlantillas(); }
          try{ document.dispatchEvent(new CustomEvent('rutinas:updated', { detail:{ action:'assign', usuarioId: Number(userId) } })); }catch(_){}
        } else {
          showToast('Acción no válida', 'warning', 2500);
        }
      }catch(e){ showToast('Error de red al asignar', 'error', 4500); }
    }

function openUnassignRutina(id){
  state.editingRutinaId = id ? Number(id) : null;
  const sel = document.getElementById('rutina-unassign-user');
  const search = document.getElementById('rutina-unassign-search');
  const summaryName = document.getElementById('rutina-unassign-rutina-name');
  const summaryUser = document.getElementById('rutina-unassign-current-user');
  if(summaryName){
    try{
      fetch(`/api/rutinas/${id}`, { headers:{ 'Accept':'application/json' } })
        .then(r => r.ok ? r.json() : {})
        .then(data => { summaryName.textContent = data && (data.nombre_rutina || data.nombre) ? String(data.nombre_rutina || data.nombre) : `Rutina ${id}`; })
        .catch(()=>{ summaryName.textContent = `Rutina ${id}`; });
    }catch(_){ summaryName.textContent = `Rutina ${id}`; }
  }
  if(sel){
    sel.innerHTML = '';
    const def = document.createElement('option'); def.value = ''; def.textContent = 'Selecciona usuario'; sel.appendChild(def);
    const fill = (users) => { (Array.isArray(users) ? users : []).forEach(u => { const opt = document.createElement('option'); opt.value = String(u.id); opt.textContent = u.nombre || u.email || `Usuario ${u.id}`; sel.appendChild(opt); }); };
    const users = Array.isArray(state.usuarios) ? state.usuarios : [];
    if(users.length){
      fill(users);
    } else {
      try{ loadUsers().then(() => { const u2 = Array.isArray(state.usuarios) ? state.usuarios : []; fill(u2); }).catch(() => {}); }catch(_){ }
    }
    // Preseleccionar por defecto el usuario seleccionado en la vista
    try{ const cur = (document.getElementById('rutinas-usuario')||{}).value || ''; if(cur){ sel.value = String(cur); } }catch(_){ }
    // Intentar preseleccionar el usuario asignado a la rutina
    if(id){
      try{
        fetch(`/api/rutinas/${id}`, { headers:{ 'Accept':'application/json' } })
          .then(r => r.ok ? r.json() : {})
          .then(data => { const uid = data && data.usuario_id != null ? String(data.usuario_id) : ''; if(uid){ sel.value = uid; if(summaryUser){ summaryUser.textContent = data.nombre_usuario || uid; } } })
          .catch(()=>{});
      }catch(_){ }
    }
    // Filtro de búsqueda
    if(search){
      search.oninput = () => {
        const q = (search.value || '').toLowerCase();
        Array.from(sel.options).forEach(opt => {
          if(!opt.value) return;
          opt.hidden = q.length > 0 && !(opt.textContent || '').toLowerCase().includes(q);
        });
      };
    }
  }
  openModal('modal-rutina-unassign');
}
    async function performUnassignRutina(){
      const id = state.editingRutinaId; const userSel = document.getElementById('rutina-unassign-user'); const userId = userSel ? (userSel.value || '') : '';
      if(!id || !userId){ showToast('Selecciona usuario', 'warning', 3000); return; }
      try{
        const res = await fetch(`/api/rutinas/${id}/unassign`, { method:'POST', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify({ usuario_id: Number(userId) }) });
        if(res.status === 401){ showToast('Acceso restringido; inicie sesión en Gestión.', 'error', 4500); try{ window.location.href = '/gestion/login'; }catch(e){} return; }
        const data = await res.json().catch(() => ({})); if(!res.ok){ showToast(data.detail || data.error || 'No se pudo desasignar', 'error', 4500); return; }
        closeModal('modal-rutina-unassign'); showToast('Rutina desasignada', 'success', 2500);
        // Refrescar según pestaña activa
        if(state.activeRutinaTab === 'usuario'){
          const uid = (document.getElementById('rutinas-usuario')||{}).value || '';
          await loadRutinasPorUsuario(uid);
        } else {
          await loadRutinas();
        }
        try{ document.dispatchEvent(new CustomEvent('rutinas:updated', { detail:{ action:'unassign', usuarioId: Number(userId) } })); }catch(_){}
      }catch(e){ showToast('Error de red al desasignar', 'error', 4500); }
    }

    // ===== Previsualización avanzada de Rutina =====
    function _deepCopy(obj){ try{ return JSON.parse(JSON.stringify(obj)); }catch(_){ return obj; } }
    function populateEjercicioSelectForPreview(){
      const sel = document.getElementById('rutina-preview-ejercicio'); if(!sel) return;
      sel.innerHTML = '';
      const def = document.createElement('option'); def.value = ''; def.textContent = 'Selecciona ejercicio'; sel.appendChild(def);
      const items = Array.isArray(state.ejerciciosFiltered) ? state.ejerciciosFiltered : (Array.isArray(state.ejercicios) ? state.ejercicios : []);
      const filter = state.ejFilter || {};
      const byGroup = new Map();
      items.forEach(e => { const g = String(e.grupo_muscular||'Generales'); const arr = byGroup.get(g) || []; arr.push(e); byGroup.set(g, arr); });
      if(filter.group){
        const groupLabel = Array.from(byGroup.keys()).find(k => String(k).toLowerCase() === String(filter.group||'').toLowerCase());
        const arr = groupLabel ? (byGroup.get(groupLabel)||[]) : [];
        arr.forEach(e => { const opt = document.createElement('option'); opt.value = String(e.id); opt.textContent = e.nombre || `Ejercicio ${e.id}`; sel.appendChild(opt); });
      } else {
        Array.from(byGroup.entries()).forEach(([label, arr]) => {
          const og = document.createElement('optgroup'); og.label = String(label);
          arr.forEach(e => { const opt = document.createElement('option'); opt.value = String(e.id); opt.textContent = e.nombre || `Ejercicio ${e.id}`; og.appendChild(opt); });
          sel.appendChild(og);
        });
      }
      // Seleccionar automáticamente el primer resultado cuando hay filtro activo
      try {
        const filtered = Array.isArray(state.ejerciciosFiltered) ? state.ejerciciosFiltered : null;
        if(filtered && filtered.length > 0){ sel.value = String(filtered[0].id); }
      } catch(_){ }
    }
    function filterEjerciciosForPreview(query){
      const base = Array.isArray(state.ejercicios) ? state.ejercicios : [];
      state.ejFilter = state.ejFilter || { q:'', group:'', objetivo:'' };
      state.ejFilter.q = String(query||'');
      const q = state.ejFilter.q.toLowerCase();
      const group = String(state.ejFilter.group||'').toLowerCase();
      const objetivo = String(state.ejFilter.objetivo||'').toLowerCase();
      const hasAny = !!q || !!group || !!objetivo;
      if(!hasAny){ state.ejerciciosFiltered = null; return; }
      state.ejerciciosFiltered = base.filter(e => {
        const name = String(e.nombre||'').toLowerCase();
        const gm = String(e.grupo_muscular||'').toLowerCase();
        const obj = String(e.objetivo||'').toLowerCase();
        const qOk = q ? (name.includes(q) || gm.includes(q) || obj.includes(q)) : true;
        const gOk = group ? (gm === group) : true;
        const oOk = objetivo ? (obj === objetivo) : true;
        return qOk && gOk && oOk;
      });
    }
    function populateEjercicioFilters(){
      const grpSel = document.getElementById('rutina-preview-filter-group');
      const objSel = document.getElementById('rutina-preview-filter-objetivo');
      const base = Array.isArray(state.ejercicios) ? state.ejercicios : [];
      const groups = Array.from(new Set(base.map(e => String(e.grupo_muscular||'').trim()).filter(Boolean)));
      const objetivos = Array.from(new Set(base.map(e => String(e.objetivo||'').trim()).filter(Boolean)));
      if(grpSel){ const cur = grpSel.value; grpSel.innerHTML = '<option value="">Grupo: Todos</option>'; groups.forEach(g => { const opt=document.createElement('option'); opt.value=String(g); opt.textContent=String(g); grpSel.appendChild(opt); }); grpSel.value = cur || ''; }
      if(objSel){ const cur = objSel.value; objSel.innerHTML = '<option value="">Objetivo: Todos</option>'; objetivos.forEach(o => { const opt=document.createElement('option'); opt.value=String(o); opt.textContent=String(o); objSel.appendChild(opt); }); objSel.value = cur || ''; }
    }
function renderRutinaPreview(){
  const cont = document.getElementById('rutina-preview-grid'); if(!cont) return;
  const d = state.rutinaPreviewDraft || state.rutinaPreview || {};
  const diasRaw = Number(d.dias_semana || 3);
  const dias = Math.max(2, Math.min(5, diasRaw));
  cont.style.gridTemplateColumns = `repeat(${Math.max(2, dias)}, 1fr)`;
  cont.innerHTML = '';
  const ejs = Array.isArray(d.ejercicios) ? d.ejercicios : [];
  const selectedSet = new Set(Array.isArray(state.rutinaSelected) ? state.rutinaSelected.map(String) : []);
  // Helpers para valores semanales
  const sumSeries = (val) => {
    if(val == null) return 0;
    if(typeof val === 'string'){
      const parts = val.split(',').map(x => Math.max(0, Number(x.trim())||0));
      return parts.reduce((a,b)=>a+b,0);
    }
    return Math.max(0, Number(val)||0);
  };
  const fmtWeekly = (val) => {
    if(val == null) return '';
    if(typeof val === 'string'){
      return val.split(',').map(x => String(x.trim())).join('-');
    }
    return String(val);
  };
  for(let dia=1; dia<=dias; dia++){
    const col = document.createElement('div'); col.className = 'day-col';
    const header = document.createElement('div'); header.className = 'day-header';
    const items = ejs.filter(x => Number(x.dia_semana||1) === dia).sort((a,b) => Number(a.orden||0) - Number(b.orden||0));
    const vol = items.reduce((sum,it)=> sum + sumSeries(it.series), 0);
    const collapsed = !!(state.rutinaDayCollapsed && state.rutinaDayCollapsed[dia]);
    header.innerHTML = `
      <div style="display:flex; align-items:center; gap:8px"><strong>Día ${dia}</strong></div>
      <div class="muted" style="margin-top:4px">Volumen: ${vol} series</div>
      <div style="margin-top:4px"><a href="#" data-day-act="dup" data-day="${dia}">Duplicar a…</a> · <a href="#" data-day-act="clear" data-day="${dia}">Vaciar</a></div>
    `;
    col.appendChild(header);
    const list = document.createElement('div'); list.className = 'day-list'; list.style.display = collapsed ? 'none' : 'flex'; list.style.flexDirection='column'; list.style.gap='6px'; list.style.minHeight='64px';
    // Identificador de día para soporte táctil
    list.dataset.day = String(dia);
    // Zona de drop al inicio (ampliada)
    const topDrop = document.createElement('div'); topDrop.className = 'drop-top'; topDrop.dataset.day = String(dia); topDrop.style.height='28px'; topDrop.style.border='1px dashed #ddd'; topDrop.style.borderRadius='6px'; topDrop.style.opacity='0.7'; topDrop.style.marginBottom='6px'; topDrop.style.display='flex'; topDrop.style.alignItems='center'; topDrop.style.justifyContent='center'; topDrop.textContent = 'Soltar aquí para el inicio'; topDrop.style.fontSize='12px'; topDrop.style.color='#667';
    topDrop.addEventListener('dragover', (ev) => { ev.preventDefault(); topDrop.style.borderColor = '#59a0ff'; });
    topDrop.addEventListener('dragleave', () => { topDrop.style.borderColor = '#ddd'; });
    topDrop.addEventListener('drop', (ev) => { ev.preventDefault(); const drag = state.dragEj||{}; if(drag.eid){ moveOrReorderEjercicio(drag.eid, dia, '__TOP__'); state.dragEj=null; } topDrop.style.borderColor = '#ddd'; });
    list.appendChild(topDrop);
    items.forEach(item => {
      const tile = document.createElement('div'); tile.className = 'ejercicio-tile';
      const key = `${String(item.ejercicio_id)}#${Number(dia)}#${Number(item.orden||1)}`;
      tile.style.border='1px solid var(--border)'; tile.style.borderRadius='10px'; tile.style.padding= state.rutinaCompact ? '6px 8px' : '10px 12px'; tile.style.cursor='pointer'; tile.style.background = selectedSet.has(key) ? 'rgba(89,160,255,0.12)' : 'var(--card)'; tile.style.borderColor = selectedSet.has(key) ? 'rgba(89,160,255,0.8)' : 'var(--border)'; tile.style.boxShadow='0 1px 2px rgba(0,0,0,0.06)'; tile.style.transition='background 0.2s ease, box-shadow 0.2s ease';
      tile.setAttribute('draggable', 'true'); tile.dataset.eid = String(item.ejercicio_id); tile.dataset.day = String(dia); tile.dataset.order = String(item.orden || 1);
      const name = (item.ejercicio && item.ejercicio.nombre) ? item.ejercicio.nombre : `Ejercicio ${item.ejercicio_id}`;
      const series = item.series != null ? item.series : '';
      const reps = item.repeticiones != null ? item.repeticiones : '';
      const weeks = Math.max(1, Math.min(4, Number((document.getElementById('rutina-preview-semanas')||{}).value || 4)));
      const S = (typeof series === 'string') ? series.split(',').map(x=>String(x).trim()) : [String(series||'')];
      const R = (typeof reps === 'string') ? reps.split(',').map(x=>String(x).trim()) : [String(reps||'')];
      const pairs = [];
      for(let i=0;i<weeks;i++){
        const rr = (R[i] != null && R[i] !== '') ? R[i] : (R[0]||'');
        const ss = (S[i] != null && S[i] !== '') ? S[i] : (S[0]||'');
        if(rr || ss){ pairs.push(`${rr}x${ss}`); }
      }
      const pairsTxt = pairs.join(', ');
      const handle = '<span aria-hidden="true" style="font-family:monospace; opacity:0.7; cursor:grab; margin-right:6px">⋮⋮</span>';
      tile.innerHTML = state.rutinaCompact
        ? `<div>${handle}<strong>${name}</strong> <span class="muted">(${pairsTxt})</span></div>`
        : `<div style="display:flex; align-items:center; justify-content:space-between; gap:8px">${handle}<strong>${name}</strong><span style="font-size:12px; color:#667">#${Number(item.orden||1)}</span></div><div class="muted" style="margin-top:2px; font-size:12px">${pairsTxt}</div>`;
      tile.addEventListener('mouseenter', () => { tile.style.boxShadow='0 2px 6px rgba(0,0,0,0.12)'; });
      tile.addEventListener('mouseleave', () => { tile.style.boxShadow='0 1px 2px rgba(0,0,0,0.06)'; });
      tile.addEventListener('click', (ev) => {
        if(state.rutinaSelectMode){
          if(selectedSet.has(key)){ selectedSet.delete(key); state.rutinaSelected = Array.from(selectedSet); tile.style.background='var(--card)'; tile.style.borderColor='var(--border)'; }
          else { selectedSet.add(key); state.rutinaSelected = Array.from(selectedSet); tile.style.background='rgba(89,160,255,0.12)'; tile.style.borderColor='rgba(89,160,255,0.8)'; }
        } else {
          showRutinaPreviewFloat(item, ev.currentTarget);
        }
      });
      tile.addEventListener('dragstart', (ev) => { try{ state.dragEj = { eid: String(item.ejercicio_id), fromDay: Number(item.dia_semana||dia), order: Number(item.orden||1) }; ev.dataTransfer && ev.dataTransfer.setData('text/plain', String(item.ejercicio_id)); }catch(_){ state.dragEj = { eid: String(item.ejercicio_id), fromDay: Number(item.dia_semana||dia), order: Number(item.orden||1) }; } });
      tile.addEventListener('dragover', (ev) => { ev.preventDefault(); });
      tile.addEventListener('drop', (ev) => { ev.preventDefault(); const drag = state.dragEj || {}; if(drag.eid){ const beforeKey = `${String(item.ejercicio_id)}#${Number(item.orden||1)}`; moveOrReorderEjercicio(drag.eid, dia, beforeKey); state.dragEj = null; } });
      list.appendChild(tile);
    });
    list.addEventListener('dragover', (ev) => { ev.preventDefault(); list.style.border='1px dashed #59a0ff'; list.style.borderRadius='6px'; });
    list.addEventListener('drop', (ev) => { ev.preventDefault(); const drag = state.dragEj||{}; if(drag.eid){ moveOrReorderEjercicio(drag.eid, dia, null); state.dragEj = null; } list.style.border=''; });
    col.appendChild(list);
    // Bind acciones de día
    header.querySelectorAll('a[data-day-act]').forEach(a => {
      a.addEventListener('click', (ev) => {
        ev.preventDefault();
        const act = a.getAttribute('data-day-act');
        const dnum = Number(a.getAttribute('data-day')||'1')||1;
        if(act==='clear'){ clearRutinaDay(dnum); }
        if(act==='dup'){ openDuplicateDayPopover(dnum, a); }
        // Colapsar individual removido: usar solo el botón general
      });
    });
    cont.appendChild(col);
  }
  // Sincronizar selects de día con número de días actual
  refreshPreviewDayOptions(dias);
  // Renderizar también la vista tipo Excel (tabla editable)
  renderRutinaExcelView();
  // Si la vista avanzada está visible, refrescar su HTML
  const adv = document.getElementById('rutina-preview-excel-advanced');
  if(adv && adv.style.display !== 'none'){ renderRutinaSheetJSView(); }
  // Activar soporte táctil global de drag & drop (una sola vez)
  setupTouchDragDropFallback();
}

// Fallback móvil para drag & drop en elementos con atributo draggable
function setupTouchDragDropFallback(){
  try{
    if(window.__touchDragDropEnabled) return;
    window.__touchDragDropEnabled = true;
    const isTouchEnv = () => (navigator.maxTouchPoints||0) > 0 || /Mobi|Android/i.test(String(navigator.userAgent||''));
    if(!isTouchEnv()) return;

    let dragging = null; // { src, ghost, startX, startY, hasMoved, dataText }
    let lastOver = null;

    const onPointerDown = (ev) => {
      // Solo iniciar en entorno táctil y sobre elementos draggable
      if(ev.pointerType && ev.pointerType !== 'touch') return;
      const el = ev.target && ev.target.closest && ev.target.closest('[draggable="true"]');
      if(!el) return;

      // Datos de arrastre (genéricos)
      const dataText = String(
        el.getAttribute('data-index') ||
        el.getAttribute('data-eid') ||
        el.getAttribute('data-id') ||
        ''
      );

      // Para rutinas: preparar estado como en desktop
      const ejEid = el.getAttribute('data-eid');
      const ejDay = el.getAttribute('data-day');
      const ejOrder = el.getAttribute('data-order');
      if(ejEid){
        try{ window.state = window.state || {}; }catch(_){ }
        if(window.state){ window.state.dragEj = { eid: String(ejEid), fromDay: Number(ejDay||0)||null, order: Number(ejOrder||1)||1 }; }
      }

      const rect = el.getBoundingClientRect();
      const ghost = el.cloneNode(true);
      ghost.style.position = 'fixed';
      ghost.style.left = `${rect.left}px`;
      ghost.style.top = `${rect.top}px`;
      ghost.style.width = `${rect.width}px`;
      ghost.style.zIndex = '9999';
      ghost.style.pointerEvents = 'none';
      ghost.style.opacity = '0.95';
      ghost.style.transform = 'scale(0.98)';
      ghost.style.boxShadow = '0 12px 28px rgba(0,0,0,0.3)';
      document.body.appendChild(ghost);

      // Feedback háptico breve (si está disponible)
      try{ if(typeof navigator.vibrate==='function'){ navigator.vibrate(12); } }catch(_){ }

      dragging = { src: el, ghost, startX: ev.clientX, startY: ev.clientY, hasMoved: false, dataText };

      const onMove = (e) => {
        if(!dragging) return;
        const dx = e.clientX - dragging.startX, dy = e.clientY - dragging.startY;
        if(!dragging.hasMoved && Math.hypot(dx,dy) > 6){ dragging.hasMoved = true; }
        if(dragging.hasMoved){ e.preventDefault(); }
        // Seguir el dedo
        dragging.ghost.style.left = `${e.clientX - rect.width/2}px`;
        dragging.ghost.style.top = `${e.clientY - rect.height/2}px`;

        // Simular dragover para estilos existentes
        const overEl = document.elementFromPoint(e.clientX, e.clientY);
        if(lastOver && lastOver !== overEl){ try{ lastOver.dispatchEvent(new Event('dragleave', { bubbles:true })); }catch(_){ } }
        lastOver = overEl;
        if(overEl){ try{ overEl.dispatchEvent(new Event('dragover', { bubbles:true })); }catch(_){ }
          // Realzar listas de día si aplica
          const dayList = overEl.closest && overEl.closest('.day-list');
          if(dayList){ dayList.style.border='1px dashed #59a0ff'; dayList.style.borderRadius='6px'; }
        }
      };

      const onUp = (e) => {
        document.removeEventListener('pointermove', onMove, { passive:false });
        document.removeEventListener('pointerup', onUp);

        if(!dragging){ return; }
        // Si no hubo movimiento, dejar el click normal
        if(!dragging.hasMoved){ try{ dragging.ghost && dragging.ghost.remove(); }catch(_){ } dragging = null; return; }

        // Determinar objetivo y despachar drop con dataTransfer polifill
        const targetElRaw = document.elementFromPoint(e.clientX, e.clientY);
        const dropTarget = targetElRaw && targetElRaw.closest && (targetElRaw.closest('.ejercicio-tile') || targetElRaw.closest('.drop-top') || targetElRaw.closest('.day-list') || targetElRaw.closest('tr')) || targetElRaw;
        const evt = new Event('drop', { bubbles:true, cancelable:true });
        try{ evt.dataTransfer = { getData: () => String(dragging.dataText||''), setData: ()=>{} }; }catch(_){ }
        if(dropTarget){ try{ dropTarget.dispatchEvent(evt); }catch(_){ } }
        if(lastOver){ try{ lastOver.dispatchEvent(new Event('dragleave', { bubbles:true })); }catch(_){ } }

        try{ dragging.ghost && dragging.ghost.remove(); }catch(_){ }
        dragging = null; lastOver = null;

        // Limpiar estado de arrastre de rutina
        try{ if(window.state && window.state.dragEj){ window.state.dragEj = null; } }catch(_){ }
      };

      document.addEventListener('pointermove', onMove, { passive:false });
      document.addEventListener('pointerup', onUp, { passive:false });
    };

    document.addEventListener('pointerdown', onPointerDown, { passive:false });
  }catch(_){ /* noop */ }
}
    function clearRutinaDay(dia){
      const d = state.rutinaPreviewDraft || state.rutinaPreview || {};
      const ejs = Array.isArray(d.ejercicios) ? d.ejercicios : [];
      const remaining = ejs.filter(x => Number(x.dia_semana||1) !== Number(dia));
      d.ejercicios = remaining; state.rutinaPreviewDraft = d;
      markRutinaDirty(); renderRutinaPreview(); showToast(`Día ${dia} vaciado`, 'info', 1800);
    }
    function duplicateRutinaDay(dia){
      const d = state.rutinaPreviewDraft || state.rutinaPreview || {};
      const diasMax = Math.max(2, Math.min(5, Number(d.dias_semana||3)));
      const target = Math.min(diasMax, Number(dia)+1);
      if(target === Number(dia)){ showToast('No hay día destino para duplicar', 'warning', 2500); return; }
      const ejs = Array.isArray(d.ejercicios) ? d.ejercicios : [];
      const srcItems = ejs.filter(x => Number(x.dia_semana||1) === Number(dia));
      const destItems = ejs.filter(x => Number(x.dia_semana||1) === Number(target));
      if(destItems.length + srcItems.length > 8){ showToast('No se puede duplicar: supera 8 ejercicios', 'warning', 2800); return; }
      const baseOrder = destItems.length ? Math.max(...destItems.map(x => Number(x.orden||1))) : 0;
      const copies = srcItems.map((it, idx) => ({ ejercicio_id: Number(it.ejercicio_id), dia_semana: Number(target), series: (it.series!=null?it.series:3), repeticiones: (it.repeticiones!=null?it.repeticiones:10), orden: Number(baseOrder + idx + 1), ejercicio: it.ejercicio ? _deepCopy(it.ejercicio) : { id: Number(it.ejercicio_id) } }));
      d.ejercicios = ejs.concat(copies); state.rutinaPreviewDraft = d;
      markRutinaDirty(); renderRutinaPreview(); showToast(`Día ${dia} duplicado a Día ${target}`, 'success', 2000);
    }
function duplicateRutinaDayTo(srcDay, destDay){
      const d = state.rutinaPreviewDraft || state.rutinaPreview || {};
      const diasMax = Math.max(2, Math.min(5, Number(d.dias_semana||3)));
      const target = Math.max(1, Math.min(diasMax, Number(destDay||srcDay+1)));
      if(target === Number(srcDay)){ showToast('Elige un día distinto para duplicar', 'warning', 2500); return; }
      const ejs = Array.isArray(d.ejercicios) ? d.ejercicios : [];
      const srcItems = ejs.filter(x => Number(x.dia_semana||1) === Number(srcDay));
      const destItems = ejs.filter(x => Number(x.dia_semana||1) === Number(target));
      if(destItems.length + srcItems.length > 8){ showToast('No se puede duplicar: supera 8 ejercicios', 'warning', 2800); return; }
      const baseOrder = destItems.length ? Math.max(...destItems.map(x => Number(x.orden||1))) : 0;
      const copies = srcItems.map((it, idx) => ({ ejercicio_id: Number(it.ejercicio_id), dia_semana: Number(target), series: (it.series!=null?it.series:3), repeticiones: (it.repeticiones!=null?it.repeticiones:10), orden: Number(baseOrder + idx + 1), ejercicio: it.ejercicio ? _deepCopy(it.ejercicio) : { id: Number(it.ejercicio_id) } }));
      d.ejercicios = ejs.concat(copies); state.rutinaPreviewDraft = d;
      markRutinaDirty(); renderRutinaPreview(); showToast(`Día ${srcDay} duplicado a Día ${target}`, 'success', 2000);
}
function openDuplicateDayPopover(dia, anchor){
      try{ const prev = document.getElementById('rutina-dup-popover'); if(prev) prev.remove(); }catch(_){ }
      const d = state.rutinaPreviewDraft || state.rutinaPreview || {};
      const diasMax = Math.max(2, Math.min(5, Number(d.dias_semana||3)));
      const pop = document.createElement('div'); pop.id='rutina-dup-popover'; pop.style.position='absolute'; pop.style.background='#fff'; pop.style.border='1px solid #ddd'; pop.style.borderRadius='6px'; pop.style.padding='8px'; pop.style.boxShadow='0 4px 14px rgba(0,0,0,0.2)'; pop.style.zIndex='1001';
      const rect = anchor.getBoundingClientRect(); const modal = anchor.closest('.modal'); const mrect = modal ? modal.getBoundingClientRect() : {left:0, top:0};
      pop.style.left = `${rect.left - mrect.left + 8}px`; pop.style.top = `${rect.top - mrect.top + 20}px`;
      const sel = document.createElement('select'); sel.style.marginRight='8px'; for(let i=1;i<=diasMax;i++){ if(i===Number(dia)) continue; const opt=document.createElement('option'); opt.value=String(i); opt.textContent=`Día ${i}`; sel.appendChild(opt); }
      const ok = document.createElement('button'); ok.className='btn'; ok.textContent='Duplicar'; ok.onclick = () => { const dest = Number(sel.value||dia+1)||dia+1; duplicateRutinaDayTo(Number(dia), dest); try{ pop.remove(); }catch(_){ } };
      const cancel = document.createElement('button'); cancel.className='btn secondary'; cancel.textContent='Cancelar'; cancel.style.marginLeft='6px'; cancel.onclick = () => { try{ pop.remove(); }catch(_){ } };
      pop.appendChild(sel); pop.appendChild(ok); pop.appendChild(cancel);
      const cont = document.getElementById('modal-rutina-preview'); if(cont){ cont.appendChild(pop); } else { document.body.appendChild(pop); }
}
function toggleDayCollapse(dnum){
  state.rutinaDayCollapsed = state.rutinaDayCollapsed || {};
  state.rutinaDayCollapsed[Number(dnum)] = !state.rutinaDayCollapsed[Number(dnum)];
  renderRutinaPreview();
}
function refreshPreviewDayOptions(dias){
  const clampDias = Math.max(2, Math.min(5, Number(dias || 3)));
  const makeOpts = (sel) => {
    if(!sel) return;
    sel.innerHTML = '';
    for(let i=1;i<=clampDias;i++){ const opt=document.createElement('option'); opt.value=String(i); opt.textContent=`Día ${i}`; sel.appendChild(opt); }
  };
  makeOpts(document.getElementById('rutina-preview-dia'));
  makeOpts(document.getElementById('rutina-preview-float-dia'));
}
    function showRutinaPreviewFloat(item, anchor){
      const float = document.getElementById('rutina-preview-float'); if(!float) return;
      const rect = anchor.getBoundingClientRect(); const modal = float.closest('.modal'); const mrect = modal ? modal.getBoundingClientRect() : {left:0, top:0, width: (window.innerWidth||800), height: (window.innerHeight||600)};
      // Mostrar primero para medir dimensiones
      float.style.display = 'block';
      const fw = float.offsetWidth || 360; const fh = float.offsetHeight || 240;
      const mw = (mrect.width != null) ? mrect.width : (modal ? modal.clientWidth : 800);
      const mh = (mrect.height != null) ? mrect.height : (modal ? modal.clientHeight : 600);
      let x = (rect.left - mrect.left) + 8;
      let y = (rect.top - mrect.top) + 8;
      // Si se cortaría por abajo, intentar ubicar arriba del tile
      if(y + fh + 8 > mh){ y = (rect.top - mrect.top) - fh - 8; }
      // Clampeo para mantener dentro del modal
      const maxX = Math.max(8, mw - fw - 8);
      const maxY = Math.max(8, mh - fh - 8);
      x = Math.max(8, Math.min(x, maxX));
      y = Math.max(8, Math.min(y, maxY));
      float.style.left = `${x}px`; float.style.top = `${y}px`;
      const t = document.getElementById('rutina-preview-float-title'); if(t) t.textContent = (item.ejercicio && item.ejercicio.nombre) ? item.ejercicio.nombre : `Ejercicio ${item.ejercicio_id}`;
      const s = document.getElementById('rutina-preview-float-series'); if(s) s.value = (typeof item.series === 'string' ? '' : (item.series || ''));
      const r = document.getElementById('rutina-preview-float-reps'); if(r) r.value = (typeof item.repeticiones === 'string' ? '' : (item.repeticiones || ''));
      const o = document.getElementById('rutina-preview-float-orden'); if(o) o.value = item.orden || 1;
      const dsel = document.getElementById('rutina-preview-float-dia'); if(dsel) dsel.value = String(item.dia_semana || 1);
      const weeklyToggle = document.getElementById('rutina-preview-float-weekly');
      const singleWrap = document.getElementById('rutina-preview-float-single');
      const weeklyWrap = document.getElementById('rutina-preview-float-weekly-inputs');
      const weeks = Math.max(1, Math.min(4, Number((document.getElementById('rutina-preview-semanas')||{}).value || 4)));
      const sInputs = ['s1','s2','s3','s4'].map(id => document.getElementById(`rutina-preview-float-${id}`));
      const rInputs = ['r1','r2','r3','r4'].map(id => document.getElementById(`rutina-preview-float-${id}`));
      const S = typeof item.series === 'string' ? item.series.split(',').map(x=>String(x).trim()) : [];
      const R = typeof item.repeticiones === 'string' ? item.repeticiones.split(',').map(x=>String(x).trim()) : [];
      const hasWeekly = (S.length || R.length) > 0;
      if(weeklyToggle){ weeklyToggle.checked = hasWeekly; }
      if(singleWrap && weeklyWrap){ singleWrap.style.display = hasWeekly ? 'none' : '';
        weeklyWrap.style.display = hasWeekly ? 'block' : 'none'; }
      for(let i=0;i<4;i++){
        if(sInputs[i]){ sInputs[i].style.display = (i<weeks) ? '' : 'none'; sInputs[i].value = S[i] ? S[i] : ''; }
        if(rInputs[i]){ rInputs[i].style.display = (i<weeks) ? '' : 'none'; rInputs[i].value = R[i] ? R[i] : ''; }
      }
      if(weeklyToggle){ weeklyToggle.onchange = () => {
        const useWeekly = !!weeklyToggle.checked;
        if(singleWrap && weeklyWrap){ singleWrap.style.display = useWeekly ? 'none' : '';
          weeklyWrap.style.display = useWeekly ? 'block' : 'none'; }
      }; }
      float.dataset.eid = String(item.ejercicio_id);
      // Identidad exacta de la instancia para evitar editar otro duplicado
      try {
        float.dataset.srcDay = String(item.dia_semana || 1);
        float.dataset.srcOrder = String(item.orden || 0);
      } catch(_){ float.dataset.srcDay = String(item.dia_semana || 1); float.dataset.srcOrder = String(item.orden || 0); }
      // Cierre por click fuera del editor flotante (solo dentro del modal)
      try {
        const onOutsideClick = (ev) => {
          const tgt = ev.target;
          const isInside = float.contains(tgt);
          const isTile = !!(tgt && (tgt.closest && tgt.closest('.ejercicio-tile')));
          if(float.style.display === 'block' && !isInside && !isTile){ try{ applyRutinaPreviewFloat(true); }catch(_){ hideRutinaPreviewFloat(); } }
        };
        state._floatOutsideHandler && modal && modal.removeEventListener('mousedown', state._floatOutsideHandler);
        state._floatOutsideHandler = onOutsideClick;
        modal && modal.addEventListener('mousedown', onOutsideClick);
        // Cierre con Escape para accesibilidad
        const onKey = (ev) => { if(ev.key === 'Escape'){ try{ applyRutinaPreviewFloat(true); }catch(_){ hideRutinaPreviewFloat(); } } };
        state._floatKeyHandler && document.removeEventListener('keydown', state._floatKeyHandler);
        state._floatKeyHandler = onKey;
        document.addEventListener('keydown', onKey);
      } catch(_){ }
    }
    function hideRutinaPreviewFloat(){
      const float = document.getElementById('rutina-preview-float');
      if(float){
        float.style.display='none';
        float.dataset.eid='';
        try{
          const modal = float.closest('.modal');
          if(state._floatOutsideHandler && modal){ modal.removeEventListener('mousedown', state._floatOutsideHandler); }
          state._floatOutsideHandler = null;
          if(state._floatKeyHandler){ document.removeEventListener('keydown', state._floatKeyHandler); }
          state._floatKeyHandler = null;
        }catch(_){ }
      }

      // Cierre de modal Resumen
      const resumenCloseBtn = document.getElementById('rutina-resumen-close'); if(resumenCloseBtn) resumenCloseBtn.addEventListener('click', () => closeModal('modal-rutina-resumen'));
    }
    function applyRutinaPreviewFloat(silent){
      const float = document.getElementById('rutina-preview-float'); if(!float) return;
      const eid = float.dataset.eid; if(!eid) return;
      const srcDayF = Number(float.dataset.srcDay||1);
      const srcOrderF = Number(float.dataset.srcOrder||0);
      // Siempre tomar los valores semanales mostrados en el panel flotante
      // (los inputs individuales no existen en el DOM de esta vista)
      const weeks = Math.max(1, Math.min(4, Number((document.getElementById('rutina-preview-semanas')||{}).value || 4)));
      const sVals = [];
      const rVals = [];
      for(let i=1;i<=weeks;i++){
        const sVal = Math.max(1, Number((document.getElementById(`rutina-preview-float-s${i}`)||{}).value || 1));
        const rVal = Math.max(1, Number((document.getElementById(`rutina-preview-float-r${i}`)||{}).value || 1));
        sVals.push(String(sVal)); rVals.push(String(rVal));
      }
      const s = sVals.join(',');
      const r = rVals.join(',');
      const o = Math.max(1, Number((document.getElementById('rutina-preview-float-orden')||{}).value || 1));
  const dMax = Math.max(2, Math.min(5, Number((document.getElementById('rutina-preview-dias')||{}).value || 3)));
      let dsel = Number((document.getElementById('rutina-preview-float-dia')||{}).value || 1) || 1; dsel = Math.max(1, Math.min(dMax, dsel));
      const d = state.rutinaPreviewDraft || state.rutinaPreview || {};
      const ejs = Array.isArray(d.ejercicios) ? d.ejercicios : [];
      // Buscar la instancia exacta por id + día + orden
      let item = ejs.find(x => String(x.ejercicio_id) === String(eid) && Number(x.dia_semana||1) === srcDayF && Number(x.orden||0) === srcOrderF);
      if(!item){ if(!silent){ try{ showToast('No se encontró la instancia seleccionada', 'warning', 2000); }catch(_){ } } hideRutinaPreviewFloat(); return; }
      if(item){
        // Límite: máximo 8 ejercicios por día al mover
        const currentDay = Number(item.dia_semana||1);
        if(dsel !== currentDay){
          const destCount = ejs.filter(x => Number(x.dia_semana||1)===dsel && String(x.ejercicio_id)!==String(eid)).length;
          if(destCount >= 8){
            item.series = s; item.repeticiones = r; item.orden = o;
            showToast(`Día ${dsel} ya tiene 8 ejercicios. No se movió.`, 'warning', 2800);
          } else {
            item.series = s; item.repeticiones = r; item.orden = o; item.dia_semana = dsel;
          }
        } else {
          item.series = s; item.repeticiones = r; item.orden = o; item.dia_semana = dsel;
        }
      }
      markRutinaDirty(); renderRutinaPreview(); hideRutinaPreviewFloat(); if(!silent){ try{ showToast('Cambios aplicados', 'success', 1800); }catch(_){ } }
    }
    function removeRutinaPreviewItem(){
      const float = document.getElementById('rutina-preview-float'); if(!float) return;
      const eid = float.dataset.eid; if(!eid) return;
      const srcDayF = Number(float.dataset.srcDay||1);
      const srcOrderF = Number(float.dataset.srcOrder||0);
      const d = state.rutinaPreviewDraft || state.rutinaPreview || {};
      let ejs = Array.isArray(d.ejercicios) ? d.ejercicios : [];
      // Eliminar sólo la instancia exacta
      ejs = ejs.filter(x => !(String(x.ejercicio_id) === String(eid) && Number(x.dia_semana||1) === srcDayF && Number(x.orden||0) === srcOrderF));
      d.ejercicios = ejs; state.rutinaPreviewDraft = d;
      markRutinaDirty(); renderRutinaPreview(); hideRutinaPreviewFloat();
    }
    function duplicateRutinaPreviewItem(){
      const float = document.getElementById('rutina-preview-float'); if(!float) return;
      const eid = float.dataset.eid; if(!eid) return;
      const srcDayF = Number(float.dataset.srcDay||1);
      const srcOrderF = Number(float.dataset.srcOrder||0);
      const dsel = Number((document.getElementById('rutina-preview-float-dia')||{}).value || 1) || 1;
      const d = state.rutinaPreviewDraft || state.rutinaPreview || {};
      const ejs = Array.isArray(d.ejercicios) ? d.ejercicios : [];
      const src = ejs.find(x => String(x.ejercicio_id) === String(eid) && Number(x.dia_semana||1) === srcDayF && Number(x.orden||0) === srcOrderF); if(!src){ try{ showToast('No se encontró la instancia seleccionada', 'warning', 2000); }catch(_){ } return; }
      const dayItems = ejs.filter(x => Number(x.dia_semana||1) === Number(dsel));
      if(dayItems.length >= 8){ showToast('Máximo 8 ejercicios por día', 'warning', 2500); return; }
      const maxOrder = dayItems.length ? Math.max(...dayItems.map(x => Number(x.orden||1))) : 0;
      const copy = { ejercicio_id: Number(src.ejercicio_id), dia_semana: Number(dsel), series: (src.series!=null?src.series:3), repeticiones: (src.repeticiones!=null?src.repeticiones:10), orden: Number(maxOrder+1), ejercicio: src.ejercicio ? _deepCopy(src.ejercicio) : { id: Number(src.ejercicio_id) } };
      ejs.push(copy); d.ejercicios = ejs; state.rutinaPreviewDraft = d; markRutinaDirty(); renderRutinaPreview(); showToast('Ejercicio duplicado', 'success', 1800);
    }
    function reorderRutinaPreviewItem(direction){
      const float = document.getElementById('rutina-preview-float'); if(!float) return;
      const eid = float.dataset.eid; if(!eid) return;
      const srcDayF = Number(float.dataset.srcDay||1);
      const srcOrderF = Number(float.dataset.srcOrder||0);
      const d = state.rutinaPreviewDraft || state.rutinaPreview || {};
      const ejs = Array.isArray(d.ejercicios) ? d.ejercicios : [];
      const item = ejs.find(x => String(x.ejercicio_id) === String(eid) && Number(x.dia_semana||1) === srcDayF && Number(x.orden||0) === srcOrderF); if(!item){ try{ showToast('No se encontró la instancia seleccionada', 'warning', 2000); }catch(_){ } return; }
      const day = Number(item.dia_semana||1);
      const dayItems = ejs.filter(x => Number(x.dia_semana||1) === day).sort((a,b) => Number(a.orden||1) - Number(b.orden||1));
      const idx = dayItems.findIndex(x => String(x.ejercicio_id) === String(eid) && Number(x.orden||1) === Number(item.orden||1)); if(idx < 0) return;
      if(direction === 'up' && idx > 0){ const tmp = dayItems[idx-1]; dayItems[idx-1] = dayItems[idx]; dayItems[idx] = tmp; }
      if(direction === 'down' && idx < dayItems.length - 1){ const tmp = dayItems[idx+1]; dayItems[idx+1] = dayItems[idx]; dayItems[idx] = tmp; }
      // Reindex orders
      dayItems.forEach((x,i) => { x.orden = i+1; });
      d.ejercicios = ejs; state.rutinaPreviewDraft = d; markRutinaDirty(); renderRutinaPreview(); showToast('Orden actualizado', 'info', 1500);
    }
function moveOrReorderEjercicio(eid, toDay, beforeEid){
  const d = state.rutinaPreviewDraft || state.rutinaPreview || {};
  let ejs = Array.isArray(d.ejercicios) ? d.ejercicios : [];
  const drag = state.dragEj || {};
  const bulk = state.bulkMoveHint || {};
  const srcDayHint = Number((drag.fromDay != null ? drag.fromDay : bulk.fromDay) || 0) || null;
  const srcOrderHint = Number((drag.order != null ? drag.order : bulk.order) || 0) || null;
  let src = ejs.find(x => String(x.ejercicio_id) === String(eid) && (srcDayHint==null || Number(x.dia_semana||1)===srcDayHint) && (srcOrderHint==null || Number(x.orden||0)===srcOrderHint));
  if(!src){ src = ejs.find(x => String(x.ejercicio_id) === String(eid)); }
  if(!src) return;
  const fromDay = Number(src.dia_semana||1);
  const tDay = Number(toDay||fromDay) || fromDay;
  // Si se suelta en el mismo día, solo reordenar dentro del día sin duplicar listas
  if(fromDay === tDay){
    const dayList = ejs.filter(x => Number(x.dia_semana||1)===fromDay && x !== src);
    let insertIndex = -1;
    if(String(beforeEid) === '__TOP__'){ insertIndex = 0; }
    else if(beforeEid != null){
      const parts = String(beforeEid).split('#');
      const beid = parts[0]; const bord = parts[1] != null ? Number(parts[1]) : null;
      insertIndex = dayList.findIndex(x => String(x.ejercicio_id) === String(beid) && (bord==null || Number(x.orden||0)===bord));
    }
    src.dia_semana = fromDay;
    if(insertIndex >= 0){ dayList.splice(insertIndex, 0, src); } else { dayList.push(src); }
    dayList.forEach((x,i)=>{ x.orden = i+1; x.dia_semana = fromDay; });
    const others = ejs.filter(x => Number(x.dia_semana||1)!==fromDay);
    d.ejercicios = others.concat(dayList);
    state.rutinaPreviewDraft = d; markRutinaDirty(); renderRutinaPreview(); showToast('Ejercicio reordenado', 'success', 1500);
    return;
  }
  const fromList = ejs.filter(x => Number(x.dia_semana||1)===fromDay && x !== src);
  const toList = ejs.filter(x => Number(x.dia_semana||1)===tDay);
  const others = ejs.filter(x => Number(x.dia_semana||1)!==fromDay && Number(x.dia_semana||1)!==tDay);
  // Límite de 8 por día al mover entre días
  if(fromDay !== tDay && toList.length >= 8){ showToast('Máximo 8 ejercicios por día', 'warning', 2500); return; }
  let insertIndex = -1;
  if(String(beforeEid) === '__TOP__'){ insertIndex = 0; }
  else if(beforeEid != null){
    const parts = String(beforeEid).split('#');
    const beid = parts[0]; const bord = parts[1] != null ? Number(parts[1]) : null;
    insertIndex = toList.findIndex(x => String(x.ejercicio_id) === String(beid) && (bord==null || Number(x.orden||0)===bord));
  }
  src.dia_semana = tDay;
  if(insertIndex >= 0){ toList.splice(insertIndex, 0, src); } else { toList.push(src); }
  fromList.forEach((x,i)=>{ x.orden = i+1; x.dia_semana = fromDay; });
  toList.forEach((x,i)=>{ x.orden = i+1; x.dia_semana = tDay; });
  d.ejercicios = others.concat(fromList).concat(toList);
  state.rutinaPreviewDraft = d; markRutinaDirty(); renderRutinaPreview(); showToast('Ejercicio movido', 'success', 1500);
}

function bulkMoveSelected(destDay){
  const d = state.rutinaPreviewDraft || state.rutinaPreview || {};
  const keys = Array.isArray(state.rutinaSelected) ? state.rutinaSelected.map(String) : [];
  const ejs = Array.isArray(d.ejercicios)? d.ejercicios: [];
  const destItems = ejs.filter(x => Number(x.dia_semana||1) === Number(destDay));
  if(destItems.length + keys.length > 8){ showToast('No se puede mover: supera 8 ejercicios', 'warning', 2800); return; }
  keys.forEach(k => {
    const parts = String(k).split('#');
    const eid = parts[0]; const sday = parts[1] != null ? Number(parts[1]) : null; const sorder = parts[2] != null ? Number(parts[2]) : null;
    state.bulkMoveHint = { fromDay: sday, order: sorder };
    moveOrReorderEjercicio(String(eid), Number(destDay), null);
    state.bulkMoveHint = null;
  });
  markRutinaDirty(); renderRutinaPreview(); showToast('Seleccionados movidos', 'success', 1800);
}
function bulkDuplicateSelected(destDay){
  const d = state.rutinaPreviewDraft || state.rutinaPreview || {};
  const ejs = Array.isArray(d.ejercicios)? d.ejercicios: [];
  const ids = new Set(Array.isArray(state.rutinaSelected) ? state.rutinaSelected.map(String) : []);
  const destItems = ejs.filter(x => Number(x.dia_semana||1) === Number(destDay));
  let baseOrder = destItems.length ? Math.max(...destItems.map(x => Number(x.orden||1))) : 0;
  const toCopy = ejs.filter(x => ids.has(`${String(x.ejercicio_id)}#${Number(x.dia_semana||1)}#${Number(x.orden||1)}`));
  if(destItems.length + toCopy.length > 8){ showToast('No se puede duplicar: supera 8 ejercicios', 'warning', 2800); return; }
  toCopy.forEach((src) => {
    const copy = { ejercicio_id: Number(src.ejercicio_id), dia_semana: Number(destDay), series: (src.series!=null?src.series:3), repeticiones: (src.repeticiones!=null?src.repeticiones:10), orden: Number(++baseOrder), ejercicio: src.ejercicio ? _deepCopy(src.ejercicio) : { id: Number(src.ejercicio_id) } };
    ejs.push(copy);
  });
  d.ejercicios = ejs; state.rutinaPreviewDraft = d;
  markRutinaDirty(); renderRutinaPreview(); showToast('Seleccionados duplicados', 'success', 1800);
}
function bulkDeleteSelected(){
  const d = state.rutinaPreviewDraft || state.rutinaPreview || {};
  let ejs = Array.isArray(d.ejercicios)? d.ejercicios: [];
  const ids = new Set(Array.isArray(state.rutinaSelected) ? state.rutinaSelected.map(String) : []);
  ejs = ejs.filter(x => !ids.has(`${String(x.ejercicio_id)}#${Number(x.dia_semana||1)}#${Number(x.orden||1)}`));
  d.ejercicios = ejs; state.rutinaPreviewDraft = d; state.rutinaSelected = [];
  markRutinaDirty(); renderRutinaPreview(); showToast('Seleccionados eliminados', 'info', 1800);
}
function openBulkDayPopover(kind, anchor){
  try{ const prev = document.getElementById('rutina-bulk-popover'); if(prev) prev.remove(); }catch(_){ }
  const d = state.rutinaPreviewDraft || state.rutinaPreview || {};
  const diasMax = Math.max(2, Math.min(5, Number(d.dias_semana||3)));
  const pop = document.createElement('div'); pop.id='rutina-bulk-popover'; pop.style.position='absolute'; pop.style.background='#fff'; pop.style.border='1px solid #ddd'; pop.style.borderRadius='6px'; pop.style.padding='8px'; pop.style.boxShadow='0 4px 14px rgba(0,0,0,0.2)'; pop.style.zIndex='1001';
  const rect = anchor.getBoundingClientRect(); const modal = anchor.closest('.modal'); const mrect = modal ? modal.getBoundingClientRect() : {left:0, top:0};
  pop.style.left = `${rect.left - mrect.left + 8}px`; pop.style.top = `${rect.top - mrect.top + 20}px`;
  const sel = document.createElement('select'); sel.style.marginRight='8px'; for(let i=1;i<=diasMax;i++){ const opt=document.createElement('option'); opt.value=String(i); opt.textContent=`Día ${i}`; sel.appendChild(opt); }
  const ok = document.createElement('button'); ok.className='btn'; ok.textContent= kind==='move' ? 'Mover' : 'Duplicar'; ok.onclick = () => { const dest = Number(sel.value||1)||1; if(kind==='move') bulkMoveSelected(dest); else bulkDuplicateSelected(dest); try{ pop.remove(); }catch(_){ } };
  const cancel = document.createElement('button'); cancel.className='btn secondary'; cancel.textContent='Cancelar'; cancel.style.marginLeft='6px'; cancel.onclick = () => { try{ pop.remove(); }catch(_){ } };
  pop.appendChild(sel); pop.appendChild(ok); pop.appendChild(cancel);
  const cont = document.getElementById('modal-rutina-preview'); if(cont){ cont.appendChild(pop); } else { document.body.appendChild(pop); }
}

function markRutinaDirty(){
  state.rutinaPreviewDirty = true;
  try{ const st = document.getElementById('rutina-preview-status'); if(st) st.textContent = 'Editado'; }catch(_){ }
  try { if(state.rutinaAutoSaveImmediateTimer){ clearTimeout(state.rutinaAutoSaveImmediateTimer); } } catch(_){ }
  try {
    state.rutinaAutoSaveImmediateTimer = setTimeout(() => { try{ autoSaveRutinaDraft(); }catch(_){ } }, 800);
  } catch(_){ }
}
function ensureRutinaAutoSave(){
  try{ if(state.rutinaAutoSaveTimer) return; }catch(_){ }
  state.rutinaAutoSaveTimer = setInterval(autoSaveRutinaDraft, 5000);
}
function stopRutinaAutoSave(){ try{ if(state.rutinaAutoSaveTimer){ clearInterval(state.rutinaAutoSaveTimer); state.rutinaAutoSaveTimer = null; } }catch(_){ } }
async function autoSaveRutinaDraft(){
  try{
    if(!state.rutinaPreviewDirty) return;
    const d = state.rutinaPreviewDraft || state.rutinaPreview || {};
    if(!d || !d.id) return; // solo auto-guardar para rutinas existentes
    try{ const st = document.getElementById('rutina-preview-status'); if(st) st.textContent = 'Guardando…'; }catch(_){ }
    const payload = {
      nombre_rutina: (document.getElementById('rutina-preview-nombre')||{}).value || (d.nombre_rutina||''),
      descripcion: (document.getElementById('rutina-preview-descripcion')||{}).value || d.descripcion || null,
  dias_semana: Math.max(2, Math.min(5, Number((document.getElementById('rutina-preview-dias')||{}).value || d.dias_semana || 3))),
      categoria: d.categoria || 'general',
      ejercicios: (Array.isArray(d.ejercicios)? d.ejercicios: []).map(x => ({ ejercicio_id: Number(x.ejercicio_id), dia_semana: Number(x.dia_semana||1), series: x.series, repeticiones: x.repeticiones, orden: Number(x.orden||1) }))
    };
    const putRes = await fetch(`/api/rutinas/${d.id}`, { method:'PUT', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(payload) });
    if(putRes.ok){
      state.rutinaPreviewDirty = false; state.lastAutoSaveTs = Date.now();
      try{ const st = document.getElementById('rutina-preview-status'); if(st) st.textContent = 'Guardado'; }catch(_){ }
      try{ updateRutinaPDFPreview(); }catch(_){ }
    } else {
      try{ const st = document.getElementById('rutina-preview-status'); if(st) st.textContent = 'Error al guardar'; }catch(_){ }
    }
  }catch(_){ /* silencioso */ }
}

// Descarga directa de Excel desde la vista previa (sin modal)
async function directExportExcelFromPreview(){
  try{
    const d = state.rutinaPreviewDraft || state.rutinaPreview || {};
  const payload = {
      nombre_rutina: (document.getElementById('rutina-preview-nombre')||{}).value || (d.nombre_rutina||''),
      descripcion: (document.getElementById('rutina-preview-descripcion')||{}).value || d.descripcion || null,
  dias_semana: Math.max(2, Math.min(5, Number((document.getElementById('rutina-preview-dias')||{}).value || d.dias_semana || 3))),
      categoria: d.categoria || 'general',
      usuario_id: (typeof d.usuario_id !== 'undefined' ? d.usuario_id : null),
      usuario_nombre_override: ((document.getElementById('rutina-preview-usuario-nombre')||{}).value || '').trim() || null,
      ejercicios: (Array.isArray(d.ejercicios)? d.ejercicios: []).map(x => ({
        ejercicio_id: Number(x.ejercicio_id),
        dia_semana: Number(x.dia_semana||1),
        series: x.series,
        repeticiones: x.repeticiones,
        orden: Number(x.orden||1),
        nombre_ejercicio: (
          x.nombre_ejercicio
          || ((x.ejercicio||{}).nombre)
          || (((state.ejercicios||[]).find(e => String(e.id) === String(x.ejercicio_id))||{}).nombre)
          || null
        )
      }))
    };
    const weeks = Math.max(1, Math.min(4, Number((document.getElementById('rutina-preview-semanas')||{}).value || 4)));
  const diasCount = Math.max(2, Math.min(5, Number((document.getElementById('rutina-preview-dias')||{}).value || d.dias_semana || 3)));
    const nombreRutinaSafe = ((document.getElementById('rutina-preview-nombre')||{}).value || d.nombre_rutina || d.nombre || 'rutina');
    const usuarioNombreFull = (((document.getElementById('rutina-preview-usuario-nombre')||{}).value || '').trim());
    const dateStr = (() => { const dt = new Date(); const dd = String(dt.getDate()).padStart(2,'0'); const mm = String(dt.getMonth()+1).padStart(2,'0'); const yy = String(dt.getFullYear()); return `${dd}-${mm}-${yy}`; })();
    const segs = ['rutina', nombreRutinaSafe, `${diasCount}-dias`];
    if (usuarioNombreFull) segs.push(usuarioNombreFull);
    segs.push(dateStr);
    let xlsxName = segs.join('_') + '.xlsx';
    try { xlsxName = String(xlsxName).replace(/\s+/g,'_').replace(/[\\/:*?"<>|]+/g, '_').slice(0,150); } catch(_) {}
    let urlSignedRes;
    const qrModeDefault = ((document.getElementById('preview-qr-placement')||{}).value || 'inline');
    const sheetDefault = (((document.getElementById('preview-sheet-name')||{}).value || '').trim() || '');
    if (d && d.id) {
      const qs = new URLSearchParams({ weeks: String(weeks), filename: xlsxName, qr_mode: qrModeDefault, sheet: sheetDefault });
      urlSignedRes = await fetch(`/api/rutinas/${encodeURIComponent(String(d.id))}/export/excel_view_url?` + qs.toString(), { method:'GET', headers:{ 'Accept':'application/json' } });
    } else {
      urlSignedRes = await fetch(`/api/rutinas/preview/excel_view_url?weeks=${encodeURIComponent(String(weeks))}&filename=${encodeURIComponent(xlsxName)}&qr_mode=${encodeURIComponent(String(qrModeDefault))}&sheet=${encodeURIComponent(String(sheetDefault))}`, { method:'POST', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(payload) });
    }
    const urlSignedData = await urlSignedRes.json().catch(()=>({}));
    if(urlSignedRes.status === 401){ showToast('Acceso restringido; inicie sesión en Gestión.', 'error', 4500); try{ window.location.href='/gestion/login'; }catch(e){} return; }
    if(!urlSignedRes.ok || !urlSignedData.url){ let msg = urlSignedData.detail || urlSignedData.error || `Error ${urlSignedRes.status}`; showToast(msg, 'error', 4500); return; }
    const r = await fetch(String(urlSignedData.url));
    if(!r.ok){ let msg = `Error ${r.status}`; try{ const err = await r.json(); msg = err.detail || err.error || msg; }catch(_){ } showToast(msg, 'error', 4500); return; }
    const blob = await r.blob();
    let downloadName = xlsxName;
    try { downloadName = String(downloadName).replace(/[\\/:*?"<>|]+/g, '_'); } catch(_) {}
    const dlUrl = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = dlUrl; a.download = downloadName; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(dlUrl);
    showToast('Excel descargado', 'success', 2500);
  }catch(_){ showToast('No se pudo exportar Excel', 'error', 4500); }
}

// Previsualización integrada mediante Google Drive Viewer (XLSX inline)
async function updateRutinaPDFPreview(){
  try{
    const cont = document.getElementById('rutina-preview-pdf'); const frame = document.getElementById('rutina-preview-frame'); const empty = document.getElementById('rutina-preview-pdf-empty'); const statusEl = document.getElementById('rutina-preview-pdf-status');
    if(!cont || !frame || !empty) return;
    const d = state.rutinaPreviewDraft || state.rutinaPreview || {};
  const payload = {
      nombre_rutina: (document.getElementById('rutina-preview-nombre')||{}).value || (d.nombre_rutina||''),
      descripcion: (document.getElementById('rutina-preview-descripcion')||{}).value || d.descripcion || null,
  dias_semana: Math.max(2, Math.min(5, Number((document.getElementById('rutina-preview-dias')||{}).value || d.dias_semana || 3))),
      categoria: d.categoria || 'general',
      usuario_id: (typeof d.usuario_id !== 'undefined' ? d.usuario_id : null),
      usuario_nombre_override: ((document.getElementById('rutina-preview-usuario-nombre')||{}).value || '').trim() || null,
      ejercicios: (Array.isArray(d.ejercicios)? d.ejercicios: []).map(x => ({
        ejercicio_id: Number(x.ejercicio_id),
        dia_semana: Number(x.dia_semana||1),
        series: x.series,
        repeticiones: x.repeticiones,
        orden: Number(x.orden||1),
        nombre_ejercicio: (
          x.nombre_ejercicio
          || ((x.ejercicio||{}).nombre)
          || (((state.ejercicios||[]).find(e => String(e.id) === String(x.ejercicio_id))||{}).nombre)
          || null
        )
      }))
    };
    const weeks = Math.max(1, Math.min(4, Number((document.getElementById('rutina-preview-semanas')||{}).value || 4)));
  const diasCount = Math.max(2, Math.min(5, Number((document.getElementById('rutina-preview-dias')||{}).value || d.dias_semana || 3)));
    const nombreRutinaSafe = ((document.getElementById('rutina-preview-nombre')||{}).value || d.nombre_rutina || d.nombre || 'rutina');
    const usuarioNombreFull = (((document.getElementById('rutina-preview-usuario-nombre')||{}).value || '').trim());
    const dateStr = (() => { const dt = new Date(); const dd = String(dt.getDate()).padStart(2,'0'); const mm = String(dt.getMonth()+1).padStart(2,'0'); const yy = String(dt.getFullYear()); return `${dd}-${mm}-${yy}`; })();
    const segs = ['rutina', nombreRutinaSafe, `${diasCount}-dias`];
    if (usuarioNombreFull) segs.push(usuarioNombreFull);
    segs.push(dateStr);
    let xlsxName = segs.join('_') + '.xlsx';
    try { xlsxName = String(xlsxName).replace(/\s+/g,'_').replace(/[\\/:*?"<>|]+/g, '_').slice(0,150); } catch(_) {}
    const qrPlacement = ((document.getElementById('preview-qr-placement')||{}).value || 'inline');
    const sheetName = (((document.getElementById('preview-sheet-name')||{}).value || '').trim() || '');
    async function makeViewerSrc(sheetArg){
      let res;
      if(d && d.id){
        const qs = new URLSearchParams({ weeks: String(weeks), filename: xlsxName, qr_mode: qrPlacement, sheet: sheetArg });
        res = await fetch(`/api/rutinas/${encodeURIComponent(String(d.id))}/export/excel_view_url?` + qs.toString(), { method:'GET', headers:{ 'Accept':'application/json' } });
      } else {
        res = await fetch(`/api/rutinas/preview/excel_view_url?weeks=${encodeURIComponent(String(weeks))}&filename=${encodeURIComponent(xlsxName)}&qr_mode=${encodeURIComponent(String(qrPlacement))}&sheet=${encodeURIComponent(String(sheetArg||''))}`, { method:'POST', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(payload) });
      }
      const data = await res.json().catch(()=>({}));
      if(res.status === 401){ showToast('Acceso restringido; inicie sesión en Gestión.', 'error', 4500); try{ window.location.href='/gestion/login'; }catch(e){} return null; }
      if(!res.ok || !data.url){ let msg = data.detail || data.error || `Error ${res.status}`; showToast(msg, 'error', 4500); if(empty && frame){ empty.style.display='block'; frame.style.display='none'; } return null; }
      let signed = String(data.url || "");
      try { signed = signed.replace(/([^:])\/\/+/, "$1/"); } catch(_) {}
      return `https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(signed)}`;
    }
    let cache = { sheet: null, qr: null };
    if(String(qrPlacement).toLowerCase() === 'inline'){
      cache.sheet = await makeViewerSrc('Sheet');
      cache.qr = await makeViewerSrc('QR');
    } else {
      const current = await makeViewerSrc(sheetName || 'Sheet');
      cache.sheet = current;
    }
    state.rutinaPreviewSrcCache = cache;
    empty.style.display='none';
    if(statusEl){ statusEl.textContent = 'Actualizando vista previa…'; statusEl.style.display='block'; }
    frame.style.display='block';
    try{ frame.onload = () => { try{ if(statusEl){ statusEl.textContent = 'Vista previa actualizada'; setTimeout(() => { statusEl.style.display='none'; }, 900); } }catch(_){ } }; }catch(_){ }
    const pick = (() => { const v = (sheetName||'').trim().toLowerCase(); if(v === 'qr' && cache.qr){ return cache.qr; } return cache.sheet; })();
    if(pick){ frame.src = pick; }
  // Adjuntar zoom con rueda
  try{ attachWheelZoom('rutina-preview-pdf', 'rutina-preview-frame'); }catch(_){ }
  // Asegurar controles flotantes de zoom
  try{ ensurePdfZoomControls('rutina-preview-pdf', 'rutina-preview-frame'); }catch(_){ }
  // Enganchar eventos de controles flotantes
  try{ ensureFloatingPreviewControls(); }catch(_){ }
}catch(_){ const empty = document.getElementById('rutina-preview-pdf-empty'); const frame = document.getElementById('rutina-preview-frame'); if(empty && frame){ empty.style.display='block'; frame.style.display='none'; } }
}

// Controles flotantes: wiring de eventos y navegación de hojas rápidas
function ensureFloatingPreviewControls(){
  const sheetInput = document.getElementById('preview-sheet-name');
  const qrSel = document.getElementById('preview-qr-placement');
  const prevBtn = document.getElementById('preview-sheet-prev');
  const nextBtn = document.getElementById('preview-sheet-next');
  const cycle = ['Sheet','QR'];
  if(sheetInput){ sheetInput.oninput = () => { try{ const v = String(sheetInput.value||'').trim().toLowerCase(); const frame = document.getElementById('rutina-preview-frame'); if(v === 'qr'){ if(qrSel){ qrSel.value = 'inline'; } if(state.rutinaPreviewSrcCache && state.rutinaPreviewSrcCache.qr && frame){ frame.src = state.rutinaPreviewSrcCache.qr; return; } } if(v === 'sheet'){ if(state.rutinaPreviewSrcCache && state.rutinaPreviewSrcCache.sheet && frame){ frame.src = state.rutinaPreviewSrcCache.sheet; return; } } updateRutinaPDFPreview(); }catch(_){ } }; }
  if(qrSel){ qrSel.onchange = () => { try{ updateRutinaPDFPreview(); }catch(_){ } }; }
  function step(dir){
    try{
      const curr = (sheetInput && sheetInput.value ? String(sheetInput.value).trim() : '');
      let idx = cycle.findIndex(n => n.toLowerCase() === curr.toLowerCase());
      if(idx < 0){ idx = 0; }
      idx = (idx + (dir<0 ? -1 : 1) + cycle.length) % cycle.length;
      const nextVal = cycle[idx];
      if(sheetInput){ sheetInput.value = nextVal; }
      const frame = document.getElementById('rutina-preview-frame');
      if(nextVal.toLowerCase() === 'qr'){ if(qrSel){ qrSel.value = 'inline'; } if(state.rutinaPreviewSrcCache && state.rutinaPreviewSrcCache.qr && frame){ frame.src = state.rutinaPreviewSrcCache.qr; return; } }
      if(state.rutinaPreviewSrcCache && state.rutinaPreviewSrcCache.sheet && frame){ frame.src = state.rutinaPreviewSrcCache.sheet; return; }
      updateRutinaPDFPreview();
    }catch(_){ }
  }
  if(prevBtn){ prevBtn.onclick = () => step(-1); }
  if(nextBtn){ nextBtn.onclick = () => step(1); }
}
// Zoom con rueda para iframes PDF (aplica escala CSS al iframe)
function attachWheelZoom(containerId, frameId){
  try {
    const cont = document.getElementById(containerId);
    const frame = document.getElementById(frameId);
    if(!cont || !frame) return;
    // Asegurar comportamiento correcto
    cont.style.overflow = cont.style.overflow || 'auto';
    frame.style.transformOrigin = frame.style.transformOrigin || 'center top';
    if(!state._wheelZoom) state._wheelZoom = {};
    if(!state._wheelZoomBound) state._wheelZoomBound = new Set();
    if(!state._wheelZoom[frameId]) state._wheelZoom[frameId] = { scale: 1.0 };
    if(state._wheelZoomBound.has(frameId)) return;
    const zoom = state._wheelZoom[frameId];
    const minScale = (containerId === 'rutina-preview-pdf' ? 1.0 : 0.5);
    cont.addEventListener('wheel', (ev) => {
      try {
        if(ev.ctrlKey) return; // Mantener zoom nativo del navegador con Ctrl
        ev.preventDefault();
        const delta = ev.deltaY < 0 ? 0.1 : -0.1;
        const next = Math.max(minScale, Math.min(3.0, (zoom.scale || 1.0) + delta));
        zoom.scale = next;
        const rect = cont.getBoundingClientRect();
        const ox = (ev.clientX - rect.left);
        const oy = (ev.clientY - rect.top);
        frame.style.transformOrigin = `${ox}px ${oy}px`;
        frame.style.transform = `scale(${zoom.scale})`;
      } catch(_){ /* noop */ }
    }, { passive: false });
    state._wheelZoomBound.add(frameId);
  } catch(_){ }
}
// Controles flotantes para zoom del visor de Excel (iframe)
function ensurePdfZoomControls(containerId, frameId){
  try{
    const cont = document.getElementById(containerId);
    const frame = document.getElementById(frameId);
    if(!cont || !frame) return;
    try{ const pos = window.getComputedStyle(cont).position; if(!pos || pos === 'static'){ cont.style.position = 'relative'; } }catch(_){ cont.style.position = 'relative'; }
    // Inyectar estilos profesionales y responsivos una sola vez
    let styleTag = document.getElementById('rutina-preview-zoom-css');
    if(!styleTag){
      styleTag = document.createElement('style');
      styleTag.id = 'rutina-preview-zoom-css';
      styleTag.textContent = `
        #rutina-preview-pdf{ position:relative; }
        #rutina-preview-zoom-controls{ position:absolute; top:12px; left:50%; transform: translateX(-50%); display:flex; align-items:center; gap:8px; padding:6px; border-radius:999px; border:1px solid var(--info); background: rgba(139,120,185,0.12); backdrop-filter: blur(6px); box-shadow: var(--shadow-md); z-index: 9999; }
        #rutina-preview-zoom-controls .btn{ padding:8px 12px; border-radius:999px; }
        #rutina-preview-zoom-controls .btn .icon{ font-weight:700; }
        #rutina-preview-zoom-controls .btn .label{ font-weight:600; }
        #rutina-preview-zoom-controls .menu-panel{ position:absolute; top:calc(100% + 8px); left:50%; transform: translateX(-50%); min-width:220px; display:none; padding:8px; border-radius:12px; border:1px solid var(--info); background: rgba(139,120,185,0.18); backdrop-filter: blur(8px); box-shadow: var(--shadow-md); }
        #rutina-preview-zoom-controls .menu-panel[data-open="true"]{ display:flex; flex-direction:column; gap:8px; }
        #rutina-preview-zoom-controls .menu-panel .btn{ width:100%; border-radius:8px; }
        #rutina-preview-zoom-controls .menu-panel .btn .label{ display:inline; }
        @media (max-width: 720px){
          #rutina-preview-zoom-controls{ top:8px; left:50%; transform: translateX(-50%); padding:4px; gap:6px; }
          #rutina-preview-zoom-controls .btn{ width:36px; height:36px; padding:0; }
          #rutina-preview-zoom-controls .btn .label{ display:none; }
          #rutina-preview-zoom-controls .menu-panel{ min-width:180px; }
          #rutina-preview-zoom-controls .menu-panel .btn{ width:100%; height:auto; padding:6px 10px; }
          #rutina-preview-zoom-controls .menu-panel .btn .label{ display:inline; }
        }
      `;
      document.head.appendChild(styleTag);
    }
    let fab = document.getElementById('rutina-preview-zoom-controls');
    if(!fab){
      fab = document.createElement('div');
      fab.id = 'rutina-preview-zoom-controls';
      fab.setAttribute('role','toolbar');
      fab.setAttribute('aria-label','Controles de zoom');
      const mkBtn = (iconText, labelText, aria, onClick) => {
        const b = document.createElement('button');
        b.type = 'button';
        b.className = 'btn info sm';
        b.setAttribute('aria-label', aria);
        b.title = aria;
        const icon = document.createElement('span'); icon.className = 'icon'; icon.textContent = iconText;
        const label = document.createElement('span'); label.className = 'label'; label.textContent = labelText;
        b.appendChild(icon); b.appendChild(label);
        b.onclick = onClick;
        return b;
      };
      const getZoom = () => {
        if(!state._wheelZoom) state._wheelZoom = {};
        if(!state._wheelZoom[frameId]) state._wheelZoom[frameId] = { scale: 1.0 };
        return state._wheelZoom[frameId];
      };
      const applyScale = (scale) => {
        const z = getZoom();
        z.scale = Math.max(0.25, Math.min(3.0, scale));
        frame.style.transform = `scale(${z.scale})`;
        frame.style.transformOrigin = 'center top';
      };
      const btnMinus = mkBtn('−', 'Zoom', 'Disminuir zoom', () => { const z = getZoom(); applyScale((z.scale||1.0) - 0.1); });
      const btnPlus  = mkBtn('+', 'Zoom', 'Aumentar zoom', () => { const z = getZoom(); applyScale((z.scale||1.0) + 0.1); });
      const btnReset = mkBtn('⟲', 'Reset', 'Restablecer zoom', () => { applyScale(1.0); });
      btnMinus.dataset.role = 'base'; btnPlus.dataset.role = 'base'; btnReset.dataset.role = 'base';
      fab.appendChild(btnMinus);
      fab.appendChild(btnPlus);
      fab.appendChild(btnReset);
      // Menú "Más" para acciones extra
      const menuBtn = mkBtn('⋯', 'Más', 'Más opciones', () => {});
      menuBtn.classList.add('menu-toggle');
      menuBtn.id = 'rutina-preview-zoom-more';
      menuBtn.setAttribute('aria-haspopup','true');
      menuBtn.setAttribute('aria-expanded','false');
      fab.appendChild(menuBtn);
      let menu = document.getElementById('rutina-preview-zoom-menu');
      if(!menu){
        menu = document.createElement('div');
        menu.id = 'rutina-preview-zoom-menu';
        menu.className = 'menu-panel';
        menu.setAttribute('role','menu');
        menu.setAttribute('aria-labelledby','rutina-preview-zoom-more');
        const mkMenuItem = (iconText, labelText, aria, onClick) => {
          const item = document.createElement('button');
          item.type = 'button';
          item.className = 'btn info sm menu-item';
          item.setAttribute('role','menuitem');
          item.setAttribute('aria-label', aria);
          const icon = document.createElement('span'); icon.className = 'icon'; icon.textContent = iconText;
          const label = document.createElement('span'); label.className = 'label'; label.textContent = labelText;
          item.appendChild(icon); item.appendChild(label);
          item.onclick = onClick;
          return item;
        };
        const itemFit = mkMenuItem('⤢', 'Fit', 'Ajustar a ancho', () => { applyScale(1.0); closeMenu(); });
        const itemFull = mkMenuItem('⬌', 'Ancho', 'Alternar ancho completo', () => {
          try{
            const cols = document.getElementById('rutina-preview-columns');
            const grid = document.getElementById('rutina-preview-grid');
            state.viewerFullWidth = !state.viewerFullWidth;
            if(cols){ cols.style.gridTemplateColumns = state.viewerFullWidth ? '1fr' : '1.5fr 1fr'; }
            if(grid && grid.parentElement){ grid.parentElement.style.display = state.viewerFullWidth ? 'none' : ''; }
          }catch(_){ }
          closeMenu();
        });
        const itemOpen = mkMenuItem('↗', 'Abrir', 'Abrir vista en nueva pestaña', () => {
          try{ const url = frame.src || ''; if(url){ window.open(url, '_blank', 'noopener'); } }
          catch(_){ }
          closeMenu();
        });
        const itemToggleSheet = mkMenuItem('⇆', 'Sheet/QR', 'Alternar entre Sheet y QR', () => {
          try{
            const input = document.getElementById('preview-sheet-name');
            if(!input){ closeMenu(); return; }
            const cur = ((input.value||'').trim().toLowerCase());
            const nextSheet = (cur === 'sheet') ? 'QR' : 'Sheet';
            input.value = nextSheet;
            const qrSel = document.getElementById('preview-qr-placement');
            const frame = document.getElementById('rutina-preview-frame');
            if(qrSel && nextSheet === 'QR'){ qrSel.value = 'inline'; }
            if(frame && state.rutinaPreviewSrcCache){
              const src = (nextSheet === 'QR') ? state.rutinaPreviewSrcCache.qr : state.rutinaPreviewSrcCache.sheet;
              if(src){ frame.src = src; closeMenu(); return; }
            }
            try{ updateRutinaPDFPreview(); }catch(_){ }
          }catch(__){ }
          closeMenu();
        });
        menu.appendChild(itemFit);
        menu.appendChild(itemFull);
        menu.appendChild(itemOpen);
        menu.appendChild(itemToggleSheet);
        fab.appendChild(menu);
      }
      const openMenu = () => { menu.dataset.open = 'true'; menuBtn.setAttribute('aria-expanded','true'); try{ const first = menu.querySelector('.menu-item'); if(first) first.focus(); }catch(_){ } };
      const closeMenu = () => { menu.dataset.open = 'false'; menuBtn.setAttribute('aria-expanded','false'); };
      const toggleMenu = () => { if(menu.dataset.open === 'true'){ closeMenu(); } else { openMenu(); } };
      menuBtn.onclick = toggleMenu;
      document.addEventListener('click', (ev) => {
        try{
          if(menu.dataset.open !== 'true') return;
          const t = ev.target;
          if(!menu.contains(t) && !menuBtn.contains(t)){ closeMenu(); }
        }catch(_){ }
      }, { capture:true });
      document.addEventListener('keydown', (ev) => {
        try{
          if(ev.key === 'Escape'){ closeMenu(); return; }
          if(menu.dataset.open === 'true' && (ev.key === 'ArrowDown' || ev.key === 'ArrowUp')){
            ev.preventDefault();
            const items = Array.from(menu.querySelectorAll('.menu-item'));
            if(!items.length) return;
            const idx = Math.max(0, items.indexOf(document.activeElement));
            const next = ev.key === 'ArrowDown' ? Math.min(items.length-1, idx+1) : Math.max(0, idx-1);
            items[next].focus();
          }
        }catch(_){ }
      }, { passive:false });
      try{ cont.insertBefore(fab, cont.firstChild || null); }catch(_){ cont.appendChild(fab); }
      // No ocultamos controles principales; el menú alberga acciones extra
    }
  }catch(_){ }
}
    async function openRutinaPreview(id){
      try{
        // Asegurar ejercicios cargados para los selects de agregar
        async function ensureEjerciciosLoaded(){
          if(Array.isArray(state.ejercicios) && state.ejercicios.length){ return; }
          try{
            const r = await fetch('/api/ejercicios', { headers:{ 'Accept':'application/json' } });
            if(r.status === 401){ showToast('Acceso restringido; inicie sesión en Gestión.', 'error', 4500); try{ window.location.href='/gestion/login'; }catch(e){} return; }
            const arr = await r.json().catch(()=>[]);
            state.ejercicios = Array.isArray(arr) ? arr : [];
          }catch(_){ state.ejercicios = []; }
        }
        await ensureEjerciciosLoaded();
        if(id != null){
          const res = await fetch(`/api/rutinas/${id}`, { headers:{ 'Accept':'application/json' } });
          if(res.status === 401){ showToast('Acceso restringido; inicie sesión en Gestión.', 'error', 4500); try{ window.location.href='/gestion/login'; }catch(e){} return; }
          const data = await res.json().catch(() => ({})); if(!res.ok){ showToast(data.detail || data.error || 'No se pudo cargar rutina', 'error', 4500); return; }
          state.rutinaPreview = data; state.rutinaPreviewDraft = _deepCopy(data);
          const nameEl = document.getElementById('rutina-preview-nombre'); if(nameEl) nameEl.value = (data.nombre_rutina || data.nombre || '') || '';
          try{ state.rutinaNombreBase = String((data.nombre_rutina || data.nombre || '') || '').replace(/\s*-\s*[^-]+$/, '').trim(); }catch(_){ state.rutinaNombreBase = String((data.nombre_rutina || data.nombre || '') || ''); }
          const descEl = document.getElementById('rutina-preview-descripcion'); if(descEl) descEl.value = data.descripcion || '';
  const diasEl = document.getElementById('rutina-preview-dias'); if(diasEl) diasEl.value = String(Math.max(2, Math.min(5, Number(data.dias_semana||3))));
          const catEl = document.getElementById('rutina-preview-categoria'); if(catEl){
            const isPlantilla = (data.usuario_id == null);
            catEl.value = String(data.categoria || 'general');
            catEl.disabled = false;
            // Mostrar tabla de ejercicios solo en plantillas
            try{
              const excelTable = document.getElementById('rutina-preview-excel');
              if(excelTable){ excelTable.style.display = isPlantilla ? '' : 'none'; }
            }catch(_){ }
          }
          refreshPreviewDayOptions(Number(diasEl ? diasEl.value : 3));
        } else {
          const base = { id: null, usuario_id: null, nombre_rutina: '', descripcion: '', dias_semana: 3, categoria: 'general', ejercicios: [] };
          state.rutinaPreview = base; state.rutinaPreviewDraft = _deepCopy(base);
          const nameEl = document.getElementById('rutina-preview-nombre'); if(nameEl) nameEl.value = '';
          const descEl = document.getElementById('rutina-preview-descripcion'); if(descEl) descEl.value = '';
          const diasEl = document.getElementById('rutina-preview-dias'); if(diasEl) diasEl.value = '3';
          const catEl = document.getElementById('rutina-preview-categoria'); if(catEl){ catEl.value = 'general'; catEl.disabled = false; }
          refreshPreviewDayOptions(Number(diasEl ? diasEl.value : 3));
        }
        // Prefijar campo de usuario en encabezado según selección/override
        try{
          const uEl = document.getElementById('rutina-preview-usuario-nombre');
          if(uEl){
            const cur = state.rutinaPreviewDraft || state.rutinaPreview || {};
            const selU = state.selectedUsuario;
            if(selU && (cur.usuario_id === selU.id) && selU.nombre){
              uEl.value = String(selU.nombre);
            } else {
              uEl.value = String(cur.usuario_nombre_override || '');
            }
          }
        }catch(_){ }
        // Asegurar que los ejercicios estén cargados antes de poblar filtros y select
        (async () => {
          try {
            if(!Array.isArray(state.ejercicios) || state.ejercicios.length === 0){ await loadEjercicios(); }
          } catch(_){ }
          populateEjercicioFilters();
          const qvInit = (document.getElementById('rutina-preview-ejercicio-search')||{}).value || '';
          filterEjerciciosForPreview(qvInit);
          populateEjercicioSelectForPreview();
          renderRutinaPreview();
        })();
        openModal('modal-rutina-preview');
        // Ajustar título según contexto (plantilla vs rutina)
        try{
          const titleEl = document.getElementById('modal-rutina-preview-title');
          if(titleEl){
            const d = state.rutinaPreviewDraft || state.rutinaPreview || {};
            const isTemplate = (d.usuario_id == null);
            titleEl.textContent = isTemplate ? 'Vista previa de plantilla' : 'Vista previa de rutina';
          }
        }catch(_){ }
        try{ const st = document.getElementById('rutina-preview-status'); if(st) st.textContent=''; const ps = document.getElementById('rutina-preview-pdf-status'); if(ps) ps.style.display='none'; }catch(_){ }
        ensureRutinaAutoSave();
        // Colapsar inputs por defecto y primera carga de PDF
        try{
          const adv = document.getElementById('rutina-preview-advanced'); const btnPrevToggle = document.getElementById('rutina-preview-toggle-advanced');
          if(adv){ adv.style.display = 'none'; state.rutinaPreviewAdvancedHidden = true; }
          if(btnPrevToggle) btnPrevToggle.textContent = 'Mostrar opciones avanzadas';
        }catch(_){ }
        // Establecer valores por defecto del visor: hoja y ubicación del QR
        try{
          const sheetInput = document.getElementById('preview-sheet-name'); if(sheetInput){ sheetInput.value = 'Sheet'; }
          const qrSelDef = document.getElementById('preview-qr-placement'); if(qrSelDef){ qrSelDef.value = 'inline'; }
        }catch(_){ }
        try{ updateRutinaPDFPreview(); }catch(_){ }
        // Bind inline once modal opens
        const closeBtn = document.getElementById('rutina-preview-close');
        const cancelBtn = document.getElementById('rutina-preview-cancel');
        const fApply = document.getElementById('rutina-preview-float-apply');
        function onKeyDown(ev){
          try{
            if(ev.key === 'Escape'){ ev.preventDefault(); closeModal('modal-rutina-preview'); cleanupKeys(); }
            else if((ev.ctrlKey || ev.metaKey) && String(ev.key||'').toLowerCase() === 's'){ ev.preventDefault(); const saveBtn = document.getElementById('rutina-preview-save'); if(saveBtn){ saveBtn.click(); } }
            else if(ev.key === 'Enter'){
              const float = document.getElementById('rutina-preview-float'); if(float && float.style.display === 'block' && fApply){ ev.preventDefault(); fApply.click(); }
            }
          }catch(_){ }
        }
        function cleanupKeys(){ document.removeEventListener('keydown', onKeyDown); }
        document.addEventListener('keydown', onKeyDown);
        if(closeBtn) closeBtn.onclick = async () => {
          try {
            const float = document.getElementById('rutina-preview-float');
            if(float && float.style.display === 'block') { try{ applyRutinaPreviewFloat(true); }catch(_){ } }
            if(state.rutinaPreviewDirty){ try{ await autoSaveRutinaDraft(); }catch(_){ } }
          } catch(_){ }
          cleanupKeys(); stopRutinaAutoSave(); closeModal('modal-rutina-preview');
        };
        if(cancelBtn) cancelBtn.onclick = async () => {
          try {
            const float = document.getElementById('rutina-preview-float');
            if(float && float.style.display === 'block') { try{ applyRutinaPreviewFloat(true); }catch(_){ } }
            if(state.rutinaPreviewDirty){ try{ await autoSaveRutinaDraft(); }catch(_){ } }
          } catch(_){ }
          cleanupKeys(); stopRutinaAutoSave(); closeModal('modal-rutina-preview');
        };
        const searchEl = document.getElementById('rutina-preview-ejercicio-search'); if(searchEl){
          const doFilter = () => { filterEjerciciosForPreview(searchEl.value || ''); populateEjercicioSelectForPreview(); };
          let qTimer = null;
          const debounced = () => { try{ if(qTimer) clearTimeout(qTimer); }catch(_){ }
            qTimer = setTimeout(() => { try{ doFilter(); }catch(_){ } }, 200);
          };
          searchEl.oninput = debounced;
          searchEl.onkeyup = debounced;
        }
        const grpSel = document.getElementById('rutina-preview-filter-group'); if(grpSel){ grpSel.onchange = () => { state.ejFilter = Object.assign({ q:'', group:'', objetivo:'' }, state.ejFilter||{}); state.ejFilter.group = String(grpSel.value||''); const qv = (document.getElementById('rutina-preview-ejercicio-search')||{}).value || ''; filterEjerciciosForPreview(qv); populateEjercicioSelectForPreview(); }; }
        const objSel = document.getElementById('rutina-preview-filter-objetivo'); if(objSel){ objSel.onchange = () => { state.ejFilter = Object.assign({ q:'', group:'', objetivo:'' }, state.ejFilter||{}); state.ejFilter.objetivo = String(objSel.value||''); const qv = (document.getElementById('rutina-preview-ejercicio-search')||{}).value || ''; filterEjerciciosForPreview(qv); populateEjercicioSelectForPreview(); }; }
        const addBtn = document.getElementById('rutina-preview-add'); if(addBtn) addBtn.onclick = () => {
          const esel = document.getElementById('rutina-preview-ejercicio'); const dsel = document.getElementById('rutina-preview-dia');
          const eid = esel ? (esel.value||'') : ''; const dia = dsel ? Number(dsel.value||'1') : 1;
          if(!eid) { showToast('Selecciona ejercicio', 'warning', 2500); return; }
          const d = state.rutinaPreviewDraft || state.rutinaPreview || {};
          const ejs = Array.isArray(d.ejercicios) ? d.ejercicios : [];
          const destItems = ejs.filter(x => Number(x.dia_semana||1) === Number(dia));
          if(destItems.length >= 8){ showToast('Máximo 8 ejercicios por día', 'warning', 2500); return; }
          const existsInDay = destItems.some(x => String(x.ejercicio_id) === String(eid));
          if(existsInDay){ showToast('El ejercicio ya está en este día', 'info', 2500); return; }
          const baseOrder = destItems.length ? Math.max(...destItems.map(x => Number(x.orden||1))) : 0;
          const ejMeta = (state.ejercicios||[]).find(x => String(x.id)===String(eid)) || { id: Number(eid) };
          ejs.push({ ejercicio_id: Number(eid), dia_semana: Number(dia), series: 3, repeticiones: 10, orden: Number(baseOrder+1), ejercicio: ejMeta });
          d.ejercicios = ejs; state.rutinaPreviewDraft = d; renderRutinaPreview(); markRutinaDirty();
        };
        const diasSel = document.getElementById('rutina-preview-dias'); if(diasSel) diasSel.onchange = () => { const d = state.rutinaPreviewDraft || state.rutinaPreview || {}; d.dias_semana = Number(diasSel.value||3); state.rutinaPreviewDraft = d; refreshPreviewDayOptions(Number(diasSel.value||3)); renderRutinaPreview(); markRutinaDirty(); };
        const weeksSel = document.getElementById('rutina-preview-semanas'); if(weeksSel) weeksSel.onchange = () => {
          try{ updateRutinaPDFPreview(); }catch(_){ }
          // Sincronizar inputs semanales en el editor flotante si está abierto
          try {
            const float = document.getElementById('rutina-preview-float');
            if(float && float.style.display === 'block'){
              const weeks = Math.max(1, Math.min(4, Number(weeksSel.value || 1)));
              ['s1','s2','s3','s4'].forEach((id, i) => { const el = document.getElementById(`rutina-preview-float-${id}`); if(el){ el.style.display = (i < weeks) ? '' : 'none'; } });
              ['r1','r2','r3','r4'].forEach((id, i) => { const el = document.getElementById(`rutina-preview-float-${id}`); if(el){ el.style.display = (i < weeks) ? '' : 'none'; } });
            }
          } catch(_){ }
        };
    const catSel = document.getElementById('rutina-preview-categoria'); if(catSel) catSel.onchange = () => { const d = state.rutinaPreviewDraft || state.rutinaPreview || {}; d.categoria = String(catSel.value || 'general'); state.rutinaPreviewDraft = d; renderRutinaPreview(); markRutinaDirty(); };
    const nameEl2 = document.getElementById('rutina-preview-nombre'); if(nameEl2) nameEl2.oninput = () => { const d = state.rutinaPreviewDraft || state.rutinaPreview || {}; d.nombre_rutina = String(nameEl2.value || ''); state.rutinaPreviewDraft = d; // Actualiza base eliminando sufijo "- usuario" si existe
      try{ state.rutinaNombreBase = String(nameEl2.value || '').replace(/\s*-\s*[^-]+$/, '').trim(); }catch(_){ state.rutinaNombreBase = String(nameEl2.value||''); }
      markRutinaDirty(); };
    const descEl2 = document.getElementById('rutina-preview-descripcion'); if(descEl2) descEl2.oninput = () => { const d = state.rutinaPreviewDraft || state.rutinaPreview || {}; d.descripcion = String(descEl2.value || ''); state.rutinaPreviewDraft = d; markRutinaDirty(); };
    const userNameEl = document.getElementById('rutina-preview-usuario-nombre'); if(userNameEl) userNameEl.oninput = () => {
      const d = state.rutinaPreviewDraft || state.rutinaPreview || {}; d.usuario_nombre_override = String(userNameEl.value || '');
      // Estandariza automáticamente el nombre si hay base
      try{
        const base = state.rutinaNombreBase || (d.nombre_rutina || '');
        const nuevo = window.computeRoutineName(base, userNameEl.value || '');
        if(nameEl2){ nameEl2.value = nuevo; }
        d.nombre_rutina = nuevo;
      }catch(_){ }
      state.rutinaPreviewDraft = d; markRutinaDirty(); };
        if(fApply) fApply.onclick = () => applyRutinaPreviewFloat(false);
        const fRemove = document.getElementById('rutina-preview-float-remove'); if(fRemove) fRemove.onclick = removeRutinaPreviewItem;
        const fClose = document.getElementById('rutina-preview-float-close'); if(fClose) fClose.onclick = () => applyRutinaPreviewFloat(true);
        const fDup = document.getElementById('rutina-preview-float-dup'); if(fDup) fDup.onclick = duplicateRutinaPreviewItem;
        const fUp = document.getElementById('rutina-preview-float-up'); if(fUp) fUp.onclick = () => reorderRutinaPreviewItem('up');
        const fDown = document.getElementById('rutina-preview-float-down'); if(fDown) fDown.onclick = () => reorderRutinaPreviewItem('down');
        // Barra de herramientas de selección y vista
        const selMode = document.getElementById('rutina-preview-select-mode'); if(selMode){ selMode.checked = !!state.rutinaSelectMode; selMode.onchange = () => { state.rutinaSelectMode = !!selMode.checked; renderRutinaPreview(); }; }
        const selAll = document.getElementById('rutina-preview-select-all'); if(selAll){ selAll.onclick = () => { const d = state.rutinaPreviewDraft || state.rutinaPreview || {}; const ejs = Array.isArray(d.ejercicios) ? d.ejercicios : []; state.rutinaSelected = ejs.map(x => `${String(x.ejercicio_id)}#${Number(x.dia_semana||1)}#${Number(x.orden||1)}`); renderRutinaPreview(); showToast('Todos seleccionados', 'info', 1500); }; }
        const bulkMoveBtn = document.getElementById('rutina-preview-bulk-move'); if(bulkMoveBtn){ bulkMoveBtn.onclick = (ev) => openBulkDayPopover('move', ev.currentTarget); }
        const bulkDupBtn = document.getElementById('rutina-preview-bulk-dup'); if(bulkDupBtn){ bulkDupBtn.onclick = (ev) => openBulkDayPopover('dup', ev.currentTarget); }
        const bulkDelBtn = document.getElementById('rutina-preview-bulk-delete'); if(bulkDelBtn){ bulkDelBtn.onclick = () => bulkDeleteSelected(); }
        const compactBtn = document.getElementById('rutina-preview-toggle-compact'); if(compactBtn){ compactBtn.onclick = () => { state.rutinaCompact = !state.rutinaCompact; renderRutinaPreview(); compactBtn.textContent = state.rutinaCompact ? 'Vista normal' : 'Vista compacta'; }; }
        const collapseBtn = document.getElementById('rutina-preview-collapse-days'); if(collapseBtn){ collapseBtn.onclick = () => {
  const d = state.rutinaPreviewDraft || state.rutinaPreview || {}; const diasMax = Math.max(2, Math.min(5, Number(d.dias_semana||3)));
          const collapsed = state.rutinaDayCollapsed || {}; let anyExpanded = false; for(let i=1;i<=diasMax;i++){ if(!collapsed[i]) { anyExpanded = true; break; } }
          const next = anyExpanded ? true : false; state.rutinaDayCollapsed = {}; for(let i=1;i<=diasMax;i++){ state.rutinaDayCollapsed[i] = next; }
          renderRutinaPreview();
          // Expandir PDF a ancho completo si todos los días están colapsados
          const cols = document.getElementById('rutina-preview-columns');
          const grid = document.getElementById('rutina-preview-grid');
          if(cols){ cols.style.gridTemplateColumns = next ? '1fr' : '1.5fr 1fr'; }
          if(grid){ grid.parentElement.style.display = next ? 'none' : ''; }
        }; }
        const advBtn = document.getElementById('rutina-preview-excel-advanced-btn');
        if(advBtn){
          advBtn.onclick = async () => {
            try{ await (window.loadSheetJSLib ? window.loadSheetJSLib() : Promise.resolve(false)); }catch(_){ }
            const cont = document.getElementById('rutina-preview-excel-advanced');
            const simple = document.getElementById('rutina-preview-excel');
            if(cont && simple){
              const showingAdv = cont.style.display === '';
              const nextShowAdv = !showingAdv;
              cont.style.display = nextShowAdv ? '' : 'none';
              simple.style.display = nextShowAdv ? 'none' : '';
              advBtn.textContent = nextShowAdv ? 'Vista simple' : 'Vista Excel (SheetJS)';
              if(nextShowAdv){ renderRutinaSheetJSView(); }
            }
          };
        }
        const saveBtn = document.getElementById('rutina-preview-save'); if(saveBtn) saveBtn.onclick = async () => {
          const d = state.rutinaPreviewDraft || state.rutinaPreview || {};
          const payloadBase = {
            nombre_rutina: (document.getElementById('rutina-preview-nombre')||{}).value || (d.nombre_rutina||''),
            descripcion: (document.getElementById('rutina-preview-descripcion')||{}).value || d.descripcion || null,
  dias_semana: Math.max(2, Math.min(5, Number((document.getElementById('rutina-preview-dias')||{}).value || d.dias_semana || 3))),
            categoria: (document.getElementById('rutina-preview-categoria')||{}).value || (d.categoria || 'general'),
            ejercicios: (Array.isArray(d.ejercicios)? d.ejercicios: []).map(x => ({ ejercicio_id: Number(x.ejercicio_id), dia_semana: Number(x.dia_semana||1), series: x.series, repeticiones: x.repeticiones, orden: Number(x.orden||1) }))
          };
          try{
            if(d.id){
              const res = await fetch(`/api/rutinas/${d.id}`, { method:'PUT', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(payloadBase) });
              const data = await res.json().catch(()=>({})); if(!res.ok){ showToast(data.detail || data.error || 'No se pudo guardar rutina', 'error', 4500); return; }
              closeModal('modal-rutina-preview'); cleanupKeys(); showToast('Rutina actualizada', 'success', 2500);
              await loadRutinasPlantillas();
              const uidAfter = (document.getElementById('rutinas-usuario')||{}).value || '';
              await loadRutinasPorUsuario(uidAfter);
              try{ document.dispatchEvent(new CustomEvent('rutinas:updated', { detail:{ action:'update', usuarioId: Number(uidAfter||0) } })); }catch(_){}
            } else {
              // Crear: si tiene usuario_id, crear asignada al usuario; si no, crear como plantilla
              const hasUsuario = (d.usuario_id != null) && !isNaN(Number(d.usuario_id));
              const payload = Object.assign({}, payloadBase, { usuario_id: hasUsuario ? Number(d.usuario_id) : null });
              const res = await fetch('/api/rutinas', { method:'POST', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(payload) });
              const data = await res.json().catch(()=>({})); if(!res.ok){ showToast(data.detail || data.error || (hasUsuario?'No se pudo crear rutina de usuario':'No se pudo crear plantilla'), 'error', 4500); return; }
              closeModal('modal-rutina-preview'); cleanupKeys(); showToast(hasUsuario ? 'Rutina creada y asignada al usuario' : 'Plantilla creada', 'success', 2500);
              await loadRutinasPlantillas();
              const uidAfterCreate = (document.getElementById('rutinas-usuario')||{}).value || '';
              await loadRutinasPorUsuario(uidAfterCreate);
              try{ document.dispatchEvent(new CustomEvent('rutinas:updated', { detail:{ action:'create', usuarioId: Number(uidAfterCreate||0), assigned: !!hasUsuario } })); }catch(_){}
            }
          }catch(e){ showToast('Error de red al guardar rutina', 'error', 4500); }
        };
      }catch(e){ showToast('Error de red al cargar rutina', 'error', 4500); }
    }

    // Vista tipo Excel dentro del preview: render y edición en tiempo real
    function renderRutinaExcelView(){
      const table = document.querySelector('#rutina-preview-excel-table tbody'); if(!table) return;
      const d = state.rutinaPreviewDraft || state.rutinaPreview || {};
      const ejs = Array.isArray(d.ejercicios) ? d.ejercicios.slice() : [];
      ejs.sort((a,b) => (Number(a.dia_semana||1) - Number(b.dia_semana||1)) || (Number(a.orden||1) - Number(b.orden||1)));
      table.innerHTML = '';
      const fmtEdit = (val) => {
        if(val == null) return '';
        if(typeof val === 'string') return val;
        return String(val);
      };
      ejs.forEach(item => {
        const tr = document.createElement('tr'); tr.setAttribute('data-ej-id', String(item.ejercicio_id));
        tr.innerHTML = `
          <td>${Number(item.dia_semana||1)}</td>
          <td>${(item.ejercicio && item.ejercicio.nombre) ? String(item.ejercicio.nombre) : ('Ejercicio ' + item.ejercicio_id)}</td>
          <td contenteditable="true">${fmtEdit(item.series!=null?item.series:3)}</td>
          <td contenteditable="true">${fmtEdit(item.repeticiones!=null?item.repeticiones:10)}</td>
          <td>${Number(item.orden||1)}</td>`;
        table.appendChild(tr);
      });
      // Edición en tiempo real: actualizar series/reps al escribir
      const tbl = document.getElementById('rutina-preview-excel-table');
      if(tbl){
        tbl.oninput = (ev) => {
          const cell = ev.target.closest('td'); if(!cell) return;
          const row = cell.parentElement; const eid = row ? row.getAttribute('data-ej-id') : '';
          if(!eid) return;
          const tds = row.querySelectorAll('td');
          const rawS = (tds[2]?.textContent || '').trim();
          const rawR = (tds[3]?.textContent || '').trim();
          const parseField = (raw) => {
            if(raw.includes(',')){
              return raw.split(',').map(p => String(Math.max(1, Number(p.trim())||1))).join(',');
            }
            return Math.max(1, Number(raw)||1);
          };
          const series = parseField(rawS);
          const reps = parseField(rawR);
          const d2 = state.rutinaPreviewDraft || state.rutinaPreview || {};
          const ejs2 = Array.isArray(d2.ejercicios) ? d2.ejercicios : [];
          const it = ejs2.find(x => String(x.ejercicio_id) === String(eid)); if(it){ it.series = series; it.repeticiones = reps; }
          // Mantener la grilla sincronizada
          markRutinaDirty(); renderRutinaPreview();
        };
      }
    }

    // Vista avanzada con SheetJS (HTML de hoja de cálculo, sin progresión por semanas)
    async function renderRutinaSheetJSView(){
      const cont = document.getElementById('rutina-preview-excel-advanced'); if(!cont) return;
      // Asegurar librería
      try { if(!window.XLSX){ await (window.loadSheetJSLib ? window.loadSheetJSLib() : Promise.resolve(false)); } } catch(_){ }
      const d = state.rutinaPreviewDraft || state.rutinaPreview || {};
      const ejs = Array.isArray(d.ejercicios) ? d.ejercicios.slice() : [];
      ejs.sort((a,b) => (Number(a.dia_semana||1) - Number(b.dia_semana||1)) || (Number(a.orden||1) - Number(b.orden||1)));
      const aoa = [['Día','Ejercicio','Series','Repeticiones','Orden']];
      ejs.forEach(it => {
        aoa.push([
          Number(it.dia_semana||1),
          (it.ejercicio && it.ejercicio.nombre) ? String(it.ejercicio.nombre) : ('Ejercicio ' + it.ejercicio_id),
          Number(it.series||3),
          Number(it.repeticiones||10),
          Number(it.orden||1)
        ]);
      });
      if(window.XLSX){
        const ws = XLSX.utils.aoa_to_sheet(aoa);
        const html = XLSX.utils.sheet_to_html(ws, { id: 'rutina-sheetjs-html', editable: false });
        cont.innerHTML = html;
      } else {
        // Fallback manual sin SheetJS
        const table = document.createElement('table');
        table.id = 'rutina-sheetjs-html';
        const thead = document.createElement('thead');
        const trh = document.createElement('tr');
        ['Día','Ejercicio','Series','Repeticiones','Orden'].forEach(h => { const th=document.createElement('th'); th.textContent=h; trh.appendChild(th); });
        thead.appendChild(trh);
        const tbody = document.createElement('tbody');
        aoa.slice(1).forEach(row => {
          const tr = document.createElement('tr');
          row.forEach(val => { const td=document.createElement('td'); td.textContent=String(val); tr.appendChild(td); });
          tbody.appendChild(tr);
        });
        table.appendChild(thead); table.appendChild(tbody);
        cont.innerHTML = ''; cont.appendChild(table);
      }
      const tbl = cont.querySelector('table'); if(tbl){ tbl.style.width = 'max-content'; tbl.style.minWidth = '100%'; tbl.style.borderCollapse = 'collapse'; }
      const ths = cont.querySelectorAll('th, td'); ths.forEach(el => { el.style.padding = '10px'; el.style.borderBottom = '1px solid var(--border)'; el.style.textAlign = 'left'; });
    }

    // ===== Exportar Excel desde preview =====
    function openRutinaExportModal(){
      const d = state.rutinaPreviewDraft || state.rutinaPreview || {};
      if(!d || !d.id){ showToast('Guarda la rutina/plantilla antes de exportar', 'warning', 3500); return; }
      const fname = (d.nombre_rutina || d.nombre || 'rutina') + '.xlsx';
      const fEl = document.getElementById('rutina-export-filename'); if(fEl) fEl.value = fname;
      // Inicializar nombre de usuario para encabezado
      try{
        const uEl = document.getElementById('rutina-export-usuario-nombre');
        if(uEl){
          const selU = state.selectedUsuario;
          if(selU && (d.usuario_id === selU.id) && selU.nombre){
            uEl.value = String(selU.nombre);
          } else {
            uEl.value = String((d.usuario_nombre_override || ''));
          }
        }
      }catch(_){ }
      const tbody = document.querySelector('#rutina-export-table tbody'); if(tbody){
        const ejs = Array.isArray(d.ejercicios) ? d.ejercicios.slice() : [];
        ejs.sort((a,b) => (Number(a.dia_semana||1) - Number(b.dia_semana||1)) || (Number(a.orden||1) - Number(b.orden||1)));
        tbody.innerHTML = '';
        ejs.forEach(item => {
          const tr = document.createElement('tr');
          tr.setAttribute('data-ej-id', String(item.ejercicio_id));
          tr.innerHTML = `
            <td>${Number(item.dia_semana||1)}</td>
            <td>${(item.ejercicio && item.ejercicio.nombre) ? String(item.ejercicio.nombre) : ('Ejercicio ' + item.ejercicio_id)}</td>
            <td contenteditable="true">${(item.series!=null? (typeof item.series==='string'? item.series : String(item.series)) : '3')}</td>
            <td contenteditable="true">${(item.repeticiones!=null? (typeof item.repeticiones==='string'? item.repeticiones : String(item.repeticiones)) : '10')}</td>
            <td>${Number(item.orden||1)}</td>`;
          tbody.appendChild(tr);
        });
      }
      const c1 = document.getElementById('rutina-export-close'); if(c1) c1.onclick = () => closeModal('modal-rutina-export');
      const c2 = document.getElementById('rutina-export-close-btn'); if(c2) c2.onclick = () => closeModal('modal-rutina-export');
      const applyAllBtn = document.getElementById('rutina-export-apply-all');
      if(applyAllBtn){
        applyAllBtn.onclick = () => {
          const sVal = Number((document.getElementById('rutina-export-all-series')||{}).value || '');
          const rVal = Number((document.getElementById('rutina-export-all-reps')||{}).value || '');
          const tbody3 = document.querySelector('#rutina-export-table tbody');
          if(tbody3){
            Array.from(tbody3.querySelectorAll('tr')).forEach(tr => {
              const tds = tr.querySelectorAll('td');
              if(!isNaN(sVal) && sVal > 0){ const tdS = tds[2]; if(tdS) tdS.textContent = String(sVal); }
              if(!isNaN(rVal) && rVal > 0){ const tdR = tds[3]; if(tdR) tdR.textContent = String(rVal); }
            });
          }
          // Actualizar previsualización tras aplicar
          const prevBtn = document.getElementById('rutina-export-preview-btn'); if(prevBtn) prevBtn.click();
        };
      }
      // Helper: construir payload desde la tabla para guardar
      function buildPayloadFromTable(){
        const dInner = state.rutinaPreviewDraft || state.rutinaPreview || {};
        const tbody2 = document.querySelector('#rutina-export-table tbody');
        const rows = Array.from(tbody2 ? tbody2.querySelectorAll('tr') : []);
        const map = new Map();
        rows.forEach(tr => {
          const eid = tr.getAttribute('data-ej-id'); if(!eid) return;
          const tds = tr.querySelectorAll('td');
          const rawS = (tds[2]?.textContent || '').trim();
          const rawR = (tds[3]?.textContent || '').trim();
          const parseField = (raw) => {
            if(raw.includes(',')){
              return raw.split(',').map(p => String(Math.max(1, Number(p.trim())||1))).join(',');
            }
            return Math.max(1, Number(raw)||1);
          };
          const series = parseField(rawS);
          const reps = parseField(rawR);
          map.set(String(eid), { series, repeticiones: reps });
        });
        const ejs = Array.isArray(dInner.ejercicios) ? dInner.ejercicios : [];
        ejs.forEach(item => { const m = map.get(String(item.ejercicio_id)); if(m){ item.series = m.series; item.repeticiones = m.repeticiones; } });
      const payload = {
        nombre_rutina: (document.getElementById('rutina-preview-nombre')||{}).value || (dInner.nombre_rutina||''),
        descripcion: (document.getElementById('rutina-preview-descripcion')||{}).value || dInner.descripcion || null,
  dias_semana: Math.max(2, Math.min(5, Number((document.getElementById('rutina-preview-dias')||{}).value || dInner.dias_semana || 3))),
        categoria: dInner.categoria || 'general',
        usuario_id: (typeof dInner.usuario_id !== 'undefined' ? dInner.usuario_id : null),
        usuario_nombre_override: ((document.getElementById('rutina-export-usuario-nombre')||{}).value || '').trim() || null,
        ejercicios: ejs.map(x => ({
          ejercicio_id: Number(x.ejercicio_id),
          dia_semana: Number(x.dia_semana||1),
          series: x.series,
          repeticiones: x.repeticiones,
          orden: Number(x.orden||1),
          nombre_ejercicio: (
            x.nombre_ejercicio
            || ((x.ejercicio||{}).nombre)
            || (((state.ejercicios||[]).find(e => String(e.id) === String(x.ejercicio_id))||{}).nombre)
            || null
          )
        }))
      };
        return { dInner, payload };
      }

      // Guardar cambios explícitamente
      const saveBtn = document.getElementById('rutina-export-save-btn'); if(saveBtn){
        saveBtn.onclick = async () => {
          try{
            const { dInner, payload } = buildPayloadFromTable();
            const putRes = await fetch(`/api/rutinas/${dInner.id}`, { method:'PUT', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(payload) });
            const putData = await putRes.json().catch(()=>({})); if(!putRes.ok){ showToast(putData.detail || putData.error || 'No se pudo guardar', 'error', 4500); return; }
            showToast('Cambios guardados', 'success', 2000);
            try{
              document.dispatchEvent(new CustomEvent('rutinas:updated', { detail:{ action:'export-save', rutinaId: Number(dInner.id||0) } }));
              if(state && state.activeRutinaTab === 'usuario'){
                const uid = (document.getElementById('rutinas-usuario')||{}).value || '';
                await loadRutinasPorUsuario(uid);
              } else {
                await loadRutinasPlantillas();
              }
            }catch(_){ }
          }catch(_){ showToast('Error guardando cambios', 'error', 4500); }
        };
      }

      // Previsualización literal: guarda y renderiza desde backend XLSX
      async function updateExcelPreview(){
        try{
          const previewEl = document.getElementById('rutina-export-preview'); if(!previewEl) return;
          const { dInner, payload } = buildPayloadFromTable();
          const weeks = Math.max(1, Math.min(4, Number((document.getElementById('rutina-export-weeks')||{}).value || 1)));
          const fnameEl = (document.getElementById('rutina-export-filename')||{}).value || '';
          const fnameSafe = (fnameEl || ((dInner.nombre_rutina || dInner.nombre || 'rutina') + '.xlsx')).replace(/[\\/:*?"<>|]+/g, '_');
          const qrMode = (document.getElementById('rutina-export-qr-mode')||{}).value || 'auto';
          const sheetName = ((document.getElementById('rutina-export-sheet-name')||{}).value || '').trim();
          const urlSignedRes = await fetch(`/api/rutinas/preview/excel_view_url?weeks=${encodeURIComponent(String(weeks))}&filename=${encodeURIComponent(fnameSafe)}&qr_mode=${encodeURIComponent(String(qrMode))}&sheet=${encodeURIComponent(String(sheetName||''))}`, { method:'POST', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(payload) });
          const urlSignedData = await urlSignedRes.json().catch(()=>({}));
          if(urlSignedRes.status === 401){ showToast('Acceso restringido; inicie sesión en Gestión.', 'error', 4500); try{ window.location.href='/gestion/login'; }catch(e){} return; }
          if(!urlSignedRes.ok || !urlSignedData.url){ let msg = urlSignedData.detail || urlSignedData.error || `Error ${urlSignedRes.status}`; showToast(msg, 'error', 4500); return; }
          const r = await fetch(String(urlSignedData.url));
          if(!r.ok){ let msg = `Error ${r.status}`; try{ const err = await r.json(); msg = err.detail || err.error || msg; }catch(_){ } showToast(msg, 'error', 4500); return; }
          const blob = await r.blob();
          // Renderizar con SheetJS
          try{ await (window.loadSheetJSLib ? window.loadSheetJSLib() : Promise.resolve(false)); }catch(_){ }
          if(!window.XLSX){ previewEl.innerHTML = '<p class="muted">No se pudo cargar la librería de previsualización.</p>'; return; }
          const buf = await blob.arrayBuffer();
          let wb; try{ wb = XLSX.read(buf, { type:'array' }); }catch(_){ wb = null; }
          if(!wb || !wb.SheetNames || !wb.SheetNames.length){ previewEl.innerHTML = '<p class="muted">No se pudo interpretar el Excel.</p>'; return; }
          // Selección de hoja
          const sheetEl = document.getElementById('rutina-export-sheet');
          let sheetIndex = 0;
          if(sheetEl){
            const names = wb.SheetNames || [];
            const currLen = (sheetEl.options || []).length;
            if(currLen !== names.length){
              sheetEl.innerHTML = names.map((nm, idx) => `<option value="${idx}">${String(nm)}</option>`).join('');
            }
            sheetIndex = Math.max(0, Math.min((wb.SheetNames.length-1), Number(sheetEl.value || 0)));
          }
          const ws = wb.Sheets[wb.SheetNames[sheetIndex]];
          const html = XLSX.utils.sheet_to_html(ws, { id:'rutina-export-preview-table', editable:false });
          // Contenedor con zoom
          previewEl.innerHTML = `<div id="rutina-export-preview-zoomable" style="transform-origin: top left;">${html}</div>`;
          const zoomEl = document.getElementById('rutina-export-zoom');
          const zoomVal = Math.max(50, Math.min(200, Number((zoomEl||{}).value || 100)));
          const zoomWrap = document.getElementById('rutina-export-preview-zoomable'); if(zoomWrap){ zoomWrap.style.transform = `scale(${zoomVal/100})`; }
          const zLbl = document.getElementById('rutina-export-zoom-label'); if(zLbl){ zLbl.textContent = `${zoomVal}%`; }
          const tbl = previewEl.querySelector('table'); if(tbl){ tbl.style.width = 'max-content'; tbl.style.minWidth = '100%'; tbl.style.borderCollapse = 'collapse'; }
          const cells = previewEl.querySelectorAll('th, td'); cells.forEach(el => { el.style.padding = '10px'; el.style.borderBottom = '1px solid var(--border)'; el.style.textAlign = 'left'; });
          showToast('Vista previa actualizada', 'success', 1200);
        }catch(_){ showToast('No se pudo generar la vista previa', 'error', 4500); }
      }

      const prevBtn = document.getElementById('rutina-export-preview-btn'); if(prevBtn){ prevBtn.onclick = updateExcelPreview; }
      const weeksEl = document.getElementById('rutina-export-weeks'); if(weeksEl){ weeksEl.onchange = updateExcelPreview; }
      const unameEl = document.getElementById('rutina-export-usuario-nombre'); if(unameEl){ unameEl.oninput = updateExcelPreview; }
      const sheetSel = document.getElementById('rutina-export-sheet'); if(sheetSel){ sheetSel.onchange = updateExcelPreview; }
      const zoomEl = document.getElementById('rutina-export-zoom'); if(zoomEl){
        zoomEl.oninput = () => {
          const z = Math.max(50, Math.min(200, Number(zoomEl.value || 100)));
          const zLbl = document.getElementById('rutina-export-zoom-label'); if(zLbl){ zLbl.textContent = `${z}%`; }
          const wrap = document.getElementById('rutina-export-preview-zoomable'); if(wrap){ wrap.style.transform = `scale(${z/100})`; }
        };
      }
      const dBtn = document.getElementById('rutina-export-download'); if(dBtn){
        dBtn.onclick = async () => {
          try{
            const { dInner, payload } = buildPayloadFromTable();
            const weeks = Math.max(1, Math.min(4, Number((document.getElementById('rutina-export-weeks')||{}).value || 1)));
            const fnameEl = (document.getElementById('rutina-export-filename')||{}).value || '';
            const fnameSafe = (fnameEl || ((dInner.nombre_rutina || dInner.nombre || 'rutina') + '.xlsx')).replace(/[\\/:*?"<>|]+/g, '_');
            const qrMode = (document.getElementById('rutina-export-qr-mode')||{}).value || 'auto';
            const sheetName = ((document.getElementById('rutina-export-sheet-name')||{}).value || '').trim();
            let urlSignedRes;
            if (dInner && dInner.id) {
              const qs = new URLSearchParams({ weeks: String(weeks), filename: fnameSafe, qr_mode: String(qrMode), sheet: String(sheetName||'') });
              urlSignedRes = await fetch(`/api/rutinas/${encodeURIComponent(String(dInner.id))}/export/excel_view_url?` + qs.toString(), { method:'GET', headers:{ 'Accept':'application/json' } });
            } else {
              urlSignedRes = await fetch(`/api/rutinas/preview/excel_view_url?weeks=${encodeURIComponent(String(weeks))}&filename=${encodeURIComponent(fnameSafe)}&qr_mode=${encodeURIComponent(String(qrMode))}&sheet=${encodeURIComponent(String(sheetName||''))}`, { method:'POST', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(payload) });
            }
            const urlSignedData = await urlSignedRes.json().catch(()=>({}));
            if(urlSignedRes.status === 401){ showToast('Acceso restringido; inicie sesión en Gestión.', 'error', 4500); try{ window.location.href='/gestion/login'; }catch(e){} return; }
            if(!urlSignedRes.ok || !urlSignedData.url){ let msg = urlSignedData.detail || urlSignedData.error || `Error ${urlSignedRes.status}`; showToast(msg, 'error', 4500); return; }
            const r = await fetch(String(urlSignedData.url));
            if(!r.ok){ let msg = `Error ${r.status}`; try{ const err = await r.json(); msg = err.detail || err.error || msg; }catch(_){ } showToast(msg, 'error', 4500); return; }
            const blob = await r.blob();
            let dlName = fnameSafe;
            try { dlName = String(dlName).replace(/[\\/:*?"<>|]+/g, '_'); } catch(_) {}
            const dlUrl = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = dlUrl; a.download = dlName;
            document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(dlUrl);
            showToast('Excel descargado', 'success', 2500);
            closeModal('modal-rutina-export');
          }catch(_){ showToast('No se pudo exportar Excel', 'error', 4500); }
        };
      }
      
      openModal('modal-rutina-export');
      // Opcional: cargar una previsualización inicial
      const prevBtn2 = document.getElementById('rutina-export-preview-btn'); if(prevBtn2){ prevBtn2.click(); }
    }

    function openRutinaBuilderNew(){
      // Abrir modal de elección: desde plantilla o desde cero
      (async () => {
        try{
          if(!Array.isArray(state.plantillas) || !state.plantillas.length){ await loadRutinasPlantillas(); }
        }catch(_){}
        const searchEl = document.getElementById('rutina-choice-template-search');
        const selEl = document.getElementById('rutina-choice-template');
        const closeEl = document.getElementById('rutina-new-choice-close');
        const cancelEl = document.getElementById('rutina-new-choice-cancel');
        const confirmTpl = document.getElementById('rutina-choice-template-confirm');
        const confirmScratch = document.getElementById('rutina-choice-scratch-confirm');
        const isQuickFlow = !!state.rutinaQuickAssignFlow;
        const selUser = state.selectedUsuario || null;
        const userSearchEl = document.getElementById('rutina-choice-user-search');
        const userSelEl = document.getElementById('rutina-choice-user');
        // Prepara selector de usuario en el modal
        try{
          if(!Array.isArray(state.usuarios) || !state.usuarios.length){ await loadUsers(); }
        }catch(_){ }
        if(userSelEl){
          userSelEl.innerHTML = '';
          const def = document.createElement('option'); def.value = ''; def.textContent = 'Selecciona usuario'; userSelEl.appendChild(def);
          const users = Array.isArray(state.usuarios) ? state.usuarios : [];
          users.forEach(u => { const opt = document.createElement('option'); opt.value = String(u.id); opt.textContent = u.nombre || u.email || `Usuario ${u.id}`; userSelEl.appendChild(opt); });
          try{ if(selUser && selUser.id){ userSelEl.value = String(selUser.id); } }catch(_){ }
          // Deshabilita confirmaciones hasta que haya usuario seleccionado
          const updateConfirmEnabled = () => {
            const hasUser = !!(userSelEl && userSelEl.value);
            if(confirmTpl) confirmTpl.disabled = !hasUser;
            if(confirmScratch) confirmScratch.disabled = !hasUser;
          };
          updateConfirmEnabled();
          userSelEl.onchange = updateConfirmEnabled;
        }
        if(userSearchEl){
          userSearchEl.value = '';
          userSearchEl.oninput = () => {
            const q = (userSearchEl.value || '').toLowerCase();
            Array.from((userSelEl||{options:[]}).options).forEach(opt => {
              if(!opt.value) return;
              opt.hidden = q.length > 0 && !(opt.textContent || '').toLowerCase().includes(q);
            });
          };
        }
        const items = Array.isArray(state.plantillas) ? state.plantillas : [];
        function populateSelect(filter){
          const q = String(filter || '').trim().toLowerCase();
          if(selEl){ selEl.innerHTML=''; (items||[]).filter(x => !q || String((x.nombre||x.nombre_rutina||'')) .toLowerCase().includes(q)).forEach(r => {
            const opt = document.createElement('option');
            opt.value = String(r.id);
            opt.textContent = String(r.nombre || r.nombre_rutina || `Plantilla ${r.id}`);
            selEl.appendChild(opt);
          }); }
        }
        populateSelect('');
        if(searchEl){
          searchEl.value='';
          let timer=null;
          const run = () => { try{ populateSelect(searchEl.value || ''); }catch(_){ } };
          searchEl.oninput = () => { try{ if(timer) clearTimeout(timer); timer = setTimeout(run, 200); }catch(_){ run(); } };
        }
        if(closeEl) closeEl.onclick = () => { state.rutinaQuickAssignFlow = false; closeModal('modal-rutina-new-choice'); };
        if(cancelEl) cancelEl.onclick = () => { state.rutinaQuickAssignFlow = false; closeModal('modal-rutina-new-choice'); };
        if(confirmTpl) confirmTpl.onclick = async () => {
          const id = selEl ? Number(selEl.value || '') : 0;
          if(!id){ showToast('Selecciona una plantilla', 'info', 2500); return; }
          // Si hay usuario seleccionado en el modal (o flujo rápido), clonar y asignar al usuario
          const modalUserId = userSelEl ? Number(userSelEl.value || 0) : 0;
          const targetUser = modalUserId || (isQuickFlow && selUser && selUser.id ? Number(selUser.id) : 0);
          let createdId = null;
          if(targetUser){
            try{
              const detRes = await fetch(`/api/rutinas/${id}`, { headers:{ 'Accept':'application/json' } });
              if(detRes.status === 401){ showToast('Acceso restringido; inicie sesión en Gestión.', 'error', 4500); try{ window.location.href = '/gestion/login'; }catch(e){} return; }
              const det = await detRes.json().catch(() => ({}));
              if(!detRes.ok){ showToast(det.detail || det.error || 'No se pudo cargar plantilla', 'error', 4500); return; }
               const baseNombre = det.nombre_rutina || det.nombre || 'Rutina';
               const userLabel = (() => { try{ const opt = (userSelEl && userSelEl.options[userSelEl.selectedIndex]) ? userSelEl.options[userSelEl.selectedIndex] : null; return String((opt && opt.textContent) || 'Usuario'); }catch(_){ return 'Usuario'; } })();
               const nombreAuto = window.computeRoutineName(baseNombre, userLabel);
              const diasMax = Math.max(2, Math.min(5, Number(det.dias_semana || 3)));
              const payload = {
                usuario_id: Number(targetUser),
                nombre_rutina: nombreAuto,
                descripcion: det.descripcion || null,
                dias_semana: diasMax,
                categoria: det.categoria || 'general',
                ejercicios: (Array.isArray(det.ejercicios)? det.ejercicios: []).map(x => ({
                  ejercicio_id: Number(x.ejercicio_id),
                  dia_semana: Math.max(1, Math.min(diasMax, Number(x.dia_semana||1))),
                  series: x.series,
                  repeticiones: x.repeticiones,
                  orden: Number(x.orden||1)
                }))
              };
              const res = await fetch('/api/rutinas', { method:'POST', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(payload) });
              if(res.status === 401){ showToast('Acceso restringido; inicie sesión en Gestión.', 'error', 4500); try{ window.location.href = '/gestion/login'; }catch(e){} return; }
              const data = await res.json().catch(() => ({}));
              if(!res.ok){ showToast(data.detail || data.error || 'No se pudo crear rutina para usuario', 'error', 4500); return; }
              try{ createdId = Number((data && (data.id != null ? data.id : data.id)) || null); }catch(_){ createdId = null; }
              // Fallback robusto: si la rutina creada quedó sin usuario, forzar asignación
              try{
                const detCreated = await fetch(`/api/rutinas/${Number(data.id)}`, { headers:{ 'Accept':'application/json' } });
                const detData = await detCreated.json().catch(() => ({}));
                if(detCreated.ok && (!detData || detData.usuario_id == null)){
                  const assignRes = await fetch(`/api/rutinas/${Number(data.id)}/assign`, { method:'POST', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify({ usuario_id: Number(targetUser) }) });
                  if(assignRes.status === 401){ showToast('Acceso restringido; inicie sesión en Gestión.', 'error', 4500); try{ window.location.href = '/gestion/login'; }catch(e){} return; }
                  if(!assignRes.ok){ const ad = await assignRes.json().catch(()=>({})); showToast(ad.detail || ad.error || 'No se pudo asignar la rutina al usuario', 'warning', 3500); }
                }
              }catch(_){ /* No bloquear si falla el fallback */ }
              closeModal('modal-rutina-new-choice');
              state.rutinaQuickAssignFlow = false;
              showToast('Plantilla clonada para el usuario', 'success', 2500);
              try{ document.dispatchEvent(new CustomEvent('rutinas:updated', { detail:{ action:'create', usuarioId: Number(targetUser) } })); }catch(_){}
              let _opened = false;
              try{ await openRutinaPreview(Number(data.id)); _opened = true; }catch(_){ _opened = false; }
              // Asegurar encabezados visibles con el nombre y usuario
              try{
                const nameEl = document.getElementById('rutina-preview-nombre'); if(nameEl){ nameEl.value = nombreAuto; }
                const userEl = document.getElementById('rutina-preview-usuario-nombre'); if(userEl){ userEl.value = userLabel; }
                const dInner = state.rutinaPreviewDraft || state.rutinaPreview || {};
                dInner.nombre_rutina = nombreAuto; dInner.usuario_nombre_override = userLabel;
                state.rutinaPreviewDraft = dInner;
              }catch(_){ }
              try{
                const modal = document.getElementById('modal-rutina-preview');
                const cs = modal ? window.getComputedStyle(modal) : null;
                const visible = !!(modal && cs && cs.display !== 'none' && modal.getClientRects && modal.getClientRects().length > 0);
                if(!_opened || !visible){
                  let cause = 'unknown';
                  try{
                    const rEj = await fetch('/api/ejercicios', { headers:{ 'Accept':'application/json' } });
                    if(rEj.status === 401){ showToast('Acceso restringido; inicie sesión en Gestión.', 'error', 4500); try{ window.location.href='/gestion/login'; }catch(e){} return; }
                    await rEj.json().catch(()=>[]);
                    if(!rEj.ok){ cause = 'ejercicios'; }
                  }catch(_){ cause = 'ejercicios'; }
                  if(cause === 'unknown'){
                    try{
                      const rDet = await fetch(`/api/rutinas/${Number(data.id)}`, { headers:{ 'Accept':'application/json' } });
                      if(rDet.status === 401){ showToast('Acceso restringido; inicie sesión en Gestión.', 'error', 4500); try{ window.location.href='/gestion/login'; }catch(e){} return; }
                      await rDet.json().catch(()=>({}));
                      if(!rDet.ok){ cause = 'rutina'; }
                    }catch(_){ cause = 'rutina'; }
                  }
                  if(cause === 'ejercicios'){ showToast('Rutina creada, pero falló cargar ejercicios para la previsualización', 'warning', 4000); }
                  else if(cause === 'rutina'){ showToast('Rutina creada, pero no se pudo cargar su detalle', 'warning', 4000); }
                  else { showToast('Rutina creada, pero no se pudo abrir la previsualización', 'warning', 3500); }
                }
              }catch(_){ }
            }catch(e){
              try{ console.error(e); }catch(_){ }
              const msg = (e && e.message) ? String(e.message) : '';
              const isNetwork = /network|fetch|failed|abort/i.test(msg);
              if(createdId){
                try{ closeModal('modal-rutina-new-choice'); state.rutinaQuickAssignFlow = false; }catch(_){ }
                showToast('Plantilla clonada, pero ocurrió un problema al actualizar la vista', 'warning', 4500);
                try{ document.dispatchEvent(new CustomEvent('rutinas:updated', { detail:{ action:'create', usuarioId: Number(targetUser) } })); }catch(_){ }
              } else {
                showToast(isNetwork ? 'Error de red al clonar plantilla' : (msg ? `Error al clonar plantilla: ${msg}` : 'Error al clonar plantilla'), 'error', 4500);
              }
            }
          } else {
            showToast('Selecciona un usuario para continuar', 'info', 2500);
            return;
          }
        };
        if(confirmScratch) confirmScratch.onclick = async () => {
          // Requiere usuario seleccionado
          const modalUserId2 = userSelEl ? Number(userSelEl.value || 0) : 0;
          const targetUser2 = modalUserId2 || (isQuickFlow && selUser && selUser.id ? Number(selUser.id) : 0);
          if(!targetUser2){ showToast('Selecciona un usuario para continuar', 'info', 2500); return; }
          let createdId2 = null;
          try{
            const chosenLabel = (() => { try{ const opt = (userSelEl && userSelEl.options[userSelEl.selectedIndex]) ? userSelEl.options[userSelEl.selectedIndex] : null; return String((opt && opt.textContent) || 'Usuario'); }catch(_){ return 'Usuario'; } })();
             const baseNombre = 'Rutina';
             const nombreAuto = window.computeRoutineName(baseNombre, chosenLabel);
            const payload = {
              usuario_id: Number(targetUser2),
              nombre_rutina: nombreAuto,
              descripcion: null,
              dias_semana: 3,
              categoria: 'general',
              ejercicios: []
            };
            const res = await fetch('/api/rutinas', { method:'POST', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(payload) });
            if(res.status === 401){ showToast('Acceso restringido; inicie sesión en Gestión.', 'error', 4500); try{ window.location.href = '/gestion/login'; }catch(e){} return; }
            const data = await res.json().catch(() => ({}));
            if(!res.ok){ showToast(data.detail || data.error || 'No se pudo crear la rutina', 'error', 4500); return; }
            try{ createdId2 = Number((data && (data.id != null ? data.id : data.id)) || null); }catch(_){ createdId2 = null; }
            closeModal('modal-rutina-new-choice');
            state.rutinaQuickAssignFlow = false;
            showToast('Rutina creada y guardada automáticamente', 'success', 2500);
            try{ document.dispatchEvent(new CustomEvent('rutinas:updated', { detail:{ action:'create', usuarioId: Number(targetUser2) } })); }catch(_){}
            let _opened2 = false;
            try{ await openRutinaPreview(Number(data.id)); _opened2 = true; }catch(_){ _opened2 = false; }
            // Asegurar encabezados visibles con el nombre y usuario
            try{
              const nameEl = document.getElementById('rutina-preview-nombre'); if(nameEl){ nameEl.value = nombreAuto; }
              const userEl = document.getElementById('rutina-preview-usuario-nombre'); if(userEl){ userEl.value = chosenLabel; }
              const dInner = state.rutinaPreviewDraft || state.rutinaPreview || {};
              dInner.nombre_rutina = nombreAuto; dInner.usuario_nombre_override = chosenLabel;
              state.rutinaPreviewDraft = dInner;
            }catch(_){ }
            try{
              const modal = document.getElementById('modal-rutina-preview');
              const cs = modal ? window.getComputedStyle(modal) : null;
              const visible = !!(modal && cs && cs.display !== 'none' && modal.getClientRects && modal.getClientRects().length > 0);
              if(!_opened2 || !visible){
                let cause = 'unknown';
                try{
                  const rEj = await fetch('/api/ejercicios', { headers:{ 'Accept':'application/json' } });
                  if(rEj.status === 401){ showToast('Acceso restringido; inicie sesión en Gestión.', 'error', 4500); try{ window.location.href='/gestion/login'; }catch(e){} return; }
                  await rEj.json().catch(()=>[]);
                  if(!rEj.ok){ cause = 'ejercicios'; }
                }catch(_){ cause = 'ejercicios'; }
                if(cause === 'unknown'){
                  try{
                    const rDet = await fetch(`/api/rutinas/${Number(data.id)}`, { headers:{ 'Accept':'application/json' } });
                    if(rDet.status === 401){ showToast('Acceso restringido; inicie sesión en Gestión.', 'error', 4500); try{ window.location.href='/gestion/login'; }catch(e){} return; }
                    await rDet.json().catch(()=>({}));
                    if(!rDet.ok){ cause = 'rutina'; }
                  }catch(_){ cause = 'rutina'; }
                }
                if(cause === 'ejercicios'){ showToast('Rutina creada, pero falló cargar ejercicios para la previsualización', 'warning', 4000); }
                else if(cause === 'rutina'){ showToast('Rutina creada, pero no se pudo cargar su detalle', 'warning', 4000); }
                else { showToast('Rutina creada, pero no se pudo abrir la previsualización', 'warning', 3500); }
              }
            }catch(_){ }
          }catch(e){
            try{ console.error(e); }catch(_){ }
            const msg = (e && e.message) ? String(e.message) : '';
            const isNetwork = /network|fetch|failed|abort/i.test(msg);
            if(createdId2){
              try{ closeModal('modal-rutina-new-choice'); state.rutinaQuickAssignFlow = false; }catch(_){ }
              showToast('Rutina creada, pero ocurrió un problema al actualizar la vista', 'warning', 4500);
              try{ document.dispatchEvent(new CustomEvent('rutinas:updated', { detail:{ action:'create', usuarioId: Number(targetUser2) } })); }catch(_){ }
            } else {
              showToast(isNetwork ? 'Error de red al crear rutina' : (msg ? `Error al crear rutina: ${msg}` : 'Error al crear rutina'), 'error', 4500);
            }
          }
        };
        openModal('modal-rutina-new-choice');
      })();
    }

    // ===== Rutinas por usuario =====
    async function loadRutinasPorUsuario(uid){
      const block = document.getElementById('rutinas-usuario-block'); const tbody = document.querySelector('#rutinas-usuario-table tbody');
      if(!block || !tbody){ return; }
      try{
        const url = uid ? `/api/rutinas?usuario_id=${encodeURIComponent(String(uid))}` : '/api/rutinas';
        const res = await fetch(url, { headers:{ 'Accept':'application/json' } });
        let arr = await res.json().catch(()=>[]);
        // Asegurar que solo se muestren rutinas con usuario asignado; si hay uid, además debe coincidir
        arr = (Array.isArray(arr)? arr: []).filter(r => {
          const hasUser = r && r.usuario_id != null;
          if(!hasUser) return false; // excluir plantillas o rutinas sin asignar
          if(uid){ return String(r.usuario_id) === String(uid); }
          return true;
        });
        // Filtro por texto (coincide con el input global de búsqueda)
        try{
          const q = ((document.getElementById('rutinas-q')||{}).value || '').trim().toLowerCase();
          if(q){ arr = arr.filter(r => String(r.nombre_rutina || r.nombre || '').toLowerCase().includes(q)); }
        }catch(_){ }
        tbody.innerHTML = '';
        (Array.isArray(arr)? arr: []).forEach(r => {
          const tr = document.createElement('tr'); tr.setAttribute('data-id', String(r.id));
          tr.setAttribute('data-uuid-rutina', String(r.uuid_rutina || ''));
          // Normalizar fecha a YYYY-MM-DD si es ISO, o mostrar '—' si no disponible
          const fcRaw = r.fecha_creacion;
          const fc = fcRaw ? String(fcRaw).split('T')[0] : '—';
          const acciones = `
            <button class="btn info" data-action="preview" data-id="${r.id}">Abrir</button>
            <button class="btn neutral" data-action="toggle" data-id="${r.id}" data-uuid="${r.uuid_rutina || ''}" data-activa="${r.activa ? '1' : '0'}">${r.activa ? 'Desactivar' : 'Activar'}</button>
            <button class="btn danger" data-action="delete" data-id="${r.id}">Eliminar</button>`;
          tr.innerHTML = `<td data-col="nombre">${r.nombre_rutina || r.nombre || ''}</td><td data-col="dias">${r.dias_semana || ''}</td><td data-col="categoria">${r.categoria || ''}</td><td data-col="fecha">${fc}</td><td data-col="activa">${r.activa ? 'Sí' : 'No'}</td><td>${acciones}</td>`;
          tr.addEventListener('click', (ev) => {
            const btn = ev.target.closest('button');
            if(btn){
              const action = btn.getAttribute('data-action'); const id = btn.getAttribute('data-id');
              if(action==='preview'){ if(id) openRutinaPreview(Number(id)); }
              else if(action==='delete'){ if(id) deleteRutina(Number(id)); }
              else if(action==='toggle'){
                const uuid = btn.getAttribute('data-uuid') || tr.getAttribute('data-uuid-rutina') || '';
                const isActive = btn.getAttribute('data-activa') === '1';
                const target = !isActive;
                btn.disabled = true;
                const doUpdate = async () => {
                  const path = uuid ? `/api/gestion/rutinas/activar/${encodeURIComponent(String(uuid))}` : `/api/gestion/rutinas/activar_id/${encodeURIComponent(String(id))}`;
                  try{
                    const rsp = await fetch(path, {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                      body: JSON.stringify({ activa: target })
                    });
                    const data = await rsp.json().catch(()=>({}));
                    if(rsp.ok && data && data.ok && data.rutina){
                      const nowActive = !!data.rutina.activa;
                      r.activa = nowActive;
                      btn.textContent = nowActive ? 'Desactivar' : 'Activar';
                      btn.setAttribute('data-activa', nowActive ? '1' : '0');
                      const activaCell = tr.querySelector('[data-col="activa"]');
                      if(activaCell) activaCell.textContent = nowActive ? 'Sí' : 'No';
                      // Feedback
                      try{ showToast(nowActive ? 'Rutina activada' : 'Rutina desactivada', 'success', 2500); }catch(_){}
                      // Sincronizar panel lateral y refrescar lista para reflejar unicidad
                      if(state.selectedRutina && Number(state.selectedRutina.id) === Number(r.id)){
                        state.selectedRutina.activa = nowActive;
                        updateRutinaSidePanel(state.selectedRutina);
                      }
                      const u = state.selectedUsuario; if(u && u.id){ try{ await loadRutinasPorUsuario(Number(u.id)); }catch(_){} }
                    } else {
                      const msg = (data && (data.detail || data.error || data.message)) ? String(data.detail || data.error || data.message) : 'No se pudo actualizar el estado de la rutina';
                      try{ showToast(msg, 'error', 4500); }catch(_){}
                    }
                  }catch(e){
                    try{ showToast('Error de red al actualizar el estado de la rutina', 'error', 4500); }catch(_){}
                  }finally{
                    btn.disabled = false;
                  }
                };
                doUpdate();
              }
            } else {
              // Seleccionar fila para actualizar panel lateral
              state.selectedRutina = r; updateRutinaSidePanel(r);
            }
          });
          tbody.appendChild(tr);
        });
        // Selección inicial para panel lateral
        if(Array.isArray(arr) && arr.length){
          state.selectedRutina = arr[0];
          updateRutinaSidePanel(arr[0]);
        } else {
          updateRutinaSidePanel(null);
        }
        block.style.display='';
        // Aplicar filtros de categoría de forma unificada
        applyRutinasFilters();
      }catch(e){ block.style.display=''; }
    }

    function updateRutinaSidePanel(r){
      const nombreEl = document.getElementById('rutina-side-nombre');
      const descEl = document.getElementById('rutina-side-descripcion');
      const btnEdit = document.getElementById('rutina-side-edit');
      const btnPrev = document.getElementById('rutina-side-preview');
      const btnDel = document.getElementById('rutina-side-delete');
      const btnAsn = document.getElementById('rutina-side-assign');
      const btnUn = document.getElementById('rutina-side-unassign');
      const none = '—';
      if(!nombreEl) return;
      if(r){
        if(nombreEl) nombreEl.textContent = r.nombre || r.nombre_rutina || none;
        if(descEl) descEl.textContent = r.descripcion || none;
        if(btnEdit) { btnEdit.disabled = false; btnEdit.textContent = 'Abrir'; btnEdit.onclick = () => openRutinaPreview(Number(r.id)); }
        if(btnPrev) { btnPrev.disabled = false; btnPrev.onclick = () => openRutinaPreview(Number(r.id)); }
        if(btnDel) { btnDel.disabled = false; btnDel.onclick = () => deleteRutina(r.id); }
        if(btnAsn) {
          btnAsn.disabled = false;
          if(state.activeRutinaTab === 'plantillas'){
            btnAsn.onclick = () => openAssignPlantilla(r.id);
            btnAsn.textContent = 'Asignar a usuario';
          } else {
            btnAsn.onclick = () => openAssignRutina(r.id);
            btnAsn.textContent = 'Asignar';
          }
        }
        if(btnUn) {
          const canUnassign = r.usuario_id != null;
          btnUn.disabled = !canUnassign;
          btnUn.onclick = canUnassign ? (() => openUnassignRutina(r.id)) : null;
        }
      } else {
        if(nombreEl) nombreEl.textContent = none;
        if(descEl) descEl.textContent = none;
        if(btnEdit) { btnEdit.disabled = true; btnEdit.onclick = null; }
        if(btnPrev) { btnPrev.disabled = true; btnPrev.onclick = null; }
        if(btnDel) { btnDel.disabled = true; btnDel.onclick = null; }
        if(btnAsn) { btnAsn.disabled = true; btnAsn.onclick = null; }
        if(btnUn) { btnUn.disabled = true; btnUn.onclick = null; }
      }
      // Bind de captura para ajustar la asignación según pestaña activa (una sola vez)
      const asnEl = document.getElementById('rutina-side-assign');
      if(asnEl && !state.__assignHandlerBound){
        asnEl.addEventListener('click', function(ev){
          ev.stopImmediatePropagation();
          if(state.selectedRutina){
            if(state.activeRutinaTab === 'plantillas'){ openAssignPlantilla(state.selectedRutina.id); }
            else { openAssignRutina(state.selectedRutina.id); }
          }
        }, true);
        state.__assignHandlerBound = true;
      }
    }
    function updateEjerciciosTable(){
      const tbody = document.querySelector('#ejercicios-table tbody');
      if(!tbody) return;
      tbody.innerHTML = '';
      const items = Array.isArray(state.ejercicios) ? state.ejercicios : [];
      items.forEach((e, idx) => {
        const tr = document.createElement('tr');
        tr.setAttribute('data-index', String(idx));
        tr.setAttribute('data-id', String(e.id || ''));
        tr.innerHTML = `
          <td>${e.nombre || ''}</td>
          <td>${e.grupo_muscular || ''}</td>
          <td>${e.objetivo || ''}</td>
          <td>${e.descripcion || ''}</td>
          <td>
            <button class="btn neutral" data-action="edit" data-index="${idx}" data-id="${e.id}">Editar</button>
            <button class="btn danger" data-action="delete" data-id="${e.id}">Eliminar</button>
          </td>`;
        tr.addEventListener('click', (ev) => {
          const isBtn = !!ev.target.closest('button');
          if(isBtn) return;
          state.selectedEjercicio = e;
          updateEjercicioSidePanel(e);
        });
        tbody.appendChild(tr);
      });
      const countEl = document.getElementById('ejercicios-count'); if(countEl) countEl.textContent = `${items.length} ejercicios`;
    }

    function bindEjerciciosEvents(){
      const btnRefresh = document.getElementById('ejercicios-refresh'); if(btnRefresh) btnRefresh.addEventListener('click', loadEjercicios);
      const qInput = document.getElementById('ejercicios-q'); if(qInput) qInput.addEventListener('keydown', (e) => { if(e.key === 'Enter') loadEjercicios(); });
      const objSel = document.getElementById('ejercicios-objetivo'); if(objSel) objSel.addEventListener('change', loadEjercicios);
      const grpSel = document.getElementById('ejercicios-grupo'); if(grpSel) grpSel.addEventListener('change', loadEjercicios);
      const btnNew = document.getElementById('ejercicios-new'); if(btnNew) btnNew.addEventListener('click', () => showEjercicioForm(null));

      const tbody = document.querySelector('#ejercicios-table tbody');
      if(tbody){
        tbody.addEventListener('click', (ev) => {
          const btn = ev.target.closest('button'); if(!btn) return;
          const action = btn.getAttribute('data-action');
          if(action === 'edit'){
            const idx = parseInt(btn.getAttribute('data-index') || '0', 10);
            const row = (state.ejercicios || [])[idx];
            showEjercicioForm(row || null);
          } else if(action === 'delete'){
            const id = btn.getAttribute('data-id');
            deleteEjercicio(id);
          }
        });
      }

      const btnSave = document.getElementById('save-ejercicio'); if(btnSave) btnSave.addEventListener('click', saveEjercicio);
      const btnCancel = document.getElementById('cancel-ejercicio'); if(btnCancel) btnCancel.addEventListener('click', hideEjercicioForm);
      const btnClose = document.getElementById('close-modal-ejercicio'); if(btnClose) btnClose.addEventListener('click', hideEjercicioForm);

      const delCancel = document.getElementById('ejercicio-delete-cancel'); if(delCancel) delCancel.addEventListener('click', () => closeModal('modal-ejercicio-delete'));
      const delConfirm = document.getElementById('ejercicio-delete-confirm'); if(delConfirm) delConfirm.addEventListener('click', confirmDeleteEjercicio);
      const delClose = document.getElementById('ejercicio-delete-close'); if(delClose) delClose.addEventListener('click', () => closeModal('modal-ejercicio-delete'));

      // Extras modal bindings
      const btnEditExtras = document.getElementById('ejercicio-side-edit-extras'); if(btnEditExtras) btnEditExtras.addEventListener('click', () => { if(state.selectedEjercicio) openExtrasModal(state.selectedEjercicio); });
      const btnSaveExtras = document.getElementById('save-extras'); if(btnSaveExtras) btnSaveExtras.addEventListener('click', saveExtras);
      const btnCancelExtras = document.getElementById('cancel-extras'); if(btnCancelExtras) btnCancelExtras.addEventListener('click', hideExtrasModal);
      const btnCloseExtras = document.getElementById('close-modal-extras'); if(btnCloseExtras) btnCloseExtras.addEventListener('click', hideExtrasModal);
    }

    function showEjercicioForm(e){
      state.editingEjercicioId = e && e.id ? Number(e.id) : null;
      state.ejercicioVideoFile = null; state.ejercicioVideoRemove = false; state.editingEjercicioOriginalVideoUrl = (e && e.video_url) ? String(e.video_url) : null;
      openModal('modal-ejercicio-form');
      const nombreEl = document.getElementById('ejercicio-nombre'); if(nombreEl) nombreEl.value = e && e.nombre ? String(e.nombre) : '';
      const grupoEl = document.getElementById('ejercicio-grupo'); if(grupoEl) grupoEl.value = e && e.grupo_muscular ? String(e.grupo_muscular) : '';
      const objEl = document.getElementById('ejercicio-objetivo'); if(objEl) objEl.value = e && e.objetivo ? String(e.objetivo) : 'general';
      const descEl = document.getElementById('ejercicio-descripcion'); if(descEl) descEl.value = e && e.descripcion ? String(e.descripcion) : '';
      const prev = document.getElementById('ejercicio-video-preview'); if(prev){
        prev.innerHTML = '';
        const url = e && e.video_url ? String(e.video_url) : '';
        if(url){
          if(/\.gif(\?.*)?$/.test(url)){
            const img = document.createElement('img'); img.src = url; img.alt = 'Animación del ejercicio'; img.className = 'responsive-media'; img.style.maxHeight = '220px'; prev.appendChild(img);
          } else {
            const v = document.createElement('video'); v.src = url; v.controls = true; v.playsInline = true; v.preload = 'metadata'; v.setAttribute('controlsList','nodownload noplaybackrate'); v.className = 'responsive-media'; v.style.maxHeight = '220px'; prev.appendChild(v);
          }
        } else {
          const p = document.createElement('p'); p.className = 'muted'; p.textContent = 'Sin video'; prev.appendChild(p);
        }
      }
      const fileEl = document.getElementById('ejercicio-video-file'); if(fileEl){
        try{ fileEl.value = ''; }catch(_){}
        const processVideoFile = (f) => {
          if(f){
            const type = (f.type || '').toLowerCase();
            const sizeMB = f.size ? (f.size / (1024*1024)) : 0;
            const isGif = type === 'image/gif' || /\.gif$/i.test(f.name || '');
            const isVideo = type.startsWith('video/');
            if(!(isGif || isVideo)){
              showToast('Archivo no permitido. Solo video o GIF.', 'warning', 3500);
              try{ fileEl.value = ''; }catch(_){}
              return;
            }
            if(sizeMB > 50){
              showToast('Archivo demasiado grande. Máximo 50MB.', 'warning', 4000);
              try{ fileEl.value = ''; }catch(_){}
              return;
            }
          }
          state.ejercicioVideoFile = f || null; state.ejercicioVideoRemove = false; const flg = document.getElementById('ejercicio-video-remove-flag'); if(flg) flg.textContent = '0';
          const prev2 = document.getElementById('ejercicio-video-preview'); if(prev2){ prev2.innerHTML = ''; if(f){
            const url2 = URL.createObjectURL(f);
            if((f.type||'').toLowerCase() === 'image/gif' || /\.gif$/i.test(f.name || '')){
              const img2 = document.createElement('img'); img2.src = url2; img2.alt = 'GIF seleccionado'; img2.className = 'responsive-media'; img2.style.maxHeight = '220px'; prev2.appendChild(img2);
            } else {
              const v2 = document.createElement('video'); v2.src = url2; v2.controls = true; v2.playsInline = true; v2.preload = 'metadata'; v2.setAttribute('controlsList','nodownload noplaybackrate'); v2.className = 'responsive-media'; v2.style.maxHeight = '220px'; prev2.appendChild(v2);
            }
          } else { const p2 = document.createElement('p'); p2.className = 'muted'; p2.textContent = 'Sin video'; prev2.appendChild(p2); } }
        };
        fileEl.onchange = () => {
          const f = fileEl.files && fileEl.files[0] ? fileEl.files[0] : null;
          processVideoFile(f);
        };
        // Dropzone bindings
        const dz = document.getElementById('ejercicio-video-dropzone');
        if(dz){
          const dzMsg = document.getElementById('ejercicio-video-msg');
          const baseMsg = (dzMsg && dzMsg.textContent) || 'Arrastra y suelta un video o GIF aquí, o haz clic para seleccionar';
          const setActive = (on) => { try{ dz.style.borderColor = on ? '#007bff' : '#ccc'; dz.style.backgroundColor = on ? 'rgba(0,120,255,0.06)' : ''; if(dzMsg) dzMsg.textContent = on ? 'Suelta aquí para cargar' : baseMsg; }catch(_){} };
          ['dragenter','dragover'].forEach(evName => dz.addEventListener(evName, (ev) => { ev.preventDefault(); ev.stopPropagation(); setActive(true);}));
          ['dragleave','drop'].forEach(evName => dz.addEventListener(evName, (ev) => { ev.preventDefault(); ev.stopPropagation(); setActive(false);}));
          dz.addEventListener('drop', (ev) => {
            const f = (ev.dataTransfer && ev.dataTransfer.files && ev.dataTransfer.files[0]) ? ev.dataTransfer.files[0] : null;
            if(f){ processVideoFile(f); }
          });
          dz.addEventListener('click', () => { try{ fileEl.click(); }catch(_){} });
          dz.addEventListener('keydown', (ev) => { if(ev.key === 'Enter' || ev.key === ' '){ ev.preventDefault(); try{ fileEl.click(); }catch(_){} } });
        }
        const selectBtn = document.getElementById('ejercicio-video-select');
        if(selectBtn){ selectBtn.onclick = () => { try{ fileEl.click(); }catch(_){} }; }
      }
      const rmBtn = document.getElementById('ejercicio-video-remove'); if(rmBtn){
        rmBtn.onclick = () => {
          state.ejercicioVideoFile = null; state.ejercicioVideoRemove = true; try{ (document.getElementById('ejercicio-video-file')||{}).value=''; }catch(_){}
          const flg2 = document.getElementById('ejercicio-video-remove-flag'); if(flg2) flg2.textContent = '1';
          const prev3 = document.getElementById('ejercicio-video-preview'); if(prev3){ prev3.innerHTML = ''; const p3 = document.createElement('p'); p3.className = 'muted'; p3.textContent = 'Se eliminará el video actual'; prev3.appendChild(p3); }
        };
      }
    }
    function hideEjercicioForm(){ closeModal('modal-ejercicio-form'); state.ejercicioVideoFile=null; state.ejercicioVideoRemove=false; state.editingEjercicioOriginalVideoUrl=null; const flg = document.getElementById('ejercicio-video-remove-flag'); if(flg) flg.textContent = '0'; }

    async function saveEjercicio(){
      const nombre = (document.getElementById('ejercicio-nombre') || {}).value || '';
      const grupo_muscular = (document.getElementById('ejercicio-grupo') || {}).value || '';
      const objetivo = (document.getElementById('ejercicio-objetivo') || {}).value || 'general';
      const descripcion = (document.getElementById('ejercicio-descripcion') || {}).value || '';
      if(!nombre.trim()){ showToast('El nombre es obligatorio', 'warning', 3000); return; }
      const body = { nombre, grupo_muscular, objetivo, descripcion };
      let url = '/api/ejercicios'; let method = 'POST';
      if(state.editingEjercicioId){ url = `/api/ejercicios/${state.editingEjercicioId}`; method = 'PUT'; }
      try{
        const res = await fetch(url, { method, headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(body) });
        if(res.status === 401){ showToast('Acceso restringido; inicie sesión en Gestión.', 'error', 4500); try{ window.location.href = '/gestion/login'; }catch(e){} return; }
        const data = await res.json().catch(() => ({}));
        if(!res.ok){ showToast(data.detail || data.error || 'No se pudo guardar', 'error', 4500); return; }
        const eid = Number((data && (data.id || (state.editingEjercicioId||0))) || 0);
        if(state.ejercicioVideoFile && eid){
          const fd = new FormData(); fd.append('file', state.ejercicioVideoFile); fd.append('overwrite', 'true');
          try{
            const up = await fetch(`/api/ejercicios/${eid}/media`, { method:'POST', body: fd });
            const jd = await up.json().catch(() => ({}));
            if(!up.ok){
              showToast(jd.detail || jd.error || 'No se pudo subir el video', 'error', 4500);
            } else {
              const loc = String(jd.storage || '').toLowerCase();
              if(loc === 'b2'){
                showToast('Video subido a Backblaze B2', 'success', 3000);
              } else if(loc === 'gcs'){
                showToast('Video subido a Google Cloud Storage', 'success', 3000);
              } else if(loc === 'local'){
                const warn = String(jd.warning || '').trim();
                showToast(warn || 'Subida remota falló; usando almacenamiento local temporal', 'warning', 6000);
              }
            }
          }catch(_){ showToast('Error de red al subir el video', 'error', 4500); }
        } else if(state.ejercicioVideoRemove && state.editingEjercicioOriginalVideoUrl && eid){
          try{
            const up2 = await fetch(`/api/ejercicios/${eid}`, { method:'PUT', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify({ video_url: null, video_mime: null }) });
            const jd2 = await up2.json().catch(() => ({})); if(!up2.ok){ showToast(jd2.detail || jd2.error || 'No se pudo eliminar el video', 'error', 4500); }
          }catch(_){ showToast('Error de red al eliminar el video', 'error', 4500); }
        }
        closeModal('modal-ejercicio-form');
        showToast('Ejercicio guardado', 'success', 2500);
        await loadEjercicios();
      }catch(e){ showToast('Error de red al guardar', 'error', 4500); }
    }

    function deleteEjercicio(id){
      if(!id){ showToast('Ejercicio no encontrado', 'warning', 3000); return; }
      state.deleteEjercicioId = Number(id);
      openModal('modal-ejercicio-delete');
    }
    async function confirmDeleteEjercicio(){
      const id = state.deleteEjercicioId; if(!id) return;
      try{
        const res = await fetch(`/api/ejercicios/${id}`, { method:'DELETE', headers:{ 'Accept':'application/json' } });
        if(res.status === 401){ showToast('Acceso restringido; inicie sesión en Gestión.', 'error', 4500); try{ window.location.href = '/gestion/login'; }catch(e){} return; }
        const data = await res.json().catch(() => ({}));
        if(!res.ok){ showToast(data.detail || data.error || 'No se pudo eliminar', 'error', 4500); return; }
        closeModal('modal-ejercicio-delete');
        showToast('Ejercicio eliminado', 'success', 2500);
        await loadEjercicios();
      }catch(e){ showToast('Error de red al eliminar', 'error', 4500); }
    }

    // ===== Ejercicios: extras (equipamiento y variantes) =====
    function parseExtrasFromDescripcion(text){
      const lines = String(text || '').split(/\r?\n/);
      const equipamiento = []; const variantes = []; const base = [];
      for(const l of lines){
        const s = String(l).trim();
        if(/^Equipamiento:/i.test(s)){
          const rest = s.replace(/^Equipamiento:/i, '').trim();
          const items = rest.split(/[;,]/).map(x => x.trim()).filter(Boolean);
          equipamiento.push(...items);
        } else if(/^Variantes:/i.test(s)){
          const rest = s.replace(/^Variantes:/i, '').trim();
          const items = rest.split(/[;,]/).map(x => x.trim()).filter(Boolean);
          variantes.push(...items);
        } else {
          base.push(l);
        }
      }
      return { baseDescripcion: base.join('\n').trim(), equipamiento, variantes };
    }
    function composeDescripcionWithExtras(base, equip, vars){
      const parts = [String(base || '').trim()];
      const eq = Array.isArray(equip) ? equip.filter(Boolean) : [];
      const va = Array.isArray(vars) ? vars.filter(Boolean) : [];
      if(eq.length) parts.push('Equipamiento: ' + eq.join('; '));
      if(va.length) parts.push('Variantes: ' + va.join('; '));
      return parts.filter(Boolean).join('\n\n').trim();
    }
    function openExtrasModal(e){
      if(!e){ showToast('Selecciona un ejercicio', 'warning', 3000); return; }
      const extras = parseExtrasFromDescripcion(e.descripcion || '');
      const eqEl = document.getElementById('extras-equipamiento'); if(eqEl) eqEl.value = (extras.equipamiento || []).join('\n');
      const varEl = document.getElementById('extras-variantes'); if(varEl) varEl.value = (extras.variantes || []).join('\n');
      openModal('modal-ejercicio-extras');
    }
    function hideExtrasModal(){ closeModal('modal-ejercicio-extras'); }
    async function saveExtras(){
      const e = state.selectedEjercicio; if(!e){ showToast('Selecciona un ejercicio', 'warning', 3000); return; }
      const eqRaw = (document.getElementById('extras-equipamiento') || {}).value || '';
      const varRaw = (document.getElementById('extras-variantes') || {}).value || '';
      const equipos = eqRaw.split(/\r?\n|;/).map(x => x.trim()).filter(Boolean);
      const variantes = varRaw.split(/\r?\n|;/).map(x => x.trim()).filter(Boolean);
      const parsed = parseExtrasFromDescripcion(e.descripcion || '');
      const descripcion = composeDescripcionWithExtras(parsed.baseDescripcion || '', equipos, variantes);
      const body = { nombre: e.nombre || '', grupo_muscular: e.grupo_muscular || '', objetivo: e.objetivo || 'general', descripcion };
      try{
        const res = await fetch(`/api/ejercicios/${e.id}`, { method: 'PUT', headers: { 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(body) });
        if(res.status === 401){ showToast('Acceso restringido; inicie sesión en Gestión.', 'error', 4500); try{ window.location.href = '/gestion/login'; }catch(_e){} return; }
        const data = await res.json().catch(() => ({}));
        if(!res.ok){ showToast(data.detail || data.error || 'No se pudo guardar extras', 'error', 4500); return; }
        hideExtrasModal();
        showToast('Extras actualizados', 'success', 2500);
        await loadEjercicios();
      }catch(_){ showToast('Error de red al guardar extras', 'error', 4500); }
    }

    function updateEjercicioSidePanel(e){
      const nombreEl = document.getElementById('ejercicio-side-nombre');
      const objEl = document.getElementById('ejercicio-side-objetivo');
      const grpEl = document.getElementById('ejercicio-side-grupo');
      const descEl = document.getElementById('ejercicio-side-descripcion');
      const tipsEl = document.getElementById('ejercicio-side-tips');
      const eqEl = document.getElementById('ejercicio-side-equipos');
      const varEl = document.getElementById('ejercicio-side-variantes');
      const mediaEl = document.getElementById('ejercicio-side-media');
      const btnEdit = document.getElementById('ejercicio-side-edit');
      const btnDel = document.getElementById('ejercicio-side-delete');
      const none = '—';
      if(!nombreEl) return;
      if(e){
        nombreEl.textContent = e.nombre || none;
        objEl.textContent = e.objetivo || none;
        grpEl.textContent = e.grupo_muscular || none;
        descEl.textContent = e.descripcion || none;
      if(mediaEl){ mediaEl.innerHTML = ''; const url = e.video_url; if(url){ if(/\.gif(\?.*)?$/.test(url)){ const img = document.createElement('img'); img.src = url; img.alt = 'Animación del ejercicio'; img.className='responsive-media'; img.style.maxHeight='220px'; mediaEl.appendChild(img);} else { const v = document.createElement('video'); v.src = url; v.controls = true; v.playsInline = true; v.preload='metadata'; v.setAttribute('controlsList','nodownload noplaybackrate'); v.className='responsive-media'; v.style.maxHeight='220px'; mediaEl.appendChild(v);} } else { const p = document.createElement('p'); p.className='muted'; p.textContent='Sin video'; mediaEl.appendChild(p);} }
        tipsEl.innerHTML = renderList(ejercicioTips(e.objetivo, e.grupo_muscular));
        const extras = parseExtrasFromDescripcion(e.descripcion || '');
        const equiposList = (extras.equipamiento && extras.equipamiento.length) ? extras.equipamiento : ejercicioEquipos(e.grupo_muscular);
        const variantesList = (extras.variantes && extras.variantes.length) ? extras.variantes : ejercicioVariantes(e.grupo_muscular);
        eqEl.innerHTML = renderList(equiposList);
        varEl.innerHTML = renderList(variantesList);
        if(btnEdit) btnEdit.disabled = false;
        if(btnDel) btnDel.disabled = false;
        if(btnEdit) btnEdit.onclick = () => showEjercicioForm(e);
        if(btnDel) btnDel.onclick = () => deleteEjercicio(e.id);
        const btnXtra = document.getElementById('ejercicio-side-edit-extras');
        if(btnXtra){ btnXtra.disabled = false; btnXtra.onclick = () => openExtrasModal(e); }
      } else {
        nombreEl.textContent = none;
        objEl.textContent = none;
        grpEl.textContent = none;
        if(mediaEl){ mediaEl.innerHTML = '<p class="muted">Sin video</p>'; }
        descEl.textContent = none;
        tipsEl.innerHTML = '<li class="muted">Selecciona un ejercicio para ver consejos</li>';
        eqEl.innerHTML = '<li class="muted">—</li>';
        varEl.innerHTML = '<li class="muted">—</li>';
        if(btnEdit) btnEdit.disabled = true;
        if(btnDel) btnDel.disabled = true;
        if(btnEdit) btnEdit.onclick = null;
        if(btnDel) btnDel.onclick = null;
        const btnXtra = document.getElementById('ejercicio-side-edit-extras');
        if(btnXtra){ btnXtra.disabled = true; btnXtra.onclick = null; }
      }
    }
    function renderList(items){ const arr = Array.isArray(items) ? items : []; if(arr.length===0){ return '<li class="muted">—</li>'; } return arr.map(x => `<li>${x}</li>`).join(''); }
    function ejercicioTips(objetivo, grupo){
      const tips = {
        general: ['Calentamiento previo 5–10 min', 'Controla la técnica y rango de movimiento'],
        fuerza: ['Prioriza multiarticulares', 'Descansos largos 2–3 min entre series'],
        hipertrofia: ['Tempo controlado', 'Series de 8–12 reps', 'Progresión semanal del volumen'],
        resistencia: ['Circuitos con pausas cortas', 'Mantén respiración constante'],
        cardio: ['Intensidad moderada y sostenida', 'Hidratación en sesiones largas'],
        flexibilidad: ['No rebotes', 'Exhala en la fase de extensión']
      };
      const base = tips[String(objetivo || 'general')] || tips.general;
      const extra = {
        Piernas: ['En sentadillas, mantén columna neutra', 'Alinea rodillas con punta de pies'],
        Espalda: ['Retracción escapular antes de traccionar'],
        Pecho: ['Codos a ~45° en press', 'No hiperextiendas en banca'],
        Hombros: ['Evita elevación excesiva en laterales'],
        Brazos: ['No balancees en curls; usa control'],
        Core: ['Activa abdomen, evita hiperextensión lumbar'],
        'Full Body': ['Ordena del más demandante al más técnico']
      }[String(grupo || '')] || [];
      return base.concat(extra);
    }
    function ejercicioEquipos(grupo){
      const map = {
        Piernas: ['Barra', 'Mancuernas', 'Máquina prensa', 'Banda elástica'],
        Espalda: ['Polea', 'Barra', 'Mancuernas'],
        Pecho: ['Banco', 'Barra', 'Mancuernas'],
        Hombros: ['Mancuernas', 'Polea', 'Barra'],
        Brazos: ['Mancuernas', 'Polea'],
        Core: ['Esterilla', 'Rueda abdominal'],
        'Full Body': ['Barra', 'Mancuernas', 'Kettlebell']
      };
      return map[String(grupo || '')] || ['—'];
    }
    function ejercicioVariantes(grupo){
      const map = {
        Piernas: ['Sentadilla frontal', 'Zancadas', 'Prensa inclinada'],
        Espalda: ['Remo con barra', 'Dominadas supinas'],
        Pecho: ['Press inclinado', 'Fondos en paralelas'],
        Hombros: ['Press militar', 'Elevaciones frontales'],
        Brazos: ['Curl martillo', 'Extensiones sobre cabeza'],
        Core: ['Plancha lateral', 'Dead bug'],
        'Full Body': ['Thrusters', 'Complexes con barra']
      };
      return map[String(grupo || '')] || [];
    }

  function renderLoginInfo(){
    const el = document.getElementById('login-current');
    if(!el) return;
    const role = (el.getAttribute('data-role') || '').trim();
    if(role === 'dueño'){
      const name = '<i class="bi bi-shield-check" aria-hidden="true"></i><span>Dueño</span>';
      el.setAttribute('data-name', name);
      el.setAttribute('data-status', 'Sesión: —');
      composeTopBarBase();
      const topEstadoEl = document.getElementById('prof-sesion-estado');
      if(topEstadoEl) topEstadoEl.style.display = 'none';
      const startBtn = document.getElementById('sesion-iniciar');
      const endBtn = document.getElementById('sesion-finalizar');
      if(startBtn) startBtn.style.display = '';
      if(endBtn) endBtn.style.display = '';
      return;
    }
    const pidRaw = el.getAttribute('data-prof-id') || '';
    const uidRaw = el.getAttribute('data-prof-uid') || '';
    const pid = pidRaw ? Number(pidRaw) : null;
    const uid = uidRaw ? Number(uidRaw) : null;
    const baseDefaultName = '<i class="bi bi-person-badge" aria-hidden="true"></i><span>Profesor</span>';
    const topEstadoEl = document.getElementById('prof-sesion-estado');
    if(topEstadoEl) topEstadoEl.style.display = '';
      // Ocultar botones de inicio/fin de sesión para profesor
      const startBtn = document.getElementById('sesion-iniciar');
      const endBtn = document.getElementById('sesion-finalizar');
      if(startBtn) startBtn.style.display = 'none';
      if(endBtn) endBtn.style.display = 'none';
    if(pid || uid){
      fetch('/api/profesores_basico', { headers: { 'Accept': 'application/json' } })
        .then(r => r.ok ? r.json() : [])
        .then(list => {
          const arr = Array.isArray(list) ? list : [];
          const profByPid = pid ? arr.find(x => String(x.profesor_id) === String(pid)) : null;
          const profByUid = (!profByPid && uid) ? arr.find(x => String(x.usuario_id) === String(uid)) : null;
          const prof = profByPid || profByUid;
          const name = (prof && prof.nombre) ? `<i class=\"bi bi-person-badge\" aria-hidden=\"true\"></i><span>${String(prof.nombre).replace(/</g,'&lt;').replace(/>/g,'&gt;')}</span>` : baseDefaultName;
          el.setAttribute('data-name', name);
          el.setAttribute('data-status', 'Sesión: —');
          composeTopBarBase();
          if(prof && prof.profesor_id){ el.setAttribute('data-prof-id', String(prof.profesor_id)); }
        })
        .catch(() => { el.setAttribute('data-name', baseDefaultName); el.setAttribute('data-status','Sesión: —'); composeTopBarBase(); });
    } else {
      el.setAttribute('data-name', baseDefaultName);
      el.setAttribute('data-status', 'Sesión: —');
      composeTopBarBase();
    }
  }

  // ===== Clases (Gestión) =====
  const clasesState = { list: [], selectedId: null, selectedHorarioId: null, tipos: [], profesores: [], horarios: [] };
  async function ensureClasesState(){
    try {
      if(!Array.isArray(clasesState.tipos) || clasesState.tipos.length === 0){
        const r = await fetch('/api/tipos_clases', { headers: { 'Accept': 'application/json' } });
        clasesState.tipos = r.ok ? (await r.json()) : [];
      }
    } catch(_){ clasesState.tipos = []; }
    try {
      if(!Array.isArray(clasesState.profesores) || clasesState.profesores.length === 0){
        const r = await fetch('/api/profesores_basico', { headers: { 'Accept': 'application/json' } });
        clasesState.profesores = r.ok ? (await r.json()) : [];
      }
    } catch(_){ clasesState.profesores = []; }
    // Pintar selects de tipo y profesor
    try {
      const tipoSel = document.getElementById('clases-tipo-filter');
      const tipoSide = document.getElementById('clase-side-tipo');
      if(tipoSel){ tipoSel.innerHTML = '<option value="">Todos los tipos</option>' + (clasesState.tipos||[]).map(t => `<option value="${String(t.id||t.tipo_clase_id||'').replace(/</g,'&lt;').replace(/>/g,'&gt;')}">${String(t.nombre||t.tipo||'').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</option>`).join(''); }
      if(tipoSide){ tipoSide.innerHTML = (clasesState.tipos||[]).map(t => `<option value="${String(t.id||t.tipo_clase_id||'').replace(/</g,'&lt;').replace(/>/g,'&gt;')}">${String(t.nombre||t.tipo||'').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</option>`).join(''); }
    } catch(_){}
    try {
      const profSel = document.getElementById('clase-horario-profesor');
      const mProfSel = document.getElementById('modal-clase-horario-profesor');
      if(profSel){
        profSel.innerHTML = '<option value="">Sin profesor</option>' + (clasesState.profesores||[]).map(p => `<option value="${String(p.profesor_id||'').replace(/</g,'&lt;').replace(/>/g,'&gt;')}">${String(p.nombre||'').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</option>`).join('');
      }
      if(mProfSel){
        mProfSel.innerHTML = '<option value="">Sin profesor</option>' + (clasesState.profesores||[]).map(p => `<option value="${String(p.profesor_id||'').replace(/</g,'&lt;').replace(/>/g,'&gt;')}">${String(p.nombre||'').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</option>`).join('');
      }
    } catch(_){}
  }

  async function loadClases(){
    const q = (document.getElementById('clases-q')?.value || '').trim().toLowerCase();
    const tipoFilter = document.getElementById('clases-tipo-filter')?.value || '';
    try {
      const r = await fetch('/api/clases', { headers: { 'Accept': 'application/json' } });
      const arr = r.ok ? (await r.json()) : [];
      clasesState.list = Array.isArray(arr) ? arr : [];
      let filtered = clasesState.list;
      if(q){ filtered = filtered.filter(x => String(x.nombre||'').toLowerCase().includes(q) || String(x.descripcion||'').toLowerCase().includes(q)); }
      if(tipoFilter){ filtered = filtered.filter(x => String(x.tipo_clase_id||'') === String(tipoFilter)); }
      renderClasesTable(filtered);
      const countEl = document.getElementById('clases-count');
      if(countEl) countEl.textContent = `${filtered.length} clases`;
    } catch(e){ showToast('Error al cargar clases', 'error'); }
  }

  function renderClasesTable(list){
    const tbody = document.querySelector('#clases-table tbody');
    if(!tbody) return;
    tbody.innerHTML = '';
    const rows = (Array.isArray(list) ? list : []).map(c => {
      const nombre = String(c.nombre||'').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      const desc = String(c.descripcion||'').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      const tipo = String(c.tipo_clase_nombre||c.tipo||'').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      const activa = (c.activa===true || String(c.activa)=='1') ? 'Sí' : 'No';
      return `<tr data-id="${String(c.id||'').replace(/</g,'&lt;').replace(/>/g,'&gt;')}">
        <td>${nombre}</td>
        <td>${desc||'—'}</td>
        <td>${tipo||'—'}</td>
        <td>${activa}</td>
        <td>
          <button class="btn outline neutral sm" data-action="edit">Editar</button>
          <button class="btn danger sm" data-action="delete">Eliminar</button>
        </td>
      </tr>`;
    }).join('');
    tbody.innerHTML = rows || '';
    tbody.querySelectorAll('tr').forEach(tr => {
      // Resaltar la clase seleccionada (accesible y responsivo)
      const idRow = tr.getAttribute('data-id');
      if(String(idRow) === String(clasesState.selectedId||'')){
        tr.classList.add('selected');
        tr.setAttribute('aria-selected','true');
      } else {
        tr.classList.remove('selected');
        tr.removeAttribute('aria-selected');
      }
      tr.addEventListener('click', (e) => { if(!(e.target instanceof HTMLElement) || e.target.closest('button')) return; const id = tr.getAttribute('data-id'); selectClase(id); });
      tr.addEventListener('dblclick', (e) => { const id = tr.getAttribute('data-id'); selectClase(id); openClaseModal(id); });
      const edit = tr.querySelector('button[data-action="edit"]');
      const del = tr.querySelector('button[data-action="delete"]');
      if(edit) edit.addEventListener('click', (e) => { e.stopPropagation(); const id = tr.getAttribute('data-id'); selectClase(id); openClaseModal(id); });
      if(del) del.addEventListener('click', async (e) => { e.stopPropagation(); await deleteClase(tr.getAttribute('data-id')); });
    });
  }

  function setClaseSideVisible(has){
    const emptyEl = document.getElementById('clase-side-empty');
    const cont = document.getElementById('clase-side-content');
    if(emptyEl && cont){ emptyEl.style.display = has ? 'none' : ''; cont.style.display = has ? '' : 'none'; }
  }

  async function selectClase(id){
    const clase = (clasesState.list||[]).find(x => String(x.id||'') === String(id));
    clasesState.selectedId = clase ? clase.id : null;
    // Actualizar resaltado en la tabla de clases
    const tbody = document.querySelector('#clases-table tbody');
    if(tbody){
      tbody.querySelectorAll('tr').forEach(tr => {
        const isSel = String(tr.getAttribute('data-id')||'') === String(clasesState.selectedId||'');
        tr.classList.toggle('selected', isSel);
        if(isSel){ tr.setAttribute('aria-selected','true'); } else { tr.removeAttribute('aria-selected'); }
      });
    }
    const idEl = document.getElementById('clase-side-id'); if(idEl) idEl.textContent = clase ? `#${clase.id}` : '';
    const nombreEl = document.getElementById('clase-side-nombre'); if(nombreEl) nombreEl.value = String(clase?.nombre||'');
    const descEl = document.getElementById('clase-side-descripcion'); if(descEl) descEl.value = String(clase?.descripcion||'');
    const tipoEl = document.getElementById('clase-side-tipo'); if(tipoEl) tipoEl.value = String(clase?.tipo_clase_id||'');
    const actEl = document.getElementById('clase-side-activa'); if(actEl) actEl.checked = (clase?.activa===true || String(clase?.activa)=='1');
    setClaseSideVisible(!!clase);
    if(clase && clase.id){ await loadClaseHorarios(clase.id); }
  }

  async function saveClase(){
    const id = clasesState.selectedId;
    const body = {
      nombre: document.getElementById('clase-side-nombre')?.value || '',
      descripcion: document.getElementById('clase-side-descripcion')?.value || '',
      activa: !!document.getElementById('clase-side-activa')?.checked,
      tipo_clase_id: document.getElementById('clase-side-tipo')?.value || null
    };
    try {
      let r;
      if(id){ r = await fetch(`/api/clases/${id}`,{ method:'PUT', headers:{'Content-Type':'application/json','Accept':'application/json'}, body: JSON.stringify(body)}); }
      else { r = await fetch('/api/clases',{ method:'POST', headers:{'Content-Type':'application/json','Accept':'application/json'}, body: JSON.stringify(body)}); }
      if(!r.ok){ showToast('No se pudo guardar la clase', 'error'); return; }
      showToast('Clase guardada', 'success');
      await loadClases();
      if(!id){ // si era nueva, seleccionar la última creada por nombre
        const created = (clasesState.list||[]).find(x => String(x.nombre||'') === String(body.nombre));
        if(created){ await selectClase(created.id); }
      }
    } catch(e){ showToast('Error de red al guardar clase', 'error'); }
  }

  async function deleteClase(id){
    if(!id){ showToast('Selecciona una clase', 'warning'); return; }
    try {
      const ok = confirm('¿Eliminar la clase seleccionada?');
      if(!ok) return;
    } catch(_){ /* sin modal, continuar */ }
    try {
      const r = await fetch(`/api/clases/${id}`, { method:'DELETE', headers:{ 'Accept':'application/json' } });
      if(!r.ok){ showToast('No se pudo eliminar la clase', 'error'); return; }
      showToast('Clase eliminada', 'success');
      clasesState.selectedId = null; setClaseSideVisible(false);
      await loadClases();
      // limpiar horarios
      const tb = document.querySelector('#clase-horarios-table tbody'); if(tb) tb.innerHTML='';
      const emp = document.getElementById('clase-horarios-empty'); if(emp) emp.style.display='';
    } catch(e){ showToast('Error de red al eliminar clase', 'error'); }
  }

  async function loadClaseHorarios(claseId){
    try {
      const r = await fetch(`/api/clases/${claseId}/horarios`, { headers:{ 'Accept':'application/json' } });
      const arr = r.ok ? (await r.json()) : [];
      clasesState.horarios = Array.isArray(arr) ? arr : [];
      renderHorariosTable(clasesState.horarios);
    } catch(e){ showToast('Error al cargar horarios de clase', 'error'); }
  }

  function renderHorariosTable(list){
    const tbody = document.querySelector('#clase-horarios-table tbody');
    const empty = document.getElementById('clase-horarios-empty');
    if(!tbody) return;
    const rows = (Array.isArray(list)?list:[]).map(h => {
      const dia = String(h.dia_semana||h.dia||'').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      const ini = String(h.hora_inicio||'').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      const fin = String(h.hora_fin||'').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      const prof = String(h.nombre_profesor||h.profesor_nombre||'').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      const cupo = String(h.cupo_maximo||'').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      const ins = String(h.inscriptos||'').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      return `<tr data-id="${String(h.id||h.horario_id||'').replace(/</g,'&lt;').replace(/>/g,'&gt;')}">
        <td>${dia||'—'}</td>
        <td>${ini||'—'}</td>
        <td>${fin||'—'}</td>
        <td>${prof||'—'}</td>
        <td>${cupo||'—'}</td>
        <td>${ins||'0'}</td>
        <td>
          <button class="btn outline neutral sm" data-action="assign">Asignar profesor</button>
          <button class="btn outline neutral sm" data-action="unassign">Desasignar</button>
          <button class="btn danger sm" data-action="delete">Eliminar</button>
        </td>
      </tr>`;
    }).join('');
    tbody.innerHTML = rows || '';
    if(empty) empty.style.display = (tbody.children.length === 0) ? '' : 'none';
    tbody.querySelectorAll('tr').forEach(tr => {
      const id = tr.getAttribute('data-id');
      tr.addEventListener('click', async () => {
        try { clasesState.selectedHorarioId = id ? Number(id) : null; } catch(_) { clasesState.selectedHorarioId = null; }
        await loadHorarioUsuarios(clasesState.selectedHorarioId);
      });
      const assign = tr.querySelector('button[data-action="assign"]');
      const unassign = tr.querySelector('button[data-action="unassign"]');
      const del = tr.querySelector('button[data-action="delete"]');
      if(assign) assign.addEventListener('click', async (e) => {
        e.stopPropagation();
        const profId = document.getElementById('clase-horario-profesor')?.value || '';
        if(!profId){ showToast('Selecciona un profesor', 'warning'); return; }
        try {
          const r = await fetch(`/api/clases/horarios/${id}/asignar_profesor`, { method:'POST', headers:{ 'Content-Type':'application/json','Accept':'application/json' }, body: JSON.stringify({ profesor_id: profId }) });
          if(!r.ok){ showToast('No se pudo asignar profesor', 'error'); return; }
          showToast('Profesor asignado', 'success');
          if(clasesState.selectedId){ await loadClaseHorarios(clasesState.selectedId); }
        } catch(e){ showToast('Error de red al asignar', 'error'); }
      });
      if(unassign) unassign.addEventListener('click', async (e) => {
        e.stopPropagation();
        const profId = document.getElementById('clase-horario-profesor')?.value || '';
        if(!profId){ showToast('Selecciona un profesor', 'warning'); return; }
        try {
          const r = await fetch(`/api/clases/horarios/${id}/desasignar_profesor`, { method:'POST', headers:{ 'Content-Type':'application/json','Accept':'application/json' }, body: JSON.stringify({ profesor_id: profId }) });
          if(!r.ok){ showToast('No se pudo desasignar profesor', 'error'); return; }
          showToast('Profesor desasignado', 'success');
          if(clasesState.selectedId){ await loadClaseHorarios(clasesState.selectedId); }
        } catch(e){ showToast('Error de red al desasignar', 'error'); }
      });
      if(del) del.addEventListener('click', async (e) => {
        e.stopPropagation();
        try { const ok = confirm('¿Eliminar horario?'); if(!ok) return; } catch(_){}
        try {
          const r = await fetch(`/api/clases/horarios/${id}`, { method:'DELETE', headers:{ 'Accept':'application/json' } });
          if(!r.ok){ showToast('No se pudo eliminar horario', 'error'); return; }
          showToast('Horario eliminado', 'success');
          if(clasesState.selectedId){ await loadClaseHorarios(clasesState.selectedId); }
        } catch(e){ showToast('Error de red al eliminar horario', 'error'); }
      });
    });
    // Actualizar selectores de horarios (panel principal y modal)
    updateHorariosSelectors(list);
  }

  async function addHorario(){
    const cid = clasesState.selectedId;
    if(!cid){ showToast('Selecciona una clase', 'warning'); return; }
    const dia = document.getElementById('clase-horario-dia')?.value || '';
    const hIni = document.getElementById('clase-horario-inicio')?.value || '';
    const hFin = document.getElementById('clase-horario-fin')?.value || '';
    const cupoRaw = document.getElementById('clase-horario-cupo')?.value || '';
    const profId = document.getElementById('clase-horario-profesor')?.value || '';
    const cupo = Number(cupoRaw || 0);
    if(!dia || !hIni || !hFin || !cupo || cupo <= 0){ showToast('Completa día, inicio, fin y un cupo válido (>0)', 'warning'); return; }
    const body = { dia_semana: dia, hora_inicio: hIni, hora_fin: hFin, cupo_maximo: cupo };
    if(profId){ body.profesor_id = profId; }
    try {
      const r = await fetch(`/api/clases/${cid}/horarios`, { method:'POST', headers:{ 'Content-Type':'application/json','Accept':'application/json' }, body: JSON.stringify(body) });
      if(!r.ok){ showToast('No se pudo crear horario', 'error'); return; }
      await r.json().catch(()=>({}));
      showToast('Horario creado', 'success');
      await loadClaseHorarios(cid);
    } catch(e){ showToast('Error de red al crear horario', 'error'); }
  }

  function updateHorariosSelectors(list){
    try {
      const opts = (Array.isArray(list)?list:[]).map(h => {
        const id = String(h.id||h.horario_id||'').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        const dia = String(h.dia_semana||h.dia||'').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        const ini = String(h.hora_inicio||'').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        const fin = String(h.hora_fin||'').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        const prof = String(h.nombre_profesor||h.profesor_nombre||'').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        const cupo = String(h.cupo_maximo||'').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        const lbl = `${dia||'—'} ${ini||'—'}-${fin||'—'}${prof?` · ${prof}`:''}${cupo?` · cupo ${cupo}`:''}`;
        return `<option value="${id}">${lbl}</option>`;
      }).join('');
      const selMain = document.getElementById('clase-horario-select');
      if(selMain){ selMain.innerHTML = '<option value="">Ver horarios guardados…</option>' + (opts||''); }
      const selModal = document.getElementById('modal-clase-horarios-select');
      if(selModal){ selModal.innerHTML = '<option value="">Selecciona un horario…</option>' + (opts||''); }
    } catch(_){}
  }

  async function loadModalClaseHorarios(claseId){
    if(!claseId) return;
    try {
      const r = await fetch(`/api/clases/${claseId}/horarios`, { headers:{ 'Accept':'application/json' } });
      const arr = r.ok ? (await r.json()) : [];
      clasesState.horarios = Array.isArray(arr) ? arr : [];
      updateHorariosSelectors(clasesState.horarios);
    } catch(_){ /* silencio en modal */ }
  }

  async function addModalHorario(){
    const modal = document.getElementById('modal-clase');
    const idRaw = modal?.getAttribute('data-id') || '';
    const cid = idRaw ? Number(idRaw) : null;
    if(!cid){ showToast('Primero guarda la clase para añadir horarios', 'warning'); return; }
    const dia = document.getElementById('modal-clase-horario-dia')?.value || '';
    const hIni = document.getElementById('modal-clase-horario-inicio')?.value || '';
    const hFin = document.getElementById('modal-clase-horario-fin')?.value || '';
    const cupoRaw = document.getElementById('modal-clase-horario-cupo')?.value || '';
    const profId = document.getElementById('modal-clase-horario-profesor')?.value || '';
    const cupo = Number(cupoRaw || 0);
    if(!dia || !hIni || !hFin || !cupo || cupo <= 0){ showToast('Completa día, inicio, fin y un cupo válido (>0)', 'warning'); return; }
    const body = { dia_semana: dia, hora_inicio: hIni, hora_fin: hFin, cupo_maximo: cupo };
    if(profId){ body.profesor_id = profId; }
    try {
      const r = await fetch(`/api/clases/${cid}/horarios`, { method:'POST', headers:{ 'Content-Type':'application/json','Accept':'application/json' }, body: JSON.stringify(body) });
      if(!r.ok){ showToast('No se pudo crear horario', 'error'); return; }
      await r.json().catch(()=>({}));
      showToast('Horario creado', 'success');
      await Promise.all([
        loadClaseHorarios(cid),
        loadModalClaseHorarios(cid)
      ]);
    } catch(e){ showToast('Error de red al crear horario', 'error'); }
  }

  function clearClaseSelection(){
    clasesState.selectedId = null;
    // limpiar panel lateral
    const idEl = document.getElementById('clase-side-id'); if(idEl) idEl.textContent = '';
    const nombreEl = document.getElementById('clase-side-nombre'); if(nombreEl) nombreEl.value = '';
    const descEl = document.getElementById('clase-side-descripcion'); if(descEl) descEl.value = '';
    const tipoEl = document.getElementById('clase-side-tipo'); if(tipoEl) tipoEl.value = '';
    const actEl = document.getElementById('clase-side-activa'); if(actEl) actEl.checked = true;
    setClaseSideVisible(false);
    // limpiar horarios
    const tb = document.querySelector('#clase-horarios-table tbody'); if(tb) tb.innerHTML='';
    const emp = document.getElementById('clase-horarios-empty'); if(emp) emp.style.display='';
  }

  function bindClasesEvents(){
    const qEl = document.getElementById('clases-q'); if(qEl){ qEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter') loadClases(); }); }
    const tipoEl = document.getElementById('clases-tipo-filter'); if(tipoEl){ tipoEl.addEventListener('change', loadClases); }
    const refEl = document.getElementById('clases-refresh'); if(refEl){ refEl.addEventListener('click', loadClases); }
    const newEl = document.getElementById('clases-new'); if(newEl){ newEl.addEventListener('click', () => { openClaseModal(null); }); }
    const saveEl = document.getElementById('clase-side-save'); if(saveEl){ saveEl.addEventListener('click', saveClase); }
  const editModalEl = document.getElementById('clases-edit'); if(editModalEl){ editModalEl.addEventListener('click', () => { if(!clasesState.selectedId){ showToast('Selecciona una clase', 'warning'); return; } openClaseModal(clasesState.selectedId); }); }
    const delEl = document.getElementById('clase-side-delete'); if(delEl){ delEl.addEventListener('click', async ()=>{ if(!clasesState.selectedId){ showToast('Selecciona una clase', 'warning'); return; } await deleteClase(clasesState.selectedId); }); }
    const clrEl = document.getElementById('clases-clear-selection'); if(clrEl){ clrEl.addEventListener('click', clearClaseSelection); }
    const addHorEl = document.getElementById('clase-horario-add'); if(addHorEl){ addHorEl.addEventListener('click', addHorario); }
    const selHorEl = document.getElementById('clase-horario-select'); if(selHorEl){ selHorEl.addEventListener('change', () => { const id = Number(selHorEl.value||0); clasesState.selectedHorarioId = id || null; loadHorarioUsuarios(clasesState.selectedHorarioId); }); }
    const insBtn = document.getElementById('horario-inscribir-btn'); if(insBtn){ insBtn.addEventListener('click', inscribirUsuarioEnHorario); }
    const notifyBtn = document.getElementById('horario-notify-btn'); if(notifyBtn){ notifyBtn.addEventListener('click', notifyWaitlistFirst); }
    const mClose = document.getElementById('modal-clase-close'); if(mClose){ mClose.addEventListener('click', closeClaseModal); }
    const mCancel = document.getElementById('modal-clase-cancel'); if(mCancel){ mCancel.addEventListener('click', closeClaseModal); }
    const mSave = document.getElementById('modal-clase-save'); if(mSave){ mSave.addEventListener('click', saveClaseModal); }
    const mHorAdd = document.getElementById('modal-clase-horario-add'); if(mHorAdd){ mHorAdd.addEventListener('click', addModalHorario); }
    const mHorRef = document.getElementById('modal-clase-horario-refresh'); if(mHorRef){ mHorRef.addEventListener('click', () => { const idRaw = document.getElementById('modal-clase')?.getAttribute('data-id')||''; const cid = idRaw ? Number(idRaw) : null; if(cid) loadModalClaseHorarios(cid); }); }
    const mHorSel = document.getElementById('modal-clase-horarios-select'); if(mHorSel){ mHorSel.addEventListener('change', () => { const id = Number(mHorSel.value||0); clasesState.selectedHorarioId = id || null; loadHorarioUsuarios(clasesState.selectedHorarioId); }); }
    const ejSearch = document.getElementById('modal-clase-ejercicios-search'); if(ejSearch){ ejSearch.addEventListener('input', filterModalEjercicios); }
    const ejOpenBtn = document.getElementById('modal-clase-open-ejercicios'); if(ejOpenBtn){ ejOpenBtn.addEventListener('click', () => { const idRaw = document.getElementById('modal-clase')?.getAttribute('data-id')||''; const cid = idRaw ? Number(idRaw) : null; if(!cid){ showToast('Primero guarda la clase', 'warning'); return; } openClaseEjerciciosModal(cid); }); }
    const tipoNewBtn = document.getElementById('modal-clase-tipo-new'); if(tipoNewBtn){ tipoNewBtn.addEventListener('click', async ()=>{ const nombre = prompt('Nombre del nuevo tipo de clase'); if(!nombre || !nombre.trim()) return; try{ const r = await fetch('/api/tipos_clases', { method:'POST', headers:{ 'Content-Type':'application/json','Accept':'application/json' }, body: JSON.stringify({ nombre: nombre.trim() }) }); if(!r.ok){ showToast('No se pudo crear el tipo', 'error'); return; } const data = await r.json(); await ensureClasesState(); const tipoEl = document.getElementById('modal-clase-tipo'); if(tipoEl){ tipoEl.innerHTML = (clasesState.tipos||[]).map(t => `<option value="${String(t.id||t.tipo_clase_id||'').replace(/</g,'&lt;').replace(/>/g,'&gt;')}">${String(t.nombre||t.tipo||'').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</option>`).join(''); tipoEl.value = String(data?.id||''); } showToast('Tipo creado', 'success'); }catch(e){ showToast('Error de red al crear tipo', 'error'); } }); }
    const uSearch = document.getElementById('horario-usuario-search'); const uSelect = document.getElementById('horario-usuario-select');
    if(uSearch && uSelect){
      uSearch.addEventListener('input', debounce(async ()=>{
        const q = (uSearch.value||'').trim();
        if(!q){ uSelect.innerHTML = '<option value="">Selecciona usuario…</option>'; return; }
        try{
          const r = await fetch(`/api/usuarios?q=${encodeURIComponent(q)}&limit=20`, { headers:{ 'Accept':'application/json' } });
          const list = r.ok ? (await r.json()) : [];
          const opts = '<option value="">Selecciona usuario…</option>' + (Array.isArray(list)?list:[]).map(u => {
            const nombre = String(u.nombre||'').replace(/</g,'&lt;').replace(/>/g,'&gt;');
            const dni = u.dni ? `, DNI: ${String(u.dni).replace(/</g,'&lt;').replace(/>/g,'&gt;')}` : '';
            const tel = u.telefono ? `, ${String(u.telefono).replace(/</g,'&lt;').replace(/>/g,'&gt;')}` : '';
            return `<option value="${String(u.id||'').replace(/</g,'&lt;').replace(/>/g,'&gt;')}">${nombre} (ID: ${String(u.id||'').replace(/</g,'&lt;').replace(/>/g,'&gt;')}${dni}${tel})</option>`;
          }).join('');
          uSelect.innerHTML = opts;
        }catch(_){ uSelect.innerHTML = '<option value="">Selecciona usuario…</option>'; }
      }, 300));
    }
    const ejerciciosViewEl = document.getElementById('clases-ejercicios'); if(ejerciciosViewEl){ ejerciciosViewEl.addEventListener('click', () => { if(!clasesState.selectedId){ showToast('Selecciona una clase', 'warning'); return; } openClaseEjerciciosModal(clasesState.selectedId); }); }
    const ejClose = document.getElementById('modal-ejercicios-close'); if(ejClose){ ejClose.addEventListener('click', closeClaseEjerciciosModal); }
    const ejCancel = document.getElementById('modal-ejercicios-cerrar'); if(ejCancel){ ejCancel.addEventListener('click', closeClaseEjerciciosModal); }
    const waClose = document.getElementById('wa-clase-close'); if(waClose){ waClose.addEventListener('click', closeWaClaseModal); }
    const waCancel = document.getElementById('wa-clase-cancel'); if(waCancel){ waCancel.addEventListener('click', closeWaClaseModal); }
    const waSend = document.getElementById('wa-clase-send'); if(waSend){ waSend.addEventListener('click', sendWaClaseReminder); }
  }

  async function loadClasesPanel(){
    await ensureClasesState();
    bindClasesEvents();
    await loadClases();
  }

  async function loadHorarioUsuarios(horarioId){
    const uTbody = document.querySelector('#horario-usuarios-table tbody');
    const uEmpty = document.getElementById('horario-usuarios-empty');
    const wTbody = document.querySelector('#horario-waitlist-table tbody');
    const wEmpty = document.getElementById('horario-waitlist-empty');
    if(!horarioId){ if(uTbody) uTbody.innerHTML=''; if(uEmpty) uEmpty.style.display=''; if(wTbody) wTbody.innerHTML=''; if(wEmpty) wEmpty.style.display=''; return; }
    try {
      const [rU, rW] = await Promise.all([
        fetch(`/api/horarios/${horarioId}/usuarios`, { headers:{ 'Accept':'application/json' } }),
        fetch(`/api/horarios/${horarioId}/lista_espera`, { headers:{ 'Accept':'application/json' } })
      ]);
      const usuarios = rU.ok ? (await rU.json()) : [];
      const espera = rW.ok ? (await rW.json()) : [];
      const uRows = (Array.isArray(usuarios)?usuarios:[]).map(u => {
        const nombre = String(u.nombre_usuario||'').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        const uid = String(u.usuario_id||'').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        return `<tr data-uid="${uid}" data-nombre="${nombre}">
          <td>${uid||'—'}</td>
          <td>${nombre||'—'}</td>
          <td><button class="btn info sm" data-action="wa-reminder">Recordatorio</button></td>
          <td><button class="btn danger sm" data-action="remove-u">Quitar</button></td>
        </tr>`;
      }).join('');
      const wRows = (Array.isArray(espera)?espera:[]).map(w => {
        const nombre = String(w.nombre_usuario||'').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        const pos = String(w.posicion||'').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        const uid = String(w.usuario_id||'').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        return `<tr data-uid="${uid}">
          <td>${uid||'—'}</td>
          <td>${nombre||'—'}</td>
          <td>${pos||'—'}</td>
          <td><button class="btn danger sm" data-action="remove-w">Quitar</button></td>
        </tr>`;
      }).join('');
      if(uTbody) uTbody.innerHTML = uRows || '';
      if(wTbody) wTbody.innerHTML = wRows || '';
      if(uEmpty) uEmpty.style.display = (uTbody && uTbody.children.length===0) ? '' : 'none';
      if(wEmpty) wEmpty.style.display = (wTbody && wTbody.children.length===0) ? '' : 'none';
      if(uTbody){ uTbody.querySelectorAll('tr').forEach(tr => {
        const uid = tr.getAttribute('data-uid');
        const nombre = tr.getAttribute('data-nombre')||'';
        const btnRemove = tr.querySelector('button[data-action="remove-u"]');
        const btnWa = tr.querySelector('button[data-action="wa-reminder"]');
        if(btnRemove) btnRemove.addEventListener('click', async (e) => { e.stopPropagation(); await quitarUsuarioDeHorario(Number(uid)); });
        if(btnWa) btnWa.addEventListener('click', (e) => { e.stopPropagation(); openWaClaseModal(Number(uid), nombre); });
      }); }
      if(wTbody){ wTbody.querySelectorAll('tr').forEach(tr => {
        const uid = tr.getAttribute('data-uid');
        const btn = tr.querySelector('button[data-action="remove-w"]');
        if(btn) btn.addEventListener('click', async (e) => { e.stopPropagation(); await quitarUsuarioDeListaEspera(Number(uid)); });
      }); }
    } catch(e){ showToast('Error al cargar inscriptos/lista de espera', 'error'); }
  }

  async function inscribirUsuarioEnHorario(){
    const hid = clasesState.selectedHorarioId;
    if(!hid){ showToast('Selecciona un horario', 'warning'); return; }
    const uid = Number(document.getElementById('horario-usuario-select')?.value || 0) || Number(document.getElementById('horario-usuario-id')?.value || 0);
    if(!uid){ showToast('Selecciona un usuario', 'warning'); return; }
    try {
      const r = await fetch(`/api/horarios/${hid}/usuarios`, { method:'POST', headers:{ 'Content-Type':'application/json','Accept':'application/json' }, body: JSON.stringify({ usuario_id: uid }) });
      if(!r.ok){ showToast('No se pudo inscribir usuario', 'error'); return; }
      const data = await r.json();
      showToast(data?.enrolled ? 'Usuario inscripto' : 'Sin cupo: añadido a espera', data?.enrolled ? 'success' : 'warning');
      await loadHorarioUsuarios(hid);
    } catch(e){ showToast('Error de red al inscribir', 'error'); }
  }

  async function quitarUsuarioDeHorario(uid){
    const hid = clasesState.selectedHorarioId;
    if(!hid || !uid){ showToast('Selecciona horario y usuario', 'warning'); return; }
    try {
      const ok = confirm('¿Quitar usuario del horario?'); if(!ok) return;
    } catch(_){ }
    try {
      const r = await fetch(`/api/horarios/${hid}/usuarios/${uid}`, { method:'DELETE', headers:{ 'Accept':'application/json' } });
      if(!r.ok){ showToast('No se pudo quitar usuario', 'error'); return; }
      showToast('Usuario quitado', 'success');
      await loadHorarioUsuarios(hid);
    } catch(e){ showToast('Error de red al quitar usuario', 'error'); }
  }

  async function quitarUsuarioDeListaEspera(uid){
    const hid = clasesState.selectedHorarioId;
    if(!hid || !uid){ showToast('Selecciona horario y usuario', 'warning'); return; }
    try {
      const ok = confirm('¿Quitar de lista de espera?'); if(!ok) return;
    } catch(_){ }
    try {
      const r = await fetch(`/api/horarios/${hid}/lista_espera/${uid}`, { method:'DELETE', headers:{ 'Accept':'application/json' } });
      if(!r.ok){ showToast('No se pudo quitar de espera', 'error'); return; }
      showToast('Eliminado de espera', 'success');
      await loadHorarioUsuarios(hid);
    } catch(e){ showToast('Error de red al quitar de espera', 'error'); }
  }

  async function notifyWaitlistFirst(){
    const hid = clasesState.selectedHorarioId;
    if(!hid){ showToast('Selecciona un horario', 'warning'); return; }
    try {
      const r = await fetch(`/api/horarios/${hid}/whatsapp/notify_waitlist_first`, { method:'POST', headers:{ 'Accept':'application/json' } });
      if(!r.ok){ showToast('No se pudo notificar a espera', 'error'); return; }
      showToast('Notificación enviada', 'success');
    } catch(e){ showToast('Error de red al notificar espera', 'error'); }
  }

  function openClaseModal(id){
    try { openModal('modal-clase'); } catch(_){
      const m = document.getElementById('modal-clase');
      if(m){ m.classList.add('active'); m.setAttribute('aria-hidden','false'); }
    }
    const nombreEl = document.getElementById('modal-clase-nombre');
    const descEl = document.getElementById('modal-clase-descripcion');
    const tipoEl = document.getElementById('modal-clase-tipo');
    const activaEl = document.getElementById('modal-clase-activa');
    const ejSel = document.getElementById('modal-clase-ejercicios');
    const ejSearch = document.getElementById('modal-clase-ejercicios-search');
    const ejChips = document.getElementById('modal-clase-ejercicios-chips');
    const clase = id ? (clasesState.list||[]).find(x => String(x.id||'') === String(id)) : null;
    if(nombreEl) nombreEl.value = String(clase?.nombre||'');
    if(descEl) descEl.value = String(clase?.descripcion||'');
    if(activaEl) activaEl.checked = (clase?.activa===true || String(clase?.activa)=='1');
    if(tipoEl){ tipoEl.innerHTML = (clasesState.tipos||[]).map(t => `<option value="${String(t.id||t.tipo_clase_id||'').replace(/</g,'&lt;').replace(/>/g,'&gt;')}">${String(t.nombre||t.tipo||'').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</option>`).join(''); tipoEl.value = String(clase?.tipo_clase_id||''); }
    // Cargar ejercicios y seleccionar los actuales
    (async ()=>{
      try {
        const r = await fetch('/api/ejercicios', { headers:{ 'Accept':'application/json' } });
        const arr = r.ok ? (await r.json()) : [];
        if(ejSel){ ejSel.innerHTML = (Array.isArray(arr)?arr:[]).map(e => `<option value="${String(e.id||'').replace(/</g,'&lt;').replace(/>/g,'&gt;')}">${String(e.nombre||'').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</option>`).join(''); }
        if(id){
          const r2 = await fetch(`/api/clases/${id}/ejercicios`, { headers:{ 'Accept':'application/json' } });
          const selected = r2.ok ? (await r2.json()) : [];
          const ids = (Array.isArray(selected)?selected:[]).map(x => { if(typeof x === 'number') return String(x); return String(x?.ejercicio_id ?? x?.id ?? ''); });
          if(ejSel){ Array.from(ejSel.options).forEach(opt => { opt.selected = ids.includes(String(opt.value||'')); }); }
          if(ejChips){
            const chips = ids.map(id => {
              const ex = (Array.isArray(arr)?arr:[]).find(e => String(e.id||'')===String(id));
              const name = ex ? String(ex.nombre||'') : `Ejercicio ${id}`;
              return `<span class="chip" data-eid="${String(id).replace(/</g,'&lt;').replace(/>/g,'&gt;')}">${name.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</span>`;
            }).join('');
            ejChips.innerHTML = chips || '<span class="muted">Sin ejercicios asociados</span>';
          }
        }
        if(ejSearch) ejSearch.value = '';
      } catch(_){}
    })();
    // Cargar horarios para el selector del modal (si clase existente)
    try { if(id) loadModalClaseHorarios(Number(id)); } catch(_){}
    // Guardar el id seleccionado en estado temporal
    try { document.getElementById('modal-clase').setAttribute('data-id', id ? String(id) : ''); } catch(_){}
  }

  function closeClaseModal(){
    try { closeModal('modal-clase'); } catch(_){
      const m = document.getElementById('modal-clase');
      if(m){ m.classList.remove('active'); m.setAttribute('aria-hidden','true'); }
    }
  }

  function filterModalEjercicios(){
    const q = (document.getElementById('modal-clase-ejercicios-search')?.value || '').toLowerCase();
    const sel = document.getElementById('modal-clase-ejercicios');
    if(!sel) return;
    Array.from(sel.options).forEach(opt => {
      const show = (String(opt.text||'').toLowerCase().includes(q));
      opt.style.display = show ? '' : 'none';
    });
  }

  async function saveClaseModal(){
    const modal = document.getElementById('modal-clase');
    const idRaw = modal?.getAttribute('data-id') || '';
    const id = idRaw ? Number(idRaw) : null;
    const nombre = document.getElementById('modal-clase-nombre')?.value || '';
    const tipo = document.getElementById('modal-clase-tipo')?.value || '';
    const activa = !!document.getElementById('modal-clase-activa')?.checked;
    const descripcion = document.getElementById('modal-clase-descripcion')?.value || '';
    const ejSel = document.getElementById('modal-clase-ejercicios');
    const ejercicio_ids = ejSel ? Array.from(ejSel.selectedOptions).map(o => Number(o.value)) : [];
    if(!nombre.trim()){ showToast('El nombre es obligatorio', 'warning'); return; }
    const body = { nombre, descripcion, activa, tipo_clase_id: tipo };
    try {
      let r;
      if(id){ r = await fetch(`/api/clases/${id}`, { method:'PUT', headers:{ 'Content-Type':'application/json','Accept':'application/json' }, body: JSON.stringify(body) }); }
      else { r = await fetch('/api/clases', { method:'POST', headers:{ 'Content-Type':'application/json','Accept':'application/json' }, body: JSON.stringify(body) }); }
      if(!r.ok){ showToast('No se pudo guardar la clase', 'error'); return; }
      const saved = id ? { id } : (await r.json());
      const claseId = Number(saved?.id || saved?.clase_id || id || 0);
      // Guardar ejercicios asociados
      if(claseId){
        const r2 = await fetch(`/api/clases/${claseId}/ejercicios`, { method:'POST', headers:{ 'Content-Type':'application/json','Accept':'application/json' }, body: JSON.stringify({ ejercicio_ids }) });
        if(!r2.ok){ showToast('Clase guardada, pero ejercicios no se actualizaron', 'warning'); }
      }
      showToast('Clase guardada correctamente', 'success');
      closeClaseModal();
      await loadClases();
      if(claseId){ await selectClase(claseId); }
    } catch(e){ showToast('Error de red al guardar clase', 'error'); }
  }

  async function openClaseEjerciciosModal(id){
    if(!id){ showToast('Selecciona una clase', 'warning'); return; }
    const cls = (clasesState.list||[]).find(x => String(x.id||'')===String(id));
    const statusEl = document.getElementById('clase-ej-status'); if(statusEl){ statusEl.textContent = cls ? `Clase: ${String(cls.nombre||'').replace(/</g,'&lt;').replace(/>/g,'&gt;')}` : '—'; }
    // Cargar catálogo completo de ejercicios
    let catalog = [];
    try {
      const rAll = await fetch('/api/ejercicios', { headers:{ 'Accept':'application/json' } });
      catalog = rAll.ok ? (await rAll.json()) : [];
      catalog = Array.isArray(catalog) ? catalog : [];
    } catch(_){ catalog = []; }
    // Cargar bloque actual de la clase
    let selected = [];
    try {
      const rSel = await fetch(`/api/clases/${id}/ejercicios`, { headers:{ 'Accept':'application/json' } });
      selected = rSel.ok ? (await rSel.json()) : [];
      selected = Array.isArray(selected) ? selected : [];
    } catch(_){ selected = []; }
    // Persistir en estado temporal: normalizar al nuevo formato con metadatos
    clasesState._ej_catalog = catalog;
    try{
      const norm = selected.map((e, idx) => {
        if (typeof e === 'number') {
          return { ejercicio_id: Number(e), series: 3, repeticiones: '', descanso_segundos: 60, notas: '', orden: idx };
        }
        const id = Number(e?.ejercicio_id ?? e?.id ?? 0);
        const ord = Number(e?.orden ?? idx);
        return {
          ejercicio_id: id,
          series: Number(e?.series ?? 3) || 0,
          repeticiones: String(e?.repeticiones ?? ''),
          descanso_segundos: Number(e?.descanso_segundos ?? e?.descanso ?? 60) || 0,
          notas: String(e?.notas ?? ''),
          orden: ord
        };
      }).filter(x => Number(x.ejercicio_id));
      // Ordenar por 'orden' si viene del backend
      norm.sort((a,b) => (Number(a.orden)||0) - (Number(b.orden)||0));
      clasesState._ej_selected = norm;
    }catch(__){ clasesState._ej_selected = []; }
    // Popular filtros
    try{
      const groups = Array.from(new Set(catalog.map(e => String(e.grupo_muscular||'')).filter(Boolean))).sort();
      const objetivos = Array.from(new Set(catalog.map(e => String(e.objetivo||'')).filter(Boolean))).sort();
      const selG = document.getElementById('clase-ej-group'); if(selG){ selG.innerHTML = `<option value="">Grupo: Todos</option>` + groups.map(g => `<option value="${g.replace(/</g,'&lt;').replace(/>/g,'&gt;')}">${g.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</option>`).join(''); }
      const selO = document.getElementById('clase-ej-objetivo'); if(selO){ selO.innerHTML = `<option value="">Objetivo: Todos</option>` + objetivos.map(o => `<option value="${o.replace(/</g,'&lt;').replace(/>/g,'&gt;')}">${o.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</option>`).join(''); }
    }catch(_){}
    // Render listas
    renderClaseEjerciciosUI();
    // Cargar bloques de la clase
    try{ await loadClaseBloques(id); }catch(_){}
    // Enlazar controles
    const qEl = document.getElementById('clase-ej-q'); if(qEl){ qEl.value=''; qEl.addEventListener('input', debounce(renderClaseEjerciciosUI, 200)); }
    const gEl = document.getElementById('clase-ej-group'); if(gEl){ gEl.addEventListener('change', renderClaseEjerciciosUI); }
    const oEl = document.getElementById('clase-ej-objetivo'); if(oEl){ oEl.addEventListener('change', renderClaseEjerciciosUI); }
    const addEl = document.getElementById('clase-ej-add'); if(addEl){ addEl.onclick = addSelectedEjerciciosToClase; }
    const rmEl = document.getElementById('clase-ej-remove-selected'); if(rmEl){ rmEl.onclick = removeSelectedFromBloque; }
    const saveEl = document.getElementById('clase-ej-save'); if(saveEl){ saveEl.onclick = async ()=>{ await saveClaseEjercicios(id); }; }
    const multiEl = document.getElementById('clase-ej-multi'); if(multiEl){ multiEl.checked=false; multiEl.addEventListener('change', () => { const t = document.getElementById('clase-ej-list-table'); if(!t) return; t.classList.toggle('multi', !!multiEl.checked); }); }
    const btnNew = document.getElementById('clase-ej-new'); if(btnNew){ btnNew.onclick = ()=> showEjercicioForm(null); }
    const btnEdit = document.getElementById('clase-ej-edit'); if(btnEdit){ btnEdit.onclick = editSelectedEjercicioFromCatalog; }
    const btnDel = document.getElementById('clase-ej-delete'); if(btnDel){ btnDel.onclick = deleteSelectedEjercicioFromCatalog; }
    const selBloq = document.getElementById('clase-ej-bloque-select'); if(selBloq){ selBloq.onchange = async ()=>{ await applySelectedBloque(id); }; }
    const btnBloqSave = document.getElementById('clase-ej-bloque-save'); if(btnBloqSave){ btnBloqSave.onclick = async ()=>{ await saveCurrentAsBloque(id); }; }
    const btnBloqUpdate = document.getElementById('clase-ej-bloque-update'); if(btnBloqUpdate){ btnBloqUpdate.onclick = async ()=>{ await updateSelectedBloque(id); }; }
    const btnBloqDelete = document.getElementById('clase-ej-bloque-delete'); if(btnBloqDelete){ btnBloqDelete.onclick = async ()=>{ await deleteSelectedBloque(id); }; }
  try { openModal('modal-ejercicios-clase'); } catch(_){ const el = document.getElementById('modal-ejercicios-clase'); if(el){ el.classList.add('active'); el.setAttribute('aria-hidden','false'); }}
  }
  function closeClaseEjerciciosModal(){ try { closeModal('modal-ejercicios-clase'); } catch(_){ const el = document.getElementById('modal-ejercicios-clase'); if(el){ el.classList.remove('active'); el.setAttribute('aria-hidden','true'); } } }

function renderClaseEjerciciosUI(){
    const q = (document.getElementById('clase-ej-q')?.value||'').toLowerCase();
    const g = document.getElementById('clase-ej-group')?.value||'';
    const o = document.getElementById('clase-ej-objetivo')?.value||'';
    const tbodyL = document.querySelector('#clase-ej-list-table tbody');
    const emptyL = document.getElementById('clase-ej-list-empty');
    const tbodyB = document.querySelector('#clase-ej-bloque-table tbody');
    const emptyB = document.getElementById('clase-ej-bloque-empty');
    const listTable = document.getElementById('clase-ej-list-table');
    const bloqueTable = document.getElementById('clase-ej-bloque-table');
    const listWrap = listTable && typeof listTable.closest==='function' ? listTable.closest('.table-scroll') : null;
    const bloqueWrap = bloqueTable && typeof bloqueTable.closest==='function' ? bloqueTable.closest('.table-scroll') : null;
    if(tbodyL) tbodyL.innerHTML=''; if(tbodyB) tbodyB.innerHTML='';
    const catalog = Array.isArray(clasesState._ej_catalog)?clasesState._ej_catalog:[];
    const selected = Array.isArray(clasesState._ej_selected)?clasesState._ej_selected:[];
    const filtered = catalog.filter(e => {
      const name = String(e.nombre||'').toLowerCase();
      const grp = String(e.grupo_muscular||'');
      const obj = String(e.objetivo||'');
      return (!q || name.includes(q)) && (!g || grp===g) && (!o || obj===o);
    });
    if(tbodyL){ filtered.forEach(e => {
      const tr = document.createElement('tr'); tr.setAttribute('data-id', String(e.id||'')); tr.setAttribute('data-name', String(e.nombre||''));
      const tdHandle = document.createElement('td'); tdHandle.innerHTML = `<span class="handle" style="display:inline-block; padding:0 6px; cursor:grab; user-select:none; opacity:.8;">${'⋮⋮'}</span>`;
      const tdNombre = document.createElement('td'); tdNombre.textContent = String(e.nombre||'');
      const tdGrupo = document.createElement('td'); tdGrupo.textContent = String(e.grupo_muscular||'');
      const tdObj = document.createElement('td'); tdObj.textContent = String(e.objetivo||'');
      tr.addEventListener('click', () => { tr.classList.toggle('selected'); });
      // Hacer arrastrable: permite mover del catálogo al bloque
      tr.draggable = true;
      tr.style.cursor = 'grab';
      tr.addEventListener('dragstart', (ev) => { 
        try{ 
          ev.dataTransfer.effectAllowed = 'copyMove'; 
          ev.dataTransfer.setData('text/plain', `CAT:${String(e.id)}`); 
        }catch(_){ }
      });
      tr.appendChild(tdHandle);
      tr.appendChild(tdNombre);
      tr.appendChild(tdGrupo);
      tr.appendChild(tdObj);
      tbodyL.appendChild(tr);
    });
    // Permitir soltar aquí para remover del bloque (desde BLK:)
    if(tbodyL && !tbodyL.dataset.dndBound){
      tbodyL.dataset.dndBound = '1';
      tbodyL.addEventListener('dragenter', (ev) => { ev.preventDefault(); try{ ev.dataTransfer.dropEffect = 'move'; }catch(_){ } tbodyL.classList.add('drag-over'); });
      tbodyL.addEventListener('dragover', (ev) => { ev.preventDefault(); try{ ev.dataTransfer.dropEffect = 'move'; }catch(_){ } tbodyL.classList.add('drag-over'); });
      tbodyL.addEventListener('dragleave', () => { tbodyL.classList.remove('drag-over'); });
      tbodyL.addEventListener('drop', (ev) => {
        ev.preventDefault(); ev.stopPropagation(); tbodyL.classList.remove('drag-over');
        let from = -1; try{ const p = String(ev.dataTransfer.getData('text/plain')||''); from = p.startsWith('BLK:') ? Number(p.slice(4)) : -1; }catch(_){ from = -1; }
        if(from>=0){
          const arr = Array.isArray(clasesState._ej_selected)?clasesState._ej_selected.slice():[];
          arr.splice(from, 1);
          clasesState._ej_selected = arr.map((it,i) => ({...it, orden:i}));
          renderClaseEjerciciosUI();
        }
      });
    }
    // También aceptar drop en el contenedor y la tabla (facilita interacción en scroll)
    [listWrap, listTable].forEach(el => {
      if(el && !el.dataset?.dndBound){
        try { el.dataset.dndBound = '1'; } catch(__){}
        el.addEventListener('dragenter', (ev) => { ev.preventDefault(); try{ ev.dataTransfer.dropEffect = 'move'; }catch(_){ } if(tbodyL){ tbodyL.classList.add('drag-over'); } });
        el.addEventListener('dragover', (ev) => { ev.preventDefault(); try{ ev.dataTransfer.dropEffect = 'move'; }catch(_){ } if(tbodyL){ tbodyL.classList.add('drag-over'); } });
        el.addEventListener('dragleave', () => { if(tbodyL){ tbodyL.classList.remove('drag-over'); } });
        el.addEventListener('drop', (ev) => {
          ev.preventDefault(); ev.stopPropagation(); if(tbodyL){ tbodyL.classList.remove('drag-over'); }
          let from = -1; try{ const p = String(ev.dataTransfer.getData('text/plain')||''); from = p.startsWith('BLK:') ? Number(p.slice(4)) : -1; }catch(_){ from = -1; }
          if(from>=0){
            const arr = Array.isArray(clasesState._ej_selected)?clasesState._ej_selected.slice():[];
            arr.splice(from, 1);
            clasesState._ej_selected = arr.map((it,i) => ({...it, orden:i}));
            renderClaseEjerciciosUI();
          }
        });
      }
    });

    // Aceptar drop también sobre el mensaje vacío del catálogo
    if(emptyL && !emptyL.dataset.dndBound){
      emptyL.dataset.dndBound = '1';
      emptyL.addEventListener('dragenter', (ev) => { ev.preventDefault(); try{ ev.dataTransfer.dropEffect = 'move'; }catch(_){ } emptyL.classList.add('drag-over'); });
      emptyL.addEventListener('dragover', (ev) => { ev.preventDefault(); try{ ev.dataTransfer.dropEffect = 'move'; }catch(_){ } emptyL.classList.add('drag-over'); });
      emptyL.addEventListener('dragleave', () => { emptyL.classList.remove('drag-over'); });
      emptyL.addEventListener('drop', (ev) => {
        ev.preventDefault(); ev.stopPropagation(); emptyL.classList.remove('drag-over');
        let from = -1; try{ const p = String(ev.dataTransfer.getData('text/plain')||''); from = p.startsWith('BLK:') ? Number(p.slice(4)) : -1; }catch(_){ from = -1; }
        if(from>=0){
          const arr = Array.isArray(clasesState._ej_selected)?clasesState._ej_selected.slice():[];
          arr.splice(from, 1);
          clasesState._ej_selected = arr.map((it,i) => ({...it, orden:i}));
          renderClaseEjerciciosUI();
        }
      });
    }
    }
    if(emptyL) emptyL.style.display = (tbodyL && tbodyL.children.length===0) ? '' : 'none';
    if(tbodyB){
      tbodyB.innerHTML = '';
      selected.forEach((item, idx) => {
        const ej = catalog.find(x => Number(x.id)===Number(item.ejercicio_id));
        const tr = document.createElement('tr');
        tr.classList.add('animate-in');
        tr.setAttribute('data-id', String(item.ejercicio_id));
        tr.setAttribute('data-index', String(idx));
        tr.draggable = true;
        tr.addEventListener('click', () => { tr.classList.toggle('selected'); });
        tr.addEventListener('dragstart', (ev) => {
          try{ ev.dataTransfer.effectAllowed = 'move'; ev.dataTransfer.setData('text/plain', `BLK:${String(idx)}`); }catch(_){ }
        });
        tr.addEventListener('dragover', (ev) => { ev.preventDefault(); try{ ev.dataTransfer.dropEffect = 'move'; }catch(_){ } tr.classList.add('drag-over'); });
        tr.addEventListener('dragleave', () => { tr.classList.remove('drag-over'); });
        tr.addEventListener('drop', (ev) => {
          ev.preventDefault(); ev.stopPropagation(); tr.classList.remove('drag-over');
          const payload = (()=>{ try{ return String(ev.dataTransfer.getData('text/plain')||''); }catch(_){ return ''; } })();
          const to = idx;
          // Si viene desde el propio bloque: reordenar
          if(payload.startsWith('BLK:')){
            const from = Number(payload.slice(4));
            if(from>=0 && to>=0 && from!==to){
              const arr = Array.isArray(clasesState._ej_selected)?clasesState._ej_selected.slice():[];
              const [m] = arr.splice(from, 1);
              arr.splice(to, 0, m);
              clasesState._ej_selected = arr.map((it,i) => ({...it, orden:i}));
              renderClaseEjerciciosUI();
            }
            return;
          }
          // Si viene del catálogo: insertar antes de esta fila
          const eid = payload.startsWith('CAT:') ? Number(payload.slice(4)) : 0;
          if(eid>0){
            const arr = Array.isArray(clasesState._ej_selected)?clasesState._ej_selected.slice():[];
            const exists = arr.some(it => Number(it.ejercicio_id)===eid);
            const ej = catalog.find(x => Number(x.id)===eid);
            if(ej && !exists){
              arr.splice(to, 0, { ejercicio_id:eid, orden:to, series:0, repeticiones:'', descanso_segundos:0, notas:'' });
              clasesState._ej_selected = arr.map((it,i) => ({...it, orden:i}));
              renderClaseEjerciciosUI();
            }
          }
        });
        const tdHandle = document.createElement('td'); tdHandle.innerHTML = `<span class="handle" style="display:inline-block; padding:0 6px; cursor:grab; user-select:none; opacity:.8;">${'⋮⋮'}</span>`;
        const tdOrden = document.createElement('td'); tdOrden.textContent = String(idx+1);
        const tdNombre = document.createElement('td'); tdNombre.textContent = String(ej?.nombre||'—');
        const tdSeries = document.createElement('td');
        const inpSeries = document.createElement('input'); inpSeries.type='number'; inpSeries.min='0'; inpSeries.step='1'; inpSeries.value=String(Number(item.series||0)); inpSeries.setAttribute('aria-label','Series'); inpSeries.style.width='80px';
        inpSeries.addEventListener('input', () => { const v = Number(inpSeries.value||0)||0; clasesState._ej_selected[idx].series = v; });
        tdSeries.appendChild(inpSeries);
        const tdReps = document.createElement('td');
        const inpReps = document.createElement('input'); inpReps.type='text'; inpReps.value=String(item.repeticiones||''); inpReps.setAttribute('aria-label','Repeticiones'); inpReps.placeholder='Ej: 10-12'; inpReps.style.width='120px';
        inpReps.addEventListener('input', () => { clasesState._ej_selected[idx].repeticiones = String(inpReps.value||''); });
        tdReps.appendChild(inpReps);
        const tdDesc = document.createElement('td');
        const inpDesc = document.createElement('input'); inpDesc.type='number'; inpDesc.min='0'; inpDesc.step='1'; inpDesc.value=String(Number(item.descanso_segundos||0)); inpDesc.setAttribute('aria-label','Descanso en segundos'); inpDesc.style.width='120px';
        inpDesc.addEventListener('input', () => { const v = Number(inpDesc.value||0)||0; clasesState._ej_selected[idx].descanso_segundos = v; });
        tdDesc.appendChild(inpDesc);
        const tdNotas = document.createElement('td');
        const inpNotas = document.createElement('input'); inpNotas.type='text'; inpNotas.value=String(item.notas||''); inpNotas.setAttribute('aria-label','Notas'); inpNotas.placeholder='Opcional'; inpNotas.style.width='180px';
        inpNotas.addEventListener('input', () => { clasesState._ej_selected[idx].notas = String(inpNotas.value||''); });
        tdNotas.appendChild(inpNotas);
        const tdAcc = document.createElement('td');
        const btnRm = document.createElement('button'); btnRm.className='btn danger sm'; btnRm.textContent='Quitar'; btnRm.addEventListener('click', () => {
          const arr = Array.isArray(clasesState._ej_selected)?clasesState._ej_selected:[];
          clasesState._ej_selected = arr.filter((_,i) => i!==idx).map((it,i) => ({...it, orden:i}));
          renderClaseEjerciciosUI();
        });
        tdAcc.appendChild(btnRm);
        tr.appendChild(tdOrden);
        tr.appendChild(tdNombre);
        tr.appendChild(tdHandle);
        tr.appendChild(tdSeries);
        tr.appendChild(tdReps);
        tr.appendChild(tdDesc);
        tr.appendChild(tdNotas);
        tr.appendChild(tdAcc);
      tbodyB.appendChild(tr);
      });
      // Permitir soltar al final del bloque (desde CAT:) en tbody, tabla y contenedor
      if(tbodyB && !tbodyB.dataset.dndBound){
        tbodyB.dataset.dndBound = '1';
        tbodyB.addEventListener('dragenter', (ev) => { ev.preventDefault(); try{ ev.dataTransfer.dropEffect = 'move'; }catch(_){ } tbodyB.classList.add('drag-over'); });
        tbodyB.addEventListener('dragover', (ev) => { ev.preventDefault(); try{ ev.dataTransfer.dropEffect = 'move'; }catch(_){ } tbodyB.classList.add('drag-over'); });
        tbodyB.addEventListener('dragleave', () => { tbodyB.classList.remove('drag-over'); });
        tbodyB.addEventListener('drop', (ev) => {
          ev.preventDefault(); ev.stopPropagation(); tbodyB.classList.remove('drag-over');
          const payload = (()=>{ try{ return String(ev.dataTransfer.getData('text/plain')||''); }catch(_){ return ''; } })();
          // Si viene del catálogo: agregar al final
          if(payload.startsWith('CAT:')){
            const eid = Number(payload.slice(4))||0;
            if(eid>0){
              const arr = Array.isArray(clasesState._ej_selected)?clasesState._ej_selected.slice():[];
              const exists = arr.some(it => Number(it.ejercicio_id)===eid);
              const ej = catalog.find(x => Number(x.id)===eid);
              if(ej && !exists){
                arr.push({ ejercicio_id:eid, orden:arr.length, series:0, repeticiones:'', descanso_segundos:0, notas:'' });
                clasesState._ej_selected = arr.map((it,i) => ({...it, orden:i}));
                renderClaseEjerciciosUI();
              }
            }
          }
        });
      }
      [bloqueWrap, bloqueTable].forEach(el => {
        if(el && !el.dataset?.dndBound){
          try { el.dataset.dndBound = '1'; } catch(__){}
          el.addEventListener('dragenter', (ev) => { ev.preventDefault(); try{ ev.dataTransfer.dropEffect = 'move'; }catch(_){ } if(tbodyB){ tbodyB.classList.add('drag-over'); } });
          el.addEventListener('dragover', (ev) => { ev.preventDefault(); try{ ev.dataTransfer.dropEffect = 'move'; }catch(_){ } if(tbodyB){ tbodyB.classList.add('drag-over'); } });
          el.addEventListener('dragleave', () => { if(tbodyB){ tbodyB.classList.remove('drag-over'); } });
          el.addEventListener('drop', (ev) => {
            ev.preventDefault(); ev.stopPropagation(); if(tbodyB){ tbodyB.classList.remove('drag-over'); }
            const payload = (()=>{ try{ return String(ev.dataTransfer.getData('text/plain')||''); }catch(_){ return ''; } })();
            if(payload.startsWith('CAT:')){
              const eid = Number(payload.slice(4))||0;
              if(eid>0){
                const arr = Array.isArray(clasesState._ej_selected)?clasesState._ej_selected.slice():[];
                const exists = arr.some(it => Number(it.ejercicio_id)===eid);
                const ej = catalog.find(x => Number(x.id)===eid);
                if(ej && !exists){
                  arr.push({ ejercicio_id:eid, orden:arr.length, series:0, repeticiones:'', descanso_segundos:0, notas:'' });
                  clasesState._ej_selected = arr.map((it,i) => ({...it, orden:i}));
                  renderClaseEjerciciosUI();
                }
              }
            }
          });
        }
      });
      // Aceptar drop también sobre el mensaje vacío del bloque
      if(emptyB && !emptyB.dataset.dndBound){
        emptyB.dataset.dndBound = '1';
        emptyB.addEventListener('dragenter', (ev) => { ev.preventDefault(); try{ ev.dataTransfer.dropEffect = 'move'; }catch(_){ } emptyB.classList.add('drag-over'); });
        emptyB.addEventListener('dragover', (ev) => { ev.preventDefault(); try{ ev.dataTransfer.dropEffect = 'move'; }catch(_){ } emptyB.classList.add('drag-over'); });
        emptyB.addEventListener('dragleave', () => { emptyB.classList.remove('drag-over'); });
        emptyB.addEventListener('drop', (ev) => {
          ev.preventDefault(); ev.stopPropagation(); emptyB.classList.remove('drag-over');
          const payload = (()=>{ try{ return String(ev.dataTransfer.getData('text/plain')||''); }catch(_){ return ''; } })();
          if(payload.startsWith('CAT:')){
            const eid = Number(payload.slice(4))||0;
            if(eid>0){
              const arr = Array.isArray(clasesState._ej_selected)?clasesState._ej_selected.slice():[];
              const exists = arr.some(it => Number(it.ejercicio_id)===eid);
              const ej = catalog.find(x => Number(x.id)===eid);
              if(ej && !exists){
                arr.push({ ejercicio_id:eid, orden:arr.length, series:0, repeticiones:'', descanso_segundos:0, notas:'' });
                clasesState._ej_selected = arr.map((it,i) => ({...it, orden:i}));
                renderClaseEjerciciosUI();
              }
            }
          }
        });
      }
    }
    if(emptyB) emptyB.style.display = (tbodyB && tbodyB.children.length===0) ? '' : 'none';
  }

  function addSelectedEjerciciosToClase(){
    const tbodyL = document.querySelector('#clase-ej-list-table tbody');
    const selectedRows = Array.from(tbodyL?.querySelectorAll('tr.selected')||[]).map(tr => Number(tr.getAttribute('data-id')||0)).filter(Boolean);
    const current = Array.isArray(clasesState._ej_selected)?clasesState._ej_selected.slice():[];
    const existingIds = new Set(current.map(it => Number(it.ejercicio_id)));
    selectedRows.forEach(eid => {
      if(!existingIds.has(Number(eid))){
        current.push({ ejercicio_id: Number(eid), series: 3, repeticiones: '', descanso_segundos: 60, notas: '', orden: current.length });
      }
    });
    clasesState._ej_selected = current.map((it,i) => ({...it, orden:i}));
    renderClaseEjerciciosUI();
  }

  function removeSelectedFromBloque(){
    const tbodyB = document.querySelector('#clase-ej-bloque-table tbody');
    const toRemoveIdx = Array.from(tbodyB?.querySelectorAll('tr.selected')||[]).map(tr => Number(tr.getAttribute('data-index')||-1)).filter(i => i>=0);
    const arr = Array.isArray(clasesState._ej_selected)?clasesState._ej_selected:[];
    clasesState._ej_selected = arr.filter((_,i) => !toRemoveIdx.includes(i)).map((it,i) => ({...it, orden:i}));
    renderClaseEjerciciosUI();
  }

  async function saveClaseEjercicios(claseId){
    const items = Array.isArray(clasesState._ej_selected)?clasesState._ej_selected:[];
    try{
      const payload = { ejercicios: items.map((it, idx) => ({ ejercicio_id: Number(it.ejercicio_id), orden: idx, series: Number(it.series||0), repeticiones: String(it.repeticiones||''), descanso_segundos: Number(it.descanso_segundos||0), notas: String(it.notas||'') })) };
      const r = await fetch(`/api/clases/${claseId}/ejercicios`, { method:'POST', headers:{ 'Content-Type':'application/json','Accept':'application/json' }, body: JSON.stringify(payload) });
      if(!r.ok){ showToast('No se pudo guardar ejercicios de clase', 'error'); return; }
      showToast('Ejercicios de la clase actualizados', 'success');
      closeClaseEjerciciosModal();
    }catch(e){ showToast('Error de red al guardar', 'error'); }
  }

  async function loadClaseBloques(claseId){
    const sel = document.getElementById('clase-ej-bloque-select'); if(!sel) return;
    try{
      const r = await fetch(`/api/clases/${claseId}/bloques`, { headers:{ 'Accept':'application/json' } });
      const arr = r.ok ? (await r.json()) : [];
      const list = Array.isArray(arr) ? arr : [];
      clasesState._ej_bloques = list;
      const html = ['<option value="">Seleccionar bloque…</option>'].concat(list.map(b => `<option value="${String(b.id).replace(/</g,'&lt;').replace(/>/g,'&gt;')}">${String(b.nombre||'Bloque').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</option>`)).join('');
      sel.innerHTML = html;
    }catch(_){ if(sel){ sel.innerHTML = '<option value="">Seleccionar bloque…</option>'; } }
  }

  async function applySelectedBloque(claseId){
    const sel = document.getElementById('clase-ej-bloque-select'); const bid = sel ? Number(sel.value||0) : 0;
    if(!bid){ return; }
    try{
      const r = await fetch(`/api/clases/${claseId}/bloques/${bid}`, { headers:{ 'Accept':'application/json' } });
      const items = r.ok ? (await r.json()) : [];
      const norm = (Array.isArray(items)?items:[]).map((it, idx) => ({
        ejercicio_id: Number(it.ejercicio_id || it.id || 0),
        orden: Number(it.orden ?? idx) || idx,
        series: Number(it.series||0) || 0,
        repeticiones: String(it.repeticiones||''),
        descanso_segundos: Number(it.descanso_segundos||0) || 0,
        notas: String(it.notas||'')
      })).filter(x => Number(x.ejercicio_id));
      norm.sort((a,b) => (a.orden||0) - (b.orden||0));
      clasesState._ej_selected = norm.map((it,i) => ({...it, orden:i}));
      clasesState._ej_bloque_selected_id = bid;
      try{ const nameEl = document.getElementById('clase-ej-bloque-name'); if(nameEl && sel){ const opt = sel.options[sel.selectedIndex]; nameEl.value = String(opt?.text||''); } }catch(_){}
      renderClaseEjerciciosUI();
      showToast('Bloque aplicado a la vista', 'success', 2000);
    }catch(_){ showToast('No se pudo cargar el bloque', 'error'); }
  }

  async function saveCurrentAsBloque(claseId){
    const nameEl = document.getElementById('clase-ej-bloque-name');
    const btnEl = document.getElementById('clase-ej-bloque-save');
    const statusEl = document.getElementById('clase-ej-status');
    const nombre = String((nameEl?.value||'')).trim();
    if(!nombre){ showToast('Nombre de bloque obligatorio', 'warning'); try{ nameEl?.focus(); }catch(_){} return; }
    const items = Array.isArray(clasesState._ej_selected)?clasesState._ej_selected:[];
    if(!items.length){ showToast('Añade ejercicios antes de guardar el bloque', 'warning'); return; }
    const payload = { nombre, items: items.map((it,idx) => ({ ejercicio_id: Number(it.ejercicio_id), orden: idx, series: Number(it.series||0), repeticiones: String(it.repeticiones||''), descanso_segundos: Number(it.descanso_segundos||0), notas: String(it.notas||'' ) })) };
    try{
      if(btnEl){ btnEl.disabled = true; }
      if(statusEl){ statusEl.textContent = 'Guardando bloque…'; }
      const r = await fetch(`/api/clases/${claseId}/bloques`, { method:'POST', headers:{ 'Content-Type':'application/json','Accept':'application/json' }, body: JSON.stringify(payload) });
      if(!r.ok){ showToast('No se pudo guardar el bloque', 'error'); return; }
      const data = await r.json().catch(()=>({}));
      await loadClaseBloques(claseId);
      const sel = document.getElementById('clase-ej-bloque-select'); if(sel){ sel.value = String(data?.id||''); }
      showToast('Bloque creado', 'success', 2500);
    }catch(_){ showToast('Error de red al guardar bloque', 'error'); }
    finally {
      if(btnEl){ btnEl.disabled = false; }
      if(statusEl){ statusEl.textContent = '—'; }
    }
  }

  async function updateSelectedBloque(claseId){
    const bid = Number(document.getElementById('clase-ej-bloque-select')?.value||0);
    if(!bid){ showToast('Selecciona un bloque', 'warning'); return; }
    const nameEl = document.getElementById('clase-ej-bloque-name');
    const btnEl = document.getElementById('clase-ej-bloque-update');
    const statusEl = document.getElementById('clase-ej-status');
    const nombre = String((nameEl?.value||''));
    const items = Array.isArray(clasesState._ej_selected)?clasesState._ej_selected:[];
    const payload = { nombre, items: items.map((it,idx) => ({ ejercicio_id: Number(it.ejercicio_id), orden: idx, series: Number(it.series||0), repeticiones: String(it.repeticiones||''), descanso_segundos: Number(it.descanso_segundos||0), notas: String(it.notas||'' ) })) };
    try{
      if(btnEl){ btnEl.disabled = true; }
      if(statusEl){ statusEl.textContent = 'Actualizando bloque…'; }
      const r = await fetch(`/api/clases/${claseId}/bloques/${bid}`, { method:'PUT', headers:{ 'Content-Type':'application/json','Accept':'application/json' }, body: JSON.stringify(payload) });
      if(!r.ok){ showToast('No se pudo actualizar el bloque', 'error'); return; }
      await loadClaseBloques(claseId);
      const sel = document.getElementById('clase-ej-bloque-select'); if(sel){ sel.value = String(bid||''); }
      showToast('Bloque actualizado', 'success', 2500);
    }catch(_){ showToast('Error de red al actualizar bloque', 'error'); }
    finally {
      if(btnEl){ btnEl.disabled = false; }
      if(statusEl){ statusEl.textContent = '—'; }
    }
  }

  async function deleteSelectedBloque(claseId){
    const bid = Number(document.getElementById('clase-ej-bloque-select')?.value||0);
    if(!bid){ showToast('Selecciona un bloque', 'warning'); return; }
    try{ const ok = confirm('¿Eliminar bloque seleccionado?'); if(!ok) return; }catch(_){}
    try{
      const r = await fetch(`/api/clases/${claseId}/bloques/${bid}`, { method:'DELETE', headers:{ 'Accept':'application/json' } });
      if(!r.ok){ showToast('No se pudo eliminar el bloque', 'error'); return; }
      await loadClaseBloques(claseId);
      const sel = document.getElementById('clase-ej-bloque-select'); if(sel){ sel.value=''; }
      showToast('Bloque eliminado', 'success', 2500);
    }catch(_){ showToast('Error de red al eliminar bloque', 'error'); }
  }

  function editSelectedEjercicioFromCatalog(){
    const tbodyL = document.querySelector('#clase-ej-list-table tbody');
    const selectedRows = Array.from(tbodyL?.querySelectorAll('tr.selected')||[]);
    if(selectedRows.length!==1){ showToast('Selecciona un único ejercicio para editar', 'warning'); return; }
    const id = Number(selectedRows[0].getAttribute('data-id')||0);
    const ej = (Array.isArray(clasesState._ej_catalog)?clasesState._ej_catalog:[]).find(x => Number(x.id)===id);
    if(!ej){ showToast('Ejercicio no encontrado', 'error'); return; }
    showEjercicioForm(ej);
  }

  function deleteSelectedEjercicioFromCatalog(){
    const tbodyL = document.querySelector('#clase-ej-list-table tbody');
    const selectedRows = Array.from(tbodyL?.querySelectorAll('tr.selected')||[]);
    if(selectedRows.length!==1){ showToast('Selecciona un único ejercicio para eliminar', 'warning'); return; }
    const id = Number(selectedRows[0].getAttribute('data-id')||0);
    try{ deleteEjercicio(id); }catch(_){ showToast('No se pudo iniciar eliminación', 'error'); }
  }

  function openWaClaseModal(uid, nombre){
    const userEl = document.getElementById('wa-clase-user-name'); if(userEl){ userEl.textContent = String(nombre||'—'); }
    const tipoEl = document.getElementById('wa-clase-tipo');
    const horaEl = document.getElementById('wa-clase-hora');
    const fechaEl = document.getElementById('wa-clase-fecha');
    const cls = (clasesState.list||[]).find(x => Number(x.id)===Number(clasesState.selectedId));
    const hid = Number(clasesState.selectedHorarioId||0);
    const hor = (clasesState.horarios||[]).find(h => Number(h.id||h.horario_id||0)===hid) || {};
    if(tipoEl){ tipoEl.value = String(cls?.nombre||''); }
    if(horaEl){ horaEl.value = String(hor?.hora_inicio||''); }
    try{ const today = new Date(); const yyyy = today.getFullYear(); const mm = String(today.getMonth()+1).padStart(2,'0'); const dd = String(today.getDate()).padStart(2,'0'); if(fechaEl){ fechaEl.value = `${yyyy}-${mm}-${dd}`; } }catch(_){}
    const modal = document.getElementById('modal-wa-clase'); if(modal){ modal.classList.add('active'); modal.setAttribute('aria-hidden','false'); }
    modal?.setAttribute('data-uid', String(uid||''));
  }
  function closeWaClaseModal(){ const modal = document.getElementById('modal-wa-clase'); if(modal){ modal.classList.remove('active'); modal.setAttribute('aria-hidden','true'); modal.removeAttribute('data-uid'); } }
  async function sendWaClaseReminder(){
    const modal = document.getElementById('modal-wa-clase'); const uidRaw = modal?.getAttribute('data-uid')||''; const uid = Number(uidRaw||0);
    if(!uid){ showToast('Usuario inválido', 'error'); return; }
    const tipo = document.getElementById('wa-clase-tipo')?.value||'';
    const fecha = document.getElementById('wa-clase-fecha')?.value||'';
    const hora = document.getElementById('wa-clase-hora')?.value||'';
    try{
      const r = await fetch(`/api/usuarios/${uid}/whatsapp/recordatorio_clase`, { method:'POST', headers:{ 'Content-Type':'application/json','Accept':'application/json' }, body: JSON.stringify({ tipo_clase: tipo, fecha, hora }) });
      if(!r.ok){ showToast('No se pudo enviar WhatsApp', 'error'); return; }
      showToast('Recordatorio enviado por WhatsApp', 'success');
      closeWaClaseModal();
    }catch(_){ showToast('Error de red al enviar WhatsApp', 'error'); }
  }


    function init(){
      // Enlazar pestañas y sidebar; si algún módulo falla, no bloquear el resto
      document.querySelectorAll('.tab').forEach(btn => {
        btn.addEventListener('click', () => {
          const tab = btn.dataset.tab;
          try { switchTab(tab); } catch(_){}
          try { if(tab === 'clases') loadClasesPanel(); } catch(_){}
          try { if(tab === 'pagos') loadPayments(); } catch(_){}
          try { if(tab === 'usuarios') loadUsers(); } catch(_){}
          try { if(tab === 'profesores') loadProfesoresPanel(); } catch(_){}
          try { if(tab === 'ejercicios') loadEjercicios(); } catch(_){}
          try { if(tab === 'rutinas') loadRutinas(); } catch(_){}
          try { if(tab === 'configuracion') loadConfigData(); } catch(_){}
        });
      });
      // Subtabs móviles: replicar comportamiento de sidebar y header
      document.querySelectorAll('#mobile-subtabs [data-tab]').forEach(item => {
        item.addEventListener('click', (e) => {
          e.preventDefault();
          const tab = item.getAttribute('data-tab');
          const btn = document.querySelector('.tab[data-tab="'+tab+'"]');
          if(btn){ try{ btn.click(); }catch(_){} }
          else { try{ switchTab(tab); }catch(_){} }
          try{ closeMobileSubtabs(); }catch(_){}
        });
      });
      // Botones de toggle de sidebar controlan también la barra móvil
      document.querySelectorAll('[data-sidebar-toggle]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          if((window.innerWidth || document.documentElement.clientWidth || 0) <= 960){
            e.preventDefault();
            try{ e.stopPropagation(); }catch(_){}
            try{ toggleMobileSubtabs(); }catch(_){}
            try{ reorderMobileSubtabs(); }catch(_){}
          }
        });
      });
      // Peek controla apertura de barra móvil
      try{
        const peek = document.getElementById('mobile-subtabs-peek');
        if(peek){ peek.addEventListener('click', (e) => { if((window.innerWidth || document.documentElement.clientWidth || 0) <= 960){ try{ toggleMobileSubtabs(); }catch(_){} try{ reorderMobileSubtabs(); }catch(_){} } }); }
      }catch(_){}
      // Modo compacto al hacer scroll (solo móvil)
      try{
        const nav = document.getElementById('mobile-subtabs');
        const onScroll = () => {
          if(!nav) return;
          if(window.innerWidth > 960){ nav.classList.remove('compact'); return; }
          const scrolled = (window.scrollY || document.documentElement.scrollTop || 0) > 64;
          nav.classList.toggle('compact', scrolled);
          try{
            const y = (window.scrollY || document.documentElement.scrollTop || 0);
            if(y > 160 && document.body.classList.contains('mobile-subtabs-open')){ closeMobileSubtabs(); }
          }catch(_){}
        };
        window.addEventListener('scroll', onScroll, { passive: true });
        onScroll();
      }catch(_){}
      // Gestos de swipe para cambiar pestañas (solo móvil)
      try{
        const main = document.getElementById('main-content');
        let sx = 0, sy = 0;
        main.addEventListener('touchstart', (e) => {
          const t = e.touches && e.touches[0];
          if(!t) return;
          sx = t.clientX; sy = t.clientY;
        }, { passive: true });
        main.addEventListener('touchend', (e) => {
          const t = e.changedTouches && e.changedTouches[0];
          if(!t) return;
          const dx = t.clientX - sx; const dy = t.clientY - sy;
          if(window.innerWidth > 960) return;
          if(Math.abs(dx) < 48 || Math.abs(dx) < Math.abs(dy)+10) return;
          const items = Array.from(document.querySelectorAll('#mobile-subtabs [data-tab]'));
          const idx = items.findIndex(i => i.classList.contains('active'));
          if(idx < 0) return;
          let nextIdx = idx;
          if(dx < 0 && idx < items.length-1) nextIdx = idx+1; // swipe izquierda => siguiente
          else if(dx > 0 && idx > 0) nextIdx = idx-1; // swipe derecha => anterior
          if(nextIdx !== idx){ try{ items[nextIdx].click(); }catch(_){} try{ closeMobileSubtabs(); }catch(_){} }
        }, { passive: true });
      }catch(_){}
      // Reordenar barra móvil al iniciar y actualizar etiqueta del peek
      try{ reorderMobileSubtabs(); }catch(_){}
      try{ updatePeekLabel(); }catch(_){}
      // Cerrar barra móvil al hacer click fuera
      try{
        document.addEventListener('click', (e) => {
          try{
            if((window.innerWidth || document.documentElement.clientWidth || 0) > 960) return;
            const open = document.body.classList.contains('mobile-subtabs-open');
            if(!open) return;
            const nav = document.getElementById('mobile-subtabs');
            const t = e.target;
            const inNav = nav && t && typeof t.closest==='function' ? !!t.closest('#mobile-subtabs') : false;
            const onToggle = t && typeof t.closest==='function' ? !!t.closest('[data-sidebar-toggle]') : false;
            if(!inNav && !onToggle){ closeMobileSubtabs(); }
          }catch(_){}
        }, true);
      }catch(_){}
      // Sidebar: enlazar elementos con data-tab a las mismas acciones de pestañas
      document.querySelectorAll('.sidebar .nav-item[data-tab]').forEach(item => {
        item.addEventListener('click', (e) => {
          e.preventDefault();
          const tab = item.getAttribute('data-tab');
          const btn = document.querySelector('.tab[data-tab="'+tab+'"]');
          if(btn){ try{ btn.click(); }catch(_){} }
          document.querySelectorAll('.sidebar .nav-item').forEach(x => x.classList.remove('active'));
          item.classList.add('active');
        });
      });
      // Aplicar pestaña persistida si existe
      try {
        const persisted = localStorage.getItem('gestion-active-tab') || '';
        const validTabs = ['pagos','usuarios','profesores','clases','ejercicios','rutinas','configuracion'];
        const initial = validTabs.includes(persisted) ? persisted : '';
        if(initial){
          const btn = document.querySelector('.tab[data-tab="'+initial+'"]');
          if(btn){ btn.click(); }
          document.querySelectorAll('.sidebar .nav-item[data-tab]').forEach(item => {
            const isActive = (item.getAttribute('data-tab') || '') === initial;
            item.classList.toggle('active', isActive);
            if(isActive) item.setAttribute('aria-current','page');
            else item.removeAttribute('aria-current');
          });
        }
      } catch(_){}
      let start = '', end = '';
      try { const r = defaultRange(); start = r.start; end = r.end; } catch(_){}
      const startEl = document.getElementById('pagos-start');
      const endEl = document.getElementById('pagos-end');
      if(startEl && !startEl.value) startEl.value = start;
      if(endEl && !endEl.value) endEl.value = end;
      const pagosRefreshEl = document.getElementById('pagos-refresh');
      if(pagosRefreshEl) pagosRefreshEl.addEventListener('click', loadPayments);
      const pagosQEl = document.getElementById('pagos-q');
      if(pagosQEl) pagosQEl.addEventListener('keydown', (e) => { if(e.key === 'Enter') loadPayments(); });
      // Búsqueda con debounce para mejor rendimiento
      try{
        const pagosQ = document.getElementById('pagos-q');
        if(pagosQ){ pagosQ.addEventListener('input', debounce(() => { loadPayments(); }, 300)); }
        const pagosStart = document.getElementById('pagos-start');
        const pagosEnd = document.getElementById('pagos-end');
        if(pagosStart){ pagosStart.addEventListener('input', debounce(() => { loadPayments(); }, 300)); pagosStart.addEventListener('change', () => { loadPayments(); }); }
        if(pagosEnd){ pagosEnd.addEventListener('input', debounce(() => { loadPayments(); }, 300)); pagosEnd.addEventListener('change', () => { loadPayments(); }); }
      } catch(_){}
      const pagosLimitEl = document.getElementById('pagos-limit');
      if(pagosLimitEl) pagosLimitEl.addEventListener('change', loadPayments);
      const selPU = document.getElementById('pagos-usuario');
      if(selPU){
        selPU.addEventListener('change', () => {
          const val = selPU.value || '';
          const u = (state.usuarios || []).find(x => String(x.id) === String(val));
          const input = document.getElementById('pagos-q');
          if(u && input){
            input.value = String(u.dni || '') || (u.nombre || '');
          } else if(input){
            input.value = '';
          }
          loadPayments();
        });
      }
      try{ bindPagosEvents(); }catch(_){}
      try{ bindUsuariosEvents(); }catch(_){}
      try{ bindConfiguracionEvents(); }catch(_){}
      try{ bindEjerciciosEvents(); }catch(_){}
      try{ bindRutinasEvents(); }catch(_){}
      try{ bindProfesoresEvents(); }catch(_){}
      try{ renderLoginInfo(); }catch(_){}
      try{ refreshTopBarSesion(); }catch(_){}
      const roleEl = document.getElementById('login-current');
      const role = roleEl ? (roleEl.getAttribute('data-role') || '') : '';
      const btnProf = document.getElementById('tab-btn-profesores');
      if(btnProf && role === 'profesor'){ btnProf.style.display = 'none'; }
      const sideProfItem = document.querySelector('.sidebar .nav-item[data-tab="profesores"]');
      if(sideProfItem && role === 'profesor'){ sideProfItem.style.display = 'none'; }
      const mobileProfItem = document.querySelector('#mobile-subtabs [data-tab="profesores"]');
      if(mobileProfItem && role === 'profesor'){ mobileProfItem.style.display = 'none'; }

      // Interceptar logout para profesor: mostrar confirmación
      const logoutLink = document.querySelector('a[href^="/gestion/logout"]');
      if(logoutLink){
        logoutLink.addEventListener('click', (e) => {
          const r = roleEl ? (roleEl.getAttribute('data-role') || '').trim() : '';
          if(r === 'profesor'){
            e.preventDefault();
            try{ e.stopPropagation(); e.stopImmediatePropagation(); }catch(_){}
            try{ populateSesionFinModal(); }catch(_){}
            try{ openModal('modal-sesion-fin'); }catch(_){}
          }
        });
      }
      // Fallback robusto: interceptar a nivel documento (captura) por si el enlace cambia o se re-renderiza
      document.addEventListener('click', (e) => {
        try{
          const t = e.target;
          const link = t && typeof t.closest==='function' ? t.closest('a[href^="/gestion/logout"]') : null;
          if(!link) return;
          const r = roleEl ? (roleEl.getAttribute('data-role') || '').trim() : '';
          if(r !== 'profesor') return;
          e.preventDefault();
          try{ e.stopPropagation(); e.stopImmediatePropagation(); }catch(_){}
          try{ populateSesionFinModal(); }catch(_){}
          try{ openModal('modal-sesion-fin'); }catch(_){}
          try{
            setTimeout(() => {
              try{
                const m = document.getElementById('modal-sesion-fin');
                let visible = false;
                if(m){
                  const cs = window.getComputedStyle(m);
                  const rects = (typeof m.getClientRects === 'function') ? m.getClientRects() : [];
                  const notInBody = !!(m.parentElement && m.parentElement.tagName && m.parentElement.tagName.toLowerCase() !== 'body');
                  visible = !!(cs && cs.display !== 'none' && cs.visibility !== 'hidden' && rects.length > 0);
                  if(!visible || notInBody){
                    try{
                      document.body.appendChild(m);
                      // Reabrir con util para asegurar z-index correcto y foco accesible
                      try{ openModal('modal-sesion-fin'); }catch(__){ m.classList.add('active'); m.setAttribute('aria-hidden','false'); }
                      const rects2 = (typeof m.getClientRects === 'function') ? m.getClientRects() : [];
                      visible = !!(rects2.length > 0);
                    }catch(__){}
                  }
                }
                if(!visible){
                  (async () => {
                    try{
                      const roleEl2 = document.getElementById('login-current');
                      const pidRaw2 = roleEl2 ? (roleEl2.getAttribute('data-prof-id') || '').trim() : '';
                      const body2 = pidRaw2 ? JSON.stringify({ profesor_id: Number(pidRaw2) }) : JSON.stringify({});
                      const res2 = await fetch('/api/profesor_sesion_fin', { method:'POST', headers:{ 'Accept':'application/json', 'Content-Type':'application/json' }, body: body2 });
                      const data2 = await res2.json().catch(() => ({}));
                      if(!res2.ok || data2.success === false){ showToast(data2.detail || data2.error || data2.message || 'No se pudo finalizar la sesión', 'error', 4500); }
                    }catch(_){ showToast('Error de red al finalizar sesión', 'error', 4500); }
                    try{ window.location.href = '/gestion/logout'; }catch(_){}
                  })();
                }
              }catch(_){ /* noop */ }
            }, 150);
          }catch(_){}
        }catch(_){ /* noop */ }
      }, true);
      const finClose = document.getElementById('sesion-fin-close');
      const finCancel = document.getElementById('sesion-fin-cancel');
      const finConfirm = document.getElementById('sesion-fin-confirm');
      if(finClose) finClose.onclick = () => { try{ closeModal('modal-sesion-fin'); }catch(_){} };
      if(finCancel) finCancel.onclick = () => { try{ closeModal('modal-sesion-fin'); }catch(_){ } };
      if(finConfirm) finConfirm.onclick = async () => {
        const btn = finConfirm;
        try{
          btn.disabled = true; btn.setAttribute('aria-busy','true');
          const roleEl = document.getElementById('login-current');
          const pidRaw = roleEl ? (roleEl.getAttribute('data-prof-id') || '').trim() : '';
          const body = pidRaw ? JSON.stringify({ profesor_id: Number(pidRaw) }) : JSON.stringify({});
          const res = await fetch('/api/profesor_sesion_fin', { method:'POST', headers:{ 'Accept':'application/json', 'Content-Type':'application/json' }, body });
          const data = await res.json().catch(() => ({}));
          if(res.status === 401){ showToast('Sesión de gestión requerida', 'error', 4500); try{ window.location.href = '/gestion/login'; }catch(_){ } return; }
          if(!res.ok || data.success === false){
            showToast(data.detail || data.error || data.message || 'No se pudo finalizar la sesión', 'error', 5000);
            try{ closeModal('modal-sesion-fin'); }catch(_){}
            try{ window.location.href = '/gestion/logout'; }catch(_){}
            return;
          }
          showToast('Sesión finalizada', 'success', 3000);
          try{ closeModal('modal-sesion-fin'); }catch(_){}
          try{ refreshTopBarSesion(); refreshSesion(); }catch(_){}
          try{ window.location.href = '/gestion/logout'; }catch(_){}
        }catch(e){
          showToast('Error de red al finalizar sesión', 'error', 4500);
          try{ closeModal('modal-sesion-fin'); }catch(_){}
          try{ window.location.href = '/gestion/logout'; }catch(_){}
        }
        finally{ btn.disabled = false; btn.removeAttribute('aria-busy'); }
      };
      try{ loadEstadoPlantillas(); }catch(_){}
      // Auto-ocultar header al hacer scroll (usa main como contenedor de scroll)
      const headerEl = document.getElementById('main-header');
      const mainEl = document.getElementById('main-content');
      if(headerEl){
        let lastY = mainEl ? mainEl.scrollTop : window.scrollY;
        let hidden = false;
        function onScroll(){
          const y = mainEl ? mainEl.scrollTop : window.scrollY;
          if(y > lastY && y > 20){
            if(!hidden){ headerEl.classList.add('header--hidden'); hidden = true; }
          } else {
            if(hidden){ headerEl.classList.remove('header--hidden'); hidden = false; }
          }
          lastY = y;
        }
        const scrollTarget = mainEl || window;
        scrollTarget.addEventListener('scroll', onScroll, { passive: true });
      }
      // Precarga datos base para una UX fluida
      try{
        Promise.allSettled([
          loadConceptosPago(),
          loadMetodosPago(),
          loadTiposCuotaActivos(),
          ensureTiposCuotaCatalogo(),
        ]).catch(()=>{});
      }catch(_){}
      // Banner de salud eliminado
      // Cargar primer listado de Usuarios
      try{ loadUsers(); }catch(_){}
      // Cargar pagos por defecto (últimos 30 días)
      try{ loadPayments(); }catch(_){}
    }
    // ==== Profesores: estado y funciones ====
  function ensureProfesoresState(){
    if(!window.state) window.state = {};
    if(!state.profesores) state.profesores = { list: [], horarios: [], sesiones: [], horarioEditId: null, sesionEditId: null, activeSubtab: 'resumen', sesionTimerId: null, sesionTickId: null, sesionActive: false, lastDurationMin: 0, lastDurationAt: 0, currentUsuario: null };
  }
  function bindProfesoresEvents(){
    const btnRefresh = document.getElementById('prof-refresh');
    const selProf = document.getElementById('profesor-select');
    const btnAdd = document.getElementById('horario-add');
    const btnCancel = document.getElementById('horario-cancel');
    const btnStart = document.getElementById('sesion-iniciar');
    const btnEnd = document.getElementById('sesion-finalizar');
    const btnSesRefresh = document.getElementById('prof-ses-refresh');
    const btnSesWeek = document.getElementById('prof-ses-week');
    const btnSesMonth = document.getElementById('prof-ses-month');
    const sesStartEl = document.getElementById('prof-ses-start');
    const sesEndEl = document.getElementById('prof-ses-end');
    const weekDate = document.getElementById('prof-week-date');
    const weekStart = document.getElementById('prof-week-start');
    if(!document.getElementById('panel-profesores')) return;
    if(btnRefresh) btnRefresh.onclick = () => loadProfesoresBasico(true);
    if(selProf) selProf.onchange = () => { ensureProfesoresState(); state.profesores.horarioEditId = null; resetHorarioForm(); loadProfesorDatos(); loadProfesorHorarios(); loadProfesorConfig(); refreshSesion(); if(state.profesores.activeSubtab==='resumen') loadProfesorResumen(); if(state.profesores.activeSubtab==='sesiones') loadProfesorSesiones(); };
    if(btnAdd) btnAdd.onclick = addOrUpdateHorario;
    if(btnCancel) btnCancel.onclick = () => { ensureProfesoresState(); state.profesores.horarioEditId = null; resetHorarioForm(); };
    // Asignar eventos de sesión solo para Dueño
    try{
      const roleEl = document.getElementById('login-current');
      const role = roleEl ? (roleEl.getAttribute('data-role') || '') : '';
      if(btnStart) btnStart.onclick = (role === 'dueño') ? startSesion : null;
      if(btnEnd) btnEnd.onclick = (role === 'dueño') ? endSesion : null;
    } catch(_){
      if(btnStart) btnStart.onclick = null;
      if(btnEnd) btnEnd.onclick = null;
    }
    if(btnSesRefresh) btnSesRefresh.onclick = loadProfesorSesiones;
    if(btnSesWeek) btnSesWeek.onclick = () => { const base = toISODate(new Date()); const mode = (document.getElementById('prof-week-start')?.value || 'mon'); const r = getWeekRange(base, mode); if(sesStartEl) sesStartEl.value = r.start; if(sesEndEl) sesEndEl.value = r.end; loadProfesorSesiones(); };
    if(btnSesMonth) btnSesMonth.onclick = () => { const r = getMonthRange(); if(sesStartEl) sesStartEl.value = r.start; if(sesEndEl) sesEndEl.value = r.end; loadProfesorSesiones(); };
    const btnDatosSave = document.getElementById('prof-datos-save');
    if(btnDatosSave) btnDatosSave.onclick = saveProfesorDatos;
    const btnConfigSave = document.getElementById('prof-config-save');
    if(btnConfigSave) btnConfigSave.onclick = saveProfesorConfig;
    if(weekDate) weekDate.onchange = loadProfesorResumen;
    if(weekStart) weekStart.onchange = loadProfesorResumen;
    if(document.getElementById('prof-subtabs')) bindProfesoresSubtabsEvents();
    // Inicializar semana con hoy
    const today = new Date();
    if(weekDate && !weekDate.value) weekDate.value = toISODate(today);
    // Eventos modal edición de sesión
    const sesSave = document.getElementById('sesion-save');
    const sesCancel = document.getElementById('sesion-form-cancel');
    const sesClose = document.getElementById('sesion-form-close');
    const sesFecha = document.getElementById('sesion-fecha');
    const sesInicio = document.getElementById('sesion-inicio');
    const sesFin = document.getElementById('sesion-fin');
    const sesMin = document.getElementById('sesion-minutos');
    const sesAuto = document.getElementById('sesion-auto');
    const sesTipo = document.getElementById('sesion-tipo');

    function calcMinutesFromInputs(){
      const dateStr = sesFecha?.value || toISODate(new Date());
      const iVal = sesInicio?.value || '';
      const fVal = sesFin?.value || '';
      if(!dateStr || !iVal || !fVal) return null;
      try{
        const sDate = new Date(`${dateStr}T${String(iVal).padStart(5,'0')}:00`);
        let eDate = new Date(`${dateStr}T${String(fVal).padStart(5,'0')}:00`);
        if(eDate < sDate){ eDate = new Date(eDate.getTime() + 24*60*60*1000); }
        const minutes = Math.max(0, Math.round((eDate - sDate) / 60000));
        return minutes;
      }catch(_){ return null; }
    }
    function updateSesionResumen(){
      const resMinEl = document.getElementById('sesion-resumen-min');
      const resHrsEl = document.getElementById('sesion-resumen-horas');
      const autoOn = !!(sesAuto && sesAuto.checked);
      const calc = calcMinutesFromInputs();
      if(autoOn && sesMin){ sesMin.value = calc != null ? String(calc) : ''; }
      if(resMinEl) resMinEl.textContent = calc != null ? String(calc) : '—';
      if(resHrsEl) resHrsEl.textContent = calc != null ? (calc/60).toFixed(2) : '—';
      try{ updateExtraIndicators(); }catch(_){}
    }

    if(sesSave) sesSave.onclick = saveSesionEdit;
    if(sesCancel) sesCancel.onclick = () => { ensureProfesoresState(); state.profesores.sesionEditId = null; closeModal('modal-sesion-form'); };
    if(sesClose) sesClose.onclick = () => { ensureProfesoresState(); state.profesores.sesionEditId = null; closeModal('modal-sesion-form'); };

    if(sesAuto) sesAuto.onchange = () => { const on = sesAuto.checked; if(sesMin) sesMin.disabled = on; updateSesionResumen(); try{ updateTipoHint(); }catch(_){} };
    if(sesFecha) sesFecha.onchange = () => { updateSesionResumen(); try{ updateFechaDiaLabel(); updateTipoHint(); }catch(_){} };
    if(sesInicio) sesInicio.oninput = () => { updateSesionResumen(); try{ updateTipoHint(); }catch(_){} };
    if(sesFin) sesFin.oninput = () => { updateSesionResumen(); try{ updateTipoHint(); }catch(_){} };
    if(sesMin) sesMin.oninput = () => { const resHrsEl = document.getElementById('sesion-resumen-horas'); const v = Number(sesMin.value); if(!isFinite(v)) { if(resHrsEl) resHrsEl.textContent = '—'; return; } if(resHrsEl) resHrsEl.textContent = (Math.max(0, Math.round(v))/60).toFixed(2); try{ updateTipoHint(); }catch(_){} };
    if(sesTipo) sesTipo.onchange = () => { updateSesionResumen(); try{ updateTipoHint(); }catch(_){} };
  }
  function loadProfesoresPanel(){
    ensureProfesoresState();
    bindProfesoresEvents();
    loadProfesoresBasico();
  }
  function loadProfesoresBasico(){
    ensureProfesoresState();
    fetch('/api/profesores_basico')
      .then(r => r.json())
      .then(list => {
        state.profesores.list = Array.isArray(list) ? list : [];
        const sel = document.getElementById('profesor-select');
        if(!sel) return;
        const prev = sel.value;
        sel.innerHTML = state.profesores.list.map(p => `<option value="${p.profesor_id}">${p.nombre || ('Profesor ' + p.profesor_id)}</option>`).join('');
        const hasPrev = state.profesores.list.some(p => String(p.profesor_id) === String(prev));
        if(hasPrev) sel.value = prev;
        if(!sel.value && state.profesores.list.length) sel.value = String(state.profesores.list[0].profesor_id);
        loadProfesorDatos();
        loadProfesorHorarios();
        loadProfesorConfig();
        refreshSesion();
        loadProfesorResumen();
      })
      .catch(_ => {
        if (typeof showToast === 'function') showToast('Error cargando profesores', 'error');
      });
  }
  function loadProfesorHorarios(){
    ensureProfesoresState();
    const sel = document.getElementById('profesor-select');
    if(!sel || !sel.value) return;
    const pid = sel.value;
    fetch(`/api/profesor_horarios?profesor_id=${encodeURIComponent(pid)}`)
      .then(r => r.json())
      .then(list => {
        state.profesores.horarios = Array.isArray(list) ? list : [];
        renderHorariosTable();
      })
      .catch(_ => {
        if (typeof showToast === 'function') showToast('Error cargando horarios', 'error');
      });
  }
  function renderHorariosTable(){
    const tbody = document.querySelector('#prof-horarios-table tbody');
    const count = document.getElementById('horarios-count');
    if(!tbody) return;
    const rows = (state.profesores.horarios || []).map(h => {
      const disponibleTxt = h.disponible ? 'Sí' : 'No';
      const id = h.id ?? h.horario_id ?? '';
      const dia = h.dia ?? h.dia_semana ?? '';
      const inicio = (h.inicio || h.hora_inicio || '').toString().slice(0,5);
      const fin = (h.fin || h.hora_fin || '').toString().slice(0,5);
      return `<tr data-id="${id}">
        <td>${dia}</td>
        <td>${inicio}</td>
        <td>${fin}</td>
        <td>${disponibleTxt}</td>
        <td>
          <button class="btn tiny" data-action="edit">Editar</button>
          <button class="btn tiny danger" data-action="delete">Eliminar</button>
        </td>
      </tr>`;
    }).join('');
    tbody.innerHTML = rows;
    if(count) count.textContent = `${state.profesores.horarios.length} registros`;
    tbody.querySelectorAll('button[data-action="edit"]').forEach(btn => {
      btn.onclick = ev => {
        const tr = ev.target.closest('tr');
        const id = tr?.getAttribute('data-id');
        if(!id) return;
        handleEditHorario(id);
      };
    });
    tbody.querySelectorAll('button[data-action="delete"]').forEach(btn => {
      btn.onclick = ev => {
        const tr = ev.target.closest('tr');
        const id = tr?.getAttribute('data-id');
        if(!id) return;
        handleDeleteHorario(id);
      };
    });
  }
  function resetHorarioForm(){
    const addBtn = document.getElementById('horario-add');
    const cancelBtn = document.getElementById('horario-cancel');
    const diaSel = document.getElementById('horario-dia');
    const inicio = document.getElementById('horario-inicio');
    const fin = document.getElementById('horario-fin');
    const disp = document.getElementById('horario-disponible');
    if(addBtn) addBtn.textContent = 'Añadir';
    if(cancelBtn) cancelBtn.style.display = 'none';
    if(diaSel) diaSel.value = 'Lunes';
    if(inicio) inicio.value = '';
    if(fin) fin.value = '';
    if(disp) disp.checked = true;
  }
  function handleEditHorario(id){
    const h = (state.profesores.horarios || []).find(x => (String(x.id ?? x.horario_id) === String(id)));
    if(!h) return;
    state.profesores.horarioEditId = String(id);
    const addBtn = document.getElementById('horario-add');
    const cancelBtn = document.getElementById('horario-cancel');
    const diaSel = document.getElementById('horario-dia');
    const inicio = document.getElementById('horario-inicio');
    const fin = document.getElementById('horario-fin');
    const disp = document.getElementById('horario-disponible');
    if(addBtn) addBtn.textContent = 'Guardar';
    if(cancelBtn) cancelBtn.style.display = 'inline-block';
    if(diaSel) diaSel.value = h.dia ?? h.dia_semana ?? 'Lunes';
    if(inicio) inicio.value = (h.inicio || h.hora_inicio || '').toString().slice(0,5);
    if(fin) fin.value = (h.fin || h.hora_fin || '').toString().slice(0,5);
    if(disp) disp.checked = !!h.disponible;
  }
  function openSesionEdit(id){
    ensureProfesoresState();
    state.profesores.sesionEditId = String(id);
    const ses = (state.profesores.sesiones || []).find(x => String(x.id ?? x.sesion_id ?? x.id_sesion ?? x.SesionID) === String(id));
    if(!ses){ if (typeof showToast === 'function') showToast('No se encontró la sesión', 'error'); return; }
    const fecha = String(ses.fecha ?? ses.Fecha ?? ses.fecha_sesion ?? ses.fecha_numerica ?? ses.fecha_num ?? ses.date ?? ses.dia ?? ses.FechaSesion ?? '').slice(0,10);
    const inicioRaw = (ses.inicio ?? ses.hora_inicio ?? ses.Inicio ?? ses.entrada ?? ses.HoraInicio ?? ses.start_time ?? ses.horaEntrada ?? '');
    const finRaw = (ses.fin ?? ses.hora_fin ?? ses.Fin ?? ses.salida ?? ses.HoraFin ?? ses.end_time ?? ses.horaSalida ?? '');
    const tipoVal = (ses.tipo ?? ses.tipo_actividad ?? ses.Tipo ?? ses.actividad ?? '');
    const fEl = document.getElementById('sesion-fecha');
    const iEl = document.getElementById('sesion-inicio');
    const finEl = document.getElementById('sesion-fin');
    const tEl = document.getElementById('sesion-tipo');
    const minEl = document.getElementById('sesion-minutos');
    const autoEl = document.getElementById('sesion-auto');
    if(fEl) fEl.value = fecha || '';
    if(iEl) iEl.value = extractTime(inicioRaw).replace('—','');
    if(finEl) finEl.value = extractTime(finRaw).replace('—','');
    if(tEl){
      const val = String(tipoVal || '');
      const opts = Array.from(tEl.options || []);
      const exists = opts.some(o => String(o.value) === val);
      if(val && !exists){
        try{
          const opt = document.createElement('option');
          opt.value = val;
          opt.textContent = val;
          tEl.insertBefore(opt, tEl.firstChild);
        }catch(_){}
      }
      // Forzar Automático como selección por defecto al abrir el modal
      tEl.value = 'Auto';
    }
    if(minEl) minEl.value = String(ses.minutos ?? ses.minutos_totales ?? '');
    if(autoEl){ autoEl.checked = true; if(minEl) minEl.disabled = true; }
    try{ if(iEl) iEl.dispatchEvent(new Event('input')); }catch(_){}
    try{ updateFechaDiaLabel(); updateTipoHint(); }catch(_){}
    openModal('modal-sesion-form');
  }
  async function saveSesionEdit(){
    try{
      ensureProfesoresState();
      const id = state.profesores.sesionEditId;
      if(!id){ if (typeof showToast === 'function') showToast('No hay sesión seleccionada', 'error'); return; }
      const fEl = document.getElementById('sesion-fecha');
      const iEl = document.getElementById('sesion-inicio');
      const finEl = document.getElementById('sesion-fin');
      const tEl = document.getElementById('sesion-tipo');
      const minEl = document.getElementById('sesion-minutos');
      const autoEl = document.getElementById('sesion-auto');
      let minutosPayload = null;
      if(autoEl && autoEl.checked){
        minutosPayload = null;
      } else {
        const mv = minEl ? Number(minEl.value) : null;
        minutosPayload = (mv != null && isFinite(mv)) ? Math.max(0, Math.round(mv)) : null;
      }
      const payload = {
        fecha: fEl ? fEl.value : null,
        inicio: iEl ? iEl.value : null,
        fin: finEl ? finEl.value : null,
        tipo: tEl ? String(tEl.value || '').trim() : null,
        minutos: minutosPayload
      };
      const r = await fetch(`/api/profesor_sesion/${encodeURIComponent(id)}`, {
        method: 'PUT',
        headers: { 'Content-Type':'application/json', 'Accept':'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await r.json().catch(()=> ({}));
      if(!r.ok){
        if (typeof showToast === 'function') showToast(data?.detail || data?.error || 'No se pudo actualizar la sesión', 'error');
        return;
      }
      if (typeof showToast === 'function') showToast('Sesión actualizada correctamente', 'success');
      closeModal('modal-sesion-form');
      state.profesores.sesionEditId = null;
      await loadProfesorSesiones();
      await loadProfesorResumen();
    }catch(e){ if (typeof showToast === 'function') showToast('Error de red al actualizar sesión', 'error'); }
  }

  function getWeekdayNameISO(dateStr){
    try{
      const d = new Date(dateStr);
      if(isNaN(d.getTime())) return null;
      const dias = ['Domingo','Lunes','Martes','Miércoles','Jueves','Viernes','Sábado'];
      return dias[d.getDay()];
    }catch(_){ return null; }
  }
  function updateFechaDiaLabel(){
    const dayEl = document.getElementById('sesion-fecha-dia');
    const fEl = document.getElementById('sesion-fecha');
    const nombre = fEl && fEl.value ? getWeekdayNameISO(fEl.value) : null;
    if(dayEl) dayEl.textContent = nombre ? `Día: ${nombre}` : '—';
  }
  // Cálculo robusto de cobertura y extra con unión de bloques
  function hmToMin(v){ const s = String(v).slice(0,5); const parts = s.split(':').map(Number); if(parts.length!==2 || parts.some(x=>!isFinite(x))) return null; return parts[0]*60 + parts[1]; }
  function mergeIntervals(blocks){
    const sorted = blocks.slice().sort((a,b)=> a.start - b.start);
    const merged = [];
    for(const b of sorted){
      if(!merged.length || b.start > merged[merged.length-1].end){ merged.push({ start:b.start, end:b.end }); }
      else { merged[merged.length-1].end = Math.max(merged[merged.length-1].end, b.end); }
    }
    return merged;
  }
  function computeCoverageExtra(dateStr, iVal, fVal){
    try{
      ensureProfesoresState();
      if(!dateStr || !iVal || !fVal) return null;
      const s = hmToMin(iVal); let e = hmToMin(fVal);
      if(s==null || e==null) return null;
      const dObj = new Date(dateStr);
      const dayName = getWeekdayNameISO(dateStr);
      const dayNum = dObj.getDay();

      // Construir bloques del día actual
      const blocksDay = (state.profesores.horarios || [])
        .filter(h => {
          const dRaw = (h.dia ?? h.dia_semana);
          const match = String(dRaw) === String(dayName) || String(dRaw) === String(dayNum);
          const disp = (h.disponible === undefined) ? true : !!h.disponible;
          return match && disp;
        })
        .map(h => {
          const si = extractTime(h.inicio || h.hora_inicio || '');
          const sf = extractTime(h.fin || h.hora_fin || '');
          return { start: hmToMin(si), end: hmToMin(sf) };
        })
        .filter(b => b.start!=null && b.end!=null && b.end>b.start);
      const unionDay = mergeIntervals(blocksDay);

      // Si la sesión cruza medianoche, partir en dos segmentos y considerar bloques del día siguiente
      let sessionDuration = 0;
      let covered = 0;
      if(e < s){ e += 1440; }
      sessionDuration = Math.max(0, e - s);

      const coverSegment = (blocks, segStart, segEnd) => {
        if(!blocks || blocks.length === 0){
          // Sin horario definido: no hay cobertura; todo ese segmento será extra
          return 0;
        }
        let c = 0;
        const left = Math.max(segStart, 0);
        const right = Math.min(segEnd, 1440);
        for(const b of blocks){
          const overlap = Math.max(0, Math.min(b.end, right) - Math.max(b.start, left));
          c += overlap;
        }
        return c;
      };

      if(e <= 1440){
        covered += coverSegment(unionDay, s, e);
      } else {
        // Día actual
        covered += coverSegment(unionDay, s, 1440);
        // Día siguiente: construir bloques
        const nextDate = new Date(dObj.getTime());
        nextDate.setDate(dObj.getDate()+1);
        const nextName = getWeekdayNameISO(nextDate.toISOString().slice(0,10));
        const nextNum = nextDate.getDay();
        const blocksNext = (state.profesores.horarios || [])
          .filter(h => {
            const dRaw = (h.dia ?? h.dia_semana);
            const match = String(dRaw) === String(nextName) || String(dRaw) === String(nextNum);
            const disp = (h.disponible === undefined) ? true : !!h.disponible;
            return match && disp;
          })
          .map(h => {
            const si = extractTime(h.inicio || h.hora_inicio || '');
            const sf = extractTime(h.fin || h.hora_fin || '');
            return { start: hmToMin(si), end: hmToMin(sf) };
          })
          .filter(b => b.start!=null && b.end!=null && b.end>b.start);
        const unionNext = mergeIntervals(blocksNext);
        covered += coverSegment(unionNext, 0, e - 1440);
      }

      const extra = Math.max(0, sessionDuration - covered);
      return { coveredMin: covered, extraMin: extra, totalMin: sessionDuration };
    }catch(_){ return null; }
  }
  function predictTipoFromHorario(){
    try{
      ensureProfesoresState();
      const fEl = document.getElementById('sesion-fecha');
      const iEl = document.getElementById('sesion-inicio');
      const finEl = document.getElementById('sesion-fin');
      const dateStr = fEl?.value || '';
      const iVal = iEl?.value || '';
      const fVal = finEl?.value || '';
      if(!dateStr || !iVal || !fVal) return null;
      const cov = computeCoverageExtra(dateStr, iVal, fVal);
      if(!cov) return null;
      if(cov.coveredMin > 0 && cov.extraMin > 0) return 'Trabajo - Extra';
      if(cov.extraMin === 0 && cov.coveredMin > 0) return 'En horario';
      if(cov.coveredMin === 0 && cov.extraMin > 0) return 'Horas extra';
      return null;
    }catch(_){ return null; }
  }
  function updateExtraIndicators(){
    const fEl = document.getElementById('sesion-fecha');
    const iEl = document.getElementById('sesion-inicio');
    const finEl = document.getElementById('sesion-fin');
    const chipCov = document.getElementById('sesion-chip-cobertura');
    const chipExt = document.getElementById('sesion-chip-extra');
    const dateStr = fEl?.value || '';
    const iVal = iEl?.value || '';
    const fVal = finEl?.value || '';
    const cov = (dateStr && iVal && fVal) ? computeCoverageExtra(dateStr, iVal, fVal) : null;
    if(!cov){ if(chipCov) chipCov.textContent = 'En horario: —'; if(chipExt) chipExt.textContent = 'Horas extra: —'; return null; }
    const covH = (cov.coveredMin/60).toFixed(2);
    const extH = (cov.extraMin/60).toFixed(2);
    if(chipCov) chipCov.textContent = `En horario: ${cov.coveredMin} (${covH} h)`;
    if(chipExt) chipExt.textContent = `Horas extra: ${cov.extraMin} (${extH} h)`;
    return cov;
  }
  function updateTipoHint(){
    const chipTxt = document.getElementById('sesion-tipo-sugerido');
    const tEl = document.getElementById('sesion-tipo');
    const pred = predictTipoFromHorario();
    if(chipTxt) chipTxt.textContent = pred || '—';
    // Si el usuario elige explícitamente "En horario" pero la sugerencia es "Horas extra", mostrar aviso en el hint
    const hint = document.getElementById('sesion-tipo-hint');
    const warnEl = document.getElementById('sesion-tipo-warning');
    if(hint){
      if(tEl && tEl.value === 'En horario' && pred === 'Horas extra'){
        hint.innerHTML = 'Sugerencia según horarios: <span id="sesion-tipo-sugerido">Horas extra</span> · <span style="color:#b00020">fuera de horario</span>';
      } else {
        hint.innerHTML = 'Sugerencia según horarios: <span id="sesion-tipo-sugerido">' + (pred || '—') + '</span>';
      }
    }
    if(warnEl){
      const mismatch = (tEl && tEl.value === 'En horario' && pred === 'Horas extra');
      warnEl.style.display = mismatch ? 'block' : 'none';
    }
    try{ updateExtraIndicators(); }catch(_){}
  }

  function addOrUpdateHorario(){
    const sel = document.getElementById('profesor-select');
    const diaSel = document.getElementById('horario-dia');
    const inicio = document.getElementById('horario-inicio');
    const fin = document.getElementById('horario-fin');
    const disp = document.getElementById('horario-disponible');
    const pid = sel?.value;
    if(!pid || !diaSel || !inicio || !fin || !disp) return;
    const payload = {
      profesor_id: Number(pid),
      dia: diaSel.value,
      inicio: inicio.value,
      fin: fin.value,
      disponible: !!disp.checked
    };
    const editId = state.profesores.horarioEditId;
    const url = editId ? `/api/profesor_horarios/${encodeURIComponent(editId)}` : '/api/profesor_horarios';
    const opts = {
      method: editId ? 'PUT' : 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    };
    fetch(url, opts)
      .then(r => r.json())
      .then(_ => {
        if (typeof showToast === 'function') showToast(editId ? 'Horario actualizado' : 'Horario creado', 'success');
        state.profesores.horarioEditId = null;
        resetHorarioForm();
        loadProfesorHorarios();
      })
      .catch(_ => {
        if (typeof showToast === 'function') showToast('Error guardando horario', 'error');
      });
  }
  function handleDeleteHorario(id){
    const sel = document.getElementById('profesor-select');
    const pid = sel?.value;
    if(!pid) return;
    const ok = confirm('¿Eliminar horario?');
    if(!ok) return;
    fetch(`/api/profesor_horarios/${encodeURIComponent(id)}`, { method: 'DELETE' })
      .then(r => r.json())
      .then(_ => {
        if (typeof showToast === 'function') showToast('Horario eliminado', 'success');
        loadProfesorHorarios();
      })
      .catch(_ => {
        if (typeof showToast === 'function') showToast('Error eliminando horario', 'error');
      });
  }

  let pendingDeleteSesionId = null;
  function openDeleteSesionModal(id){
    pendingDeleteSesionId = id;
    // Usar utilidades de modales consistentes
    try { openModal('modal-sesion-delete'); } catch(_) {
      const mb = document.getElementById('modal-sesion-delete');
      if(mb){ mb.classList.add('active'); mb.setAttribute('aria-hidden','false'); }
    }
  }
  function closeDeleteSesionModal(){
    // Usar utilidades de modales consistentes
    try { closeModal('modal-sesion-delete'); } catch(_) {
      const mb = document.getElementById('modal-sesion-delete');
      if(mb){ mb.classList.remove('active'); mb.setAttribute('aria-hidden','true'); }
    }
    pendingDeleteSesionId = null;
  }
  function handleDeleteSesion(id){
    // Fallback: abrir el modal en lugar de confirm() nativo.
    openDeleteSesionModal(id);
  }
  // Eventos del modal de eliminación de sesión
  (function(){
    const btnClose = document.getElementById('sesion-delete-close');
    const btnCancel = document.getElementById('sesion-delete-cancel');
    const btnConfirm = document.getElementById('sesion-delete-confirm');
    if(btnClose) btnClose.onclick = closeDeleteSesionModal;
    if(btnCancel) btnCancel.onclick = closeDeleteSesionModal;
    if(btnConfirm) btnConfirm.onclick = () => {
      const id = pendingDeleteSesionId;
      if(!id){ closeDeleteSesionModal(); return; }
      const sel = document.getElementById('profesor-select');
      const pid = sel?.value;
      if(!pid){ closeDeleteSesionModal(); return; }
      fetch(`/api/profesor_sesion/${encodeURIComponent(id)}`, { method: 'DELETE', headers: { 'Accept':'application/json' } })
        .then(async r => {
          const data = await r.json().catch(() => ({}));
          if(!r.ok){
            if (typeof showToast === 'function') showToast(data?.detail || data?.error || 'No se pudo eliminar la sesión', 'error');
            return;
          }
          if (typeof showToast === 'function') showToast('Sesión eliminada correctamente', 'success');
          closeDeleteSesionModal();
          await loadProfesorSesiones();
          await loadProfesorResumen();
        })
        .catch(_ => {
          if (typeof showToast === 'function') showToast('Error de red al eliminar sesión', 'error');
        });
    };
  })();

  // ====== Profesores: Datos (usuario vinculado) ======
  function getSelectedProfesorUsuarioId(){
    ensureProfesoresState();
    const sel = document.getElementById('profesor-select');
    const pid = sel?.value;
    const prof = (state.profesores.list || []).find(p => String(p.profesor_id) === String(pid));
    return prof ? prof.usuario_id : null;
  }
  async function loadProfesorDatos(){
    try{
      ensureProfesoresState();
      const uid = getSelectedProfesorUsuarioId();
      const nomEl = document.getElementById('prof-dato-nombre');
      const dniEl = document.getElementById('prof-dato-dni');
      const telEl = document.getElementById('prof-dato-telefono');
      const pinEl = document.getElementById('prof-dato-pin');
      const actEl = document.getElementById('prof-dato-activo');
      const rolLabel = document.getElementById('prof-dato-rol-label');
      if(!uid || !nomEl || !dniEl || !telEl || !pinEl || !actEl) return;
      const r = await fetch(`/api/usuarios/${encodeURIComponent(uid)}`, { headers: { 'Accept':'application/json' } });
      if(!r.ok){ if (typeof showToast === 'function') showToast('No se pudo cargar datos del profesor', 'error'); return; }
      const data = await r.json().catch(()=> ({}));
      state.profesores.currentUsuario = data || null;
      nomEl.value = String(data?.nombre || '');
      dniEl.value = String(data?.dni || '');
      telEl.value = String(data?.telefono || '');
      pinEl.value = String(data?.pin || '');
      actEl.checked = !!data?.activo;
      if(rolLabel) rolLabel.textContent = `Rol: ${String(data?.rol || 'profesor').charAt(0).toUpperCase() + String(data?.rol || 'profesor').slice(1)}`;
      // Ocultar/deshabilitar PIN si sesión es profesor y está viendo otro profesor
      try{
        const loginEl = document.getElementById('login-current');
        const role = (loginEl?.getAttribute('data-role') || '').trim();
        const loginProfId = (loginEl?.getAttribute('data-prof-id') || '').trim();
        const sel = document.getElementById('profesor-select');
        const pid = sel?.value || '';
        const isOther = role === 'profesor' && loginProfId && pid && (String(loginProfId) !== String(pid));
        if(isOther){ pinEl.value=''; pinEl.disabled = true; pinEl.placeholder = 'PIN oculto (no editable)'; }
        else { pinEl.disabled = false; pinEl.placeholder = ''; }
      }catch(_){}
    }catch(e){ console.error('Error cargando datos profesor', e); }
  }
  async function saveProfesorDatos(){
    try{
      ensureProfesoresState();
      const uid = getSelectedProfesorUsuarioId();
      if(!uid){ if (typeof showToast === 'function') showToast('Seleccione un profesor', 'error'); return; }
      const nomEl = document.getElementById('prof-dato-nombre');
      const dniEl = document.getElementById('prof-dato-dni');
      const telEl = document.getElementById('prof-dato-telefono');
      const pinEl = document.getElementById('prof-dato-pin');
      const actEl = document.getElementById('prof-dato-activo');
      if(!nomEl || !dniEl || !telEl || !pinEl || !actEl) return;
      const current = state.profesores.currentUsuario || {};
      const payload = {
        nombre: String(nomEl.value || '').trim().toUpperCase(),
        dni: String(dniEl.value || '').trim(),
        telefono: String(telEl.value || '').trim(),
        pin: (pinEl && !pinEl.disabled) ? String(pinEl.value || '').trim() : undefined,
        activo: !!actEl.checked,
        rol: 'profesor',
        tipo_cuota: current.tipo_cuota ?? null,
        notas: current.notas ?? null
      };
      if(!payload.nombre || !payload.dni){
        if (typeof showToast === 'function') showToast('Nombre y DNI son obligatorios', 'error');
        return;
      }
      const r = await fetch(`/api/usuarios/${encodeURIComponent(uid)}`, {
        method: 'PUT',
        headers: { 'Content-Type':'application/json', 'Accept':'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await r.json().catch(()=> ({}));
      if(!r.ok){
        if (typeof showToast === 'function') showToast(data?.detail || data?.error || 'No se pudo guardar', 'error');
        return;
      }
      if (typeof showToast === 'function') showToast('Datos del profesor guardados', 'success');
      await loadProfesorDatos();
      await loadProfesoresBasico();
    }catch(e){ if (typeof showToast === 'function') showToast('Error de red al guardar', 'error'); }
  }

  // ====== Profesores: Configuración lateral (usuario, salario, notas) ======
  async function loadUsuariosOptions(selectedId){
    try{
      const sel = document.getElementById('prof-config-usuario');
      if(!sel) return;
      sel.innerHTML = '<option value="">—</option>';
      const r = await fetch('/api/usuarios?limit=300');
      const list = await r.json().catch(()=> []);
      if(Array.isArray(list)){
        for(const u of list){
          const opt = document.createElement('option');
          opt.value = String(u.usuario_id);
          opt.textContent = (u.nombre && String(u.nombre).trim() !== '') ? `${String(u.nombre)}${u.dni? ' ('+u.dni+')':''}` : `Usuario ${u.usuario_id}`;
          sel.appendChild(opt);
        }
      }
      if(selectedId){ sel.value = String(selectedId); }
    }catch(_){ /* silencioso */ }
  }
  async function loadProfesorConfig(){
    try{
      const selProf = document.getElementById('profesor-select');
      const pid = selProf?.value;
      if(!pid) return;
      const r = await fetch(`/api/profesores/${encodeURIComponent(pid)}`);
      const d = await r.json().catch(()=> ({}));
      const usuarioEl = document.getElementById('prof-config-usuario');
      if(usuarioEl){
        const uid = d?.usuario_id ?? null;
        const uname = d?.usuario_nombre || '';
        const display = uid ? ((uname && uname.trim() !== '') ? `${uname} (ID ${uid})` : `Usuario ${uid}`) : '—';
        usuarioEl.value = display;
        usuarioEl.setAttribute('data-uid', uid ? String(uid) : '');
      }
      const salLabelEl = document.getElementById('prof-config-salario-label');
      const salInput = document.getElementById('prof-config-salario');
      const notasEl = document.getElementById('prof-config-notas');
      if(salLabelEl){
        let key = null;
        if(Object.prototype.hasOwnProperty.call(d, 'sueldo')){ key = 'sueldo'; }
        else if(Object.prototype.hasOwnProperty.call(d, 'salario')){ key = 'salario'; }
        else { key = 'sueldo'; }
        salLabelEl.textContent = 'Monto (ARS)';
        salLabelEl.setAttribute('data-key', String(key));
      }
      if(salInput){
        let val = null;
        if(Object.prototype.hasOwnProperty.call(d, 'tarifa_por_hora') && d.tarifa_por_hora != null){ val = d.tarifa_por_hora; }
        else if(Object.prototype.hasOwnProperty.call(d, 'sueldo')){ val = d.sueldo; }
        else if(Object.prototype.hasOwnProperty.call(d, 'salario')){ val = d.salario; }
        try {
          const num = (val !== null && val !== undefined) ? Number(String(val).replace(',', '.')) : null;
          salInput.value = (num !== null && Number.isFinite(num)) ? num.toFixed(2) : ((val !== null && val !== undefined) ? String(val) : '');
        } catch(_) {
          salInput.value = (val !== null && val !== undefined) ? String(val) : '';
        }
        const tipoMontoEl = document.getElementById('prof-monto-tipo');
        if(tipoMontoEl){
          const hasHora = Object.prototype.hasOwnProperty.call(d, 'tarifa_por_hora') && d.tarifa_por_hora != null;
          tipoMontoEl.value = hasHora ? 'hora' : 'mensual';
        }
      }
      if(notasEl){ notasEl.value = String(d?.notas || d?.usuario_notas || ''); }
      const espEl = document.getElementById('prof-config-especialidad');
      const expEl = document.getElementById('prof-config-experiencia');
      const certEl = document.getElementById('prof-config-certificaciones');
      if(espEl) espEl.value = String(d?.tipo || '');
      if(expEl) expEl.value = (d?.experiencia_años != null) ? String(d.experiencia_años) : '';
      if(certEl) certEl.value = String(d?.certificaciones || '');
    }catch(_){ /* silencioso */ }
  }
  async function saveProfesorConfig(){
    try{
      const selProf = document.getElementById('profesor-select');
      const pid = selProf?.value;
      if(!pid){ if (typeof showToast === 'function') showToast('Seleccione un profesor', 'error'); return; }
      const salLabelEl = document.getElementById('prof-config-salario-label');
      const salInput = document.getElementById('prof-config-salario');
      const notasEl = document.getElementById('prof-config-notas');
      const espEl = document.getElementById('prof-config-especialidad');
      const expEl = document.getElementById('prof-config-experiencia');
      const certEl = document.getElementById('prof-config-certificaciones');
      const payload = {};
      const key = salLabelEl ? (salLabelEl.getAttribute('data-key') || 'sueldo') : 'sueldo';
      const salVal = salInput ? String(salInput.value || '').trim() : '';
      const expVal = expEl ? String(expEl.value || '').trim() : '';

      const errors = [];
      const salNum = salVal !== '' ? Number(salVal.replace(',', '.')) : null;
      if(salVal !== '' && (!Number.isFinite(salNum) || salNum < 0)) errors.push('El monto debe ser un número ≥ 0');
      const expNum = expVal !== '' ? Number(expVal) : null;
      if(expVal !== '' && (!Number.isFinite(expNum) || expNum < 0 || Math.floor(expNum) !== expNum)) errors.push('Experiencia (años) debe ser un entero ≥ 0');
      if(errors.length){ if (typeof showToast === 'function') showToast(errors[0], 'error'); else alert(errors[0]); return; }

      const tipoMontoEl = document.getElementById('prof-monto-tipo');
      const tipoMonto = tipoMontoEl ? String(tipoMontoEl.value || 'mensual') : 'mensual';
      if(tipoMonto === 'hora'){
        payload['tarifa_por_hora'] = salVal !== '' ? salNum : null;
        payload['sueldo'] = null;
      } else {
        payload['sueldo'] = salVal !== '' ? salNum : null;
        payload['tarifa_por_hora'] = null;
      }
      payload['notas'] = notasEl ? String(notasEl.value || '') : '';
      payload['tipo'] = espEl ? String(espEl.value || '').trim() : '';
      payload['experiencia_años'] = expVal !== '' ? expNum : null;
      payload['certificaciones'] = certEl ? String(certEl.value || '') : '';
      const usuarioEl = document.getElementById('prof-config-usuario');
      const usuarioId = usuarioEl ? Number(usuarioEl.getAttribute('data-uid') || '') || null : null;
      payload['usuario_id'] = usuarioId;

      const r = await fetch(`/api/profesores/${encodeURIComponent(pid)}`, {
        method: 'PUT',
        headers: { 'Content-Type':'application/json', 'Accept':'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await r.json().catch(()=> ({}));
      if(!r.ok){ if (typeof showToast === 'function') showToast(data?.detail || data?.error || 'No se pudo guardar', 'error'); return; }
      if (typeof showToast === 'function') showToast('Configuración del profesor guardada', 'success');
      await loadProfesoresBasico();
      await loadProfesorDatos();
    }catch(_){ if (typeof showToast === 'function') showToast('Error al guardar configuración', 'error'); }
  }

  // ====== Profesores: Helpers y cargadores de Resumen/Sesiones ======
  function toISODate(d){ return fmtDate(d); }
  function extractTime(val){
    if(val === null || val === undefined) return '—';
    const s = String(val);
    const m = s.match(/(\d{2}:\d{2})/);
    if(m) return m[1];
    try {
      const dt = new Date(s);
      if(!isNaN(dt.getTime())){
        const hh = String(dt.getHours()).padStart(2,'0');
        const mm = String(dt.getMinutes()).padStart(2,'0');
        return `${hh}:${mm}`;
      }
    } catch(_){}
    return s.slice(0,5);
  }
  function getWeekRange(baseDate, startOn){
    const d = new Date(baseDate);
    if(isNaN(d.getTime())) return null;
    const v = String(startOn || 'mon').toLowerCase();
    const startMonday = (v === 'mon' || v === 'lunes' || v === 'monday');
    const day = d.getDay(); // 0=Domingo, 1=Lunes, ...
    const diff = startMonday ? (day === 0 ? -6 : (1 - day)) : -day;
    const start = new Date(d);
    start.setDate(d.getDate() + diff);
    const end = new Date(start);
    end.setDate(start.getDate() + 6);
    return { start: fmtDate(start), end: fmtDate(end), label: `${fmtDate(start)} — ${fmtDate(end)}` };
  }
  function getMonthRange(date){
    const d = date ? new Date(date) : new Date();
    const start = new Date(d.getFullYear(), d.getMonth(), 1);
    const end = new Date(d.getFullYear(), d.getMonth()+1, 0);
    return { start: fmtDate(start), end: fmtDate(end) };
  }
  function updateResumenCards(prefix, res){
    const set = (id, val) => {
      const el = document.getElementById(id);
      if(el){
        const n = Number(val);
        el.textContent = Number.isFinite(n) ? (Math.round(n*100)/100).toFixed(2) : '0.00';
      }
    };
    const hTrab = res?.horas_trabajadas ?? 0;
    const hProj = res?.horas_proyectadas ?? 0;
    const hExt = res?.horas_extras ?? 0;
    const hExtDisplay = Math.max(0, Number(hExt) || 0);
    set(`${prefix}-horas-trabajadas`, hTrab);
    set(`${prefix}-horas-proyectadas`, hProj);
    set(`${prefix}-horas-extra`, hExtDisplay);
    // Nuevo: Horas totales = trabajadas + extras
    set(`${prefix}-horas-totales`, Number(hTrab) + Number(hExtDisplay));
  }
  async function loadProfesorResumen(){
    try {
      ensureProfesoresState();
      const sel = document.getElementById('profesor-select');
      const pid = sel?.value;
      if(!pid) return;
      // Mensual: mes actual
      const { start: ms, end: me } = getMonthRange();
      try {
        const qsM = new URLSearchParams({ profesor_id: String(pid), start: ms, end: me });
        const rM = await fetch('/api/profesor_resumen?' + qsM.toString());
        const resM = await rM.json().catch(() => ({}));
        // Recalcular cobertura (en horario) y extras desde sesiones en el mismo rango
        let extrasMinM = 0;
        let coveredMinM = 0;
        try{
          const rSM = await fetch('/api/profesor_sesiones?' + qsM.toString());
          const dataSM = await rSM.json().catch(() => ([]));
          const arrSM = Array.isArray(dataSM) ? dataSM : (Array.isArray(dataSM?.items) ? dataSM.items : []);
          for(const ses of arrSM){
            const fecha = (ses.fecha ?? ses.Fecha ?? ses.fecha_sesion ?? ses.fecha_numerica ?? ses.fecha_num ?? ses.date ?? ses.dia ?? ses.FechaSesion ?? '');
            const inicioText = extractTime(ses.inicio ?? ses.hora_inicio ?? ses.Inicio ?? ses.entrada ?? ses.HoraInicio ?? ses.start_time ?? ses.horaEntrada ?? '');
            const finText = extractTime(ses.fin ?? ses.hora_fin ?? ses.Fin ?? ses.salida ?? ses.HoraFin ?? ses.end_time ?? ses.horaSalida ?? '');
            const cov = computeCoverageExtra(String(fecha).slice(0,10), inicioText, finText);
            if(cov){
              extrasMinM += Math.max(0, cov.extraMin || 0);
              coveredMinM += Math.max(0, cov.coveredMin || 0);
            }
          }
        }catch(_){ /* mantener backend si falla */ }
        const resM2 = Object.assign({}, resM || {}, { horas_trabajadas: (coveredMinM/60), horas_extras: (extrasMinM/60) });
        updateResumenCards('prof-m', resM2);
      } catch(_) { updateResumenCards('prof-m', {}); }
      // Semanal: basado en fecha y comienzo de semana
      const weekDate = document.getElementById('prof-week-date');
      const weekStart = document.getElementById('prof-week-start');
      const base = weekDate?.value || toISODate(new Date());
      const mode = (weekStart?.value || 'mon');
      const range = getWeekRange(base, mode);
      const rangeEl = document.getElementById('prof-week-range');
      if(rangeEl && range) rangeEl.textContent = range.label; else if(rangeEl) rangeEl.textContent = '—';
      if(range){
        try {
          const qsW = new URLSearchParams({ profesor_id: String(pid), start: range.start, end: range.end });
          const rW = await fetch('/api/profesor_resumen?' + qsW.toString());
          const resW = await rW.json().catch(() => ({}));
          let extrasMinW = 0;
          let coveredMinW = 0;
          try{
            const rSW = await fetch('/api/profesor_sesiones?' + qsW.toString());
            const dataSW = await rSW.json().catch(() => ([]));
            const arrSW = Array.isArray(dataSW) ? dataSW : (Array.isArray(dataSW?.items) ? dataSW.items : []);
            for(const ses of arrSW){
              const fecha = (ses.fecha ?? ses.Fecha ?? ses.fecha_sesion ?? ses.fecha_numerica ?? ses.fecha_num ?? ses.date ?? ses.dia ?? ses.FechaSesion ?? '');
              const inicioText = extractTime(ses.inicio ?? ses.hora_inicio ?? ses.Inicio ?? ses.entrada ?? ses.HoraInicio ?? ses.start_time ?? ses.horaEntrada ?? '');
              const finText = extractTime(ses.fin ?? ses.hora_fin ?? ses.Fin ?? ses.salida ?? ses.HoraFin ?? ses.end_time ?? ses.horaSalida ?? '');
              const cov = computeCoverageExtra(String(fecha).slice(0,10), inicioText, finText);
              if(cov){
                extrasMinW += Math.max(0, cov.extraMin || 0);
                coveredMinW += Math.max(0, cov.coveredMin || 0);
              }
            }
          }catch(_){ }
          const resW2 = Object.assign({}, resW || {}, { horas_trabajadas: (coveredMinW/60), horas_extras: (extrasMinW/60) });
          updateResumenCards('prof-w', resW2);
        } catch(_) { updateResumenCards('prof-w', {}); }
      } else {
        updateResumenCards('prof-w', {});
      }
    } catch(e){ console.error('Error cargando resumen profesor', e); }
  }
  async function loadProfesorSesiones(){
    try {
      const sel = document.getElementById('profesor-select');
      const pid = sel?.value;
      if(!pid) return;
      const s = document.getElementById('prof-ses-start')?.value || null;
      const e = document.getElementById('prof-ses-end')?.value || null;
      const qs = new URLSearchParams();
      qs.set('profesor_id', String(pid));
      if(s) qs.set('start', s);
      if(e) qs.set('end', e);
      const tbody = document.querySelector('#prof-sesiones-table tbody');
      if(tbody) tbody.innerHTML = `<tr><td colspan="7" class="empty">Cargando…</td></tr>`;
      const r = await fetch('/api/profesor_sesiones?' + qs.toString());
      if(!r.ok){
        let msg = `Error ${r.status}`;
        try { const err = await r.json(); msg = err?.detail || err?.error || msg; } catch(_){ }
        if(tbody) tbody.innerHTML = `<tr><td colspan="7" class="empty">${msg}</td></tr>`;
        return;
      }
      const data = await r.json();
      const arr = Array.isArray(data) ? data : (Array.isArray(data?.items) ? data.items : []);
      if(arr.length === 0){
        if(s || e){ if(tbody) tbody.innerHTML = `<tr><td colspan="7" class="empty">Sin datos en el rango</td></tr>`; return; }
        try {
          const qs2 = new URLSearchParams(); qs2.set('profesor_id', String(pid));
          const r2 = await fetch('/api/profesor_sesiones?' + qs2.toString());
          if(!r2.ok){ if(tbody) tbody.innerHTML = `<tr><td colspan="7" class="empty">Sin datos</td></tr>`; return; }
          const data2 = await r2.json();
          const arr2 = Array.isArray(data2) ? data2 : (Array.isArray(data2?.items) ? data2.items : []);
          if(arr2.length === 0){ if(tbody) tbody.innerHTML = `<tr><td colspan="7" class="empty">Sin datos</td></tr>`; return; }
          arr.push(...arr2);
        } catch(_){ if(tbody) tbody.innerHTML = `<tr><td colspan="7" class="empty">Sin datos</td></tr>`; return; }
      }
      if(tbody) tbody.innerHTML = '';
      ensureProfesoresState();
      state.profesores.sesiones = arr;
      arr.forEach(ses => {
        const fecha = (ses.fecha ?? ses.Fecha ?? ses.fecha_sesion ?? ses.fecha_numerica ?? ses.fecha_num ?? ses.date ?? ses.dia ?? ses.FechaSesion ?? '');
        const inicioRaw = (ses.inicio ?? ses.hora_inicio ?? ses.Inicio ?? ses.entrada ?? ses.HoraInicio ?? ses.start_time ?? ses.horaEntrada ?? '');
        const finRaw = (ses.fin ?? ses.hora_fin ?? ses.Fin ?? ses.salida ?? ses.HoraFin ?? ses.end_time ?? ses.horaSalida ?? '');
        const minutosVal = (ses.minutos ?? ses.minutos_totales ?? ses.Minutos ?? ses.duracion_min ?? ses.duracion ?? ses.mins ?? ses.minutos_trabajados ?? ses.minutes ?? 0);
        const horasVal = (ses.horas ?? ses.horas_totales ?? ses.Horas ?? ses.horas_trabajadas ?? ses.duracion_horas ?? ses.duration_hours ?? null);
        const tipoVal = (ses.tipo ?? ses.tipo_actividad ?? ses.Tipo ?? ses.actividad ?? ses.category ?? '');
        const tr = document.createElement('tr');
        const inicioText = extractTime(inicioRaw);
        const finText0 = extractTime(finRaw);
        const parseMin = (t) => {
          if(!t || t === '—') return null;
          try {
            const [hh, mm] = String(t).split(':');
            const h = parseInt(hh, 10); const m = parseInt(mm, 10);
            if(Number.isFinite(h) && Number.isFinite(m)) return h*60 + m;
          } catch(_){ }
          return null;
        };
        const approxEq = (a, b, tol=3) => (typeof a === 'number' && typeof b === 'number') ? Math.abs(a-b) <= tol : false;
        const sMin = parseMin(inicioText);
        const fMin = parseMin(finText0);
        const minutosNum = Number(minutosVal || 0);
        // Estrategia: calcular cruce de medianoche a partir de minutos reales desde hora de inicio
        const crossesByMinutes = (sMin !== null && Number.isFinite(minutosNum)) ? ((sMin + minutosNum) >= 1440) : false;
        // Respaldo: comparar fin<inicio y que los minutos coincidan con cruce (tolerancia)
        const expectedMinTimes = (sMin !== null && fMin !== null) ? (fMin - sMin + 1440) : null;
        const crossesByTimes = (sMin !== null && fMin !== null && fMin < sMin) && (expectedMinTimes !== null) && approxEq(minutosNum, expectedMinTimes, 3);
        const crossesMidnight = crossesByMinutes || crossesByTimes;
        const finText = crossesMidnight ? `${finText0} <span title="Termina después de medianoche">(+1d)</span>` : finText0;
        // Calcular chip y determinar texto de tipo enriquecido
        let extraBadge = '';
        let covResult = null;
        try{
          covResult = computeCoverageExtra(String(fecha).slice(0,10), inicioText, finText0);
          if(covResult){
            const extMin = covResult.extraMin;
            if(extMin > 0){
              const h = (extMin/60).toFixed(2);
              extraBadge = `<span class="chip sm danger" title="Tiempo fuera de horario" style="margin-left:6px">${h} h extra</span>`;
            } else {
              extraBadge = `<span class="chip sm success" title="Completamente en horario" style="margin-left:6px">En horario</span>`;
            }
          }
        }catch(_){ }
        const sanitizeTipo = (s) => {
          const x = String(s || '').trim();
          if(!x) return '';
          // Colapsar duplicados "Horas extra - Horas extra"
          let y = x.replace(/\s*-\s*Horas extra\s*-\s*Horas extra/gi, ' - Horas extra');
          if(/^Horas extra\s*-\s*Horas extra$/i.test(y)) y = 'Horas extra';
          return y.replace(/\s{2,}/g, ' ');
        };
        let tipoDisplay = '';
        if(covResult){
          if(covResult.coveredMin > 0 && covResult.extraMin > 0){
            // Forzar clasificación compuesta independientemente del tipo backend
            tipoDisplay = 'Trabajo - Extra';
          } else if(covResult.extraMin === 0 && covResult.coveredMin > 0){
            tipoDisplay = 'Trabajo';
          } else if(covResult.coveredMin === 0 && covResult.extraMin > 0){
            tipoDisplay = 'Horas extra';
          } else {
            tipoDisplay = sanitizeTipo(tipoVal);
          }
        } else {
          tipoDisplay = sanitizeTipo(tipoVal);
        }
        const idVal = (ses.id ?? ses.sesion_id ?? ses.id_sesion ?? ses.SesionID ?? '');
        tr.innerHTML = `
          <td>${String(fecha).slice(0,10)}</td>
          <td>${inicioText}</td>
          <td>${finText}</td>
          <td>${Number(minutosVal ?? 0)}</td>
          <td>${(horasVal!==undefined && horasVal!==null)?Number(horasVal).toFixed(2):'—'}</td>
          <td>${tipoDisplay} ${extraBadge}</td>
          <td>
            <button class="btn tiny" data-action="edit-sesion" data-id="${idVal}">Editar</button>
            <button class="btn tiny danger" data-action="delete-sesion" data-id="${idVal}">Eliminar</button>
          </td>
        `;
        tbody?.appendChild(tr);
        const b = tr.querySelector('button[data-action="edit-sesion"]');
        if(b){ b.onclick = () => { const sid = b.getAttribute('data-id') || ''; if(sid) openSesionEdit(sid); }; }
        const bd = tr.querySelector('button[data-action="delete-sesion"]');
        if(bd){ bd.onclick = () => { const sid = bd.getAttribute('data-id') || ''; if(sid) openDeleteSesionModal(sid); }; }
      });
    } catch(e){ console.error('Error cargando sesiones profesor', e); }
  }
  function bindProfesoresSubtabsEvents(){
    const cont = document.getElementById('prof-subtabs');
    const contR = document.getElementById('prof-tab-resumen');
    const contH = document.getElementById('prof-tab-horarios');
    const contS = document.getElementById('prof-tab-sesiones');
    const buttons = cont ? Array.from(cont.querySelectorAll('button[data-subtab]')) : [];
    function setActive(which){
      ensureProfesoresState();
      state.profesores.activeSubtab = which;
      buttons.forEach(b => { if(b){ b.classList.toggle('active', b.getAttribute('data-subtab') === which); } });
      if(contR) contR.style.display = which==='resumen' ? '' : 'none';
      if(contH) contH.style.display = which==='horarios' ? '' : 'none';
      if(contS) contS.style.display = which==='sesiones' ? '' : 'none';
      const sel = document.getElementById('profesor-select'); const pid = sel?.value;
      if(!pid) return;
      if(which==='resumen') loadProfesorResumen();
      else if(which==='sesiones') loadProfesorSesiones();
    }
    buttons.forEach(b => { b.onclick = () => setActive(b.getAttribute('data-subtab') || 'resumen'); });
    ensureProfesoresState();
    const initial = state.profesores.activeSubtab || 'resumen';
    setActive(initial);
  }
  function updateTopBarDurationText(text){
    const el = document.getElementById('login-current');
    if(!el) return;
    const base = el.getAttribute('data-base') || el.innerHTML || '';
    el.innerHTML = text ? (base + ' • ' + text) : base;
  }
  function updateTopBarDurationHMS(h, m, s){
    const el = document.getElementById('login-current');
    if(!el) return;
    const base = el.getAttribute('data-base') || el.textContent || '';
    const prev = el.getAttribute('data-prev') || '';
    const currentText = `${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    const needFlip = !!(prev && prev !== currentText);
    el.innerHTML = `${base} • <span class="duration-timer" aria-label="Duración ${h} horas ${m} minutos ${s} segundos"><span class="duration-group"><span class="duration-digit ${needFlip ? 'flip':''}" data-part="h">${h}</span><span class="duration-sep">:</span><span class="duration-digit ${needFlip ? 'flip':''}" data-part="m">${String(m).padStart(2,'0')}</span><span class="duration-sep">:</span><span class="duration-digit ${needFlip ? 'flip':''}" data-part="s">${String(s).padStart(2,'0')}</span></span></span>`;
    el.setAttribute('data-prev', currentText);
  }
  function composeTopBarBase(){
    const el = document.getElementById('login-current');
    if(!el) return;
    const name = el.getAttribute('data-name') || '';
    const status = el.getAttribute('data-status') || '';
    const isActive = el.classList.contains('active');
    const stateCls = isActive ? 'active' : 'inactive';
    const base = `${name ? `<span class=\"session-chip\">${name}</span>` : ''}${status ? `${name ? ' • ' : ''}<span class=\"session-state ${stateCls}\">${status}</span>` : ''}` || (el.textContent || '');
    el.setAttribute('data-base', base);
    el.innerHTML = base;
  }
  // Tick de segundos y renderizado H:MM:SS animado
  function startSesionSecondTick(){
    ensureProfesoresState();
    if(state.profesores.sesionTickId){ clearInterval(state.profesores.sesionTickId); state.profesores.sesionTickId = null; }
    state.profesores.sesionTickId = setInterval(() => { try{ updateLocalDurationTick(); }catch(_){ } }, 1000);
  }
  function stopSesionSecondTick(){
    ensureProfesoresState();
    if(state.profesores.sesionTickId){ clearInterval(state.profesores.sesionTickId); state.profesores.sesionTickId = null; }
  }
  function renderDurationHMS(totalSeconds, pidSel, role, loginProfId){
    const durSpan = document.getElementById('sesion-duracion');
    if(!durSpan) return;
    durSpan.setAttribute('aria-live','polite');
    if(!totalSeconds || totalSeconds < 0){ durSpan.textContent = '—'; return; }
    const h = Math.floor(totalSeconds / 3600);
    const m = Math.floor((totalSeconds % 3600) / 60);
    const s = Math.floor(totalSeconds % 60);
    const prev = durSpan.getAttribute('data-prev') || '';
    const currentText = `${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    const needFlip = !!(prev && prev !== currentText);
    const html = `<span class="duration-timer" aria-label="Duración ${h} horas ${m} minutos ${s} segundos">
      <span class="duration-group">
        <span class="duration-digit ${needFlip ? 'flip':''}" data-part="h">${h}</span><span class="duration-sep">:</span>
        <span class="duration-digit ${needFlip ? 'flip':''}" data-part="m">${String(m).padStart(2,'0')}</span><span class="duration-sep">:</span>
        <span class="duration-digit ${needFlip ? 'flip':''}" data-part="s">${String(s).padStart(2,'0')}</span>
      </span>
    </span>`;
    durSpan.innerHTML = html;
    durSpan.setAttribute('data-prev', currentText);
    // Actualiza la barra superior para profesores y también para dueño si hay profesor seleccionado
    const shouldUpdateTopBar = (
      (role === 'profesor' && loginProfId && String(loginProfId) === String(pidSel || loginProfId)) ||
      (role !== 'profesor' && !!pidSel)
    );
    if(shouldUpdateTopBar){
      updateTopBarDurationHMS(h, m, s);
    }
  }
  function renderDurationHMSTo(elementId, totalSeconds){
    const el = document.getElementById(elementId);
    if(!el) return;
    el.setAttribute('aria-live','polite');
    if(!totalSeconds || totalSeconds < 0){ el.textContent = '—'; return; }
    const h = Math.floor(totalSeconds / 3600);
    const m = Math.floor((totalSeconds % 3600) / 60);
    const s = Math.floor(totalSeconds % 60);
    const prev = el.getAttribute('data-prev') || '';
    const currentText = `${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    const needFlip = !!(prev && prev !== currentText);
    const html = `<span class="duration-timer" aria-label="Duración ${h} horas ${m} minutos ${s} segundos"><span class="duration-group"><span class="duration-digit ${needFlip ? 'flip':''}" data-part="h">${h}</span><span class="duration-sep">:</span><span class="duration-digit ${needFlip ? 'flip':''}" data-part="m">${String(m).padStart(2,'0')}</span><span class="duration-sep">:</span><span class="duration-digit ${needFlip ? 'flip':''}" data-part="s">${String(s).padStart(2,'0')}</span></span></span>`;
    el.innerHTML = html;
    el.setAttribute('data-prev', currentText);
  }
  function updateLocalDurationTick(){
    ensureProfesoresState();
    if(!state.profesores || !state.profesores.sesionActive){ return; }
    const roleEl = document.getElementById('login-current');
    const role = roleEl ? (roleEl.getAttribute('data-role') || '') : '';
    const loginProfId = roleEl ? (roleEl.getAttribute('data-prof-id') || '') : '';
    const sel = document.getElementById('profesor-select');
    const pidSel = sel?.value;
    const baseSec = Math.floor((state.profesores.lastDurationMin || 0) * 60);
    const deltaSec = Math.floor(((Date.now() - (state.profesores.lastDurationAt || Date.now())) / 1000));
    const totalSec = baseSec + Math.max(0, deltaSec);
    renderDurationHMS(totalSec, pidSel, role, loginProfId);
  }
  function setupSesionTimer(active){
    ensureProfesoresState();
    const roleEl = document.getElementById('login-current');
    const role = roleEl ? (roleEl.getAttribute('data-role') || '') : '';
    if(state.profesores.sesionTimerId){ clearInterval(state.profesores.sesionTimerId); state.profesores.sesionTimerId = null; }
    if(active){
      state.profesores.sesionActive = true;
      startSesionSecondTick();
      state.profesores.sesionTimerId = setInterval(() => { try{ refreshSesionDuration(true); }catch(_){} }, 15000);
      try{ refreshSesionDuration(true); }catch(_){ }
    } else {
      state.profesores.sesionActive = false;
      stopSesionSecondTick();
    }
  }
  // Refresca la sesión del profesor de login para la barra superior
  function refreshTopBarSesion(){
    try{
      const roleEl = document.getElementById('login-current');
      const role = roleEl ? (roleEl.getAttribute('data-role') || '') : '';
      const loginProfId = roleEl ? (roleEl.getAttribute('data-prof-id') || '') : '';
      const sel = document.getElementById('profesor-select');
      const pidSel = sel?.value || '';
      const isOwnerView = (role !== 'profesor');
      const profId = isOwnerView ? (pidSel || '') : (loginProfId || '');
      if(isOwnerView && !profId){
        setupSesionTimer(false);
        const el = document.getElementById('login-current');
        if(el){
          el.setAttribute('data-status', 'Sesión: —');
          el.classList.add('session-indicator');
          el.classList.remove('active');
          el.classList.add('inactive');
          composeTopBarBase();
        }
        return;
      }
      const urlActiva = profId ? `/api/profesor_sesion_activa?profesor_id=${encodeURIComponent(profId)}` : `/api/profesor_sesion_activa`;
      fetch(urlActiva)
        .then(r => r.json().catch(() => ({})))
        .then(d => {
          const active = !!d?.activa;
          const tipo = d?.tipo_actividad || 'Trabajo';
          const texto = active ? `Sesión: Activa (${tipo})` : 'Sesión: Inactiva';
          const el = document.getElementById('login-current');
          if(el){
            el.classList.remove('muted');
            el.classList.add('session-indicator');
            el.classList.toggle('active', active);
            el.classList.toggle('inactive', !active);
            el.setAttribute('data-status', texto);
            composeTopBarBase();
          }
          setupSesionTimer(active);
          refreshSesionDuration(active);
        })
        .catch(_ => {
          setupSesionTimer(false);
          const el = document.getElementById('login-current');
          if(el){
            el.setAttribute('data-status', 'Sesión: —');
            el.classList.add('session-indicator');
            el.classList.remove('active');
            el.classList.add('inactive');
            composeTopBarBase();
          }
        });
    }catch(_){ /* silencioso */ }
  }
  async function populateSesionFinModal(){
    try{
      const roleEl = document.getElementById('login-current');
      const role = roleEl ? (roleEl.getAttribute('data-role') || '').trim() : '';
      const loginProfId = roleEl ? (roleEl.getAttribute('data-prof-id') || '').trim() : '';
      const tipoEl = document.getElementById('modal-sesion-fin-tipo');
      const durElId = 'modal-sesion-fin-duracion';
      if(role !== 'profesor'){
        if(tipoEl) tipoEl.textContent = '—';
        const el = document.getElementById(durElId); if(el) el.textContent = '—';
        return;
      }
      let tipo = 'Trabajo';
      let activa = false;
      try{
        const urlActiva = loginProfId ? `/api/profesor_sesion_activa?profesor_id=${encodeURIComponent(loginProfId)}` : `/api/profesor_sesion_activa`;
        const r = await fetch(urlActiva, { headers:{ 'Accept':'application/json' } });
        const d = await r.json().catch(() => ({}));
        activa = !!d?.activa; tipo = d?.tipo_actividad || 'Trabajo';
      }catch(_){}
      if(tipoEl){
        const t = String(tipo || '').toLowerCase();
        const label = activa ? (t.includes('extra') ? 'Horas extra' : (t.includes('horario') ? 'En horario' : (tipo || 'Trabajo'))) : 'Inactiva';
        tipoEl.textContent = label;
        // Estilo dinámico de chip según el tipo
        try{
          tipoEl.style.display = 'inline-block';
          tipoEl.style.padding = '6px 10px';
          tipoEl.style.borderRadius = '999px';
          tipoEl.style.border = '1px solid';
          if(label === 'En horario'){
            tipoEl.style.backgroundColor = 'var(--primary)';
            tipoEl.style.color = '#fff';
            tipoEl.style.borderColor = 'rgba(76,63,118,.5)';
          } else if(label === 'Horas extra'){
            tipoEl.style.backgroundColor = '#fde7ea';
            tipoEl.style.color = '#842029';
            tipoEl.style.borderColor = '#f5c2c7';
          } else {
            tipoEl.style.backgroundColor = '#eef2f7';
            tipoEl.style.color = '#374151';
            tipoEl.style.borderColor = 'var(--border)';
          }
        }catch(_){ /* silencioso */ }
      }
      let min = 0;
      try{
        const urlDur = loginProfId ? `/api/profesor_sesion_duracion?profesor_id=${encodeURIComponent(loginProfId)}` : `/api/profesor_sesion_duracion`;
        const r2 = await fetch(urlDur, { headers:{ 'Accept':'application/json' } });
        const d2 = await r2.json().catch(() => ({}));
        min = Number(d2?.minutos || 0);
      }catch(_){}
      const totalSec = Math.floor(min * 60);
      try{ renderDurationHMSTo(durElId, totalSec); }catch(_){}
    }catch(_){}
  }
  function refreshSesion(){
    const estadoSpan = document.getElementById('sesion-estado');
    const topEstado = document.getElementById('prof-sesion-estado');
    const sel = document.getElementById('profesor-select');
    const pid = sel?.value;
    if(!pid){
      if(estadoSpan) estadoSpan.textContent = '—';
      if(topEstado){ topEstado.textContent = 'Sesión: —'; topEstado.classList.add('session-indicator'); topEstado.classList.remove('active'); topEstado.classList.add('inactive'); }
      setupSesionTimer(false);
      updateTopBarDurationText('');
      return;
    }
    fetch(`/api/profesor_sesion_activa?profesor_id=${encodeURIComponent(pid)}`)
      .then(r => r.json().catch(() => ({})))
      .then(d => {
        const active = !!d?.activa;
        const tipo = d?.tipo_actividad || 'Trabajo';
        const texto = active ? `Activa (${tipo})` : 'Inactiva';
        if(estadoSpan) estadoSpan.textContent = texto;
        if(topEstado){ topEstado.textContent = `Sesión: ${texto}`; topEstado.classList.add('session-indicator'); topEstado.classList.toggle('active', active); topEstado.classList.toggle('inactive', !active); }
        setupSesionTimer(active);
        refreshSesionDuration(active);
      })
      .catch(_ => {
        if(estadoSpan) estadoSpan.textContent = '—';
        if(topEstado){ topEstado.textContent = 'Sesión: —'; topEstado.classList.add('session-indicator'); topEstado.classList.remove('active'); topEstado.classList.add('inactive'); }
        setupSesionTimer(false);
        updateTopBarDurationText('');
      });
  }
  function refreshSesionDuration(onlyIfActive){
    const durSpan = document.getElementById('sesion-duracion');
    const sel = document.getElementById('profesor-select');
    const pidSel = sel?.value;
    const roleEl = document.getElementById('login-current');
    const loginProfId = roleEl ? (roleEl.getAttribute('data-prof-id') || '') : '';
    const role = roleEl ? (roleEl.getAttribute('data-role') || '') : '';
    const pid = pidSel || loginProfId;
    if(onlyIfActive === false){
      if(durSpan) durSpan.textContent = '—';
      updateTopBarDurationText('');
      ensureProfesoresState(); state.profesores.sesionActive = false; stopSesionSecondTick();
      return;
    }
    const urlDur = pid ? `/api/profesor_sesion_duracion?profesor_id=${encodeURIComponent(pid)}` : (role === 'profesor' ? '/api/profesor_sesion_duracion' : '');
    if(!urlDur){
      if(durSpan) durSpan.textContent = '—';
      updateTopBarDurationText('');
      ensureProfesoresState(); state.profesores.sesionActive = false; stopSesionSecondTick();
      return;
    }
    fetch(urlDur)
      .then(r => r.json().catch(() => ({})))
      .then(d => {
        const min = Number(d?.minutos || 0);
        ensureProfesoresState();
        const now = Date.now();
        const prevMin = Number(state.profesores.lastDurationMin || 0);
        const hadActive = !!state.profesores.sesionActive;
        state.profesores.sesionActive = true;
        // Reglas de sincronización:
        // - Si no estaba activa o el servidor reporta 0-1 min, alinear y reiniciar.
        // - Si el servidor avanza minutos, actualizar base y reiniciar delta.
        // - Si el servidor reduce minutos de forma notable (sesión reiniciada), aceptar reset.
        const shouldHardReset = (!hadActive) || (prevMin > 0 && min < prevMin && (prevMin - min) >= 1);
        if(shouldHardReset){
          state.profesores.lastDurationMin = min;
          state.profesores.lastDurationAt = now;
          const baseSec = Math.floor(min * 60);
          renderDurationHMS(baseSec, pidSel, role, loginProfId);
        } else {
          if(min > prevMin){
            state.profesores.lastDurationMin = min;
            state.profesores.lastDurationAt = now;
          } else {
            // No disminuir minutos; mantener el progreso local.
            state.profesores.lastDurationMin = Math.max(prevMin, min);
          }
          // Renderizar usando el tick local para preservar los segundos.
          updateLocalDurationTick();
        }
      })
      .catch(_ => {
        if(durSpan) durSpan.textContent = '—';
        updateTopBarDurationText('');
        ensureProfesoresState(); state.profesores.sesionActive = false; stopSesionSecondTick();
      });
  }
  function startSesion(){
    try{
      const sel = document.getElementById('profesor-select');
      const pid = sel?.value;
      if(!pid){ if (typeof showToast==='function') showToast('Seleccione un profesor', 'warning'); return; }
      fetch('/api/profesor_sesion_inicio', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ profesor_id: pid, tipo: 'Trabajo' })
      })
      .then(r => r.json())
      .then(d => {
        if(d && d.success !== false && !d.error){
          if (typeof showToast==='function') showToast('Sesión iniciada', 'success');
          // Reset local inmediato para empezar en 0 segundos
          ensureProfesoresState();
          state.profesores.sesionActive = true;
          state.profesores.lastDurationMin = 0;
          state.profesores.lastDurationAt = Date.now();
          startSesionSecondTick();
          refreshSesion();
          loadProfesorResumen();
        } else {
          if (typeof showToast==='function') showToast('No se pudo iniciar la sesión', 'error');
        }
      })
      .catch(_ => { if (typeof showToast==='function') showToast('Error iniciando la sesión', 'error'); });
    }catch(_){}
  }
  function endSesion(){
    try{
      const sel = document.getElementById('profesor-select');
      const pid = sel?.value;
      if(!pid){ if (typeof showToast==='function') showToast('Seleccione un profesor', 'warning'); return; }
      fetch('/api/profesor_sesion_fin', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ profesor_id: pid })
      })
      .then(r => r.json())
      .then(d => {
        if(d && d.success){
          if (typeof showToast==='function') showToast('Sesión finalizada', 'success');
        } else {
          if (typeof showToast==='function') showToast('No se pudo finalizar la sesión', 'error');
        }
        refreshSesion();
        loadProfesorResumen();
      })
      .catch(_ => { if (typeof showToast==='function') showToast('Error finalizando la sesión', 'error'); });
    }catch(_){}
  }

  // --- Numeración de recibos (UI + API) ---
  async function updateReciboNextNumber(){
    try{
      const el = document.getElementById('recibo-next');
      if(!el) return;
      el.textContent = 'Recibo #…';
      const r = await fetch('/api/recibos/numero-proximo', { headers: { 'Accept': 'application/json' } });
      if(r.ok){
        let j = null; try{ j = await r.json(); }catch(_){}
        const num = (j && (j.numero || j.next || j.number)) ? (j.numero || j.next || j.number) : null;
        if(num){ el.textContent = `Recibo #${num}`; }
        else { el.textContent = 'Recibo #—'; }
      } else {
        el.textContent = 'Recibo #—';
      }
    }catch(_){
      const el = document.getElementById('recibo-next');
      if(el) el.textContent = 'Recibo #—';
    }
  }

  function _padLeft(n, len){ try{ const s = String(n||''); return s.length>=len ? s : ('0'.repeat(Math.max(0, len-s.length))+s); }catch(_){ return String(n||''); } }
  function computeReciboPreview(){
    try{
      const prefijo = document.getElementById('recibo-prefijo')?.value || 'REC';
      const sep = document.getElementById('recibo-separador')?.value || '-';
      const n0 = parseInt(document.getElementById('recibo-numero-inicial')?.value || '1', 10) || 1;
      const llen = parseInt(document.getElementById('recibo-longitud-numero')?.value || '6', 10) || 6;
      const y = document.getElementById('recibo-incluir-anio')?.checked ? (new Date().getFullYear()) : null;
      const m = document.getElementById('recibo-incluir-mes')?.checked ? (String(new Date().getMonth()+1).padStart(2,'0')) : null;
      const parts = [];
      if(prefijo) parts.push(prefijo);
      if(y || m){
        const dt = [];
        if(y) dt.push(String(y));
        if(m) dt.push(String(m));
        parts.push(dt.join(sep));
      }
      parts.push(_padLeft(n0, llen));
      const preview = parts.join(sep);
      const el = document.getElementById('recibo-config-preview');
      if(el) el.textContent = `Próximo ejemplo: ${preview}`;
    }catch(_){}
  }

  async function loadReciboConfig(){
    try{
      const r = await fetch('/api/recibos/config', { headers: { 'Accept': 'application/json' } });
      let j = null; try{ j = await r.json(); }catch(_){}
      const cfg = j && typeof j === 'object' ? j : {};
      const setVal = (id, v) => { const el = document.getElementById(id); if(el) el.value = (v ?? el.value ?? ''); };
      const setChk = (id, v) => { const el = document.getElementById(id); if(el) el.checked = !!v; };
      setVal('recibo-prefijo', (cfg.prefijo ?? 'REC'));
      setVal('recibo-separador', (cfg.separador ?? '-'));
      setVal('recibo-numero-inicial', (cfg.numero_inicial ?? 1));
      setVal('recibo-longitud-numero', (cfg.longitud_numero ?? 6));
      setChk('recibo-reiniciar-anual', (cfg.reiniciar_anual ?? false));
      setChk('recibo-incluir-anio', (cfg.incluir_año ?? true));
      setChk('recibo-incluir-mes', (cfg.incluir_mes ?? false));
      computeReciboPreview();
    }catch(_){ computeReciboPreview(); }
  }

  // --- Recibo preview helpers ---
  function addItemRow(data){
    try{
      const rows = document.getElementById('recibo-items-rows');
      if(!rows) return;
      const row = document.createElement('div');
      row.style.display = 'grid';
      row.style.gridTemplateColumns = '1fr 100px 140px 40px';
      row.style.gap = '8px';
      row.style.alignItems = 'center';
      const desc = document.createElement('input'); desc.type='text'; desc.placeholder='Descripción'; desc.style.width='100%'; desc.value = (data && (data.descripcion || data.concepto_nombre)) || '';
      desc.className = 'recibo-item-desc';
      const qty = document.createElement('input'); qty.type='number'; qty.step='1'; qty.inputMode='numeric'; qty.placeholder='1'; qty.value = (data && (data.cantidad != null) ? data.cantidad : 1);
      qty.className = 'recibo-item-cantidad';
      const price = document.createElement('input'); price.type='number'; price.step='0.01'; price.inputMode='decimal'; price.placeholder='0.00'; price.value = (data && (data.precio_unitario != null ? data.precio_unitario : (data.precio ?? 0))) || 0;
      price.className = 'recibo-item-precio';
      const del = document.createElement('button'); del.type='button'; del.className='btn icon-only recibo-item-del'; del.textContent='×'; del.title='Quitar';
      row.appendChild(desc); row.appendChild(qty); row.appendChild(price); row.appendChild(del);
      rows.appendChild(row);
      const onChange = () => { recalcTotalsFromItems(); try{ refreshReciboPreview(); }catch(_){} };
      desc.oninput = onChange; qty.oninput = onChange; price.oninput = onChange;
      del.onclick = () => { try{ rows.removeChild(row); }catch(_){} recalcTotalsFromItems(); try{ refreshReciboPreview(); }catch(_){} };
    }catch(_){ /* noop */ }
  }

  function getItemsArray(){
    try{
      const rows = document.getElementById('recibo-items-rows');
      if(!rows) return [];
      const arr = [];
      Array.from(rows.children || []).forEach((row) => {
        try{
          const inputs = row.querySelectorAll('input');
          const desc = (inputs[0]?.value || '').trim();
          const qty = parseFloat(inputs[1]?.value || '1');
          const price = parseFloat(inputs[2]?.value || '0');
          if(desc){ arr.push({ descripcion: desc, cantidad: isNaN(qty)?1:qty, precio_unitario: isNaN(price)?0:price }); }
        }catch(_){ /* skip row */ }
      });
      return arr;
    }catch(_){ return []; }
  }

  function recalcTotalsFromItems(){
    try{
      const items = getItemsArray();
      let subtotal = 0.0;
      for(const it of items){ subtotal += ((it.cantidad||1) * (it.precio_unitario||0)); }
      const subEl = document.getElementById('recibo-total-subtotal'); if(subEl) subEl.value = Number(subtotal||0).toFixed(2);
      try{ const cntEl = document.getElementById('recibo-total-items'); if(cntEl) cntEl.value = String(items.length||0); }catch(_){}
      const comEl = document.getElementById('recibo-total-comision'); const com = parseFloat(comEl?.value || '0');
      const totalEl = document.getElementById('recibo-total-total'); if(totalEl) totalEl.value = Number((subtotal||0) + (isNaN(com)?0:com)).toFixed(2);
      try{ refreshReciboPreview(); }catch(_){}
    }catch(_){ /* noop */ }
  }

  function buildReciboParams(){
    const params = new URLSearchParams();
    const setIf = (k, v) => { try{ const s = String(v||'').trim(); if(s) params.set(k, s); }catch(_){ /* ignore */ } };
    setIf('numero', document.getElementById('recibo-preview-numero')?.value);
    setIf('observaciones', document.getElementById('recibo-preview-observaciones')?.value);
    setIf('emitido_por', document.getElementById('recibo-preview-emitidopor')?.value);
    setIf('titulo', document.getElementById('recibo-preview-titulo')?.value);
    // Fecha: enviar YYYY-MM-DD (backend convierte)
    setIf('fecha', document.getElementById('recibo-preview-fecha')?.value);
    setIf('gym_name', document.getElementById('recibo-preview-gym-nombre')?.value);
    setIf('gym_address', document.getElementById('recibo-preview-gym-direccion')?.value);
    setIf('usuario_nombre', document.getElementById('recibo-preview-usuario-nombre')?.value);
    setIf('usuario_dni', document.getElementById('recibo-preview-usuario-dni')?.value);
    setIf('metodo', document.getElementById('recibo-preview-metodo')?.value);
    // Tipo de cuota y periodo
    try{
      const fechaStr = document.getElementById('recibo-preview-fecha')?.value || '';
      if(fechaStr){
        const d = new Date(fechaStr);
        const meses = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
        const per = `${meses[d.getMonth()]} ${d.getFullYear()}`;
        setIf('periodo', per);
      } else if(state.previewPeriodo){ setIf('periodo', state.previewPeriodo); }
    }catch(_){}
    if(state.previewTipoCuota){ setIf('tipo_cuota', state.previewTipoCuota); }
    try{ params.set('mostrar_logo', document.getElementById('recibo-preview-mostrar-logo')?.checked ? '1':'0'); }catch(_){}
    try{ params.set('mostrar_metodo', document.getElementById('recibo-preview-mostrar-metodo')?.checked ? '1':'0'); }catch(_){}
    try{ params.set('mostrar_dni', document.getElementById('recibo-preview-mostrar-dni')?.checked ? '1':'0'); }catch(_){}
    try{
      const items = getItemsArray();
      if(Array.isArray(items) && items.length){ params.set('items', JSON.stringify(items)); }
    }catch(_){}
    try{
      const sv = document.getElementById('recibo-total-subtotal')?.value || '';
      const cv = document.getElementById('recibo-total-comision')?.value || '';
      const tv = document.getElementById('recibo-total-total')?.value || '';
      if(sv) params.set('subtotal', sv);
      if(cv) params.set('comision', cv);
      if(tv) params.set('total', tv);
    }catch(_){}
    return params;
  }

  // Construye una etiqueta de concepto a partir de los ítems
  function buildItemsConceptLabel(items){
    try{
      const list = Array.isArray(items) ? items.filter(it => String(it.descripcion||'').trim()) : [];
      if(!list.length) return { label:'', tooltip:'' };
      const first = String(list[0].descripcion||'').trim();
      const maxLen = 40;
      const trunc = first.length > maxLen ? (first.slice(0, maxLen-1) + '…') : first;
      const label = list.length > 1 ? `${trunc} + ${list.length-1} ítems` : trunc;
      const lines = [];
      let total = 0;
      for(const it of list){
        const desc = String(it.descripcion||'').trim();
        const qty = Number(it.cantidad != null ? it.cantidad : 1);
        const pu = Number(it.precio_unitario != null ? it.precio_unitario : 0);
        const line = Number(qty * pu);
        total += line;
        lines.push(`• ${desc} × ${qty} @ ${fmtCurrency(pu)} = ${fmtCurrency(line)}`);
      }
      const header = `Ítems: ${list.length} · Total: ${fmtCurrency(total)}`;
      const tooltip = [header, ...lines].join('\n');
      return { label, tooltip };
    }catch(_){ return { label:'', tooltip:'' }; }
  }

  function refreshReciboPreview(){
    try{
      const id = state.previewPagoId;
      if(!id) return;
      const frame = document.getElementById('recibo-preview-frame');
      if(!frame) return;
      const params = buildReciboParams();
      params.set('preview','1');
      const url = `/api/pagos/${id}/recibo.pdf?${params.toString()}#toolbar=0&navpanes=0`;
      if(frame.src !== url){ frame.src = url; try{ attachWheelZoom('recibo-preview-frame-wrap','recibo-preview-frame'); }catch(_){ } }
    }catch(_){ /* noop */ }
  }

  function handleReciboPreviewClose(){
    try{
      const orig = state.previewOriginal || {};
      const fOrig = String(orig.fecha || '').slice(0,10);
      const mOrig = Number(orig.monto || 0);
      const fNew = document.getElementById('recibo-preview-fecha')?.value || '';
      const tNewStr = document.getElementById('recibo-total-total')?.value || '';
      const tNew = parseFloat(tNewStr || 'NaN');
      const changedFecha = !!(fNew && fNew !== fOrig);
      const changedMonto = Number.isFinite(tNew) && Math.abs(tNew - mOrig) >= 0.01;
      if(changedFecha || changedMonto){
        const fLbl = document.getElementById('recibo-save-fecha'); if(fLbl) fLbl.textContent = fNew || '—';
        const tLbl = document.getElementById('recibo-save-total'); if(tLbl) tLbl.textContent = Number.isFinite(tNew) ? fmtCurrency(tNew) : '—';
        openModal('modal-recibo-save');
      } else {
        closeModal('modal-recibo-preview');
      }
    }catch(_){ closeModal('modal-recibo-preview'); }
  }

  async function applyReciboChangesToPago(){
    try{
      const id = state.previewPagoId;
      if(!id){ closeModal('modal-recibo-save'); return; }
      const usuario_id = state.previewUsuarioId || null;
      const metodo_pago_id = state.previewMetodoId || null;
      const fecha_pago = document.getElementById('recibo-preview-fecha')?.value || '';
      const totalStr = document.getElementById('recibo-total-total')?.value || '';
      const monto = Number.parseFloat(totalStr || '0') || 0;
      const items = getItemsArray();
      const conceptAgg = buildItemsConceptLabel(items);
      // Construir conceptos desde las filas del recibo; si no hay, asegurar ítem del concepto/monto
      let conceptos = Array.isArray(items) ? items.filter(it => String(it.descripcion||'').trim()).map(it => ({ descripcion: String(it.descripcion||'').trim(), cantidad: Number(it.cantidad||1), precio_unitario: Number(it.precio_unitario||0) })) : [];
      if(conceptos.length === 0){
        const desc = conceptAgg.label ? conceptAgg.label : 'Concepto';
        const pu = Number(monto||0);
        conceptos.push({ descripcion: desc, cantidad: 1, precio_unitario: pu });
      }
      const payload = { usuario_id, monto, conceptos };
      if(metodo_pago_id != null) payload.metodo_pago_id = Number(metodo_pago_id);
      if(fecha_pago) payload.fecha_pago = fecha_pago;
      if(conceptAgg.label){ payload.concepto = conceptAgg.label; payload.concepto_pago = conceptAgg.label; }
      const r = await fetch(`/api/pagos/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' }, body: JSON.stringify(payload) });
      let j = null; try{ j = await r.json(); }catch(_){}
      if(r.ok){
        if (typeof showToast==='function') showToast('Pago actualizado desde vista previa', 'success');
        // Actualizar resumen visual del concepto y tooltip inmediato
        try{
          const rc = document.getElementById('pago-resumen-concepto'); if(rc){ rc.textContent = conceptAgg.label || rc.textContent; rc.setAttribute('title', conceptAgg.tooltip || ''); }
          const sideC = document.getElementById('pago-side-concepto'); if(sideC){ sideC.textContent = conceptAgg.label || sideC.textContent; sideC.setAttribute('title', conceptAgg.tooltip || ''); }
        }catch(_){}
        // Selección del concepto en el select (opción temporal personalizada)
        try{
          const cpEl = document.getElementById('pago-concepto');
          if(cpEl && conceptAgg.label){
            let opt = Array.from(cpEl.options || []).find(o => String(o.value) === '__custom__');
            if(!opt){ opt = document.createElement('option'); opt.value='__custom__'; cpEl.appendChild(opt); }
            opt.textContent = conceptAgg.label;
            cpEl.value = '__custom__';
          }
        }catch(_){}
        // Refrescar listado
        closeModal('modal-recibo-save');
        closeModal('modal-recibo-preview');
        try{ await loadPayments(); try{ document.dispatchEvent(new CustomEvent('pagos:updated')); }catch(__){} }catch(_){}
      } else {
        if (typeof showToast==='function') showToast(j?.detail || j?.error || 'No se pudo actualizar el pago', 'error', 4500);
      }
    }catch(_){ if (typeof showToast==='function') showToast('Error al guardar cambios', 'error', 4500); }
  }

  function updatePeriodoLabel(){
    try{
      const lbl = document.getElementById('recibo-preview-periodo-label');
      if(!lbl) return;
      const fechaStr = document.getElementById('recibo-preview-fecha')?.value || '';
      let per = '';
      if(fechaStr){
        const d = new Date(fechaStr);
        if(!isNaN(d.getTime())){
          const meses = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
          per = `${meses[d.getMonth()]} ${d.getFullYear()}`;
        }
      }
      if(!per){ per = state.previewPeriodo || ''; }
      const tipo = String(state.previewTipoCuota || '').trim();
      const parts = [];
      if(per) parts.push(`Periodo: ${per}`);
      if(tipo) parts.push(`Tipo: ${tipo}`);
      const text = parts.join(' · ');
      lbl.textContent = text;
      lbl.style.display = text ? 'block' : 'none';
      state.previewPeriodo = per || null;
    }catch(_){ /* noop */ }
  }

  async function saveReciboConfig(){
    try{
      const payload = {
        prefijo: document.getElementById('recibo-prefijo')?.value || 'REC',
        separador: document.getElementById('recibo-separador')?.value || '-',
        numero_inicial: parseInt(document.getElementById('recibo-numero-inicial')?.value || '1', 10) || 1,
        longitud_numero: parseInt(document.getElementById('recibo-longitud-numero')?.value || '6', 10) || 6,
        reiniciar_anual: !!document.getElementById('recibo-reiniciar-anual')?.checked,
        incluir_año: !!document.getElementById('recibo-incluir-anio')?.checked,
        incluir_mes: !!document.getElementById('recibo-incluir-mes')?.checked,
      };
      const r = await fetch('/api/recibos/config', { method: 'PUT', headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' }, body: JSON.stringify(payload) });
      let j = null; try{ j = await r.json(); }catch(_){}
      if(r.ok && j && (j.ok || j.success)){
        if (typeof showToast==='function') showToast('Configuración guardada', 'success');
        closeModal('modal-recibo-config');
        updateReciboNextNumber();
      } else {
        if (typeof showToast==='function') showToast(j?.detail || j?.error || 'No se pudo guardar la configuración', 'warning');
      }
    }catch(_){ if (typeof showToast==='function') showToast('Error guardando la configuración', 'error'); }
  }

  function bindReciboConfigEvents(){
    try{
      const btn = document.getElementById('recibo-config-btn');
      const closeBtn = document.getElementById('recibo-config-close');
      const cancelBtn = document.getElementById('recibo-config-cancel');
      const saveBtn = document.getElementById('recibo-config-save');
      const inputs = ['recibo-prefijo','recibo-separador','recibo-numero-inicial','recibo-longitud-numero','recibo-reiniciar-anual','recibo-incluir-anio','recibo-incluir-mes'];
      if(btn) btn.onclick = async () => { await loadReciboConfig(); openModal('modal-recibo-config'); };
      if(closeBtn) closeBtn.onclick = () => { closeModal('modal-recibo-config'); };
      if(cancelBtn) cancelBtn.onclick = () => { closeModal('modal-recibo-config'); };
      if(saveBtn) saveBtn.onclick = () => { saveReciboConfig(); };
      inputs.forEach(id => { const el = document.getElementById(id); if(el){ el.oninput = computeReciboPreview; el.onchange = computeReciboPreview; } });
    }catch(_){}
  }

  // Abrir modal de vista previa de recibo
  async function openReciboPreview(id){
    try {
      state.previewPagoId = id;
      const frame = document.getElementById('recibo-preview-frame');
      const numEl = document.getElementById('recibo-preview-numero');
      // Precargar el número sugerido manteniendo el placeholder
      if(numEl){
        try {
          const r = await fetch('/api/recibos/numero-proximo', { headers: { 'Accept': 'application/json' } });
          let j = null; try{ j = await r.json(); }catch(_){}
          const next = j && (j.numero || j.next || j.number);
          if(next) numEl.value = next;
        } catch(_){ /* mantener valor actual/placeholder */ }
      }
      // Prefill de branding del gimnasio y título por defecto
      try{
        const rg = await fetch('/api/gym/data', { headers: { 'Accept': 'application/json' } });
        let jg = null; try{ jg = await rg.json(); }catch(_){}
        if(rg.ok && jg){
          const gnameEl = document.getElementById('recibo-preview-gym-nombre'); if(gnameEl) gnameEl.value = (jg.gym_name || '').trim();
          const gaddrEl = document.getElementById('recibo-preview-gym-direccion'); if(gaddrEl) gaddrEl.value = (jg.gym_address || '').trim();
        }
      }catch(_){ /* continuar */ }
      try{ const titEl = document.getElementById('recibo-preview-titulo'); if(titEl && !titEl.value) titEl.value = 'RECIBO DE PAGO'; }catch(_){}
      // Prefill "Emitido por" con el profesor en sesión si el campo está vacío
      try{
        const emitEl = document.getElementById('recibo-preview-emitidopor');
        const sessEl = document.getElementById('login-current');
        const profUidRaw = sessEl ? (sessEl.getAttribute('data-prof-uid') || '') : '';
        const profUid = String(profUidRaw).trim();
        if(emitEl && !emitEl.value && profUid){
          const rU = await fetch(`/api/usuarios/${encodeURIComponent(profUid)}`, { headers: { 'Accept': 'application/json' } });
          let jU = null; try{ jU = await rU.json(); }catch(_){}
          const nombre = jU ? ((jU.usuario && jU.usuario.nombre) || jU.nombre || '') : '';
          if(nombre) emitEl.value = String(nombre).trim();
        }
      }catch(_){ /* continuar */ }
      // Prefill desde el pago: usuario, fecha y detalles
      try{
        const r2 = await fetch(`/api/pagos/${id}`, { headers: { 'Accept': 'application/json' } });
        let j2 = null; try{ j2 = await r2.json(); }catch(_){}
        if(r2.ok && j2 && typeof j2 === 'object'){
          const pago = j2.pago || {};
          const detalles = Array.isArray(j2.detalles) ? j2.detalles : [];
          const nombreEl = document.getElementById('recibo-preview-usuario-nombre'); if(nombreEl) nombreEl.value = pago.usuario_nombre || '';
          const dniEl = document.getElementById('recibo-preview-usuario-dni'); if(dniEl) dniEl.value = pago.dni || '';
          const fechaEl = document.getElementById('recibo-preview-fecha'); if(fechaEl){ const f = String(pago.fecha_pago || '').slice(0,10); if(f) fechaEl.value = f; }
          // Guardar en estado para confirmación y guardado
          try{ state.previewUsuarioId = pago.usuario_id || (pago.usuario && pago.usuario.id) || null; }catch(_){ state.previewUsuarioId = null; }
          try{ state.previewMetodoId = pago.metodo_pago_id || pago.metodo_id || null; }catch(_){ state.previewMetodoId = null; }
          try{ state.previewOriginal = { fecha: String(pago.fecha_pago || pago.fecha || '').slice(0,10) || null, monto: (pago.monto != null ? Number(pago.monto) : null) }; }catch(_){ state.previewOriginal = { fecha: null, monto: null }; }
          // Método de pago nombre
          try{
            const metodoId = String(pago.metodo_pago_id || pago.metodo_id || '').trim();
            if(metodoId){ const m = state.metodosPagoMap ? state.metodosPagoMap[metodoId] : null; const metEl = document.getElementById('recibo-preview-metodo'); if(metEl) metEl.value = m ? (m.nombre || '') : (metodoId || ''); }
          }catch(_){ /* continuar */ }
          // Tipo de cuota y periodo en estado (resolver etiqueta legible)
          try{
            try{
              if(!Array.isArray(state.tiposCuotaActivos) || state.tiposCuotaActivos.length === 0){
                await loadTiposCuotaActivos();
              }
            }catch(__){}
            try{ await ensureTiposCuotaCatalogo(); }catch(__){}
            let u = (state.usuarios || []).find(x => Number(x.id) === Number(pago.usuario_id));
            if(!u){
              try{
                const rU = await fetch(`/api/usuarios/${encodeURIComponent(pago.usuario_id)}`, { headers: { 'Accept':'application/json' } });
                let jU = null; try{ jU = await rU.json(); }catch(__){}
                u = jU && (jU.usuario || jU);
              }catch(__){ /* continuar */ }
            }
            const tipoVal = u ? (u.tipo_cuota ?? null) : null;
            const tipoObj = resolveTipoCuota(tipoVal);
            const label = tipoObj ? (tipoObj.nombre || String(tipoObj.id || '')) : (tipoVal || '');
            state.previewTipoCuota = label || null;
          }catch(_){ state.previewTipoCuota = null; }
          try{
            const meses = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
            const per = `${meses[(pago.mes||1)-1]} ${pago.año||new Date().getFullYear()}`;
            state.previewPeriodo = per;
          }catch(_){ state.previewPeriodo = null; }
          // Limpiar ítems y precargar desde detalles
          const rows = document.getElementById('recibo-items-rows'); if(rows) rows.innerHTML = '';
          if(detalles.length){
            detalles.forEach(d => { addItemRow({ descripcion: (d.descripcion || d.concepto_nombre || ''), cantidad: d.cantidad, precio_unitario: d.precio_unitario }); });
          } else {
            // Si no hay detalles, agregar un ítem vacío para edición rápida
            addItemRow({ descripcion: '', cantidad: 1, precio_unitario: Number(pago.monto||0) });
          }
          recalcTotalsFromItems();
        }
      }catch(_){ /* continuar */ }
      if(frame) { frame.src = `/api/pagos/${id}/recibo.pdf?preview=1#toolbar=0&navpanes=0`; try{ attachWheelZoom('recibo-preview-frame-wrap','recibo-preview-frame'); }catch(_){ } }
      updatePeriodoLabel();
      try{ refreshReciboPreview(); }catch(_){}
      openModal('modal-recibo-preview');
    } catch(_){
      if (typeof showToast==='function') showToast('No se pudo abrir el recibo', 'error', 4500);
    }
  }

    document.addEventListener('DOMContentLoaded', () => {
      init();
      // Refrescar automáticamente tablas de Pagos y Rutinas cuando se emitan eventos
      try{
        document.addEventListener('pagos:updated', () => { try{ loadPayments(); }catch(_){ } });
        document.addEventListener('rutinas:updated', () => {
          try{
            if(state && state.activeRutinaTab === 'usuario'){
              const uid = (document.getElementById('rutinas-usuario')||{}).value || '';
              loadRutinasPorUsuario(uid);
            } else {
              loadRutinasPlantillas();
            }
          }catch(_){ }
        });
      }catch(_){ }
      // Inicializar numeración de recibos (indicador y eventos)
      updateReciboNextNumber();
      bindReciboConfigEvents();

      // Enganchar botón de salir directamente y con fallback fuerte
      try{
        const link = document.getElementById('logout-link');
        const el = document.getElementById('login-current');
        const role = (el && (el.getAttribute('data-role')||'').trim()) || '';
        if(link && role === 'profesor'){
          try{ link.setAttribute('href','#'); link.setAttribute('aria-controls','modal-sesion-fin'); }catch(_){}
          const handleLogout = (e) => {
            try{
              e.preventDefault();
              try{ populateSesionFinModal(); }catch(_){}
              try{ openModal('modal-sesion-fin'); }catch(_){}
              try{
                setTimeout(() => {
                  try{
                    const m = document.getElementById('modal-sesion-fin');
                    const isActive = !!(m && m.classList.contains('active') && m.style.display !== 'none');
                    if(!isActive){
                      fetch('/api/profesor_sesion_fin', { method:'POST', headers:{ 'Accept':'application/json', 'Content-Type':'application/json' } })
                        .finally(() => { try{ window.location.href = '/gestion/logout'; }catch(__){} });
                    }
                  }catch(__){ try{ window.location.href = '/gestion/logout'; }catch(__){} }
                }, 160);
              }catch(__){ try{ window.location.href = '/gestion/logout'; }catch(__){} }
            }catch(__){ /* noop */ }
          };
          try{ link.addEventListener('pointerdown', handleLogout, { passive:false }); }catch(_){}
          try{ link.addEventListener('click', handleLogout); }catch(_){}
        }
      }catch(_){}
    });
  
  </script>
  <script src="/static/js/ui.js"></script>
  <script src="/static/js/utils.js"></script>
</body>
</html>
