{% extends "base.html" %}
{% set _ = '' %}
{% block content %}
  <div class="space-y-4">
    <h1 class="text-2xl font-semibold">Gimnasios</h1>
    
    
    <div class="flex flex-wrap gap-3 items-center">
    <button id="open-actions" class="px-3 py-2 rounded-md bg-primary text-primary-foreground">Acciones</button>
    <form method="get" action="/admin/gyms" class="flex flex-wrap gap-2">
      <input name="q" value="{{ q }}" placeholder="Buscar por nombre o subdominio" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950 w-full sm:min-w-[240px] sm:w-auto min-w-0" />
      <select name="status" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950">
        <option value="">Todos</option>
        <option value="active"{% if status_q=='active' %} selected{% endif %}>Activos</option>
        <option value="suspended"{% if status_q=='suspended' %} selected{% endif %}>Suspendidos</option>
        <option value="maintenance"{% if status_q=='maintenance' %} selected{% endif %}>Mantenimiento</option>
      </select>
      <select name="order_by" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950">
        <option value="id">ID</option>
        <option value="created_at">Creado</option>
        <option value="nombre">Nombre</option>
        <option value="subdominio">Subdominio</option>
        <option value="status">Estado</option>
      </select>
      <select name="order_dir" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950">
        <option value="DESC">Desc</option>
        <option value="ASC">Asc</option>
      </select>
      <input type="hidden" name="ui" value="1" />
      <button type="submit" class="px-3 py-2 rounded-md bg-primary text-primary-foreground">Filtrar</button>
    </form>
    <div class="flex flex-wrap items-center gap-2">
      <span class="text-sm text-gray-400">Estado:</span>
      <a href="/admin/gyms?ui=1&q={{ q }}&status=&order_by={{ order_by }}&order_dir={{ order_dir }}&view={{ view or 'cards' }}" hx-headers='{"accept":"text/html"}' class="px-2 py-1 rounded-md {{ 'bg-primary text-primary-foreground' if not status_q else 'bg-gray-900' }}">Todos</a>
      <a href="/admin/gyms?ui=1&q={{ q }}&status=active&order_by={{ order_by }}&order_dir={{ order_dir }}&view={{ view or 'cards' }}" hx-headers='{"accept":"text/html"}' class="px-2 py-1 rounded-md {{ 'bg-primary text-primary-foreground' if status_q=='active' else 'bg-gray-900' }}">Activos</a>
      <a href="/admin/gyms?ui=1&q={{ q }}&status=suspended&order_by={{ order_by }}&order_dir={{ order_dir }}&view={{ view or 'cards' }}" hx-headers='{"accept":"text/html"}' class="px-2 py-1 rounded-md {{ 'bg-primary text-primary-foreground' if status_q=='suspended' else 'bg-gray-900' }}">Suspendidos</a>
      <a href="/admin/gyms?ui=1&q={{ q }}&status=maintenance&order_by={{ order_by }}&order_dir={{ order_dir }}&view={{ view or 'cards' }}" hx-headers='{"accept":"text/html"}' class="px-2 py-1 rounded-md {{ 'bg-primary text-primary-foreground' if status_q=='maintenance' else 'bg-gray-900' }}">Mantenimiento</a>
    </div>
    <form method="get" action="/admin/gyms" class="flex flex-wrap items-center gap-2">
      <input name="page_size" value="{{ page_size }}" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950 w-24" />
      <input type="hidden" name="ui" value="1" />
      <input type="hidden" name="page" value="1" />
      <button type="submit" class="px-3 py-2 rounded-md bg-gray-900">Tamaño página</button>
    </form>
    {% set dir_next = 'ASC' if (order_dir or 'DESC')=='DESC' else 'DESC' %}
    <div class="flex flex-wrap items-center gap-2">
      <span class="text-sm text-gray-400">Ordenar por:</span>
      <a href="/admin/gyms?ui=1&q={{ q }}&status={{ status_q }}&order_by=id&order_dir={{ dir_next }}" hx-headers='{"accept":"text/html"}' class="px-2 py-1 rounded-md {{ 'bg-primary text-primary-foreground' if order_by=='id' else 'bg-gray-900' }}">ID</a>
      <a href="/admin/gyms?ui=1&q={{ q }}&status={{ status_q }}&order_by=created_at&order_dir={{ dir_next }}" hx-headers='{"accept":"text/html"}' class="px-2 py-1 rounded-md {{ 'bg-primary text-primary-foreground' if order_by=='created_at' else 'bg-gray-900' }}">Creado</a>
      <a href="/admin/gyms?ui=1&q={{ q }}&status={{ status_q }}&order_by=nombre&order_dir={{ dir_next }}" hx-headers='{"accept":"text/html"}' class="px-2 py-1 rounded-md {{ 'bg-primary text-primary-foreground' if order_by=='nombre' else 'bg-gray-900' }}">Nombre</a>
      <a href="/admin/gyms?ui=1&q={{ q }}&status={{ status_q }}&order_by=subdominio&order_dir={{ dir_next }}" hx-headers='{"accept":"text/html"}' class="px-2 py-1 rounded-md {{ 'bg-primary text-primary-foreground' if order_by=='subdominio' else 'bg-gray-900' }}">Subdominio</a>
      <a href="/admin/gyms?ui=1&q={{ q }}&status={{ status_q }}&order_by=status&order_dir={{ dir_next }}" hx-headers='{"accept":"text/html"}' class="px-2 py-1 rounded-md {{ 'bg-primary text-primary-foreground' if order_by=='status' else 'bg-gray-900' }}">Estado</a>
      <span class="ml-3 text-sm text-gray-400">Vista:</span>
      <a href="/admin/gyms?ui=1&q={{ q }}&status={{ status_q }}&order_by={{ order_by }}&order_dir={{ order_dir }}&view=cards" hx-headers='{"accept":"text/html"}' class="px-2 py-1 rounded-md {{ 'bg-primary text-primary-foreground' if (view or 'cards')=='cards' else 'bg-gray-900' }}">Tarjetas</a>
      <a href="/admin/gyms?ui=1&q={{ q }}&status={{ status_q }}&order_by={{ order_by }}&order_dir={{ order_dir }}&view=table" hx-headers='{"accept":"text/html"}' class="px-2 py-1 rounded-md {{ 'bg-primary text-primary-foreground' if (view or 'cards')=='table' else 'bg-gray-900' }}">Tabla</a>
    </div>
    <button id="open-create" class="px-3 py-2 rounded-md bg-primary text-primary-foreground">Crear gimnasio</button>
    <button id="open-k" class="px-3 py-2 rounded-md bg-gray-900" onclick="window.openGlobalK && window.openGlobalK()"><i class="fa-solid fa-keyboard"></i><span class="ml-2">Ctrl+K</span></button>
  </div>
  <div id="actions-overlay" role="dialog" aria-modal="true" aria-labelledby="actions-title" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60" tabindex="-1">
    <div class="relative p-4 w-full max-w-md max-h-[85vh] overflow-auto">
      <div class="relative bg-gray-900 rounded-lg border border-gray-800 shadow">
        <div class="flex items-center justify-between p-3 border-b border-gray-800">
          <h3 id="actions-title" class="text-base font-semibold text-white">Acciones rápidas</h3>
          <button id="actions-close" class="px-2 py-1 rounded-md bg-gray-800">Cerrar</button>
        </div>
        <div class="p-3 grid gap-3">
          <button id="open-create-quick" class="px-3 py-2 rounded-md bg-primary text-primary-foreground">Crear gimnasio</button>
          <div class="grid gap-2">
            <div class="text-sm text-gray-400">Acciones por lote</div>
            <div class="grid grid-cols-2 gap-2">
              <button id="batch-prov-side" class="px-3 py-2 rounded-md bg-primary text-primary-foreground">Provisionar</button>
              <button id="batch-uns-side" class="px-3 py-2 rounded-md bg-green-600 text-white">Reactivar</button>
              <button id="batch-sus-side" class="px-3 py-2 rounded-md bg-red-600 text-white">Suspender</button>
            </div>
            <input id="batch-message-side" placeholder="Mensaje recordatorio" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
            <button id="batch-remind-side" class="px-3 py-2 rounded-md bg-gray-900">Recordar</button>
          </div>
          <div class="grid gap-2">
            <div class="text-sm text-gray-400">Aviso mantenimiento</div>
            <input id="batch-maint-message-side" placeholder="Mensaje mantenimiento" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
            <button id="batch-maint-side" class="px-3 py-2 rounded-md bg-yellow-500 text-black">Enviar aviso</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
  window.addEventListener('DOMContentLoaded', function(){
  (function(){var o=document.getElementById('open-actions');var ov=document.getElementById('actions-overlay');var c=document.getElementById('actions-close');var ab=document.getElementById('actions-backdrop');function open(){if(ov){ov.classList.remove('hidden');document.body.classList.add('overflow-hidden');setTimeout(function(){if(c){c.focus()}},10)}}function close(){if(ov){ov.classList.add('hidden');document.body.classList.remove('overflow-hidden')}}if(o){o.addEventListener('click',open)}if(c){c.addEventListener('click',close)}if(ab){ab.addEventListener('click',close)}document.addEventListener('keydown',function(e){if(e.key==='Escape'){close()}});var ocq=document.getElementById('open-create-quick');if(ocq){ocq.addEventListener('click',function(){close();var btn=document.getElementById('open-create');if(btn){btn.click()}})}function proxy(id,fn){var b=document.getElementById(id);if(b){b.addEventListener('click',fn)}}proxy('batch-prov-side',function(){document.getElementById('batch-prov').click()});proxy('batch-uns-side',function(){document.getElementById('batch-uns').click()});proxy('batch-sus-side',function(){document.getElementById('batch-sus').click()});proxy('batch-remind-side',function(){var src=document.getElementById('batch-message');var dst=document.getElementById('batch-message-side');if(src&&dst){src.value=dst.value}document.getElementById('batch-remind').click()});proxy('batch-maint-side',function(){var src=document.getElementById('batch-maint-message');var dst=document.getElementById('batch-maint-message-side');if(src&&dst){src.value=dst.value}document.getElementById('batch-maint').click()});try{var cards=document.querySelectorAll('[data-gym-id]');for(var i=0;i<cards.length;i++){var gid=String(cards[i].getAttribute('data-gym-id')||'');if(!gid)continue;var sId='edit-sub-'+gid;var fId='edit-folder-preview-'+gid;var subEl=document.getElementById(sId);var fn=function(v){var p=(v||'').trim().toLowerCase();var el=document.getElementById(fId);if(el){el.textContent=p+'-assets'}};if(subEl){subEl.addEventListener('input',function(){fn(subEl.value)})}fn((subEl&&subEl.value)||'')}var rows=document.querySelectorAll('tr[data-gym-id]');for(var j=0;j<rows.length;j++){var tsId='t-sub-'+rows[j].getAttribute('data-gym-id');var tfId='t-folder-preview-'+rows[j].getAttribute('data-gym-id');var tsEl=document.getElementById(tsId);var fn2=function(v){var p=(v||'').trim().toLowerCase();var el=document.getElementById(tfId);if(el){el.textContent=p+'-assets'}};if(tsEl){tsEl.addEventListener('input',function(){fn2(tsEl.value)})}fn2((tsEl&&tsEl.value)||'')}}catch(_){}})();
  });
  </script>
  <script>
  function openDetails3(gid){var detailsOverlay=document.getElementById('details-overlay');var detailsContent=document.getElementById('details-content');var detailsClose=document.getElementById('details-close');if(!detailsOverlay||!detailsContent)return;detailsOverlay.classList.remove('hidden');document.body.classList.add('overflow-hidden');try{var url=new URL(window.location.href);url.searchParams.set('modal','details');url.searchParams.set('gid',String(gid||''));history.pushState({},'',url.toString())}catch(_){ }setTimeout(function(){if(detailsClose){detailsClose.focus()}},10);detailsContent.innerHTML='<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px"><div class="skeleton h-24 rounded-md"></div><div class="skeleton h-24 rounded-md"></div><div class="skeleton h-24 rounded-md"></div></div>';fetch((window.apiPref?window.apiPref():'')+'/admin/gyms/'+gid+'/details',{headers:{'accept':'application/json'}}).then(function(r){return r.json()}).then(function(j){var d=(j&&j.gym)||{};var h=(j&&j.health)||{};var pays=(j&&j.payments)||[];var sub=(j&&j.subscription)||{};var wurl=String((j&&j.webapp_url)||'');var dbo=!!(h&&h.db&&h.db.ok);var wao=!!(h&&h.whatsapp&&h.whatsapp.ok);var sto=!!(h&&h.storage&&h.storage.ok);var healthHtml='<div class="flex items-center gap-2"><div class="flex items-center gap-2"><span class="w-6 h-6 rounded-full '+(dbo?'bg-green-600':'bg-red-600')+'"></span><span class="text-gray-300 text-xs">DB</span></div><div class="flex items-center gap-2"><span class="w-6 h-6 rounded-full '+(wao?'bg-green-600':'bg-red-600')+'"></span><span class="text-gray-300 text-xs">WA</span></div><div class="flex items-center gap-2"><span class="w-6 h-6 rounded-full '+(sto?'bg-green-600':'bg-red-600')+'"></span><span class="text-gray-300 text-xs">ST</span></div></div>';var dh=document.getElementById('details-health');if(dh){dh.innerHTML=healthHtml}var html='';html+='<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px">';html+='<div class="grid gap-4">';html+='<div class="bg-gray-800 p-3 rounded-md"><div class="font-semibold text-white">Información Básica</div><div class="grid grid-cols-2 gap-2 mt-2">';html+='<div class="text-gray-400">ID</div><div>'+String(d.id||'')+'</div>';html+='<div class="text-gray-400">Nombre</div><div>'+String(d.nombre||'')+'</div>';html+='<div class="text-gray-400">Subdominio</div><div>'+String(d.subdominio||'')+'</div>';html+='<div class="text-gray-400">Estado</div><div>'+String(d.status||'')+'</div>';html+='<div class="text-gray-400">Creado</div><div>'+String(d.created_at||'')+'</div>';html+='<div class="text-gray-400">Teléfono</div><div>'+String(d.owner_phone||'')+'</div>';html+='<div class="text-gray-400">DB</div><div>'+String(d.db_name||'')+'</div>';html+='</div></div>';html+='<div class="bg-gray-800 p-3 rounded-md"><div class="font-semibold text-white">Almacenamiento</div><div class="grid grid-cols-2 gap-2 mt-2">';html+='<div class="text-gray-400">Carpeta en bucket</div><div>'+String(d.assets_folder_prefix||'')+'</div>';html+='<div class="text-gray-400">CDN base</div><div>'+String(d.storage_public_base||'')+'</div>';html+='</div></div>';html+='</div>';html+='<div class="grid gap-4">';html+='<div class="bg-gray-800 p-3 rounded-md"><div class="font-semibold text-white">Suscripción</div><div class="mt-2 text-sm">Plan: '+String(sub.plan||'')+' · Válido hasta: '+String(sub.valid_until||'')+'</div></div>';html+='<div class="bg-gray-800 p-3 rounded-md"><div class="font-semibold text-white">Pagos recientes</div>';if(pays.length){html+='<div class="mt-2 grid gap-1">';for(var i=0;i<Math.min(pays.length,5);i++){var p=pays[i];html+='<div class="flex justify-between text-sm"><span>'+(String(p.plan||'')+' · '+String(p.amount||'')+' '+String(p.currency||''))+'</span><span class="text-gray-400">'+String(p.paid_at||'')+'</span></div>'}html+='</div>'}else{html+='<div class="mt-2 text-gray-400 text-sm">Sin pagos</div>'}html+='</div>';html+='</div>';if(wurl){html+='<div class="grid gap-4"><div class="bg-gray-800 p-3 rounded-md"><div class="font-semibold text-white">Vista previa</div><div class="mt-2 rounded-md border border-gray-800 overflow-hidden"><iframe src="'+wurl+'" title="Vista previa webapp" class="w-full h-[70vh] bg-black"></iframe></div></div></div>'}detailsContent.innerHTML=html}).catch(function(){detailsContent.innerHTML='<div class="text-red-600">Error al cargar detalles</div>'})}
  </script>
  <script>
  function openDetails2(gid){openDetails3(gid)}
  </script>
  <script>
  (function(){var det=document.getElementById('details-overlay');var detClose=document.getElementById('details-close');if(det){det.addEventListener('click',function(e){if(e.target===det){det.classList.add('hidden');document.body.classList.remove('overflow-hidden')}})}if(detClose){detClose.addEventListener('click',function(){document.body.classList.remove('overflow-hidden')})}var oc=document.getElementById('open-create');var oc2=document.getElementById('open-create-2');var cm=document.getElementById('create-modal');var cc=document.getElementById('create-cancel');var cc2=document.getElementById('create-cancel-2');function doBind(){if(window.bindSubdomainBucket){window.bindSubdomainBucket('create-name','create-sub','create-sub-status','create-bucket','')}}if(oc){oc.addEventListener('click',function(){document.body.classList.add('overflow-hidden');doBind()})}if(oc2){oc2.addEventListener('click',function(){document.body.classList.add('overflow-hidden');doBind()})}if(cm){cm.addEventListener('click',function(e){if(e.target===cm){cm.classList.add('hidden');document.body.classList.remove('overflow-hidden')}})}if(cc){cc.addEventListener('click',function(){document.body.classList.remove('overflow-hidden')})}if(cc2){cc2.addEventListener('click',function(){document.body.classList.remove('overflow-hidden')})}var so=document.getElementById('suspend-modal');var sc=document.getElementById('suspend-cancel');var sc2=document.getElementById('suspend-cancel-2');var sy=document.getElementById('suspend-yes');var os=document.querySelectorAll('[data-open-suspend]');for(var i=0;i<os.length;i++){os[i].addEventListener('click',function(){document.body.classList.add('overflow-hidden')})}if(so){so.addEventListener('click',function(e){if(e.target===so){so.classList.add('hidden');document.body.classList.remove('overflow-hidden')}})}if(sc){sc.addEventListener('click',function(){document.body.classList.remove('overflow-hidden')})}if(sc2){sc2.addEventListener('click',function(){document.body.classList.remove('overflow-hidden')})}if(sy){sy.addEventListener('click',function(){document.body.classList.remove('overflow-hidden')})}})();
  </script>
  <script>
  (function(){var o=document.getElementById('open-actions');var ov=document.getElementById('actions-overlay');var c=document.getElementById('actions-close');var b=document.getElementById('actions-backdrop');function close(){if(ov){ov.classList.add('hidden');document.body.classList.remove('overflow-hidden')}}if(o){o.addEventListener('click',function(){document.body.classList.add('overflow-hidden');setTimeout(function(){if(c){c.focus()}},10)})}if(c){c.addEventListener('click',function(){document.body.classList.remove('overflow-hidden')})}if(b){b.addEventListener('click',close)}document.addEventListener('keydown',function(e){if(e.key==='Escape'){document.body.classList.remove('overflow-hidden')}})})();
  </script>
  {% if items|length == 0 %}
  <div class="p-6 rounded-xl border border-gray-800 bg-[#0b1222] grid gap-2 text-center">
    <div class="text-lg font-semibold">Sin resultados</div>
    <div class="text-gray-400">Ajusta filtros u <button id="open-create-2" class="px-3 py-1 rounded-md bg-primary text-primary-foreground">crea un gimnasio</button></div>
  </div>
  {% elif (view or 'cards')=='cards' %}
  <div id="gyms-section" class="grid gap-3" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr))">
    {% for g in items %}
    <div class="p-3 rounded-xl border border-gray-800 bg-[#0b1222] grid gap-3" data-gym-id="{{ g.id }}" data-next-due="{{ g.next_due_date or '' }}" x-data="{ edit:false, showCfg:false, more:false }">
      <div class="flex flex-wrap justify-between items-center">
        <div class="flex items-center gap-2 min-w-0">
          <input type="checkbox" class="select-gym" value="{{ g.id }}" />
          <div id="gym-name-{{ g.id }}" class="font-semibold truncate max-w-[60%]" title="{{ g.nombre }}">{{ g.nombre }}</div>
          <button type="button" id="gym-sub-{{ g.id }}" class="text-gray-400 text-sm truncate max-w-[40%]" data-sub="{{ g.subdominio }}" title="{{ g.subdominio }}">{{ g.subdominio }}</button>
          {% if g.webapp_url %}
          <a id="gym-url-{{ g.id }}" href="{{ g.webapp_url }}" target="_blank" rel="noopener" class="text-blue-400 text-xs truncate max-w-[50%]" title="{{ g.webapp_url }}">{{ g.webapp_url }}</a>
          {% endif %}
        </div>
        <div class="flex items-center gap-2 ml-auto">
          <div id="health-mini-{{ g.id }}" hx-get="/admin/gyms/{{ g.id }}/health?snippet=1" hx-headers='{"accept":"text/html"}' hx-trigger="revealed delay:300ms throttle:500ms" hx-target="this" hx-select="*" hx-swap="innerHTML" hx-push-url="false" class="hidden sm:flex gap-1 items-center">
            <div class="skeleton w-16 h-3 rounded-md"></div>
          </div>
          <span id="status-badge-{{ g.id }}" class="px-2 py-1 rounded-full text-xs {{ 'bg-green-600 text-white' if g.status=='active' else ('bg-red-600 text-white' if g.status=='suspended' else ('bg-yellow-500 text-black' if g.status=='maintenance' else 'bg-gray-700 text-white')) }}">{{ g.status }}</span>
        </div>
      </div>
      {% set next_due = g.next_due_date if g.next_due_date is defined else '' %}
      {% set last_amt = g.last_payment_amount if g.last_payment_amount is defined else '' %}
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
        <div class="grid gap-2">
          <div class="flex items-center justify-between"><span class="text-gray-400">Creado</span><span>{{ g.created_at }}</span></div>
          <div class="flex items-center justify-between"><span class="text-gray-400">Vence</span><span class="flex items-center gap-2"><span>{{ next_due }}</span><span data-due-chip class="px-2 py-1 rounded-full text-xs"></span></span></div>
          <div class="flex items-center justify-between"><span class="text-gray-400">Carpeta en bucket</span><span id="gym-folder-{{ g.id }}" class="truncate" title="{{ g.subdominio ~ '-assets' }}">{{ g.subdominio ~ '-assets' }}</span></div>
        </div>
        <div class="grid gap-2">
          <div class="flex items-center justify-between"><span class="text-gray-400">Teléfono</span><span>{% if g.owner_phone and g.owner_phone|trim %}{{ g.owner_phone }}{% else %}No registrado{% endif %}</span></div>
          <div class="flex items-center justify-between"><span class="text-gray-400">Último pago</span><span>{% if last_amt %}{{ last_amt }} {{ g.last_payment_currency or '' }}{% if g.last_payment_at %} · {{ g.last_payment_at }}{% endif %}{% else %}Sin pagos{% endif %}</span></div>
          <div class="flex items-center justify-end"><button type="button" class="px-2 py-1 rounded-md bg-gray-900" x-on:click="showCfg=!showCfg">Configuración</button></div>
        </div>
      </div>
      <div class="grid gap-2" x-show="showCfg">
        <form hx-post="/admin/gyms/{{ g.id }}/contact" hx-headers='{"accept":"application/json"}' hx-swap="none" class="grid grid-cols-1 sm:grid-cols-2 gap-2">
          <input name="owner_phone" value="{{ g.owner_phone }}" placeholder="+54..." class="px-2 py-1 rounded-md border border-gray-700 bg-gray-950" />
          <div class="sm:col-span-2 flex justify-end"><button type="submit" class="px-3 py-2 rounded-md bg-primary text-primary-foreground">Guardar</button></div>
        </form>
        <form hx-post="/admin/gyms/{{ g.id }}/update" hx-headers='{"accept":"application/json"}' hx-swap="none" class="grid grid-cols-1 sm:grid-cols-2 gap-2 needs-confirm" data-confirm="Esta acción puede cambiar subdominio y carpeta. Puede afectar el acceso a archivos. ¿Confirmar?">
          <input id="edit-name-{{ g.id }}" name="nombre" value="{{ g.nombre }}" placeholder="Nombre" class="px-2 py-1 rounded-md border border-gray-700 bg-gray-950" />
          <div>
            <input id="edit-sub-{{ g.id }}" name="subdominio" value="{{ g.subdominio }}" placeholder="Subdominio" class="px-2 py-1 rounded-md border border-gray-700 bg-gray-950 w-full"
                   hx-get="/admin/subdomains/check" hx-trigger="input changed" hx-target="#edit-sub-status-{{ g.id }}" hx-include="#edit-name-{{ g.id }}, #edit-sub-hidden-{{ g.id }}" hx-headers='{"accept":"text/html"}'
                   x-on:input="document.getElementById('edit-sub-hidden-{{ g.id }}').value = $event.target.value" />
            <input type="hidden" id="edit-sub-hidden-{{ g.id }}" name="sub" />
            <span id="edit-sub-status-{{ g.id }}" class="text-xs text-gray-400"></span>
            <div id="edit-folder-preview-{{ g.id }}" class="text-xs text-gray-400">{{ g.subdominio ~ '-assets' }}</div>
          </div>
          <label class="flex items-center gap-2"><input type="checkbox" name="disable_sync" /> <span class="text-sm text-gray-300">Desactivar sincronización obligatoria en esta edición</span></label>
          
          <div class="sm:col-span-2 flex justify-end"><button type="submit" class="px-3 py-2 rounded-md bg-primary text-primary-foreground">Guardar</button></div>
        </form>
      </div>
      <div class="flex items-center justify-between gap-2">
        <div class="flex items-center gap-2">
          <form hx-post="/admin/gyms/{{ g.id }}/provision" hx-headers='{"accept":"application/json"}' hx-swap="none" class="inline"><button type="submit" class="px-3 py-2 rounded-md bg-primary text-primary-foreground"><i class="fa-solid fa-cloud"></i><span class="ml-2">Provisionar</span></button></form>
          <button type="button" class="px-3 py-2 rounded-md bg-red-600 text-white" data-open-suspend="{{ g.id }}"><i class="fa-solid fa-pause"></i><span class="ml-2">Suspender</span></button>
          <form hx-post="/admin/gyms/{{ g.id }}/unsuspend" hx-headers='{"accept":"application/json"}' hx-swap="none" class="inline"><button type="submit" class="px-3 py-2 rounded-md bg-green-600 text-white"><i class="fa-solid fa-play"></i><span class="ml-2">Reactivar</span></button></form>
        </div>
        <div class="relative ml-auto">
          <button type="button" class="px-3 py-2 rounded-md bg-gray-900" x-on:click="more=!more">⋮ Más acciones</button>
          <div x-show="more" class="absolute right-0 mt-2 w-48 rounded-md border border-gray-800 bg-[#0b1222] z-10">
            <button type="button" class="w-full text-left px-3 py-2" data-open-details="{{ g.id }}"><i class="fa-solid fa-circle-info"></i><span class="ml-2">Ver detalles</span></button>
            <button type="button" class="w-full text-left px-3 py-2" x-on:click="edit=!edit"><i class="fa-solid fa-pen"></i><span class="ml-2">Editar</span></button>
            
            <form method="post" action="/admin/gyms/{{ g.id }}/delete" class="w-full needs-confirm" data-confirm="¿Eliminar gimnasio?"><button type="submit" class="w-full text-left px-3 py-2 text-red-500"><i class="fa-solid fa-trash"></i><span class="ml-2">Eliminar</span></button></form>
          </div>
        </div>
      </div>
      <div class="flex flex-wrap items-center gap-2">
        <a href="/admin/gyms/{{ g.id }}/subscription?ui=1" hx-headers='{"accept":"text/html"}' class="px-3 py-2 rounded-md bg-gray-900"><i class="fa-solid fa-ticket"></i><span class="ml-2">Subs</span></a>
        <a href="/admin/gyms/{{ g.id }}/payments?ui=1" hx-headers='{"accept":"text/html"}' class="px-3 py-2 rounded-md bg-gray-900"><i class="fa-solid fa-dollar-sign"></i><span class="ml-2">Pagos</span></a>
        <a href="/admin/gyms/{{ g.id }}/whatsapp?ui=1" hx-headers='{"accept":"text/html"}' class="px-3 py-2 rounded-md bg-gray-900"><i class="fa-brands fa-whatsapp"></i><span class="ml-2">Soporte</span></a>
        <a href="/admin/gyms/{{ g.id }}/health?ui=1" hx-headers='{"accept":"text/html"}' class="px-3 py-2 rounded-md bg-gray-900"><i class="fa-solid fa-stethoscope"></i><span class="ml-2">Salud</span></a>
      </div>
    </div>
    {% endfor %}
  </div>
  <script>
  (function(){var cards=document.querySelectorAll('#gyms-section [data-gym-id]');for(var i=0;i<cards.length;i++){var nd=String(cards[i].getAttribute('data-next-due')||'').trim();if(!nd)continue;var chip=cards[i].querySelector('[data-due-chip]');if(!chip)continue;var days=null;try{var d=new Date(nd+'T00:00:00Z');var now=new Date();days=Math.ceil((d-now)/86400000)}catch(_){days=null}if(days===null){chip.textContent='';chip.className='px-2 py-1 rounded-full text-xs';continue}if(days<0){chip.textContent='vencido';chip.className='px-2 py-1 rounded-full text-xs bg-red-600 text-white'}else{chip.textContent=String(days)+' días';if(days<=7){chip.className='px-2 py-1 rounded-full text-xs bg-yellow-500 text-black'}else{chip.className='px-2 py-1 rounded-full text-xs bg-gray-700 text-white'}}}})();
  </script>
  {% else %}
  <div id="gyms-section" class="overflow-x-auto rounded-xl border border-gray-800">
    <table class="w-full text-sm">
      <thead>
        <tr class="bg-gray-900">
          <th class="px-3 py-2 text-left">Sel</th>
          <th class="px-3 py-2 text-left"><a href="/admin/gyms?ui=1&q={{ q }}&status={{ status_q }}&order_by=id&order_dir={{ dir_next }}&view=table">ID</a></th>
          <th class="px-3 py-2 text-left"><a href="/admin/gyms?ui=1&q={{ q }}&status={{ status_q }}&order_by=nombre&order_dir={{ dir_next }}&view=table">Nombre</a></th>
          <th class="px-3 py-2 text-left"><a href="/admin/gyms?ui=1&q={{ q }}&status={{ status_q }}&order_by=subdominio&order_dir={{ dir_next }}&view=table">Subdominio</a></th>
          <th class="px-3 py-2 text-left"><a href="/admin/gyms?ui=1&q={{ q }}&status={{ status_q }}&order_by=created_at&order_dir={{ dir_next }}&view=table">Creado</a></th>
          <th class="px-3 py-2 text-left"><a href="/admin/gyms?ui=1&q={{ q }}&status={{ status_q }}&order_by=next_due_date&order_dir={{ dir_next }}&view=table">Vence</a></th>
          <th class="px-3 py-2 text-left">Teléfono</th>
          <th class="px-3 py-2 text-left"><a href="/admin/gyms?ui=1&q={{ q }}&status={{ status_q }}&order_by=status&order_dir={{ dir_next }}&view=table">Estado</a></th>
          <th class="px-3 py-2 text-left">Salud</th>
          <th class="px-3 py-2 text-left">Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for g in items %}
        <tr class="border-t border-gray-800" data-gym-id="{{ g.id }}" data-next-due="{{ g.next_due_date or '' }}" x-data="{ editRow:false }">
          <td class="px-3 py-2"><input type="checkbox" class="select-gym" value="{{ g.id }}" /></td>
          <td class="px-3 py-2">{{ g.id }}</td>
          <td class="px-3 py-2">
            <div id="row-name-{{ g.id }}" x-show="!editRow">{{ g.nombre }}</div>
            <input x-show="editRow" id="t-name-{{ g.id }}" name="nombre" value="{{ g.nombre }}" class="px-2 py-1 rounded-md border border-gray-700 bg-gray-950" />
          </td>
          <td class="px-3 py-2">
            <div id="row-sub-{{ g.id }}" x-show="!editRow">{{ g.subdominio }}</div>
            {% if g.webapp_url %}
            <div x-show="!editRow"><a id="row-url-{{ g.id }}" href="{{ g.webapp_url }}" target="_blank" rel="noopener" class="text-xs text-blue-400 hover:underline">{{ g.webapp_url }}</a></div>
            {% endif %}
            <div x-show="editRow" class="grid gap-2">
              <input id="t-sub-{{ g.id }}" name="subdominio" value="{{ g.subdominio }}" class="px-2 py-1 rounded-md border border-gray-700 bg-gray-950"
                     hx-get="/admin/subdomains/check" hx-trigger="input changed" hx-target="#t-sub-status-{{ g.id }}" hx-headers='{"accept":"text/html"}' hx-include="#t-name-{{ g.id }}, #t-sub-hidden-{{ g.id }}"
                     x-on:input="document.getElementById('t-sub-hidden-{{ g.id }}').value = $event.target.value" />
              <input type="hidden" id="t-sub-hidden-{{ g.id }}" name="sub" />
              <span id="t-sub-status-{{ g.id }}" class="text-xs text-gray-400"></span>
              <div id="t-folder-preview-{{ g.id }}" class="text-xs text-gray-400">{{ g.subdominio ~ '-assets' }}</div>
              <label class="flex items-center gap-2"><input type="checkbox" name="disable_sync" /> <span class="text-xs text-gray-300">Desactivar sincronización obligatoria</span></label>
              
            </div>
          </td>
          <td class="px-3 py-2">{{ g.created_at }}</td>
          <td class="px-3 py-2"><div class="flex items-center gap-2"><span>{{ g.next_due_date }}</span><span data-due-chip class="px-2 py-1 rounded-full text-xs"></span></div></td>
          <td class="px-3 py-2">
            <form hx-post="/admin/gyms/{{ g.id }}/contact" hx-headers='{"accept":"application/json"}' hx-trigger="submit" hx-swap="none" class="flex flex-wrap gap-2">
              <input name="owner_phone" value="{{ g.owner_phone }}" placeholder="+54..." class="px-2 py-1 rounded-md border border-gray-700 bg-gray-950 w-full md:w-40" />
              <button type="submit" class="px-2 py-1 rounded-md bg-gray-900">Guardar</button>
            </form>
          </td>
          <td class="px-3 py-2">
            <span class="px-2 py-1 rounded-md {{ 'bg-green-600 text-white' if g.status=='active' else ('bg-red-600 text-white' if g.status=='suspended' else ('bg-yellow-500 text-black' if g.status=='maintenance' else 'bg-gray-700 text-white')) }}">{{ g.status }}</span>
          </td>
          <td class="px-3 py-2">
            <div id="health-{{ g.id }}" hx-get="/admin/gyms/{{ g.id }}/health?snippet=1" hx-headers='{"accept":"text/html"}' hx-trigger="revealed delay:300ms throttle:500ms" hx-target="this" hx-select="*" hx-swap="innerHTML" hx-push-url="false" class="flex gap-2 items-center">
              <div class="skeleton w-24 h-3 rounded-md"></div>
            </div>
          </td>
          <td class="px-3 py-2">
            <div class="flex flex-wrap gap-2">
              <button type="button" class="px-2 py-1 rounded-md bg-gray-900" x-on:click="editRow=!editRow" title="Editar"><i class="fa-solid fa-pen"></i></button>
              <form hx-post="/admin/gyms/{{ g.id }}/provision" hx-headers='{"accept":"application/json"}' hx-swap="none" class="inline"><button type="submit" class="px-2 py-1 rounded-md bg-primary text-primary-foreground" title="Provisionar"><i class="fa-solid fa-cloud"></i></button></form>
              <button type="button" class="px-2 py-1 rounded-md bg-red-600 text-white" data-open-suspend="{{ g.id }}" title="Suspender"><i class="fa-solid fa-pause"></i></button>
              <form hx-post="/admin/gyms/{{ g.id }}/unsuspend" hx-headers='{"accept":"application/json"}' hx-swap="none" class="inline"><button type="submit" class="px-2 py-1 rounded-md bg-green-600 text-white" title="Reactivar"><i class="fa-solid fa-play"></i></button></form>
              <a href="/admin/gyms/{{ g.id }}/subscription?ui=1" hx-headers='{"accept":"text/html"}' class="px-2 py-1 rounded-md bg-gray-900" title="Suscripción"><i class="fa-solid fa-ticket"></i></a>
              <a href="/admin/gyms/{{ g.id }}/payments?ui=1" hx-headers='{"accept":"text/html"}' class="px-2 py-1 rounded-md bg-gray-900" title="Pagos"><i class="fa-solid fa-dollar-sign"></i></a>
              <a href="/admin/gyms/{{ g.id }}/whatsapp?ui=1" hx-headers='{"accept":"text/html"}' class="px-2 py-1 rounded-md bg-gray-900" title="WhatsApp"><i class="fa-brands fa-whatsapp"></i></a>
              <a href="/admin/gyms/{{ g.id }}/maintenance?ui=1" hx-headers='{"accept":"text/html"}' class="px-2 py-1 rounded-md bg-gray-900" title="Mantenimiento"><i class="fa-solid fa-wrench"></i></a>
              <a href="/admin/gyms/{{ g.id }}/branding?ui=1" hx-headers='{"accept":"text/html"}' class="px-2 py-1 rounded-md bg-gray-900" title="Branding"><i class="fa-solid fa-palette"></i></a>
              <a href="/admin/gyms/{{ g.id }}/owner?ui=1" hx-headers='{"accept":"text/html"}' class="px-2 py-1 rounded-md bg-gray-900" title="Contraseña dueño"><i class="fa-solid fa-key"></i></a>
              <a href="/admin/gyms/{{ g.id }}/health?ui=1" hx-headers='{"accept":"text/html"}' class="px-2 py-1 rounded-md bg-gray-900" title="Salud"><i class="fa-solid fa-stethoscope"></i></a>
              <form method="post" action="/admin/gyms/{{ g.id }}/delete" class="inline needs-confirm" data-confirm="¿Eliminar gimnasio?"><button type="submit" class="px-2 py-1 rounded-md bg-red-600 text-white" title="Eliminar gimnasio"><i class="fa-solid fa-trash"></i></button></form>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <script>
  (function(){var rows=document.querySelectorAll('#gyms-section tbody [data-next-due]');for(var i=0;i<rows.length;i++){var nd=String(rows[i].getAttribute('data-next-due')||'').trim();if(!nd)continue;var chip=rows[i].querySelector('[data-due-chip]');if(!chip)continue;var days=null;try{var d=new Date(nd+'T00:00:00Z');var now=new Date();days=Math.ceil((d-now)/86400000)}catch(_){days=null}if(days===null){chip.textContent='';chip.className='px-2 py-1 rounded-full text-xs';continue}if(days<0){chip.textContent='vencido';chip.className='px-2 py-1 rounded-full text-xs bg-red-600 text-white'}else{chip.textContent=String(days)+' días';if(days<=7){chip.className='px-2 py-1 rounded-full text-xs bg-yellow-500 text-black'}else{chip.className='px-2 py-1 rounded-full text-xs bg-gray-700 text-white'}}}})();
  </script>
  {% endif %}
    <div class="mt-3 flex flex-wrap items-center gap-3">
      <a id="prev-link" href="{{ prev_link }}" hx-headers='{"accept":"text/html"}' class="px-3 py-2 rounded-md bg-gray-900">Anterior</a>
      <a id="next-link" href="{{ next_link }}" hx-headers='{"accept":"text/html"}' class="px-3 py-2 rounded-md bg-gray-900">Siguiente</a>
      <div class="text-gray-400">Página {{ page }} de {{ last_page }} · {{ total }} resultados</div>
      <div class="ml-auto text-gray-400">Seleccionados: <span id="sel-count">0</span></div>
      <div class="flex flex-wrap gap-2">
        <input type="hidden" id="selected-ids" />
        <button id="batch-prov" class="px-3 py-2 rounded-md bg-primary text-primary-foreground">Provisionar</button>
        <button id="batch-sus" class="px-3 py-2 rounded-md bg-red-600 text-white">Suspender</button>
        <button id="batch-uns" class="px-3 py-2 rounded-md bg-green-600 text-white">Reactivar</button>
        <input id="batch-message" placeholder="Mensaje recordatorio" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950 w-full sm:min-w-[280px]" />
        <button id="batch-remind" class="px-3 py-2 rounded-md bg-primary text-primary-foreground">Recordar</button>
        <button id="batch-remind-clear" class="px-3 py-2 rounded-md bg-gray-800 text-white">Quitar recordatorio</button>
        <input id="batch-maint-message" placeholder="Mensaje mantenimiento" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950 w-full sm:min-w-[280px]" />
        <button id="batch-maint" class="px-3 py-2 rounded-md bg-yellow-500 text-black">Aviso mant.</button>
        <button id="batch-select-all" class="px-3 py-2 rounded-md bg-gray-900" title="Seleccionar todos">Seleccionar todo</button>
        <button id="batch-clear" class="px-3 py-2 rounded-md bg-gray-900" title="Limpiar selección">Limpiar</button>
      </div>
    </div>
  <div class="fixed bottom-4 right-4">
    <button id="open-k-float" class="px-3 py-2 rounded-full bg-gray-700 text-white" onclick="window.openGlobalK && window.openGlobalK()">Ctrl+K</button>
  </div>
  <div id="details-overlay" role="dialog" aria-modal="true" aria-labelledby="details-title" aria-describedby="details-content" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/60" tabindex="-1">
    <div class="relative p-0 w-full h-full overflow-hidden">
      <div class="relative bg-gray-900 border border-gray-800 shadow w-full h-full flex flex-col">
        <div class="flex items-center justify-between p-3 border-b border-gray-800">
          <div class="flex items-center gap-4">
            <h3 id="details-title" class="text-base font-semibold text-white">Detalles del gimnasio</h3>
            <div id="details-health" class="flex items-center gap-2"></div>
          </div>
          <button id="details-close" class="px-2 py-1 rounded-md bg-gray-800">Cerrar</button>
        </div>
        <div id="details-content" class="p-3 text-gray-200 text-sm grid grid-cols-1 xl:grid-cols-3 gap-4 h-full overflow-auto"></div>
      </div>
    </div>
  </div>
  <div id="create-modal" role="dialog" aria-modal="true" aria-labelledby="create-title" tabindex="-1" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60">
    <div class="relative p-4 w-full max-w-lg max-h-[85vh] overflow-auto">
      <div class="relative bg-gray-900 rounded-lg border border-gray-800 shadow">
        <div class="flex items-center justify-between p-3 border-b border-gray-800">
          <h3 id="create-title" class="text-base font-semibold text-white">Crear gimnasio</h3>
          <button id="create-cancel" class="px-2 py-1 rounded-md bg-gray-800">Cerrar</button>
        </div>
        <form hx-post="/admin/gyms" hx-headers='{"accept":"application/json"}' hx-swap="none" class="p-3 grid gap-2">
          <label for="create-name" class="text-sm text-gray-300">Nombre</label>
          <input id="create-name" name="nombre" required minlength="2" maxlength="80" autocomplete="off" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
          <label for="create-sub" class="text-sm text-gray-300">Subdominio</label>
          <input id="create-sub" name="subdominio" pattern="^[a-z0-9-]{1,63}$" title="Solo letras minúsculas, números y guiones" autocomplete="off" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950"
                 hx-get="/admin/subdomains/check" hx-trigger="input changed" hx-target="#create-sub-status" hx-headers='{"accept":"text/html"}' hx-include="#create-name, #create-sub-hidden" x-on:input="document.getElementById('create-sub-hidden').value = $event.target.value" />
          <input type="hidden" id="create-sub-hidden" name="sub" />
          <span id="create-sub-status" class="text-xs text-gray-400"></span>
          <div id="create-bucket" class="text-xs text-gray-400"></div>
          
          <label for="create-owner-phone" class="text-sm text-gray-300">Teléfono dueño</label>
          <input id="create-owner-phone" name="owner_phone" pattern="^\+?[0-9]{7,15}$" inputmode="tel" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
          <details class="rounded-md border border-gray-800">
            <summary class="cursor-pointer px-3 py-2 text-sm text-gray-300 bg-gray-900 rounded-md">Configuración de WhatsApp (avanzado)</summary>
            <div class="p-3 grid gap-2">
              <label for="create-whatsapp-phone-id" class="text-sm text-gray-300">WhatsApp Phone ID</label>
              <input id="create-whatsapp-phone-id" name="whatsapp_phone_id" autocomplete="off" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
              <label for="create-whatsapp-access-token" class="text-sm text-gray-300">WhatsApp Access Token</label>
              <input id="create-whatsapp-access-token" name="whatsapp_access_token" autocomplete="off" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
              <label for="create-waba-id" class="text-sm text-gray-300">WABA ID</label>
              <input id="create-waba-id" name="whatsapp_business_account_id" autocomplete="off" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
              <label for="create-whatsapp-verify-token" class="text-sm text-gray-300">Verify Token</label>
              <input id="create-whatsapp-verify-token" name="whatsapp_verify_token" autocomplete="off" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
              <label for="create-app-secret" class="text-sm text-gray-300">App Secret</label>
              <input id="create-app-secret" name="whatsapp_app_secret" autocomplete="off" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
              <label class="flex items-center gap-2"><input type="checkbox" name="whatsapp_nonblocking" /><span class="text-sm text-gray-300">Envío no bloqueante</span></label>
              <label for="create-whatsapp-timeout" class="text-sm text-gray-300">Timeout de envío (segundos)</label>
              <input id="create-whatsapp-timeout" name="whatsapp_send_timeout_seconds" type="number" min="1" max="120" step="1" value="25" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
            </div>
          </details>
          <div class="flex justify-end gap-2">
            <button type="button" id="create-cancel-2" class="px-3 py-2 rounded-md bg-gray-900">Cancelar</button>
            <button type="submit" class="px-3 py-2 rounded-md bg-primary text-primary-foreground">Crear</button>
          </div>
        </form>
        <script>
          
        </script>
      </div>
    </div>
  </div>
  <div id="suspend-modal" role="dialog" aria-modal="true" aria-labelledby="suspend-title" tabindex="-1" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60">
    <div class="relative p-4 w-full max-w-md max-h-[85vh] overflow-auto">
      <div class="relative bg-gray-900 rounded-lg border border-gray-800 shadow">
        <div class="flex items-center justify-between p-3 border-b border-gray-800">
          <h3 id="suspend-title" class="text-base font-semibold text-white">Suspender gimnasio</h3>
          <button id="suspend-cancel" class="px-2 py-1 rounded-md bg-gray-800">Cerrar</button>
        </div>
        <div class="p-3 grid gap-2">
          <label for="suspend-reason" class="text-sm text-gray-300">Razón</label>
          <input id="suspend-reason" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
          <label for="suspend-until" class="text-sm text-gray-300">Hasta</label>
          <input id="suspend-until" type="date" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
          <label class="flex items-center gap-2"><input id="suspend-hard" type="checkbox" /><span class="text-gray-300 text-sm">Hard suspend</span></label>
        </div>
        <div class="p-3 flex justify-end gap-2">
          <button id="suspend-cancel-2" class="px-2 py-1 rounded-md bg-gray-800">Cancelar</button>
          <button id="suspend-yes" class="px-2 py-1 rounded-md bg-red-600 text-white">Suspender</button>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    (function(){
    
    
    var toast = window.toast || function(){};
    var selected=new Set();function updateSel(){var c=document.getElementById('sel-count');if(c){c.textContent=String(selected.size)}var hid=document.getElementById('selected-ids');if(hid){hid.value=Array.from(selected).join(',')}}
    var boxes=document.querySelectorAll('.select-gym');for(var i=0;i<boxes.length;i++){boxes[i].addEventListener('change',function(){var v=this.value;if(this.checked){selected.add(v)}else{selected.delete(v)}updateSel()})}
    function selectAll(){var boxes=document.querySelectorAll('.select-gym');selected.clear();for(var i=0;i<boxes.length;i++){boxes[i].checked=true;selected.add(boxes[i].value)}updateSel()}
    function clearSel(){var boxes=document.querySelectorAll('.select-gym');for(var i=0;i<boxes.length;i++){boxes[i].checked=false}selected.clear();updateSel()}
    var bsa=document.getElementById('batch-select-all');if(bsa){bsa.addEventListener('click',selectAll)}var bcl=document.getElementById('batch-clear');if(bcl){bcl.addEventListener('click',clearSel)}
    var subs=document.querySelectorAll('[data-sub]');for(var j=0;j<subs.length;j++){subs[j].addEventListener('click',function(){var tx=this.getAttribute('data-sub')||'';if(navigator.clipboard&&navigator.clipboard.writeText){navigator.clipboard.writeText(tx).then(function(){toast('Copiado: '+tx,'info')}).catch(function(){toast('No se pudo copiar','error')})}else{toast(tx,'info')}})}
    var _pref='';
    function runBatch(action){if(selected.size===0){toast('No hay seleccionados','info');return}var form=new URLSearchParams();form.append('action',action);form.append('gym_ids',Array.from(selected).join(','));var pref=(window.apiPref?window.apiPref():'');return fetch(pref+'/admin/gyms/batch',{method:'POST',headers:{'accept':'application/json','content-type':'application/x-www-form-urlencoded'},body:form.toString()}).then(function(r){return r.json().then(function(j){return {ok:r.ok,body:j}})}).then(function(res){if(res.ok&&res.body&&res.body.ok){toast('Acción '+action+' aplicada','success');refreshGymsList()}else{toast('Error en lote','error')}}).catch(function(){toast('Error de red','error')})}
    function runRemindBatch(){if(selected.size===0){toast('No hay seleccionados','info');return}var msgEl=document.getElementById('batch-message');var form=new URLSearchParams();form.append('gym_ids',Array.from(selected).join(','));form.append('message',msgEl?String(msgEl.value||''):'');var pref=(window.apiPref?window.apiPref():'');return fetch(pref+'/admin/gyms/remind/batch',{method:'POST',headers:{'accept':'application/json','content-type':'application/x-www-form-urlencoded'},body:form.toString()}).then(function(r){return r.json().then(function(j){return {ok:r.ok,body:j}})}).then(function(res){if(res.ok&&res.body&&res.body.ok){var results=Array.isArray(res.body.results)?res.body.results:[];var okc=results.filter(function(x){return !!x&&!!x.ok}).length;var fail=results.length-okc;toast('Recordatorios enviados: '+okc+' · Fallidos: '+fail,'success');refreshGymsList()}else{var msg=(res&&res.body&&res.body.error)?String(res.body.error):'Error al enviar recordatorios';toast(msg,'error')}}).catch(function(){toast('Error de red','error')})}
    function runRemindClearBatch(){if(selected.size===0){toast('No hay seleccionados','info');return}var form=new URLSearchParams();form.append('gym_ids',Array.from(selected).join(','));var pref=(window.apiPref?window.apiPref():'');return fetch(pref+'/admin/gyms/remind/clear/batch',{method:'POST',headers:{'accept':'application/json','content-type':'application/x-www-form-urlencoded'},body:form.toString()}).then(function(r){return r.json().then(function(j){return {ok:r.ok,body:j}})}).then(function(res){if(res.ok&&res.body&&res.body.ok){var results=Array.isArray(res.body.results)?res.body.results:[];var okc=results.filter(function(x){return !!x&&!!x.ok}).length;var fail=results.length-okc;toast('Recordatorios quitados: '+okc+' · Fallidos: '+fail,'success');refreshGymsList()}else{var msg=(res&&res.body&&res.body.error)?String(res.body.error):'Error al quitar recordatorios';toast(msg,'error')}}).catch(function(){toast('Error de red','error')})}
    function runMaintBatch(){if(selected.size===0){toast('No hay seleccionados','info');return}var msgEl=document.getElementById('batch-maint-message');var form=new URLSearchParams();form.append('gym_ids',Array.from(selected).join(','));form.append('message',msgEl?String(msgEl.value||''):'');var pref=(window.apiPref?window.apiPref():'');return fetch(pref+'/admin/gyms/maintenance/notify/batch',{method:'POST',headers:{'accept':'application/json','content-type':'application/x-www-form-urlencoded'},body:form.toString()}).then(function(r){return r.json().then(function(j){return {ok:r.ok,body:j}})}).then(function(res){if(res.ok&&res.body&&res.body.ok){var results=Array.isArray(res.body.results)?res.body.results:[];var okc=results.filter(function(x){return !!x&&!!x.ok}).length;var fail=results.length-okc;toast('Avisos de mantenimiento enviados: '+okc+' · Fallidos: '+fail,'success');refreshGymsList()}else{var msg=(res&&res.body&&res.body.error)?String(res.body.error):'Error al enviar avisos';toast(msg,'error')}}).catch(function(){toast('Error de red','error')})}
    function withBtn(btn,fn){if(!btn)return;btn.setAttribute('disabled','disabled');var p=null;try{p=fn()}catch(_){ }if(p&&p.finally){p.finally(function(){btn.removeAttribute('disabled')})}else{btn.removeAttribute('disabled')}}
    function openDetails(gid){openDetails3(gid)}
    function haloDue(){var cards=document.querySelectorAll('[data-next-due]');var now=new Date();for(var i=0;i<cards.length;i++){var nd=cards[i].getAttribute('data-next-due')||'';if(!nd)continue;var d=new Date(nd);if(isNaN(d.getTime()))continue;var diff=Math.round((d.getTime()-now.getTime())/86400000);if(diff<=3){cards[i].classList.remove('border-gray-800');cards[i].classList.add('border-red-600')}else if(diff<=7){cards[i].classList.remove('border-gray-800');cards[i].classList.add('border-yellow-500')}}}
    haloDue()
    var createOverlay=document.getElementById('create-modal');var createOpen=document.getElementById('open-create');var createOpen2=document.getElementById('open-create-2');var createCancel=document.getElementById('create-cancel');var createCancel2=document.getElementById('create-cancel-2');function openCreate(){if(createOverlay){createOverlay.classList.remove('hidden');document.body.classList.add('overflow-hidden');var nm=document.querySelector('#create-modal [name="nombre"]');if(nm){setTimeout(function(){nm.focus()},10)}}}function closeCreate(){if(createOverlay){createOverlay.classList.add('hidden');document.body.classList.remove('overflow-hidden')}}if(createOpen){createOpen.addEventListener('click',openCreate)}if(createOpen2){createOpen2.addEventListener('click',openCreate)}if(createCancel){createCancel.addEventListener('click',closeCreate)}if(createCancel2){createCancel2.addEventListener('click',closeCreate)}if(createOverlay){createOverlay.addEventListener('click',function(e){if(e.target===createOverlay){closeCreate()}})}
    if(detailsClose){detailsClose.addEventListener('click',function(){if(detailsOverlay){detailsOverlay.classList.add('hidden');document.body.classList.remove('overflow-hidden');try{var u=new URL(window.location.href);u.searchParams.delete('modal');u.searchParams.delete('gid');history.pushState({},'',u.toString())}catch(_){}}})}
    var od=document.querySelectorAll('[data-open-details]');for(var i=0;i<od.length;i++){od[i].addEventListener('click',function(){var gid=this.getAttribute('data-open-details');openDetails3(gid)})}
    var suspendOverlay=document.getElementById('suspend-modal');var suspendCancel=document.getElementById('suspend-cancel');var suspendCancel2=document.getElementById('suspend-cancel-2');var suspendYes=document.getElementById('suspend-yes');var suspendReason=document.getElementById('suspend-reason');var suspendUntil=document.getElementById('suspend-until');var suspendHard=document.getElementById('suspend-hard');var suspendGymId=null;function openSuspend(gid){suspendGymId=gid;if(suspendOverlay){suspendOverlay.classList.remove('hidden');document.body.classList.add('overflow-hidden');if(suspendReason){setTimeout(function(){suspendReason.focus()},10)}}}function closeSuspend(){suspendGymId=null;if(suspendOverlay){suspendOverlay.classList.add('hidden');document.body.classList.remove('overflow-hidden')}}function submitSuspend(){if(!suspendGymId){closeSuspend();return}var form=new URLSearchParams();form.append('reason',String(suspendReason.value||''));form.append('until',String(suspendUntil.value||''));form.append('hard',suspendHard.checked?'true':'false');var pref=(window.apiPref?window.apiPref():'');fetch(pref+'/admin/gyms/'+suspendGymId+'/suspend',{method:'POST',headers:{'accept':'application/json','content-type':'application/x-www-form-urlencoded'},body:form.toString()}).then(function(r){return r.json().then(function(j){return {ok:r.ok,body:j}})}).then(function(res){if(res.ok&&res.body&&res.body.ok){toast('Gimnasio suspendido','success');refreshGymUI(suspendGymId);refreshHealth(suspendGymId)}else{toast('Error al suspender','error')}}).catch(function(){toast('Error de red','error')}).finally(function(){closeSuspend()})}
    if(suspendCancel){suspendCancel.addEventListener('click',closeSuspend)}if(suspendCancel2){suspendCancel2.addEventListener('click',closeSuspend)}if(suspendYes){suspendYes.addEventListener('click',submitSuspend)}var os=document.querySelectorAll('[data-open-suspend]');for(var i=0;i<os.length;i++){os[i].addEventListener('click',function(){var gid=this.getAttribute('data-open-suspend');openSuspend(gid)})}
    var bp=document.getElementById('batch-prov');if(bp){bp.addEventListener('click',function(){var self=this;var f=function(){withBtn(self,function(){return runBatch('provision')})};if(window.confirmAction){window.confirmAction('¿Provisionar seleccionados?',f)}else{f()}})}
    var bs=document.getElementById('batch-sus');if(bs){bs.addEventListener('click',function(){var self=this;var f=function(){withBtn(self,function(){return runBatch('suspend')})};if(window.confirmAction){window.confirmAction('¿Suspender seleccionados?',f)}else{f()}})}
    var bu=document.getElementById('batch-uns');if(bu){bu.addEventListener('click',function(){var self=this;var f=function(){withBtn(self,function(){return runBatch('unsuspend')})};if(window.confirmAction){window.confirmAction('¿Reactivar seleccionados?',f)}else{f()}})}
    var br=document.getElementById('batch-remind');if(br){br.addEventListener('click',function(){var self=this;var f=function(){withBtn(self,function(){return runRemindBatch()})};if(window.confirmAction){window.confirmAction('¿Enviar recordatorio?',f)}else{f()}})}
    var brc=document.getElementById('batch-remind-clear');if(brc){brc.addEventListener('click',function(){var self=this;var f=function(){withBtn(self,function(){return runRemindClearBatch()})};if(window.confirmAction){window.confirmAction('¿Quitar recordatorio?',f)}else{f()}})}
    var bm=document.getElementById('batch-maint');if(bm){bm.addEventListener('click',function(){var self=this;var f=function(){withBtn(self,function(){return runMaintBatch()})};if(window.confirmAction){window.confirmAction('¿Enviar aviso de mantenimiento?',f)}else{f()}})}
    var ok=document.getElementById('open-k');var okf=document.getElementById('open-k-float');
    if(ok){ok.addEventListener('click',function(){if(window.openGlobalK){window.openGlobalK()}})}
    if(okf){okf.addEventListener('click',function(){if(window.openGlobalK){window.openGlobalK()}})}
    function refreshHealth(gid){var mini=document.getElementById('health-mini-'+gid);var pref=(window.apiPref?window.apiPref():'');if(mini){fetch(pref+'/admin/gyms/'+gid+'/health?snippet=1',{headers:{'accept':'text/html'}}).then(function(r){return r.text()}).then(function(html){mini.innerHTML=html}).catch(function(){})}var full=document.getElementById('health-'+gid);if(full){fetch(pref+'/admin/gyms/'+gid+'/health?snippet=1',{headers:{'accept':'text/html'}}).then(function(r){return r.text()}).then(function(html){full.innerHTML=html}).catch(function(){})}
    }
    function refreshGymUI(gid){var pref=(window.apiPref?window.apiPref():'');fetch(pref+'/admin/gyms/'+gid+'/details',{headers:{'accept':'application/json'}}).then(function(r){return r.json()}).then(function(j){var d=(j&&j.gym)||{};var nameEl=document.getElementById('gym-name-'+gid);if(nameEl){nameEl.textContent=String(d.nombre||'')}var subBtn=document.getElementById('gym-sub-'+gid);if(subBtn){subBtn.textContent=String(d.subdominio||'');subBtn.setAttribute('data-sub',String(d.subdominio||''))}var urlEl=document.getElementById('gym-url-'+gid);if(urlEl){var w=String((j&&j.webapp_url)||'');if(w){urlEl.textContent=w;urlEl.setAttribute('href',w);urlEl.style.display=''}else{urlEl.textContent='';urlEl.removeAttribute('href');urlEl.style.display='none'}}var fEl=document.getElementById('gym-folder-'+gid);if(fEl){fEl.textContent=String(d.assets_folder_prefix||'')}var st=document.getElementById('status-badge-'+gid);if(st){var s=String(d.status||'');st.textContent=s;st.className='px-2 py-1 rounded-full text-xs '+(s==='active'?'bg-green-600 text-white':(s==='suspended'?'bg-red-600 text-white':(s==='maintenance'?'bg-yellow-500 text-black':'bg-gray-700 text-white')))}var rn=document.getElementById('row-name-'+gid);if(rn){rn.textContent=String(d.nombre||'')}var rs=document.getElementById('row-sub-'+gid);if(rs){rs.textContent=String(d.subdominio||'')}var rurl=document.getElementById('row-url-'+gid);if(rurl){var w2=String((j&&j.webapp_url)||'');if(w2){rurl.textContent=w2;rurl.setAttribute('href',w2);rurl.style.display=''}else{rurl.textContent='';rurl.removeAttribute('href');rurl.style.display='none'}}}).catch(function(){})}
    function refreshGymsList(){var url=new URL(window.location.href);url.searchParams.set('ui','1');url.searchParams.set('snippet','1');fetch(url.toString(),{headers:{'accept':'text/html'}}).then(function(r){return r.text()}).then(function(html){try{var doc=new DOMParser().parseFromString(html,'text/html');var next=doc.querySelector('#gyms-section');var cur=document.querySelector('#gyms-section');if(next&&cur){cur.innerHTML=next.innerHTML;rebindGymsInteractions();haloDue()}}catch(_){}}).catch(function(){})}
    function rebindGymsInteractions(){
      var boxes=document.querySelectorAll('.select-gym');
      for(var i=0;i<boxes.length;i++){
        boxes[i].addEventListener('change',function(){
          var v=this.value;
          if(this.checked){selected.add(v)}else{selected.delete(v)}
          updateSel()
        })
      }
      var od=document.querySelectorAll('[data-open-details]');
      for(var j=0;j<od.length;j++){
        od[j].addEventListener('click',function(){
          var gid=this.getAttribute('data-open-details');
          openDetails3(gid)
        })
      }
      var bp=document.getElementById('batch-prov');
      if(bp){bp.addEventListener('click',function(){var self=this;var f=function(){withBtn(self,function(){return runBatch('provision')})};if(window.confirmAction){window.confirmAction('¿Provisionar seleccionados?',f)}else{f()}})}
      var bs=document.getElementById('batch-sus');
      if(bs){bs.addEventListener('click',function(){var self=this;var f=function(){withBtn(self,function(){return runBatch('suspend')})};if(window.confirmAction){window.confirmAction('¿Suspender seleccionados?',f)}else{f()}})}
      var bu=document.getElementById('batch-uns');
      if(bu){bu.addEventListener('click',function(){var self=this;var f=function(){withBtn(self,function(){return runBatch('unsuspend')})};if(window.confirmAction){window.confirmAction('¿Reactivar seleccionados?',f)}else{f()}})}
      var br=document.getElementById('batch-remind');
      if(br){br.addEventListener('click',function(){var self=this;var f=function(){withBtn(self,function(){return runRemindBatch()})};if(window.confirmAction){window.confirmAction('¿Enviar recordatorio?',f)}else{f()}})}
      var bm=document.getElementById('batch-maint');
      if(bm){bm.addEventListener('click',function(){var self=this;var f=function(){withBtn(self,function(){return runMaintBatch()})};if(window.confirmAction){window.confirmAction('¿Enviar aviso de mantenimiento?',f)}else{f()}})}
      try{
        var pref='';
        var cards=document.querySelectorAll('[data-gym-id]');
        for(var i=0;i<cards.length;i++){
          var gid=String(cards[i].getAttribute('data-gym-id')||'');
          if(!gid)continue;
          var nId='edit-name-'+gid;
          var sId='edit-sub-'+gid;
          var stId='edit-sub-status-'+gid;
          var bId='edit-folder-preview-'+gid;
          if(window.bindSubdomainBucket){window.bindSubdomainBucket(nId,sId,stId,bId,pref)}
        }
        var rows=document.querySelectorAll('tr[data-gym-id]');
        for(var j=0;j<rows.length;j++){
          var rgid=String(rows[j].getAttribute('data-gym-id')||'');
          if(!rgid)continue;
          var tnId='t-name-'+rgid;
          var tsId='t-sub-'+rgid;
          var tstId='t-sub-status-'+rgid;
          var tbId='t-folder-preview-'+rgid;
          if(window.bindSubdomainBucket){window.bindSubdomainBucket(tnId,tsId,tstId,tbId,pref)}
        }
        var cName=document.getElementById('create-name');
        var cSub=document.getElementById('create-sub');
        
      }catch(_){}
    }
    document.body.addEventListener('htmx:afterOnLoad',function(evt){try{var xhr=evt.detail.xhr;var ct=(xhr&&xhr.getResponseHeader)?(xhr.getResponseHeader('content-type')||''):'';if(ct.indexOf('application/json')===-1){return}var txt=xhr&&xhr.responseText||'';var j=null;try{j=JSON.parse(txt)}catch(_){j=null}var el=evt.target;var act=el&&el.getAttribute('action')||el&&el.getAttribute('hx-post')||'';if(j&&j.ok){if(act==='/admin/gyms'){toast('Gimnasio creado','success');closeCreate();refreshGymsList()}else{var m=act.match(/\/admin\/gyms\/(\d+)(\/\w+)?/);if(m&&m[1]){var gid=m[1];toast('Guardado','success');var op=m[2]||'';if(op.indexOf('/update')===0){refreshGymsList()}else{refreshGymUI(gid);refreshHealth(gid)}}else{toast('Guardado','success')}}}else{toast('Error','error')}}catch(_){}});
    if(inp){inp.addEventListener('input',function(){searchK(inp.value)})}
    document.addEventListener('keydown',function(e){if(e.key==='Escape'){var det=document.getElementById('details-overlay');if(det&&!det.classList.contains('hidden')){var dc=document.getElementById('details-close');if(dc){dc.click()}}if(createOverlay&&!createOverlay.classList.contains('hidden')){var cc=document.getElementById('create-cancel');if(cc){cc.click()}}if(suspendOverlay&&!suspendOverlay.classList.contains('hidden')){var sc=document.getElementById('suspend-cancel');if(sc){sc.click()}}}});
    try{var u=new URL(window.location.href);var m=u.searchParams.get('modal')||'';var gid=u.searchParams.get('gid')||'';if(m==='details'&&gid){openDetails3(gid)}window.addEventListener('popstate',function(){try{var u2=new URL(window.location.href);var m2=u2.searchParams.get('modal')||'';var gid2=u2.searchParams.get('gid')||'';var det=document.getElementById('details-overlay');if(m2==='details'&&gid2){openDetails3(gid2)}else{if(det){det.classList.add('hidden');document.body.classList.remove('overflow-hidden')}}}catch(_){}})}catch(_){}
    document.addEventListener('keydown',function(e){var k=e.key.toLowerCase();if((e.ctrlKey||e.metaKey)&&k==='k'){var o=document.getElementById('global-open-k');if(o){e.preventDefault();o.click();return}}if(k==='['){var link=document.getElementById('prev-link');if(link){link.click()}}if(k===']'){var link2=document.getElementById('next-link');if(link2){link2.click()}}if(k==='a'){e.preventDefault();var bsa=document.getElementById('batch-select-all');if(bsa){bsa.click()}}if(k==='c'){e.preventDefault();var bcl=document.getElementById('batch-clear');if(bcl){bcl.click()}}if(k==='r'){e.preventDefault();var br=document.getElementById('batch-remind');if(br){br.click()}}if(k==='p'){e.preventDefault();var bp=document.getElementById('batch-prov');if(bp){bp.click()}}if(k==='s'){e.preventDefault();var bs=document.getElementById('batch-sus');if(bs){bs.click()}}if(k==='u'){e.preventDefault();var bu=document.getElementById('batch-uns');if(bu){bu.click()}}if(k==='m'){e.preventDefault();var bm=document.getElementById('batch-maint');if(bm){bm.click()}}});
    })();
  </script>
</div>
{% endblock %}
