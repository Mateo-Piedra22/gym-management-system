{% extends "base.html" %}
{% set _ = '' %}
{% block content %}
  <div class="space-y-4">
    <h1 class="text-2xl font-semibold">Gimnasios</h1>
    
    <div class="flex flex-wrap gap-3 items-center">
    <button id="open-actions" class="px-3 py-2 rounded-md bg-primary text-primary-foreground">Acciones</button>
    <form method="get" action="/gyms" class="flex flex-wrap gap-2">
      <input name="q" value="{{ q }}" placeholder="Buscar por nombre o subdominio" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950 w-full sm:min-w-[240px] sm:w-auto min-w-0" />
      <select name="status" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950">
        <option value="">Todos</option>
        <option value="active"{% if status_q=='active' %} selected{% endif %}>Activos</option>
        <option value="suspended"{% if status_q=='suspended' %} selected{% endif %}>Suspendidos</option>
        <option value="maintenance"{% if status_q=='maintenance' %} selected{% endif %}>Mantenimiento</option>
      </select>
      <select name="order_by" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950">
        <option value="id">ID</option>
        <option value="created_at">Creado</option>
        <option value="nombre">Nombre</option>
        <option value="subdominio">Subdominio</option>
        <option value="status">Estado</option>
      </select>
      <select name="order_dir" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950">
        <option value="DESC">Desc</option>
        <option value="ASC">Asc</option>
      </select>
      <input type="hidden" name="ui" value="1" />
      <button type="submit" class="px-3 py-2 rounded-md bg-primary text-primary-foreground">Filtrar</button>
    </form>
    <div class="flex flex-wrap items-center gap-2">
      <span class="text-sm text-gray-400">Estado:</span>
      <a href="/gyms?ui=1&q={{ q }}&status=&order_by={{ order_by }}&order_dir={{ order_dir }}&view={{ view or 'cards' }}" hx-headers='{"accept":"text/html"}' class="px-2 py-1 rounded-md {{ 'bg-primary text-primary-foreground' if not status_q else 'bg-gray-900' }}">Todos</a>
      <a href="/gyms?ui=1&q={{ q }}&status=active&order_by={{ order_by }}&order_dir={{ order_dir }}&view={{ view or 'cards' }}" hx-headers='{"accept":"text/html"}' class="px-2 py-1 rounded-md {{ 'bg-primary text-primary-foreground' if status_q=='active' else 'bg-gray-900' }}">Activos</a>
      <a href="/gyms?ui=1&q={{ q }}&status=suspended&order_by={{ order_by }}&order_dir={{ order_dir }}&view={{ view or 'cards' }}" hx-headers='{"accept":"text/html"}' class="px-2 py-1 rounded-md {{ 'bg-primary text-primary-foreground' if status_q=='suspended' else 'bg-gray-900' }}">Suspendidos</a>
      <a href="/gyms?ui=1&q={{ q }}&status=maintenance&order_by={{ order_by }}&order_dir={{ order_dir }}&view={{ view or 'cards' }}" hx-headers='{"accept":"text/html"}' class="px-2 py-1 rounded-md {{ 'bg-primary text-primary-foreground' if status_q=='maintenance' else 'bg-gray-900' }}">Mantenimiento</a>
    </div>
    <form method="get" action="/gyms" class="flex flex-wrap items-center gap-2">
      <input name="page_size" value="{{ page_size }}" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950 w-24" />
      <input type="hidden" name="ui" value="1" />
      <input type="hidden" name="page" value="1" />
      <button type="submit" class="px-3 py-2 rounded-md bg-gray-900">Tamaño página</button>
    </form>
    {% set dir_next = 'ASC' if (order_dir or 'DESC')=='DESC' else 'DESC' %}
    <div class="flex flex-wrap items-center gap-2">
      <span class="text-sm text-gray-400">Ordenar por:</span>
      <a href="/gyms?ui=1&q={{ q }}&status={{ status_q }}&order_by=id&order_dir={{ dir_next }}" hx-headers='{"accept":"text/html"}' class="px-2 py-1 rounded-md {{ 'bg-primary text-primary-foreground' if order_by=='id' else 'bg-gray-900' }}">ID</a>
      <a href="/gyms?ui=1&q={{ q }}&status={{ status_q }}&order_by=created_at&order_dir={{ dir_next }}" hx-headers='{"accept":"text/html"}' class="px-2 py-1 rounded-md {{ 'bg-primary text-primary-foreground' if order_by=='created_at' else 'bg-gray-900' }}">Creado</a>
      <a href="/gyms?ui=1&q={{ q }}&status={{ status_q }}&order_by=nombre&order_dir={{ dir_next }}" hx-headers='{"accept":"text/html"}' class="px-2 py-1 rounded-md {{ 'bg-primary text-primary-foreground' if order_by=='nombre' else 'bg-gray-900' }}">Nombre</a>
      <a href="/gyms?ui=1&q={{ q }}&status={{ status_q }}&order_by=subdominio&order_dir={{ dir_next }}" hx-headers='{"accept":"text/html"}' class="px-2 py-1 rounded-md {{ 'bg-primary text-primary-foreground' if order_by=='subdominio' else 'bg-gray-900' }}">Subdominio</a>
      <a href="/admin/gyms?ui=1&q={{ q }}&status={{ status_q }}&order_by=status&order_dir={{ dir_next }}" hx-headers='{"accept":"text/html"}' class="px-2 py-1 rounded-md {{ 'bg-primary text-primary-foreground' if order_by=='status' else 'bg-gray-900' }}">Estado</a>
      <span class="ml-3 text-sm text-gray-400">Vista:</span>
      <a href="/admin/gyms?ui=1&q={{ q }}&status={{ status_q }}&order_by={{ order_by }}&order_dir={{ order_dir }}&view=cards" hx-headers='{"accept":"text/html"}' class="px-2 py-1 rounded-md {{ 'bg-primary text-primary-foreground' if (view or 'cards')=='cards' else 'bg-gray-900' }}">Tarjetas</a>
      <a href="/admin/gyms?ui=1&q={{ q }}&status={{ status_q }}&order_by={{ order_by }}&order_dir={{ order_dir }}&view=table" hx-headers='{"accept":"text/html"}' class="px-2 py-1 rounded-md {{ 'bg-primary text-primary-foreground' if (view or 'cards')=='table' else 'bg-gray-900' }}">Tabla</a>
    </div>
    <button id="open-create" class="px-3 py-2 rounded-md bg-primary text-primary-foreground">Crear gimnasio</button>
    <button id="open-k" class="px-3 py-2 rounded-md bg-gray-900" onclick="window.openGlobalK && window.openGlobalK()"><i class="fa-solid fa-keyboard"></i><span class="ml-2">Ctrl+K</span></button>
  </div>
  <div id="actions-overlay" role="dialog" aria-modal="true" aria-labelledby="actions-title" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60" tabindex="-1">
    <div class="relative p-4 w-full max-w-md max-h-[85vh] overflow-auto">
      <div class="relative bg-gray-900 rounded-lg border border-gray-800 shadow">
        <div class="flex items-center justify-between p-3 border-b border-gray-800">
          <h3 id="actions-title" class="text-base font-semibold text-white">Acciones rápidas</h3>
          <button id="actions-close" class="px-2 py-1 rounded-md bg-gray-800">Cerrar</button>
        </div>
        <div class="p-3 grid gap-3">
          <button id="open-create-quick" class="px-3 py-2 rounded-md bg-primary text-primary-foreground">Crear gimnasio</button>
          <div class="grid gap-2">
            <div class="text-sm text-gray-400">Acciones por lote</div>
            <div class="grid grid-cols-2 gap-2">
              <button id="batch-prov-side" class="px-3 py-2 rounded-md bg-primary text-primary-foreground">Provisionar</button>
              <button id="batch-uns-side" class="px-3 py-2 rounded-md bg-green-600 text-white">Reactivar</button>
              <button id="batch-sus-side" class="px-3 py-2 rounded-md bg-red-600 text-white">Suspender</button>
            </div>
            <input id="batch-message-side" placeholder="Mensaje recordatorio" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
            <button id="batch-remind-side" class="px-3 py-2 rounded-md bg-gray-900">Recordar</button>
          </div>
          <div class="grid gap-2">
            <div class="text-sm text-gray-400">Aviso mantenimiento</div>
            <input id="batch-maint-message-side" placeholder="Mensaje mantenimiento" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
            <button id="batch-maint-side" class="px-3 py-2 rounded-md bg-yellow-500 text-black">Enviar aviso</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  {% if items|length == 0 %}
  <div class="p-6 rounded-xl border border-gray-800 bg-[#0b1222] grid gap-2 text-center">
    <div class="text-lg font-semibold">Sin resultados</div>
    <div class="text-gray-400">Ajusta filtros u <button id="open-create-2" class="px-3 py-1 rounded-md bg-primary text-primary-foreground">crea un gimnasio</button></div>
  </div>
  {% elif (view or 'cards')=='cards' %}
    {% include "gyms_grid.html" %}
  {% else %}
    {% include "gyms_table.html" %}
  {% endif %}

    <div class="mt-3 flex flex-wrap items-center gap-3">
      <a id="prev-link" href="{{ prev_link }}" hx-headers='{"accept":"text/html"}' class="px-3 py-2 rounded-md bg-gray-900">Anterior</a>
      <a id="next-link" href="{{ next_link }}" hx-headers='{"accept":"text/html"}' class="px-3 py-2 rounded-md bg-gray-900">Siguiente</a>
      <div class="text-gray-400">Página {{ page }} de {{ last_page }} · {{ total }} resultados</div>
      <div class="ml-auto text-gray-400">Seleccionados: <span id="sel-count">0</span></div>
      <div class="flex flex-wrap gap-2">
        <input type="hidden" id="selected-ids" />
        <button id="batch-prov" class="px-3 py-2 rounded-md bg-primary text-primary-foreground">Provisionar</button>
        <button id="batch-sus" class="px-3 py-2 rounded-md bg-red-600 text-white">Suspender</button>
        <button id="batch-uns" class="px-3 py-2 rounded-md bg-green-600 text-white">Reactivar</button>
        <input id="batch-message" placeholder="Mensaje recordatorio" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950 w-full sm:min-w-[280px]" />
        <button id="batch-remind" class="px-3 py-2 rounded-md bg-primary text-primary-foreground">Recordar</button>
        <button id="batch-remind-clear" class="px-3 py-2 rounded-md bg-gray-800 text-white">Quitar recordatorio</button>
        <input id="batch-maint-message" placeholder="Mensaje mantenimiento" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950 w-full sm:min-w-[280px]" />
        <button id="batch-maint" class="px-3 py-2 rounded-md bg-yellow-500 text-black">Aviso mant.</button>
        <button id="batch-select-all" class="px-3 py-2 rounded-md bg-gray-900" title="Seleccionar todos">Seleccionar todo</button>
        <button id="batch-clear" class="px-3 py-2 rounded-md bg-gray-900" title="Limpiar selección">Limpiar</button>
      </div>
    </div>
  <div class="fixed bottom-4 right-4">
    <button id="open-k-float" class="px-3 py-2 rounded-full bg-gray-700 text-white" onclick="window.openGlobalK && window.openGlobalK()">Ctrl+K</button>
  </div>
  <div id="details-overlay" role="dialog" aria-modal="true" aria-labelledby="details-title" aria-describedby="details-content" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/60" tabindex="-1">
    <div class="relative p-0 w-full h-full overflow-hidden">
      <div class="relative bg-gray-900 border border-gray-800 shadow w-full h-full flex flex-col">
        <div class="flex items-center justify-between p-3 border-b border-gray-800">
          <div class="flex items-center gap-4">
            <h3 id="details-title" class="text-base font-semibold text-white">Detalles del gimnasio</h3>
            <div id="details-health" class="flex items-center gap-2"></div>
          </div>
          <button id="details-close" class="px-2 py-1 rounded-md bg-gray-800">Cerrar</button>
        </div>
        <div id="details-content" class="p-3 text-gray-200 text-sm grid grid-cols-1 xl:grid-cols-3 gap-4 h-full overflow-auto"></div>
      </div>
    </div>
  </div>
  <div id="create-modal" role="dialog" aria-modal="true" aria-labelledby="create-title" tabindex="-1" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60">
    <div class="relative p-4 w-full max-w-lg max-h-[85vh] overflow-auto">
      <div class="relative bg-gray-900 rounded-lg border border-gray-800 shadow">
        <div class="flex items-center justify-between p-3 border-b border-gray-800">
          <h3 id="create-title" class="text-base font-semibold text-white">Crear gimnasio</h3>
          <button id="create-cancel" class="px-2 py-1 rounded-md bg-gray-800">Cerrar</button>
        </div>
        <form hx-post="/gyms" hx-headers='{"accept":"application/json"}' hx-swap="none" class="p-3 grid gap-2">
          <label for="create-name" class="text-sm text-gray-300">Nombre</label>
          <input id="create-name" name="nombre" required minlength="2" maxlength="80" autocomplete="off" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
          <label for="create-sub" class="text-sm text-gray-300">Subdominio</label>
          <input id="create-sub" name="subdominio" pattern="^[a-z0-9-]{1,63}$" title="Solo letras minúsculas, números y guiones" autocomplete="off" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950"
                 hx-get="/subdomains/check" hx-trigger="input changed" hx-target="#create-sub-status" hx-headers='{"accept":"text/html"}' hx-include="#create-name, #create-sub-hidden" x-on:input="document.getElementById('create-sub-hidden').value = $event.target.value" />
          <input type="hidden" id="create-sub-hidden" name="sub" />
          <span id="create-sub-status" class="text-xs text-gray-400"></span>
          <div id="create-bucket" class="text-xs text-gray-400"></div>
          
          <label for="create-owner-phone" class="text-sm text-gray-300">Teléfono dueño</label>
          <input id="create-owner-phone" name="owner_phone" pattern="^\+?[0-9]{7,15}$" inputmode="tel" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
          <details class="rounded-md border border-gray-800">
            <summary class="cursor-pointer px-3 py-2 text-sm text-gray-300 bg-gray-900 rounded-md">Configuración de WhatsApp (avanzado)</summary>
            <div class="p-3 grid gap-2">
              <label for="create-whatsapp-phone-id" class="text-sm text-gray-300">WhatsApp Phone ID</label>
              <input id="create-whatsapp-phone-id" name="whatsapp_phone_id" autocomplete="off" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
              <label for="create-whatsapp-access-token" class="text-sm text-gray-300">WhatsApp Access Token</label>
              <input id="create-whatsapp-access-token" name="whatsapp_access_token" autocomplete="off" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
              <label for="create-waba-id" class="text-sm text-gray-300">WABA ID</label>
              <input id="create-waba-id" name="whatsapp_business_account_id" autocomplete="off" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
              <label for="create-whatsapp-verify-token" class="text-sm text-gray-300">Verify Token</label>
              <input id="create-whatsapp-verify-token" name="whatsapp_verify_token" autocomplete="off" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
              <label for="create-app-secret" class="text-sm text-gray-300">App Secret</label>
              <input id="create-app-secret" name="whatsapp_app_secret" autocomplete="off" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
              <label class="flex items-center gap-2"><input type="checkbox" name="whatsapp_nonblocking" /><span class="text-sm text-gray-300">Envío no bloqueante</span></label>
              <label for="create-whatsapp-timeout" class="text-sm text-gray-300">Timeout de envío (segundos)</label>
              <input id="create-whatsapp-timeout" name="whatsapp_send_timeout_seconds" type="number" min="1" max="120" step="1" value="25" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
            </div>
          </details>
          <div class="flex justify-end gap-2">
            <button type="button" id="create-cancel-2" class="px-3 py-2 rounded-md bg-gray-900">Cancelar</button>
            <button type="submit" class="px-3 py-2 rounded-md bg-primary text-primary-foreground">Crear</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <div id="suspend-modal" role="dialog" aria-modal="true" aria-labelledby="suspend-title" tabindex="-1" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60">
    <div class="relative p-4 w-full max-w-md max-h-[85vh] overflow-auto">
      <div class="relative bg-gray-900 rounded-lg border border-gray-800 shadow">
        <div class="flex items-center justify-between p-3 border-b border-gray-800">
          <h3 id="suspend-title" class="text-base font-semibold text-white">Suspender gimnasio</h3>
          <button id="suspend-cancel" class="px-2 py-1 rounded-md bg-gray-800">Cerrar</button>
        </div>
        <div class="p-3 grid gap-2">
          <label for="suspend-reason" class="text-sm text-gray-300">Razón</label>
          <input id="suspend-reason" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
          <label for="suspend-until" class="text-sm text-gray-300">Hasta</label>
          <input id="suspend-until" type="date" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
          <label class="flex items-center gap-2"><input id="suspend-hard" type="checkbox" /><span class="text-gray-300 text-sm">Hard suspend</span></label>
        </div>
        <div class="p-3 flex justify-end gap-2">
          <button id="suspend-cancel-2" class="px-2 py-1 rounded-md bg-gray-800">Cancelar</button>
          <button id="suspend-yes" class="px-2 py-1 rounded-md bg-red-600 text-white">Suspender</button>
        </div>
      </div>
    </div>
  </div>
  {% include "gyms_scripts.html" %}
</div>
{% endblock %}
