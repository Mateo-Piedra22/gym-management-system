{% extends "base.html" %}
{% set _ = '' %}
{% block content %}
<div class="space-y-4">
  <h1 class="text-2xl font-semibold">Gimnasios</h1>
  <div class="flex flex-wrap gap-3 items-center">
    <button id="open-actions" class="px-3 py-2 rounded-md bg-primary text-primary-foreground">Acciones</button>
    <form method="get" action="/admin/gyms" class="flex flex-wrap gap-2">
      <input name="q" value="{{ q }}" placeholder="Buscar por nombre o subdominio" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950 min-w-[240px]" />
      <select name="status" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950">
        <option value="">Todos</option>
        <option value="active"{% if status_q=='active' %} selected{% endif %}>Activos</option>
        <option value="suspended"{% if status_q=='suspended' %} selected{% endif %}>Suspendidos</option>
        <option value="maintenance"{% if status_q=='maintenance' %} selected{% endif %}>Mantenimiento</option>
      </select>
      <select name="order_by" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950">
        <option value="id">ID</option>
        <option value="created_at">Creado</option>
        <option value="nombre">Nombre</option>
        <option value="subdominio">Subdominio</option>
        <option value="status">Estado</option>
      </select>
      <select name="order_dir" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950">
        <option value="DESC">Desc</option>
        <option value="ASC">Asc</option>
      </select>
      <input type="hidden" name="ui" value="1" />
      <button type="submit" class="px-3 py-2 rounded-md bg-primary text-primary-foreground">Filtrar</button>
    </form>
    <div class="flex items-center gap-2">
      <span class="text-sm text-gray-400">Estado:</span>
      <a href="/admin/gyms?ui=1&q={{ q }}&status=&order_by={{ order_by }}&order_dir={{ order_dir }}&view={{ view or 'cards' }}" class="px-2 py-1 rounded-md {{ 'bg-primary text-primary-foreground' if not status_q else 'bg-gray-900' }}">Todos</a>
      <a href="/admin/gyms?ui=1&q={{ q }}&status=active&order_by={{ order_by }}&order_dir={{ order_dir }}&view={{ view or 'cards' }}" class="px-2 py-1 rounded-md {{ 'bg-primary text-primary-foreground' if status_q=='active' else 'bg-gray-900' }}">Activos</a>
      <a href="/admin/gyms?ui=1&q={{ q }}&status=suspended&order_by={{ order_by }}&order_dir={{ order_dir }}&view={{ view or 'cards' }}" class="px-2 py-1 rounded-md {{ 'bg-primary text-primary-foreground' if status_q=='suspended' else 'bg-gray-900' }}">Suspendidos</a>
      <a href="/admin/gyms?ui=1&q={{ q }}&status=maintenance&order_by={{ order_by }}&order_dir={{ order_dir }}&view={{ view or 'cards' }}" class="px-2 py-1 rounded-md {{ 'bg-primary text-primary-foreground' if status_q=='maintenance' else 'bg-gray-900' }}">Mantenimiento</a>
    </div>
    <form method="get" action="/admin/gyms" class="flex items-center gap-2">
      <input name="page_size" value="{{ page_size }}" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950 w-24" />
      <input type="hidden" name="ui" value="1" />
      <input type="hidden" name="page" value="1" />
      <button type="submit" class="px-3 py-2 rounded-md bg-gray-900">Tamaño página</button>
    </form>
    {% set dir_next = 'ASC' if (order_dir or 'DESC')=='DESC' else 'DESC' %}
    <div class="flex items-center gap-2">
      <span class="text-sm text-gray-400">Ordenar por:</span>
      <a href="/admin/gyms?ui=1&q={{ q }}&status={{ status_q }}&order_by=id&order_dir={{ dir_next }}" class="px-2 py-1 rounded-md {{ 'bg-primary text-primary-foreground' if order_by=='id' else 'bg-gray-900' }}">ID</a>
      <a href="/admin/gyms?ui=1&q={{ q }}&status={{ status_q }}&order_by=created_at&order_dir={{ dir_next }}" class="px-2 py-1 rounded-md {{ 'bg-primary text-primary-foreground' if order_by=='created_at' else 'bg-gray-900' }}">Creado</a>
      <a href="/admin/gyms?ui=1&q={{ q }}&status={{ status_q }}&order_by=nombre&order_dir={{ dir_next }}" class="px-2 py-1 rounded-md {{ 'bg-primary text-primary-foreground' if order_by=='nombre' else 'bg-gray-900' }}">Nombre</a>
      <a href="/admin/gyms?ui=1&q={{ q }}&status={{ status_q }}&order_by=subdominio&order_dir={{ dir_next }}" class="px-2 py-1 rounded-md {{ 'bg-primary text-primary-foreground' if order_by=='subdominio' else 'bg-gray-900' }}">Subdominio</a>
      <a href="/admin/gyms?ui=1&q={{ q }}&status={{ status_q }}&order_by=status&order_dir={{ dir_next }}" class="px-2 py-1 rounded-md {{ 'bg-primary text-primary-foreground' if order_by=='status' else 'bg-gray-900' }}">Estado</a>
      <span class="ml-3 text-sm text-gray-400">Vista:</span>
      <a href="/admin/gyms?ui=1&q={{ q }}&status={{ status_q }}&order_by={{ order_by }}&order_dir={{ order_dir }}&view=cards" class="px-2 py-1 rounded-md {{ 'bg-primary text-primary-foreground' if (view or 'cards')=='cards' else 'bg-gray-900' }}">Tarjetas</a>
      <a href="/admin/gyms?ui=1&q={{ q }}&status={{ status_q }}&order_by={{ order_by }}&order_dir={{ order_dir }}&view=table" class="px-2 py-1 rounded-md {{ 'bg-primary text-primary-foreground' if (view or 'cards')=='table' else 'bg-gray-900' }}">Tabla</a>
    </div>
    <button id="open-create" class="px-3 py-2 rounded-md bg-primary text-primary-foreground">Crear gimnasio</button>
    <button id="open-k" class="px-3 py-2 rounded-md bg-gray-900"><i class="fa-solid fa-keyboard"></i><span class="ml-2">Ctrl+K</span></button>
  </div>
  <div id="actions-overlay" role="dialog" aria-modal="true" aria-labelledby="actions-title" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/60"></div>
    <div class="absolute right-0 top-0 h-full w-[380px] bg-gray-900 border-l border-gray-800 shadow">
      <div class="flex items-center justify-between p-3 border-b border-gray-800">
        <h3 id="actions-title" class="text-base font-semibold text-white">Acciones rápidas</h3>
        <button id="actions-close" class="px-2 py-1 rounded-md bg-gray-800">Cerrar</button>
      </div>
      <div class="p-3 grid gap-3">
        <button id="open-create-quick" class="px-3 py-2 rounded-md bg-primary text-primary-foreground">Crear gimnasio</button>
        <div class="grid gap-2">
          <div class="text-sm text-gray-400">Acciones por lote</div>
          <div class="grid grid-cols-2 gap-2">
            <button id="batch-prov-side" class="px-3 py-2 rounded-md bg-primary text-primary-foreground">Provisionar</button>
            <button id="batch-uns-side" class="px-3 py-2 rounded-md bg-green-600 text-white">Reactivar</button>
            <button id="batch-sus-side" class="px-3 py-2 rounded-md bg-red-600 text-white">Suspender</button>
          </div>
          <input id="batch-message-side" placeholder="Mensaje recordatorio" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
          <button id="batch-remind-side" class="px-3 py-2 rounded-md bg-gray-900">Recordar</button>
        </div>
        <div class="grid gap-2">
          <div class="text-sm text-gray-400">Aviso mantenimiento</div>
          <input id="batch-maint-message-side" placeholder="Mensaje mantenimiento" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
          <button id="batch-maint-side" class="px-3 py-2 rounded-md bg-yellow-500 text-black">Enviar aviso</button>
        </div>
      </div>
    </div>
  </div>
  <script>
  (function(){var o=document.getElementById('open-actions');var ov=document.getElementById('actions-overlay');var c=document.getElementById('actions-close');function open(){if(ov){ov.classList.remove('hidden')}}function close(){if(ov){ov.classList.add('hidden')}}if(o){o.addEventListener('click',open)}if(c){c.addEventListener('click',close)}document.addEventListener('keydown',function(e){if(e.key==='Escape'){close()}});var ocq=document.getElementById('open-create-quick');if(ocq){ocq.addEventListener('click',function(){close();var btn=document.getElementById('open-create');if(btn){btn.click()}})}function proxy(id,fn){var b=document.getElementById(id);if(b){b.addEventListener('click',fn)}}proxy('batch-prov-side',function(){document.getElementById('batch-prov').click()});proxy('batch-uns-side',function(){document.getElementById('batch-uns').click()});proxy('batch-sus-side',function(){document.getElementById('batch-sus').click()});proxy('batch-remind-side',function(){var src=document.getElementById('batch-message');var dst=document.getElementById('batch-message-side');if(src&&dst){src.value=dst.value}document.getElementById('batch-remind').click()});proxy('batch-maint-side',function(){var src=document.getElementById('batch-maint-message');var dst=document.getElementById('batch-maint-message-side');if(src&&dst){src.value=dst.value}document.getElementById('batch-maint').click()});})();
  </script>
  {% if items|length == 0 %}
  <div class="p-6 rounded-xl border border-gray-800 bg-[#0b1222] grid gap-2 text-center">
    <div class="text-lg font-semibold">Sin resultados</div>
    <div class="text-gray-400">Ajusta filtros u <button id="open-create-2" class="px-3 py-1 rounded-md bg-primary text-primary-foreground">crea un gimnasio</button></div>
  </div>
  {% elif (view or 'cards')=='cards' %}
  <div class="grid [grid-template-columns:repeat(auto-fit,minmax(260px,1fr))] gap-3">
    {% for g in items %}
    <div class="p-3 rounded-xl border border-gray-800 bg-[#0b1222] grid gap-3" data-gym-id="{{ g.id }}" data-next-due="{{ g.next_due_date or '' }}" x-data="{ edit: false }">
      <div class="flex justify-between items-center">
        <div class="flex items-center gap-2">
          <input type="checkbox" class="select-gym" value="{{ g.id }}" />
          <div class="font-semibold">{{ g.nombre }}</div>
          <button type="button" class="text-gray-400 text-sm" data-sub="{{ g.subdominio }}">{{ g.subdominio }}</button>
        </div>
        <div class="flex items-center gap-2">
          <div id="health-mini-{{ g.id }}" hx-get="/admin/gyms/{{ g.id }}/health?snippet=1" hx-headers='{"accept":"text/html"}' hx-trigger="revealed delay:300ms throttle:500ms" hx-swap="innerHTML" class="hidden sm:flex gap-1 items-center">
            <div class="skeleton w-16 h-3 rounded-md"></div>
          </div>
          <span class="px-2 py-1 rounded-full text-xs {{ 'bg-green-600 text-white' if g.status=='active' else ('bg-red-600 text-white' if g.status=='suspended' else ('bg-yellow-500 text-black' if g.status=='maintenance' else 'bg-gray-700 text-white')) }}">{{ g.status }}</span>
        </div>
      </div>
      <div class="grid grid-cols-2 gap-2 text-sm">
        <div class="text-gray-400">Creado</div><div>{{ g.created_at }}</div>
        <div class="text-gray-400">Teléfono</div>
        <div>
          <form hx-post="/admin/gyms/{{ g.id }}/contact" hx-headers='{"accept":"application/json"}' hx-trigger="submit" hx-swap="none" class="flex gap-2">
            <input name="owner_phone" value="{{ g.owner_phone }}" placeholder="+54..." class="px-2 py-1 rounded-md border border-gray-700 bg-gray-950 w-40" />
            <button type="submit" class="px-2 py-1 rounded-md bg-gray-900">Guardar</button>
          </form>
        </div>
      </div>
      <div class="grid gap-2" x-show="edit">
        <div class="text-sm text-gray-400">Editar gimnasio</div>
        <form hx-post="/admin/gyms/{{ g.id }}/update" hx-headers='{"accept":"application/json"}' hx-trigger="submit" hx-swap="none" class="grid grid-cols-1 sm:grid-cols-2 gap-2">
          <input id="edit-name-{{ g.id }}" name="nombre" value="{{ g.nombre }}" placeholder="Nombre" class="px-2 py-1 rounded-md border border-gray-700 bg-gray-950" />
          <div>
            <input id="edit-sub-{{ g.id }}" name="subdominio" value="{{ g.subdominio }}" placeholder="Subdominio" class="px-2 py-1 rounded-md border border-gray-700 bg-gray-950 w-full"
                   hx-get="/admin/subdomains/check" hx-trigger="input changed" hx-target="#edit-sub-status-{{ g.id }}" hx-include="#edit-name-{{ g.id }}, #edit-sub-hidden-{{ g.id }}" hx-headers='{"accept":"text/html"}'
                   x-on:input="document.getElementById('edit-sub-hidden-{{ g.id }}').value = $event.target.value" />
            <input type="hidden" id="edit-sub-hidden-{{ g.id }}" name="sub" />
            <span id="edit-sub-status-{{ g.id }}" class="text-xs text-gray-400"></span>
          </div>
          <div class="sm:col-span-2">
            <button type="submit" class="px-3 py-2 rounded-md bg-primary text-primary-foreground">Guardar cambios</button>
          </div>
        </form>
      </div>
      {% set next_due = g.next_due_date if g.next_due_date is defined else '' %}
      {% set last_amt = g.last_payment_amount if g.last_payment_amount is defined else '' %}
      {% if next_due or last_amt %}
      <div class="grid grid-cols-2 gap-2 text-sm">
        <div class="text-gray-400">Vence</div><div>{{ next_due }}</div>
        <div class="text-gray-400">Último pago</div>
        <div>{{ last_amt }} {{ g.last_payment_currency or '' }}{% if g.last_payment_at %} <span class="text-gray-400">· {{ g.last_payment_at }}</span>{% endif %}</div>
      </div>
      {% endif %}
      <div class="flex justify-between items-center">
        <div class="flex items-center gap-2">
          <div class="text-gray-400">Salud</div>
          <div id="health-{{ g.id }}" hx-get="/admin/gyms/{{ g.id }}/health?snippet=1" hx-headers='{"accept":"text/html"}' hx-trigger="revealed delay:300ms throttle:500ms" hx-swap="innerHTML" class="flex gap-2 items-center">
            <div class="skeleton w-24 h-3 rounded-md"></div>
          </div>
        </div>
        <div class="flex gap-2">
          <a href="/admin/gyms/{{ g.id }}/subscription?ui=1" class="px-3 py-2 rounded-md bg-gray-900" title="Suscripción"><i class="fa-solid fa-ticket"></i><span class="ml-2">Subs</span></a>
          <a href="/admin/gyms/{{ g.id }}/payments?ui=1" class="px-3 py-2 rounded-md bg-gray-900" title="Pagos"><i class="fa-solid fa-dollar-sign"></i><span class="ml-2">Pagos</span></a>
          <a href="/admin/gyms/{{ g.id }}/whatsapp?ui=1" class="px-3 py-2 rounded-md bg-gray-900" title="WhatsApp"><i class="fa-brands fa-whatsapp"></i><span class="ml-2">WA</span></a>
          <a href="/admin/gyms/{{ g.id }}/maintenance?ui=1" class="px-3 py-2 rounded-md bg-gray-900" title="Mantenimiento"><i class="fa-solid fa-wrench"></i><span class="ml-2">Mant.</span></a>
          <a href="/admin/gyms/{{ g.id }}/branding?ui=1" class="px-3 py-2 rounded-md bg-gray-900" title="Branding"><i class="fa-solid fa-palette"></i><span class="ml-2">Branding</span></a>
          <a href="/admin/gyms/{{ g.id }}/owner?ui=1" class="px-3 py-2 rounded-md bg-gray-900" title="Contraseña dueño"><i class="fa-solid fa-key"></i><span class="ml-2">Contraseña</span></a>
          <a href="/admin/gyms/{{ g.id }}/health?ui=1" class="px-3 py-2 rounded-md bg-gray-900" title="Salud"><i class="fa-solid fa-stethoscope"></i><span class="ml-2">Salud</span></a>
          <button type="button" class="px-3 py-2 rounded-md bg-gray-900" data-open-details="{{ g.id }}" title="Ver detalles"><i class="fa-solid fa-circle-info"></i><span class="ml-2">Ver detalles</span></button>
          <button type="button" class="px-3 py-2 rounded-md bg-gray-900" x-on:click="edit=!edit" title="Editar"><i class="fa-solid fa-pen"></i><span class="ml-2">Editar</span></button>
        </div>
      </div>
      <div class="flex flex-wrap gap-2">
        <form method="post" action="/admin/gyms/{{ g.id }}/provision" class="inline"><button type="submit" class="px-3 py-2 rounded-md bg-primary text-primary-foreground" title="Provisionar"><i class="fa-solid fa-cloud"></i><span class="ml-2">Provisionar</span></button></form>
        <button type="button" class="px-3 py-2 rounded-md bg-red-600 text-white" data-open-suspend="{{ g.id }}" title="Suspender"><i class="fa-solid fa-pause"></i><span class="ml-2">Suspender</span></button>
        <form method="post" action="/admin/gyms/{{ g.id }}/unsuspend" class="inline"><button type="submit" class="px-3 py-2 rounded-md bg-green-600 text-white"><i class="fa-solid fa-play"></i><span class="ml-2">Reactivar</span></button></form>
        <form method="post" action="/admin/gyms/{{ g.id }}/b2/regenerate-key" class="inline needs-confirm" data-confirm="¿Regenerar clave B2?"><button type="submit" class="px-3 py-2 rounded-md bg-gray-900" title="Regenerar clave B2"><i class="fa-solid fa-key"></i><span class="ml-2">Regenerar clave B2</span></button></form>
        <form method="post" action="/admin/gyms/{{ g.id }}/b2/delete-bucket" class="inline needs-confirm" data-confirm="¿Eliminar bucket B2?"><button type="submit" class="px-3 py-2 rounded-md bg-gray-900" title="Eliminar bucket B2"><i class="fa-solid fa-trash"></i><span class="ml-2">Eliminar bucket B2</span></button></form>
        <form method="post" action="/admin/gyms/{{ g.id }}/delete" class="inline needs-confirm" data-confirm="¿Eliminar gimnasio?"><button type="submit" class="px-3 py-2 rounded-md bg-gray-900" title="Eliminar gimnasio"><i class="fa-solid fa-trash"></i><span class="ml-2">Eliminar</span></button></form>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="overflow-x-auto rounded-xl border border-gray-800">
    <table class="w-full text-sm">
      <thead>
        <tr class="bg-gray-900">
          <th class="px-3 py-2 text-left">Sel</th>
          <th class="px-3 py-2 text-left"><a href="/admin/gyms?ui=1&q={{ q }}&status={{ status_q }}&order_by=id&order_dir={{ dir_next }}&view=table">ID</a></th>
          <th class="px-3 py-2 text-left"><a href="/admin/gyms?ui=1&q={{ q }}&status={{ status_q }}&order_by=nombre&order_dir={{ dir_next }}&view=table">Nombre</a></th>
          <th class="px-3 py-2 text-left"><a href="/admin/gyms?ui=1&q={{ q }}&status={{ status_q }}&order_by=subdominio&order_dir={{ dir_next }}&view=table">Subdominio</a></th>
          <th class="px-3 py-2 text-left"><a href="/admin/gyms?ui=1&q={{ q }}&status={{ status_q }}&order_by=created_at&order_dir={{ dir_next }}&view=table">Creado</a></th>
          <th class="px-3 py-2 text-left">Teléfono</th>
          <th class="px-3 py-2 text-left"><a href="/admin/gyms?ui=1&q={{ q }}&status={{ status_q }}&order_by=status&order_dir={{ dir_next }}&view=table">Estado</a></th>
          <th class="px-3 py-2 text-left">Salud</th>
          <th class="px-3 py-2 text-left">Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for g in items %}
        <tr class="border-t border-gray-800" data-gym-id="{{ g.id }}" x-data="{ editRow:false }">
          <td class="px-3 py-2"><input type="checkbox" class="select-gym" value="{{ g.id }}" /></td>
          <td class="px-3 py-2">{{ g.id }}</td>
          <td class="px-3 py-2">
            <div x-show="!editRow">{{ g.nombre }}</div>
            <input x-show="editRow" id="t-name-{{ g.id }}" name="nombre" value="{{ g.nombre }}" class="px-2 py-1 rounded-md border border-gray-700 bg-gray-950" />
          </td>
          <td class="px-3 py-2">
            <div x-show="!editRow">{{ g.subdominio }}</div>
            <div x-show="editRow">
              <input id="t-sub-{{ g.id }}" name="subdominio" value="{{ g.subdominio }}" class="px-2 py-1 rounded-md border border-gray-700 bg-gray-950"
                     hx-get="/admin/subdomains/check" hx-trigger="input changed" hx-target="#t-sub-status-{{ g.id }}" hx-headers='{"accept":"text/html"}' />
              <span id="t-sub-status-{{ g.id }}" class="text-xs text-gray-400"></span>
            </div>
          </td>
          <td class="px-3 py-2">{{ g.created_at }}</td>
          <td class="px-3 py-2">
            <form hx-post="/admin/gyms/{{ g.id }}/contact" hx-headers='{"accept":"application/json"}' hx-trigger="submit" hx-swap="none" class="flex gap-2">
              <input name="owner_phone" value="{{ g.owner_phone }}" placeholder="+54..." class="px-2 py-1 rounded-md border border-gray-700 bg-gray-950 w-40" />
              <button type="submit" class="px-2 py-1 rounded-md bg-gray-900">Guardar</button>
            </form>
          </td>
          <td class="px-3 py-2">
            <span class="px-2 py-1 rounded-md {{ 'bg-green-600 text-white' if g.status=='active' else ('bg-red-600 text-white' if g.status=='suspended' else ('bg-yellow-500 text-black' if g.status=='maintenance' else 'bg-gray-700 text-white')) }}">{{ g.status }}</span>
          </td>
          <td class="px-3 py-2">
            <div id="health-{{ g.id }}" hx-get="/admin/gyms/{{ g.id }}/health?snippet=1" hx-headers='{"accept":"text/html"}' hx-trigger="revealed delay:300ms throttle:500ms" hx-swap="innerHTML" class="flex gap-2 items-center">
              <div class="skeleton w-24 h-3 rounded-md"></div>
            </div>
          </td>
          <td class="px-3 py-2">
            <div class="flex flex-wrap gap-2">
              <button type="button" class="px-2 py-1 rounded-md bg-gray-900" x-on:click="editRow=!editRow" title="Editar"><i class="fa-solid fa-pen"></i></button>
              <form method="post" action="/admin/gyms/{{ g.id }}/provision" class="inline"><button type="submit" class="px-2 py-1 rounded-md bg-primary text-primary-foreground" title="Provisionar"><i class="fa-solid fa-cloud"></i></button></form>
              <button type="button" class="px-2 py-1 rounded-md bg-red-600 text-white" data-open-suspend="{{ g.id }}" title="Suspender"><i class="fa-solid fa-pause"></i></button>
              <form method="post" action="/admin/gyms/{{ g.id }}/unsuspend" class="inline"><button type="submit" class="px-2 py-1 rounded-md bg-green-600 text-white" title="Reactivar"><i class="fa-solid fa-play"></i></button></form>
              <a href="/admin/gyms/{{ g.id }}/subscription?ui=1" class="px-2 py-1 rounded-md bg-gray-900" title="Suscripción"><i class="fa-solid fa-ticket"></i></a>
              <a href="/admin/gyms/{{ g.id }}/payments?ui=1" class="px-2 py-1 rounded-md bg-gray-900" title="Pagos"><i class="fa-solid fa-dollar-sign"></i></a>
              <a href="/admin/gyms/{{ g.id }}/whatsapp?ui=1" class="px-2 py-1 rounded-md bg-gray-900" title="WhatsApp"><i class="fa-brands fa-whatsapp"></i></a>
              <a href="/admin/gyms/{{ g.id }}/maintenance?ui=1" class="px-2 py-1 rounded-md bg-gray-900" title="Mantenimiento"><i class="fa-solid fa-wrench"></i></a>
              <a href="/admin/gyms/{{ g.id }}/branding?ui=1" class="px-2 py-1 rounded-md bg-gray-900" title="Branding"><i class="fa-solid fa-palette"></i></a>
              <a href="/admin/gyms/{{ g.id }}/owner?ui=1" class="px-2 py-1 rounded-md bg-gray-900" title="Contraseña dueño"><i class="fa-solid fa-key"></i></a>
              <a href="/admin/gyms/{{ g.id }}/health?ui=1" class="px-2 py-1 rounded-md bg-gray-900" title="Salud"><i class="fa-solid fa-stethoscope"></i></a>
              <form method="post" action="/admin/gyms/{{ g.id }}/b2/regenerate-key" class="inline needs-confirm" data-confirm="¿Regenerar clave B2?"><button type="submit" class="px-2 py-1 rounded-md bg-gray-900" title="Regenerar clave B2"><i class="fa-solid fa-key"></i></button></form>
              <form method="post" action="/admin/gyms/{{ g.id }}/b2/delete-bucket" class="inline needs-confirm" data-confirm="¿Eliminar bucket B2?"><button type="submit" class="px-2 py-1 rounded-md bg-gray-900" title="Eliminar bucket B2"><i class="fa-solid fa-trash"></i></button></form>
              <form method="post" action="/admin/gyms/{{ g.id }}/delete" class="inline needs-confirm" data-confirm="¿Eliminar gimnasio?"><button type="submit" class="px-2 py-1 rounded-md bg-gray-900" title="Eliminar gimnasio"><i class="fa-solid fa-trash"></i></button></form>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}
    <div class="mt-3 flex items-center gap-3">
      <a id="prev-link" href="{{ prev_link }}" class="px-3 py-2 rounded-md bg-gray-900">Anterior</a>
      <a id="next-link" href="{{ next_link }}" class="px-3 py-2 rounded-md bg-gray-900">Siguiente</a>
      <div class="text-gray-400">Página {{ page }} de {{ last_page }} · {{ total }} resultados</div>
      <div class="ml-auto text-gray-400">Seleccionados: <span id="sel-count">0</span></div>
      <div class="flex gap-2">
        <input type="hidden" id="selected-ids" />
        <button id="batch-prov" class="px-3 py-2 rounded-md bg-primary text-primary-foreground">Provisionar</button>
        <button id="batch-sus" class="px-3 py-2 rounded-md bg-red-600 text-white">Suspender</button>
        <button id="batch-uns" class="px-3 py-2 rounded-md bg-green-600 text-white">Reactivar</button>
        <input id="batch-message" placeholder="Mensaje recordatorio" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950 min-w-[280px]" />
        <button id="batch-remind" class="px-3 py-2 rounded-md bg-primary text-primary-foreground">Recordar</button>
        <input id="batch-maint-message" placeholder="Mensaje mantenimiento" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950 min-w-[280px]" />
        <button id="batch-maint" class="px-3 py-2 rounded-md bg-yellow-500 text-black">Aviso mant.</button>
        <button id="batch-select-all" class="px-3 py-2 rounded-md bg-gray-900" title="Seleccionar todos">Seleccionar todo</button>
        <button id="batch-clear" class="px-3 py-2 rounded-md bg-gray-900" title="Limpiar selección">Limpiar</button>
      </div>
    </div>
  <div class="fixed bottom-4 right-4">
    <button id="open-k-float" class="px-3 py-2 rounded-full bg-gray-700 text-white">Ctrl+K</button>
  </div>
  <div id="details-overlay" role="dialog" aria-modal="true" aria-labelledby="details-title" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60">
    <div class="relative p-4 w-full max-w-3xl">
      <div class="relative bg-gray-900 rounded-lg border border-gray-800 shadow">
        <div class="flex items-center justify-between p-3 border-b border-gray-800">
          <h3 id="details-title" class="text-base font-semibold text-white">Detalles del gimnasio</h3>
          <button id="details-close" class="px-2 py-1 rounded-md bg-gray-800">Cerrar</button>
        </div>
        <div id="details-content" class="p-3 text-gray-200 text-sm"></div>
      </div>
    </div>
  </div>
  <div id="confirm-modal" role="dialog" aria-modal="true" aria-labelledby="confirm-title" tabindex="-1" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60">
    <div class="relative p-4 w-full max-w-md">
      <div class="relative bg-gray-900 rounded-lg border border-gray-800 shadow">
        <div class="flex items-center justify-between p-3 border-b border-gray-800">
          <h3 id="confirm-title" class="text-base font-semibold text-white">Confirmar acción</h3>
          <button id="confirm-cancel" class="px-2 py-1 rounded-md bg-gray-800">Cerrar</button>
        </div>
        <div class="p-3">
          <p id="confirm-message" class="text-gray-300">¿Confirmar?</p>
        </div>
        <div class="p-3 flex justify-end gap-2">
          <button id="confirm-cancel-2" class="px-2 py-1 rounded-md bg-gray-800">Cancelar</button>
          <button id="confirm-yes" class="px-2 py-1 rounded-md bg-primary text-primary-foreground">Confirmar</button>
        </div>
      </div>
    </div>
  </div>
  <div id="create-modal" role="dialog" aria-modal="true" aria-labelledby="create-title" tabindex="-1" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60">
    <div class="relative p-4 w-full max-w-lg">
      <div class="relative bg-gray-900 rounded-lg border border-gray-800 shadow">
        <div class="flex items-center justify-between p-3 border-b border-gray-800">
          <h3 id="create-title" class="text-base font-semibold text-white">Crear gimnasio</h3>
          <button id="create-cancel" class="px-2 py-1 rounded-md bg-gray-800">Cerrar</button>
        </div>
        <form hx-post="/admin/gyms" hx-headers='{"accept":"application/json"}' hx-swap="none" class="p-3 grid gap-2">
          <input name="nombre" placeholder="Nombre" required minlength="2" maxlength="80" autocomplete="off" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
          <input id="create-sub" name="subdominio" placeholder="Subdominio" pattern="^[a-z0-9-]{1,63}$" title="Solo letras minúsculas, números y guiones" autocomplete="off" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950"
                 hx-get="/admin/subdomains/check" hx-trigger="input changed" hx-target="#create-sub-status" hx-headers='{"accept":"text/html"}' />
          <span id="create-sub-status" class="text-xs text-gray-400"></span>
          <input name="owner_phone" placeholder="Teléfono dueño (+54...)" pattern="^\+?[0-9]{7,15}$" inputmode="tel" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
          <label class="flex items-center gap-2"><input type="checkbox" name="nonblocking" /><span class="text-sm text-gray-300">Provisionar en background</span></label>
          <input name="send_timeout_seconds" type="number" min="1" max="120" step="1" value="25" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
          <div class="flex justify-end gap-2">
            <button type="button" id="create-cancel-2" class="px-3 py-2 rounded-md bg-gray-900">Cancelar</button>
            <button type="submit" class="px-3 py-2 rounded-md bg-primary text-primary-foreground">Crear</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <div id="suspend-modal" role="dialog" aria-modal="true" aria-labelledby="suspend-title" tabindex="-1" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60">
    <div class="relative p-4 w-full max-w-md">
      <div class="relative bg-gray-900 rounded-lg border border-gray-800 shadow">
        <div class="flex items-center justify-between p-3 border-b border-gray-800">
          <h3 id="suspend-title" class="text-base font-semibold text-white">Suspender gimnasio</h3>
          <button id="suspend-cancel" class="px-2 py-1 rounded-md bg-gray-800">Cerrar</button>
        </div>
        <div class="p-3 grid gap-2">
          <input id="suspend-reason" placeholder="Razón (opcional)" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
          <input id="suspend-until" type="date" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
          <label class="flex items-center gap-2"><input id="suspend-hard" type="checkbox" /><span class="text-gray-300 text-sm">Hard suspend</span></label>
        </div>
        <div class="p-3 flex justify-end gap-2">
          <button id="suspend-cancel-2" class="px-2 py-1 rounded-md bg-gray-800">Cancelar</button>
          <button id="suspend-yes" class="px-2 py-1 rounded-md bg-red-600 text-white">Suspender</button>
        </div>
      </div>
    </div>
  </div>
  <div x-data="{ open: false, q: '' }" x-show="open" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50" x-transition
       x-on:keydown.escape.window="open=false"
       x-bind:class="open ? 'flex' : 'hidden'">
    <div class="w-[92%] max-w-[720px] bg-gray-900 border border-gray-800 rounded-xl">
      <div class="p-3 border-b border-gray-800 flex justify-between items-center">
        <div class="font-semibold">Búsqueda</div>
        <button x-on:click="open=false" id="k-close" class="px-2 py-1 rounded-md bg-gray-800">Cerrar</button>
      </div>
      <div class="p-3">
        <input id="k-input" x-model="q" placeholder="Buscar gimnasios o templates" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950 w-full" />
        <div id="k-results" class="mt-3 grid gap-2"></div>
      </div>
    </div>
  </div>
  <script>
  (function(){
    var confirmOverlay=document.getElementById('confirm-modal');
    var confirmMsg=document.getElementById('confirm-message');
    var confirmYes=document.getElementById('confirm-yes');
    var confirmCancel=document.getElementById('confirm-cancel');
    var pendingForm=null;
    function openConfirm(message, form){if(confirmOverlay){confirmOverlay.classList.remove('hidden');confirmMsg.textContent=message||'¿Confirmar?';pendingForm=form;setTimeout(function(){if(confirmYes){confirmYes.focus()}},10)}}
    function closeConfirm(){if(confirmOverlay){confirmOverlay.classList.add('hidden');pendingForm=null}}
    if(confirmYes){confirmYes.addEventListener('click',function(){if(pendingForm){pendingForm.submit()}closeConfirm()})}
    if(confirmCancel){confirmCancel.addEventListener('click',function(){closeConfirm()})}
    var confirmCancel2=document.getElementById('confirm-cancel-2');
    if(confirmCancel2){confirmCancel2.addEventListener('click',function(){closeConfirm()})}
    var cForms=document.querySelectorAll('form.needs-confirm');
    for(var i=0;i<cForms.length;i++){cForms[i].addEventListener('submit',function(e){e.preventDefault();var m=this.getAttribute('data-confirm')||'¿Confirmar?';openConfirm(m,this)})}
    function toast(msg,type){var c=document.getElementById('toast-container');if(!c){var t=document.createElement('div');t.id='toast-container';t.setAttribute('style','display:grid;gap:8px;position:fixed;top:16px;right:16px');document.body.appendChild(t);c=t}var bg=type==='error'?'#ef4444':(type==='info'?'#374151':'#16a34a');var el=document.createElement('div');el.setAttribute('style','background:'+bg+';color:#fff;padding:10px 12px;border-radius:8px;box-shadow:0 10px 15px rgba(0,0,0,0.2)');el.textContent=msg;c.appendChild(el);setTimeout(function(){if(el&&el.parentNode){el.parentNode.removeChild(el)}},3000)}
    var selected=new Set();function updateSel(){var c=document.getElementById('sel-count');if(c){c.textContent=String(selected.size)}var hid=document.getElementById('selected-ids');if(hid){hid.value=Array.from(selected).join(',')}}
    var boxes=document.querySelectorAll('.select-gym');for(var i=0;i<boxes.length;i++){boxes[i].addEventListener('change',function(){var v=this.value;if(this.checked){selected.add(v)}else{selected.delete(v)}updateSel()})}
    function selectAll(){var boxes=document.querySelectorAll('.select-gym');selected.clear();for(var i=0;i<boxes.length;i++){boxes[i].checked=true;selected.add(boxes[i].value)}updateSel()}
    function clearSel(){var boxes=document.querySelectorAll('.select-gym');for(var i=0;i<boxes.length;i++){boxes[i].checked=false}selected.clear();updateSel()}
    var bsa=document.getElementById('batch-select-all');if(bsa){bsa.addEventListener('click',selectAll)}var bcl=document.getElementById('batch-clear');if(bcl){bcl.addEventListener('click',clearSel)}
    var subs=document.querySelectorAll('[data-sub]');for(var j=0;j<subs.length;j++){subs[j].addEventListener('click',function(){var tx=this.getAttribute('data-sub')||'';if(navigator.clipboard&&navigator.clipboard.writeText){navigator.clipboard.writeText(tx).then(function(){toast('Copiado: '+tx,'info')}).catch(function(){toast('No se pudo copiar','error')})}else{toast(tx,'info')}})}
    function runBatch(action){if(selected.size===0){toast('No hay seleccionados','info');return}var form=new URLSearchParams();form.append('action',action);form.append('gym_ids',Array.from(selected).join(','));fetch('/admin/gyms/batch',{method:'POST',headers:{'accept':'application/json','content-type':'application/x-www-form-urlencoded'},body:form.toString()}).then(function(r){return r.json().then(function(j){return {ok:r.ok,body:j}})}).then(function(res){if(res.ok&&res.body&&res.body.ok){toast('Acción '+action+' aplicada','success');setTimeout(function(){window.location.reload()},600)}else{toast('Error en lote','error')}}).catch(function(){toast('Error de red','error')})}
    function runRemindBatch(){if(selected.size===0){toast('No hay seleccionados','info');return}var msgEl=document.getElementById('batch-message');var form=new URLSearchParams();form.append('gym_ids',Array.from(selected).join(','));form.append('message',msgEl?String(msgEl.value||''):'');fetch('/admin/gyms/remind/batch',{method:'POST',headers:{'accept':'application/json','content-type':'application/x-www-form-urlencoded'},body:form.toString()}).then(function(r){return r.json().then(function(j){return {ok:r.ok,body:j}})}).then(function(res){if(res.ok&&res.body&&res.body.ok){toast('Recordatorios enviados','success')}else{toast('Error al enviar recordatorios','error')}}).catch(function(){toast('Error de red','error')})}
    function runMaintBatch(){if(selected.size===0){toast('No hay seleccionados','info');return}var msgEl=document.getElementById('batch-maint-message');var form=new URLSearchParams();form.append('gym_ids',Array.from(selected).join(','));form.append('message',msgEl?String(msgEl.value||''):'');fetch('/admin/gyms/maintenance/notify/batch',{method:'POST',headers:{'accept':'application/json','content-type':'application/x-www-form-urlencoded'},body:form.toString()}).then(function(r){return r.json().then(function(j){return {ok:r.ok,body:j}})}).then(function(res){if(res.ok&&res.body&&res.body.ok){toast('Avisos de mantenimiento enviados','success')}else{toast('Error al enviar avisos','error')}}).catch(function(){toast('Error de red','error')})}
    var detailsOverlay=document.getElementById('details-overlay');var detailsContent=document.getElementById('details-content');var detailsClose=document.getElementById('details-close');function openDetails(gid){if(!detailsOverlay||!detailsContent)return;detailsOverlay.classList.remove('hidden');fetch('/admin/gyms/'+gid+'/details',{headers:{'accept':'application/json'}}).then(function(r){return r.json()}).then(function(j){var d=(j&&j.gym)||{};var h=(j&&j.health)||{};var pays=(j&&j.payments)||[];var sub=(j&&j.subscription)||{};var html='';html+='<div class="grid grid-cols-2 gap-2">';html+='<div class="text-gray-400">ID</div><div>'+String(d.id||'')+'</div>';html+='<div class="text-gray-400">Nombre</div><div>'+String(d.nombre||'')+'</div>';html+='<div class="text-gray-400">Subdominio</div><div>'+String(d.subdominio||'')+'</div>';html+='<div class="text-gray-400">Estado</div><div>'+String(d.status||'')+'</div>';html+='<div class="text-gray-400">Creado</div><div>'+String(d.created_at||'')+'</div>';html+='</div>';html+='<div class="mt-3 grid grid-cols-3 gap-2">';html+='<div class="px-2 py-1 rounded-md '+((h.db&&h.db.ok)?'bg-green-600 text-white':'bg-red-600 text-white')+'">DB</div>';html+='<div class="px-2 py-1 rounded-md '+((h.whatsapp&&h.whatsapp.ok)?'bg-green-600 text-white':'bg-red-600 text-white')+'">WA</div>';html+='<div class="px-2 py-1 rounded-md '+((h.storage&&h.storage.ok)?'bg-green-600 text-white':'bg-red-600 text-white')+'">ST</div>';html+='</div>';html+='<div class="mt-3"><div class="text-gray-300">Suscripción</div><div class="text-sm">Plan: '+String(sub.plan||'')+' · Válido hasta: '+String(sub.valid_until||'')+'</div></div>';html+='<div class="mt-3"><div class="text-gray-300">Pagos recientes</div>';if(pays.length){html+='<div class="grid gap-1">';for(var i=0;i<Math.min(pays.length,5);i++){var p=pays[i];html+='<div class="flex justify-between text-sm"><span>'+(String(p.plan||'')+' · '+String(p.amount||'')+' '+String(p.currency||''))+'</span><span class="text-gray-400">'+String(p.paid_at||'')+'</span></div>'}html+='</div>'}else{html+='<div class="text-gray-400 text-sm">Sin pagos</div>'}html+='</div>';detailsContent.innerHTML=html}).catch(function(){detailsContent.innerHTML='<div class="text-red-600">Error al cargar detalles</div>'})}
    function haloDue(){var cards=document.querySelectorAll('[data-next-due]');var now=new Date();for(var i=0;i<cards.length;i++){var nd=cards[i].getAttribute('data-next-due')||'';if(!nd)continue;var d=new Date(nd);if(isNaN(d.getTime()))continue;var diff=Math.round((d.getTime()-now.getTime())/86400000);if(diff<=3){cards[i].classList.remove('border-gray-800');cards[i].classList.add('border-red-600')}else if(diff<=7){cards[i].classList.remove('border-gray-800');cards[i].classList.add('border-yellow-500')}}}
    haloDue()
    var createOverlay=document.getElementById('create-modal');var createOpen=document.getElementById('open-create');var createOpen2=document.getElementById('open-create-2');var createCancel=document.getElementById('create-cancel');var createCancel2=document.getElementById('create-cancel-2');function openCreate(){if(createOverlay){createOverlay.classList.remove('hidden');var nm=document.querySelector('#create-modal [name="nombre"]');if(nm){setTimeout(function(){nm.focus()},10)}}}function closeCreate(){if(createOverlay){createOverlay.classList.add('hidden')}}if(createOpen){createOpen.addEventListener('click',openCreate)}if(createOpen2){createOpen2.addEventListener('click',openCreate)}if(createCancel){createCancel.addEventListener('click',closeCreate)}if(createCancel2){createCancel2.addEventListener('click',closeCreate)}document.body.addEventListener('htmx:afterOnLoad',function(evt){try{var xhr=evt.detail.xhr;var j=xhr&&JSON.parse(xhr.responseText);if(j&&j.ok){var formEl=evt.target;if(formEl&&formEl.getAttribute('hx-post')==='/admin/gyms'){toast('Gimnasio creado','success');setTimeout(function(){window.location.reload()},600)}else{toast('Guardado','success')}}else{toast('Error','error')}}catch(e){}})
    if(detailsClose){detailsClose.addEventListener('click',function(){if(detailsOverlay){detailsOverlay.classList.add('hidden')}})}
    var od=document.querySelectorAll('[data-open-details]');for(var i=0;i<od.length;i++){od[i].addEventListener('click',function(){var gid=this.getAttribute('data-open-details');openDetails(gid)})}
    var suspendOverlay=document.getElementById('suspend-modal');var suspendCancel=document.getElementById('suspend-cancel');var suspendCancel2=document.getElementById('suspend-cancel-2');var suspendYes=document.getElementById('suspend-yes');var suspendReason=document.getElementById('suspend-reason');var suspendUntil=document.getElementById('suspend-until');var suspendHard=document.getElementById('suspend-hard');var suspendGymId=null;function openSuspend(gid){suspendGymId=gid;if(suspendOverlay){suspendOverlay.classList.remove('hidden');if(suspendReason){setTimeout(function(){suspendReason.focus()},10)}}}function closeSuspend(){suspendGymId=null;if(suspendOverlay){suspendOverlay.classList.add('hidden')}}function submitSuspend(){if(!suspendGymId){closeSuspend();return}var form=new URLSearchParams();form.append('reason',String(suspendReason.value||''));form.append('until',String(suspendUntil.value||''));form.append('hard',suspendHard.checked?'true':'false');fetch('/admin/gyms/'+suspendGymId+'/suspend',{method:'POST',headers:{'accept':'application/json','content-type':'application/x-www-form-urlencoded'},body:form.toString()}).then(function(r){return r.json().then(function(j){return {ok:r.ok,body:j}})}).then(function(res){if(res.ok&&res.body&&res.body.ok){toast('Gimnasio suspendido','success');setTimeout(function(){window.location.reload()},600)}else{toast('Error al suspender','error')}}).catch(function(){toast('Error de red','error')}).finally(function(){closeSuspend()})}
    if(suspendCancel){suspendCancel.addEventListener('click',closeSuspend)}if(suspendCancel2){suspendCancel2.addEventListener('click',closeSuspend)}if(suspendYes){suspendYes.addEventListener('click',submitSuspend)}var os=document.querySelectorAll('[data-open-suspend]');for(var i=0;i<os.length;i++){os[i].addEventListener('click',function(){var gid=this.getAttribute('data-open-suspend');openSuspend(gid)})}
    var bp=document.getElementById('batch-prov');if(bp){bp.addEventListener('click',function(){runBatch('provision')})}
    var bs=document.getElementById('batch-sus');if(bs){bs.addEventListener('click',function(){runBatch('suspend')})}
    var bu=document.getElementById('batch-uns');if(bu){bu.addEventListener('click',function(){runBatch('unsuspend')})}
    var br=document.getElementById('batch-remind');if(br){br.addEventListener('click',function(){runRemindBatch()})}
    var bm=document.getElementById('batch-maint');if(bm){bm.addEventListener('click',function(){runMaintBatch()})}
    var ok=document.getElementById('open-k');var okf=document.getElementById('open-k-float');var overlay=document.querySelector('[x-data]');var inp=document.getElementById('k-input');var res=document.getElementById('k-results');
    function openK(){if(overlay){overlay.classList.remove('hidden');overlay.classList.add('flex');setTimeout(function(){if(inp){inp.focus()}},50)}}
    function closeK(){if(overlay){overlay.classList.add('hidden');overlay.classList.remove('flex')}}
    if(ok){ok.addEventListener('click',openK)}if(okf){okf.addEventListener('click',openK)}
    var kc=document.getElementById('k-close');if(kc){kc.addEventListener('click',closeK)}
    var _kTimer=null;function searchK(q){if(!res)return;clearTimeout(_kTimer);_kTimer=setTimeout(function(){res.innerHTML='<div class="skeleton w-full h-4 rounded-md"></div>';var list=[];fetch('/admin/gyms?q='+encodeURIComponent(q)+'&page=1&page_size=10',{headers:{'accept':'application/json'}}).then(function(r){return r.json()}).then(function(j){var items=(j&&j.items)||[];for(var i=0;i<items.length;i++){var g=items[i];list.push({t:'gym',id:String(g.id||''),label:String(g.nombre||'')+' · '+String(g.subdominio||'')})}return fetch('/admin/templates',{headers:{'accept':'application/json'}})}).then(function(r){return r.json()}).then(function(j){var t=(j&&j.templates)||[];for(var i=0;i<t.length;i++){list.push({t:'template',id:String(i+1),label:String(t[i]||'')})}var html='';for(var k=0;k<list.length;k++){var it=list[k];var href=it.t==='gym'?('/admin/gyms/'+it.id+'/health?ui=1'):('/admin/templates?ui=1');html+='<a href="'+href+'" class="flex justify-between items-center px-3 py-2 rounded-md border border-gray-800 bg-[#0b1222] text-white"><span>'+it.label+'</span><span class="text-gray-400 text-xs">'+it.t+'</span></a>'}if(!html){html='<div class="text-gray-400">Sin resultados</div>'}res.innerHTML=html}).catch(function(){res.innerHTML='<div class="text-red-600">Error en búsqueda</div>'})},300)}
    if(inp){inp.addEventListener('input',function(){searchK(inp.value)})}
    document.addEventListener('keydown',function(e){if(e.key==='Escape'){if(confirmOverlay&&!confirmOverlay.classList.contains('hidden')){closeConfirm()}var det=document.getElementById('details-overlay');if(det&&!det.classList.contains('hidden')){var dc=document.getElementById('details-close');if(dc){dc.click()}}if(createOverlay&&!createOverlay.classList.contains('hidden')){var cc=document.getElementById('create-cancel');if(cc){cc.click()}}if(suspendOverlay&&!suspendOverlay.classList.contains('hidden')){var sc=document.getElementById('suspend-cancel');if(sc){sc.click()}}}})
    document.addEventListener('keydown',function(e){var k=e.key.toLowerCase();if((e.ctrlKey||e.metaKey)&&k==='k'){var o=document.getElementById('global-open-k');if(o){e.preventDefault();o.click();return}}if(k==='['){var link=document.getElementById('prev-link');if(link){link.click()}}if(k===']'){var link2=document.getElementById('next-link');if(link2){link2.click()}}if(k==='a'){e.preventDefault();var bsa=document.getElementById('batch-select-all');if(bsa){bsa.click()}}if(k==='c'){e.preventDefault();var bcl=document.getElementById('batch-clear');if(bcl){bcl.click()}}if(k==='r'){e.preventDefault();var br=document.getElementById('batch-remind');if(br){br.click()}}if(k==='p'){e.preventDefault();var bp=document.getElementById('batch-prov');if(bp){bp.click()}}if(k==='s'){e.preventDefault();var bs=document.getElementById('batch-sus');if(bs){bs.click()}}if(k==='u'){e.preventDefault();var bu=document.getElementById('batch-uns');if(bu){bu.click()}}if(k==='m'){e.preventDefault();var bm=document.getElementById('batch-maint');if(bm){bm.click()}}});
  })();
  </script>
</div>
{% endblock %}