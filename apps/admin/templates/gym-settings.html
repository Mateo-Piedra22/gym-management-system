{% extends "base.html" %}
{% set _ = '' %}
{% block content %}
<div id="settings-section" class="max-w-4xl mx-auto space-y-4">
  <div class="flex items-center justify-between">
    <h1 class="text-2xl font-semibold">
      {% if section=='whatsapp' %}Configurar WhatsApp{% elif section=='maintenance' %}Modo mantenimiento{% elif section=='branding' %}Branding{% elif section=='subscription' %}Suscripción{% elif section=='payments' %}Pagos{% elif section=='health' %}Salud del gimnasio{% else %}Gimnasio{% endif %}
    </h1>
    <a href="/admin/gyms?ui=1" class="px-3 py-2 rounded-md bg-gray-900"><i class="fa-solid fa-arrow-left"></i><span class="ml-2">Volver</span></a>
  </div>
  <div class="flex flex-wrap gap-2">
    {% set base = '/admin/gyms/' ~ gid %}
    <a href="{{ base }}/subscription?ui=1" class="px-3 py-2 rounded-md {{ 'bg-primary text-primary-foreground' if section=='subscription' else 'bg-gray-900' }}">Suscripción</a>
    <a href="{{ base }}/payments?ui=1" class="px-3 py-2 rounded-md {{ 'bg-primary text-primary-foreground' if section=='payments' else 'bg-gray-900' }}">Pagos</a>
    <a href="{{ base }}/whatsapp?ui=1" class="px-3 py-2 rounded-md {{ 'bg-primary text-primary-foreground' if section=='whatsapp' else 'bg-gray-900' }}">WhatsApp</a>
    <a href="{{ base }}/storage?ui=1" class="px-3 py-2 rounded-md {{ 'bg-primary text-primary-foreground' if section=='storage' else 'bg-gray-900' }}">Storage</a>
    <a href="{{ base }}/maintenance?ui=1" class="px-3 py-2 rounded-md {{ 'bg-primary text-primary-foreground' if section=='maintenance' else 'bg-gray-900' }}">Mantenimiento</a>
    <a href="{{ base }}/branding?ui=1" class="px-3 py-2 rounded-md {{ 'bg-primary text-primary-foreground' if section=='branding' else 'bg-gray-900' }}">Branding</a>
    <a href="{{ base }}/health?ui=1" class="px-3 py-2 rounded-md {{ 'bg-primary text-primary-foreground' if section=='health' else 'bg-gray-900' }}">Salud</a>
    <a href="{{ base }}/owner?ui=1" class="px-3 py-2 rounded-md {{ 'bg-primary text-primary-foreground' if section=='owner' else 'bg-gray-900' }}">Contraseña dueño</a>
  </div>

  {% if section=='whatsapp' %}
  <form method="post" action="/admin/gyms/{{ gid }}/whatsapp" class="grid grid-cols-1 sm:grid-cols-2 gap-3" hx-headers='{"accept":"application/json"}' hx-swap="none">
    <label for="wa-phone-id" class="text-sm text-gray-300">Phone ID</label>
    <input id="wa-phone-id" name="phone_id" value="{{ phone_id }}" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
    <label for="wa-access-token" class="text-sm text-gray-300">Access Token</label>
    <input id="wa-access-token" name="access_token" value="{{ access_token }}" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
    <label for="wa-waba-id" class="text-sm text-gray-300">WABA ID</label>
    <input id="wa-waba-id" name="waba_id" value="{{ waba_id }}" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
    <label for="wa-verify-token" class="text-sm text-gray-300">Verify Token</label>
    <input id="wa-verify-token" name="verify_token" value="{{ verify_token }}" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
    <label for="wa-app-secret" class="text-sm text-gray-300">App Secret</label>
    <input id="wa-app-secret" name="app_secret" value="{{ app_secret }}" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
    <label class="flex items-center gap-2"><input type="checkbox" name="nonblocking" {% if nonblocking %}checked{% endif %} /> <span class="text-sm text-gray-300">Envío no bloqueante</span></label>
    <label for="wa-timeout" class="text-sm text-gray-300">Timeout de envío (segundos)</label>
    <input id="wa-timeout" name="send_timeout_seconds" value="{{ send_timeout_seconds }}" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
    <div class="sm:col-span-2"><button type="submit" class="px-3 py-2 rounded-md bg-primary text-primary-foreground">Guardar</button></div>
  </form>
  {% elif section=='maintenance' %}
  <form method="post" action="/admin/gyms/{{ gid }}/maintenance" class="space-y-3" hx-headers='{"accept":"application/json"}' hx-swap="none">
    <label for="maint-message" class="text-sm text-gray-300">Mensaje para usuarios</label>
    <textarea id="maint-message" name="message" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950 h-32"></textarea>
    <button type="submit" class="px-3 py-2 rounded-md bg-yellow-500 text-black">Activar mantenimiento</button>
  </form>
  <form method="post" action="/admin/gyms/{{ gid }}/maintenance/schedule" class="space-y-3 mt-3" hx-headers='{"accept":"application/json"}' hx-swap="none">
    <label for="maint-sched-message" class="text-sm text-gray-300">Mensaje para usuarios (opcional)</label>
    <textarea id="maint-sched-message" name="message" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950 h-24"></textarea>
    <label for="maint-until" class="text-sm text-gray-300">Hasta</label>
    <input id="maint-until" name="until" type="datetime-local" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
    <button type="submit" class="px-3 py-2 rounded-md bg-yellow-500 text-black">Programar mantenimiento</button>
  </form>
  <form method="post" action="/admin/gyms/{{ gid }}/maintenance/clear" class="mt-2" hx-headers='{"accept":"application/json"}' hx-swap="none">
    <button type="submit" class="px-3 py-2 rounded-md bg-green-600 text-white">Desactivar mantenimiento</button>
  </form>
  <h2 class="text-lg font-medium mt-4">Avisos a dueño</h2>
  <form method="post" action="/admin/gyms/{{ gid }}/maintenance/notify" class="flex flex-wrap gap-2 items-center" hx-headers='{"accept":"application/json"}' hx-swap="none">
    <label for="maint-notify" class="text-sm text-gray-300">Mensaje de mantenimiento (opcional)</label>
    <input id="maint-notify" name="message" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950 min-w-[320px]" />
    <button type="submit" class="px-3 py-2 rounded-md bg-primary text-primary-foreground">Enviar aviso</button>
  </form>
  {% elif section=='branding' %}
  <form method="post" action="/admin/gyms/{{ gid }}/branding" class="grid grid-cols-1 sm:grid-cols-2 gap-3" hx-headers='{"accept":"application/json"}' hx-swap="none">
    <label for="gym_name" class="text-sm text-gray-300">Nombre público</label>
    <input id="gym_name" name="gym_name" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
    <label for="gym_address" class="text-sm text-gray-300">Dirección</label>
    <input id="gym_address" name="gym_address" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
    <label for="logo_url" class="text-sm text-gray-300">Logo URL</label>
    <input id="logo_url" name="logo_url" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
    <div class="sm:col-span-2">
      <h2 class="text-lg font-medium">Colores</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3 mt-2">
        <label for="primary" class="text-sm text-gray-300">Primario</label>
        <input id="primary" name="primary" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
        <label for="secondary" class="text-sm text-gray-300">Secundario</label>
        <input id="secondary" name="secondary" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
        <label for="accent" class="text-sm text-gray-300">Acento</label>
        <input id="accent" name="accent" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
        <label for="bg" class="text-sm text-gray-300">Fondo</label>
        <input id="bg" name="bg" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
        <label for="card" class="text-sm text-gray-300">Tarjeta</label>
        <input id="card" name="card" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
        <label for="text" class="text-sm text-gray-300">Texto</label>
        <input id="text" name="text" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
        <label for="muted" class="text-sm text-gray-300">Mutado</label>
        <input id="muted" name="muted" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
        <label for="border" class="text-sm text-gray-300">Borde</label>
        <input id="border" name="border" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
      </div>
    </div>
    <div class="sm:col-span-2">
      <h2 class="text-lg font-medium">Tipografías</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-2">
        <label for="font_base" class="text-sm text-gray-300">Fuente base</label>
        <input id="font_base" name="font_base" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
        <label for="font_heading" class="text-sm text-gray-300">Fuente títulos</label>
        <input id="font_heading" name="font_heading" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
      </div>
    </div>
    <div class="sm:col-span-2"><button type="submit" class="px-3 py-2 rounded-md bg-primary text-primary-foreground">Guardar</button></div>
  </form>
  {% elif section=='subscription' %}
  <div class="grid gap-3">
    <div class="grid grid-cols-2 gap-2 text-sm">
      <div class="text-gray-400">Plan actual</div><div>{{ (subscription.plan or '') }}</div>
      <div class="text-gray-400">Inicio</div><div>{{ (subscription.start_date or '') }}</div>
      <div class="text-gray-400">Válido hasta</div><div>{{ (subscription.valid_until or '') }}</div>
    </div>
    <h2 class="text-lg font-medium">Cambiar suscripción</h2>
    <form method="post" action="/admin/gyms/{{ gid }}/subscription" class="grid grid-cols-1 sm:grid-cols-2 gap-3" hx-headers='{"accept":"application/json"}' hx-swap="none">
      <label for="plan_id" class="text-sm text-gray-300">Plan</label>
      <select id="plan_id" name="plan_id" required class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950">
        {% for p in plans %}
          <option value="{{ p.id }}">{{ p.name }} · {{ p.amount }} {{ p.currency }}</option>
        {% endfor %}
      </select>
      <label for="start_date" class="text-sm text-gray-300">Inicio</label>
      <input id="start_date" name="start_date" type="date" required class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
      <div class="sm:col-span-2"><button type="submit" class="px-3 py-2 rounded-md bg-primary text-primary-foreground">Guardar</button></div>
    </form>
    <h2 class="text-lg font-medium mt-4">Recordatorio de vencimiento</h2>
    <form method="post" action="/admin/gyms/{{ gid }}/subscription/remind" class="flex flex-wrap gap-2 items-center" hx-headers='{"accept":"application/json"}' hx-swap="none">
      <label for="sub-remind" class="text-sm text-gray-300">Mensaje opcional</label>
      <input id="sub-remind" name="message" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950 min-w-[320px]" />
      <button type="submit" class="px-3 py-2 rounded-md bg-primary text-primary-foreground">Enviar recordatorio</button>
    </form>
  </div>
  {% elif section=='payments' %}
  <div class="overflow-x-auto">
    <table class="w-full text-sm">
      <thead>
        <tr class="text-gray-300">
          <th class="text-left p-2">ID</th>
          <th class="text-left p-2">Plan</th>
          <th class="text-left p-2">Monto</th>
          <th class="text-left p-2">Moneda</th>
          <th class="text-left p-2">Pagado</th>
          <th class="text-left p-2">Válido hasta</th>
          <th class="text-left p-2">Status</th>
          <th class="text-left p-2">Notas</th>
        </tr>
      </thead>
      <tbody>
        {% for p in items %}
        <tr class="border-t border-gray-800">
          <td class="p-2">{{ p.id }}</td>
          <td class="p-2">{{ p.plan }}</td>
          <td class="p-2">{{ p.amount }}</td>
          <td class="p-2">{{ p.currency }}</td>
          <td class="p-2">{{ p.paid_at }}</td>
          <td class="p-2">{{ p.valid_until }}</td>
          <td class="p-2">{{ p.status }}</td>
          <td class="p-2">{{ p.notes }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div>
    <h2 class="text-lg font-medium">Registrar pago</h2>
    <form method="post" action="/admin/gyms/{{ gid }}/payments" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3 mt-2" hx-headers='{"accept":"application/json"}' hx-swap="none">
      <label for="pay-plan" class="text-sm text-gray-300">Plan</label>
      <input id="pay-plan" name="plan" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
      <label for="pay-amount" class="text-sm text-gray-300">Monto</label>
      <input id="pay-amount" name="amount" type="number" min="0.01" step="0.01" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
      <label for="pay-currency" class="text-sm text-gray-300">Moneda</label>
      <input id="pay-currency" name="currency" pattern="^[A-Z]{3,4}$" oninput="this.value=this.value.toUpperCase()" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
      <label for="pay-valid" class="text-sm text-gray-300">Válido hasta</label>
      <input id="pay-valid" name="valid_until" type="date" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
      <label for="pay-status" class="text-sm text-gray-300">Status</label>
      <input id="pay-status" name="status" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
      <label for="pay-notes" class="text-sm text-gray-300">Notas</label>
      <input id="pay-notes" name="notes" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
      <div class="sm:col-span-2 md:col-span-3">
        <button type="submit" class="px-3 py-2 rounded-md bg-primary text-primary-foreground">Guardar</button>
      </div>
    </form>
  </div>
  {% elif section=='storage' %}
  <form method="post" action="/admin/gyms/{{ gid }}/storage" class="grid grid-cols-1 sm:grid-cols-2 gap-3" hx-headers='{"accept":"application/json"}' hx-swap="none">
    <label for="storage-bucket" class="text-sm text-gray-300">Bucket Name</label>
    <input id="storage-bucket" name="bucket_name" value="{{ bucket_name }}" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
    <label class="flex items-center gap-2"><input type="checkbox" name="provision" /> Crear/Actualizar recursos ahora</label>
    <div class="sm:col-span-2"><button type="submit" class="px-3 py-2 rounded-md bg-primary text-primary-foreground">Guardar</button></div>
  </form>
  <div class="grid gap-3 mt-3">
    <div class="grid grid-cols-2 gap-2 text-sm"><div class="text-gray-400">Bucket ID</div><div>{{ bucket_id }}</div></div>
    <div class="grid grid-cols-2 gap-2 text-sm"><div class="text-gray-400">Key ID</div><div>{{ key_id }}</div></div>
    <div class="grid grid-cols-2 gap-2 items-center text-sm"><div class="text-gray-400">Application Key</div><div id="appkey">{{ application_key and '••••••••••••••' or '' }}</div></div>
    <div class="flex flex-wrap gap-2">
      <form method="post" action="/admin/gyms/{{ gid }}/b2/regenerate-key" hx-headers='{"accept":"application/json"}' hx-swap="none"><button type="submit" class="px-3 py-2 rounded-md bg-primary text-primary-foreground">Regenerar clave</button></form>
      <form method="post" action="/admin/gyms/{{ gid }}/b2/delete-bucket" hx-headers='{"accept":"application/json"}' hx-swap="none"><button type="submit" class="px-3 py-2 rounded-md bg-red-600 text-white">Eliminar bucket</button></form>
    </div>
    <button id="reveal" class="px-3 py-2 rounded-md bg-gray-900">Mostrar clave</button>
  </div>
  <script>(function(){var b=document.getElementById('reveal');if(!b)return;var s=document.getElementById('appkey');var shown=false;b.addEventListener('click',function(){if(!s)return;shown=!shown;s.textContent=shown?"{{ application_key }}":"{{ application_key and '••••••••••••••' or '' }}"})})();</script>
  {% elif section=='health' %}
  <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
    <div class="p-3 rounded-xl border border-gray-800 bg-[#0b1222]">
      <div class="text-gray-400">Base de datos</div>
      <div class="mt-1">{{ 'OK' if db_ok else 'Error' }}{% if db_err %} · {{ db_err }}{% endif %}</div>
    </div>
    <div class="p-3 rounded-xl border border-gray-800 bg-[#0b1222]">
      <div class="text-gray-400">WhatsApp</div>
      <div class="mt-1">{{ 'OK' if wa_ok else 'Error' }}{% if wa_status %} · {{ wa_status }}{% endif %}</div>
    </div>
    <div class="p-3 rounded-xl border border-gray-800 bg-[#0b1222]">
      <div class="text-gray-400">Storage</div>
      <div class="mt-1">{{ 'Configurado' if st_cfg else 'No configurado' }}{% if st_ok %} · OK{% endif %}</div>
    </div>
  </div>
  <div class="mt-3">
    {% if webapp_url %}
    <a href="{{ webapp_url }}" target="_blank" rel="noopener" class="px-3 py-2 rounded-md bg-primary text-primary-foreground"><i class="fa-solid fa-up-right-from-square"></i><span class="ml-2">Abrir WebApp</span></a>
    {% endif %}
  </div>
  {% endif %}
</div>
{% endblock %}
  <script>
  (function(){
    function rebindSettingsInteractions(){var b=document.getElementById('reveal');if(b){var s=document.getElementById('appkey');var shown=false;b.addEventListener('click',function(){if(!s)return;shown=!shown;s.textContent=shown?"{{ application_key }}":"{{ application_key and '••••••••••••••' or '' }}"})}}
    document.body.addEventListener('htmx:afterOnLoad', function(evt){try{var xhr=evt.detail.xhr;var txt=xhr&&xhr.responseText||'';var j=null;try{j=JSON.parse(txt)}catch(_){j=null}if(j&&j.ok){if(window.toast){window.toast('Guardado','success')}var url=new URL(window.location.href);url.searchParams.set('ui','1');fetch(url.toString(),{headers:{'accept':'text/html'}}).then(function(r){return r.text()}).then(function(html){try{var doc=new DOMParser().parseFromString(html,'text/html');var next=doc.querySelector('#settings-section');var cur=document.querySelector('#settings-section');if(next&&cur){cur.innerHTML=next.innerHTML;rebindSettingsInteractions()}}catch(_){}})} else {if(window.toast){window.toast('Error en operación','error')}}}catch(_){}});
  })();
  </script>