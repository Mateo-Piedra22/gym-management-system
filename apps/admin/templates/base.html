<!DOCTYPE html>
<html lang="es" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GymMS Admin</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config = { darkMode: 'class', theme: { extend: { colors: { primary: '#7c3aed', 'primary-foreground': '#ffffff' } } } }</script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/htmx.org@1.9.12"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://unpkg.com/flowbite@2.3.0/dist/flowbite.min.js"></script>
  <style>
    .skeleton { position: relative; overflow: hidden; background-color: rgb(31 41 55); }
    .skeleton::after { content: ""; position: absolute; inset: 0; transform: translateX(-100%); background-image: linear-gradient(90deg, rgba(31,41,55,0) 0, rgba(107,114,128,.15) 50%, rgba(31,41,55,0) 100%); animation: shimmer 1.5s infinite; }
    @keyframes shimmer { 100% { transform: translateX(100%) } }
    .htmx-indicator { display: none }
    .htmx-indicator.htmx-request { display: block }
  </style>
</head>
<body class="bg-gray-950 text-gray-100 min-h-screen" x-data="{ open: {{ 'false' if hide_sidebar else 'true' }}, isMobile: window.innerWidth < 768 }" x-init="(() => { const onResize = () => { isMobile = window.innerWidth < 768; if (!isMobile) { open = true } }; window.addEventListener('resize', onResize); onResize(); })()" hx-boost="true" hx-target="#main" hx-select="main > *" hx-push-url="true" hx-indicator="#main-indicator">
  <div x-bind:class="(isMobile ? 'grid grid-cols-1' : (open ? 'grid grid-cols-[240px,1fr]' : 'grid grid-cols-1')) + ' min-h-screen'" class="min-h-screen">
    {% if not hide_sidebar %}
    <aside x-show="open" x-bind:class="isMobile ? 'fixed inset-y-0 left-0 w-[240px] z-50 bg-[#0b1222] border-r border-gray-800 p-4' : 'bg-[#0b1222] border-r border-gray-800 p-4'">
      <div class="text-lg font-bold flex items-center gap-2">
        <i class="fa-solid fa-dumbbell"></i>
        <span>GymMS Admin</span>
      </div>
      <nav class="mt-3 space-y-2" hx-boost="true" hx-target="#main" hx-select="main > *" hx-push-url="true" hx-indicator="#main-indicator" hx-headers='{"accept":"text/html"}'>
        {% set p = request.url.path %}
        <a href="/admin/?ui=1" hx-headers='{"accept":"text/html"}' class="flex items-center gap-2 px-3 py-2 rounded-md {{ 'bg-primary text-primary-foreground' if p == '/admin' or p == '/admin/' else 'bg-gray-900' }}'><i class="fa-solid fa-house"></i><span>Home</span></a>
        <a href="/admin/gyms?ui=1" hx-headers='{"accept":"text/html"}' class="flex items-center gap-2 px-3 py-2 rounded-md {{ 'bg-primary text-primary-foreground' if p.startswith('/admin/gyms') else 'bg-gray-900' }}'><i class="fa-solid fa-building"></i><span>Gimnasios</span></a>
        <a href="/admin/audit?ui=1" hx-headers='{"accept":"text/html"}' class="flex items-center gap-2 px-3 py-2 rounded-md {{ 'bg-primary text-primary-foreground' if p.startswith('/admin/audit') else 'bg-gray-900' }}'><i class="fa-solid fa-user-secret"></i><span>Auditoría</span></a>
        <a href="/admin/subscriptions/dashboard?ui=1" hx-headers='{"accept":"text/html"}' class="flex items-center gap-2 px-3 py-2 rounded-md {{ 'bg-primary text-primary-foreground' if p.startswith('/admin/subscriptions') else 'bg-gray-900' }}'><i class="fa-solid fa-ticket"></i><span>Suscripciones</span></a>
        <a href="/admin/plans?ui=1" hx-headers='{"accept":"text/html"}' class="flex items-center gap-2 px-3 py-2 rounded-md {{ 'bg-primary text-primary-foreground' if p.startswith('/admin/plans') else 'bg-gray-900' }}'><i class="fa-solid fa-list"></i><span>Planes</span></a>
        <a href="/admin/templates?ui=1" hx-headers='{"accept":"text/html"}' class="flex items-center gap-2 px-3 py-2 rounded-md {{ 'bg-primary text-primary-foreground' if p.startswith('/admin/templates') else 'bg-gray-900' }}'><i class="fa-solid fa-message"></i><span>Templates</span></a>
      </nav>
    </aside>
    <div x-show="open && isMobile" class="fixed inset-0 bg-black/60 z-40" x-on:click="open=false"></div>
    {% endif %}
    <main id="main" hx-history-elt class="p-5 w-full min-w-0">
      {% if not hide_sidebar %}
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-2">
          <button id="sidebar-toggle" class="px-3 py-2 rounded-md bg-gray-900" x-on:click="open = !open"><i class="fa-solid fa-bars"></i><span class="ml-2">Menú</span></button>
          <button id="global-open-k" class="px-3 py-2 rounded-md bg-gray-900"><i class="fa-solid fa-magnifying-glass"></i><span class="ml-2">Buscar</span></button>
        </div>
        <div class="flex items-center gap-2">
          <a href="/admin/login" class="px-3 py-2 rounded-md bg-gray-900"><i class="fa-solid fa-right-to-bracket"></i><span class="ml-2">Cambiar cuenta</span></a>
          <form method="post" action="/admin/sessions/invalidate" class="inline"><button type="submit" class="px-3 py-2 rounded-md bg-red-600 text-white"><i class="fa-solid fa-ban"></i><span class="ml-2">Invalidar sesiones</span></button></form>
          <button id="toggle-dark" class="px-3 py-2 rounded-md bg-gray-900"><i class="fa-solid fa-moon"></i></button>
        </div>
      </div>
      {% endif %}
      {% macro btn(label, variant='default', href=None, attrs='', icon=None) %}
        {% set cls = 'px-3 py-2 rounded-md bg-gray-900' %}
        {% if variant=='primary' %}{% set cls = 'px-3 py-2 rounded-md bg-primary text-primary-foreground' %}{% endif %}
        {% if variant=='danger' %}{% set cls = 'px-3 py-2 rounded-md bg-red-600 text-white' %}{% endif %}
        {% if variant=='success' %}{% set cls = 'px-3 py-2 rounded-md bg-green-600 text-white' %}{% endif %}
        {% if variant=='warning' %}{% set cls = 'px-3 py-2 rounded-md bg-yellow-500 text-black' %}{% endif %}
        {% if href %}
          <a href="{{ href }}" class="{{ cls }}" {{ attrs|safe }}>
            {% if icon %}<i class="{{ icon }}"></i><span class="ml-2">{{ label }}</span>{% else %}{{ label }}{% endif %}
          </a>
        {% else %}
          <button class="{{ cls }}" {{ attrs|safe }}>
            {% if icon %}<i class="{{ icon }}"></i><span class="ml-2">{{ label }}</span>{% else %}{{ label }}{% endif %}
          </button>
        {% endif %}
      {% endmacro %}
      {% macro status_badge(status) %}
        {% set st = (status or '') %}
        {% set cls = 'px-2 py-1 rounded-full text-xs bg-gray-700 text-white' %}
        {% if st=='active' %}{% set cls = 'px-2 py-1 rounded-full text-xs bg-green-600 text-white' %}{% endif %}
        {% if st=='suspended' %}{% set cls = 'px-2 py-1 rounded-full text-xs bg-red-600 text-white' %}{% endif %}
        {% if st=='maintenance' %}{% set cls = 'px-2 py-1 rounded-full text-xs bg-yellow-500 text-black' %}{% endif %}
        {% if st=='paid' %}{% set cls = 'px-2 py-1 rounded-full text-xs bg-green-600 text-white' %}{% endif %}
        {% if st=='pending' %}{% set cls = 'px-2 py-1 rounded-full text-xs bg-yellow-500 text-black' %}{% endif %}
        {% if st=='failed' %}{% set cls = 'px-2 py-1 rounded-full text-xs bg-red-600 text-white' %}{% endif %}
        <span class="{{ cls }}">{{ status }}</span>
      {% endmacro %}
      {% block content %}{% endblock %}
    </main>
  </div>
  <div id="main-indicator" class="htmx-indicator fixed top-4 right-4 z-50 hidden">
    <div class="flex items-center gap-2 px-3 py-2 rounded-md bg-gray-900 border border-gray-800 shadow">
      <div class="w-4 h-4 rounded-full border-2 border-gray-500 border-t-transparent animate-spin"></div>
      <span class="text-sm">Cargando...</span>
    </div>
  </div>
  <div id="global-k-overlay" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50" tabindex="-1">
    <div class="w-[92%] max-w-[720px] bg-gray-900 border border-gray-800 rounded-xl">
      <div class="p-3 border-b border-gray-800 flex justify-between items-center">
        <div class="font-semibold">Búsqueda</div>
        <button id="global-k-close" class="px-2 py-1 rounded-md bg-gray-800">Cerrar</button>
      </div>
      <div class="p-3">
        <input id="global-k-input" placeholder="Buscar gimnasios o templates" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950 w-full" />
        <div id="global-k-results" class="mt-3 grid gap-2"></div>
      </div>
    </div>
  </div>
  <div id="global-confirm-overlay" role="dialog" aria-modal="true" aria-labelledby="global-confirm-title" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60" tabindex="-1">
    <div class="relative p-4 w-full max-w-md">
      <div class="relative bg-gray-900 rounded-lg border border-gray-800 shadow">
        <div class="flex items-center justify-between p-3 border-b border-gray-800">
          <h3 id="global-confirm-title" class="text-base font-semibold text-white">Confirmar acción</h3>
          <button id="global-confirm-cancel" class="px-2 py-1 rounded-md bg-gray-800">Cerrar</button>
        </div>
        <div class="p-3">
          <p id="global-confirm-message" class="text-gray-300">¿Confirmar?</p>
        </div>
        <div class="p-3 flex justify-end gap-2">
          <button id="global-confirm-cancel-2" class="px-2 py-1 rounded-md bg-gray-800">Cancelar</button>
          <button id="global-confirm-yes" class="px-2 py-1 rounded-md bg-primary text-primary-foreground">Confirmar</button>
        </div>
      </div>
    </div>
  </div>
  <script>
  (function(){
    try { var p = window.location && window.location.pathname ? window.location.pathname : ''; var pref = p.indexOf('/api/')===0 || p==='/api' || p.indexOf('/api')===0 ? '/api' : ''; if (pref) { var as = document.querySelectorAll('a[href^="/admin/"]'); for (var i=0;i<as.length;i++){ var h = as[i].getAttribute('href'); if (h && h.indexOf('/admin/')===0) { as[i].setAttribute('href', pref + h); } } var fs = document.querySelectorAll('form[action^="/admin/"]'); for (var j=0;j<fs.length;j++){ var a = fs[j].getAttribute('action'); if (a && a.indexOf('/admin/')===0) { fs[j].setAttribute('action', pref + a); } } } } catch(_){ }
    function toast(msg,type){var c=document.getElementById('toast-container');if(!c){var t=document.createElement('div');t.id='toast-container';t.setAttribute('style','display:grid;gap:8px;position:fixed;top:16px;right:16px');document.body.appendChild(t);c=t}var bg=type==='error'?'#ef4444':(type==='info'?'#374151':'#16a34a');var el=document.createElement('div');el.setAttribute('style','background:'+bg+';color:#fff;padding:10px 12px;border-radius:8px;box-shadow:0 10px 15px rgba(0,0,0,0.2)');el.textContent=msg;c.appendChild(el);setTimeout(function(){if(el&&el.parentNode){el.parentNode.removeChild(el)}},3000)}
    window.toast = toast;
    var darkBtn=document.getElementById('toggle-dark');if(darkBtn){darkBtn.addEventListener('click',function(){var h=document.documentElement;var on=h.classList.contains('dark');if(on){h.classList.remove('dark')}else{h.classList.add('dark')}})}
    var open=document.getElementById('global-open-k');var overlay=document.getElementById('global-k-overlay');var close=document.getElementById('global-k-close');var inp=document.getElementById('global-k-input');var res=document.getElementById('global-k-results');function openK(){if(overlay){overlay.classList.remove('hidden');overlay.classList.add('flex');document.body.classList.add('overflow-hidden');setTimeout(function(){if(inp){inp.focus()}},50)}}function closeK(){if(overlay){overlay.classList.add('hidden');overlay.classList.remove('flex');document.body.classList.remove('overflow-hidden')}}if(overlay){overlay.addEventListener('click',function(e){if(e.target===overlay){closeK()}})}window.openGlobalK = openK; if(open){open.addEventListener('click',openK)}if(close){close.addEventListener('click',closeK)}
    var _t=null;function runSearch(q){if(!res)return;clearTimeout(_t);_t=setTimeout(function(){res.innerHTML='<div class="skeleton w-full h-4 rounded-md"></div>';var list=[];fetch('/admin/gyms?q='+encodeURIComponent(q)+'&page=1&page_size=10',{headers:{'accept':'application/json'}}).then(function(r){return r.json()}).then(function(j){var items=(j&&j.items)||[];for(var i=0;i<items.length;i++){var g=items[i];list.push({t:'gym',id:String(g.id||''),label:String(g.nombre||'')+' · '+String(g.subdominio||'')})}return fetch('/admin/templates',{headers:{'accept':'application/json'}})}).then(function(r){return r.json()}).then(function(j){var t=(j&&j.templates)||[];for(var i=0;i<t.length;i++){list.push({t:'template',id:String(i+1),label:String(t[i]||'')})}var pref='';try{var p=window.location&&window.location.pathname?window.location.pathname:'';pref=(p.indexOf('/api/')===0||p==='/api'||p.indexOf('/api')===0)?'/api':''}catch(_){pref=''}var html='';for(var k=0;k<list.length;k++){var it=list[k];var href=it.t==='gym'?(pref+'/admin/gyms/'+it.id+'/health?ui=1'):(pref+'/admin/templates?ui=1');html+='<a href="'+href+'" class="flex justify-between items-center px-3 py-2 rounded-md border border-gray-800 bg-[#0b1222] text-white"><span>'+it.label+'</span><span class="text-gray-400 text-xs">'+it.t+'</span></a>'}if(!html){html='<div class="text-gray-400">Sin resultados</div>'}res.innerHTML=html}).catch(function(){res.innerHTML='<div class="text-red-600">Error en búsqueda</div>'})},300)}
    if(inp){inp.addEventListener('input',function(){runSearch(inp.value)})}
    document.addEventListener('keydown',function(e){if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='k'){e.preventDefault();openK()}});
    
    document.addEventListener('htmx:responseError', function(ev){ try { var s = ev && ev.detail && ev.detail.xhr ? ev.detail.xhr.status : 0; var elt = ev && ev.detail ? ev.detail.elt : null; var tag = elt && elt.tagName ? elt.tagName.toLowerCase() : ''; toast('Error '+s+' cargando contenido','error'); var p = ev && ev.detail && ev.detail.pathInfo ? ev.detail.pathInfo.path : null; if ((tag==='a' || tag==='form') && p && typeof p === 'string') { window.location.href = p; } } catch(_){ } });
    document.addEventListener('htmx:send', function(){ try { var ind = document.querySelector('#main-indicator'); if (ind){ ind.classList.add('htmx-request'); } } catch(_){ } });
    document.addEventListener('htmx:afterOnLoad', function(ev){ try { var ind = document.querySelector('#main-indicator'); if (ind){ ind.classList.remove('htmx-request'); } var xhr = ev && ev.detail ? ev.detail.xhr : null; var ct = xhr && xhr.getResponseHeader ? (xhr.getResponseHeader('content-type')||'') : ''; var p = window.location && window.location.pathname ? window.location.pathname : ''; var skip = ['/admin/gyms','/admin/audit','/admin/subscriptions','/admin/plans','/admin/templates','/admin/passwords','/admin/owner']; for (var i=0;i<skip.length;i++){ if (p.indexOf(skip[i])===0) { return } } if (ct.indexOf('application/json')!==-1){ var txt = xhr && xhr.responseText || ''; var j = null; try { j = JSON.parse(txt); } catch(_){ j = null } if (j && j.ok){ if (window.toast) { window.toast('Operación exitosa','success'); } var url = new URL(window.location.href); url.searchParams.set('ui','1'); fetch(url.toString(), { headers: { 'accept':'text/html' } }).then(function(r){ return r.text() }).then(function(html){ try { var doc = new DOMParser().parseFromString(html,'text/html'); var next = doc.querySelector('main'); var cur = document.querySelector('main'); if (next && cur) { cur.innerHTML = next.innerHTML; } } catch(_){ } }).catch(function(){ }); } else if (j && j.error) { if (window.toast) { window.toast('Error: '+String(j.error||''),'error'); } } } } catch(_){ } });
    window.slugify=function(v){var s=String(v||'').toLowerCase();s=s.normalize('NFD').replace(/[\u0300-\u036f]/g,'');s=s.replace(/[^a-z0-9\s-]/g,'');s=s.trim().replace(/\s+/g,'-');s=s.replace(/-+/g,'-');return s.slice(0,63)};
    window.bindSubdomainBucket=function(nameId,subId,statusId,bucketId,prefix){var n=document.getElementById(nameId);var s=document.getElementById(subId);var st=statusId?document.getElementById(statusId):null;var b=bucketId?document.getElementById(bucketId):null;var pref=String(prefix||'').trim();function setBucket(val){if(!b)return;var v=(pref?pref+'-':'')+String(val||'');if(b.tagName==='INPUT'){b.value=v}else{b.textContent=v}}function update(){var base=window.slugify(n&&n.value||'');if(!base){if(st){st.textContent='';st.removeAttribute('style')}if(!s||!s.value){setBucket('')}return}var userEdit=(s&&s.dataset&&s.dataset.userEdited==='true');if(s&&!userEdit){fetch('/admin/subdomains/check?name='+encodeURIComponent(String(base||'')),{headers:{'accept':'application/json'}}).then(function(r){return r.json()}).then(function(j){var sug=String(j.suggestion||base||'');if(s){s.value=sug}if(st){st.textContent=j.available?'Disponible':'Sugerido: '+sug;st.style.color=j.available?'#16a34a':'#f59e0b'}setBucket(sug)}).catch(function(_){})}else{setBucket((s&&s.value)||base)}}var timer=null;function schedule(){if(timer)clearTimeout(timer);timer=setTimeout(update,200)}if(n){n.addEventListener('input',schedule)}if(s){s.addEventListener('input',function(){s.dataset.userEdited='true';setBucket(s.value||'')})}update()};
    (function(){var ov=document.getElementById('global-confirm-overlay');var msg=document.getElementById('global-confirm-message');var yes=document.getElementById('global-confirm-yes');var cancel=document.getElementById('global-confirm-cancel');var cancel2=document.getElementById('global-confirm-cancel-2');var pending=null;function open(m,formOrFn){if(ov){ov.classList.remove('hidden');document.body.classList.add('overflow-hidden');msg.textContent=m||'¿Confirmar?';pending=formOrFn}}function close(){if(ov){ov.classList.add('hidden');document.body.classList.remove('overflow-hidden');pending=null}}window.openGlobalConfirm=open;window.closeGlobalConfirm=close;window.confirmAction=function(m,fn){open(m,typeof fn==='function'?fn:null)};document.addEventListener('submit',function(e){var f=e&&e.target;if(!f||!f.classList||!f.classList.contains('needs-confirm'))return;e.preventDefault();var m=f.getAttribute('data-confirm')||'¿Confirmar?';open(m,f)});if(yes){yes.addEventListener('click',function(){try{if(typeof pending==='function'){pending()}else if(pending&&pending.submit){pending.submit()}}catch(_){ }close()})}if(cancel){cancel.addEventListener('click',close)}if(cancel2){cancel2.addEventListener('click',close)}if(ov){ov.addEventListener('click',function(e){if(e.target===ov){close()}})}document.addEventListener('keydown',function(e){if(e.key==='Escape'){if(ov&&!ov.classList.contains('hidden')){close()}}})})();
  })();
  </script>
</body>
</html>