<!DOCTYPE html>
<html lang="es" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GymMS Admin</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config = { darkMode: 'class', theme: { extend: { colors: { primary: '#7c3aed', 'primary-foreground': '#ffffff' } } } }</script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/htmx.org@1.9.12"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://unpkg.com/flowbite@2.3.0/dist/flowbite.min.js"></script>
  <style>
    .skeleton { position: relative; overflow: hidden; background-color: rgb(31 41 55); }
    .skeleton::after { content: ""; position: absolute; inset: 0; transform: translateX(-100%); background-image: linear-gradient(90deg, rgba(31,41,55,0) 0, rgba(107,114,128,.15) 50%, rgba(31,41,55,0) 100%); animation: shimmer 1.5s infinite; }
    @keyframes shimmer { 100% { transform: translateX(100%) } }
    .htmx-indicator { display: none }
    .htmx-indicator.htmx-request { display: block }
  </style>
</head>
<body class="bg-gray-950 text-gray-100 min-h-screen" x-data="{ open: false }" hx-boost="true" hx-target="#main" hx-select="main > *" hx-push-url="true" hx-indicator="#main-indicator">
  <div class="{{ 'min-h-screen' if hide_sidebar else 'grid grid-cols-[240px,1fr] min-h-screen' }}">
    {% if not hide_sidebar %}
    <aside class="bg-[#0b1222] border-r border-gray-800 p-4">
      <div class="text-lg font-bold flex items-center gap-2">
        <i class="fa-solid fa-dumbbell"></i>
        <span>GymMS Admin</span>
      </div>
      <nav class="mt-3 space-y-2" hx-boost="true" hx-target="#main" hx-select="main > *" hx-push-url="true" hx-indicator="#main-indicator" hx-headers='{"accept":"text/html"}'>
        {% set p = request.url.path %}
        <a href="/admin/?ui=1" hx-headers='{"accept":"text/html"}' class="flex items-center gap-2 px-3 py-2 rounded-md {{ 'bg-primary text-primary-foreground' if p == '/admin' or p == '/admin/' else 'bg-gray-900' }}'><i class="fa-solid fa-house"></i><span>Home</span></a>
        <a href="/admin/gyms?ui=1" hx-headers='{"accept":"text/html"}' class="flex items-center gap-2 px-3 py-2 rounded-md {{ 'bg-primary text-primary-foreground' if p.startswith('/admin/gyms') else 'bg-gray-900' }}'><i class="fa-solid fa-building"></i><span>Gimnasios</span></a>
        <a href="/admin/audit?ui=1" hx-headers='{"accept":"text/html"}' class="flex items-center gap-2 px-3 py-2 rounded-md {{ 'bg-primary text-primary-foreground' if p.startswith('/admin/audit') else 'bg-gray-900' }}'><i class="fa-solid fa-user-secret"></i><span>Auditoría</span></a>
        <a href="/admin/subscriptions/dashboard?ui=1" hx-headers='{"accept":"text/html"}' class="flex items-center gap-2 px-3 py-2 rounded-md {{ 'bg-primary text-primary-foreground' if p.startswith('/admin/subscriptions') else 'bg-gray-900' }}'><i class="fa-solid fa-ticket"></i><span>Suscripciones</span></a>
        <a href="/admin/plans?ui=1" hx-headers='{"accept":"text/html"}' class="flex items-center gap-2 px-3 py-2 rounded-md {{ 'bg-primary text-primary-foreground' if p.startswith('/admin/plans') else 'bg-gray-900' }}'><i class="fa-solid fa-list"></i><span>Planes</span></a>
        <a href="/admin/templates?ui=1" hx-headers='{"accept":"text/html"}' class="flex items-center gap-2 px-3 py-2 rounded-md {{ 'bg-primary text-primary-foreground' if p.startswith('/admin/templates') else 'bg-gray-900' }}'><i class="fa-solid fa-message"></i><span>Templates</span></a>
      </nav>
    </aside>
    {% endif %}
    <main id="main" hx-history-elt class="p-5">
      {% if not hide_sidebar %}
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-2">
          <button id="global-open-k" class="px-3 py-2 rounded-md bg-gray-900"><i class="fa-solid fa-magnifying-glass"></i><span class="ml-2">Buscar</span></button>
        </div>
        <div class="flex items-center gap-2">
          <a href="/admin/login" class="px-3 py-2 rounded-md bg-gray-900"><i class="fa-solid fa-right-to-bracket"></i><span class="ml-2">Cambiar cuenta</span></a>
          <form method="post" action="/admin/sessions/invalidate" class="inline"><button type="submit" class="px-3 py-2 rounded-md bg-red-600 text-white"><i class="fa-solid fa-ban"></i><span class="ml-2">Invalidar sesiones</span></button></form>
          <button id="toggle-dark" class="px-3 py-2 rounded-md bg-gray-900"><i class="fa-solid fa-moon"></i></button>
        </div>
      </div>
      {% endif %}
      {% macro btn(label, variant='default', href=None, attrs='', icon=None) %}
        {% set cls = 'px-3 py-2 rounded-md bg-gray-900' %}
        {% if variant=='primary' %}{% set cls = 'px-3 py-2 rounded-md bg-primary text-primary-foreground' %}{% endif %}
        {% if variant=='danger' %}{% set cls = 'px-3 py-2 rounded-md bg-red-600 text-white' %}{% endif %}
        {% if variant=='success' %}{% set cls = 'px-3 py-2 rounded-md bg-green-600 text-white' %}{% endif %}
        {% if variant=='warning' %}{% set cls = 'px-3 py-2 rounded-md bg-yellow-500 text-black' %}{% endif %}
        {% if href %}
          <a href="{{ href }}" class="{{ cls }}" {{ attrs|safe }}>
            {% if icon %}<i class="{{ icon }}"></i><span class="ml-2">{{ label }}</span>{% else %}{{ label }}{% endif %}
          </a>
        {% else %}
          <button class="{{ cls }}" {{ attrs|safe }}>
            {% if icon %}<i class="{{ icon }}"></i><span class="ml-2">{{ label }}</span>{% else %}{{ label }}{% endif %}
          </button>
        {% endif %}
      {% endmacro %}
      {% macro status_badge(status) %}
        {% set st = (status or '') %}
        {% set cls = 'px-2 py-1 rounded-full text-xs bg-gray-700 text-white' %}
        {% if st=='active' %}{% set cls = 'px-2 py-1 rounded-full text-xs bg-green-600 text-white' %}{% endif %}
        {% if st=='suspended' %}{% set cls = 'px-2 py-1 rounded-full text-xs bg-red-600 text-white' %}{% endif %}
        {% if st=='maintenance' %}{% set cls = 'px-2 py-1 rounded-full text-xs bg-yellow-500 text-black' %}{% endif %}
        {% if st=='paid' %}{% set cls = 'px-2 py-1 rounded-full text-xs bg-green-600 text-white' %}{% endif %}
        {% if st=='pending' %}{% set cls = 'px-2 py-1 rounded-full text-xs bg-yellow-500 text-black' %}{% endif %}
        {% if st=='failed' %}{% set cls = 'px-2 py-1 rounded-full text-xs bg-red-600 text-white' %}{% endif %}
        <span class="{{ cls }}">{{ status }}</span>
      {% endmacro %}
      {% block content %}{% endblock %}
    </main>
  </div>
  <div id="main-indicator" class="htmx-indicator fixed top-4 right-4 z-50 hidden">
    <div class="flex items-center gap-2 px-3 py-2 rounded-md bg-gray-900 border border-gray-800 shadow">
      <div class="w-4 h-4 rounded-full border-2 border-gray-500 border-t-transparent animate-spin"></div>
      <span class="text-sm">Cargando...</span>
    </div>
  </div>
  <div id="global-k-overlay" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50">
    <div class="w-[92%] max-w-[720px] bg-gray-900 border border-gray-800 rounded-xl">
      <div class="p-3 border-b border-gray-800 flex justify-between items-center">
        <div class="font-semibold">Búsqueda</div>
        <button id="global-k-close" class="px-2 py-1 rounded-md bg-gray-800">Cerrar</button>
      </div>
      <div class="p-3">
        <input id="global-k-input" placeholder="Buscar gimnasios o templates" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950 w-full" />
        <div id="global-k-results" class="mt-3 grid gap-2"></div>
      </div>
    </div>
  </div>
  <script>
  (function(){
    try { var p = window.location && window.location.pathname ? window.location.pathname : ''; var pref = p.indexOf('/api/')===0 || p==='/api' || p.indexOf('/api')===0 ? '/api' : ''; if (pref) { var as = document.querySelectorAll('a[href^="/admin/"]'); for (var i=0;i<as.length;i++){ var h = as[i].getAttribute('href'); if (h && h.indexOf('/admin/')===0) { as[i].setAttribute('href', pref + h); } } var fs = document.querySelectorAll('form[action^="/admin/"]'); for (var j=0;j<fs.length;j++){ var a = fs[j].getAttribute('action'); if (a && a.indexOf('/admin/')===0) { fs[j].setAttribute('action', pref + a); } } } } catch(_){ }
    function toast(msg,type){var c=document.getElementById('toast-container');if(!c){var t=document.createElement('div');t.id='toast-container';t.setAttribute('style','display:grid;gap:8px;position:fixed;top:16px;right:16px');document.body.appendChild(t);c=t}var bg=type==='error'?'#ef4444':(type==='info'?'#374151':'#16a34a');var el=document.createElement('div');el.setAttribute('style','background:'+bg+';color:#fff;padding:10px 12px;border-radius:8px;box-shadow:0 10px 15px rgba(0,0,0,0.2)');el.textContent=msg;c.appendChild(el);setTimeout(function(){if(el&&el.parentNode){el.parentNode.removeChild(el)}},3000)}
    var darkBtn=document.getElementById('toggle-dark');if(darkBtn){darkBtn.addEventListener('click',function(){var h=document.documentElement;var on=h.classList.contains('dark');if(on){h.classList.remove('dark')}else{h.classList.add('dark')}})}
    var open=document.getElementById('global-open-k');var overlay=document.getElementById('global-k-overlay');var close=document.getElementById('global-k-close');var inp=document.getElementById('global-k-input');var res=document.getElementById('global-k-results');function openK(){if(overlay){overlay.classList.remove('hidden');overlay.classList.add('flex');setTimeout(function(){if(inp){inp.focus()}},50)}}function closeK(){if(overlay){overlay.classList.add('hidden');overlay.classList.remove('flex')}}if(open){open.addEventListener('click',openK)}if(close){close.addEventListener('click',closeK)}
    var _t=null;function runSearch(q){if(!res)return;clearTimeout(_t);_t=setTimeout(function(){res.innerHTML='<div class="skeleton w-full h-4 rounded-md"></div>';var list=[];fetch('/admin/gyms?q='+encodeURIComponent(q)+'&page=1&page_size=10',{headers:{'accept':'application/json'}}).then(function(r){return r.json()}).then(function(j){var items=(j&&j.items)||[];for(var i=0;i<items.length;i++){var g=items[i];list.push({t:'gym',id:String(g.id||''),label:String(g.nombre||'')+' · '+String(g.subdominio||'')})}return fetch('/admin/templates',{headers:{'accept':'application/json'}})}).then(function(r){return r.json()}).then(function(j){var t=(j&&j.templates)||[];for(var i=0;i<t.length;i++){list.push({t:'template',id:String(i+1),label:String(t[i]||'')})}var pref='';try{var p=window.location&&window.location.pathname?window.location.pathname:'';pref=(p.indexOf('/api/')===0||p==='/api'||p.indexOf('/api')===0)?'/api':''}catch(_){pref=''}var html='';for(var k=0;k<list.length;k++){var it=list[k];var href=it.t==='gym'?(pref+'/admin/gyms/'+it.id+'/health?ui=1'):(pref+'/admin/templates?ui=1');html+='<a href="'+href+'" class="flex justify-between items-center px-3 py-2 rounded-md border border-gray-800 bg-[#0b1222] text-white"><span>'+it.label+'</span><span class="text-gray-400 text-xs">'+it.t+'</span></a>'}if(!html){html='<div class="text-gray-400">Sin resultados</div>'}res.innerHTML=html}).catch(function(){res.innerHTML='<div class="text-red-600">Error en búsqueda</div>'})},300)}
    if(inp){inp.addEventListener('input',function(){runSearch(inp.value)})}
    document.addEventListener('keydown',function(e){if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='k'){e.preventDefault();openK()}});
    document.addEventListener('htmx:responseError', function(ev){ try { var s = ev && ev.detail && ev.detail.xhr ? ev.detail.xhr.status : 0; toast('Error '+s+' cargando contenido','error'); var p = ev && ev.detail && ev.detail.pathInfo ? ev.detail.pathInfo.path : null; if (p && typeof p === 'string') { window.location.href = p; } } catch(_){ } });
    document.addEventListener('htmx:send', function(){ try { var ind = document.querySelector('#main-indicator'); if (ind){ ind.classList.add('htmx-request'); } } catch(_){ } });
    document.addEventListener('htmx:afterOnLoad', function(){ try { var ind = document.querySelector('#main-indicator'); if (ind){ ind.classList.remove('htmx-request'); } } catch(_){ } });
  })();
  </script>
</body>
</html>