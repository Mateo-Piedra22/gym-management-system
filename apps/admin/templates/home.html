{% extends "base.html" %}
{% block content %}
<div class="grid gap-6">
  {% if warnings and warnings|length %}
  <div class="rounded-md border border-red-700 bg-red-600/20 text-red-200 p-4">
    <div class="font-semibold">Alertas</div>
    <ul class="list-disc pl-5 mt-2">
      {% for w in warnings %}<li>{{ w }}</li>{% endfor %}
    </ul>
  </div>
  {% endif %}
  <div class="grid gap-3">
    <div class="text-2xl font-semibold">Home</div>
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
      <div class="rounded-xl border border-gray-800 bg-[#0b1222] p-3"><div class="text-xs text-gray-400">Gimnasios</div><div class="text-2xl font-bold">{{ (metrics.gyms.total or 0) }}</div></div>
      <div class="rounded-xl border border-gray-800 bg-[#0b1222] p-3"><div class="text-xs text-gray-400">Activos</div><div class="text-2xl font-bold">{{ (metrics.gyms.active or 0) }}</div></div>
      <div class="rounded-xl border border-gray-800 bg-[#0b1222] p-3"><div class="text-xs text-gray-400">Suspendidos</div><div class="text-2xl font-bold">{{ (metrics.gyms.suspended or 0) }}</div></div>
      <div class="rounded-xl border border-gray-800 bg-[#0b1222] p-3"><div class="text-xs text-gray-400">Mantenimiento</div><div class="text-2xl font-bold">{{ (metrics.gyms.maintenance or 0) }}</div></div>
      <div class="rounded-xl border border-gray-800 bg-[#0b1222] p-3"><div class="text-xs text-gray-400">Subs activas</div><div class="text-2xl font-bold">{{ (metrics.subscriptions.active or 0) }}</div></div>
      <div class="rounded-xl border border-gray-800 bg-[#0b1222] p-3"><div class="text-xs text-gray-400">Subs vencidas</div><div class="text-2xl font-bold">{{ (metrics.subscriptions.overdue or 0) }}</div></div>
      <div class="rounded-xl border border-gray-800 bg-[#0b1222] p-3"><div class="text-xs text-gray-400">Pagos 30 días</div><div class="text-2xl font-bold">{{ (metrics.payments.last_30_sum or 0.0) }}</div></div>
      <div class="rounded-xl border border-gray-800 bg-[#0b1222] p-3"><div class="text-xs text-gray-400">WhatsApp cfg</div><div class="text-2xl font-bold">{{ (metrics.whatsapp.configured or 0) }}</div></div>
    </div>
  </div>
  <div class="grid md:grid-cols-2 gap-6">
    <div class="rounded-xl border border-gray-800 bg-[#0b1222] p-4">
      <div class="font-semibold">Alta de gimnasios (30 días)</div>
      <div class="mt-3 h-32 flex items-end gap-1">
        {% set s = metrics.gyms.series_30 or [] %}
        {% for it in s %}
        {% set h = ((it.count or 0) * 100) // (series_max or 1) %}
        <div class="bg-primary" style="width:8px" data-h="{{ h }}"></div>
        {% endfor %}
      </div>
      <div class="mt-2 text-xs text-gray-400">Últimos {{ s|length }} días</div>
    </div>
    <div class="rounded-xl border border-gray-800 bg-[#0b1222] p-4">
      <div class="font-semibold">Acciones rápidas</div>
      <div class="mt-3 grid grid-cols-2 gap-3">
        <a href="/admin/gyms?ui=1" class="px-3 py-2 rounded-md bg-primary text-primary-foreground"><i class="fa-solid fa-building"></i><span class="ml-2">Gimnasios</span></a>
        <a href="/admin/subscriptions/dashboard?ui=1" class="px-3 py-2 rounded-md bg-gray-900"><i class="fa-solid fa-ticket"></i><span class="ml-2">Suscripciones</span></a>
        <form hx-post="/admin/subscriptions/remind" hx-vals='{"days": 3}' hx-swap="none" class="inline"><button type="submit" class="px-3 py-2 rounded-md bg-gray-900"><i class="fa-solid fa-paper-plane"></i><span class="ml-2">Recordar vencimientos</span></button></form>
        <form hx-post="/admin/subscriptions/auto-suspend" hx-vals='{"grace_days": 7}' hx-swap="none" class="inline needs-confirm" data-confirm="¿Auto-suspender vencidos?">
          <button type="submit" class="px-3 py-2 rounded-md bg-red-600 text-white"><i class="fa-solid fa-pause"></i><span class="ml-2">Auto-suspender vencidos</span></button>
        </form>
      </div>
    </div>
  </div>
  <div class="grid md:grid-cols-2 gap-6">
    <div class="rounded-xl border border-gray-800 bg-[#0b1222] p-4">
      <div class="font-semibold">Próximos vencimientos (14 días)</div>
      <div class="mt-3 grid gap-2">
        {% for it in upcoming %}
        <div class="flex justify-between items-center px-3 py-2 rounded-md border border-gray-800">
          <div>
            <div class="font-medium">{{ it.nombre }}</div>
            <div class="text-xs text-gray-400">{{ it.subdominio }}</div>
          </div>
          <div class="text-sm">{{ it.next_due_date }}</div>
        </div>
        {% endfor %}
        {% if upcoming|length == 0 %}<div class="text-gray-400">Sin vencimientos próximos</div>{% endif %}
      </div>
    </div>
    <div class="rounded-xl border border-gray-800 bg-[#0b1222] p-4">
      <div class="font-semibold">Últimos pagos</div>
      <div class="mt-3 grid gap-2">
        {% for p in recent_payments %}
        <div class="flex justify-between items-center px-3 py-2 rounded-md border border-gray-800">
          <div>
            <div class="font-medium">{{ p.nombre }}</div>
            <div class="text-xs text-gray-400">{{ p.subdominio }}</div>
          </div>
          <div class="text-sm">{{ p.amount }} {{ p.currency }}</div>
        </div>
        {% endfor %}
        {% if recent_payments|length == 0 %}<div class="text-gray-400">Sin pagos recientes</div>{% endif %}
      </div>
    </div>
  </div>
  <div class="rounded-xl border border-gray-800 bg-[#0b1222] p-4">
    <div class="font-semibold">Últimos gimnasios</div>
    <div class="mt-3 grid gap-2">
      {% for g in recent_gyms %}
      <div class="flex justify-between items-center px-3 py-2 rounded-md border border-gray-800">
        <div>
          <div class="font-medium">{{ g.nombre }}</div>
          <div class="text-xs text-gray-400">{{ g.subdominio }}</div>
        </div>
        <div class="flex items-center gap-2">
          <span class="px-2 py-1 rounded-full text-xs {{ 'bg-green-600 text-white' if g.status=='active' else ('bg-red-600 text-white' if g.status=='suspended' else ('bg-yellow-500 text-black' if g.status=='maintenance' else 'bg-gray-700 text-white')) }}">{{ g.status }}</span>
          <a href="/admin/gyms/{{ g.id }}/health?ui=1" class="px-2 py-1 rounded-md bg-gray-900">Salud</a>
        </div>
      </div>
      {% endfor %}
      {% if recent_gyms|length == 0 %}<div class="text-gray-400">Sin gimnasios</div>{% endif %}
    </div>
  </div>
  <div class="rounded-xl border border-gray-800 bg-[#0b1222] p-4">
    <div class="font-semibold">Auditoría reciente</div>
    <div class="mt-3 grid md:grid-cols-2 gap-3">
      <div>
        <div class="text-sm text-gray-400">Acciones más frecuentes ({{ audit.days }} días)</div>
        <div class="mt-2 grid gap-2">
          {% for a in audit.by_action %}
          <div class="flex justify-between"><span>{{ a.action }}</span><span class="text-gray-400">{{ a.c }}</span></div>
          {% endfor %}
          {% if audit.by_action|length == 0 %}<div class="text-gray-400">Sin datos</div>{% endif %}
        </div>
      </div>
      <div>
        <div class="text-sm text-gray-400">Más activos</div>
        <div class="mt-2 grid gap-2">
          {% for u in audit.by_actor %}
          <div class="flex justify-between"><span>{{ u.actor_username }}</span><span class="text-gray-400">{{ u.c }}</span></div>
          {% endfor %}
          {% if audit.by_actor|length == 0 %}<div class="text-gray-400">Sin datos</div>{% endif %}
        </div>
      </div>
    </div>
  </div>
  <div class="rounded-xl border border-gray-800 bg-[#0b1222] p-4">
    <div class="font-semibold">Crear gimnasio</div>
    <form id="create-form" method="post" action="/admin/gyms" class="grid gap-3 mt-3">
      <label class="grid gap-1">
        <span class="text-sm text-gray-300">Nombre *</span>
        <input id="create-name" name="nombre" placeholder="Nombre" required class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" />
      </label>
      <label class="grid gap-1">
        <span class="text-sm text-gray-300">Subdominio (opcional)</span>
        <div class="flex items-center gap-2">
          <input id="create-sub" name="subdominio" placeholder="Subdominio (opcional)" pattern="^[a-z0-9-]{1,63}$" title="Solo letras minúsculas, números y guiones" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950"
                 hx-get="/admin/subdomains/check" hx-trigger="input changed" hx-target="#create-sub-status" hx-include="#create-name, #create-sub-hidden"
                 x-on:input="document.getElementById('create-sub-hidden').value = $event.target.value" />
          <input type="hidden" id="create-sub-hidden" name="sub" />
          <span id="create-sub-status" class="text-xs text-gray-400"></span>
        </div>
      </label>
      <label class="grid gap-1"><span class="text-sm text-gray-300">Teléfono dueño (opcional)</span><input name="owner_phone" placeholder="+54..." pattern="^\+?[0-9]{7,15}$" inputmode="tel" class="px-3 py-2 rounded-md border border-gray-700 bg-gray-950" /></label>
      <button type="submit" class="px-3 py-2 rounded-md bg-primary text-primary-foreground">Crear</button>
    </form>
  </div>
  <script>
  (function(){
      var bars=document.querySelectorAll('[data-h]');for(var i=0;i<bars.length;i++){var hv=Number(bars[i].getAttribute('data-h')||0);bars[i].style.height=String(hv)+'%'}
      document.addEventListener('htmx:afterOnLoad',function(evt){try{var xhr=evt.detail.xhr;var j=xhr&&JSON.parse(xhr.responseText);if(j&&j.ok){var tgt=evt.target;var act=tgt&&tgt.getAttribute('hx-post');if(act==='/admin/subscriptions/auto-suspend'){if(window.toast){window.toast('Auto-suspensión aplicada','success')}}if(act==='/admin/subscriptions/remind'){if(window.toast){window.toast('Recordatorios enviados','info')}}}
      }catch(e){}})
    })();
  </script>
  <script>
  (function(){ if(window.bindSubdomainBucket){ window.bindSubdomainBucket('create-name','create-sub','create-sub-status',null,null) } })();
  </script>
</div>
{% endblock %}