<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gestión • {{ gym_name }}</title>
  <link rel="stylesheet" href="/static/style.css" />
  <script>
    (function(){
      function loadScript(src){
        return new Promise(function(resolve, reject){
          try {
            var s = document.createElement('script');
            s.src = src; s.async = true;
            s.onload = function(){ resolve(true); };
            s.onerror = function(){ reject(new Error('Failed to load ' + src)); };
            document.head.appendChild(s);
          } catch(e){ reject(e); }
        });
      }
      // Cargador dinámico de SheetJS (XLSX)
      async function loadSheetJSLib(){
        if (window.XLSX) return true;
        var sources = [
          'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js',
          'https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js',
          '/static/libs/xlsx.full.min.js'
        ];
        for (var i=0; i<sources.length; i++){
          try {
            await loadScript(sources[i]);
            if (window.XLSX) return true;
          } catch(_){ }
        }
        return false;
      }
      async function loadQRCodeLib(){
        if (window.QRCode) return true;
        var sources = [
          'https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js',
          'https://unpkg.com/qrcode@1.5.1/build/qrcode.min.js',
          'https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.1/qrcode.min.js',
          '/static/libs/qrcode.min.js'
        ];
        for (var i=0; i<sources.length; i++){
          try {
            await loadScript(sources[i]);
            if (window.QRCode) return true;
          } catch(_){}
        }
        return false;
      }
      try { window.loadQRCodeLib = loadQRCodeLib; window.loadSheetJSLib = loadSheetJSLib; } catch(_){}
      // Intento inicial de carga (no bloqueante)
      try { loadQRCodeLib(); } catch(_){}
    })();
  </script>
  <script src="/static/js/toast.js"></script>
  <link rel="icon" href="{{ logo_url }}" />
  <meta name="theme-color" content="{{ theme['--primary'] if theme and '--primary' in theme else '#2b8a3e' }}">
  <meta name="color-scheme" content="dark light">
  <style>
    .layout { display:flex; flex-direction:column; min-height:100vh; min-height: 100dvh; }
    header { display:flex; flex-direction:column; gap:8px; padding:16px 24px; border-bottom:1px solid var(--border); backdrop-filter: blur(8px); position: sticky; top:0; z-index:10; background: rgba(17,24,39,0.75); transition: transform 160ms ease; }
    .brand { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .brand .info { display:flex; align-items:center; gap:8px; }
    .brand img { width:32px; height:32px; }
    .nav-actions { display:flex; gap:8px; align-items:center; }
    /* Logout más compacto */
    .nav-actions .btn.icon-only { padding: 4px; }
    .nav-actions img { width: 20px; height: 20px; }
    .tabs { display:flex; align-items:center; gap: 4px; padding: 6px 24px; border-bottom: 1px solid var(--border); overflow-x:auto; -webkit-overflow-scrolling: touch; }
    .tab { appearance:none; background: transparent; border: none; color: var(--muted); padding: 10px 14px; border-radius: 10px 10px 0 0; cursor:pointer; font-weight: 600; position: relative; transition: color .15s ease, background .15s ease; }
    .tab:hover { color: var(--text); background: rgba(255,255,255,0.04); }
    .tab.active { color: var(--text); }
    .tab.active::after { content: ""; position: absolute; left: 10px; right: 10px; bottom: -1px; height: 3px; background: linear-gradient(90deg, var(--primary), var(--accent)); border-radius: 2px; }

    /* Subtabs - segmented control */
    .subtabs { display:flex; gap:6px; padding:6px; border-radius: 12px; border:1px solid var(--border); background: rgba(17,24,39,0.6); }
    .subtabs .btn.tertiary { background: transparent; color: var(--muted); border: none; padding: 8px 10px; border-radius: 10px; transition: background .15s ease, color .15s ease, box-shadow .15s ease; }
    .subtabs .btn.tertiary:hover { background: rgba(255,255,255,0.05); color: var(--text); }
    .subtabs .btn.tertiary.active { background: rgba(37,99,235,0.15); color: var(--text); box-shadow: inset 0 0 0 1px var(--primary); }

    /* Chips */
    .chips { display:flex; gap:6px; flex-wrap:wrap; }
    .chip { display:inline-flex; align-items:center; gap:6px; padding: 6px 10px; border-radius: 999px; background: rgba(255,255,255,0.06); border: 1px solid var(--border); transition: background .15s ease, border-color .15s ease; }
    .chip-remove { background: transparent; border: none; color: var(--muted); cursor: pointer; padding: 0; }
    .chip-remove:hover { color: var(--accent); }

     .chip:hover { background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.25); }
     .chips .chip[data-suggest] { cursor: pointer; }
     .chips .chip[data-suggest]:hover { background: rgba(37,99,235,0.18); border-color: rgba(37,99,235,0.35); }

    /* States list */
    .state-item { display:flex; align-items:center; justify-content: space-between; gap: 8px; padding: 8px 10px; border: 1px dashed var(--border); border-radius: 10px; transition: background .15s ease, border-color .15s ease; }
    .state-item .left { display:flex; align-items:center; gap:8px; }
    .state-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--accent); flex: 0 0 auto; }
    .state-name { font-weight: 600; }
    .state-meta { color: var(--muted); margin-left: 6px; font-size: 12px; }
    .state-item.expired { opacity: 0.75; }
    .state-item:hover { background: rgba(255,255,255,0.03); border-color: var(--border); }
    .counter { font-size: 12px; color: var(--muted); }
    .empty-hint { color: var(--muted); font-size: 13px; }
    .hl { background: rgba(37,99,235,0.25); border-radius: 4px; padding: 0 2px; }
    .btn.small { padding: 6px 10px; font-size: 12px; border-radius: 8px; }
    main { flex: 1; padding: 16px 24px; width: 100%; max-width: 100%; min-height: 0; overflow-x: hidden; overflow-y: auto; }
    .panel { display:none; }
    .panel.active { display:block; }
    .panel-controls { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom: 12px; }
    .panel-controls > * { min-width: 0; max-width: 100%; flex: 1 1 auto; }
    .panel-controls input[type="date"],
    .panel-controls input[type="text"],
    .panel-controls select { background: #0b1220; color: var(--text); border: 1px solid var(--border); border-radius: 10px; padding: 8px 10px; }
    table { width:100%; border-collapse: collapse; }
    th, td { padding: 10px; border-bottom: 1px solid var(--border); text-align: left; }
    th { color: var(--muted); font-weight: 600; }
    .muted { color: var(--muted); }
    *, *::before, *::after { box-sizing: border-box; }
    html, body { width: 100%; max-width: 100%; }
    /* Tarjetas y tablas mejoradas */
    .cards { display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 16px; align-items: stretch; max-width: 100%; }
    .cards > * { min-width: 0; }
    .card { padding: 12px; background: var(--card); border: 1px solid var(--border); border-radius: 12px; min-width: 0; }
    .card-title { font-size: 12px; color: var(--muted); }
    .card-value { font-size: 20px; font-weight: 600; margin-top: 6px; }
    .table-scroll { overflow:auto; overflow-x:auto; overflow-y:auto; width:100%; max-width:100%; max-height:60vh; border: 1px solid var(--border); border-radius: 12px; -webkit-overflow-scrolling: touch; }
     .table-scroll thead th { position: sticky; top: 0; background: rgba(17,24,39,0.9); backdrop-filter: blur(4px); }
     .table-scroll table { table-layout: auto; width: max-content; min-width: 100%; }
     .table-scroll th, .table-scroll td { overflow-wrap: normal; word-break: normal; white-space: normal; }
     .table-actions { display:flex; gap:8px; justify-content:flex-end; flex-wrap: nowrap; white-space: nowrap; min-width: max-content; }
     .table-actions .btn { margin: 0; flex: 0 0 auto; }
    /* Modales */
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 100; }
    /* Elevar el modal de configuración de numeración por encima del de vista previa */
    #modal-recibo-config { z-index: 110; }
    .modal { width: 640px; max-width: 95vw; background: var(--card); border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 20px 30px rgba(0,0,0,0.35); overflow: hidden; display:flex; flex-direction:column; }
    .modal-header { display:flex; align-items:center; justify-content:space-between; padding: 12px 16px; border-bottom: 1px solid var(--border); }
    .modal-body { padding: 16px; flex: 1 1 auto; overflow-y: auto; }
    .modal-footer { display:flex; gap:8px; padding: 12px 16px; border-top: 1px solid var(--border); justify-content: flex-end; }
    .modal-backdrop.active { display:flex; }
    .input-row { display:flex; gap:8px; flex-wrap:wrap; }
    .input-row > * { min-width: 0; }
    /* Split panel layout */
    .split { display:grid; grid-template-columns: minmax(0,1fr) 380px; gap:16px; align-items:start; }
    .split-main { min-width: 0; }
    .split-side { position: sticky; top: 96px; height: auto; overflow: visible; }
    .block { background: var(--card); border: 1px solid var(--border); border-radius: 12px; max-width: 100%; }
    .block-header { display:flex; align-items:center; justify-content:space-between; gap:8px; padding: 10px 12px; border-bottom: 1px solid var(--border); }
    .block-body { padding:12px; }
    .side-empty { color: var(--muted); padding: 16px; }
    .row-selectable tr:hover { background: rgba(255,255,255,.04); cursor: pointer; }
    .table-compact th, .table-compact td { padding: 8px; word-break: break-word; }
    @media (max-width: 960px){ .split { grid-template-columns: 1fr; } .split-side { position: static; height:auto; } }
    @media (max-width: 640px){
      header { padding: 12px; }
      main { padding: 12px; }
      .brand { flex-direction: column; align-items: flex-start; gap: 10px; }
      .nav-actions { width: 100%; justify-content: flex-end; }
      .modal { width: 95vw; margin: 0 8px; max-height: 90vh; }
      .input-row { flex-direction: column; }
      .input-row > * { flex: 1 1 100%; width: 100%; }
      .panel-controls { flex-direction: column; align-items: stretch; }
      .panel-controls > * { width: 100%; }
      .tabs { flex-wrap: wrap; width: 100%; }
      .table-scroll { max-height: 60vh; }
    }
    @media (max-width: 768px){
      .cards { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 480px){
      .cards { grid-template-columns: 1fr; }
    }
    /* Botón pequeño y variantes */
    .btn.sm { padding: 6px 10px; font-size: 12px; border-radius: 8px; }
    .btn.icon-only { padding: 6px; border-radius: 8px; background: transparent; }
    .btn.icon-only:hover { background: rgba(255,255,255,0.06); }
    .btn[disabled] { opacity: 0.55; cursor: not-allowed; }
    /* Toasts */
    .toast-container { position: fixed; top: 16px; right: 16px; display: flex; flex-direction: column; gap: 8px; z-index: 200; pointer-events: none; }
    .toast { pointer-events: all; background: var(--card); border: 1px solid var(--border); border-left: 4px solid var(--accent); border-radius: 10px; padding: 10px 12px; min-width: 240px; max-width: 400px; box-shadow: 0 12px 24px rgba(0,0,0,0.35); display: flex; align-items: center; justify-content: space-between; gap: 8px; }
    .toast .message { flex: 1; }
    .toast .actions { display: flex; gap: 8px; }
    .toast.success { border-left-color: #22c55e; }
    .toast.warning { border-left-color: #f59e0b; }
    .toast.error { border-left-color: #ef4444; }
    /* Tabs hover */
    .tab:hover { background: rgba(255,255,255,.12); }
    .header--hidden { transform: translateY(-100%); }

    /* Zebra stripes y selección */
    .table-scroll tbody tr:nth-child(odd){ background: rgba(255,255,255,.03); }
    .row-selectable tr.selected{ background: rgba(34,197,94,.14); outline: 1px solid rgba(34,197,94,.35); }
    /* Animaciones toast */
    @keyframes toast-in { from { opacity: 0; transform: translateY(-6px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes toast-out { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-6px); } }
    /* Animaciones modal */
    @keyframes modal-in { from { opacity: 0; transform: translateY(-6px) scale(.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
    @keyframes modal-out { from { opacity: 1; transform: translateY(0) scale(1); } to { opacity: 0; transform: translateY(-6px) scale(.98); } }
    .modal-backdrop.active .modal{ animation: modal-in 180ms ease-out; }
    .modal.closing{ animation: modal-out 160ms ease-in forwards; }
    /* Mini loader overlay */
    #usuario-side{ position: relative; }
    .loader-overlay{ position:absolute; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,0.35); backdrop-filter: blur(2px); z-index: 5; }
    .loader-overlay.active{ display:flex; }
    .loader-overlay .spinner{ width:24px; height:24px; border:3px solid var(--border); border-top-color:#22c55e; border-radius:50%; animation: spin .8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

  </style>
</head>
<body>
  <div class="layout">
    <header id="main-header">
      <div class="brand">
        <div class="info">
          <img src="{{ logo_url }}" alt="Logo" />
          <div>
            <h1 style="margin:0; font-size: 18px;">Gestión • {{ gym_name }}</h1>
            <p class="muted" style="margin:2px 0 0 0">Gestión centralizada</p>
          </div>
        </div>
        <div class="nav-actions">
          <span id="login-current" class="muted" style="margin-right:12px"
                data-role="{{ 'dueño' if request.session.get('logged_in') else ('profesor' if request.session.get('gestion_profesor_id') else '') }}"
                data-prof-id="{{ request.session.get('gestion_profesor_id') or '' }}"
                data-prof-uid="{{ request.session.get('gestion_profesor_user_id') or '' }}">Sesión: —</span>
          <a class="btn icon-only" href="/gestion/logout" title="Cerrar sesión" aria-label="Salir">
            <img src="/assets/salir.png" alt="Salir" />
          </a>
        </div>
      </div>
      <nav class="tabs">
        <button class="tab active" data-tab="usuarios">Usuarios</button>
        {% if request.session.get('logged_in') %}
        <button class="tab" data-tab="profesores" id="tab-btn-profesores">Profesores</button>
        {% endif %}
        <button class="tab" data-tab="pagos">Pagos</button>
        <button class="tab" data-tab="ejercicios">Ejercicios</button>
        <button class="tab" data-tab="rutinas">Rutinas</button>
        <button class="tab" data-tab="configuracion">Configuración</button>
      </nav>
    </header>

    <main>
      <section id="panel-pagos" class="panel">
        <div class="split">
          <div class="split-main">
            <div class="panel-controls">
              <label>Desde</label>
              <input type="date" id="pagos-start" />
              <label>Hasta</label>
              <input type="date" id="pagos-end" />
              <label>Búsqueda</label>
              <input type="text" id="pagos-q" placeholder="Nombre / DNI / Método / Concepto" />
              <select id="pagos-usuario" title="Filtrar por usuario"></select>
              <select id="pagos-limit">
                <option value="25">25</option>
                <option value="50" selected>50</option>
                <option value="100">100</option>
              </select>
              <button class="btn" id="pagos-refresh">Actualizar</button>
              <button class="btn secondary" id="pagos-filtros-btn">Filtros avanzados</button>
              <button class="btn" id="pagos-new">Nuevo Pago</button>
              <button class="btn secondary" id="pagos-export-csv">Exportar CSV</button>
              <div id="recibo-controls" style="margin-left:auto; display:flex; align-items:center; gap:10px">
                <span id="recibo-next" class="muted" title="Próximo número de recibo" style="padding:2px 8px; border:1px solid var(--border); border-radius:12px;">Recibo #—</span>
                <button class="btn secondary" id="recibo-config-btn" title="Configurar numeración" style="padding:6px 10px; display:inline-flex; align-items:center; gap:8px">
                  <img src="/assets/gear.png" alt="Configurar" style="width:16px; height:16px;" />
                  <span style="font-size:12px">Numeración</span>
                </button>
                <span id="pagos-count" class="muted"></span>
              </div>
            </div>
            <div class="cards" id="pagos-cards">
              <div class="card"><div class="card-title">Pagos mostrados</div><div class="card-value" id="pagos-card-count">0</div></div>
              <div class="card"><div class="card-title">Monto total</div><div class="card-value" id="pagos-card-monto">$0</div></div>
              <div class="card"><div class="card-title">Pagadores únicos</div><div class="card-value" id="pagos-card-unique">0</div></div>
              <div class="card"><div class="card-title">Promedio por pago</div><div class="card-value" id="pagos-card-average">$0</div></div>
            </div>
            <div class="table-scroll row-selectable">
              <table id="pagos-table">
                <thead>
                  <tr>
                    <th>Fecha</th>
                    <th>Usuario</th>
                    <th>DNI</th>
                    <th>Método</th>
                    <th>Concepto</th>
                    <th>Monto</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
          <aside class="split-side">
            <div class="block">
              <div class="block-header">
                <div style="display:flex; align-items:center; gap:8px">
                  <h3 style="margin:0; font-size:16px;">Pago seleccionado</h3>
                  <span id="pago-side-id" class="muted"></span>
                </div>
                <button class="btn secondary" id="pagos-clear-selection">Limpiar</button>
              </div>
              <div class="block-body">
                <div id="pago-side-empty" class="side-empty">Selecciona un pago para ver detalles.</div>
                <div id="pago-side" style="display:none">
                  <div class="input-row">
                    <div style="flex:1"><label class="muted">Fecha</label><div id="pago-side-fecha"></div></div>
                    <div style="flex:1"><label class="muted">Monto</label><div id="pago-side-monto"></div></div>
                  </div>
                  <div class="input-row">
                    <div style="flex:1"><label class="muted">Usuario</label><div id="pago-side-nombre"></div></div>
                    <div style="flex:1"><label class="muted">DNI</label><div id="pago-side-dni"></div></div>
                  </div>
                  <div class="input-row">
                    <div style="flex:1"><label class="muted">Método</label><div id="pago-side-metodo"></div></div>
                    <div style="flex:1"><label class="muted">Concepto</label><div id="pago-side-concepto"></div></div>
                  </div>
                  <div style="margin-top:12px">
                    <h4 style="margin:0 0 8px 0; font-size:14px;">Items</h4>
                    <div class="table-scroll table-compact">
                      <table id="pago-detalles-table">
                        <thead><tr><th>Concepto</th><th>Cantidad</th><th>Precio</th><th>Subtotal</th></tr></thead>
                        <tbody></tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="block" style="margin-top:12px">
              <div class="block-header"><h3 style="margin:0; font-size:16px;">Acciones rápidas</h3></div>
              <div class="block-body">
                <div class="input-row">
                  <button class="btn" id="pago-side-ver-usuario">Ver usuario</button>
                  <button class="btn secondary" id="pago-side-ver-detalle">Ver detalle</button>
                  <button class="btn" id="pago-side-recibo">Ver recibo</button>
                  <button class="btn" id="pago-side-editar">Editar pago</button>
                  <button class="btn secondary" id="pago-side-eliminar">Eliminar pago</button>
                </div>
              </div>
            </div>
            <div class="block" style="margin-top:12px">
              <div class="block-header"><h3 style="margin:0; font-size:16px;">Notas</h3></div>
              <div class="block-body"><div id="pago-side-notas" class="muted">—</div></div>
            </div>
          </aside>
        </div>
      </section>

      <section id="panel-ejercicios" class="panel">
  <div class="split">
    <div class="split-main">
      <div class="panel-controls">
        <label for="ejercicios-q">Búsqueda</label>
        <input type="text" id="ejercicios-q" placeholder="Nombre o descripción" />
        <label for="ejercicios-objetivo">Objetivo</label>
        <select id="ejercicios-objetivo">
          <option value="Todos">Todos</option>
          <option value="general" selected>General</option>
          <option value="fuerza">Fuerza</option>
          <option value="hipertrofia">Hipertrofia</option>
          <option value="resistencia">Resistencia</option>
          <option value="cardio">Cardio</option>
          <option value="flexibilidad">Flexibilidad</option>
        </select>
        <label for="ejercicios-grupo">Grupo</label>
        <select id="ejercicios-grupo">
          <option value="Todos">Todos</option>
          <option value="Pecho">Pecho</option>
          <option value="Espalda">Espalda</option>
          <option value="Hombros">Hombros</option>
          <option value="Brazos">Brazos</option>
          <option value="Piernas">Piernas</option>
          <option value="Glúteos">Glúteos</option>
          <option value="Core">Core</option>
          <option value="Full Body">Full Body</option>
        </select>
        <button class="btn" id="ejercicios-refresh">Actualizar</button>
        <button class="btn" id="ejercicios-new">Nuevo Ejercicio</button>
        <span id="ejercicios-count" class="muted" style="margin-left:auto"></span>
      </div>
      <div class="table-scroll row-selectable">
        <table id="ejercicios-table">
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Grupo muscular</th>
              <th>Objetivo</th>
              <th>Descripción</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <aside class="split-side">
      <div class="block">
        <div class="block-header"><h3 style="margin:0; font-size:16px;">Resumen del ejercicio</h3></div>
        <div class="block-body">
          <div><strong>Nombre:</strong> <span id="ejercicio-side-nombre">—</span></div>
          <div><strong>Objetivo:</strong> <span id="ejercicio-side-objetivo">—</span></div>
          <div><strong>Grupo:</strong> <span id="ejercicio-side-grupo">—</span></div>
          <div><strong>Descripción:</strong>
            <div id="ejercicio-side-descripcion" class="muted">—</div>
          </div>
          <div style="margin-top:8px">
            <button class="btn secondary" id="ejercicio-side-edit" disabled>Editar</button>
            <button class="btn" id="ejercicio-side-delete" disabled>Eliminar</button>
          </div>
        </div>
      </div>
      <div class="block">
        <div class="block-header"><h3 style="margin:0; font-size:16px;">Consejos de ejecución</h3></div>
        <div class="block-body">
          <ul id="ejercicio-side-tips" style="padding-left:18px; margin:0"><li class="muted">Selecciona un ejercicio para ver consejos</li></ul>
        </div>
      </div>
      <div class="block">
        <div class="block-header">
          <h3 style="margin:0; font-size:16px;">Equipamiento sugerido</h3>
          <div class="panel-controls" style="margin-left:auto">
            <button class="btn small" id="ejercicio-side-edit-extras" disabled>Editar extras</button>
          </div>
        </div>
        <div class="block-body">
          <ul id="ejercicio-side-equipos" style="padding-left:18px; margin:0"><li class="muted">—</li></ul>
        </div>
      </div>
      <div class="block">
        <div class="block-header"><h3 style="margin:0; font-size:16px;">Variantes útiles</h3></div>
        <div class="block-body">
          <ul id="ejercicio-side-variantes" style="padding-left:18px; margin:0"><li class="muted">—</li></ul>
        </div>
      </div>
    </aside>
  </div>
</section>

<section id="panel-rutinas" class="panel">
  <div class="split">
    <div class="split-main">
      <div class="panel-controls" id="rutinas-subtabs" style="margin-bottom:8px; display:flex; gap:8px; align-items:center">
        <button class="btn small" data-rutinas-tab="plantillas" id="rutinas-tab-plantillas">Plantillas</button>
        <button class="btn small secondary" data-rutinas-tab="usuario" id="rutinas-tab-usuario">Rutinas de usuario</button>
      </div>
      <div class="panel-controls">
        <label for="rutinas-q">Búsqueda</label>
        <input type="text" id="rutinas-q" placeholder="Nombre o descripción" />
        <label for="rutinas-categoria">Categoría</label>
        <select id="rutinas-categoria">
          <option value="">Todas</option>
          <option value="general" selected>General</option>
          <option value="fuerza">Fuerza</option>
          <option value="hipertrofia">Hipertrofia</option>
          <option value="resistencia">Resistencia</option>
          <option value="fullbody">Full body</option>
        </select>
        <label for="rutinas-usuario" id="rutinas-usuario-label">Usuario</label>
        <select id="rutinas-usuario"><option value="">Todos</option></select>
        <button class="btn" id="rutinas-refresh">Actualizar</button>
        <button class="btn secondary" id="rutinas-export-csv">Exportar CSV</button>
        <button class="btn" id="rutinas-new">Nueva Plantilla</button>
        <span id="rutinas-count" class="muted" style="margin-left:auto"></span>
      </div>
      <div class="table-scroll row-selectable">
        <table id="rutinas-table">
          <thead>
            <tr>
              <th class="th-sortable" data-sort="nombre">Nombre</th>
              <th class="th-sortable" data-sort="descripcion">Descripción</th>
              <th class="th-sortable" data-sort="dias">Días</th>
              <th class="th-sortable" data-sort="categoria">Categoría</th>
              <th class="th-sortable" data-sort="ejercicios"># Ejercicios</th>
              <th class="th-sortable" data-sort="asignado">Asignada a</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="block" id="rutinas-usuario-block" style="margin-top:12px; display:none">
        <div class="block-header"><h3 style="margin:0; font-size:16px;">Rutinas del usuario seleccionado</h3></div>
        <div class="block-body">
          <div class="table-scroll">
            <table id="rutinas-usuario-table">
              <thead>
                <tr>
                  <th>Rutina</th>
                  <th>Días</th>
                  <th>Categoría</th>
                  <th>Activa</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <aside class="split-side">
      <div class="block">
        <div class="block-header"><h3 style="margin:0; font-size:16px;">Resumen de rutina</h3></div>
        <div class="block-body">
          <div><strong>Nombre:</strong> <span id="rutina-side-nombre">—</span></div>
          <div><strong>Descripción:</strong>
            <div id="rutina-side-descripcion" class="muted">—</div>
          </div>
          <div style="margin-top:8px">
            <button class="btn" id="rutina-side-edit" disabled>Abrir</button>
            <button class="btn" id="rutina-side-delete" disabled>Eliminar</button>
            <button class="btn" id="rutina-side-assign" disabled>Asignar a usuario</button>
            <button class="btn secondary" id="rutina-side-unassign" disabled>Desasignar</button>
          </div>
        </div>
      </div>
    </aside>
  </div>
</section>

<section id="panel-usuarios" class="panel active">
        <div class="split">
          <div class="split-main">
            <div class="cards" id="usuarios-cards">
              <div class="card"><div class="card-title">Total usuarios mostrados</div><div class="card-value" id="usuarios-card-count">0</div></div>
              <div class="card"><div class="card-title">Activos</div><div class="card-value" id="usuarios-card-activos">0</div></div>
              <div class="card"><div class="card-title">Inactivos</div><div class="card-value" id="usuarios-card-inactivos">0</div></div>
              <div class="card"><div class="card-title">Profesores</div><div class="card-value" id="usuarios-card-profesores">0</div></div>
              <div class="card"><div class="card-title">Sin teléfono</div><div class="card-value" id="usuarios-card-sin-telefono">0</div></div>
              <div class="card"><div class="card-title">Con notas</div><div class="card-value" id="usuarios-card-con-notas">0</div></div>
            </div>
            <div class="panel-controls">
              <label>Búsqueda</label>
              <input type="text" id="usuarios-q" placeholder="Nombre o DNI" />
              <select id="usuarios-limit">
                <option value="25">25</option>
                <option value="50" selected>50</option>
                <option value="100">100</option>
              </select>
              <button class="btn" id="usuarios-refresh">Actualizar</button>
              <button class="btn" id="usuarios-new">Nuevo Usuario</button>
              <button class="btn secondary" id="usuarios-export-csv">Exportar CSV</button>
              <span id="usuarios-count" class="muted" style="margin-left:auto"></span>
            </div>
            <div class="table-scroll row-selectable">
              <table id="usuarios-table">
                <thead>
                  <tr>
                    <th>Nombre</th>
                    <th>DNI</th>
                    <th>Teléfono</th>
                    <th>Rol</th>
                    <th>Tipo Cuota</th>
                    <th>Activo</th>
                    <th>Asistencia</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
          <aside class="split-side">
            <div class="block">
              <div class="block-header">
                <div style="display:flex; align-items:center; gap:8px">
                  <h3 style="margin:0; font-size:16px;">Usuario seleccionado</h3>
                  <span id="usuario-side-id" class="muted"></span>
                </div>
                <button class="btn secondary" id="usuarios-clear-selection">Limpiar</button>
              </div>
              <div class="block-body">
                <div id="usuario-side-empty" class="side-empty">Selecciona un usuario para ver sus datos y pagos.</div>
                <div id="usuario-side" style="display:none">
                  <div id="usuario-side-loader" class="loader-overlay"><div class="spinner"></div><span style="margin-left:8px">Cargando…</span></div>
                  <div class="cards" style="grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));">
                    <div class="card"><div class="card-title">Estado</div><div class="card-value" id="usuario-side-estado">—</div></div>
                    <div class="card"><div class="card-title">Próximo vencimiento</div><div class="card-value" id="usuario-side-vencimiento">—</div></div>
                    <div class="card"><div class="card-title">Cuotas vencidas</div><div class="card-value" id="usuario-side-cuotas-vencidas">—</div></div>
                    <div class="card"><div class="card-title">Asistencias recientes (30d)</div><div class="card-value" id="usuario-side-asistencias-recientes">—</div></div>
                  </div>
                  <div class="input-row" style="margin-top:8px">
                    <div style="flex:1"><label class="muted">Nombre</label><div id="usuario-side-nombre"></div></div>
                    <div style="flex:1"><label class="muted">DNI</label><div id="usuario-side-dni"></div></div>
                  </div>
                  <div class="input-row">
                    <div style="flex:1"><label class="muted">Teléfono</label><div id="usuario-side-telefono"></div></div>
                    <div style="flex:1"><label class="muted">Rol</label><div id="usuario-side-rol"></div></div>
                  </div>
                  <div class="input-row">
                    <div style="flex:1"><label class="muted">Tipo de cuota</label><div id="usuario-side-tipo-cuota"></div></div>
                    <div style="flex:1"><label class="muted">Último pago</label><div id="usuario-side-ultimo-pago"></div></div>
                  </div>
                  <div style="margin-top:12px">
                    <h4 style="margin:0 0 8px 0; font-size:14px;">Historial de pagos</h4>
                    <div class="table-scroll table-compact">
                      <table id="usuario-historial-table">
                        <thead><tr><th>Fecha</th><th>Método</th><th>Concepto</th><th>Monto</th></tr></thead>
                        <tbody></tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="block" style="margin-top:12px">
              <div class="block-header"><h3 style="margin:0; font-size:16px;">Acciones rápidas</h3></div>
              <div class="block-body">
                <div class="input-row">
                  <button class="btn" id="usuario-side-editar">Editar usuario</button>
                  <button class="btn secondary" id="usuario-side-eliminar">Eliminar</button>
                  <button class="btn" id="usuario-side-ver-pagos">Ver pagos</button>
                  <button class="btn secondary" id="usuario-side-toggle-activo">Activar/Inactivar</button>
                  <button class="btn" id="usuario-side-registrar">Registrar pago</button>
                  <button class="btn" id="usuario-side-qr">Emitir QR Check-in</button>
                  <button class="btn secondary" id="usuario-side-asistencia">Registrar asistencia</button>
                </div>
              </div>
            </div>
            <div class="block" style="margin-top:12px">
              <div class="block-header"><h3 style="margin:0; font-size:16px;">Notas, Etiquetas y Estados</h3></div>
              <div class="block-body">
                <div id="usuario-tabs" class="subtabs" style="display:flex; gap:8px; margin-bottom:8px;">
                  <button class="btn tertiary active" data-tab="notas">Notas</button>
                  <button class="btn tertiary" data-tab="etiquetas">Etiquetas</button>
                  <button class="btn tertiary" data-tab="estados">Estados</button>
                </div>
                <div id="usuario-tab-notas" class="tab-panel">
                  <label class="muted">Notas</label>
                  <textarea id="usuario-notas-textarea" rows="5" style="width:100%" aria-label="Notas del usuario" placeholder="Apunta comentarios, lesiones, preferencias, objetivos, etc."></textarea>
                  <div class="input-row" style="margin-top:6px; align-items:center; justify-content: space-between;">
                    <span id="usuario-notas-counter" class="counter">0 caracteres</span>
                    <div style="display:flex; gap:8px; align-items:center">
                      <span id="usuario-notas-status" class="muted" role="status" aria-live="polite"></span>
                      <button class="btn" id="usuario-notas-save">Guardar notas</button>
                    </div>
                  </div>
                </div>
                <div id="usuario-tab-etiquetas" class="tab-panel" style="display:none">
                  <div class="input-row">
                    <input id="usuario-etiqueta-input" type="text" placeholder="Nombre de etiqueta" style="flex:2" aria-label="Nombre de etiqueta">
                    <button class="btn" id="usuario-etiqueta-add">Añadir etiqueta</button>
                  </div>
                  <div class="input-row" style="margin-top:6px">
                    <input id="usuario-etiqueta-filter" type="text" placeholder="Filtrar etiquetas" style="flex:1" aria-label="Filtrar etiquetas">
                    <button id="usuario-etiqueta-filter-clear" class="btn secondary sm" title="Limpiar filtro">Limpiar</button>
                  </div>
                  <div id="usuario-etiqueta-suggests" class="chips" style="margin-top:6px; display:none"></div>
                  <div id="usuario-etiquetas-list" class="chips" style="margin-top:8px"></div>
                  <div id="usuario-etiquetas-empty" class="empty-hint" role="status" aria-live="polite" style="display:none;margin-top:8px">Sin etiquetas</div>
                </div>
                <div id="usuario-tab-estados" class="tab-panel" style="display:none">
                  <div class="input-row">
                    <select id="usuario-estado-template" style="flex:1" aria-label="Plantilla de estado"></select>
                    <input id="usuario-estado-descripcion" type="text" placeholder="Descripción" style="flex:2" aria-label="Descripción del estado">
                    <input id="usuario-estado-vencimiento" type="date" style="flex:1" aria-label="Fecha de vencimiento">
                    <button class="btn" id="usuario-estado-add">Añadir estado</button>
                  </div>
                  <div class="input-row" style="margin-top:6px; align-items:center">
                    <input id="usuario-estados-filter" type="text" placeholder="Filtrar estados" style="flex:2" aria-label="Filtrar estados">
                    <button id="usuario-estados-filter-clear" class="btn secondary sm" title="Limpiar filtro">Limpiar</button>
                    <label style="display:flex; align-items:center; gap:6px"><input id="usuario-estados-show-expired" type="checkbox" checked>Mostrar vencidos</label>
                  </div>
                  <div id="usuario-estados-list" style="margin-top:8px"></div>
                  <div id="usuario-estados-empty" class="empty-hint" role="status" aria-live="polite" style="display:none;margin-top:8px">Sin estados</div>
                </div>
              </div>
            </div>
          </aside>
        </div>
      </section>
      <section id="panel-profesores" class="panel">
  <div class="split">
    <div class="split-main">
      <div class="panel-controls">
        <select id="profesor-select" title="Seleccionar profesor" style="min-width:220px"></select>
        <button class="btn" id="prof-refresh">Actualizar</button>
        <span id="prof-sesion-estado" class="muted" style="margin-left:auto">Sesión: —</span>
      </div>
      <div class="subtabs" id="prof-subtabs" style="margin:8px 0">
        <button class="btn tertiary active" data-subtab="resumen">Resumen</button>
        <button class="btn tertiary" data-subtab="horarios">Horarios</button>
        <button class="btn tertiary" data-subtab="sesiones">Sesiones</button>
      </div>
      <div id="prof-tab-resumen" style="display:block">
        <div class="block">
          <div class="block-header">
            <h3>Datos del profesor</h3>
            <div class="panel-controls" style="margin-left:auto; gap:8px">
              <button class="btn" id="prof-datos-save">Guardar</button>
            </div>
          </div>
          <div class="block-body">
            <div class="input-row">
              <input id="prof-dato-nombre" type="text" placeholder="Nombre" style="flex:2" />
              <input id="prof-dato-dni" type="text" placeholder="DNI" style="flex:1" />
              <input id="prof-dato-telefono" type="text" placeholder="Teléfono" style="flex:1" />
            </div>
            <div class="input-row" style="margin-top:8px; align-items:center">
              <input id="prof-dato-pin" type="text" placeholder="PIN" style="flex:1" />
              <label style="display:flex; align-items:center; gap:6px"><input id="prof-dato-activo" type="checkbox" />Activo</label>
              <span class="muted" id="prof-dato-rol-label" style="margin-left:auto">Rol: Profesor</span>
            </div>
          </div>
        </div>
        <div class="block">
          <div class="block-header">
            <h3>Resumen del mes actual</h3>
          </div>
          <div class="block-body">
            <div class="cards">
              <div class="card"><div class="card-title">Trabajadas (h)</div><div class="card-value" id="prof-m-horas-trabajadas">0</div></div>
              <div class="card"><div class="card-title">Proyectadas (h)</div><div class="card-value" id="prof-m-horas-proyectadas">0</div></div>
              <div class="card"><div class="card-title">Extras (h)</div><div class="card-value" id="prof-m-horas-extra">0</div></div>
            </div>
          </div>
        </div>
        <div class="block" style="margin-top:12px">
          <div class="block-header">
            <h3>Resumen semanal</h3>
            <div class="panel-controls" style="margin-left:auto; gap:8px">
              <label>Semana <input type="date" id="prof-week-date" /></label>
              <label>Inicio
                <select id="prof-week-start"><option value="mon" selected>Lunes</option><option value="sun">Domingo</option></select>
              </label>
              <span class="muted" id="prof-week-range">—</span>
            </div>
          </div>
          <div class="block-body">
            <div class="cards">
              <div class="card"><div class="card-title">Trabajadas (h)</div><div class="card-value" id="prof-w-horas-trabajadas">0</div></div>
              <div class="card"><div class="card-title">Proyectadas (h)</div><div class="card-value" id="prof-w-horas-proyectadas">0</div></div>
              <div class="card"><div class="card-title">Extras (h)</div><div class="card-value" id="prof-w-horas-extra">0</div></div>
            </div>
          </div>
        </div>
      </div>
      <div id="prof-tab-horarios" style="display:none">
      <div class="block">
        <div class="block-header">
          <h3>Horarios de disponibilidad</h3>
          <div class="panel-controls" style="margin-left:auto; gap:8px">
            <select id="horario-dia" title="Día">
              <option value="Lunes">Lunes</option>
              <option value="Martes">Martes</option>
              <option value="Miércoles">Miércoles</option>
              <option value="Jueves">Jueves</option>
              <option value="Viernes">Viernes</option>
              <option value="Sábado">Sábado</option>
              <option value="Domingo">Domingo</option>
            </select>
            <input type="time" id="horario-inicio" title="Inicio" />
            <input type="time" id="horario-fin" title="Fin" />
            <label style="display:flex; align-items:center; gap:6px"><input type="checkbox" id="horario-disponible" checked />Disponible</label>
            <button class="btn" id="horario-add">Añadir</button>
            <button class="btn secondary" id="horario-cancel" style="display:none">Cancelar edición</button>
            <span id="horarios-count" class="muted"></span>
          </div>
        </div>
        <div class="block-body">
          <div class="table-scroll table-compact">
            <table id="prof-horarios-table">
              <thead>
                <tr>
                  <th>Día</th>
                  <th>Inicio</th>
                  <th>Fin</th>
                  <th>Disponible</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
      </div>
      <div id="prof-tab-sesiones" style="display:none">
        <div class="block">
          <div class="block-header">
            <h3>Sesiones trabajadas</h3>
            <div class="panel-controls" style="margin-left:auto; gap:8px">
              <label>Inicio <input type="date" id="prof-ses-start" /></label>
              <label>Fin <input type="date" id="prof-ses-end" /></label>
              <button class="btn secondary" id="prof-ses-week">Semana actual</button>
              <button class="btn secondary" id="prof-ses-month">Mes actual</button>
              <button class="btn" id="prof-ses-refresh">Actualizar</button>
            </div>
          </div>
          <div class="block-body">
            <div class="table-scroll">
              <table id="prof-sesiones-table">
                <thead>
                  <tr>
                    <th>Fecha</th>
                    <th>Inicio</th>
                    <th>Fin</th>
                    <th>Minutos</th>
                    <th>Horas</th>
                    <th>Tipo</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
    <aside class="split-side" id="prof-config-side">
      <div class="block">
        <div class="block-header">
          <h3 style="margin:0; font-size:16px;">Configuración del profesor</h3>
          <div class="panel-controls" style="margin-left:auto; gap:8px">
            <button class="btn" id="prof-config-save">Guardar</button>
          </div>
        </div>
        <div class="block-body">
          <div class="input-row">
            <label for="prof-config-usuario" style="display:block; margin-bottom:4px; color:var(--muted);">Usuario vinculado</label>
            <input id="prof-config-usuario" title="Usuario vinculado" style="width:100%" type="text" readonly disabled />
          </div>
          <div class="input-row" style="margin-top:8px">
            <label for="prof-config-salario" id="prof-config-salario-label" style="display:block; margin-bottom:4px; color:var(--muted);">Monto (ARS)</label>
            <div class="currency-input" style="display:flex; align-items:center; gap:8px">
              <span class="prefix" style="color:var(--muted); font-size:12px; padding:4px 8px; border:1px solid var(--border); border-radius:10px;">ARS</span>
              <input type="number" id="prof-config-salario" placeholder="Monto en ARS" step="0.01" min="0" inputmode="decimal" />
              <select id="prof-monto-tipo" title="Tipo de monto" style="margin-left:auto">
                <option value="mensual">Mensual</option>
                <option value="hora">Por hora</option>
              </select>
            </div>
          </div>
          <div class="input-row" style="margin-top:8px">
            <label for="prof-config-notas" style="display:block; margin-bottom:4px; color:var(--muted);">Notas</label>
            <textarea id="prof-config-notas" placeholder="Notas" rows="4" style="width:100%"></textarea>
          </div>
          <div class="input-row" style="margin-top:8px">
            <label for="prof-config-especialidad" style="display:block; margin-bottom:4px; color:var(--muted);">Especialidad</label>
            <input type="text" id="prof-config-especialidad" placeholder="Ej. Musculación" />
          </div>
          <div class="input-row" style="margin-top:8px">
            <label for="prof-config-experiencia" style="display:block; margin-bottom:4px; color:var(--muted);">Experiencia (años)</label>
            <input type="number" id="prof-config-experiencia" placeholder="Ej. 3" step="1" min="0" />
          </div>
          <!-- Tarifa por hora eliminada: unificado con Monto (ARS) -->
          <div class="input-row" style="margin-top:8px">
            <label for="prof-config-certificaciones" style="display:block; margin-bottom:4px; color:var(--muted);">Certificaciones</label>
            <textarea id="prof-config-certificaciones" placeholder="Certificaciones" rows="3" style="width:100%"></textarea>
          </div>
          <div style="margin-top:12px; font-size:12px; color:var(--muted); line-height:1.4">
            <strong>Inicio y fin de sesión:</strong> Inicia y termina sesiones desde Gestión. Si la hora de fin es anterior a la de inicio, se considera que cruzó medianoche y se mostrará "(+1d)". La duración se calcula ajustando el fin al día siguiente.
          </div>
        </div>
      </div>
    </aside>
  </div>
</section>

<section id="panel-configuracion" class="panel">
        <div class="split">
          <div class="split-main">
            <div class="block">
              <div class="block-header">
                <h3 style="margin:0; font-size:16px;">Tipos de cuota</h3>
                <div class="panel-controls" style="margin-left:auto">
                  <button class="btn" id="config-tipos-refresh">Actualizar</button>
                  <button class="btn" id="config-tipos-new">Nuevo</button>
                </div>
              </div>
              <div class="block-body">
                <div class="table-scroll row-selectable">
                  <table id="config-tipos-table">
                    <thead>
                      <tr>
                        <th>Nombre</th>
                        <th>Precio</th>
                        <th>Duración (días)</th>
                        <th>Activo</th>
                        <th>Acciones</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>

            <div class="block" style="margin-top:16px">
              <div class="block-header">
                <h3 style="margin:0; font-size:16px;">Conceptos de pago</h3>
                <div class="panel-controls" style="margin-left:auto">
                  <button class="btn" id="config-conceptos-refresh">Actualizar</button>
                  <button class="btn" id="config-conceptos-new">Nuevo</button>
                </div>
              </div>
              <div class="block-body">
                <div class="table-scroll row-selectable">
                  <table id="config-conceptos-table">
                    <thead>
                      <tr>
                        <th>Nombre</th>
                        <th>Precio base</th>
                        <th>Tipo</th>
                        <th>Activo</th>
                        <th>Categoría</th>
                        <th>Acciones</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>

            <div class="block" style="margin-top:16px">
              <div class="block-header">
                <h3 style="margin:0; font-size:16px;">Métodos de pago</h3>
                <div class="panel-controls" style="margin-left:auto">
                  <button class="btn" id="config-metodos-refresh">Actualizar</button>
                  <button class="btn" id="config-metodos-new">Nuevo</button>
                </div>
              </div>
              <div class="block-body">
                <div class="table-scroll row-selectable">
                  <table id="config-metodos-table">
                    <thead>
                      <tr>
                        <th>Nombre</th>
                        <th>Comisión (%)</th>
                        <th>Color</th>
                        <th>Activo</th>
                        <th>Acciones</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>

            <div class="block" style="margin-top:16px">
              <div class="block-header">
                <h3 style="margin:0; font-size:16px;">Mantenimiento</h3>
                <div class="panel-controls" style="margin-left:auto">
                  <input id="config-renum-start" type="number" min="1" step="1" value="2" placeholder="ID inicial (ej. 2)" style="width:160px" aria-label="ID inicial" />
                  <button class="btn secondary" id="config-renum-run">Renumerar IDs</button>
                  <button class="btn secondary" id="config-secure-owner">Asegurar Dueño</button>
                </div>
              </div>
              <div class="block-body">
                <p class="muted">Acción avanzada: renumera todos los IDs de usuarios consecutivamente desde el ID inicial. Solo dueño. Actualiza referencias en pagos, asistencias, rutinas, clases, notificaciones, etc. Operación irreversible; se recomienda respaldo previo.</p>
                <p class="muted">Acción avanzada: asegura la existencia del Dueño en ID 1, crea si falta y restablece protecciones (RLS y triggers). Solo dueño.</p>
              </div>
            </div>

    <!-- Modal: Confirmar Asegurar Dueño -->
    <div class="modal-backdrop" id="modal-secure-owner-confirm" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-secure-owner-title">
        <div class="modal-header">
          <h3 id="modal-secure-owner-title" style="margin:0; font-size:16px;">Confirmar Asegurar Dueño</h3>
          <button class="btn icon-only" id="secure-owner-close" aria-label="Cerrar">×</button>
        </div>
        <div class="modal-body">
          <p class="muted">Esta acción:</p>
          <ul class="muted">
            <li>Garantiza que el Dueño exista con ID 1.</li>
            <li>Restablece RLS y triggers de protección del Dueño.</li>
            <li>No afecta otros usuarios ni configuraciones.</li>
          </ul>
          <p class="muted">Requiere sesión de Dueño.</p>
        </div>
        <div class="modal-footer">
          <button class="btn" id="secure-owner-confirm">Asegurar</button>
          <button class="btn secondary" id="secure-owner-cancel">Cancelar</button>
        </div>
      </div>
    </div>

          </div>
        </div>
      </section>

    </main>

    <!-- Modal: Finalizar sesión antes de salir -->
    <div class="modal-backdrop" id="modal-sesion-fin" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-sesion-fin-title">
        <div class="modal-header">
          <h3 id="modal-sesion-fin-title" style="margin:0; font-size:16px;">Finalizar sesión antes de salir</h3>
          <button class="btn icon-only" id="sesion-fin-close" aria-label="Cerrar">×</button>
        </div>
        <div class="modal-body">
          <p class="muted">¿Deseas finalizar tu sesión de trabajo antes de salir?</p>
        </div>
        <div class="modal-footer">
          <button class="btn" id="sesion-fin-confirm">Finalizar y salir</button>
          <button class="btn secondary" id="sesion-fin-cancel">Salir sin finalizar</button>
        </div>
      </div>
    </div>

    <!-- Modal: Eliminar sesión -->
    <div class="modal-backdrop" id="modal-sesion-delete" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-sesion-delete-title">
        <div class="modal-header">
          <h3 id="modal-sesion-delete-title" style="margin:0; font-size:16px;">Eliminar sesión</h3>
          <button class="btn icon-only" id="sesion-delete-close" aria-label="Cerrar">×</button>
        </div>
        <div class="modal-body">
          <p class="muted">¿Deseas eliminar esta sesión? Esta acción no se puede deshacer.</p>
        </div>
        <div class="modal-footer">
          <button class="btn danger" id="sesion-delete-confirm">Eliminar</button>
          <button class="btn secondary" id="sesion-delete-cancel">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- Modal: Filtros avanzados de Pagos -->
    <div class="modal-backdrop" id="modal-pagos-filtros" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-pagos-filtros-title">
        <div class="modal-header">
          <h3 id="modal-pagos-filtros-title" style="margin:0; font-size:16px;">Filtros avanzados</h3>
          <button class="btn icon-only" id="pagos-filtros-close" aria-label="Cerrar">×</button>
        </div>
        <div class="modal-body">
          <div class="input-row">
            <div style="flex:1">
              <label class="muted">Método de pago</label>
              <select id="pagos-metodo" style="width:100%"></select>
            </div>
            <div style="flex:1">
              <label class="muted">Concepto</label>
              <select id="pagos-concepto" style="width:100%"></select>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn" id="pagos-filtros-aplicar">Aplicar</button>
          <button class="btn secondary" id="pagos-filtros-cancelar">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- Modal: Configuración de Numeración de Recibos -->
    <div class="modal-backdrop" id="modal-recibo-config" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-recibo-config-title">
        <div class="modal-header">
          <h3 id="modal-recibo-config-title" style="margin:0; font-size:16px;">Numeración de recibos</h3>
          <button class="btn icon-only" id="recibo-config-close" aria-label="Cerrar">×</button>
        </div>
        <div class="modal-body">
          <div class="input-row">
            <div style="flex:1">
              <label class="muted" for="recibo-prefijo">Prefijo</label>
              <input id="recibo-prefijo" type="text" placeholder="REC" style="width:100%" />
            </div>
            <div style="flex:1">
              <label class="muted" for="recibo-separador">Separador</label>
              <input id="recibo-separador" type="text" placeholder="-" style="width:100%" />
            </div>
          </div>
          <div class="input-row">
            <div style="flex:1">
              <label class="muted" for="recibo-numero-inicial">Número inicial</label>
              <input id="recibo-numero-inicial" type="number" min="1" step="1" placeholder="1" style="width:100%" />
            </div>
            <div style="flex:1">
              <label class="muted" for="recibo-longitud-numero">Longitud del número</label>
              <input id="recibo-longitud-numero" type="number" min="1" step="1" placeholder="6" style="width:100%" />
            </div>
          </div>
          <div class="input-row">
            <div style="flex:1">
              <label class="muted" for="recibo-reiniciar-anual">Reiniciar anual</label>
              <input id="recibo-reiniciar-anual" type="checkbox" />
            </div>
            <div style="flex:1">
              <label class="muted">Incluir fecha</label>
              <div style="display:flex; gap:12px; align-items:center">
                <label style="display:flex; align-items:center; gap:6px"><input id="recibo-incluir-anio" type="checkbox" /> <span>Año</span></label>
                <label style="display:flex; align-items:center; gap:6px"><input id="recibo-incluir-mes" type="checkbox" /> <span>Mes</span></label>
              </div>
            </div>
          </div>
          <div style="margin-top:8px">
            <div class="muted" id="recibo-config-preview">Próximo ejemplo: —</div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn" id="recibo-config-save">Guardar</button>
          <button class="btn secondary" id="recibo-config-cancel">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- Modal: Vista previa de Recibo -->
    <div class="modal-backdrop" id="modal-recibo-preview" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-recibo-preview-title">
        <div class="modal-header">
          <h3 id="modal-recibo-preview-title" style="margin:0; font-size:16px;">Vista previa del recibo</h3>
          <button class="btn icon-only" id="recibo-preview-close" aria-label="Cerrar">×</button>
        </div>
        <div class="modal-body" style="max-height:72vh; overflow-y:auto;">
          <div class="input-row" style="align-items:flex-end">
            <div style="flex:1">
              <label class="muted" for="recibo-preview-numero">Número de recibo (opcional)</label>
              <input id="recibo-preview-numero" type="text" placeholder="Ej: REC-2025-000123" style="width:100%" />
              <div id="recibo-preview-periodo-label" class="muted" style="margin-top:6px; font-size:12px; display:none"></div>
            </div>
            <div>
              <button class="btn" id="recibo-preview-apply" title="Actualizar vista previa">Aplicar</button>
            </div>
          </div>

          <details id="recibo-advanced" style="border:1px solid var(--border); border-radius:6px; padding:10px;">
            <summary style="cursor:pointer; user-select:none; font-weight:600">Opciones avanzadas del recibo</summary>
            <div class="input-row">
              <div style="flex:1">
                <label class="muted" for="recibo-preview-titulo">Título</label>
                <input id="recibo-preview-titulo" type="text" placeholder="RECIBO DE PAGO" style="width:100%" />
              </div>
              <div style="flex:1">
                <label class="muted" for="recibo-preview-fecha">Fecha de emisión</label>
                <input id="recibo-preview-fecha" type="date" style="width:100%" />
              </div>
            </div>
            <div class="input-row">
              <div style="flex:1">
                <label class="muted" for="recibo-preview-gym-nombre">Nombre del gimnasio</label>
                <input id="recibo-preview-gym-nombre" type="text" placeholder="Nombre del gimnasio" style="width:100%" />
              </div>
              <div style="flex:1">
                <label class="muted" for="recibo-preview-gym-direccion">Dirección del gimnasio</label>
                <input id="recibo-preview-gym-direccion" type="text" placeholder="Dirección" style="width:100%" />
              </div>
            </div>
            <div class="input-row">
              <div style="flex:1">
                <label class="muted" for="recibo-preview-usuario-nombre">Facturar a</label>
                <input id="recibo-preview-usuario-nombre" type="text" placeholder="Nombre del cliente" style="width:100%" />
              </div>
              <div style="flex:1">
                <label class="muted" for="recibo-preview-usuario-dni">DNI (opcional)</label>
                <input id="recibo-preview-usuario-dni" type="text" placeholder="DNI" style="width:100%" />
              </div>
            </div>
            <div class="input-row" style="align-items:flex-end">
              <div style="flex:1">
                <label class="muted" for="recibo-preview-metodo">Método de pago (opcional)</label>
                <input id="recibo-preview-metodo" type="text" placeholder="Efectivo / Tarjeta ..." style="width:100%" />
              </div>
              <div style="flex:1; display:flex; gap:16px; align-items:flex-end">
                <label class="muted" style="display:flex; align-items:center; gap:6px"><input id="recibo-preview-mostrar-logo" type="checkbox" checked /> <span>Mostrar logo</span></label>
                <label class="muted" style="display:flex; align-items:center; gap:6px"><input id="recibo-preview-mostrar-metodo" type="checkbox" checked /> <span>Mostrar método</span></label>
                <label class="muted" style="display:flex; align-items:center; gap:6px"><input id="recibo-preview-mostrar-dni" type="checkbox" checked /> <span>Mostrar DNI</span></label>
              </div>
            </div>
            <div class="input-row" style="align-items:flex-end">
              <div style="flex:2">
                <label class="muted" for="recibo-preview-observaciones">Observaciones (opcional)</label>
                <input id="recibo-preview-observaciones" type="text" placeholder="Notas u observaciones" style="width:100%" />
              </div>
              <div style="flex:1">
                <label class="muted" for="recibo-preview-emitidopor">Emitido por (opcional)</label>
                <input id="recibo-preview-emitidopor" type="text" placeholder="Nombre del emisor" style="width:100%" />
              </div>
            </div>
            <div class="input-row" style="align-items:flex-start">
              <div style="flex:1">
                <label class="muted">Ítems del recibo</label>
                <div id="recibo-items-list" style="border:1px solid var(--border); border-radius:6px; padding:8px; display:flex; flex-direction:column; gap:8px">
                  <div style="display:grid; grid-template-columns: 1fr 100px 140px 40px; gap:8px; align-items:center">
                    <div class="muted">Descripción</div>
                    <div class="muted">Cantidad</div>
                    <div class="muted">Precio</div>
                    <div></div>
                  </div>
                  <div id="recibo-items-rows" style="display:flex; flex-direction:column; gap:8px"></div>
                  <div>
                    <button class="btn secondary" id="recibo-item-add" type="button">Agregar ítem</button>
                  </div>
                </div>
              </div>
            </div>
            <div class="input-row">
              <div style="flex:1"><label class="muted" for="recibo-total-subtotal">Subtotal</label><input id="recibo-total-subtotal" type="number" step="0.01" inputmode="decimal" placeholder="0.00" style="width:100%" /></div>
              <div style="flex:1"><label class="muted" for="recibo-total-comision">Comisión</label><input id="recibo-total-comision" type="number" step="0.01" inputmode="decimal" placeholder="0.00" style="width:100%" /></div>
              <div style="flex:1"><label class="muted" for="recibo-total-total">Total</label><input id="recibo-total-total" type="number" step="0.01" inputmode="decimal" placeholder="0.00" style="width:100%" /></div>
            </div>
          </details>
          <div class="input-row">
              <div style="flex:1">
                <div id="recibo-preview-frame-wrap" style="width:100%; height:72vh; max-height:640px; min-height:360px; border:1px solid var(--border); border-radius:6px; overflow:auto; position:relative">
                  <iframe id="recibo-preview-frame" title="Vista previa del recibo" style="width:100%; height:100%; border:0; transform-origin: center top" src=""></iframe>
                </div>
              </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn" id="recibo-preview-download">Descargar PDF</button>
          <button class="btn secondary" id="recibo-preview-config">Configurar numeración</button>
          <button class="btn secondary" id="recibo-preview-close-btn">Cerrar</button>
        </div>
      </div>
    </div>

    <!-- Modal: Detalle de Pago -->
    <div class="modal-backdrop" id="modal-pago-detalle" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-pago-detalle-title">
        <div class="modal-header">
          <h3 id="modal-pago-detalle-title" style="margin:0; font-size:16px;">Detalle de pago</h3>
          <button class="btn icon-only" id="pago-detalle-close" aria-label="Cerrar">×</button>
        </div>
        <div class="modal-body">
          <div class="input-row">
            <div style="flex:1"><label class="muted">Fecha</label><div id="pago-detalle-fecha"></div></div>
            <div style="flex:1"><label class="muted">Usuario</label><div id="pago-detalle-nombre"></div></div>
          </div>
          <div class="input-row">
            <div style="flex:1"><label class="muted">DNI</label><div id="pago-detalle-dni"></div></div>
            <div style="flex:1"><label class="muted">Monto</label><div id="pago-detalle-monto"></div></div>
          </div>
          <div class="input-row">
            <div style="flex:1"><label class="muted">Método</label><div id="pago-detalle-metodo"></div></div>
            <div style="flex:1"><label class="muted">Concepto</label><div id="pago-detalle-concepto"></div></div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn secondary" id="pago-detalle-cerrar">Cerrar</button>
        </div>
      </div>
    </div>

    <!-- Modal: Usuario (Crear/Editar) -->
    <div class="modal-backdrop" id="modal-usuario" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-usuario-title">
        <div class="modal-header">
          <h3 id="modal-usuario-title" style="margin:0; font-size:16px;">Usuario</h3>
          <button class="btn icon-only" id="usuarios-modal-close" aria-label="Cerrar">×</button>
        </div>
        <div class="modal-body">
          <div class="input-row">
            <div style="flex:1">
              <label class="muted" for="u-id">ID de usuario</label>
              <input id="u-id" type="number" placeholder="ID (solo dueño)" style="width:100%" min="1" step="1" aria-label="ID de usuario" />
            </div>
          </div>
          <div class="input-row">
            <div style="flex:1">
              <label class="muted" for="u-nombre">Nombre completo</label>
              <input id="u-nombre" type="text" placeholder="Ej. Juan Pérez" style="width:100%" aria-label="Nombre completo" />
            </div>
            <div style="flex:1">
              <label class="muted" for="u-dni">DNI</label>
              <input id="u-dni" type="text" placeholder="Ej. 12345678" style="width:100%" aria-label="DNI" />
            </div>
          </div>
          <div class="input-row">
            <div style="flex:1">
              <label class="muted" for="u-telefono">Teléfono</label>
              <input id="u-telefono" type="text" placeholder="Ej. +54 9 11 1234-5678" style="width:100%" aria-label="Teléfono" />
            </div>
            <div style="flex:1">
              <label class="muted" for="u-pin">PIN de acceso</label>
              <input id="u-pin" type="text" placeholder="Opcional" style="width:100%" aria-label="PIN de acceso" />
            </div>
          </div>
          <div class="input-row">
            <div style="flex:1">
              <label class="muted" for="u-rol">Rol</label>
              <select id="u-rol" style="width:100%" aria-label="Rol">
                <option value="socio" selected>Socio</option>
                <option value="profesor">Profesor</option>
              </select>
            </div>
            <div style="flex:1">
              <label class="muted" for="u-tipo-cuota">Tipo de cuota</label>
              <select id="u-tipo-cuota" style="width:100%" aria-label="Tipo de cuota">
                <option value="">Seleccionar tipo de cuota</option>
              </select>
            </div>
            <div style="flex:1">
              <label class="muted" for="u-activo">Estado</label>
              <label style="display:flex; align-items:center; gap:6px">
                <input id="u-activo" type="checkbox" checked aria-label="Activo" /> Activo
              </label>
            </div>
          </div>
          <div class="input-row" style="margin-top:8px">
            <div style="flex:1">
              <label class="muted" for="u-notas">Notas</label>
              <textarea id="u-notas" rows="3" placeholder="Observaciones, preferencias y restricciones" style="width:100%" aria-label="Notas"></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn" id="usuarios-save">Guardar</button>
          <button class="btn secondary" id="usuarios-cancel">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- Modal: Confirmar eliminación de Usuario -->
    <div class="modal-backdrop" id="modal-usuarios-delete" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-usuarios-delete-title">
        <div class="modal-header">
          <h3 id="modal-usuarios-delete-title" style="margin:0; font-size:16px;">Eliminar usuario</h3>
          <button class="btn icon-only" id="usuarios-delete-close" aria-label="Cerrar">×</button>
        </div>
        <div class="modal-body">
          <p>¿Estás seguro? Esta acción es permanente.</p>
        </div>
        <div class="modal-footer">
          <button class="btn" id="usuarios-delete-confirm">Eliminar</button>
          <button class="btn secondary" id="usuarios-delete-cancel">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- Modal: Confirmar renumeración de IDs -->
    <div class="modal-backdrop" id="modal-renum-confirm" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-renum-confirm-title">
        <div class="modal-header">
          <h3 id="modal-renum-confirm-title" style="margin:0; font-size:16px;">Renumerar IDs de usuarios</h3>
          <button class="btn icon-only" id="renum-close" aria-label="Cerrar">×</button>
        </div>
        <div class="modal-body">
          <p>Esta operación es irreversible y actualizará todas las referencias.</p>
          <p>Inicio: <strong id="renum-start-display">—</strong></p>
          <p class="muted">El ID 1 está reservado para el Dueño y no será modificado.</p>
        </div>
        <div class="modal-footer">
          <button class="btn" id="renum-confirm">Renumerar</button>
          <button class="btn secondary" id="renum-cancel">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- Modal: Confirmar eliminación de Pago -->
    <div class="modal-backdrop" id="modal-pagos-delete" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-pagos-delete-title">
        <div class="modal-header">
          <h3 id="modal-pagos-delete-title" style="margin:0; font-size:16px;">Eliminar pago</h3>
          <button class="btn icon-only" id="pagos-delete-close" aria-label="Cerrar">×</button>
        </div>
        <div class="modal-body">
          <p>¿Estás seguro? Esta acción es permanente.</p>
        </div>
        <div class="modal-footer">
          <button class="btn" id="pagos-delete-confirm">Eliminar</button>
          <button class="btn secondary" id="pagos-delete-cancel">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- Modal: Pago (Crear/Editar) -->
    <div class="modal-backdrop" id="modal-pago-form" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="pago-form-title">
        <div class="modal-header">
          <h3 id="pago-form-title" style="margin:0; font-size:16px;">Pago</h3>
          <button class="btn icon-only" id="pago-form-close" aria-label="Cerrar">×</button>
        </div>
        <div class="modal-body">
          <div class="input-row">
            <div style="flex:1">
              <label class="muted" for="pago-usuario">Usuario</label>
              <select id="pago-usuario" style="width:100%" aria-label="Usuario">
                <option value="">Seleccionar usuario</option>
              </select>
            </div>
            <div style="flex:1">
              <label class="muted" for="pago-monto">Monto</label>
              <input id="pago-monto" type="number" step="0.01" placeholder="Calculado automáticamente" style="width:100%" readonly aria-label="Monto" />
            </div>
          </div>
          <div class="input-row">
            <div style="flex:1">
              <label class="muted" for="pago-fecha">Fecha del pago</label>
              <input id="pago-fecha" type="date" style="width:100%" aria-label="Fecha del pago" />
            </div>
            <div style="flex:1">
              <label class="muted" for="pago-mes">Mes</label>
              <input id="pago-mes" type="number" min="1" max="12" placeholder="Ej. 7" style="width:100%" aria-label="Mes del período" />
            </div>
            <div style="flex:1">
              <label class="muted" for="pago-año">Año</label>
              <input id="pago-año" type="number" min="2000" max="2100" placeholder="Ej. 2025" style="width:100%" aria-label="Año del período" />
            </div>
          </div>
          <div class="input-row">
            <div style="flex:1">
              <label class="muted" for="pago-metodo">Método de pago</label>
              <select id="pago-metodo" style="width:100%" aria-label="Método de pago">
                <option value="">Seleccionar (opcional)</option>
              </select>
            </div>
          </div>
          <div class="input-row">
            <div style="flex:1">
              <label class="muted" for="pago-concepto">Concepto</label>
              <select id="pago-concepto" style="width:100%" aria-label="Concepto">
                <option value="">Seleccionar concepto</option>
              </select>
            </div>
          </div>
          <div id="pago-resumen" class="calc-summary" style="margin-top:8px; font-size:12px; color:#555">
            <div><strong>Concepto:</strong> <span id="pago-resumen-concepto">Cuota Mensual</span></div>
            <div><strong>Base:</strong> $<span id="pago-resumen-base">—</span></div>
            <div><strong>Comisión:</strong> $<span id="pago-resumen-comision">—</span> <span id="pago-resumen-comision-porcentaje"></span></div>
            <div><strong>Total:</strong> $<span id="pago-resumen-total">—</span></div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn" id="pago-save">Guardar</button>
          <button class="btn secondary" id="pago-form-cancel">Cancelar</button>
        </div>
      </div>
    </div>

  </div>

  <!-- Modal: Sesión (Editar) -->
  <div class="modal-backdrop" id="modal-sesion-form" style="display:none" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="sesion-form-title">
      <div class="modal-header">
        <h3 id="sesion-form-title" style="margin:0; font-size:16px;">Editar sesión</h3>
        <button class="btn icon-only" id="sesion-form-close" aria-label="Cerrar">×</button>
      </div>
      <div class="modal-body">
        <div class="input-row">
          <div style="flex:1">
            <label class="muted" for="sesion-fecha">Fecha</label>
            <input id="sesion-fecha" type="date" style="width:100%" aria-label="Fecha" />
          </div>
          <div style="flex:1">
            <label class="muted" for="sesion-inicio">Inicio</label>
            <input id="sesion-inicio" type="time" style="width:100%" aria-label="Inicio" />
          </div>
          <div style="flex:1">
            <label class="muted" for="sesion-fin">Fin</label>
            <input id="sesion-fin" type="time" style="width:100%" aria-label="Fin" />
          </div>
        </div>
        <div class="input-row">
          <div style="flex:1">
            <label class="muted" for="sesion-tipo">Tipo</label>
            <input id="sesion-tipo" type="text" placeholder="Ej. trabajo" style="width:100%" aria-label="Tipo" />
          </div>
        </div>
        <div class="input-row">
          <div style="flex:1">
            <label class="muted" for="sesion-minutos">Minutos</label>
            <input id="sesion-minutos" type="number" min="0" step="1" placeholder="Ej. 60" style="width:100%" aria-label="Minutos trabajados" disabled />
          </div>
          <div style="flex:1; display:flex; align-items:center;">
            <label class="muted" for="sesion-auto" style="margin-right:8px;">Cálculo automático</label>
            <input id="sesion-auto" type="checkbox" checked aria-label="Calcular minutos automáticamente" />
          </div>
        </div>
        <div id="sesion-resumen" class="calc-summary" style="margin-top:8px; font-size:12px; color:#555">
          <div><strong>Minutos calculados:</strong> <span id="sesion-resumen-min">—</span></div>
          <div><strong>Horas:</strong> <span id="sesion-resumen-horas">—</span></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" id="sesion-save">Guardar</button>
        <button class="btn secondary" id="sesion-form-cancel">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal: Tipo de Cuota (Crear/Editar) -->
  <div class="modal-backdrop" id="modal-tipo-cuota" style="display:none" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-tipo-cuota-title">
      <div class="modal-header">
        <h3 id="modal-tipo-cuota-title">Tipo de Cuota</h3>
        <button class="modal-close" id="close-modal-tipo-cuota" aria-label="Cerrar">×</button>
      </div>
      <div class="modal-body">
        <div class="form-grid">
          <div class="form-row">
            <label>Nombre</label>
            <input type="text" id="tipo-nombre" placeholder="Mensual, Trimestral, ...">
          </div>
          <div class="form-row">
            <label>Precio</label>
            <input type="number" id="tipo-precio" min="0" step="0.01">
          </div>
          <div class="form-row">
            <label>Duración (días)</label>
            <input type="number" id="tipo-duracion" min="1" step="1">
          </div>
          <div class="form-row">
            <label>Activo</label>
            <select id="tipo-activo">
              <option value="true">Sí</option>
              <option value="false">No</option>
            </select>
          </div>
          <div class="form-row">
            <label>Descripción</label>
            <textarea id="tipo-descripcion"></textarea>
          </div>
          <div class="form-row">
            <label>Icono (ruta opcional)</label>
            <input type="text" id="tipo-icono" placeholder="/static/icons/monthly.svg">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" id="save-tipo-cuota">Guardar</button>
        <button class="btn" id="cancel-tipo-cuota">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal: Concepto de Pago (Crear/Editar) -->
  <div class="modal-backdrop" id="modal-concepto" style="display:none" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-concepto-title">
      <div class="modal-header">
        <h3 id="modal-concepto-title">Concepto de Pago</h3>
        <button class="modal-close" id="close-modal-concepto" aria-label="Cerrar">×</button>
      </div>
      <div class="modal-body">
        <div class="form-grid">
          <div class="form-row">
            <label>Nombre</label>
            <input type="text" id="concepto-nombre" placeholder="Cuota Mensual, Matrícula, ...">
          </div>
          <div class="form-row">
            <label>Precio base</label>
            <input type="number" id="concepto-precio-base" min="0" step="0.01">
          </div>
          <div class="form-row">
            <label>Tipo</label>
            <input type="text" id="concepto-tipo" placeholder="cuota, servicio">
          </div>
          <div class="form-row">
            <label>Activo</label>
            <select id="concepto-activo">
              <option value="true">Sí</option>
              <option value="false">No</option>
            </select>
          </div>
          <div class="form-row">
            <label>Categoría</label>
            <input type="text" id="concepto-categoria" placeholder="mensualidad, inscripción">
          </div>
          <div class="form-row">
            <label>Descripción</label>
            <textarea id="concepto-descripcion"></textarea>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" id="save-concepto">Guardar</button>
        <button class="btn" id="cancel-concepto">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal: Método de Pago (Crear/Editar) -->
  <div class="modal-backdrop" id="modal-metodo" style="display:none" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-metodo-title">
      <div class="modal-header">
        <h3 id="modal-metodo-title">Método de Pago</h3>
        <button class="modal-close" id="close-modal-metodo" aria-label="Cerrar">×</button>
      </div>
      <div class="modal-body">
        <div class="form-grid">
          <div class="form-row">
            <label>Nombre</label>
            <input type="text" id="metodo-nombre" placeholder="Efectivo, Tarjeta, ...">
          </div>
          <div class="form-row">
            <label>Comisión (%)</label>
            <input type="number" id="metodo-comision" min="0" step="0.01">
          </div>
          <div class="form-row">
            <label>Color</label>
            <input type="text" id="metodo-color" placeholder="#00AA66">
          </div>
          <div class="form-row">
            <label>Activo</label>
            <select id="metodo-activo">
              <option value="true">Sí</option>
              <option value="false">No</option>
            </select>
          </div>
          <div class="form-row">
            <label>Descripción</label>
            <textarea id="metodo-descripcion"></textarea>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" id="save-metodo">Guardar</button>
        <button class="btn" id="cancel-metodo">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modales: Ejercicios -->
<div class="modal-backdrop" id="modal-ejercicio-form" style="display:none" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-ejercicio-title">
    <div class="modal-header">
      <h3 id="modal-ejercicio-title" style="margin:0; font-size:16px;">Ejercicio</h3>
      <button class="modal-close" id="close-modal-ejercicio" aria-label="Cerrar">×</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-row">
          <label for="ejercicio-nombre">Nombre</label>
          <input id="ejercicio-nombre" type="text" placeholder="Ej. Press banca" />
        </div>
        <div class="form-row">
          <label for="ejercicio-grupo">Grupo muscular</label>
          <input id="ejercicio-grupo" type="text" placeholder="Pecho, Espalda, etc." />
        </div>
        <div class="form-row">
          <label for="ejercicio-objetivo">Objetivo</label>
          <select id="ejercicio-objetivo">
            <option value="general">General</option>
            <option value="fuerza">Fuerza</option>
            <option value="hipertrofia">Hipertrofia</option>
            <option value="resistencia">Resistencia</option>
            <option value="cardio">Cardio</option>
            <option value="flexibilidad">Flexibilidad</option>
          </select>
        </div>
        <div class="form-row">
          <label for="ejercicio-descripcion">Descripción</label>
          <textarea id="ejercicio-descripcion" placeholder="Instrucciones, técnica y variantes"></textarea>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" id="save-ejercicio">Guardar</button>
      <button class="btn" id="cancel-ejercicio">Cancelar</button>
    </div>
  </div>
</div>

  <!-- Modales: Rutinas -->
<div class="modal-backdrop" id="modal-rutina-form" style="display:none" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-rutina-title" style="width: 75vw; max-width: 900px">
    <div class="modal-header">
      <h3 id="modal-rutina-title" style="margin:0; font-size:16px;">Rutina</h3>
      <button class="modal-close" id="close-modal-rutina" aria-label="Cerrar">×</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-row">
          <label for="rutina-nombre">Nombre</label>
          <input id="rutina-nombre" type="text" placeholder="Ej. Rutina Full Body" />
        </div>
        <div class="form-row">
          <label for="rutina-descripcion">Descripción</label>
          <textarea id="rutina-descripcion" placeholder="Estructura, objetivos y notas"></textarea>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" id="save-rutina">Guardar</button>
      <button class="btn" id="cancel-rutina">Cancelar</button>
    </div>
  </div>
</div>

<div class="modal-backdrop" id="modal-rutina-delete" style="display:none" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-rutina-del-title" style="width: 65vw; max-width: 780px">
    <div class="modal-header">
      <h3 id="modal-rutina-del-title" style="margin:0; font-size:16px;">Eliminar rutina</h3>
      <button class="modal-close" id="rutina-delete-close" aria-label="Cerrar">×</button>
    </div>
    <div class="modal-body">
      <p>¿Seguro que deseas eliminar esta rutina?</p>
    </div>
    <div class="modal-footer">
      <button class="btn" id="rutina-delete-confirm">Eliminar</button>
      <button class="btn" id="rutina-delete-cancel">Cancelar</button>
    </div>
  </div>
</div>

<div class="modal-backdrop" id="modal-rutina-assign" style="display:none" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-rutina-assign-title" style="width: 70vw; max-width: 900px">
    <div class="modal-header">
      <h3 id="modal-rutina-assign-title" style="margin:0; font-size:16px;">Asignar rutina a usuario</h3>
      <button class="modal-close" id="rutina-assign-close" aria-label="Cerrar">×</button>
    </div>
    <div class="modal-body" style="max-height: 70vh; overflow:auto">
      <div class="form-grid">
        <div class="form-row"><div id="rutina-assign-summary" style="font-size: 13px; color: var(--text-muted)">Rutina seleccionada: <span id="rutina-assign-rutina-name">—</span> • Usuario actual: <span id="rutina-assign-current-user">—</span></div></div>
        <div class="form-row">
          <label for="rutina-assign-search">Buscar usuario</label>
          <input id="rutina-assign-search" type="text" placeholder="Nombre, DNI o teléfono" />
        </div>
        <div class="form-row">
          <label for="rutina-assign-user">Usuario</label>
          <select id="rutina-assign-user"></select>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" id="rutina-assign-confirm">Asignar</button>
      <button class="btn" id="rutina-assign-cancel">Cancelar</button>
    </div>
  </div>
</div>

<div class="modal-backdrop" id="modal-rutina-unassign" style="display:none" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-rutina-unassign-title" style="width: 70vw; max-width: 900px">
    <div class="modal-header">
      <h3 id="modal-rutina-unassign-title" style="margin:0; font-size:16px;">Desasignar rutina</h3>
      <button class="modal-close" id="rutina-unassign-close" aria-label="Cerrar">×</button>
    </div>
    <div class="modal-body" style="max-height: 70vh; overflow:auto">
      <div class="form-grid">
        <div class="form-row"><div id="rutina-unassign-summary" style="font-size: 13px; color: var(--text-muted)">Rutina seleccionada: <span id="rutina-unassign-rutina-name">—</span> • Usuario asignado: <span id="rutina-unassign-current-user">—</span></div></div>
        <div class="form-row">
          <label for="rutina-unassign-search">Buscar usuario</label>
          <input id="rutina-unassign-search" type="text" placeholder="Nombre, DNI o teléfono" />
        </div>
        <div class="form-row">
          <label for="rutina-unassign-user">Usuario</label>
          <select id="rutina-unassign-user"></select>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" id="rutina-unassign-confirm">Desasignar</button>
      <button class="btn" id="rutina-unassign-cancel">Cancelar</button>
    </div>
  </div>
</div>

<!-- Modal: Previsualización y edición avanzada de Rutina -->
<div class="modal-backdrop" id="modal-rutina-preview" style="display:none" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-rutina-preview-title" style="width: 99vw; max-width: 1600px">
    <div class="modal-header">
      <h3 id="modal-rutina-preview-title" style="margin:0; font-size:16px;">Vista previa de rutina</h3>
      <div id="rutina-preview-status" class="muted" aria-live="polite" style="margin-left:auto; margin-right:8px"></div>
      <button class="modal-close" id="rutina-preview-close" aria-label="Cerrar">×</button>
    </div>
    <div class="modal-body" style="max-height: 82vh; overflow:auto">
      <div class="form-grid" id="rutina-preview-form" style="margin-bottom:8px">
        <div class="form-row" style="display:flex; gap:12px; align-items:flex-end; flex-wrap:wrap">
          <div style="display:flex; gap:8px; align-items:center; flex:2; min-width:280px">
            <label for="rutina-preview-nombre" style="white-space:nowrap">Nombre</label>
            <input id="rutina-preview-nombre" type="text" placeholder="Nombre de la rutina" style="flex:1" />
          </div>
          <div style="display:flex; gap:8px; align-items:center">
            <label for="rutina-preview-dias" style="white-space:nowrap">Días</label>
            <select id="rutina-preview-dias">
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
            </select>
          </div>
          <div style="display:flex; gap:8px; align-items:center">
            <label for="rutina-preview-semanas" style="white-space:nowrap">Semana</label>
            <select id="rutina-preview-semanas">
              <option value="1" selected>1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
            </select>
          </div>
        </div>
        <div id="rutina-preview-advanced" style="margin-top:4px">
          <div class="form-row">
            <label for="rutina-preview-descripcion">Descripción</label>
            <textarea id="rutina-preview-descripcion" placeholder="Estructura y objetivos"></textarea>
          </div>
          <div class="form-row">
            <label for="rutina-preview-categoria">Categoría</label>
            <select id="rutina-preview-categoria">
              <option value="general">General</option>
              <option value="fuerza">Fuerza</option>
              <option value="hipertrofia">Hipertrofia</option>
              <option value="resistencia">Resistencia</option>
              <option value="fullbody">Full body</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <label for="rutina-preview-add-ej">Agregar ejercicio</label>
          <div style="display:grid; grid-template-columns: 1fr; gap:8px">
            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
              <input id="rutina-preview-ejercicio-search" type="text" placeholder="Buscar ejercicio..." aria-label="Buscar ejercicio" style="flex:2; min-width:220px" />
              <select id="rutina-preview-filter-group" title="Filtrar por grupo" aria-label="Filtrar por grupo" style="min-width:180px">
                <option value="">Grupo: Todos</option>
              </select>
              <select id="rutina-preview-filter-objetivo" title="Filtrar por objetivo" aria-label="Filtrar por objetivo" style="min-width:180px">
                <option value="">Objetivo: Todos</option>
              </select>
            </div>
            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
              <select id="rutina-preview-ejercicio" aria-label="Ejercicio" style="flex:2; min-width:240px"></select>
              <select id="rutina-preview-dia" aria-label="Día">
                <option value="1">Día 1</option>
                <option value="2">Día 2</option>
                <option value="3">Día 3</option>
                <option value="4">Día 4</option>
                <option value="5">Día 5</option>
              </select>
              <button class="btn" id="rutina-preview-add">Agregar</button>
              <button class="btn secondary sm" id="rutina-preview-new-ej" title="Crear nuevo ejercicio">Nuevo</button>
              <button class="btn secondary sm" id="rutina-preview-edit-ej" title="Editar ejercicio seleccionado">Editar</button>
              <button class="btn secondary sm" id="rutina-preview-toggle-advanced">Opciones avanzadas</button>
            </div>
          </div>
        </div>
      </div>

      <div id="rutina-preview-tools" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px">
        <label style="display:flex; gap:6px; align-items:center"><input id="rutina-preview-select-mode" type="checkbox" /> <span>Selección múltiple</span></label>
        <button class="btn secondary sm" id="rutina-preview-select-all">Seleccionar todo</button>
        <button class="btn secondary" id="rutina-preview-collapse-days">Colapsar días</button>
      </div>

        <div id="rutina-preview-columns" style="display:grid; grid-template-columns: 2fr 1fr; gap:12px; align-items:start">
          <div>
            <div id="rutina-preview-grid" class="grid" style="display:grid; gap:8px"></div>
          </div>
          <div>
            <!-- Vista previa PDF integrada -->
            <div id="rutina-preview-pdf" class="table-scroll" style="border:1px solid var(--border); border-radius:8px; overflow:auto; position:relative">
              <div id="rutina-preview-pdf-status" class="muted" role="status" aria-live="polite" style="display:none; padding:8px; border-bottom:1px solid var(--border)">Actualizando vista previa…</div>
              <div id="rutina-preview-pdf-empty" class="muted" style="padding:12px">Genera la vista previa PDF guardando la rutina o modifica para que se actualice automáticamente.</div>
              <iframe id="rutina-preview-frame" title="Vista previa de la rutina" style="display:none; width:100%; height:80vh; min-height:480px; border:0; transform-origin: center top" src=""></iframe>
            </div>
          </div>
        </div>
      <div id="rutina-preview-float" class="floating-panel" style="position:absolute; display:none; z-index:1000; background:#fff; border:1px solid #ddd; border-radius:8px; padding:12px; box-shadow:0 8px 24px rgba(0,0,0,0.22); min-width:560px">
        <div style="display:flex; flex-direction:column; gap:6px">
          <div><strong id="rutina-preview-float-title">Ejercicio</strong></div>
          <div id="rutina-preview-float-weekly-inputs" style="display:block">
            <table id="rutina-preview-weekly-table" style="width:100%; border-collapse:collapse;">
              <thead>
                <tr>
                  <th class="muted" style="text-align:left; padding:6px; border-bottom:1px solid #eee">&nbsp;</th>
                  <th style="padding:6px; border-bottom:1px solid #eee">Semana 1</th>
                  <th style="padding:6px; border-bottom:1px solid #eee">Semana 2</th>
                  <th style="padding:6px; border-bottom:1px solid #eee">Semana 3</th>
                  <th style="padding:6px; border-bottom:1px solid #eee">Semana 4</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="muted" style="padding:6px">Repeticiones</td>
                  <td style="padding:6px"><input id="rutina-preview-float-r1" type="number" min="1" style="width:100%" /></td>
                  <td style="padding:6px"><input id="rutina-preview-float-r2" type="number" min="1" style="width:100%" /></td>
                  <td style="padding:6px"><input id="rutina-preview-float-r3" type="number" min="1" style="width:100%" /></td>
                  <td style="padding:6px"><input id="rutina-preview-float-r4" type="number" min="1" style="width:100%" /></td>
                </tr>
                <tr>
                  <td class="muted" style="padding:6px">Series</td>
                  <td style="padding:6px"><input id="rutina-preview-float-s1" type="number" min="1" style="width:100%" /></td>
                  <td style="padding:6px"><input id="rutina-preview-float-s2" type="number" min="1" style="width:100%" /></td>
                  <td style="padding:6px"><input id="rutina-preview-float-s3" type="number" min="1" style="width:100%" /></td>
                  <td style="padding:6px"><input id="rutina-preview-float-s4" type="number" min="1" style="width:100%" /></td>
                </tr>
              </tbody>
            </table>
          </div>
          <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap">
            <label style="display:flex; gap:8px; align-items:center; justify-content:space-between"><span>Orden</span><input id="rutina-preview-float-orden" type="number" min="1" max="8" style="width:120px" /></label>
            <label style="display:flex; gap:8px; align-items:center; justify-content:space-between"><span>Día</span>
              <select id="rutina-preview-float-dia">
                <option value="1">Día 1</option>
                <option value="2">Día 2</option>
                <option value="3">Día 3</option>
                <option value="4">Día 4</option>
                <option value="5">Día 5</option>
              </select>
            </label>
          </div>
          <div style="display:flex; gap:8px; margin-top:6px; align-items:center; flex-wrap:wrap">
            <button class="btn" id="rutina-preview-float-up" title="Subir orden">↑</button>
            <button class="btn" id="rutina-preview-float-down" title="Bajar orden">↓</button>
            <button class="btn secondary" id="rutina-preview-float-dup" title="Duplicar ejercicio">Duplicar</button>
          </div>
          <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap">
            <button class="btn" id="rutina-preview-float-apply">Aplicar</button>
            <button class="btn secondary" id="rutina-preview-float-remove">Eliminar</button>
            <button class="btn" id="rutina-preview-float-close">Cerrar</button>
          </div>
        </div>
      </div>
        <div class="table-scroll" id="rutina-preview-excel" style="margin-top:12px">
          <table id="rutina-preview-excel-table">
          <thead>
            <tr>
              <th>Día</th>
              <th>Ejercicio</th>
              <th>Series</th>
              <th>Repeticiones</th>
              <th>Orden</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <div class="modal-footer">
        <button class="btn" id="rutina-preview-save">Guardar cambios</button>
        <button class="btn secondary" id="rutina-preview-export">Exportar Excel</button>
        <button class="btn" id="rutina-preview-cancel">Cancelar</button>
    </div>
  </div>
  
</div>

<!-- Modal: Exportar Excel de Rutina (previsualización y edición rápida) -->
<div class="modal-backdrop" id="modal-rutina-export" style="display:none" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-rutina-export-title" style="width: 95vw; max-width: 1200px">
    <div class="modal-header">
      <h3 id="modal-rutina-export-title" style="margin:0; font-size:16px;">Exportar a Excel</h3>
      <button class="modal-close" id="rutina-export-close" aria-label="Cerrar">×</button>
    </div>
    <div class="modal-body" style="max-height: 70vh; overflow:auto">
      <div class="form-grid" style="margin-bottom:8px">
        <div class="form-row">
          <label for="rutina-export-filename">Nombre de archivo</label>
          <input id="rutina-export-filename" type="text" placeholder="rutina.xlsx" />
        </div>
        <div class="form-row">
          <label for="rutina-export-weeks">Semanas a exportar (1-4)</label>
          <input id="rutina-export-weeks" type="number" min="1" max="4" value="1" aria-describedby="rutina-export-weeks-help" />
          <small id="rutina-export-weeks-help" class="muted">Elige cuántas semanas incluir en el Excel.</small>
        </div>
      </div>
      <div class="form-grid" style="margin:8px 0;">
        <div class="form-row">
          <label>Aplicar a todas</label>
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
            <input id="rutina-export-all-series" type="number" min="1" placeholder="Series" style="width:120px" />
            <input id="rutina-export-all-reps" type="number" min="1" placeholder="Repeticiones" style="width:140px" />
            <button class="btn secondary" id="rutina-export-apply-all">Aplicar a todas</button>
          </div>
        </div>
      </div>
      <div class="table-scroll">
        <table id="rutina-export-table">
          <thead>
            <tr>
              <th>Día</th>
              <th>Ejercicio</th>
              <th>Series</th>
              <th>Repeticiones</th>
              <th>Orden</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <p class="muted">Puedes editar Series y Repeticiones directamente en la tabla. La previsualización se genera desde el archivo final del backend.</p>
      <div style="margin-top:12px">
        <div style="display:flex; align-items:center; gap:8px; justify-content:space-between; flex-wrap:wrap">
          <span class="muted">Vista previa literal del Excel generado</span>
          <div style="display:flex; gap:8px; align-items:center">
            <button class="btn secondary" id="rutina-export-preview-btn">Actualizar vista previa</button>
            <button class="btn" id="rutina-export-save-btn">Guardar cambios</button>
          </div>
        </div>
        <div id="rutina-export-preview" class="table-scroll" style="margin-top:8px"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" id="rutina-export-download">Descargar Excel</button>
      <button class="btn" id="rutina-export-close-btn">Cerrar</button>
    </div>
  </div>
</div>
<div class="modal-backdrop" id="modal-ejercicio-delete" style="display:none" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-ejercicio-del-title">
    <div class="modal-header">
      <h3 id="modal-ejercicio-del-title" style="margin:0; font-size:16px;">Eliminar ejercicio</h3>
      <button class="modal-close" id="ejercicio-delete-close" aria-label="Cerrar">×</button>
    </div>
    <div class="modal-body">
      <p>¿Seguro que deseas eliminar este ejercicio?</p>
    </div>
    <div class="modal-footer">
      <button class="btn" id="ejercicio-delete-confirm">Eliminar</button>
      <button class="btn" id="ejercicio-delete-cancel">Cancelar</button>
    </div>
  </div>
</div>

<!-- Modal: Ejercicio Extras (Equipamiento y Variantes) -->
<div class="modal-backdrop" id="modal-ejercicio-extras" style="display:none" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-ejercicio-extras-title">
    <div class="modal-header">
      <h3 id="modal-ejercicio-extras-title" style="margin:0; font-size:16px;">Editar equipamiento y variantes</h3>
      <button class="modal-close" id="close-modal-extras" aria-label="Cerrar">×</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-row">
          <label for="extras-equipamiento">Equipamiento sugerido</label>
          <textarea id="extras-equipamiento" placeholder="Un ítem por línea o separados por ;"></textarea>
        </div>
        <div class="form-row">
          <label for="extras-variantes">Variantes útiles</label>
          <textarea id="extras-variantes" placeholder="Un ítem por línea o separados por ;"></textarea>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" id="save-extras">Guardar</button>
      <button class="btn" id="cancel-extras">Cancelar</button>
    </div>
  </div>
</div>

<!-- Modal: QR Check-in Toast -->
  <div class="modal-backdrop" id="modal-qr-toast" style="display:none" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-qr-title">
      <div class="modal-header">
        <h3 id="modal-qr-title" style="margin:0; font-size:16px;">QR Check-in</h3>
        <button class="modal-close" id="qr-close-btn" aria-label="Cerrar">×</button>
      </div>
      <div class="modal-body" style="text-align:center">
        <div class="muted" id="qr-user-name" style="margin-bottom:6px">—</div>
        <canvas id="qr-canvas" width="240" height="240" style="display:inline-block; border-radius:8px; background:#fff; margin-bottom:8px"></canvas>
        <div class="muted" id="qr-token-masked" style="margin-top:4px">token: —</div>
        <div style="margin-top:8px">
          <strong>Tiempo restante:</strong> <span id="qr-countdown">—</span>
        </div>
        <div id="qr-status-msg" class="muted" style="margin-top:8px">Esperando confirmación…</div>
      </div>
      <div class="modal-footer">
        <button class="btn secondary" id="qr-close-footer">Cerrar</button>
      </div>
    </div>
  </div>

  <div id="toast-container" class="toast-container"></div>

  <script>
    let editingUserId = null;
    let editingPagoId = null;
const state = { pagos: [], pagosFilters: { metodo: '', concepto: '' }, deleteUserId: null, deletePagoId: null, selectedPago: null, selectedUsuario: null, usuarioHistorial: [], configTipos: [], configConceptos: [], configMetodos: [], editingTipoId: null, editingConceptoId: null, editingMetodoId: null, deleteTipoId: null, deleteConceptoId: null, deleteMetodoId: null, tiposCuotaActivos: [], tiposCuotaMap: {}, metodosPago: [], metodosPagoMap: {}, ejercicios: [], editingEjercicioId: null, deleteEjercicioId: null, selectedEjercicio: null, rutinas: [], plantillas: [], activeRutinaTab: 'plantillas', assignPlantillaId: null, editingRutinaId: null, deleteRutinaId: null, selectedRutina: null, renumStartId: null, estadoPlantillas: [], estadoPlantillasMap: {}, rutinaSelectMode: false, rutinaSelected: [], rutinaCompact: false, rutinaDayCollapsed: {}, rutinaAutoSaveTimer: null, rutinaPreviewDirty: false, lastAutoSaveTs: 0, ejFilter: { q:'', group:'', objetivo:'' }, ejerciciosFiltered: null };

    function fmtDate(d){
      if(!d) return '';
      if (typeof d === 'string') {
        const s = d.trim();
        const m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
        if (m) {
          return `${m[1]}-${m[2]}-${m[3]}`;
        }
      }
      const dt = new Date(d);
      if(isNaN(dt.getTime())) return String(d);
      const y = dt.getFullYear();
      const m = String(dt.getMonth()+1).padStart(2,'0');
      const day = String(dt.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }
    function defaultRange(){
      const end = new Date();
      const start = new Date(end);
      start.setDate(end.getDate() - 30);
      return { start: fmtDate(start), end: fmtDate(end) };
    }
    function switchTab(tab){
      document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
      const panel = document.getElementById(`panel-${tab}`);
      if(panel) panel.classList.add('active');
    }

    function openModal(id){
      const el = document.getElementById(id);
      if(el){
        // Asegurar stacking por z-index incremental para evitar que quede debajo de otros modales
        try { state._modalZBase = (state._modalZBase || 1000) + 1; el.style.zIndex = String(state._modalZBase); } catch(_){ }
        el.classList.add('active');
        el.style.display = 'flex';
        el.setAttribute('aria-hidden','false');
        const modalEl = el.querySelector('.modal');
        if(modalEl){
          const labelId = modalEl.getAttribute('aria-labelledby');
          if(labelId){ const labelEl = document.getElementById(labelId); if(labelEl){ labelEl.setAttribute('tabindex','-1'); labelEl.focus(); } }
        }
      }
    }
    function closeModal(id){
      const el = document.getElementById(id);
      if(!el) return;
      const m = el.querySelector('.modal');
      if(m){
        m.classList.add('closing');
        setTimeout(() => { el.classList.remove('active'); m.classList.remove('closing'); el.style.display = 'none'; el.setAttribute('aria-hidden','true'); }, 160);
      } else {
        el.classList.remove('active'); el.style.display = 'none'; el.setAttribute('aria-hidden','true');
      }
    }

    // Toasts de notificación — centralizado en /static/js/toast.js
    // Usa showToast(message, type='info', duration=3500, actionText='OK');
    if (typeof window.showToast !== 'function') {
      window.showToast = function(message, type = 'info', duration = 3500, actionText = 'OK') {
        try {
          const cont = document.getElementById('toast-container');
          if (!cont) { console[type === 'error' ? 'error' : 'log'](message); return; }
          const toast = document.createElement('div');
          toast.className = `toast ${type}`;
          toast.textContent = message;
          cont.appendChild(toast);
          setTimeout(() => { toast.classList.add('visible'); }, 10);
          setTimeout(() => { toast.classList.remove('visible'); toast.remove(); }, duration);
        } catch (e) { console.error(message); }
      };
    }

    // ===== QR Check-in (Gestión) =====
    let qrState = { token: null, expiresTs: 0, countdownInt: null, pollInt: null };
    function stopQRTimers(){ if(qrState.countdownInt){ clearInterval(qrState.countdownInt); qrState.countdownInt=null; } if(qrState.pollInt){ clearInterval(qrState.pollInt); qrState.pollInt=null; } }
    function formatCountdown(ms){ if(ms<=0) return '0:00'; const total = Math.floor(ms/1000); const m = Math.floor(total/60); const s = String(total%60).padStart(2,'0'); return `${m}:${s}`; }
    function updateQRCountdown(){ const el = document.getElementById('qr-countdown'); const now = Date.now(); const rem = Math.max(0, qrState.expiresTs - now); if(el) el.textContent = formatCountdown(rem); if(rem<=0){ const status = document.getElementById('qr-status-msg'); if(status) status.textContent = 'Token expirado'; stopQRTimers(); setTimeout(() => closeQRModal(), 1200); } }
    function pollTokenStatus(){ if(!qrState.token) return; fetch(`/api/checkin/token_status?token=${encodeURIComponent(qrState.token)}`, { headers:{ 'Accept':'application/json' } })
      .then(r => r.json()).then(j => {
        const status = document.getElementById('qr-status-msg');
        if(j && j.exists){
          const used = !!j.used; const expired = !!j.expired;
          if(status){ status.textContent = used ? '¡Asistencia registrada!' : (expired ? 'Token expirado' : 'Esperando confirmación…'); }
          if(used){
            // Refrescar la tabla de usuarios y mantener la selección actual
            const u = state.selectedUsuario;
            (async () => {
              try {
                await loadUsers();
                if (u && u.id) {
                  const idx = (state.usuarios || []).findIndex(x => x.id === u.id);
                  if (idx >= 0) selectUsuarioByIndex(idx);
                }
              } catch(_) {}
            })();
          }
          if(used || expired){ stopQRTimers(); setTimeout(() => closeQRModal(), 1200); }
        } else {
          if(status) status.textContent = 'Token inválido o inexistente';
        }
      }).catch(() => {});
    }
    function closeQRModal(){ stopQRTimers(); qrState.token=null; qrState.expiresTs=0; const un = document.getElementById('qr-user-name'); if(un) un.textContent='—'; const tm = document.getElementById('qr-token-masked'); if(tm) tm.textContent='token: —'; closeModal('modal-qr-toast'); }
    async function emitirQRCheckin(){ const u = state.selectedUsuario; if(!u || !u.id){ showToast('Selecciona un usuario primero', 'warning', 4000); return; }
      const set = state.asistenciasHoySet;
      if(set && set.has(Number(u.id))){
        showToast('El usuario ya asistió hoy. No se emite QR.', 'info', 3500);
        return;
      }
      const expires_minutes = 5;
      try{
        const res = await fetch('/api/checkin/create_token', { method:'POST', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify({ usuario_id: u.id, expires_minutes }) });
        if(!res.ok){ const err = await res.json().catch(() => ({})); throw new Error(err.detail || err.error || `Error ${res.status}`); }
        const data = await res.json();
        const token = String(data.token || '').trim(); if(!token){ throw new Error('No se generó token'); }
        qrState.token = token; qrState.expiresTs = Date.now() + (Number(data.expires_minutes||expires_minutes) * 60 * 1000);
        const un = document.getElementById('qr-user-name'); if(un) un.textContent = String(u.nombre || `Usuario #${u.id}`);
        const tm = document.getElementById('qr-token-masked'); if(tm) tm.textContent = `token: ***${token.slice(-4)}`;
        openModal('modal-qr-toast');
        showToast('Token de check-in generado', 'success', 2500);
        const statusEl = document.getElementById('qr-status-msg'); if(statusEl) statusEl.textContent = 'Generando QR…';
        const canvasEl = document.getElementById('qr-canvas');
        if(canvasEl){ const ctx = canvasEl.getContext('2d'); if(ctx){ ctx.clearRect(0,0,canvasEl.width,canvasEl.height); ctx.fillStyle='#f5f5f5'; ctx.fillRect(0,0,canvasEl.width,canvasEl.height); ctx.strokeStyle='#ddd'; for(let i=0;i<=12;i++){ ctx.beginPath(); ctx.moveTo(i*20,0); ctx.lineTo(i*20,240); ctx.stroke(); ctx.beginPath(); ctx.moveTo(0,i*20); ctx.lineTo(240,i*20); ctx.stroke(); } } }
        let qrLibReady = false;
        try{
          if(typeof window.loadQRCodeLib === 'function'){
            qrLibReady = await window.loadQRCodeLib();
          } else {
            qrLibReady = !!window.QRCode;
          }
        }catch(_){ qrLibReady = !!window.QRCode; }
        const canvas = document.getElementById('qr-canvas');
        if(canvas && qrLibReady && window.QRCode && typeof window.QRCode.toCanvas === 'function'){
          try { window.QRCode.toCanvas(canvas, token, { width: 240 }); } catch(_){}
        } else {
          const status = document.getElementById('qr-status-msg'); if(status) status.textContent = 'No se pudo cargar la librería de QR. Usa ingreso manual.';
          if(tm) tm.textContent = `token: ${token}`;
        }
        updateQRCountdown(); stopQRTimers(); qrState.countdownInt = setInterval(updateQRCountdown, 1000); qrState.pollInt = setInterval(pollTokenStatus, 2000);
      }catch(e){ showToast(`No se pudo emitir token: ${e.message}`, 'error', 4500); }
    }
    async function registrarAsistenciaQuick(){ const u = state.selectedUsuario; if(!u || !u.id){ showToast('Selecciona un usuario primero', 'warning', 4000); return; }
      try{
        const res = await fetch('/api/asistencias/registrar', { method:'POST', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify({ usuario_id: u.id }) });
        if(!res.ok){ const err = await res.json().catch(() => ({})); throw new Error(err.detail || err.error || `Error ${res.status}`); }
        const j = await res.json().catch(() => ({}));
        showToast('Asistencia registrada', 'success', 3000);
        await loadUsers(); const idx = (state.usuarios || []).findIndex(x => x.id === u.id); if(idx >= 0) selectUsuarioByIndex(idx);
      }catch(e){ showToast(`No se pudo registrar asistencia: ${e.message}`, 'error', 4500); }
    }

    async function eliminarAsistenciaQuick(){ const u = state.selectedUsuario; if(!u || !u.id){ showToast('Selecciona un usuario primero', 'warning', 4000); return; } const hoy = fmtDate(new Date()); try{ const res = await fetch('/api/asistencias/eliminar', { method:'DELETE', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify({ usuario_id: u.id, fecha: hoy }) }); if(!res.ok){ const err = await res.json().catch(() => ({})); throw new Error(err.detail || err.error || `Error ${res.status}`); } await res.json().catch(() => ({})); showToast('Asistencia eliminada', 'success', 3000); await loadUsers(); const idx = (state.usuarios || []).findIndex(x => x.id === u.id); if(idx >= 0) selectUsuarioByIndex(idx); }catch(e){ showToast(`No se pudo eliminar asistencia: ${e.message}`, 'error', 4500); } }

    function handleAsistenciaClick(){ const u = state.selectedUsuario; if(!u || !u.id){ showToast('Selecciona un usuario primero', 'warning', 4000); return; } const btn = document.getElementById('usuario-side-asistencia'); const hoy = fmtDate(new Date()); const arr = Array.isArray(state.usuarioAsistencias) ? state.usuarioAsistencias : []; const hasHoy = arr.some(a => { const f = a.fecha || a.fecha_asistencia || a.fechaAsistencia || ''; return fmtDate(f) === hoy; }); if(hasHoy){ eliminarAsistenciaQuick(); } else { registrarAsistenciaQuick(); } }

    function pagosAplicaFiltros(items){
      const metodo = (state.pagosFilters.metodo || '').trim().toLowerCase();
      const concepto = (state.pagosFilters.concepto || '').trim().toLowerCase();
      if(!metodo && !concepto) return items;
      return items.filter(row => {
        const m = String(row.metodo_pago || row.metodo || '').toLowerCase();
        const c = String(row.concepto_pago || row.concepto || '').toLowerCase();
        return (!metodo || m === metodo || m.includes(metodo)) && (!concepto || c === concepto || c.includes(concepto));
      });
    }

    async function loadPayments(){
      const start = document.getElementById('pagos-start').value || '';
      const end = document.getElementById('pagos-end').value || '';
      const q = document.getElementById('pagos-q').value || '';
      const limit = parseInt(document.getElementById('pagos-limit').value || '50', 10);
      const params = new URLSearchParams();
      if(start) params.append('start', start);
      if(end) params.append('end', end);
      if(q) params.append('q', q);
      params.append('limit', String(limit));
      params.append('offset', '0');
      const url = `/api/pagos_detalle?${params.toString()}`;
      try {
        const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
        const data = await res.json();
        const itemsRaw = Array.isArray(data.items) ? data.items : (Array.isArray(data) ? data : []);
        state.pagos = itemsRaw;
        const items = pagosAplicaFiltros(itemsRaw);
        const tbody = document.querySelector('#pagos-table tbody');
        tbody.innerHTML = '';
        items.forEach((row, idx) => {
          const tr = document.createElement('tr');
          tr.setAttribute('data-index', String(idx));
          const fecha = row.fecha_pago || row.fecha || row.fechaPago || null;
          const nombre = row.usuario_nombre || row.nombre || '';
          const dni = row.dni || '';
          const metodo = row.metodo_pago || row.metodo || '';
          const concepto = row.concepto_pago || row.concepto || '';
          const monto = row.monto != null ? row.monto : '';
          tr.innerHTML = `
            <td>${fecha ? fmtDate(fecha) : ''}</td>
            <td>${nombre}</td>
            <td>${dni}</td>
            <td>${metodo}</td>
            <td>${concepto}</td>
            <td>${monto}</td>
            <td class="table-actions">
              <button class="btn" data-action="recibo" data-id="${row.id || row.pago_id || ''}" data-index="${idx}">Recibo</button>
              <button class="btn" data-action="editar" data-id="${row.id || row.pago_id || ''}" data-index="${idx}">Editar</button>
              <button class="btn secondary" data-action="eliminar" data-id="${row.id || row.pago_id || ''}" data-index="${idx}">Borrar</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
        const count = (data && typeof data.count === 'number') ? data.count : items.length;
        document.getElementById('pagos-count').textContent = `${count} pagos`;
        // Tarjetas
        const totalMonto = items.reduce((acc, r) => acc + (parseFloat(r.monto || 0) || 0), 0);
        const uniqueDni = new Set(items.map(r => String(r.dni || '')));
        document.getElementById('pagos-card-count').textContent = String(items.length);
        document.getElementById('pagos-card-monto').textContent = `$${totalMonto.toFixed(2)}`;
        document.getElementById('pagos-card-unique').textContent = String(Array.from(uniqueDni).filter(v => v).length);
        const avg = items.length ? (totalMonto / items.length) : 0;
        const avgEl = document.getElementById('pagos-card-average');
        if(avgEl) avgEl.textContent = `$${avg.toFixed(2)}`;
      } catch(err){
        console.error('Error cargando pagos:', err);
      }
    }

    async function loadMetodosPago(){
      try {
        const res = await fetch('/api/metodos_pago', { headers: { 'Accept': 'application/json' } });
        const met = await res.json();
        const sel = document.getElementById('pagos-metodo');
        sel.innerHTML = '<option value="">Todos</option>';
        (Array.isArray(met) ? met : []).forEach(m => {
          const opt = document.createElement('option');
          const nombre = m.nombre ?? '';
          opt.value = String(nombre).toLowerCase();
          opt.textContent = nombre;
          sel.appendChild(opt);
        });
        // Preselección actual
        if(state.pagosFilters.metodo){ sel.value = state.pagosFilters.metodo; }
      } catch(e){ console.warn('No se pudieron cargar métodos de pago:', e); }
    }
    async function loadConceptosPago(){
      try {
        const res = await fetch('/api/conceptos_pago', { headers: { 'Accept': 'application/json' } });
        const conc = await res.json();
        const sel = document.getElementById('pagos-concepto');
        sel.innerHTML = '<option value="">Todos</option>';
        (Array.isArray(conc) ? conc : []).forEach(c => {
          const nombre = c.nombre ?? '';
          const opt = document.createElement('option');
          opt.value = String(nombre).toLowerCase();
          opt.textContent = nombre;
          sel.appendChild(opt);
        });
        if(state.pagosFilters.concepto){ sel.value = state.pagosFilters.concepto; }
      } catch(e){ console.warn('No se pudieron cargar conceptos:', e); }
    }

    async function loadTiposCuotaActivos(){
      try {
        const res = await fetch('/api/tipos_cuota_activos', { headers: { 'Accept': 'application/json' } });
        const tipos = await res.json();
        const lista = Array.isArray(tipos) ? tipos : [];
        state.tiposCuotaActivos = lista;
        state.tiposCuotaMap = Object.fromEntries(lista.map(t => [String(t.id ?? t.nombre ?? ''), t]));
        const sel = document.getElementById('u-tipo-cuota');
        if(sel){
          sel.innerHTML = '<option value="">Tipo de cuota</option>' + lista.map(t => `<option value="${t.id ?? t.nombre ?? ''}">${t.nombre ?? String(t.id ?? '')}</option>`).join('');
        }
      } catch(e){ console.warn('No se pudieron cargar tipos de cuota activos:', e); }
    }

    function updateUsuariosCards(rows){
      const count = (Array.isArray(rows) ? rows.length : 0);
      const activos = (Array.isArray(rows) ? rows.filter(u => (u.activo === true || u.activo === 'true')).length : 0);
      const inactivos = (Array.isArray(rows) ? rows.filter(u => !(u.activo === true || u.activo === 'true')).length : 0);
      const profesores = (Array.isArray(rows) ? rows.filter(u => String(u.rol || '').toLowerCase() === 'profesor').length : 0);
      const sinTelefono = (Array.isArray(rows) ? rows.filter(u => !(u.telefono && String(u.telefono).trim())).length : 0);
      const conNotas = (Array.isArray(rows) ? rows.filter(u => !!(u.notas && String(u.notas).trim())).length : 0);
      const c1 = document.getElementById('usuarios-card-count');
      const c2 = document.getElementById('usuarios-card-activos');
      const c3 = document.getElementById('usuarios-card-inactivos');
      const c4 = document.getElementById('usuarios-card-profesores');
      const c5 = document.getElementById('usuarios-card-sin-telefono');
      const c6 = document.getElementById('usuarios-card-con-notas');
      if(c1) c1.textContent = String(count);
      if(c2) c2.textContent = String(activos);
      if(c3) c3.textContent = String(inactivos);
      if(c4) c4.textContent = String(profesores);
      if(c5) c5.textContent = String(sinTelefono);
      if(c6) c6.textContent = String(conNotas);
    }

    async function loadUsers(){
      const q = document.getElementById('usuarios-q').value || '';
      const limit = parseInt(document.getElementById('usuarios-limit').value || '50', 10);
      const params = new URLSearchParams();
      if(q) params.append('q', q);
      params.append('limit', String(limit));
      params.append('offset', '0');
      const url = `/api/usuarios?${params.toString()}`;
      try {
        const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
        const rows = await res.json();
        state.usuarios = Array.isArray(rows) ? rows : [];
        // Obtener set de IDs con asistencia hoy
        const hoySet = await (async () => {
          try {
            const r = await fetch('/api/asistencias_hoy_ids', { headers: { 'Accept': 'application/json' } });
            const arr = await r.json();
            const list = Array.isArray(arr) ? arr : [];
            return new Set(list.map(x => Number(x)));
          } catch(e) { return new Set(); }
        })();
        state.asistenciasHoySet = hoySet;
        const tbody = document.querySelector('#usuarios-table tbody');
        tbody.innerHTML = '';
        (Array.isArray(rows) ? rows : []).forEach((u, idx) => {
          const tr = document.createElement('tr');
          tr.setAttribute('data-index', String(idx));
          const activo = (u.activo === true || u.activo === 'true');
          const asistioHoy = hoySet.has(Number(u.id));
          const tipoObj = resolveTipoCuota(u.tipo_cuota ?? (u.tipo_cuota_nombre || u.tipo || ''));
          const tipoNombre = tipoObj ? (tipoObj.nombre || '') : (u.tipo_cuota_nombre || u.tipo_cuota || '');
          tr.innerHTML = `
            <td>${u.nombre || ''}</td>
            <td>${u.dni || ''}</td>
            <td>${u.telefono || ''}</td>
            <td>${(u.rol || '').toString().toLowerCase()}</td>
            <td>${tipoNombre}</td>
            <td>${activo ? 'Sí' : 'No'}</td>
            <td>${asistioHoy ? '<span style="padding:2px 8px;border-radius:10px;background:#27ae60;color:#fff;">Asistió</span>' : '<span style="padding:2px 8px;border-radius:10px;background:#e74c3c;color:#fff;">No asistió</span>'}</td>
            <td>
              <button class="btn secondary" data-action="edit" data-id="${u.id}">Editar</button>
              <button class="btn secondary" data-action="delete" data-id="${u.id}">Borrar</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
        document.getElementById('usuarios-count').textContent = `${(Array.isArray(rows) ? rows.length : 0)} usuarios`;
        updateUsuariosCards(rows);
        try { populatePagosUsuarioSelector(); } catch {}
        // Actualizar selector de usuario en Rutinas
        try { renderRutinasUsuarioFilter(); } catch {}
      } catch(err){
        console.error('Error cargando usuarios:', err);
      }
    }

    function showUserForm(user){
      editingUserId = user && user.id ? user.id : null;
      const f = (id) => document.getElementById(id);
      f('u-nombre').value = (user && user.nombre) || '';
      f('u-dni').value = (user && user.dni) || '';
      f('u-telefono').value = (user && user.telefono) || '';
      // Prefijo por defecto si no hay teléfono
      if(!user || !user.telefono){ const telEl = f('u-telefono'); if(telEl && !telEl.value) telEl.value = '+54'; }
      f('u-pin').value = (user && user.pin) || '';
      // Aplicar restricción: un profesor no puede ver/editar el PIN de otro profesor
      try {
        const loginEl = document.getElementById('login-current');
        const sessionRole = (loginEl && loginEl.getAttribute('data-role') || '').trim();
        const sessionProfUid = (loginEl && loginEl.getAttribute('data-prof-uid') || '').trim();
        const isProfSession = (sessionRole === 'profesor') && !!sessionProfUid;
        const isEditingProfessor = user && String(user.rol || '').toLowerCase() === 'profesor';
        const isOtherProfessor = !!(isProfSession && isEditingProfessor && String(user.id || '') !== String(sessionProfUid));
        const pinEl = f('u-pin');
        if(pinEl){
          pinEl.disabled = false;
          pinEl.placeholder = '';
          if(isOtherProfessor){
            pinEl.value = '';
            pinEl.disabled = true;
            pinEl.placeholder = 'PIN oculto (no editable)';
          }
        }
        // ID editable solo para dueño y no para usuario con rol 'dueño'
        const idEl = f('u-id');
        if(idEl){
          idEl.value = (user && user.id != null) ? String(user.id) : '';
          const isOwnerSession = (sessionRole === 'dueño');
          const isEditingOwner = user && String(user.rol || '').toLowerCase() === 'dueño';
          idEl.disabled = true;
          idEl.placeholder = 'ID (no editable)';
          if(isOwnerSession && user && !isEditingOwner){
            idEl.disabled = false;
            idEl.placeholder = 'Nuevo ID (entero positivo)';
          }
        }
      } catch(e) {}
      f('u-rol').value = (user && user.rol) ? String(user.rol).toLowerCase() : 'socio';
      f('u-activo').checked = user ? !!user.activo : true;
      f('u-notas').value = (user && user.notas) || '';
      loadTiposCuotaActivos().then(() => {
        const sel = f('u-tipo-cuota');
        const v = user ? (user.tipo_cuota ?? '') : '';
        if(sel && v !== undefined && v !== null){ sel.value = String(v); }
      });
      openModal('modal-usuario');
    }
    function hideUserForm(){
      editingUserId = null;
      ['u-id','u-nombre','u-dni','u-telefono','u-pin','u-notas'].forEach(id => { const el = document.getElementById(id); if(el) el.value=''; });
      const sel = document.getElementById('u-tipo-cuota'); if(sel) sel.value='';
      const rol = document.getElementById('u-rol'); if(rol) rol.value='socio';
      const act = document.getElementById('u-activo'); if(act) act.checked=true;
      closeModal('modal-usuario');
    }

    async function saveUser(){
      const f = (id) => document.getElementById(id);
      const pinEl = f('u-pin');
      const payload = {
        nombre: f('u-nombre').value.trim().toUpperCase(),
        dni: f('u-dni').value.trim(),
        telefono: f('u-telefono').value.trim(),
        pin: pinEl && !pinEl.disabled ? pinEl.value.trim() : undefined,
        rol: f('u-rol').value,
        activo: f('u-activo').checked,
        tipo_cuota: f('u-tipo-cuota').value || null,
        notas: f('u-notas').value || null,
      };
      // Si el dueño cambió el ID, enviar new_id
      try {
        const idEl = f('u-id');
        const loginEl = document.getElementById('login-current');
        const sessionRole = (loginEl && loginEl.getAttribute('data-role') || '').trim();
        const isOwnerSession = (sessionRole === 'dueño');
        if(editingUserId && idEl && !idEl.disabled && isOwnerSession){
          const newIdVal = Number(idEl.value || '');
          if(Number.isFinite(newIdVal) && newIdVal > 0 && newIdVal !== Number(editingUserId)){
            payload.new_id = newIdVal;
          }
        }
      } catch(_) {}
      if(pinEl && pinEl.disabled){ delete payload.pin; }
      if(!payload.nombre || !payload.dni){ showToast('Nombre y DNI son obligatorios', 'warning', 3000); return; }
      try {
        const url = editingUserId ? `/api/usuarios/${editingUserId}` : '/api/usuarios';
        const method = editingUserId ? 'PUT' : 'POST';
        const res = await fetch(url, { method, headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' }, body: JSON.stringify(payload) });
        if(!res.ok){ const err = await res.json().catch(() => ({})); throw new Error(err.detail || err.error || `Error ${res.status}`); }
        hideUserForm();
        await loadUsers();
      } catch(e){ showToast(`No se pudo guardar: ${e.message}`, 'error', 4500); }
    }

    async function deleteUser(id){
      if(!id) return;
      try {
        const res = await fetch(`/api/usuarios/${id}`, { method: 'DELETE', headers: { 'Accept': 'application/json' } });
        if(!res.ok){ const err = await res.json().catch(() => ({})); throw new Error(err.detail || err.error || `Error ${res.status}`); }
        await loadUsers();
      } catch(e){ showToast(`No se pudo eliminar: ${e.message}`, 'error', 4500); }
    }

    function renderPagoSide(pago, detalles){
      const fecha = pago.fecha_pago || pago.fecha || pago.fechaPago || '';
      const nombre = pago.usuario_nombre || pago.nombre || '';
      const dni = pago.dni || '';
      const metodo = pago.metodo_pago || pago.metodo || '';
      const concepto = pago.concepto_pago || pago.concepto || '';
      const monto = pago.monto != null ? pago.monto : '';
      document.getElementById('pago-side-fecha').textContent = fecha ? fmtDate(fecha) : '';
      document.getElementById('pago-side-nombre').textContent = nombre;
      document.getElementById('pago-side-dni').textContent = dni;
      document.getElementById('pago-side-metodo').textContent = metodo;
      document.getElementById('pago-side-concepto').textContent = concepto;
      document.getElementById('pago-side-monto').textContent = monto;
      const notasEl = document.getElementById('pago-side-notas');
      if(notasEl) notasEl.textContent = (pago.notas && String(pago.notas).trim()) ? pago.notas : '—';
      const tbody = document.querySelector('#pago-detalles-table tbody');
      if(tbody){
        tbody.innerHTML = '';
        (Array.isArray(detalles) ? detalles : []).forEach(d => {
          const tr = document.createElement('tr');
          const concepto = d.concepto_nombre || d.concepto || d.descripcion || '';
          const cantidad = d.cantidad ?? 1;
          const precio = d.precio_unitario ?? d.precio ?? 0;
          const subtotal = d.subtotal ?? (cantidad * precio);
          tr.innerHTML = `<td>${concepto}</td><td>${cantidad}</td><td>${precio}</td><td>${subtotal}</td>`;
          tbody.appendChild(tr);
        });
      }
    }

    async function selectPagoByIndex(idx){
      const row = (state.pagos || [])[idx];
      if(!row) return;
      state.selectedPago = row;
      const id = row.id || row.pago_id || null;
      document.getElementById('pago-side-empty').style.display = 'none';
      document.getElementById('pago-side').style.display = 'block';
      document.getElementById('pago-side-id').textContent = id ? `#${id}` : '';
      try {
        if(id){
          const res = await fetch(`/api/pagos/${id}`, { headers: { 'Accept': 'application/json' } });
          const data = await res.json();
          const pago = data.pago || row;
          const detalles = Array.isArray(data.detalles) ? data.detalles : [];
          renderPagoSide(pago, detalles);
        } else {
          renderPagoSide(row, []);
        }
      } catch(e){
        console.warn('No se pudo cargar detalles del pago:', e);
        renderPagoSide(row, []);
      }
      const ptbody = document.querySelector('#pagos-table tbody');
      if(ptbody){ ptbody.querySelectorAll('tr').forEach(t => t.classList.remove('selected')); const tr = ptbody.querySelector(`tr[data-index="${idx}"]`); if(tr) tr.classList.add('selected'); }
    }

    function clearPagoSelection(){
      state.selectedPago = null;
      document.getElementById('pago-side-id').textContent = '';
      document.getElementById('pago-side').style.display = 'none';
      document.getElementById('pago-side-empty').style.display = 'block';
      const tbody = document.querySelector('#pago-detalles-table tbody');
      if(tbody) tbody.innerHTML = '';
    }

    function openPagoDetalleModal(){
      const p = state.selectedPago;
      if(!p){ showToast('Selecciona un pago primero', 'warning', 4000); return; }
      const fecha = p.fecha_pago || p.fecha || p.fechaPago || null;
      document.getElementById('pago-detalle-fecha').textContent = fecha ? fmtDate(fecha) : '';
      document.getElementById('pago-detalle-nombre').textContent = p.usuario_nombre || p.nombre || '';
      document.getElementById('pago-detalle-dni').textContent = p.dni || '';
      document.getElementById('pago-detalle-monto').textContent = (p.monto != null ? p.monto : '');
      document.getElementById('pago-detalle-metodo').textContent = p.metodo_pago || p.metodo || '';
      document.getElementById('pago-detalle-concepto').textContent = p.concepto_pago || p.concepto || '';
      openModal('modal-pago-detalle');
    }

    async function navigateToUsuarioDesdePago(){
      const pago = state.selectedPago;
      if(!pago){ showToast('Selecciona un pago primero', 'warning', 4000); return; }
      const dni = pago.dni ? String(pago.dni).trim() : '';
      if(!dni){ showToast('No se encuentra DNI del pago', 'error', 4500); return; }
      const findByDni = () => (state.usuarios || []).findIndex(u => String(u.dni || '').trim() === dni);
      let idx = findByDni();
      switchTab('usuarios');
      if(idx >= 0){ selectUsuarioByIndex(idx); return; }
      await loadUsers();
      idx = findByDni();
      if(idx >= 0) selectUsuarioByIndex(idx);
      else showToast('No se encontró el usuario del pago en la lista.', 'warning', 4000);
    }

    function bindPagosEvents(){
      const tbody = document.querySelector('#pagos-table tbody');
      tbody.addEventListener('click', (ev) => {
        const btn = ev.target.closest('button');
        if(btn){
          const action = btn.getAttribute('data-action');
          if(action === 'ver'){
            const idx = parseInt(btn.getAttribute('data-index') || '0', 10);
            if(isNaN(idx)) return;
            selectPagoByIndex(idx);
            return;
          }
          if(action === 'editar'){
            const idx = parseInt(btn.getAttribute('data-index') || '0', 10);
            if(isNaN(idx)) return;
            const row = (state.pagos || [])[idx];
            const id = btn.getAttribute('data-id');
            if(id){
              fetch(`/api/pagos/${id}`, { headers:{ 'Accept':'application/json' } })
                .then(r => r.json())
                .then(data => showPagoForm(data.pago || row))
                .catch(() => showToast('No se pudo cargar el pago', 'error', 4500));
            } else {
              showPagoForm(row);
            }
            return;
          }
          if(action === 'eliminar'){
            const id = btn.getAttribute('data-id');
            if(!id){ showToast('Pago inválido', 'error', 4500); return; }
            state.deletePagoId = parseInt(id, 10);
            openModal('modal-pagos-delete');
            return;
          }
          if(action === 'recibo'){
            const id = btn.getAttribute('data-id');
            if(!id){ showToast('Pago inválido', 'error', 4500); return; }
            openReciboPreview(id);
            return;
          }
        }
        const tr = ev.target.closest('tr');
        if(!tr) return;
        const idx = parseInt(tr.getAttribute('data-index') || 'NaN', 10);
        if(isNaN(idx)) return;
        selectPagoByIndex(idx);
      });
      const filtrosBtn = document.getElementById('pagos-filtros-btn');
      filtrosBtn.addEventListener('click', async () => {
        await Promise.all([loadMetodosPago(), loadConceptosPago()]);
        openModal('modal-pagos-filtros');
      });
      document.getElementById('pagos-filtros-close').addEventListener('click', () => closeModal('modal-pagos-filtros'));
      document.getElementById('pagos-filtros-cancelar').addEventListener('click', () => closeModal('modal-pagos-filtros'));
      document.getElementById('pagos-filtros-aplicar').addEventListener('click', () => {
        const metodo = document.getElementById('pagos-metodo').value || '';
        const concepto = document.getElementById('pagos-concepto').value || '';
        state.pagosFilters.metodo = metodo;
        state.pagosFilters.concepto = concepto;
        closeModal('modal-pagos-filtros');
        loadPayments();
      });
      document.getElementById('pagos-clear-selection').addEventListener('click', clearPagoSelection);
      const verUsuarioBtn = document.getElementById('pago-side-ver-usuario');
      if(verUsuarioBtn) verUsuarioBtn.addEventListener('click', navigateToUsuarioDesdePago);
      const verDetalleBtn = document.getElementById('pago-side-ver-detalle');
      if(verDetalleBtn) verDetalleBtn.addEventListener('click', openPagoDetalleModal);
      const exportBtn = document.getElementById('pagos-export-csv');
      if(exportBtn) exportBtn.addEventListener('click', exportPagosCSV);
      const editarPagoBtn = document.getElementById('pago-side-editar');
      if(editarPagoBtn) editarPagoBtn.addEventListener('click', () => {
        const p = state.selectedPago; if(!p) { showToast('Selecciona un pago primero', 'warning', 4000); return; }
        const id = p.id || p.pago_id;
        if(id){
          fetch(`/api/pagos/${id}`, { headers:{ 'Accept':'application/json' } })
            .then(r => r.json())
            .then(data => showPagoForm(data.pago || p))
            .catch(() => showToast('No se pudo cargar el pago', 'error', 4500));
        } else {
          showPagoForm(p);
        }
      });
      const reciboBtn = document.getElementById('pago-side-recibo');
      if(reciboBtn) reciboBtn.addEventListener('click', () => {
        const p = state.selectedPago; if(!p || !(p.id || p.pago_id)) { showToast('Selecciona un pago válido', 'warning', 4000); return; }
        const id = p.id || p.pago_id;
        openReciboPreview(id);
      });
      // Modal recibo preview controls
      const reciboPrevClose = document.getElementById('recibo-preview-close'); if(reciboPrevClose) reciboPrevClose.addEventListener('click', () => closeModal('modal-recibo-preview'));
      const reciboPrevCloseBtn = document.getElementById('recibo-preview-close-btn'); if(reciboPrevCloseBtn) reciboPrevCloseBtn.addEventListener('click', () => closeModal('modal-recibo-preview'));
      const reciboPrevDownload = document.getElementById('recibo-preview-download'); if(reciboPrevDownload) reciboPrevDownload.addEventListener('click', () => {
        const id = state.previewPagoId; if(!id) { showToast('No hay recibo para descargar', 'warning', 3500); return; }
        const params = buildReciboParams();
        const url = `/api/pagos/${id}/recibo.pdf${params.toString() ? ('?' + params.toString()) : ''}`;
        try { window.open(url, '_blank'); } catch(_) { showToast('No se pudo descargar el recibo', 'error', 4500); }
      });
      const reciboPrevConfig = document.getElementById('recibo-preview-config'); if(reciboPrevConfig) reciboPrevConfig.addEventListener('click', async () => {
        await loadReciboConfig();
        openModal('modal-recibo-config');
      });
      const fechaEl = document.getElementById('recibo-preview-fecha'); if(fechaEl){
        const handler = () => updatePeriodoLabel();
        fechaEl.addEventListener('input', handler);
        fechaEl.addEventListener('change', handler);
      }
      const reciboPrevApply = document.getElementById('recibo-preview-apply'); if(reciboPrevApply) reciboPrevApply.addEventListener('click', () => {
        const id = state.previewPagoId; if(!id) { showToast('No hay pago seleccionado', 'warning', 3500); return; }
        const frame = document.getElementById('recibo-preview-frame');
        if(frame){
          const params = buildReciboParams();
          params.set('preview','1');
          const url = `/api/pagos/${id}/recibo.pdf?${params.toString()}#toolbar=0&navpanes=0`;
          frame.src = url;
          try{ attachWheelZoom('recibo-preview-frame-wrap','recibo-preview-frame'); }catch(_){ }
        }
      });
      const itemAddBtn = document.getElementById('recibo-item-add'); if(itemAddBtn) itemAddBtn.addEventListener('click', () => { addItemRow({ descripcion:'', cantidad:1, precio_unitario:0 }); recalcTotalsFromItems(); });
      const comInput = document.getElementById('recibo-total-comision'); if(comInput) comInput.addEventListener('input', recalcTotalsFromItems);
      const eliminarPagoBtn = document.getElementById('pago-side-eliminar');
      if(eliminarPagoBtn) eliminarPagoBtn.addEventListener('click', () => {
        const p = state.selectedPago; if(!p || !(p.id || p.pago_id)) { showToast('Selecciona un pago válido', 'warning', 4000); return; }
        state.deletePagoId = p.id || p.pago_id;
        openModal('modal-pagos-delete');
      });
      const nuevoPagoBtn = document.getElementById('pagos-new');
      if(nuevoPagoBtn) nuevoPagoBtn.addEventListener('click', () => showPagoForm(null));
      const registrarPagoQuick = document.getElementById('usuario-side-registrar');
      if(registrarPagoQuick) registrarPagoQuick.addEventListener('click', () => showPagoForm(null));
      // Modal pago form controls
      const pagoClose = document.getElementById('pago-form-close'); if(pagoClose) pagoClose.addEventListener('click', hidePagoForm);
      const pagoCancel = document.getElementById('pago-form-cancel'); if(pagoCancel) pagoCancel.addEventListener('click', hidePagoForm);
      const pagoSave = document.getElementById('pago-save'); if(pagoSave) pagoSave.addEventListener('click', savePago);
      // Recalcular al cambiar usuario o método de pago
      const uSel = document.getElementById('pago-usuario'); if(uSel) uSel.addEventListener('change', () => recalcPagoTotal());
      const mSel = document.getElementById('pago-metodo'); if(mSel) mSel.addEventListener('change', () => recalcPagoTotal());
      const cSel = document.getElementById('pago-concepto'); if(cSel) cSel.addEventListener('change', () => recalcPagoTotal());
      // Modal delete pago controls
      document.getElementById('pagos-delete-close').addEventListener('click', () => closeModal('modal-pagos-delete'));
      document.getElementById('pagos-delete-cancel').addEventListener('click', () => closeModal('modal-pagos-delete'));
      document.getElementById('pagos-delete-confirm').addEventListener('click', deletePago);
    }

    async function populatePagoUsuarioSelect(selectedId){
      const sel = document.getElementById('pago-usuario');
      if(!sel) return;
      if(!Array.isArray(state.usuarios) || state.usuarios.length === 0){
        await loadUsers();
      }
      const usuarios = Array.isArray(state.usuarios) ? state.usuarios : [];
      sel.innerHTML = '<option value="">Seleccionar usuario</option>' + usuarios.map(u => `<option value="${u.id}">${u.nombre} (${u.dni || ''})</option>`).join('');
      const target = selectedId || (state.selectedUsuario && state.selectedUsuario.id) || '';
      if(target) sel.value = String(target);
    }

    async function populatePagosUsuarioSelector(selectedId){
      const sel = document.getElementById('pagos-usuario');
      if(!sel) return;
      try {
        if(!Array.isArray(state.usuarios) || state.usuarios.length === 0){
          await loadUsers();
        }
        const usuarios = Array.isArray(state.usuarios) ? state.usuarios : [];
        sel.innerHTML = '<option value="">Usuario (opcional)</option>' + usuarios.map(u => `<option value="${u.id}">${u.nombre} (${u.dni || ''})</option>`).join('');
        const target = selectedId || (state.selectedUsuario && state.selectedUsuario.id) || '';
        if(target) sel.value = String(target);
      } catch(e) {}
    }

    async function populatePagoMetodoSelect(selectedId){
      const sel = document.getElementById('pago-metodo'); if(!sel) return;
      try {
        const res = await fetch('/api/metodos_pago', { headers:{ 'Accept':'application/json' } });
        const data = await res.json();
        const items = Array.isArray(data) ? data : (Array.isArray(data.metodos) ? data.metodos : []);
        state.metodosPago = items;
        state.metodosPagoMap = Object.fromEntries(items.map(m => [String(m.id), m]));
        sel.innerHTML = '<option value="">Método de pago (opcional)</option>' + items.map(m => `<option value="${m.id}">${m.nombre}</option>`).join('');
        if(selectedId) sel.value = String(selectedId);
      } catch(e) { console.warn('No se pudieron cargar métodos de pago:', e); }
    }

    async function populatePagoConceptoSelect(selectedId){
      const sel = document.getElementById('pago-concepto'); if(!sel) return;
      try{
        const res = await fetch('/api/conceptos_pago', { headers:{ 'Accept':'application/json' } });
        const data = await res.json();
        const items = Array.isArray(data?.items) ? data.items : (Array.isArray(data) ? data : []);
        state.conceptosPago = items;
        state.conceptosPagoMap = Object.fromEntries(items.map(c => [String(c.id), c]));
        sel.innerHTML = '<option value="">Concepto</option>' + items.map(c => `<option value="${c.id}">${c.nombre}</option>`).join('');
        let target = selectedId || '';
        if(!target){
          const monthly = items.find(c => String(c.nombre||'').trim().toLowerCase() === 'cuota mensual');
          if(monthly) target = String(monthly.id);
        }
        if(target) sel.value = String(target);
      } catch(e){ console.warn('No se pudieron cargar conceptos de pago:', e); }
    }

    // ---- cálculo dinámico de monto según tipo de cuota y comisión ----
    async function ensureMonthlyQuotaConceptVariableActive(){
      try {
        const res = await fetch('/api/conceptos_pago', { headers:{ 'Accept':'application/json' } });
        const conceptos = await res.json();
        const items = Array.isArray(conceptos) ? conceptos : [];
        const existing = items.find(c => String(c.nombre || '').trim().toLowerCase() === 'cuota mensual');
        if(!existing){
          await fetch('/api/conceptos_pago', {
            method:'POST', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' },
            body: JSON.stringify({ nombre: 'Cuota Mensual', descripcion: 'Pago mensual según tipo de cuota del usuario', precio_base: 0, tipo: 'variable', activo: true, categoria: 'cuota' })
          }).catch(()=>null);
        } else if(existing && (String(existing.tipo).toLowerCase() !== 'variable' || existing.activo === false)){
          await fetch(`/api/conceptos_pago/${existing.id}`, {
            method:'PUT', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' },
            body: JSON.stringify({ tipo: 'variable', activo: true })
          }).catch(()=>null);
        }
      } catch(e){ console.warn('No se pudo asegurar concepto Cuota Mensual variable/activo:', e); }
    }

    async function ensureTiposCuotaCatalogo(){
      try{
        if(Array.isArray(state.tiposCuotaCatalogo) && state.tiposCuotaCatalogo.length > 0){ return; }
        const res = await fetch('/api/tipos_cuota_catalogo', { headers:{ 'Accept':'application/json' } });
        const full = await res.json();
        const rows = Array.isArray(full.items) ? full.items : (Array.isArray(full) ? full : []);
        state.tiposCuotaCatalogo = rows;
        state.tiposCuotaCatalogoMap = Object.fromEntries(rows.map(t => [String(t.id ?? t.nombre ?? ''), t]));
      }catch(e){ console.warn('No se pudo cargar catálogo de tipos de cuota:', e); }
    }

    function resolveTipoCuota(val){
      if(val == null) return null;
      const sv = String(val).trim();
      if(!sv) return null;
      const activos = Array.isArray(state.tiposCuotaActivos) ? state.tiposCuotaActivos : [];
      let tipo = null;
      if(/^[0-9]+$/.test(sv)){
        tipo = activos.find(t => String(t.id) === sv);
      }
      if(!tipo){
        tipo = activos.find(t => String(t.nombre || '').trim().toLowerCase() === sv.toLowerCase());
      }
      if(tipo) return tipo;
      const catalogo = Array.isArray(state.tiposCuotaCatalogo) ? state.tiposCuotaCatalogo : [];
      if(/^[0-9]+$/.test(sv)){
        tipo = catalogo.find(t => String(t.id) === sv);
      }
      if(!tipo){
        tipo = catalogo.find(t => String(t.nombre || '').trim().toLowerCase() === sv.toLowerCase());
      }
      return tipo || null;
    }

    function round2(v){ const n = Number(v) || 0; return Math.round(n * 100) / 100; }

    function updatePagoResumen({ conceptoNombre, base, pct, comision, total }){
      const elConcepto = document.getElementById('pago-resumen-concepto'); if(elConcepto) elConcepto.textContent = conceptoNombre || 'Cuota Mensual';
      const elBase = document.getElementById('pago-resumen-base'); if(elBase) elBase.textContent = (base != null ? round2(base).toFixed(2) : '—');
      const elCom = document.getElementById('pago-resumen-comision'); if(elCom) elCom.textContent = (comision != null ? round2(comision).toFixed(2) : '—');
      const elPct = document.getElementById('pago-resumen-comision-porcentaje'); if(elPct) elPct.textContent = (pct ? `(${round2(pct)}%)` : '');
      const elTot = document.getElementById('pago-resumen-total'); if(elTot) elTot.textContent = (total != null ? round2(total).toFixed(2) : '—');
    }

    async function recalcPagoTotal(){
      try{
        await ensureMonthlyQuotaConceptVariableActive();
        if(!Array.isArray(state.tiposCuotaActivos) || state.tiposCuotaActivos.length === 0){
          await loadTiposCuotaActivos();
        }
        await ensureTiposCuotaCatalogo();
        const usuarioEl = document.getElementById('pago-usuario');
        const metodoEl = document.getElementById('pago-metodo');
        const conceptoEl = document.getElementById('pago-concepto');
        const montoEl = document.getElementById('pago-monto');
        const uid = usuarioEl && usuarioEl.value ? Number(usuarioEl.value) : null;
        const conceptoId = conceptoEl && conceptoEl.value ? String(conceptoEl.value) : '';
        const concepto = conceptoId ? (state.conceptosPagoMap ? state.conceptosPagoMap[conceptoId] : null) : null;
        let base = 0; let conceptoNombre = 'Cuota Mensual';
        if(concepto){ conceptoNombre = concepto.nombre || conceptoNombre; }
        if(uid){
          const u = (state.usuarios || []).find(x => Number(x.id) === uid);
          const tipoVal = u ? (u.tipo_cuota ?? null) : null;
          const tipoObj = resolveTipoCuota(tipoVal);
          if(concepto && String(concepto.nombre||'').trim().toLowerCase() === 'cuota mensual'){
            base = tipoObj ? Number(tipoObj.precio ?? tipoObj.precio_base ?? 0) : 0;
          } else {
            base = concepto ? Number(concepto.precio_base ?? 0) : (tipoObj ? Number(tipoObj.precio ?? tipoObj.precio_base ?? 0) : 0);
          }
        } else {
          base = concepto ? Number(concepto.precio_base ?? 0) : 0;
        }
        const metodoId = metodoEl && metodoEl.value ? String(metodoEl.value) : '';
        const metodo = metodoId ? (state.metodosPagoMap ? state.metodosPagoMap[metodoId] : null) : null;
        const pct = metodo ? Number(metodo.comision_porcentaje ?? metodo.comision ?? 0) : 0;
        const comision = round2(base * pct / 100);
        const total = round2(base + comision);
        if(montoEl){ montoEl.value = total > 0 ? String(total) : ''; }
        updatePagoResumen({ conceptoNombre, base, pct, comision, total });
      } catch(e){ console.warn('No se pudo recalcular el total del pago:', e); }
    }

    function resetPagoForm(){
      const f = document.getElementById('pago-fecha'); if(f) f.value = '';
      const m = document.getElementById('pago-mes'); if(m) m.value = '';
      const a = document.getElementById('pago-año'); if(a) a.value = '';
      const monto = document.getElementById('pago-monto'); if(monto) monto.value = '';
      const u = document.getElementById('pago-usuario'); if(u) u.value = '';
      const mp = document.getElementById('pago-metodo'); if(mp) mp.value = '';
      const cp = document.getElementById('pago-concepto'); if(cp) cp.value = '';
    }

    async function showPagoForm(p){
      editingPagoId = null;
      resetPagoForm();
      const titleEl = document.getElementById('pago-form-title');
      const now = new Date();
      await populatePagoUsuarioSelect(p && (p.usuario_id || (p.usuario && p.usuario.id)));
      await populatePagoMetodoSelect(p && (p.metodo_pago_id || p.metodo_id));
      await populatePagoConceptoSelect(p && p.concepto_id ? p.concepto_id : null);
      if(p && (p.id || p.pago_id)){
        editingPagoId = p.id || p.pago_id;
        if(titleEl) titleEl.textContent = `Editar pago #${editingPagoId}`;
        const montoEl = document.getElementById('pago-monto'); if(montoEl) montoEl.value = (p.monto != null ? p.monto : '');
        const fechaSrc = p.fecha_pago || p.fecha || p.fechaPago || null;
        const fechaEl = document.getElementById('pago-fecha'); if(fechaEl) fechaEl.value = fechaSrc ? fmtDate(fechaSrc) : '';
        const mesEl = document.getElementById('pago-mes'); const añoEl = document.getElementById('pago-año');
        if(mesEl && añoEl){
          const dt = fechaSrc ? new Date(fechaSrc) : now;
          mesEl.value = String(dt.getMonth()+1);
          añoEl.value = String(dt.getFullYear());
        }
        const uSel = document.getElementById('pago-usuario'); if(uSel && (p.usuario_id || (p.usuario && p.usuario.id))) uSel.value = String(p.usuario_id || (p.usuario && p.usuario.id));
        const mpSel = document.getElementById('pago-metodo'); if(mpSel && (p.metodo_pago_id || p.metodo_id)) mpSel.value = String(p.metodo_pago_id || p.metodo_id);
      } else {
        if(titleEl) titleEl.textContent = 'Registrar pago';
        const mesEl = document.getElementById('pago-mes'); const añoEl = document.getElementById('pago-año');
        if(mesEl) mesEl.value = String(now.getMonth()+1);
        if(añoEl) añoEl.value = String(now.getFullYear());
        const uSel = document.getElementById('pago-usuario'); if(uSel && state.selectedUsuario && state.selectedUsuario.id) uSel.value = String(state.selectedUsuario.id);
      }
      await recalcPagoTotal();
      openModal('modal-pago-form');
    }

    function hidePagoForm(){
      editingPagoId = null;
      closeModal('modal-pago-form');
    }

    async function savePago(){
      const usuarioEl = document.getElementById('pago-usuario');
      const montoEl = document.getElementById('pago-monto');
      const fechaEl = document.getElementById('pago-fecha');
      const mesEl = document.getElementById('pago-mes');
      const añoEl = document.getElementById('pago-año');
      const metodoEl = document.getElementById('pago-metodo');
      const usuario_id = usuarioEl && usuarioEl.value ? Number(usuarioEl.value) : null;
      const monto = montoEl && montoEl.value ? Number(montoEl.value) : null;
      const fecha_str = fechaEl && fechaEl.value ? fechaEl.value : null;
      let mes = mesEl && mesEl.value ? Number(mesEl.value) : null;
      let año = añoEl && añoEl.value ? Number(añoEl.value) : null;
      const metodo_pago_id = metodoEl && metodoEl.value ? Number(metodoEl.value) : null;
      if(!usuario_id || !monto){ showToast('Usuario y monto son obligatorios', 'warning', 4000); return; }
      let url = '/api/pagos'; let method = 'POST'; let body = {};
      const conceptoEl = document.getElementById('pago-concepto');
      const conceptoIdRaw = conceptoEl && conceptoEl.value ? String(conceptoEl.value) : '';
      const conceptoSel = conceptoIdRaw ? (state.conceptosPagoMap ? state.conceptosPagoMap[conceptoIdRaw] : null) : null;
      if(editingPagoId){
        url = `/api/pagos/${editingPagoId}`; method = 'PUT'; body = { usuario_id, monto, metodo_pago_id };
        if(fecha_str && fecha_str.trim()){ body['fecha_pago'] = fecha_str; }
        else if(mes != null && año != null){ body['mes'] = mes; body['año'] = año; }
      } else {
        // Crear pago avanzado con conceptos + fecha/mes-año
        let concepto_id_final = conceptoSel ? Number(conceptoSel.id) : null;
        if(!concepto_id_final){
          const items = Array.isArray(state.conceptosPago) ? state.conceptosPago : [];
          const monthly = items.find(c => String(c.nombre||'').trim().toLowerCase() === 'cuota mensual');
          if(monthly) concepto_id_final = Number(monthly.id);
        }
        // Determinar precio unitario según concepto (variable para cuota mensual)
        let precio_unitario = 0;
        const u = (state.usuarios || []).find(x => Number(x.id) === usuario_id);
        const tipoVal = u ? (u.tipo_cuota ?? null) : null;
        const tipoObj = resolveTipoCuota(tipoVal);
        if(conceptoSel && String(conceptoSel.nombre||'').trim().toLowerCase() === 'cuota mensual'){
          precio_unitario = tipoObj ? Number(tipoObj.precio ?? tipoObj.precio_base ?? 0) : 0;
        } else {
          precio_unitario = conceptoSel ? Number(conceptoSel.precio_base ?? 0) : (tipoObj ? Number(tipoObj.precio ?? tipoObj.precio_base ?? 0) : 0);
        }
        const conceptos = concepto_id_final ? [{ concepto_id: concepto_id_final, cantidad: 1, precio_unitario }] : [];
        body = { usuario_id, metodo_pago_id, conceptos };
        if(fecha_str && fecha_str.trim()){ body['fecha_pago'] = fecha_str; }
        else {
          if(!mes || !año){ const now = new Date(); mes = now.getMonth()+1; año = now.getFullYear(); }
          body['mes'] = mes; body['año'] = año;
        }
      }
      try{
        const res = await fetch(url, { method, headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(body) });
        if(!res.ok){ const err = await res.json().catch(()=>({})); showToast(err.detail || err.error || 'Error al guardar el pago', 'error', 4500); return; }
        await res.json().catch(()=>null);
        hidePagoForm();
        await loadPayments();
      } catch(e){ showToast('Error de red al guardar', 'error', 4500); }
    }

    async function deletePago(){
      const id = state.deletePagoId; if(!id){ closeModal('modal-pagos-delete'); return; }
      try{
        const res = await fetch(`/api/pagos/${id}`, { method:'DELETE', headers:{ 'Accept':'application/json' } });
        if(!res.ok){ const err = await res.json().catch(()=>({})); showToast(err.detail || err.error || 'No se pudo eliminar el pago', 'error', 4500); return; }
        await res.json().catch(()=>null);
        closeModal('modal-pagos-delete');
        if(state.selectedPago && (state.selectedPago.id === id || state.selectedPago.pago_id === id)) clearPagoSelection();
        await loadPayments();
      } catch(e){ showToast('Error de red al eliminar', 'error', 4500); }
    }

    function exportPagosCSV(){
      const items = Array.isArray(state.pagos) ? state.pagos : [];
      const headers = ['Fecha','Usuario','DNI','Método','Concepto','Monto'];
      const rows = items.map(p => [
        (p.fecha_pago || p.fecha || p.fechaPago) ? fmtDate(p.fecha_pago || p.fecha || p.fechaPago) : '',
        String(p.usuario_nombre || p.nombre || ''),
        String(p.dni || ''),
        String(p.metodo_pago || p.metodo || ''),
        String(p.concepto_pago || p.concepto || ''),
        String(p.monto != null ? p.monto : '')
      ]);
      const csv = [headers.join(','), ...rows.map(cols => cols.map(v => {
        const s = String(v ?? '');
        return /[",\n]/.test(s) ? '"' + s.replace(/"/g,'""') + '"' : s;
      }).join(','))].join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'pagos.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function renderUsuarioSide(u, historial){
      const estado = (u.activo === true || u.activo === 'true') ? 'Activo' : 'Inactivo';
      document.getElementById('usuario-side-estado').textContent = estado;
      const venc = u.fecha_proximo_vencimiento || u.proximo_vencimiento || null;
      document.getElementById('usuario-side-vencimiento').textContent = venc ? fmtDate(venc) : '—';
      document.getElementById('usuario-side-cuotas-vencidas').textContent = (u.cuotas_vencidas != null ? u.cuotas_vencidas : '—');
      document.getElementById('usuario-side-nombre').textContent = u.nombre || '';
      document.getElementById('usuario-side-dni').textContent = u.dni || '';
      document.getElementById('usuario-side-telefono').textContent = u.telefono || '';
      document.getElementById('usuario-side-rol').textContent = (u.rol || '').toString().toLowerCase();
      const tipoObj = resolveTipoCuota(u.tipo_cuota);
      document.getElementById('usuario-side-tipo-cuota').textContent = tipoObj ? (tipoObj.nombre ?? String(tipoObj.id ?? '')) : (u.tipo_cuota ?? '');
      const up = u.ultimo_pago || u.fecha_ultimo_pago || null;
      document.getElementById('usuario-side-ultimo-pago').textContent = up ? fmtDate(up) : '—';
      const notasTextarea = document.getElementById('usuario-notas-textarea');
      if(notasTextarea) notasTextarea.value = (u.notas && String(u.notas).trim()) ? String(u.notas) : '';
      const tbody = document.querySelector('#usuario-historial-table tbody');
      if(tbody){
        tbody.innerHTML = '';
        (Array.isArray(historial) ? historial : []).forEach(p => {
          const tr = document.createElement('tr');
          const fecha = p.fecha_pago || p.fecha || p.fechaPago || null;
          const metodo = p.metodo_pago || p.metodo || '';
          const concepto = p.concepto_pago || p.concepto || '';
          const monto = p.monto != null ? p.monto : '';
          tr.innerHTML = `<td>${fecha ? fmtDate(fecha) : ''}</td><td>${metodo}</td><td>${concepto}</td><td>${monto}</td>`;
          tbody.appendChild(tr);
        });
      }
    }

    async function selectUsuarioByIndex(idx){
      const u = (state.usuarios || [])[idx];
      if(!u) return;
      state.selectedUsuario = u;
      const id = u.id || null;
      document.getElementById('usuario-side-empty').style.display = 'none';
      document.getElementById('usuario-side').style.display = 'block';
      document.getElementById('usuario-side-id').textContent = id ? `#${id}` : '';
      const btnQR = document.getElementById('usuario-side-qr'); if(btnQR) btnQR.disabled = false;
      const btnAsis = document.getElementById('usuario-side-asistencia'); if(btnAsis) btnAsis.disabled = false;
      const loader = document.getElementById('usuario-side-loader'); if(loader) loader.classList.add('active');
      try {
        const [detRes, histRes] = await Promise.all([
          id ? fetch(`/api/usuarios/${id}`, { headers: { 'Accept': 'application/json' } }) : Promise.resolve(null),
          id ? fetch(`/api/usuarios/${id}/pagos?limit=50&offset=0`, { headers: { 'Accept': 'application/json' } }) : Promise.resolve(null),
        ]);
        const det = detRes ? await detRes.json() : u;
        const histJson = histRes ? await histRes.json() : [];
        const historial = Array.isArray(histJson.items) ? histJson.items : (Array.isArray(histJson) ? histJson : []);
        state.usuarioHistorial = historial;
        // Asegurar tipos de cuota cargados para resolver nombre
        if(!Array.isArray(state.tiposCuotaActivos) || state.tiposCuotaActivos.length === 0){ await loadTiposCuotaActivos(); }
        try { await ensureTiposCuotaCatalogo(); } catch {}
        renderUsuarioSide(det || u, historial);
        if(id){ try { await loadUsuarioEtiquetas(id); await loadUsuarioEstados(id); } catch(_){} }
        let recent = '—';
        let hasHoy = false;
        if(id){
          try{
            const aRes = await fetch(`/api/usuario_asistencias?usuario_id=${id}&limit=200&offset=0`, { headers: { 'Accept': 'application/json' } });
            const aData = await aRes.json();
            const arr = Array.isArray(aData) ? aData : (Array.isArray(aData?.items) ? aData.items : []);
            state.usuarioAsistencias = arr;
            const now = new Date(); const start = new Date(now); start.setDate(now.getDate()-30);
            recent = arr.filter(a => { const d = new Date(a.fecha||''); return !isNaN(d.getTime()) && d >= start && d <= now; }).length;
            const todayStr = fmtDate(new Date());
            hasHoy = arr.some(a => { const f = a.fecha || a.fecha_asistencia || a.fechaAsistencia || ''; return fmtDate(f) === todayStr; });
          }catch(_){ state.usuarioAsistencias = []; }
        }
        const asEl = document.getElementById('usuario-side-asistencias-recientes'); if(asEl) asEl.textContent = recent === '—' ? '—' : String(recent);
        const asBtn = document.getElementById('usuario-side-asistencia'); if(asBtn) asBtn.textContent = hasHoy ? 'Eliminar asistencia de hoy' : 'Registrar asistencia';
        const utbody = document.querySelector('#usuarios-table tbody'); if(utbody){ utbody.querySelectorAll('tr').forEach(t => t.classList.remove('selected')); const tr = utbody.querySelector(`tr[data-index="${idx}"]`); if(tr) tr.classList.add('selected'); }
      } catch(e){
        console.warn('No se pudo cargar detalles/historial del usuario:', e);
        renderUsuarioSide(u, []);
      } finally { if(loader) loader.classList.remove('active'); }
    }

    function clearUsuarioSelection(){
      state.selectedUsuario = null;
      document.getElementById('usuario-side-id').textContent = '';
      document.getElementById('usuario-side').style.display = 'none';
      document.getElementById('usuario-side-empty').style.display = 'block';
      const btnQR = document.getElementById('usuario-side-qr'); if(btnQR) btnQR.disabled = true;
      const btnAsis = document.getElementById('usuario-side-asistencia'); if(btnAsis) btnAsis.disabled = true;
      const tbody = document.querySelector('#usuario-historial-table tbody');
      if(tbody) tbody.innerHTML = '';
    }

    function bindUsuariosEvents(){
      const tbody = document.querySelector('#usuarios-table tbody');
      tbody.addEventListener('click', (ev) => {
        const btn = ev.target.closest('button');
        if(btn){
          const id = btn.getAttribute('data-id');
          const action = btn.getAttribute('data-action');
          if(action === 'edit'){
            fetch(`/api/usuarios/${id}`, { headers:{ 'Accept':'application/json' } })
              .then(r => r.json())
              .then(u => showUserForm(u))
              .catch(() => showToast('No se pudo cargar el usuario', 'error', 4500));
          } else if(action === 'delete'){
            state.deleteUserId = id;
            openModal('modal-usuarios-delete');
          }
          return;
        }
        const tr = ev.target.closest('tr');
        if(!tr) return;
        const idx = parseInt(tr.getAttribute('data-index') || 'NaN', 10);
        if(isNaN(idx)) return;
        selectUsuarioByIndex(idx);
      });
      document.getElementById('usuarios-clear-selection').addEventListener('click', clearUsuarioSelection);
      document.getElementById('usuarios-refresh').addEventListener('click', loadUsers);
      document.getElementById('usuarios-q').addEventListener('keydown', (e) => { if(e.key === 'Enter') loadUsers(); });
      document.getElementById('usuarios-new').addEventListener('click', () => showUserForm(null));
      document.getElementById('usuarios-save').addEventListener('click', saveUser);
      document.getElementById('usuarios-cancel').addEventListener('click', hideUserForm);
      document.getElementById('usuarios-modal-close').addEventListener('click', hideUserForm);
      document.getElementById('usuarios-delete-close').addEventListener('click', () => closeModal('modal-usuarios-delete'));
      document.getElementById('usuarios-delete-cancel').addEventListener('click', () => closeModal('modal-usuarios-delete'));
      document.getElementById('usuarios-delete-confirm').addEventListener('click', async () => {
        const id = state.deleteUserId;
        state.deleteUserId = null;
        closeModal('modal-usuarios-delete');
        await deleteUser(id);
      });
      const editarQuick = document.getElementById('usuario-side-editar');
      if(editarQuick){ editarQuick.addEventListener('click', () => { const u = state.selectedUsuario; if(u) showUserForm(u); }); }
      const eliminarQuick = document.getElementById('usuario-side-eliminar');
      if(eliminarQuick){ eliminarQuick.addEventListener('click', () => { const u = state.selectedUsuario; if(!u || !u.id) return; state.deleteUserId = u.id; openModal('modal-usuarios-delete'); }); }
      const verPagosQuick = document.getElementById('usuario-side-ver-pagos');
      if(verPagosQuick) verPagosQuick.addEventListener('click', verPagosDeUsuario);
      const toggleActivoQuick = document.getElementById('usuario-side-toggle-activo');
      if(toggleActivoQuick) toggleActivoQuick.addEventListener('click', toggleUsuarioActivo);
      const exportUsuariosBtn = document.getElementById('usuarios-export-csv');
      if(exportUsuariosBtn) exportUsuariosBtn.addEventListener('click', exportUsuariosCSV);
      const qrBtn = document.getElementById('usuario-side-qr');
      if(qrBtn) qrBtn.addEventListener('click', emitirQRCheckin);
      const asisBtn = document.getElementById('usuario-side-asistencia');
      if(asisBtn) asisBtn.addEventListener('click', handleAsistenciaClick);
      const qrCloseBtn = document.getElementById('qr-close-btn');
      if(qrCloseBtn) qrCloseBtn.addEventListener('click', closeQRModal);
      const qrCloseFooter = document.getElementById('qr-close-footer');
      if(qrCloseFooter) qrCloseFooter.addEventListener('click', closeQRModal);
      // Subpestañas y acciones de usuario
      const tabs = document.querySelectorAll('#usuario-tabs button');
      tabs.forEach(btn => btn.addEventListener('click', () => {
        const tab = btn.getAttribute('data-tab');
        document.querySelectorAll('#usuario-tabs button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('#usuario-tab-notas, #usuario-tab-etiquetas, #usuario-tab-estados').forEach(panel => {
          panel.style.display = panel.id === `usuario-tab-${tab}` ? 'block' : 'none';
        });
        if(tab === 'notas'){ document.getElementById('usuario-notas-textarea')?.focus(); }
        if(tab === 'etiquetas'){ document.getElementById('usuario-etiqueta-input')?.focus(); }
        if(tab === 'estados'){ document.getElementById('usuario-estado-template')?.focus(); }
      }));
      document.addEventListener('keydown', (ev) => {
        if((ev.ctrlKey || ev.metaKey) && ev.key.toLowerCase() === 'f'){
          ev.preventDefault();
          const active = document.querySelector('#usuario-tabs button.active')?.getAttribute('data-tab');
          if(active === 'etiquetas'){ document.getElementById('usuario-etiqueta-filter')?.focus(); }
          else if(active === 'estados'){ document.getElementById('usuario-estados-filter')?.focus(); }
          else { document.getElementById('usuario-notas-textarea')?.focus(); }
        }
      });
      const notasSave = document.getElementById('usuario-notas-save');
      if(notasSave){ notasSave.addEventListener('click', saveUsuarioNotas); }
      const notasTextarea = document.getElementById('usuario-notas-textarea');
      const notasCounter = document.getElementById('usuario-notas-counter');
      const notasStatus = document.getElementById('usuario-notas-status');
      if(notasTextarea){
        const updateCounter = () => { if(notasCounter) notasCounter.textContent = `${notasTextarea.value.length} caracteres`; };
        updateCounter();
        let notasSaveTimer = null;
        notasTextarea.addEventListener('input', () => {
          updateCounter();
          if(notasStatus) notasStatus.textContent = 'Editado';
          if(notasSaveTimer) clearTimeout(notasSaveTimer);
          notasSaveTimer = setTimeout(() => { try { saveUsuarioNotas(); } catch(_){} }, 1200);
        });
        notasTextarea.addEventListener('keydown', (ev) => {
          if((ev.ctrlKey || ev.metaKey) && ev.key.toLowerCase() === 's'){
            ev.preventDefault();
            if(notasSaveTimer) clearTimeout(notasSaveTimer);
            saveUsuarioNotas();
          }
        });
      }
      const etiquetaAdd = document.getElementById('usuario-etiqueta-add');
      if(etiquetaAdd){ etiquetaAdd.addEventListener('click', addUsuarioEtiqueta); }
      const etiquetaInput = document.getElementById('usuario-etiqueta-input');
      const etiquetaFilter = document.getElementById('usuario-etiqueta-filter');
      const etiquetaSuggests = document.getElementById('usuario-etiqueta-suggests');
      if(etiquetaInput){
        etiquetaInput.addEventListener('keydown', (ev) => { if(ev.key === 'Enter'){ ev.preventDefault(); addUsuarioEtiqueta(); } });
        etiquetaInput.addEventListener('input', () => { renderEtiquetaSuggests(etiquetaInput.value); });
      }
      if(etiquetaFilter){
        etiquetaFilter.addEventListener('input', renderUsuarioEtiquetas);
        etiquetaFilter.addEventListener('keydown', (ev) => { if(ev.key==='Escape'){ ev.preventDefault(); etiquetaFilter.value=''; renderUsuarioEtiquetas(); } });
      }
      const etiquetaFilterClear = document.getElementById('usuario-etiqueta-filter-clear');
      if(etiquetaFilterClear){ etiquetaFilterClear.addEventListener('click', () => { if(etiquetaFilter) etiquetaFilter.value=''; renderUsuarioEtiquetas(); }); }
      if(etiquetaSuggests){
        etiquetaSuggests.addEventListener('click', (ev) => {
          const chip = ev.target.closest('.chip[data-suggest]');
          if(!chip) return;
          const name = chip.getAttribute('data-suggest');
          const inp = document.getElementById('usuario-etiqueta-input');
          if(inp) inp.value = name;
          addUsuarioEtiqueta();
        });
      }
      const etiquetasList = document.getElementById('usuario-etiquetas-list');
      if(etiquetasList){
        etiquetasList.addEventListener('click', (ev) => {
          const btn = ev.target.closest('button[data-action="remove"]');
          if(!btn) return;
          const eid = parseInt(btn.getAttribute('data-id')||'NaN',10);
          const u = state.selectedUsuario; if(!u || !u.id || isNaN(eid)) return;
          if(!confirm('¿Quitar etiqueta?')) return;
          removeUsuarioEtiqueta(u.id, eid);
        });
      }
      const estadoAdd = document.getElementById('usuario-estado-add');
      if(estadoAdd){ estadoAdd.addEventListener('click', addUsuarioEstado); }
      const estadoDesc = document.getElementById('usuario-estado-descripcion');
      const estadoVenc = document.getElementById('usuario-estado-vencimiento');
      if(estadoDesc){ estadoDesc.addEventListener('keydown', (ev) => { if(ev.key==='Enter'){ ev.preventDefault(); addUsuarioEstado(); } }); }
      if(estadoVenc){ estadoVenc.addEventListener('keydown', (ev) => { if(ev.key==='Enter'){ ev.preventDefault(); addUsuarioEstado(); } }); }
      const estadosList = document.getElementById('usuario-estados-list');
      if(estadosList){
        estadosList.addEventListener('click', (ev) => {
          const btn = ev.target.closest('button[data-action="remove"]');
          if(!btn) return;
          const sid = parseInt(btn.getAttribute('data-id')||'NaN',10);
          const u = state.selectedUsuario; if(!u || !u.id || isNaN(sid)) return;
          if(!confirm('¿Eliminar estado?')) return;
          deleteUsuarioEstado(u.id, sid);
        });
      }
      const estadosFilter = document.getElementById('usuario-estados-filter');
      const estadosExpiredToggle = document.getElementById('usuario-estados-show-expired');
      if(estadosFilter){
        estadosFilter.addEventListener('input', renderUsuarioEstados);
        estadosFilter.addEventListener('keydown', (ev) => { if(ev.key==='Escape'){ ev.preventDefault(); estadosFilter.value=''; renderUsuarioEstados(); } });
      }
      const estadosFilterClear = document.getElementById('usuario-estados-filter-clear');
      if(estadosFilterClear){ estadosFilterClear.addEventListener('click', () => { if(estadosFilter) estadosFilter.value=''; renderUsuarioEstados(); }); }
      if(estadosExpiredToggle){ estadosExpiredToggle.addEventListener('change', renderUsuarioEstados); }
    }

    function verPagosDeUsuario(){
      const u = state.selectedUsuario;
      if(!u){ showToast('Selecciona un usuario primero', 'warning', 4000); return; }
      const dni = String(u.dni || '').trim();
      switchTab('pagos');
      try { populatePagosUsuarioSelector(); } catch {}
      const sel = document.getElementById('pagos-usuario');
      if(sel) sel.value = String(u.id);
      const input = document.getElementById('pagos-q');
      if(input) input.value = dni || (u.nombre || '');
      state.pagosFilters.metodo = '';
      state.pagosFilters.concepto = '';
      loadPayments();
    }

    function toggleUsuarioActivo(){
      const u = state.selectedUsuario;
      if(!u || !u.id){ showToast('Selecciona un usuario válido', 'warning', 3500); return; }
      const nombre = (document.getElementById('usuario-side-nombre').textContent || '').trim().toUpperCase();
      const dni = (document.getElementById('usuario-side-dni').textContent || '').trim();
      const telefono = (document.getElementById('usuario-side-telefono').textContent || '').trim();
      const rol = (document.getElementById('usuario-side-rol').textContent || '').trim().toLowerCase() || 'socio';
      const tipo_cuota_text = (document.getElementById('usuario-side-tipo-cuota').textContent || '').trim();
      const tipo_cuota = tipo_cuota_text || null;
      const notasText = (document.getElementById('usuario-notas-textarea')?.value || '').trim();
      const notas = notasText ? notasText : null;
      if(!nombre || !dni){ showToast('Nombre y DNI son obligatorios', 'warning', 3000); return; }
      const nuevoActivo = !(u.activo === true || u.activo === 'true');
      const payload = { nombre, dni, telefono: telefono || null, pin: null, rol, activo: nuevoActivo, tipo_cuota, notas };
      fetch(`/api/usuarios/${u.id}`, { method:'PUT', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(payload) })
        .then(async res => { if(!res.ok){ const err = await res.json().catch(() => ({})); throw new Error(err.detail || err.error || `Error ${res.status}`); } return res; })
        .then(async () => { await loadUsers(); const idx = (state.usuarios || []).findIndex(x => x.id === u.id); if(idx >= 0) selectUsuarioByIndex(idx); })
        .catch(e => showToast(`No se pudo actualizar estado: ${e.message}`, 'error', 4500));
    }

    function exportUsuariosCSV(){
      const items = Array.isArray(state.usuarios) ? state.usuarios : [];
      const headers = ['Nombre','DNI','Teléfono','Rol','TipoCuota','Activo'];
      const rows = items.map(u => [
        String(u.nombre || '').trim(),
        String(u.dni || ''),
        String(u.telefono || ''),
        String((u.rol || '').toString().toLowerCase()),
        String(u.tipo_cuota ?? ''),
        String((u.activo === true || u.activo === 'true') ? 'SI' : 'NO')
      ]);
      const csv = [headers.join(','), ...rows.map(cols => cols.map(v => {
        const s = String(v ?? '');
        return /[",\n]/.test(s) ? '"' + s.replace(/"/g,'""') + '"' : s;
      }).join(','))].join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'usuarios.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // --- Subpestañas Usuarios: Notas, Etiquetas y Estados ---
    async function loadUsuarioEtiquetas(usuario_id){
      const cont = document.getElementById('usuario-etiquetas-list');
      const empty = document.getElementById('usuario-etiquetas-empty');
      if(cont) cont.innerHTML = '';
      try{
        const res = await fetch(`/api/usuarios/${usuario_id}/etiquetas`, { headers:{ 'Accept':'application/json' } });
        const data = await res.json();
        const items = Array.isArray(data.items) ? data.items : (Array.isArray(data) ? data : []);
        state.usuarioEtiquetas = items;
        const names = items.map(e => String(e.nombre || '').trim()).filter(Boolean);
        state.tagsSuggest = Array.from(new Set([...(state.tagsSuggest || []), ...names]));
        renderUsuarioEtiquetas();
        if(empty) empty.style.display = items.length ? 'none' : 'block';
      }catch(e){ /* silencioso */ }
    }
    function renderUsuarioEtiquetas(){
      const cont = document.getElementById('usuario-etiquetas-list'); if(!cont) return;
      const qRaw = (document.getElementById('usuario-etiqueta-filter')?.value || '').trim();
      const q = qRaw.toLowerCase();
      const esc = (s) => s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
      const hl = (text, q) => {
        if(!q) return esc(text);
        const idx = text.toLowerCase().indexOf(q.toLowerCase());
        if(idx === -1) return esc(text);
        const before = esc(text.slice(0, idx));
        const match = esc(text.slice(idx, idx + q.length));
        const after = esc(text.slice(idx + q.length));
        return `${before}<span class="hl">${match}</span>${after}`;
      };
      cont.innerHTML = '';
      (state.usuarioEtiquetas || []).forEach(e => {
        const name = String(e.nombre || '').trim();
        if(q && !name.toLowerCase().includes(q)) return;
        const span = document.createElement('span');
        span.className = 'chip';
        if(e.color) span.style.backgroundColor = e.color;
        const nameHTML = hl(name, qRaw);
        span.innerHTML = `${nameHTML}<button class="chip-remove" data-action="remove" data-id="${e.id}" title="Quitar">×</button>`;
        cont.appendChild(span);
      });
    }
    function renderEtiquetaSuggests(prefix){
      const cont = document.getElementById('usuario-etiqueta-suggests'); if(!cont) return;
      const list = (state.tagsSuggest || []).filter(n => n && (!prefix || n.toLowerCase().startsWith(prefix.toLowerCase())));
      cont.innerHTML = list.slice(0,8).map(n => `<span class="chip" data-suggest="${n}">${n}</span>`).join('');
      cont.style.display = list.length ? 'flex' : 'none';
    }
    async function removeUsuarioEtiqueta(usuario_id, etiqueta_id){
      try{
        const res = await fetch(`/api/usuarios/${usuario_id}/etiquetas/${etiqueta_id}`, { method:'DELETE', headers:{ 'Accept':'application/json' } });
        if(!res.ok){ const err = await res.json().catch(()=>({})); showToast(err.detail || err.error || 'No se pudo quitar la etiqueta', 'error', 4500); return; }
        await res.json().catch(()=>null);
        await loadUsuarioEtiquetas(usuario_id);
      }catch(e){ showToast('Error de red al quitar etiqueta', 'error', 4500); }
    }
    async function addUsuarioEtiqueta(){
      const u = state.selectedUsuario;
      if(!u || !u.id){ showToast('Selecciona un usuario válido', 'warning', 3500); return; }
      const nombre = (document.getElementById('usuario-etiqueta-input').value || '').trim();
      if(!nombre){ showToast('Ingrese el nombre de la etiqueta', 'warning', 3000); return; }
      try{
        const res = await fetch(`/api/usuarios/${u.id}/etiquetas`, { method:'POST', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify({ nombre }) });
        if(!res.ok){ const err = await res.json().catch(()=>({})); showToast(err.detail || err.error || 'No se pudo añadir la etiqueta', 'error', 4500); return; }
        await res.json().catch(()=>null);
        document.getElementById('usuario-etiqueta-input').value = '';
        await loadUsuarioEtiquetas(u.id);
      }catch(e){ showToast('Error de red al añadir etiqueta', 'error', 4500); }
    }

    async function loadEstadoPlantillas(){
      const sel = document.getElementById('usuario-estado-template');
      if(!sel) return;
      try{
        const res = await fetch('/api/estados/plantillas', { headers:{ 'Accept':'application/json' } });
        const data = await res.json();
        const items = Array.isArray(data.items) ? data.items : (Array.isArray(data) ? data : []);
        state.estadoPlantillas = items;
        state.estadoPlantillasMap = {};
        items.forEach(p => { if(p && p.nombre) state.estadoPlantillasMap[p.nombre] = p; });
        sel.innerHTML = '<option value="">Seleccione estado…</option>' + items.map(p => `<option value="${p.nombre}">${p.nombre}</option>`).join('');
      }catch(e){ sel.innerHTML = '<option value="">Seleccione estado…</option>'; }
    }
    async function loadUsuarioEstados(usuario_id){
      const cont = document.getElementById('usuario-estados-list');
      const empty = document.getElementById('usuario-estados-empty');
      if(cont) cont.innerHTML = '';
      try{
        const res = await fetch(`/api/usuarios/${usuario_id}/estados`, { headers:{ 'Accept':'application/json' } });
        const data = await res.json();
        const items = Array.isArray(data.items) ? data.items : (Array.isArray(data) ? data : []);
        state.usuarioEstados = items;
        renderUsuarioEstados();
        if(empty) empty.style.display = items.length ? 'none' : 'block';
      }catch(e){ /* silencioso */ }
    }
    function renderUsuarioEstados(){
      const cont = document.getElementById('usuario-estados-list'); if(!cont) return;
      const qRaw = (document.getElementById('usuario-estados-filter')?.value || '').trim();
      const q = qRaw.toLowerCase();
      const showExpired = !!(document.getElementById('usuario-estados-show-expired')?.checked);
      const esc = (s) => s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
      const hl = (text, q) => {
        if(!q) return esc(text);
        const idx = text.toLowerCase().indexOf(q.toLowerCase());
        if(idx === -1) return esc(text);
        const before = esc(text.slice(0, idx));
        const match = esc(text.slice(idx, idx + q.length));
        const after = esc(text.slice(idx + q.length));
        return `${before}<span class="hl">${match}</span>${after}`;
      };
      cont.innerHTML = '';
      (state.usuarioEstados || []).forEach(s => {
        const nombre = String(s.estado || s.nombre || '').trim();
        const desc = String(s.descripcion || '').trim();
        const match = !q || nombre.toLowerCase().includes(q) || desc.toLowerCase().includes(q);
        let expired = false; let meta = '';
        if(s.fecha_vencimiento){
          try{
            const dt = new Date(s.fecha_vencimiento);
            const today = new Date();
            dt.setHours(0,0,0,0); today.setHours(0,0,0,0);
            const diffDays = Math.floor((dt - today)/86400000);
            if(diffDays < 0){ expired = true; meta = `Vencido hace ${Math.abs(diffDays)}d`; }
            else if(diffDays === 0){ meta = 'Vence hoy'; }
            else { meta = `Vence en ${diffDays}d`; }
          }catch{}
        }
        if(!match || (!showExpired && expired)) return;
        const div = document.createElement('div');
        div.className = 'state-item' + (expired ? ' expired' : '');
        const venc = s.fecha_vencimiento ? fmtDate(s.fecha_vencimiento) : '';
        const tpl = state.estadoPlantillasMap ? state.estadoPlantillasMap[nombre] : null;
        const color = tpl && tpl.color ? tpl.color : '';
        const nombreHTML = hl(nombre, qRaw);
        const descHTML = desc ? hl(desc, qRaw) : '';
        div.innerHTML = `<div class="left"><span class="state-dot" style="${color ? `background:${color}` : ''}"></span><span class="state-name">${nombreHTML}</span>${desc ? ` — <span class="state-desc">${descHTML}</span>`:''}${venc ? ` — <span class="state-date">${venc}</span>`:''}${meta ? ` <span class="state-meta">(${meta})</span>`:''}</div> <button class="btn small secondary" data-action="remove" data-id="${s.id}">Eliminar</button>`;
        cont.appendChild(div);
      });
    }
    async function deleteUsuarioEstado(usuario_id, estado_id){
      try{
        const res = await fetch(`/api/usuarios/${usuario_id}/estados/${estado_id}`, { method:'DELETE', headers:{ 'Accept':'application/json' } });
        if(!res.ok){ const err = await res.json().catch(()=>({})); showToast(err.detail || err.error || 'No se pudo eliminar el estado', 'error', 4500); return; }
        await res.json().catch(()=>null);
        await loadUsuarioEstados(usuario_id);
      }catch(e){ showToast('Error de red al eliminar estado', 'error', 4500); }
    }
    async function addUsuarioEstado(){
      const u = state.selectedUsuario;
      if(!u || !u.id){ showToast('Selecciona un usuario válido', 'warning', 3500); return; }
      const nombre = (document.getElementById('usuario-estado-template').value || '').trim();
      const descripcion = (document.getElementById('usuario-estado-descripcion').value || '').trim();
      const venc = (document.getElementById('usuario-estado-vencimiento').value || '').trim();
      if(!nombre){ showToast('Seleccione un estado', 'warning', 3000); return; }
      const body = { estado: nombre, descripcion: descripcion || null, fecha_vencimiento: venc || null };
      try{
        const res = await fetch(`/api/usuarios/${u.id}/estados`, { method:'POST', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(body) });
        if(!res.ok){ const err = await res.json().catch(()=>({})); showToast(err.detail || err.error || 'No se pudo añadir el estado', 'error', 4500); return; }
        await res.json().catch(()=>null);
        document.getElementById('usuario-estado-descripcion').value = '';
        document.getElementById('usuario-estado-vencimiento').value = '';
        await loadUsuarioEstados(u.id);
      }catch(e){ showToast('Error de red al añadir estado', 'error', 4500); }
    }
    function saveUsuarioNotas(){
      const u = state.selectedUsuario;
      if(!u || !u.id){ showToast('Selecciona un usuario válido', 'warning', 3500); return; }
      const nombre = (document.getElementById('usuario-side-nombre').textContent || '').trim().toUpperCase();
      const dni = (document.getElementById('usuario-side-dni').textContent || '').trim();
      const telefono = (document.getElementById('usuario-side-telefono').textContent || '').trim();
      const rol = (document.getElementById('usuario-side-rol').textContent || '').trim().toLowerCase() || 'socio';
      const tipo_cuota_text = (document.getElementById('usuario-side-tipo-cuota').textContent || '').trim();
      const tipo_cuota = tipo_cuota_text || null;
      const notasText = (document.getElementById('usuario-notas-textarea')?.value || '').trim();
      const notas = notasText ? notasText : null;
      const activo = (u.activo === true || u.activo === 'true');
      if(!nombre || !dni){ showToast('Nombre y DNI son obligatorios', 'warning', 3000); return; }
      const payload = { nombre, dni, telefono: telefono || null, pin: null, rol, activo, tipo_cuota, notas };
      const st = document.getElementById('usuario-notas-status'); if(st) st.textContent = 'Guardando…';
      fetch(`/api/usuarios/${u.id}`, { method:'PUT', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(payload) })
        .then(async res => { if(!res.ok){ const err = await res.json().catch(() => ({})); throw new Error(err.detail || err.error || `Error ${res.status}`); } return res; })
        .then(async () => { await loadUsers(); const idx = (state.usuarios || []).findIndex(x => x.id === u.id); if(idx >= 0) selectUsuarioByIndex(idx); showToast('Notas guardadas', 'success', 2500); const st2 = document.getElementById('usuario-notas-status'); if(st2) st2.textContent = 'Guardado'; })
        .catch(e => { showToast(`No se pudo guardar notas: ${e.message}`, 'error', 4500); const st2 = document.getElementById('usuario-notas-status'); if(st2) st2.textContent = 'Error'; });
    }

    // ===== Configuración: Tipos de cuota, Conceptos y Métodos =====
    async function loadTiposCuotaAdmin(){
      try{
        const res = await fetch('/api/tipos_cuota_catalogo', { headers:{ 'Accept':'application/json' } });
        const data = await res.json();
        const rows = Array.isArray(data.items) ? data.items : (Array.isArray(data) ? data : []);
        state.configTipos = rows;
        state.configTiposMap = Object.fromEntries(rows.map(t => [String(t.id ?? t.nombre ?? ''), t]));
        renderTiposCuotaTable(rows);
      }catch(e){ console.warn('No se pudieron cargar tipos de cuota:', e); }
    }
    function renderTiposCuotaTable(rows){
      const tbody = document.querySelector('#config-tipos-table tbody');
      if(!tbody) return;
      tbody.innerHTML = '';
      (Array.isArray(rows) ? rows : []).forEach((t) => {
        const tr = document.createElement('tr');
        tr.setAttribute('data-id', String(t.id ?? ''));
        const isActivo = (t.activo === true || t.activo === 'true');
        tr.innerHTML = `
          <td>${t.nombre ?? ''}</td>
          <td>${t.precio != null ? t.precio : ''}</td>
          <td>${t.duracion_dias != null ? t.duracion_dias : ''}</td>
          <td>${isActivo ? 'Sí' : 'No'}</td>
          <td class="table-actions">
            <button class="btn" data-action="edit-tipo" data-id="${t.id ?? ''}">Editar</button>
            <button class="btn secondary" data-action="toggle-tipo-activo" data-id="${t.id ?? ''}">${isActivo ? 'Desactivar' : 'Activar'}</button>
            <button class="btn secondary" data-action="delete-tipo" data-id="${t.id ?? ''}">Borrar</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }
    function showTipoForm(t){
      state.editingTipoId = t && t.id ? t.id : null;
      document.getElementById('modal-tipo-cuota-title').textContent = t && t.id ? `Editar tipo #${t.id}` : 'Nuevo tipo de cuota';
      const nombre = document.getElementById('tipo-nombre'); if(nombre) nombre.value = t?.nombre ?? '';
      const precio = document.getElementById('tipo-precio'); if(precio) precio.value = t?.precio ?? '';
      const dur = document.getElementById('tipo-duracion'); if(dur) dur.value = t?.duracion_dias ?? '';
      const activo = document.getElementById('tipo-activo'); if(activo) activo.value = (t && (t.activo === true || t.activo === 'true')) ? 'true' : 'false';
      const desc = document.getElementById('tipo-descripcion'); if(desc) desc.value = t?.descripcion ?? '';
      const icono = document.getElementById('tipo-icono'); if(icono) icono.value = t?.icono_path ?? '';
      openModal('modal-tipo-cuota');
    }
    function hideTipoForm(){ state.editingTipoId = null; closeModal('modal-tipo-cuota'); }
    async function saveTipoCuota(){
      const nombre = (document.getElementById('tipo-nombre').value || '').trim();
      const precio = Number(document.getElementById('tipo-precio').value || '0');
      const duracion_dias = Number(document.getElementById('tipo-duracion').value || '0');
      const activoVal = document.getElementById('tipo-activo').value || 'true';
      const activo = (String(activoVal).toLowerCase() === 'true');
      const descripcion = (document.getElementById('tipo-descripcion').value || '').trim() || null;
      const icono_path = (document.getElementById('tipo-icono').value || '').trim() || null;
      if(!nombre){ showToast('El nombre es obligatorio', 'warning', 3000); return; }
      if(!(duracion_dias > 0)){ showToast('Duración debe ser mayor a 0', 'warning', 3000); return; }
      if(precio < 0){ showToast('Precio no puede ser negativo', 'warning', 3000); return; }
      let url = '/api/tipos_cuota'; let method = 'POST';
      const body = { nombre, precio, duracion_dias, activo, descripcion, icono_path };
      if(state.editingTipoId){ url = `/api/tipos_cuota/${state.editingTipoId}`; method = 'PUT'; }
      try{
        const res = await fetch(url, { method, headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(body) });
        if(!res.ok){ const err = await res.json().catch(()=>({})); showToast(err.detail || err.error || 'Error al guardar el tipo', 'error', 4500); return; }
        await res.json().catch(()=>null);
        hideTipoForm();
        showToast('Tipo de cuota guardado', 'success', 2500);
        await loadTiposCuotaAdmin();
      }catch(e){ showToast('Error de red al guardar tipo', 'error', 4500); }
    }

    async function deleteTipoCuota(id){
      if(!id) return;
      const conf = confirm('¿Eliminar tipo de cuota?'); if(!conf) return;
      try{
        const res = await fetch(`/api/tipos_cuota/${id}`, { method:'DELETE', headers:{ 'Accept':'application/json' } });
        if(!res.ok){ const err = await res.json().catch(()=>({})); showToast(err.detail || err.error || 'No se pudo eliminar', 'error', 4500); return; }
        await res.json().catch(()=>null);
        showToast('Tipo de cuota eliminado', 'success', 2500);
        await loadTiposCuotaAdmin();
      }catch(e){ showToast('Error de red al eliminar tipo', 'error', 4500); }
    }

    async function toggleTipoActivo(id){
      if(!id) return;
      const t = (state.configTipos || []).find(x => String(x.id) === String(id));
      if(!t){ showToast('Tipo no encontrado', 'warning', 3000); return; }
      const body = {
        nombre: t.nombre ?? '',
        precio: t.precio ?? 0,
        duracion_dias: t.duracion_dias ?? 0,
        activo: !(t.activo === true || t.activo === 'true'),
        descripcion: t.descripcion ?? null,
        icono_path: t.icono_path ?? null,
      };
      try{
        const res = await fetch(`/api/tipos_cuota/${id}`, { method:'PUT', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(body) });
        if(!res.ok){ const err = await res.json().catch(()=>({})); showToast(err.detail || err.error || 'No se pudo actualizar', 'error', 4500); return; }
        await res.json().catch(()=>null);
        showToast(body.activo ? 'Tipo activado' : 'Tipo desactivado', 'success', 2500);
        await loadTiposCuotaAdmin();
      }catch(e){ showToast('Error de red al actualizar tipo', 'error', 4500); }
    }

    async function loadConceptosAdmin(){
      try{
        const res = await fetch('/api/conceptos_pago', { headers:{ 'Accept':'application/json' } });
        const data = await res.json();
        const rows = Array.isArray(data.items) ? data.items : (Array.isArray(data) ? data : []);
        state.configConceptos = rows;
        renderConceptosTable(rows);
      }catch(e){ console.warn('No se pudieron cargar conceptos:', e); }
    }
    function renderConceptosTable(rows){
      const tbody = document.querySelector('#config-conceptos-table tbody'); if(!tbody) return;
      tbody.innerHTML = '';
      (Array.isArray(rows) ? rows : []).forEach(c => {
        const tr = document.createElement('tr');
        tr.setAttribute('data-id', String(c.id ?? ''));
        const isActivo = (c.activo === true || c.activo === 'true');
        const isDefaultMonthly = (String(c.nombre || '').trim().toLowerCase() === 'cuota mensual');
        const actions = `
            <button class="btn" data-action="edit-concepto" data-id="${c.id ?? ''}">Editar</button>
            <button class="btn secondary" data-action="toggle-concepto-activo" data-id="${c.id ?? ''}">${isActivo ? 'Desactivar' : 'Activar'}</button>
            ${isDefaultMonthly ? '' : `<button class="btn secondary" data-action="delete-concepto" data-id="${c.id ?? ''}">Borrar</button>`}
          `;
        tr.innerHTML = `
          <td>${c.nombre ?? ''}</td>
          <td>${c.precio_base != null ? c.precio_base : ''}</td>
          <td>${c.tipo ?? ''}</td>
          <td>${isActivo ? 'Sí' : 'No'}</td>
          <td>${c.categoria ?? ''}</td>
          <td class="table-actions">
            ${actions}
          </td>`;
        tbody.appendChild(tr);
      });
    }
    function showConceptoForm(c){
      state.editingConceptoId = c && c.id ? c.id : null;
      document.getElementById('modal-concepto-title').textContent = c && c.id ? `Editar concepto #${c.id}` : 'Nuevo concepto de pago';
      const nombre = document.getElementById('concepto-nombre'); if(nombre) nombre.value = c?.nombre ?? '';
      const precio = document.getElementById('concepto-precio-base'); if(precio) precio.value = c?.precio_base ?? '';
      const tipo = document.getElementById('concepto-tipo'); if(tipo) tipo.value = c?.tipo ?? '';
      const activo = document.getElementById('concepto-activo'); if(activo) activo.value = (c && (c.activo === true || c.activo === 'true')) ? 'true' : 'false';
      const cat = document.getElementById('concepto-categoria'); if(cat) cat.value = c?.categoria ?? '';
      const desc = document.getElementById('concepto-descripcion'); if(desc) desc.value = c?.descripcion ?? '';
      openModal('modal-concepto');
    }
    function hideConceptoForm(){ state.editingConceptoId = null; closeModal('modal-concepto'); }
    async function saveConcepto(){
      const nombre = (document.getElementById('concepto-nombre').value || '').trim();
      const precio_base = Number(document.getElementById('concepto-precio-base').value || '0');
      const tipo = (document.getElementById('concepto-tipo').value || '').trim();
      const activoVal = document.getElementById('concepto-activo').value || 'true';
      const activo = (String(activoVal).toLowerCase() === 'true');
      const categoria = (document.getElementById('concepto-categoria').value || '').trim() || null;
      const descripcion = (document.getElementById('concepto-descripcion').value || '').trim() || null;
      if(!nombre){ showToast('El nombre es obligatorio', 'warning', 3000); return; }
      if(precio_base < 0){ showToast('Precio base no puede ser negativo', 'warning', 3000); return; }
      const body = { nombre, precio_base, tipo, activo, categoria, descripcion };
      let url = '/api/conceptos_pago'; let method = 'POST';
      if(state.editingConceptoId){ url = `/api/conceptos_pago/${state.editingConceptoId}`; method = 'PUT'; }
      try{
        const res = await fetch(url, { method, headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(body) });
        if(!res.ok){ const err = await res.json().catch(()=>({})); showToast(err.detail || err.error || 'Error al guardar concepto', 'error', 4500); return; }
        await res.json().catch(()=>null);
        hideConceptoForm();
        showToast('Concepto guardado', 'success', 2500);
        await loadConceptosAdmin();
      }catch(e){ showToast('Error de red al guardar concepto', 'error', 4500); }
    }
    async function deleteConcepto(id){
      if(!id) return;
      const c = (state.configConceptos || []).find(x => String(x.id) === String(id));
      const isDefaultMonthly = c && String(c.nombre || '').trim().toLowerCase() === 'cuota mensual';
      if(isDefaultMonthly){
        showToast('No se puede eliminar el concepto "Cuota Mensual"', 'warning', 3500);
        return;
      }
      const conf = confirm('¿Eliminar concepto de pago?'); if(!conf) return;
      try{
        const res = await fetch(`/api/conceptos_pago/${id}`, { method:'DELETE', headers:{ 'Accept':'application/json' } });
        if(!res.ok){ const err = await res.json().catch(()=>({})); showToast(err.detail || err.error || 'No se pudo eliminar', 'error', 4500); return; }
        await res.json().catch(()=>null);
        showToast('Concepto eliminado', 'success', 2500);
        await loadConceptosAdmin();
      }catch(e){ showToast('Error de red al eliminar concepto', 'error', 4500); }
    }

    async function toggleConceptoActivo(id){
      if(!id) return;
      const c = (state.configConceptos || []).find(x => String(x.id) === String(id));
      if(!c){ showToast('Concepto no encontrado', 'warning', 3000); return; }
      const body = {
        nombre: c.nombre ?? '',
        precio_base: c.precio_base ?? 0,
        tipo: c.tipo ?? '',
        activo: !(c.activo === true || c.activo === 'true'),
        categoria: c.categoria ?? null,
        descripcion: c.descripcion ?? null,
      };
      try{
        const res = await fetch(`/api/conceptos_pago/${id}`, { method:'PUT', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(body) });
        if(!res.ok){ const err = await res.json().catch(()=>({})); showToast(err.detail || err.error || 'No se pudo actualizar', 'error', 4500); return; }
        await res.json().catch(()=>null);
        showToast(body.activo ? 'Concepto activado' : 'Concepto desactivado', 'success', 2500);
        await loadConceptosAdmin();
      }catch(e){ showToast('Error de red al actualizar concepto', 'error', 4500); }
    }

    async function loadMetodosAdmin(){
      try{
        const res = await fetch('/api/metodos_pago', { headers:{ 'Accept':'application/json' } });
        const data = await res.json();
        const rows = Array.isArray(data.items) ? data.items : (Array.isArray(data) ? data : []);
        state.configMetodos = rows;
        renderMetodosTable(rows);
      }catch(e){ console.warn('No se pudieron cargar métodos:', e); }
    }
    function renderMetodosTable(rows){
      const tbody = document.querySelector('#config-metodos-table tbody'); if(!tbody) return;
      tbody.innerHTML = '';
      (Array.isArray(rows) ? rows : []).forEach(m => {
        const tr = document.createElement('tr');
        const colorBadge = m.color ? `<span style=\"background:${m.color};display:inline-block;width:12px;height:12px;border-radius:3px;\"></span>` : '';
        tr.setAttribute('data-id', String(m.id ?? ''));
        const isActivo = (m.activo === true || m.activo === 'true');
        tr.innerHTML = `
          <td>${m.nombre ?? ''}</td>
          <td>${m.comision != null ? m.comision : ''}</td>
          <td>${m.color ?? ''} ${colorBadge}</td>
          <td>${isActivo ? 'Sí' : 'No'}</td>
          <td class="table-actions">
            <button class="btn" data-action="edit-metodo" data-id="${m.id ?? ''}">Editar</button>
            <button class="btn secondary" data-action="toggle-metodo-activo" data-id="${m.id ?? ''}">${isActivo ? 'Desactivar' : 'Activar'}</button>
            <button class="btn secondary" data-action="delete-metodo" data-id="${m.id ?? ''}">Borrar</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }
    function showMetodoForm(m){
      state.editingMetodoId = m && m.id ? m.id : null;
      document.getElementById('modal-metodo-title').textContent = m && m.id ? `Editar método #${m.id}` : 'Nuevo método de pago';
      const nombre = document.getElementById('metodo-nombre'); if(nombre) nombre.value = m?.nombre ?? '';
      const comision = document.getElementById('metodo-comision'); if(comision) comision.value = m?.comision ?? '';
      const color = document.getElementById('metodo-color'); if(color) color.value = m?.color ?? '';
      const activo = document.getElementById('metodo-activo'); if(activo) activo.value = (m && (m.activo === true || m.activo === 'true')) ? 'true' : 'false';
      const desc = document.getElementById('metodo-descripcion'); if(desc) desc.value = m?.descripcion ?? '';
      openModal('modal-metodo');
    }
    function hideMetodoForm(){ state.editingMetodoId = null; closeModal('modal-metodo'); }
    async function saveMetodo(){
      const nombre = (document.getElementById('metodo-nombre').value || '').trim();
      const comision = Number(document.getElementById('metodo-comision').value || '0');
      const color = (document.getElementById('metodo-color').value || '').trim() || null;
      const activoVal = document.getElementById('metodo-activo').value || 'true';
      const activo = (String(activoVal).toLowerCase() === 'true');
      const descripcion = (document.getElementById('metodo-descripcion').value || '').trim() || null;
      if(!nombre){ showToast('El nombre es obligatorio', 'warning', 3000); return; }
      if(comision < 0){ showToast('La comisión no puede ser negativa', 'warning', 3000); return; }
      const body = { nombre, comision, color, activo, descripcion };
      let url = '/api/metodos_pago'; let method = 'POST';
      if(state.editingMetodoId){ url = `/api/metodos_pago/${state.editingMetodoId}`; method = 'PUT'; }
      try{
        const res = await fetch(url, { method, headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(body) });
        if(!res.ok){ const err = await res.json().catch(()=>({})); showToast(err.detail || err.error || 'Error al guardar método', 'error', 4500); return; }
        await res.json().catch(()=>null);
        hideMetodoForm();
        showToast('Método de pago guardado', 'success', 2500);
        await loadMetodosAdmin();
      }catch(e){ showToast('Error de red al guardar método', 'error', 4500); }
    }
    async function deleteMetodo(id){
      if(!id) return; const conf = confirm('¿Eliminar método de pago?'); if(!conf) return;
      try{
        const res = await fetch(`/api/metodos_pago/${id}`, { method:'DELETE', headers:{ 'Accept':'application/json' } });
        if(!res.ok){ const err = await res.json().catch(()=>({})); showToast(err.detail || err.error || 'No se pudo eliminar', 'error', 4500); return; }
        await res.json().catch(()=>null);
        showToast('Método de pago eliminado', 'success', 2500);
        await loadMetodosAdmin();
      }catch(e){ showToast('Error de red al eliminar método', 'error', 4500); }
    }

    async function toggleMetodoActivo(id){
      if(!id) return;
      const m = (state.configMetodos || []).find(x => String(x.id) === String(id));
      if(!m){ showToast('Método no encontrado', 'warning', 3000); return; }
      const body = {
        nombre: m.nombre ?? '',
        comision: m.comision ?? 0,
        color: m.color ?? null,
        activo: !(m.activo === true || m.activo === 'true')
      };
      try{
        const res = await fetch(`/api/metodos_pago/${id}`, { method:'PUT', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(body) });
        if(!res.ok){ const err = await res.json().catch(()=>({})); showToast(err.detail || err.error || 'No se pudo actualizar', 'error', 4500); return; }
        await res.json().catch(()=>null);
        showToast(body.activo ? 'Método activado' : 'Método desactivado', 'success', 2500);
        await loadMetodosAdmin();
      }catch(e){ showToast('Error de red al actualizar método', 'error', 4500); }
    }

    async function loadConfigData(){
      await Promise.all([loadTiposCuotaAdmin(), loadConceptosAdmin(), loadMetodosAdmin()]).catch(()=>{});
    }
    function bindConfiguracionEvents(){
      const tiposTbody = document.querySelector('#config-tipos-table tbody');
      if(tiposTbody){
        tiposTbody.addEventListener('click', (ev) => {
          const btn = ev.target.closest('button'); if(!btn) return;
          const id = btn.getAttribute('data-id'); const action = btn.getAttribute('data-action');
          if(action === 'edit-tipo'){
            const t = (state.configTipos || []).find(x => String(x.id) === String(id));
            showTipoForm(t || null);
          } else if(action === 'delete-tipo'){
            deleteTipoCuota(id);
          } else if(action === 'toggle-tipo-activo'){
            toggleTipoActivo(id);
          }
        });
      }
      const concTbody = document.querySelector('#config-conceptos-table tbody');
      if(concTbody){
        concTbody.addEventListener('click', (ev) => {
          const btn = ev.target.closest('button'); if(!btn) return;
          const id = btn.getAttribute('data-id'); const action = btn.getAttribute('data-action');
          if(action === 'edit-concepto'){
            const c = (state.configConceptos || []).find(x => String(x.id) === String(id));
            showConceptoForm(c || null);
          } else if(action === 'delete-concepto'){
            deleteConcepto(id);
          } else if(action === 'toggle-concepto-activo'){
            toggleConceptoActivo(id);
          }
        });
      }
      const metTbody = document.querySelector('#config-metodos-table tbody');
      if(metTbody){
        metTbody.addEventListener('click', (ev) => {
          const btn = ev.target.closest('button'); if(!btn) return;
          const id = btn.getAttribute('data-id'); const action = btn.getAttribute('data-action');
          if(action === 'edit-metodo'){
            const m = (state.configMetodos || []).find(x => String(x.id) === String(id));
            showMetodoForm(m || null);
          } else if(action === 'delete-metodo'){
            deleteMetodo(id);
          } else if(action === 'toggle-metodo-activo'){
            toggleMetodoActivo(id);
          }
        });
      }
      const btnTiposRefresh = document.getElementById('config-tipos-refresh'); if(btnTiposRefresh) btnTiposRefresh.addEventListener('click', loadTiposCuotaAdmin);
      const btnTiposNew = document.getElementById('config-tipos-new'); if(btnTiposNew) btnTiposNew.addEventListener('click', () => showTipoForm(null));
      const btnSaveTipo = document.getElementById('save-tipo-cuota'); if(btnSaveTipo) btnSaveTipo.addEventListener('click', saveTipoCuota);
      const btnCancelTipo = document.getElementById('cancel-tipo-cuota'); if(btnCancelTipo) btnCancelTipo.addEventListener('click', hideTipoForm);
      const btnCloseTipo = document.getElementById('close-modal-tipo-cuota'); if(btnCloseTipo) btnCloseTipo.addEventListener('click', hideTipoForm);

      const btnConcRefresh = document.getElementById('config-conceptos-refresh'); if(btnConcRefresh) btnConcRefresh.addEventListener('click', loadConceptosAdmin);
      const btnConcNew = document.getElementById('config-conceptos-new'); if(btnConcNew) btnConcNew.addEventListener('click', () => showConceptoForm(null));
      const btnSaveConc = document.getElementById('save-concepto'); if(btnSaveConc) btnSaveConc.addEventListener('click', saveConcepto);
      const btnCancelConc = document.getElementById('cancel-concepto'); if(btnCancelConc) btnCancelConc.addEventListener('click', hideConceptoForm);
      const btnCloseConc = document.getElementById('close-modal-concepto'); if(btnCloseConc) btnCloseConc.addEventListener('click', hideConceptoForm);

      const btnMetRefresh = document.getElementById('config-metodos-refresh'); if(btnMetRefresh) btnMetRefresh.addEventListener('click', loadMetodosAdmin);
      const btnMetNew = document.getElementById('config-metodos-new'); if(btnMetNew) btnMetNew.addEventListener('click', () => showMetodoForm(null));
      const btnSaveMet = document.getElementById('save-metodo'); if(btnSaveMet) btnSaveMet.addEventListener('click', saveMetodo);
      const btnCancelMet = document.getElementById('cancel-metodo'); if(btnCancelMet) btnCancelMet.addEventListener('click', hideMetodoForm);
      const btnCloseMet = document.getElementById('close-modal-metodo'); if(btnCloseMet) btnCloseMet.addEventListener('click', hideMetodoForm);

      const btnRenum = document.getElementById('config-renum-run');
      if(btnRenum) btnRenum.addEventListener('click', () => {
        const startEl = document.getElementById('config-renum-start');
        const startVal = parseInt(((startEl && startEl.value) || '1'), 10);
        if(!Number.isFinite(startVal) || startVal < 1){ showToast('ID inicial inválido', 'warning', 3000); return; }
        if(startVal === 1){ showToast('El ID 1 está reservado para Dueño. Usa 2 o mayor.', 'warning', 4000); return; }
        state.renumStartId = startVal;
        const disp = document.getElementById('renum-start-display'); if(disp) disp.textContent = String(startVal);
        openModal('modal-renum-confirm');
      });
      const renumClose = document.getElementById('renum-close'); if(renumClose) renumClose.addEventListener('click', () => closeModal('modal-renum-confirm'));
      const renumCancel = document.getElementById('renum-cancel'); if(renumCancel) renumCancel.addEventListener('click', () => closeModal('modal-renum-confirm'));
      const renumConfirm = document.getElementById('renum-confirm'); if(renumConfirm) renumConfirm.addEventListener('click', async () => {
        const btn = document.getElementById('renum-confirm'); const trigger = document.getElementById('config-renum-run');
        if(btn) btn.disabled = true; if(trigger) trigger.disabled = true;
        try{
          const startVal = Number(state.renumStartId || 0);
          const res = await fetch('/api/admin/renumerar_usuarios', { method:'POST', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify({ start_id: startVal }) });
          if(res.status === 401){ showToast('Acceso restringido a dueño. Inicie sesión.', 'error', 4500); try{ window.location.href = '/gestion/login'; }catch(e){} return; }
          const data = await res.json().catch(() => ({}));
          if(!res.ok || data.success === false){ showToast(data.detail || data.error || data.message || 'No se pudo renumerar IDs', 'error', 5000); return; }
          showToast('Renumeración completada', 'success', 3500);
          closeModal('modal-renum-confirm');
          try{ if(typeof loadUsers === 'function'){ await loadUsers(); } }catch(e){}
        }catch(e){ showToast('Error de red al renumerar', 'error', 4500); }
        finally{ if(btn) btn.disabled = false; if(trigger) trigger.disabled = false; }
      });
      const btnSecureOwner = document.getElementById('config-secure-owner');
      if(btnSecureOwner) btnSecureOwner.addEventListener('click', () => {
        openModal('modal-secure-owner-confirm');
      });
      const soClose = document.getElementById('secure-owner-close'); if(soClose) soClose.addEventListener('click', () => closeModal('modal-secure-owner-confirm'));
      const soCancel = document.getElementById('secure-owner-cancel'); if(soCancel) soCancel.addEventListener('click', () => closeModal('modal-secure-owner-confirm'));
      const soConfirm = document.getElementById('secure-owner-confirm'); if(soConfirm) soConfirm.addEventListener('click', async () => {
        const trigger = document.getElementById('config-secure-owner');
        const btn = document.getElementById('secure-owner-confirm');
        if(trigger) trigger.disabled = true; if(btn) btn.disabled = true;
        try{
          const res = await fetch('/api/admin/secure_owner', { method:'POST', headers:{ 'Accept':'application/json' } });
          if(res.status === 401){ showToast('Acceso restringido a dueño. Inicie sesión.', 'error', 4500); try{ window.location.href = '/gestion/login'; }catch(e){} return; }
          const data = await res.json().catch(() => ({}));
          if(!res.ok || data.success === false){ showToast(data.detail || data.error || data.message || 'No se pudo asegurar al Dueño', 'error', 5000); return; }
          showToast('Dueño asegurado', 'success', 3500);
          closeModal('modal-secure-owner-confirm');
          try{ if(typeof loadUsers === 'function'){ await loadUsers(); } }catch(e){}
        }catch(e){ showToast('Error de red al asegurar Dueño', 'error', 4500); }
        finally{ if(trigger) trigger.disabled = false; if(btn) btn.disabled = false; }
      });
    }

    // ===== Ejercicios: funciones =====
    function loadEjercicios(){
      const q = (document.getElementById('ejercicios-q') || {}).value || '';
      const objetivo = (document.getElementById('ejercicios-objetivo') || {}).value || '';
      const grupo = (document.getElementById('ejercicios-grupo') || {}).value || '';
      const params = new URLSearchParams();
      if(q) params.append('filtro', q);
      if(objetivo && objetivo !== 'Todos') params.append('objetivo', objetivo);
      if(grupo && grupo !== 'Todos') params.append('grupo_muscular', grupo);
      const url = params.toString() ? `/api/ejercicios?${params.toString()}` : '/api/ejercicios';
      // Retornar la promesa para permitir await loadEjercicios()
      return fetch(url, { headers: { 'Accept': 'application/json' } })
        .then(async (r) => {
          if(!r.ok){
            if(r.status === 401){
              showToast('Acceso restringido a Gestión. Inicie sesión.', 'error', 4500);
              try{ window.location.href = '/gestion/login'; }catch(e){}
              return [];
            }
            const d = await r.json().catch(() => ({}));
            showToast(d.detail || 'No se pudieron cargar ejercicios', 'error', 4500);
            return [];
          }
          return r.json().catch(() => []);
        })
        .then(items => { 
          state.ejercicios = Array.isArray(items) ? items : []; 
          updateEjerciciosTable(); 
          const sel = state.selectedEjercicio ? (state.ejercicios || []).find(x => String(x.id) === String(state.selectedEjercicio.id)) : null;
          updateEjercicioSidePanel(sel || null);
          return state.ejercicios;
        })
        .catch(() => { showToast('No se pudieron cargar ejercicios', 'error', 4500); return []; });
    }

    // ===== Rutinas: funciones =====
    function renderRutinasUsuarioFilter(){
      const sel = document.getElementById('rutinas-usuario'); if(!sel) return;
      const items = Array.isArray(state.usuarios) ? state.usuarios : [];
      const current = sel.value || '';
      sel.innerHTML = '<option value="">Todos</option>';
      items.forEach(u => {
        const opt = document.createElement('option');
        opt.value = String(u.id);
        opt.textContent = u.nombre || u.email || `Usuario ${u.id}`;
        sel.appendChild(opt);
      });
      if(current){ sel.value = current; }
    }

    function loadRutinas(){
      // Mantener para compatibilidad cuando se necesite ver todas (no default)
      const q = (document.getElementById('rutinas-q') || {}).value || '';
      fetch('/api/rutinas', { headers: { 'Accept': 'application/json' } })
        .then(async (r) => {
          if(!r.ok){
            if(r.status === 401){ showToast('Acceso restringido a Gestión. Inicie sesión.', 'error', 4500); try{ window.location.href = '/gestion/login'; }catch(e){} return []; }
            const d = await r.json().catch(() => ({})); showToast(d.detail || 'No se pudieron cargar rutinas', 'error', 4500); return [];
          }
          return r.json().catch(() => []);
        })
        .then(items => {
          const arr = Array.isArray(items) ? items : [];
          // Filtro simple por nombre
          const ql = q.trim().toLowerCase();
          state.rutinas = ql ? arr.filter(x => String((x.nombre||x.nombre_rutina||'')) .toLowerCase().includes(ql)) : arr;
          updateRutinasTable();
          const sel = state.selectedRutina ? (state.rutinas || []).find(x => String(x.id) === String(state.selectedRutina.id)) : null;
          updateRutinaSidePanel(sel || null);
        })
        .catch(() => showToast('No se pudieron cargar rutinas', 'error', 4500));
    }

    function loadRutinasPlantillas(){
      const q = (document.getElementById('rutinas-q') || {}).value || '';
      fetch('/api/rutinas/plantillas', { headers: { 'Accept': 'application/json' } })
        .then(async (r) => {
          if(!r.ok){
            if(r.status === 401){ showToast('Acceso restringido a Gestión. Inicie sesión.', 'error', 4500); try{ window.location.href = '/gestion/login'; }catch(e){} return []; }
            const d = await r.json().catch(() => ({})); showToast(d.detail || 'No se pudieron cargar plantillas', 'error', 4500); return [];
          }
          return r.json().catch(() => []);
        })
        .then(items => {
          const arr = Array.isArray(items) ? items : [];
          const ql = q.trim().toLowerCase();
          state.plantillas = ql ? arr.filter(x => String((x.nombre||x.nombre_rutina||'')).toLowerCase().includes(ql)) : arr;
          // En vista de plantillas, actualizar tabla con plantillas
          updateRutinasTable();
          const sel = state.selectedRutina ? (state.plantillas || []).find(x => String(x.id) === String(state.selectedRutina.id)) : null;
          updateRutinaSidePanel(sel || null);
        })
        .catch(() => showToast('No se pudieron cargar plantillas', 'error', 4500));
    }

    function applyRutinasFilters(){
      const cat = ((document.getElementById('rutinas-categoria')||{}).value || '').toLowerCase();
      const rows = document.querySelectorAll('#rutinas-table tbody tr');
      rows.forEach(r => {
        const rc = (r.querySelector('td[data-col="categoria"]')?.textContent || '').toLowerCase();
        const catOk = !cat || rc === cat;
        r.style.display = catOk ? '' : 'none';
      });
      const countEl = document.getElementById('rutinas-count'); if(countEl){
        const visibleRows = Array.from(document.querySelectorAll('#rutinas-table tbody tr')).filter(tr => tr.style.display !== 'none').length;
        countEl.textContent = `${visibleRows} mostradas`;
      }
    }

    function updateRutinasTable(){
      const tbody = document.querySelector('#rutinas-table tbody'); if(!tbody) return;
      tbody.innerHTML = '';
      const itemsBase = Array.isArray(state.plantillas) ? state.plantillas : [];
      // Sorting
      const sortKey = state.rutinasSortKey || (typeof localStorage !== 'undefined' ? (localStorage.getItem('rutinas-sort-key') || '') : '') || 'nombre';
      const sortDir = state.rutinasSortDir || (typeof localStorage !== 'undefined' ? (localStorage.getItem('rutinas-sort-dir') || '') : '') || 'asc';
      const users = Array.isArray(state.usuarios) ? state.usuarios : [];
      const decorated = (Array.isArray(itemsBase) ? itemsBase : []).map((r) => {
        const diasStr = r.dias_semana != null ? String(r.dias_semana) : (r.dias != null ? String(r.dias) : '0');
        const categoriaStr = r.categoria ? String(r.categoria) : 'general';
        const ejerciciosCountNum = Array.isArray(r.ejercicios) ? r.ejercicios.length : Number(r.ejercicios_count || 0) || 0;
        const assignedStr = (() => {
          const uid = r.usuario_id;
          if(uid == null) return '—';
          const u = users.find(x => String(x.id) === String(uid));
          return u ? (u.nombre || u.email || `Usuario ${u.id}`) : `ID ${uid}`;
        })();
        return {
          r,
          nombre: String(r.nombre || r.nombre_rutina || ''),
          descripcion: String(r.descripcion || ''),
          dias: Number(diasStr) || 0,
          categoria: String(categoriaStr || ''),
          ejercicios: Number(ejerciciosCountNum) || 0,
          asignado: String(assignedStr || '')
        };
      });
      const cmp = (a, b) => {
        const key = String(sortKey || 'nombre');
        let va = a[key]; let vb = b[key];
        const isNum = typeof va === 'number' && typeof vb === 'number';
        if(!isNum){ va = String(va || '').toLowerCase(); vb = String(vb || '').toLowerCase(); return sortDir === 'desc' ? vb.localeCompare(va) : va.localeCompare(vb); }
        return sortDir === 'desc' ? (vb - va) : (va - vb);
      };
      const items = decorated.sort(cmp).map(d => d.r);
      // Update sort header styles
      try{
        const ths = document.querySelectorAll('#rutinas-table thead th.th-sortable');
        ths.forEach(th => {
          const k = th.getAttribute('data-sort') || '';
          th.classList.toggle('th-sorted-asc', k === sortKey && sortDir === 'asc');
          th.classList.toggle('th-sorted-desc', k === sortKey && sortDir === 'desc');
        });
      }catch(_){ }
      items.forEach((r, idx) => {
        const tr = document.createElement('tr');
        tr.setAttribute('data-index', String(idx));
        tr.setAttribute('data-id', String(r.id || ''));
        const dias = r.dias_semana != null ? String(r.dias_semana) : (r.dias != null ? String(r.dias) : '—');
        const categoria = r.categoria ? String(r.categoria) : 'general';
        const ejerciciosCount = Array.isArray(r.ejercicios) ? r.ejercicios.length : (r.ejercicios_count != null ? String(r.ejercicios_count) : '—');
        const assigned = (() => {
          const uid = r.usuario_id;
          if(uid == null) return '—';
          const u = users.find(x => String(x.id) === String(uid));
          return u ? (u.nombre || u.email || `Usuario ${u.id}`) : `ID ${uid}`;
        })();
        const actionsHTML = `<button class="btn" data-action="preview" data-id="${r.id}">Abrir</button>
             <button class="btn" data-action="assign-template" data-id="${r.id}">Asignar a usuario</button>
             <button class="btn" data-action="delete" data-id="${r.id}">Eliminar</button>`;
        const catBadge = `<span class="badge" data-cat="${categoria}" style="display:inline-block;padding:2px 8px;border-radius:12px;background:#eef;color:#334">${categoria}</span>`;
        tr.innerHTML = `
          <td data-col="nombre">${r.nombre || r.nombre_rutina || ''}</td>
          <td data-col="descripcion">${r.descripcion || ''}</td>
          <td data-col="dias">${dias}</td>
          <td data-col="categoria">${catBadge}</td>
          <td data-col="ejercicios">${ejerciciosCount}</td>
          <td data-col="asignado">${assigned}</td>
          <td>${actionsHTML}</td>`;
        tr.addEventListener('click', (ev) => {
          const isBtn = !!ev.target.closest('button'); if(isBtn) return;
          state.selectedRutina = r; updateRutinaSidePanel(r);
        });
        tbody.appendChild(tr);
      });
      applyRutinasFilters();
      const countEl = document.getElementById('rutinas-count'); if(countEl) {
        const visibleRows = Array.from(document.querySelectorAll('#rutinas-table tbody tr')).filter(tr => tr.style.display !== 'none').length;
        countEl.textContent = `${visibleRows} mostradas`;
      }
    }

    function bindRutinasEvents(){
      if(!document.getElementById('panel-rutinas')) return;
      renderRutinasUsuarioFilter();
      const btnRefresh = document.getElementById('rutinas-refresh'); if(btnRefresh) btnRefresh.addEventListener('click', () => { loadRutinasPlantillas(); if(state.activeRutinaTab==='usuario'){ const uid = (document.getElementById('rutinas-usuario')||{}).value || ''; loadRutinasPorUsuario(uid); } });
      const qInput = document.getElementById('rutinas-q'); if(qInput) qInput.addEventListener('keydown', (e) => { if(e.key === 'Enter') { loadRutinasPlantillas(); if(state.activeRutinaTab==='usuario'){ const uid = (document.getElementById('rutinas-usuario')||{}).value || ''; loadRutinasPorUsuario(uid); } } });
      const uSel = document.getElementById('rutinas-usuario'); if(uSel) uSel.addEventListener('change', () => {
        applyRutinasFilters();
        const uid = uSel.value || '';
        loadRutinasPorUsuario(uid);
      });
      const catSel = document.getElementById('rutinas-categoria'); if(catSel) catSel.addEventListener('change', () => { applyRutinasFilters(); });
      const btnNew = document.getElementById('rutinas-new'); if(btnNew) btnNew.addEventListener('click', () => { if(state.activeRutinaTab==='plantillas') openRutinaBuilderNew(); else showRutinaForm(null); });

      // Persist and restore filters
      try{
        const qInput2 = document.getElementById('rutinas-q'); if(qInput2){ const prevQ = localStorage.getItem('rutinas-q') || ''; if(prevQ) qInput2.value = prevQ; qInput2.addEventListener('input', () => { localStorage.setItem('rutinas-q', qInput2.value || ''); }); }
        const catSel2 = document.getElementById('rutinas-categoria'); if(catSel2){ const prevC = localStorage.getItem('rutinas-categoria'); if(prevC != null) catSel2.value = prevC; catSel2.addEventListener('change', () => { localStorage.setItem('rutinas-categoria', catSel2.value || ''); }); }
        const uSel3 = document.getElementById('rutinas-usuario'); if(uSel3){ const prevU = localStorage.getItem('rutinas-usuario'); if(prevU != null) uSel3.value = prevU; uSel3.addEventListener('change', () => { localStorage.setItem('rutinas-usuario', uSel3.value || ''); }); }
      }catch(_){ }

      // Subtabs toggling
      function applyRutinasTabUI(){
        const isPlant = state.activeRutinaTab === 'plantillas';
        const lab = document.getElementById('rutinas-usuario-label'); if(lab) lab.style.display = isPlant ? 'none' : '';
        const uSel2 = document.getElementById('rutinas-usuario'); if(uSel2) uSel2.style.display = isPlant ? 'none' : '';
        const tbl = document.getElementById('rutinas-table'); if(tbl) tbl.parentElement.style.display = '';
        const block = document.getElementById('rutinas-usuario-block'); if(block) block.style.display = isPlant ? 'none' : '';
        const btnNewEl = document.getElementById('rutinas-new'); if(btnNewEl) btnNewEl.textContent = isPlant ? 'Nueva Plantilla' : 'Nueva Rutina';
        // Cargar datos: siempre plantillas; añadir rutinas por usuario si corresponde
        loadRutinasPlantillas();
        if(!isPlant){ const uid = (document.getElementById('rutinas-usuario')||{}).value || ''; loadRutinasPorUsuario(uid); }
        // Update subtabs visual state
        const bPlant = document.getElementById('rutinas-tab-plantillas'); const bUser = document.getElementById('rutinas-tab-usuario');
        if(bPlant) bPlant.classList.toggle('secondary', !isPlant);
        if(bUser) bUser.classList.toggle('secondary', isPlant);
        applyRutinasFilters();
      }
      const tabBar = document.getElementById('rutinas-subtabs');
      if(tabBar){
        tabBar.addEventListener('click', (ev) => {
          const btn = ev.target.closest('button'); if(!btn) return;
          const tab = btn.getAttribute('data-rutinas-tab'); if(!tab) return;
          state.activeRutinaTab = tab === 'usuario' ? 'usuario' : 'plantillas';
          applyRutinasTabUI();
        });
        // Apply default
        applyRutinasTabUI();
      }

      // Header sorting events
      const sortHeaders = document.querySelectorAll('#rutinas-table thead th.th-sortable');
      sortHeaders.forEach(th => {
        th.addEventListener('click', () => {
          const key = th.getAttribute('data-sort') || 'nombre';
          const curKey = state.rutinasSortKey || (localStorage.getItem('rutinas-sort-key') || 'nombre');
          const curDir = state.rutinasSortDir || (localStorage.getItem('rutinas-sort-dir') || 'asc');
          const nextDir = (key === curKey) ? (curDir === 'asc' ? 'desc' : 'asc') : 'asc';
          state.rutinasSortKey = key; state.rutinasSortDir = nextDir;
          try{ localStorage.setItem('rutinas-sort-key', key); localStorage.setItem('rutinas-sort-dir', nextDir); }catch(_){ }
          updateRutinasTable();
        });
      });

      const tbody = document.querySelector('#rutinas-table tbody');
      if(tbody){
        tbody.addEventListener('click', (ev) => {
          const btn = ev.target.closest('button'); if(!btn) return;
          const action = btn.getAttribute('data-action');
          if(action === 'edit'){
            const idx = parseInt(btn.getAttribute('data-index') || '0', 10);
            const row = (state.rutinas || [])[idx]; showRutinaForm(row || null);
          } else if(action === 'builder'){
            const id = btn.getAttribute('data-id'); if(id) openRutinaPreview(Number(id));
          } else if(action === 'preview'){
            const id = btn.getAttribute('data-id'); if(id) openRutinaPreview(Number(id));
          } else if(action === 'delete'){
            const id = btn.getAttribute('data-id'); deleteRutina(id);
          } else if(action === 'assign-template'){
            const id = btn.getAttribute('data-id'); openAssignPlantilla(id);
          } else if(action === 'assign'){
            const id = btn.getAttribute('data-id'); openAssignRutina(id);
          } else if(action === 'unassign'){
            const id = btn.getAttribute('data-id'); openUnassignRutina(id);
          }
        });
      }

      // Modal form bindings
      const btnSave = document.getElementById('save-rutina'); if(btnSave) btnSave.addEventListener('click', saveRutina);
      const btnCancel = document.getElementById('cancel-rutina'); if(btnCancel) btnCancel.addEventListener('click', hideRutinaForm);
      const btnClose = document.getElementById('close-modal-rutina'); if(btnClose) btnClose.addEventListener('click', hideRutinaForm);

      // Delete modal bindings
      const delCancel = document.getElementById('rutina-delete-cancel'); if(delCancel) delCancel.addEventListener('click', () => closeModal('modal-rutina-delete'));
      const delConfirm = document.getElementById('rutina-delete-confirm'); if(delConfirm) delConfirm.addEventListener('click', confirmDeleteRutina);
      const delClose = document.getElementById('rutina-delete-close'); if(delClose) delClose.addEventListener('click', () => closeModal('modal-rutina-delete'));

      // Assign modal bindings
      const asClose = document.getElementById('rutina-assign-close'); if(asClose) asClose.addEventListener('click', () => closeModal('modal-rutina-assign'));
      const asCancel = document.getElementById('rutina-assign-cancel'); if(asCancel) asCancel.addEventListener('click', () => closeModal('modal-rutina-assign'));
      const asConfirm = document.getElementById('rutina-assign-confirm'); if(asConfirm) asConfirm.addEventListener('click', performAssignRutina);

      // Unassign modal bindings
      const unClose = document.getElementById('rutina-unassign-close'); if(unClose) unClose.addEventListener('click', () => closeModal('modal-rutina-unassign'));
      const unCancel = document.getElementById('rutina-unassign-cancel'); if(unCancel) unCancel.addEventListener('click', () => closeModal('modal-rutina-unassign'));
      const unConfirm = document.getElementById('rutina-unassign-confirm'); if(unConfirm) unConfirm.addEventListener('click', performUnassignRutina);

      // Side actions
      const sEdit = document.getElementById('rutina-side-edit'); if(sEdit) sEdit.addEventListener('click', () => { if(state.selectedRutina) openRutinaPreview(Number(state.selectedRutina.id)); });
      const sPrev = document.getElementById('rutina-side-preview'); if(sPrev) sPrev.addEventListener('click', () => { if(state.selectedRutina) openRutinaPreview(Number(state.selectedRutina.id)); });
      const sDel = document.getElementById('rutina-side-delete'); if(sDel) sDel.addEventListener('click', () => { if(state.selectedRutina) deleteRutina(state.selectedRutina.id); });
      const sAssign = document.getElementById('rutina-side-assign'); if(sAssign) sAssign.addEventListener('click', () => { if(state.selectedRutina) openAssignPlantilla(state.selectedRutina.id); });
      const sUnassign = document.getElementById('rutina-side-unassign'); if(sUnassign) sUnassign.addEventListener('click', () => { if(state.selectedRutina) openUnassignRutina(state.selectedRutina.id); });

      // CSV export of visible routines
      const btnCsv = document.getElementById('rutinas-export-csv');
      if(btnCsv){
        btnCsv.addEventListener('click', () => {
          try{
            const rows = Array.from(document.querySelectorAll('#rutinas-table tbody tr')).filter(tr => tr.style.display !== 'none');
            const headers = ['Nombre','Descripcion','Dias','Categoria','#Ejercicios','Asignada a'];
            const lines = [headers.join(',')];
            rows.forEach(tr => {
              const cNombre = tr.querySelector('td[data-col="nombre"]')?.textContent || '';
              const cDesc = tr.querySelector('td[data-col="descripcion"]')?.textContent || '';
              const cDias = tr.querySelector('td[data-col="dias"]')?.textContent || '';
              const cCat = tr.querySelector('td[data-col="categoria"]')?.textContent || '';
              const cEjs = tr.querySelector('td[data-col="ejercicios"]')?.textContent || '';
              const cAsign = tr.querySelector('td[data-col="asignado"]')?.textContent || '';
              const esc = (s) => {
                const t = String(s || '');
                if(/[",\n]/.test(t)) return '"' + t.replace(/"/g,'""') + '"';
                return t;
              };
              lines.push([esc(cNombre), esc(cDesc), esc(cDias), esc(cCat), esc(cEjs), esc(cAsign)].join(','));
            });
            const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'rutinas.csv';
            document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
            showToast('CSV exportado', 'success', 2500);
          }catch(_){ showToast('No se pudo exportar CSV', 'error', 3000); }
        });
      }

      // Preview modal extra actions
      const btnPrevNewEj = document.getElementById('rutina-preview-new-ej'); if(btnPrevNewEj) btnPrevNewEj.addEventListener('click', () => { try{ showEjercicioForm(null); }catch(_){ showToast('No se pudo abrir el formulario', 'error', 3000); } });
      const btnPrevEditEj = document.getElementById('rutina-preview-edit-ej'); if(btnPrevEditEj) btnPrevEditEj.addEventListener('click', () => {
        const float = document.getElementById('rutina-preview-float');
        let eid = float ? (float.dataset.eid || '') : '';
        if(!eid){
          const selIds = Array.isArray(state.rutinaSelected) ? state.rutinaSelected : [];
          if(selIds.length > 0) eid = String(selIds[0]).split('#')[0];
        }
        if(!eid){
          const sel = document.getElementById('rutina-preview-ejercicio');
          const val = sel ? String(sel.value||'') : '';
          if(val) eid = val;
        }
        if(!eid){
          showToast('Selecciona un ejercicio con clic, en la lista o activa selección múltiple', 'info', 3000);
          return;
        }
        const ej = (Array.isArray(state.ejercicios) ? state.ejercicios : []).find(x => String(x.id) === String(eid));
        if(!ej){ showToast('Ejercicio no encontrado', 'warning', 2500); return; }
        try{ showEjercicioForm(ej); }catch(_){ showToast('No se pudo abrir edición', 'error', 3000); }
      });
      const btnPrevToggle = document.getElementById('rutina-preview-toggle-advanced'); if(btnPrevToggle) btnPrevToggle.addEventListener('click', () => {
        const adv = document.getElementById('rutina-preview-advanced'); if(!adv) return;
        const hidden = !!state.rutinaPreviewAdvancedHidden;
        adv.style.display = hidden ? '' : 'none';
        state.rutinaPreviewAdvancedHidden = !hidden;
        btnPrevToggle.textContent = state.rutinaPreviewAdvancedHidden ? 'Mostrar opciones avanzadas' : 'Ocultar opciones avanzadas';
      });
      const btnPrevExport = document.getElementById('rutina-preview-export'); if(btnPrevExport) btnPrevExport.addEventListener('click', directExportExcelFromPreview);
    }

    function showRutinaForm(r){
      state.editingRutinaId = r && r.id ? Number(r.id) : null;
      openModal('modal-rutina-form');
      const nombreEl = document.getElementById('rutina-nombre'); if(nombreEl) nombreEl.value = r && (r.nombre || r.nombre_rutina) ? String(r.nombre || r.nombre_rutina) : '';
      const descEl = document.getElementById('rutina-descripcion'); if(descEl) descEl.value = r && r.descripcion ? String(r.descripcion) : '';
    }
    function hideRutinaForm(){ closeModal('modal-rutina-form'); }

    async function saveRutina(){
      const nombre = (document.getElementById('rutina-nombre') || {}).value || '';
      const descripcion = (document.getElementById('rutina-descripcion') || {}).value || '';
      if(!nombre.trim()){ showToast('El nombre es obligatorio', 'warning', 3000); return; }
      const body = { nombre_rutina: nombre, descripcion };
      let url = '/api/rutinas'; let method = 'POST';
      if(state.editingRutinaId){ url = `/api/rutinas/${state.editingRutinaId}`; method = 'PUT'; }
      try{
        const res = await fetch(url, { method, headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(body) });
        if(res.status === 401){ showToast('Acceso restringido; inicie sesión en Gestión.', 'error', 4500); try{ window.location.href = '/gestion/login'; }catch(e){} return; }
        const data = await res.json().catch(() => ({}));
        if(!res.ok){ showToast(data.detail || data.error || 'No se pudo guardar', 'error', 4500); return; }
        closeModal('modal-rutina-form');
        showToast('Rutina guardada', 'success', 2500);
        await loadRutinas();
      }catch(e){ showToast('Error de red al guardar', 'error', 4500); }
    }

    function deleteRutina(id){
      if(!id){ showToast('Rutina no encontrada', 'warning', 3000); return; }
      state.deleteRutinaId = Number(id);
      openModal('modal-rutina-delete');
    }
    async function confirmDeleteRutina(){
      const id = state.deleteRutinaId; if(!id) return;
      try{
        const res = await fetch(`/api/rutinas/${id}`, { method:'DELETE', headers:{ 'Accept':'application/json' } });
        if(res.status === 401){ showToast('Acceso restringido; inicie sesión en Gestión.', 'error', 4500); try{ window.location.href = '/gestion/login'; }catch(e){} return; }
        const data = await res.json().catch(() => ({}));
        if(!res.ok){ showToast(data.detail || data.error || 'No se pudo eliminar', 'error', 4500); return; }
        closeModal('modal-rutina-delete');
        showToast('Rutina eliminada', 'success', 2500);
        await loadRutinas();
      }catch(e){ showToast('Error de red al eliminar', 'error', 4500); }
    }

function openAssignRutina(id){
  state.editingRutinaId = id ? Number(id) : null;
  renderRutinasUsuarioFilter();
  const sel = document.getElementById('rutina-assign-user');
  const search = document.getElementById('rutina-assign-search');
  const summaryName = document.getElementById('rutina-assign-rutina-name');
  const summaryUser = document.getElementById('rutina-assign-current-user');
  if(summaryName){
    const r = state.selectedRutina; summaryName.textContent = r ? (r.nombre || r.nombre_rutina || `Rutina ${r.id}`) : '—';
  }
  if(sel){
    sel.innerHTML = '';
    const def = document.createElement('option'); def.value = ''; def.textContent = 'Selecciona usuario'; sel.appendChild(def);
    const fill = (users) => { (Array.isArray(users) ? users : []).forEach(u => { const opt = document.createElement('option'); opt.value = String(u.id); opt.textContent = u.nombre || u.email || `Usuario ${u.id}`; sel.appendChild(opt); }); };
    const users = Array.isArray(state.usuarios) ? state.usuarios : [];
    if(users.length){
      fill(users);
    } else {
      try{ loadUsers().then(() => { const u2 = Array.isArray(state.usuarios) ? state.usuarios : []; fill(u2); }).catch(() => {}); }catch(_){ }
    }
    // Preseleccionar el usuario actualmente seleccionado en la vista
    try{ const cur = (document.getElementById('rutinas-usuario')||{}).value || ''; if(cur){ sel.value = String(cur); } }catch(_){ }
    // Mostrar usuario actual de la rutina
    if(summaryUser){
      const r = state.selectedRutina;
      const uid = r && r.usuario_id != null ? Number(r.usuario_id) : null;
      let name = '—';
      if(uid){
        const arr = Array.isArray(state.usuarios) ? state.usuarios : [];
        const u = arr.find(x => Number(x.id) === Number(uid));
        if(u) name = u.nombre || `Usuario ${uid}`;
        else name = String(uid);
      }
      summaryUser.textContent = name;
    }
    // Filtro de búsqueda por texto
    if(search){
      search.oninput = () => {
        const q = (search.value || '').toLowerCase();
        Array.from(sel.options).forEach(opt => {
          if(!opt.value) return; // deja 'Selecciona usuario'
          opt.hidden = q.length > 0 && !(opt.textContent || '').toLowerCase().includes(q);
        });
      };
    }
  }
  openModal('modal-rutina-assign');
}
function openAssignPlantilla(id){
  state.assignPlantillaId = id ? Number(id) : null;
  renderRutinasUsuarioFilter();
  const sel = document.getElementById('rutina-assign-user');
  const search = document.getElementById('rutina-assign-search');
  const summaryName = document.getElementById('rutina-assign-rutina-name');
  const summaryUser = document.getElementById('rutina-assign-current-user');
  if(summaryName){
    // Cargar detalle de plantilla para mostrar nombre
    try{
      fetch(`/api/rutinas/${id}`, { headers:{ 'Accept':'application/json' } })
        .then(r => r.ok ? r.json() : {})
        .then(data => { summaryName.textContent = data && (data.nombre_rutina || data.nombre) ? String(data.nombre_rutina || data.nombre) : `Rutina ${id}`; })
        .catch(()=>{ summaryName.textContent = `Rutina ${id}`; });
    }catch(_){ summaryName.textContent = `Rutina ${id}`; }
  }
  if(sel){
    sel.innerHTML = '';
    const def = document.createElement('option'); def.value = ''; def.textContent = 'Selecciona usuario'; sel.appendChild(def);
    const fill = (users) => { (Array.isArray(users) ? users : []).forEach(u => { const opt = document.createElement('option'); opt.value = String(u.id); opt.textContent = u.nombre || u.email || `Usuario ${u.id}`; sel.appendChild(opt); }); };
    const users = Array.isArray(state.usuarios) ? state.usuarios : [];
    if(users.length){
      fill(users);
    } else {
      try{ loadUsers().then(() => { const u2 = Array.isArray(state.usuarios) ? state.usuarios : []; fill(u2); }).catch(() => {}); }catch(_){ }
    }
    // Preseleccionar el usuario actualmente seleccionado en la vista
    try{ const cur = (document.getElementById('rutinas-usuario')||{}).value || ''; if(cur){ sel.value = String(cur); } }catch(_){ }
    // Mostrar usuario actual (no aplica para plantilla, deja en —)
    if(summaryUser){ summaryUser.textContent = '—'; }
    // Filtro de búsqueda
    if(search){
      search.oninput = () => {
        const q = (search.value || '').toLowerCase();
        Array.from(sel.options).forEach(opt => {
          if(!opt.value) return;
          opt.hidden = q.length > 0 && !(opt.textContent || '').toLowerCase().includes(q);
        });
      };
    }
  }
  openModal('modal-rutina-assign');
}
    async function performAssignRutina(){
      const plantillaId = state.assignPlantillaId;
      const id = state.editingRutinaId;
      const userSel = document.getElementById('rutina-assign-user'); const userId = userSel ? (userSel.value || '') : '';
      if(!userId){ showToast('Selecciona usuario', 'warning', 3000); return; }
      try{
        if(plantillaId){
          // Clonar plantilla para el usuario
          const detRes = await fetch(`/api/rutinas/${plantillaId}`, { headers:{ 'Accept':'application/json' } });
          const det = await detRes.json().catch(() => ({}));
          if(!detRes.ok){ showToast(det.detail || det.error || 'No se pudo cargar plantilla', 'error', 4500); return; }
          const payload = {
            usuario_id: Number(userId),
            nombre_rutina: det.nombre_rutina || det.nombre || 'Rutina',
            descripcion: det.descripcion || null,
            dias_semana: Math.max(2, Math.min(5, Number(det.dias_semana || 3))),
            categoria: det.categoria || 'general',
            ejercicios: (Array.isArray(det.ejercicios)? det.ejercicios: []).map(x => {
              const diasMax = Math.max(2, Math.min(5, Number(det.dias_semana || 3)));
              const dia = Number(x.dia_semana || 1);
              const diaClamped = Math.max(1, Math.min(diasMax, dia));
              return { ejercicio_id: Number(x.ejercicio_id), dia_semana: diaClamped, series: x.series, repeticiones: x.repeticiones, orden: Number(x.orden||1) };
            })
          };
          const res = await fetch('/api/rutinas', { method:'POST', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(payload) });
          const data = await res.json().catch(() => ({})); if(!res.ok){ showToast(data.detail || data.error || 'No se pudo asignar plantilla', 'error', 4500); return; }
          closeModal('modal-rutina-assign'); state.assignPlantillaId = null; showToast('Plantilla clonada y asignada', 'success', 2500);
          // Refrescar vista de usuario si está activa, si no, las plantillas
          if(state.activeRutinaTab === 'usuario'){ const uid = (document.getElementById('rutinas-usuario')||{}).value || ''; await loadRutinasPorUsuario(uid); } else { await loadRutinasPlantillas(); }
        } else if(id){
          // Asignar rutina existente
          const res = await fetch(`/api/rutinas/${id}/assign`, { method:'POST', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify({ usuario_id: Number(userId) }) });
          if(res.status === 401){ showToast('Acceso restringido; inicie sesión en Gestión.', 'error', 4500); try{ window.location.href = '/gestion/login'; }catch(e){} return; }
          const data = await res.json().catch(() => ({})); if(!res.ok){ showToast(data.detail || data.error || 'No se pudo asignar', 'error', 4500); return; }
          closeModal('modal-rutina-assign'); showToast('Rutina asignada', 'success', 2500);
          if(state.activeRutinaTab === 'usuario'){ const uid = (document.getElementById('rutinas-usuario')||{}).value || ''; await loadRutinasPorUsuario(uid); } else { await loadRutinasPlantillas(); }
        } else {
          showToast('Acción no válida', 'warning', 2500);
        }
      }catch(e){ showToast('Error de red al asignar', 'error', 4500); }
    }

function openUnassignRutina(id){
  state.editingRutinaId = id ? Number(id) : null;
  const sel = document.getElementById('rutina-unassign-user');
  const search = document.getElementById('rutina-unassign-search');
  const summaryName = document.getElementById('rutina-unassign-rutina-name');
  const summaryUser = document.getElementById('rutina-unassign-current-user');
  if(summaryName){
    try{
      fetch(`/api/rutinas/${id}`, { headers:{ 'Accept':'application/json' } })
        .then(r => r.ok ? r.json() : {})
        .then(data => { summaryName.textContent = data && (data.nombre_rutina || data.nombre) ? String(data.nombre_rutina || data.nombre) : `Rutina ${id}`; })
        .catch(()=>{ summaryName.textContent = `Rutina ${id}`; });
    }catch(_){ summaryName.textContent = `Rutina ${id}`; }
  }
  if(sel){
    sel.innerHTML = '';
    const def = document.createElement('option'); def.value = ''; def.textContent = 'Selecciona usuario'; sel.appendChild(def);
    const fill = (users) => { (Array.isArray(users) ? users : []).forEach(u => { const opt = document.createElement('option'); opt.value = String(u.id); opt.textContent = u.nombre || u.email || `Usuario ${u.id}`; sel.appendChild(opt); }); };
    const users = Array.isArray(state.usuarios) ? state.usuarios : [];
    if(users.length){
      fill(users);
    } else {
      try{ loadUsers().then(() => { const u2 = Array.isArray(state.usuarios) ? state.usuarios : []; fill(u2); }).catch(() => {}); }catch(_){ }
    }
    // Preseleccionar por defecto el usuario seleccionado en la vista
    try{ const cur = (document.getElementById('rutinas-usuario')||{}).value || ''; if(cur){ sel.value = String(cur); } }catch(_){ }
    // Intentar preseleccionar el usuario asignado a la rutina
    if(id){
      try{
        fetch(`/api/rutinas/${id}`, { headers:{ 'Accept':'application/json' } })
          .then(r => r.ok ? r.json() : {})
          .then(data => { const uid = data && data.usuario_id != null ? String(data.usuario_id) : ''; if(uid){ sel.value = uid; if(summaryUser){ summaryUser.textContent = data.nombre_usuario || uid; } } })
          .catch(()=>{});
      }catch(_){ }
    }
    // Filtro de búsqueda
    if(search){
      search.oninput = () => {
        const q = (search.value || '').toLowerCase();
        Array.from(sel.options).forEach(opt => {
          if(!opt.value) return;
          opt.hidden = q.length > 0 && !(opt.textContent || '').toLowerCase().includes(q);
        });
      };
    }
  }
  openModal('modal-rutina-unassign');
}
    async function performUnassignRutina(){
      const id = state.editingRutinaId; const userSel = document.getElementById('rutina-unassign-user'); const userId = userSel ? (userSel.value || '') : '';
      if(!id || !userId){ showToast('Selecciona usuario', 'warning', 3000); return; }
      try{
        const res = await fetch(`/api/rutinas/${id}/unassign`, { method:'POST', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify({ usuario_id: Number(userId) }) });
        if(res.status === 401){ showToast('Acceso restringido; inicie sesión en Gestión.', 'error', 4500); try{ window.location.href = '/gestion/login'; }catch(e){} return; }
        const data = await res.json().catch(() => ({})); if(!res.ok){ showToast(data.detail || data.error || 'No se pudo desasignar', 'error', 4500); return; }
        closeModal('modal-rutina-unassign'); showToast('Rutina desasignada', 'success', 2500);
        // Refrescar según pestaña activa
        if(state.activeRutinaTab === 'usuario'){
          const uid = (document.getElementById('rutinas-usuario')||{}).value || '';
          await loadRutinasPorUsuario(uid);
        } else {
          await loadRutinas();
        }
      }catch(e){ showToast('Error de red al desasignar', 'error', 4500); }
    }

    // ===== Previsualización avanzada de Rutina =====
    function _deepCopy(obj){ try{ return JSON.parse(JSON.stringify(obj)); }catch(_){ return obj; } }
    function populateEjercicioSelectForPreview(){
      const sel = document.getElementById('rutina-preview-ejercicio'); if(!sel) return;
      sel.innerHTML = '';
      const def = document.createElement('option'); def.value = ''; def.textContent = 'Selecciona ejercicio'; sel.appendChild(def);
      const items = Array.isArray(state.ejerciciosFiltered) ? state.ejerciciosFiltered : (Array.isArray(state.ejercicios) ? state.ejercicios : []);
      const filter = state.ejFilter || {};
      const byGroup = new Map();
      items.forEach(e => { const g = String(e.grupo_muscular||'Generales'); const arr = byGroup.get(g) || []; arr.push(e); byGroup.set(g, arr); });
      if(filter.group){
        const groupLabel = Array.from(byGroup.keys()).find(k => String(k).toLowerCase() === String(filter.group||'').toLowerCase());
        const arr = groupLabel ? (byGroup.get(groupLabel)||[]) : [];
        arr.forEach(e => { const opt = document.createElement('option'); opt.value = String(e.id); opt.textContent = e.nombre || `Ejercicio ${e.id}`; sel.appendChild(opt); });
      } else {
        Array.from(byGroup.entries()).forEach(([label, arr]) => {
          const og = document.createElement('optgroup'); og.label = String(label);
          arr.forEach(e => { const opt = document.createElement('option'); opt.value = String(e.id); opt.textContent = e.nombre || `Ejercicio ${e.id}`; og.appendChild(opt); });
          sel.appendChild(og);
        });
      }
      // Seleccionar automáticamente el primer resultado cuando hay filtro activo
      try {
        const filtered = Array.isArray(state.ejerciciosFiltered) ? state.ejerciciosFiltered : null;
        if(filtered && filtered.length > 0){ sel.value = String(filtered[0].id); }
      } catch(_){ }
    }
    function filterEjerciciosForPreview(query){
      const base = Array.isArray(state.ejercicios) ? state.ejercicios : [];
      state.ejFilter = state.ejFilter || { q:'', group:'', objetivo:'' };
      state.ejFilter.q = String(query||'');
      const q = state.ejFilter.q.toLowerCase();
      const group = String(state.ejFilter.group||'').toLowerCase();
      const objetivo = String(state.ejFilter.objetivo||'').toLowerCase();
      const hasAny = !!q || !!group || !!objetivo;
      if(!hasAny){ state.ejerciciosFiltered = null; return; }
      state.ejerciciosFiltered = base.filter(e => {
        const name = String(e.nombre||'').toLowerCase();
        const gm = String(e.grupo_muscular||'').toLowerCase();
        const obj = String(e.objetivo||'').toLowerCase();
        const qOk = q ? (name.includes(q) || gm.includes(q) || obj.includes(q)) : true;
        const gOk = group ? (gm === group) : true;
        const oOk = objetivo ? (obj === objetivo) : true;
        return qOk && gOk && oOk;
      });
    }
    function populateEjercicioFilters(){
      const grpSel = document.getElementById('rutina-preview-filter-group');
      const objSel = document.getElementById('rutina-preview-filter-objetivo');
      const base = Array.isArray(state.ejercicios) ? state.ejercicios : [];
      const groups = Array.from(new Set(base.map(e => String(e.grupo_muscular||'').trim()).filter(Boolean)));
      const objetivos = Array.from(new Set(base.map(e => String(e.objetivo||'').trim()).filter(Boolean)));
      if(grpSel){ const cur = grpSel.value; grpSel.innerHTML = '<option value="">Grupo: Todos</option>'; groups.forEach(g => { const opt=document.createElement('option'); opt.value=String(g); opt.textContent=String(g); grpSel.appendChild(opt); }); grpSel.value = cur || ''; }
      if(objSel){ const cur = objSel.value; objSel.innerHTML = '<option value="">Objetivo: Todos</option>'; objetivos.forEach(o => { const opt=document.createElement('option'); opt.value=String(o); opt.textContent=String(o); objSel.appendChild(opt); }); objSel.value = cur || ''; }
    }
function renderRutinaPreview(){
  const cont = document.getElementById('rutina-preview-grid'); if(!cont) return;
  const d = state.rutinaPreviewDraft || state.rutinaPreview || {};
  const diasRaw = Number(d.dias_semana || 3);
  const dias = Math.max(2, Math.min(5, diasRaw));
  cont.style.gridTemplateColumns = `repeat(${Math.max(1, dias)}, 1fr)`;
  cont.innerHTML = '';
  const ejs = Array.isArray(d.ejercicios) ? d.ejercicios : [];
  const selectedSet = new Set(Array.isArray(state.rutinaSelected) ? state.rutinaSelected.map(String) : []);
  // Helpers para valores semanales
  const sumSeries = (val) => {
    if(val == null) return 0;
    if(typeof val === 'string'){
      const parts = val.split(',').map(x => Math.max(0, Number(x.trim())||0));
      return parts.reduce((a,b)=>a+b,0);
    }
    return Math.max(0, Number(val)||0);
  };
  const fmtWeekly = (val) => {
    if(val == null) return '';
    if(typeof val === 'string'){
      return val.split(',').map(x => String(x.trim())).join('-');
    }
    return String(val);
  };
  for(let dia=1; dia<=dias; dia++){
    const col = document.createElement('div'); col.className = 'day-col';
    const header = document.createElement('div'); header.className = 'day-header';
    const items = ejs.filter(x => Number(x.dia_semana||1) === dia).sort((a,b) => Number(a.orden||0) - Number(b.orden||0));
    const vol = items.reduce((sum,it)=> sum + sumSeries(it.series), 0);
    const collapsed = !!(state.rutinaDayCollapsed && state.rutinaDayCollapsed[dia]);
    header.innerHTML = `
      <div style="display:flex; align-items:center; gap:8px"><strong>Día ${dia}</strong></div>
      <div class="muted" style="margin-top:4px">Volumen: ${vol} series</div>
      <div style="margin-top:4px"><a href="#" data-day-act="dup" data-day="${dia}">Duplicar a…</a> · <a href="#" data-day-act="clear" data-day="${dia}">Vaciar</a></div>
    `;
    col.appendChild(header);
    const list = document.createElement('div'); list.className = 'day-list'; list.style.display = collapsed ? 'none' : 'flex'; list.style.flexDirection='column'; list.style.gap='6px'; list.style.minHeight='64px';
    // Zona de drop al inicio (ampliada)
    const topDrop = document.createElement('div'); topDrop.style.height='28px'; topDrop.style.border='1px dashed #ddd'; topDrop.style.borderRadius='6px'; topDrop.style.opacity='0.7'; topDrop.style.marginBottom='6px'; topDrop.style.display='flex'; topDrop.style.alignItems='center'; topDrop.style.justifyContent='center'; topDrop.textContent = 'Soltar aquí para el inicio'; topDrop.style.fontSize='12px'; topDrop.style.color='#667';
    topDrop.addEventListener('dragover', (ev) => { ev.preventDefault(); topDrop.style.borderColor = '#59a0ff'; });
    topDrop.addEventListener('dragleave', () => { topDrop.style.borderColor = '#ddd'; });
    topDrop.addEventListener('drop', (ev) => { ev.preventDefault(); const drag = state.dragEj||{}; if(drag.eid){ moveOrReorderEjercicio(drag.eid, dia, '__TOP__'); state.dragEj=null; } topDrop.style.borderColor = '#ddd'; });
    list.appendChild(topDrop);
    items.forEach(item => {
      const tile = document.createElement('div'); tile.className = 'ejercicio-tile';
      const key = `${String(item.ejercicio_id)}#${Number(dia)}#${Number(item.orden||1)}`;
      tile.style.border='1px solid var(--border)'; tile.style.borderRadius='10px'; tile.style.padding= state.rutinaCompact ? '6px 8px' : '10px 12px'; tile.style.cursor='pointer'; tile.style.background = selectedSet.has(key) ? 'rgba(89,160,255,0.12)' : 'var(--card)'; tile.style.borderColor = selectedSet.has(key) ? 'rgba(89,160,255,0.8)' : 'var(--border)'; tile.style.boxShadow='0 1px 2px rgba(0,0,0,0.06)'; tile.style.transition='background 0.2s ease, box-shadow 0.2s ease';
      tile.setAttribute('draggable', 'true'); tile.dataset.eid = String(item.ejercicio_id); tile.dataset.day = String(dia);
      const name = (item.ejercicio && item.ejercicio.nombre) ? item.ejercicio.nombre : `Ejercicio ${item.ejercicio_id}`;
      const series = item.series != null ? item.series : '';
      const reps = item.repeticiones != null ? item.repeticiones : '';
      const weeks = Math.max(1, Math.min(4, Number((document.getElementById('rutina-preview-semanas')||{}).value || 1)));
      const S = (typeof series === 'string') ? series.split(',').map(x=>String(x).trim()) : [String(series||'')];
      const R = (typeof reps === 'string') ? reps.split(',').map(x=>String(x).trim()) : [String(reps||'')];
      const pairs = [];
      for(let i=0;i<weeks;i++){
        const rr = (R[i] != null && R[i] !== '') ? R[i] : (R[0]||'');
        const ss = (S[i] != null && S[i] !== '') ? S[i] : (S[0]||'');
        if(rr || ss){ pairs.push(`${rr}x${ss}`); }
      }
      const pairsTxt = pairs.join(', ');
      tile.innerHTML = state.rutinaCompact ? `<div><strong>${name}</strong> <span class="muted">(${pairsTxt})</span></div>` : `<div style="display:flex; align-items:center; justify-content:space-between; gap:8px"><strong>${name}</strong><span style="font-size:12px; color:#667">#${Number(item.orden||1)}</span></div><div class="muted" style="margin-top:2px; font-size:12px">${pairsTxt}</div>`;
      tile.addEventListener('mouseenter', () => { tile.style.boxShadow='0 2px 6px rgba(0,0,0,0.12)'; });
      tile.addEventListener('mouseleave', () => { tile.style.boxShadow='0 1px 2px rgba(0,0,0,0.06)'; });
      tile.addEventListener('click', (ev) => {
        if(state.rutinaSelectMode){
          if(selectedSet.has(key)){ selectedSet.delete(key); state.rutinaSelected = Array.from(selectedSet); tile.style.background='var(--card)'; tile.style.borderColor='var(--border)'; }
          else { selectedSet.add(key); state.rutinaSelected = Array.from(selectedSet); tile.style.background='rgba(89,160,255,0.12)'; tile.style.borderColor='rgba(89,160,255,0.8)'; }
        } else {
          showRutinaPreviewFloat(item, ev.currentTarget);
        }
      });
      tile.addEventListener('dragstart', (ev) => { try{ state.dragEj = { eid: String(item.ejercicio_id), fromDay: Number(item.dia_semana||dia), order: Number(item.orden||1) }; ev.dataTransfer && ev.dataTransfer.setData('text/plain', String(item.ejercicio_id)); }catch(_){ state.dragEj = { eid: String(item.ejercicio_id), fromDay: Number(item.dia_semana||dia), order: Number(item.orden||1) }; } });
      tile.addEventListener('dragover', (ev) => { ev.preventDefault(); });
      tile.addEventListener('drop', (ev) => { ev.preventDefault(); const drag = state.dragEj || {}; if(drag.eid){ const beforeKey = `${String(item.ejercicio_id)}#${Number(item.orden||1)}`; moveOrReorderEjercicio(drag.eid, dia, beforeKey); state.dragEj = null; } });
      list.appendChild(tile);
    });
    list.addEventListener('dragover', (ev) => { ev.preventDefault(); list.style.border='1px dashed #59a0ff'; list.style.borderRadius='6px'; });
    list.addEventListener('drop', (ev) => { ev.preventDefault(); const drag = state.dragEj||{}; if(drag.eid){ moveOrReorderEjercicio(drag.eid, dia, null); state.dragEj = null; } list.style.border=''; });
    col.appendChild(list);
    // Bind acciones de día
    header.querySelectorAll('a[data-day-act]').forEach(a => {
      a.addEventListener('click', (ev) => {
        ev.preventDefault();
        const act = a.getAttribute('data-day-act');
        const dnum = Number(a.getAttribute('data-day')||'1')||1;
        if(act==='clear'){ clearRutinaDay(dnum); }
        if(act==='dup'){ openDuplicateDayPopover(dnum, a); }
        // Colapsar individual removido: usar solo el botón general
      });
    });
    cont.appendChild(col);
  }
  // Sincronizar selects de día con número de días actual
  refreshPreviewDayOptions(dias);
  // Renderizar también la vista tipo Excel (tabla editable)
  renderRutinaExcelView();
  // Si la vista avanzada está visible, refrescar su HTML
  const adv = document.getElementById('rutina-preview-excel-advanced');
  if(adv && adv.style.display !== 'none'){ renderRutinaSheetJSView(); }
}
    function clearRutinaDay(dia){
      const d = state.rutinaPreviewDraft || state.rutinaPreview || {};
      const ejs = Array.isArray(d.ejercicios) ? d.ejercicios : [];
      const remaining = ejs.filter(x => Number(x.dia_semana||1) !== Number(dia));
      d.ejercicios = remaining; state.rutinaPreviewDraft = d;
      markRutinaDirty(); renderRutinaPreview(); showToast(`Día ${dia} vaciado`, 'info', 1800);
    }
    function duplicateRutinaDay(dia){
      const d = state.rutinaPreviewDraft || state.rutinaPreview || {};
      const diasMax = Math.max(2, Math.min(5, Number(d.dias_semana||3)));
      const target = Math.min(diasMax, Number(dia)+1);
      if(target === Number(dia)){ showToast('No hay día destino para duplicar', 'warning', 2500); return; }
      const ejs = Array.isArray(d.ejercicios) ? d.ejercicios : [];
      const srcItems = ejs.filter(x => Number(x.dia_semana||1) === Number(dia));
      const destItems = ejs.filter(x => Number(x.dia_semana||1) === Number(target));
      if(destItems.length + srcItems.length > 8){ showToast('No se puede duplicar: supera 8 ejercicios', 'warning', 2800); return; }
      const baseOrder = destItems.length ? Math.max(...destItems.map(x => Number(x.orden||1))) : 0;
      const copies = srcItems.map((it, idx) => ({ ejercicio_id: Number(it.ejercicio_id), dia_semana: Number(target), series: (it.series!=null?it.series:3), repeticiones: (it.repeticiones!=null?it.repeticiones:10), orden: Number(baseOrder + idx + 1), ejercicio: it.ejercicio ? _deepCopy(it.ejercicio) : { id: Number(it.ejercicio_id) } }));
      d.ejercicios = ejs.concat(copies); state.rutinaPreviewDraft = d;
      markRutinaDirty(); renderRutinaPreview(); showToast(`Día ${dia} duplicado a Día ${target}`, 'success', 2000);
    }
function duplicateRutinaDayTo(srcDay, destDay){
      const d = state.rutinaPreviewDraft || state.rutinaPreview || {};
      const diasMax = Math.max(2, Math.min(5, Number(d.dias_semana||3)));
      const target = Math.max(1, Math.min(diasMax, Number(destDay||srcDay+1)));
      if(target === Number(srcDay)){ showToast('Elige un día distinto para duplicar', 'warning', 2500); return; }
      const ejs = Array.isArray(d.ejercicios) ? d.ejercicios : [];
      const srcItems = ejs.filter(x => Number(x.dia_semana||1) === Number(srcDay));
      const destItems = ejs.filter(x => Number(x.dia_semana||1) === Number(target));
      if(destItems.length + srcItems.length > 8){ showToast('No se puede duplicar: supera 8 ejercicios', 'warning', 2800); return; }
      const baseOrder = destItems.length ? Math.max(...destItems.map(x => Number(x.orden||1))) : 0;
      const copies = srcItems.map((it, idx) => ({ ejercicio_id: Number(it.ejercicio_id), dia_semana: Number(target), series: (it.series!=null?it.series:3), repeticiones: (it.repeticiones!=null?it.repeticiones:10), orden: Number(baseOrder + idx + 1), ejercicio: it.ejercicio ? _deepCopy(it.ejercicio) : { id: Number(it.ejercicio_id) } }));
      d.ejercicios = ejs.concat(copies); state.rutinaPreviewDraft = d;
      markRutinaDirty(); renderRutinaPreview(); showToast(`Día ${srcDay} duplicado a Día ${target}`, 'success', 2000);
}
function openDuplicateDayPopover(dia, anchor){
      try{ const prev = document.getElementById('rutina-dup-popover'); if(prev) prev.remove(); }catch(_){ }
      const d = state.rutinaPreviewDraft || state.rutinaPreview || {};
      const diasMax = Math.max(2, Math.min(5, Number(d.dias_semana||3)));
      const pop = document.createElement('div'); pop.id='rutina-dup-popover'; pop.style.position='absolute'; pop.style.background='#fff'; pop.style.border='1px solid #ddd'; pop.style.borderRadius='6px'; pop.style.padding='8px'; pop.style.boxShadow='0 4px 14px rgba(0,0,0,0.2)'; pop.style.zIndex='1001';
      const rect = anchor.getBoundingClientRect(); const modal = anchor.closest('.modal'); const mrect = modal ? modal.getBoundingClientRect() : {left:0, top:0};
      pop.style.left = `${rect.left - mrect.left + 8}px`; pop.style.top = `${rect.top - mrect.top + 20}px`;
      const sel = document.createElement('select'); sel.style.marginRight='8px'; for(let i=1;i<=diasMax;i++){ if(i===Number(dia)) continue; const opt=document.createElement('option'); opt.value=String(i); opt.textContent=`Día ${i}`; sel.appendChild(opt); }
      const ok = document.createElement('button'); ok.className='btn'; ok.textContent='Duplicar'; ok.onclick = () => { const dest = Number(sel.value||dia+1)||dia+1; duplicateRutinaDayTo(Number(dia), dest); try{ pop.remove(); }catch(_){ } };
      const cancel = document.createElement('button'); cancel.className='btn secondary'; cancel.textContent='Cancelar'; cancel.style.marginLeft='6px'; cancel.onclick = () => { try{ pop.remove(); }catch(_){ } };
      pop.appendChild(sel); pop.appendChild(ok); pop.appendChild(cancel);
      const cont = document.getElementById('modal-rutina-preview'); if(cont){ cont.appendChild(pop); } else { document.body.appendChild(pop); }
}
function toggleDayCollapse(dnum){
  state.rutinaDayCollapsed = state.rutinaDayCollapsed || {};
  state.rutinaDayCollapsed[Number(dnum)] = !state.rutinaDayCollapsed[Number(dnum)];
  renderRutinaPreview();
}
function refreshPreviewDayOptions(dias){
  const clampDias = Math.max(2, Math.min(5, Number(dias || 3)));
  const makeOpts = (sel) => {
    if(!sel) return;
    sel.innerHTML = '';
    for(let i=1;i<=clampDias;i++){ const opt=document.createElement('option'); opt.value=String(i); opt.textContent=`Día ${i}`; sel.appendChild(opt); }
  };
  makeOpts(document.getElementById('rutina-preview-dia'));
  makeOpts(document.getElementById('rutina-preview-float-dia'));
}
    function showRutinaPreviewFloat(item, anchor){
      const float = document.getElementById('rutina-preview-float'); if(!float) return;
      const rect = anchor.getBoundingClientRect(); const modal = float.closest('.modal'); const mrect = modal ? modal.getBoundingClientRect() : {left:0, top:0, width: (window.innerWidth||800), height: (window.innerHeight||600)};
      // Mostrar primero para medir dimensiones
      float.style.display = 'block';
      const fw = float.offsetWidth || 360; const fh = float.offsetHeight || 240;
      const mw = (mrect.width != null) ? mrect.width : (modal ? modal.clientWidth : 800);
      const mh = (mrect.height != null) ? mrect.height : (modal ? modal.clientHeight : 600);
      let x = (rect.left - mrect.left) + 8;
      let y = (rect.top - mrect.top) + 8;
      // Si se cortaría por abajo, intentar ubicar arriba del tile
      if(y + fh + 8 > mh){ y = (rect.top - mrect.top) - fh - 8; }
      // Clampeo para mantener dentro del modal
      const maxX = Math.max(8, mw - fw - 8);
      const maxY = Math.max(8, mh - fh - 8);
      x = Math.max(8, Math.min(x, maxX));
      y = Math.max(8, Math.min(y, maxY));
      float.style.left = `${x}px`; float.style.top = `${y}px`;
      const t = document.getElementById('rutina-preview-float-title'); if(t) t.textContent = (item.ejercicio && item.ejercicio.nombre) ? item.ejercicio.nombre : `Ejercicio ${item.ejercicio_id}`;
      const s = document.getElementById('rutina-preview-float-series'); if(s) s.value = (typeof item.series === 'string' ? '' : (item.series || ''));
      const r = document.getElementById('rutina-preview-float-reps'); if(r) r.value = (typeof item.repeticiones === 'string' ? '' : (item.repeticiones || ''));
      const o = document.getElementById('rutina-preview-float-orden'); if(o) o.value = item.orden || 1;
      const dsel = document.getElementById('rutina-preview-float-dia'); if(dsel) dsel.value = String(item.dia_semana || 1);
      const weeklyToggle = document.getElementById('rutina-preview-float-weekly');
      const singleWrap = document.getElementById('rutina-preview-float-single');
      const weeklyWrap = document.getElementById('rutina-preview-float-weekly-inputs');
      const weeks = Math.max(1, Math.min(4, Number((document.getElementById('rutina-preview-semanas')||{}).value || 1)));
      const sInputs = ['s1','s2','s3','s4'].map(id => document.getElementById(`rutina-preview-float-${id}`));
      const rInputs = ['r1','r2','r3','r4'].map(id => document.getElementById(`rutina-preview-float-${id}`));
      const S = typeof item.series === 'string' ? item.series.split(',').map(x=>String(x).trim()) : [];
      const R = typeof item.repeticiones === 'string' ? item.repeticiones.split(',').map(x=>String(x).trim()) : [];
      const hasWeekly = (S.length || R.length) > 0;
      if(weeklyToggle){ weeklyToggle.checked = hasWeekly; }
      if(singleWrap && weeklyWrap){ singleWrap.style.display = hasWeekly ? 'none' : '';
        weeklyWrap.style.display = hasWeekly ? 'block' : 'none'; }
      for(let i=0;i<4;i++){
        if(sInputs[i]){ sInputs[i].style.display = (i<weeks) ? '' : 'none'; sInputs[i].value = S[i] ? S[i] : ''; }
        if(rInputs[i]){ rInputs[i].style.display = (i<weeks) ? '' : 'none'; rInputs[i].value = R[i] ? R[i] : ''; }
      }
      if(weeklyToggle){ weeklyToggle.onchange = () => {
        const useWeekly = !!weeklyToggle.checked;
        if(singleWrap && weeklyWrap){ singleWrap.style.display = useWeekly ? 'none' : '';
          weeklyWrap.style.display = useWeekly ? 'block' : 'none'; }
      }; }
      float.dataset.eid = String(item.ejercicio_id);
      // Identidad exacta de la instancia para evitar editar otro duplicado
      try {
        float.dataset.srcDay = String(item.dia_semana || 1);
        float.dataset.srcOrder = String(item.orden || 0);
      } catch(_){ float.dataset.srcDay = String(item.dia_semana || 1); float.dataset.srcOrder = String(item.orden || 0); }
      // Cierre por click fuera del editor flotante (solo dentro del modal)
      try {
        const onOutsideClick = (ev) => {
          const tgt = ev.target;
          const isInside = float.contains(tgt);
          const isTile = !!(tgt && (tgt.closest && tgt.closest('.ejercicio-tile')));
          if(float.style.display === 'block' && !isInside && !isTile){ try{ applyRutinaPreviewFloat(true); }catch(_){ hideRutinaPreviewFloat(); } }
        };
        state._floatOutsideHandler && modal && modal.removeEventListener('mousedown', state._floatOutsideHandler);
        state._floatOutsideHandler = onOutsideClick;
        modal && modal.addEventListener('mousedown', onOutsideClick);
        // Cierre con Escape para accesibilidad
        const onKey = (ev) => { if(ev.key === 'Escape'){ try{ applyRutinaPreviewFloat(true); }catch(_){ hideRutinaPreviewFloat(); } } };
        state._floatKeyHandler && document.removeEventListener('keydown', state._floatKeyHandler);
        state._floatKeyHandler = onKey;
        document.addEventListener('keydown', onKey);
      } catch(_){ }
    }
    function hideRutinaPreviewFloat(){
      const float = document.getElementById('rutina-preview-float');
      if(float){
        float.style.display='none';
        float.dataset.eid='';
        try{
          const modal = float.closest('.modal');
          if(state._floatOutsideHandler && modal){ modal.removeEventListener('mousedown', state._floatOutsideHandler); }
          state._floatOutsideHandler = null;
          if(state._floatKeyHandler){ document.removeEventListener('keydown', state._floatKeyHandler); }
          state._floatKeyHandler = null;
        }catch(_){ }
      }
    }
    function applyRutinaPreviewFloat(silent){
      const float = document.getElementById('rutina-preview-float'); if(!float) return;
      const eid = float.dataset.eid; if(!eid) return;
      const srcDayF = Number(float.dataset.srcDay||1);
      const srcOrderF = Number(float.dataset.srcOrder||0);
      // Siempre tomar los valores semanales mostrados en el panel flotante
      // (los inputs individuales no existen en el DOM de esta vista)
      const weeks = Math.max(1, Math.min(4, Number((document.getElementById('rutina-preview-semanas')||{}).value || 1)));
      const sVals = [];
      const rVals = [];
      for(let i=1;i<=weeks;i++){
        const sVal = Math.max(1, Number((document.getElementById(`rutina-preview-float-s${i}`)||{}).value || 1));
        const rVal = Math.max(1, Number((document.getElementById(`rutina-preview-float-r${i}`)||{}).value || 1));
        sVals.push(String(sVal)); rVals.push(String(rVal));
      }
      const s = sVals.join(',');
      const r = rVals.join(',');
      const o = Math.max(1, Number((document.getElementById('rutina-preview-float-orden')||{}).value || 1));
      const dMax = Math.max(2, Math.min(5, Number((document.getElementById('rutina-preview-dias')||{}).value || 3)));
      let dsel = Number((document.getElementById('rutina-preview-float-dia')||{}).value || 1) || 1; dsel = Math.max(1, Math.min(dMax, dsel));
      const d = state.rutinaPreviewDraft || state.rutinaPreview || {};
      const ejs = Array.isArray(d.ejercicios) ? d.ejercicios : [];
      // Buscar la instancia exacta por id + día + orden
      let item = ejs.find(x => String(x.ejercicio_id) === String(eid) && Number(x.dia_semana||1) === srcDayF && Number(x.orden||0) === srcOrderF);
      if(!item){ if(!silent){ try{ showToast('No se encontró la instancia seleccionada', 'warning', 2000); }catch(_){ } } hideRutinaPreviewFloat(); return; }
      if(item){
        // Límite: máximo 8 ejercicios por día al mover
        const currentDay = Number(item.dia_semana||1);
        if(dsel !== currentDay){
          const destCount = ejs.filter(x => Number(x.dia_semana||1)===dsel && String(x.ejercicio_id)!==String(eid)).length;
          if(destCount >= 8){
            item.series = s; item.repeticiones = r; item.orden = o;
            showToast(`Día ${dsel} ya tiene 8 ejercicios. No se movió.`, 'warning', 2800);
          } else {
            item.series = s; item.repeticiones = r; item.orden = o; item.dia_semana = dsel;
          }
        } else {
          item.series = s; item.repeticiones = r; item.orden = o; item.dia_semana = dsel;
        }
      }
      markRutinaDirty(); renderRutinaPreview(); hideRutinaPreviewFloat(); if(!silent){ try{ showToast('Cambios aplicados', 'success', 1800); }catch(_){ } }
    }
    function removeRutinaPreviewItem(){
      const float = document.getElementById('rutina-preview-float'); if(!float) return;
      const eid = float.dataset.eid; if(!eid) return;
      const srcDayF = Number(float.dataset.srcDay||1);
      const srcOrderF = Number(float.dataset.srcOrder||0);
      const d = state.rutinaPreviewDraft || state.rutinaPreview || {};
      let ejs = Array.isArray(d.ejercicios) ? d.ejercicios : [];
      // Eliminar sólo la instancia exacta
      ejs = ejs.filter(x => !(String(x.ejercicio_id) === String(eid) && Number(x.dia_semana||1) === srcDayF && Number(x.orden||0) === srcOrderF));
      d.ejercicios = ejs; state.rutinaPreviewDraft = d;
      markRutinaDirty(); renderRutinaPreview(); hideRutinaPreviewFloat();
    }
    function duplicateRutinaPreviewItem(){
      const float = document.getElementById('rutina-preview-float'); if(!float) return;
      const eid = float.dataset.eid; if(!eid) return;
      const srcDayF = Number(float.dataset.srcDay||1);
      const srcOrderF = Number(float.dataset.srcOrder||0);
      const dsel = Number((document.getElementById('rutina-preview-float-dia')||{}).value || 1) || 1;
      const d = state.rutinaPreviewDraft || state.rutinaPreview || {};
      const ejs = Array.isArray(d.ejercicios) ? d.ejercicios : [];
      const src = ejs.find(x => String(x.ejercicio_id) === String(eid) && Number(x.dia_semana||1) === srcDayF && Number(x.orden||0) === srcOrderF); if(!src){ try{ showToast('No se encontró la instancia seleccionada', 'warning', 2000); }catch(_){ } return; }
      const dayItems = ejs.filter(x => Number(x.dia_semana||1) === Number(dsel));
      if(dayItems.length >= 8){ showToast('Máximo 8 ejercicios por día', 'warning', 2500); return; }
      const maxOrder = dayItems.length ? Math.max(...dayItems.map(x => Number(x.orden||1))) : 0;
      const copy = { ejercicio_id: Number(src.ejercicio_id), dia_semana: Number(dsel), series: (src.series!=null?src.series:3), repeticiones: (src.repeticiones!=null?src.repeticiones:10), orden: Number(maxOrder+1), ejercicio: src.ejercicio ? _deepCopy(src.ejercicio) : { id: Number(src.ejercicio_id) } };
      ejs.push(copy); d.ejercicios = ejs; state.rutinaPreviewDraft = d; markRutinaDirty(); renderRutinaPreview(); showToast('Ejercicio duplicado', 'success', 1800);
    }
    function reorderRutinaPreviewItem(direction){
      const float = document.getElementById('rutina-preview-float'); if(!float) return;
      const eid = float.dataset.eid; if(!eid) return;
      const srcDayF = Number(float.dataset.srcDay||1);
      const srcOrderF = Number(float.dataset.srcOrder||0);
      const d = state.rutinaPreviewDraft || state.rutinaPreview || {};
      const ejs = Array.isArray(d.ejercicios) ? d.ejercicios : [];
      const item = ejs.find(x => String(x.ejercicio_id) === String(eid) && Number(x.dia_semana||1) === srcDayF && Number(x.orden||0) === srcOrderF); if(!item){ try{ showToast('No se encontró la instancia seleccionada', 'warning', 2000); }catch(_){ } return; }
      const day = Number(item.dia_semana||1);
      const dayItems = ejs.filter(x => Number(x.dia_semana||1) === day).sort((a,b) => Number(a.orden||1) - Number(b.orden||1));
      const idx = dayItems.findIndex(x => String(x.ejercicio_id) === String(eid) && Number(x.orden||1) === Number(item.orden||1)); if(idx < 0) return;
      if(direction === 'up' && idx > 0){ const tmp = dayItems[idx-1]; dayItems[idx-1] = dayItems[idx]; dayItems[idx] = tmp; }
      if(direction === 'down' && idx < dayItems.length - 1){ const tmp = dayItems[idx+1]; dayItems[idx+1] = dayItems[idx]; dayItems[idx] = tmp; }
      // Reindex orders
      dayItems.forEach((x,i) => { x.orden = i+1; });
      d.ejercicios = ejs; state.rutinaPreviewDraft = d; markRutinaDirty(); renderRutinaPreview(); showToast('Orden actualizado', 'info', 1500);
    }
function moveOrReorderEjercicio(eid, toDay, beforeEid){
  const d = state.rutinaPreviewDraft || state.rutinaPreview || {};
  let ejs = Array.isArray(d.ejercicios) ? d.ejercicios : [];
  const drag = state.dragEj || {};
  const bulk = state.bulkMoveHint || {};
  const srcDayHint = Number((drag.fromDay != null ? drag.fromDay : bulk.fromDay) || 0) || null;
  const srcOrderHint = Number((drag.order != null ? drag.order : bulk.order) || 0) || null;
  let src = ejs.find(x => String(x.ejercicio_id) === String(eid) && (srcDayHint==null || Number(x.dia_semana||1)===srcDayHint) && (srcOrderHint==null || Number(x.orden||0)===srcOrderHint));
  if(!src){ src = ejs.find(x => String(x.ejercicio_id) === String(eid)); }
  if(!src) return;
  const fromDay = Number(src.dia_semana||1);
  const tDay = Number(toDay||fromDay) || fromDay;
  // Si se suelta en el mismo día, solo reordenar dentro del día sin duplicar listas
  if(fromDay === tDay){
    const dayList = ejs.filter(x => Number(x.dia_semana||1)===fromDay && x !== src);
    let insertIndex = -1;
    if(String(beforeEid) === '__TOP__'){ insertIndex = 0; }
    else if(beforeEid != null){
      const parts = String(beforeEid).split('#');
      const beid = parts[0]; const bord = parts[1] != null ? Number(parts[1]) : null;
      insertIndex = dayList.findIndex(x => String(x.ejercicio_id) === String(beid) && (bord==null || Number(x.orden||0)===bord));
    }
    src.dia_semana = fromDay;
    if(insertIndex >= 0){ dayList.splice(insertIndex, 0, src); } else { dayList.push(src); }
    dayList.forEach((x,i)=>{ x.orden = i+1; x.dia_semana = fromDay; });
    const others = ejs.filter(x => Number(x.dia_semana||1)!==fromDay);
    d.ejercicios = others.concat(dayList);
    state.rutinaPreviewDraft = d; markRutinaDirty(); renderRutinaPreview(); showToast('Ejercicio reordenado', 'success', 1500);
    return;
  }
  const fromList = ejs.filter(x => Number(x.dia_semana||1)===fromDay && x !== src);
  const toList = ejs.filter(x => Number(x.dia_semana||1)===tDay);
  const others = ejs.filter(x => Number(x.dia_semana||1)!==fromDay && Number(x.dia_semana||1)!==tDay);
  // Límite de 8 por día al mover entre días
  if(fromDay !== tDay && toList.length >= 8){ showToast('Máximo 8 ejercicios por día', 'warning', 2500); return; }
  let insertIndex = -1;
  if(String(beforeEid) === '__TOP__'){ insertIndex = 0; }
  else if(beforeEid != null){
    const parts = String(beforeEid).split('#');
    const beid = parts[0]; const bord = parts[1] != null ? Number(parts[1]) : null;
    insertIndex = toList.findIndex(x => String(x.ejercicio_id) === String(beid) && (bord==null || Number(x.orden||0)===bord));
  }
  src.dia_semana = tDay;
  if(insertIndex >= 0){ toList.splice(insertIndex, 0, src); } else { toList.push(src); }
  fromList.forEach((x,i)=>{ x.orden = i+1; x.dia_semana = fromDay; });
  toList.forEach((x,i)=>{ x.orden = i+1; x.dia_semana = tDay; });
  d.ejercicios = others.concat(fromList).concat(toList);
  state.rutinaPreviewDraft = d; markRutinaDirty(); renderRutinaPreview(); showToast('Ejercicio movido', 'success', 1500);
}

function bulkMoveSelected(destDay){
  const d = state.rutinaPreviewDraft || state.rutinaPreview || {};
  const keys = Array.isArray(state.rutinaSelected) ? state.rutinaSelected.map(String) : [];
  const ejs = Array.isArray(d.ejercicios)? d.ejercicios: [];
  const destItems = ejs.filter(x => Number(x.dia_semana||1) === Number(destDay));
  if(destItems.length + keys.length > 8){ showToast('No se puede mover: supera 8 ejercicios', 'warning', 2800); return; }
  keys.forEach(k => {
    const parts = String(k).split('#');
    const eid = parts[0]; const sday = parts[1] != null ? Number(parts[1]) : null; const sorder = parts[2] != null ? Number(parts[2]) : null;
    state.bulkMoveHint = { fromDay: sday, order: sorder };
    moveOrReorderEjercicio(String(eid), Number(destDay), null);
    state.bulkMoveHint = null;
  });
  markRutinaDirty(); renderRutinaPreview(); showToast('Seleccionados movidos', 'success', 1800);
}
function bulkDuplicateSelected(destDay){
  const d = state.rutinaPreviewDraft || state.rutinaPreview || {};
  const ejs = Array.isArray(d.ejercicios)? d.ejercicios: [];
  const ids = new Set(Array.isArray(state.rutinaSelected) ? state.rutinaSelected.map(String) : []);
  const destItems = ejs.filter(x => Number(x.dia_semana||1) === Number(destDay));
  let baseOrder = destItems.length ? Math.max(...destItems.map(x => Number(x.orden||1))) : 0;
  const toCopy = ejs.filter(x => ids.has(`${String(x.ejercicio_id)}#${Number(x.dia_semana||1)}#${Number(x.orden||1)}`));
  if(destItems.length + toCopy.length > 8){ showToast('No se puede duplicar: supera 8 ejercicios', 'warning', 2800); return; }
  toCopy.forEach((src) => {
    const copy = { ejercicio_id: Number(src.ejercicio_id), dia_semana: Number(destDay), series: (src.series!=null?src.series:3), repeticiones: (src.repeticiones!=null?src.repeticiones:10), orden: Number(++baseOrder), ejercicio: src.ejercicio ? _deepCopy(src.ejercicio) : { id: Number(src.ejercicio_id) } };
    ejs.push(copy);
  });
  d.ejercicios = ejs; state.rutinaPreviewDraft = d;
  markRutinaDirty(); renderRutinaPreview(); showToast('Seleccionados duplicados', 'success', 1800);
}
function bulkDeleteSelected(){
  const d = state.rutinaPreviewDraft || state.rutinaPreview || {};
  let ejs = Array.isArray(d.ejercicios)? d.ejercicios: [];
  const ids = new Set(Array.isArray(state.rutinaSelected) ? state.rutinaSelected.map(String) : []);
  ejs = ejs.filter(x => !ids.has(`${String(x.ejercicio_id)}#${Number(x.dia_semana||1)}#${Number(x.orden||1)}`));
  d.ejercicios = ejs; state.rutinaPreviewDraft = d; state.rutinaSelected = [];
  markRutinaDirty(); renderRutinaPreview(); showToast('Seleccionados eliminados', 'info', 1800);
}
function openBulkDayPopover(kind, anchor){
  try{ const prev = document.getElementById('rutina-bulk-popover'); if(prev) prev.remove(); }catch(_){ }
  const d = state.rutinaPreviewDraft || state.rutinaPreview || {};
  const diasMax = Math.max(2, Math.min(5, Number(d.dias_semana||3)));
  const pop = document.createElement('div'); pop.id='rutina-bulk-popover'; pop.style.position='absolute'; pop.style.background='#fff'; pop.style.border='1px solid #ddd'; pop.style.borderRadius='6px'; pop.style.padding='8px'; pop.style.boxShadow='0 4px 14px rgba(0,0,0,0.2)'; pop.style.zIndex='1001';
  const rect = anchor.getBoundingClientRect(); const modal = anchor.closest('.modal'); const mrect = modal ? modal.getBoundingClientRect() : {left:0, top:0};
  pop.style.left = `${rect.left - mrect.left + 8}px`; pop.style.top = `${rect.top - mrect.top + 20}px`;
  const sel = document.createElement('select'); sel.style.marginRight='8px'; for(let i=1;i<=diasMax;i++){ const opt=document.createElement('option'); opt.value=String(i); opt.textContent=`Día ${i}`; sel.appendChild(opt); }
  const ok = document.createElement('button'); ok.className='btn'; ok.textContent= kind==='move' ? 'Mover' : 'Duplicar'; ok.onclick = () => { const dest = Number(sel.value||1)||1; if(kind==='move') bulkMoveSelected(dest); else bulkDuplicateSelected(dest); try{ pop.remove(); }catch(_){ } };
  const cancel = document.createElement('button'); cancel.className='btn secondary'; cancel.textContent='Cancelar'; cancel.style.marginLeft='6px'; cancel.onclick = () => { try{ pop.remove(); }catch(_){ } };
  pop.appendChild(sel); pop.appendChild(ok); pop.appendChild(cancel);
  const cont = document.getElementById('modal-rutina-preview'); if(cont){ cont.appendChild(pop); } else { document.body.appendChild(pop); }
}

function markRutinaDirty(){
  state.rutinaPreviewDirty = true;
  try{ const st = document.getElementById('rutina-preview-status'); if(st) st.textContent = 'Editado'; }catch(_){ }
  try { if(state.rutinaAutoSaveImmediateTimer){ clearTimeout(state.rutinaAutoSaveImmediateTimer); } } catch(_){ }
  try {
    state.rutinaAutoSaveImmediateTimer = setTimeout(() => { try{ autoSaveRutinaDraft(); }catch(_){ } }, 800);
  } catch(_){ }
}
function ensureRutinaAutoSave(){
  try{ if(state.rutinaAutoSaveTimer) return; }catch(_){ }
  state.rutinaAutoSaveTimer = setInterval(autoSaveRutinaDraft, 5000);
}
function stopRutinaAutoSave(){ try{ if(state.rutinaAutoSaveTimer){ clearInterval(state.rutinaAutoSaveTimer); state.rutinaAutoSaveTimer = null; } }catch(_){ } }
async function autoSaveRutinaDraft(){
  try{
    if(!state.rutinaPreviewDirty) return;
    const d = state.rutinaPreviewDraft || state.rutinaPreview || {};
    if(!d || !d.id) return; // solo auto-guardar para rutinas existentes
    try{ const st = document.getElementById('rutina-preview-status'); if(st) st.textContent = 'Guardando…'; }catch(_){ }
    const payload = {
      nombre_rutina: (document.getElementById('rutina-preview-nombre')||{}).value || (d.nombre_rutina||''),
      descripcion: (document.getElementById('rutina-preview-descripcion')||{}).value || d.descripcion || null,
      dias_semana: Math.max(2, Math.min(5, Number((document.getElementById('rutina-preview-dias')||{}).value || d.dias_semana || 3))),
      categoria: d.categoria || 'general',
      ejercicios: (Array.isArray(d.ejercicios)? d.ejercicios: []).map(x => ({ ejercicio_id: Number(x.ejercicio_id), dia_semana: Number(x.dia_semana||1), series: x.series, repeticiones: x.repeticiones, orden: Number(x.orden||1) }))
    };
    const putRes = await fetch(`/api/rutinas/${d.id}`, { method:'PUT', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(payload) });
    if(putRes.ok){
      state.rutinaPreviewDirty = false; state.lastAutoSaveTs = Date.now();
      try{ const st = document.getElementById('rutina-preview-status'); if(st) st.textContent = 'Guardado'; }catch(_){ }
      try{ updateRutinaPDFPreview(); }catch(_){ }
    } else {
      try{ const st = document.getElementById('rutina-preview-status'); if(st) st.textContent = 'Error al guardar'; }catch(_){ }
    }
  }catch(_){ /* silencioso */ }
}

// Descarga directa de Excel desde la vista previa (sin modal)
async function directExportExcelFromPreview(){
  try{
    const d = state.rutinaPreviewDraft || state.rutinaPreview || {};
    if(!d || !d.id){ showToast('Primero guarda o crea la rutina', 'warning', 3000); return; }
    const payload = {
      nombre_rutina: (document.getElementById('rutina-preview-nombre')||{}).value || (d.nombre_rutina||''),
      descripcion: (document.getElementById('rutina-preview-descripcion')||{}).value || d.descripcion || null,
      dias_semana: Math.max(2, Math.min(5, Number((document.getElementById('rutina-preview-dias')||{}).value || d.dias_semana || 3))),
      categoria: d.categoria || 'general',
      ejercicios: (Array.isArray(d.ejercicios)? d.ejercicios: []).map(x => ({ ejercicio_id: Number(x.ejercicio_id), dia_semana: Number(x.dia_semana||1), series: x.series, repeticiones: x.repeticiones, orden: Number(x.orden||1) }))
    };
    const putRes = await fetch(`/api/rutinas/${d.id}`, { method:'PUT', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(payload) });
    const putData = await putRes.json().catch(()=>({})); if(!putRes.ok){ showToast(putData.detail || putData.error || 'No se pudo guardar antes de exportar', 'error', 4500); return; }
    const weeks = Math.max(1, Math.min(4, Number((document.getElementById('rutina-preview-semanas')||{}).value || 1)));
    const url = `/api/rutinas/${d.id}/export/excel?weeks=${encodeURIComponent(String(weeks))}`;
    const r = await fetch(url);
    if(!r.ok){ let msg = `Error ${r.status}`; try{ const err = await r.json(); msg = err.detail || err.error || msg; }catch(_){ } showToast(msg, 'error', 4500); return; }
    const blob = await r.blob();
    const fname2 = (d.nombre_rutina || d.nombre || 'rutina') + '.xlsx';
    const dlUrl = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = dlUrl; a.download = fname2; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(dlUrl);
    showToast('Excel descargado', 'success', 2500);
  }catch(_){ showToast('No se pudo exportar Excel', 'error', 4500); }
}

// Previsualización PDF integrada mediante iframe
async function updateRutinaPDFPreview(){
  try{
    const cont = document.getElementById('rutina-preview-pdf'); const frame = document.getElementById('rutina-preview-frame'); const empty = document.getElementById('rutina-preview-pdf-empty'); const statusEl = document.getElementById('rutina-preview-pdf-status');
    if(!cont || !frame || !empty) return;
    const d = state.rutinaPreviewDraft || state.rutinaPreview || {};
    if(!d || !d.id){ empty.style.display='block'; frame.style.display='none'; return; }
    const weeks = Math.max(1, Math.min(4, Number((document.getElementById('rutina-preview-semanas')||{}).value || 1)));
    const urlP = `/api/rutinas/${d.id}/export/pdf?weeks=${encodeURIComponent(String(weeks))}&ts=${Date.now()}#toolbar=0&navpanes=0`;
    empty.style.display='none';
    if(statusEl){ statusEl.textContent = 'Actualizando vista previa…'; statusEl.style.display='block'; }
    frame.style.display='block';
    try{ frame.onload = () => { try{ if(statusEl){ statusEl.textContent = 'Vista previa actualizada'; setTimeout(() => { statusEl.style.display='none'; }, 900); } }catch(_){ } }; }catch(_){ }
    frame.src = urlP;
    // Adjuntar zoom con rueda
    try{ attachWheelZoom('rutina-preview-pdf', 'rutina-preview-frame'); }catch(_){ }
  }catch(_){ const empty = document.getElementById('rutina-preview-pdf-empty'); const frame = document.getElementById('rutina-preview-frame'); if(empty && frame){ empty.style.display='block'; frame.style.display='none'; } }
}
// Zoom con rueda para iframes PDF (aplica escala CSS al iframe)
function attachWheelZoom(containerId, frameId){
  try {
    const cont = document.getElementById(containerId);
    const frame = document.getElementById(frameId);
    if(!cont || !frame) return;
    // Asegurar comportamiento correcto
    cont.style.overflow = cont.style.overflow || 'auto';
    frame.style.transformOrigin = frame.style.transformOrigin || 'center top';
    if(!state._wheelZoom) state._wheelZoom = {};
    if(!state._wheelZoomBound) state._wheelZoomBound = new Set();
    if(!state._wheelZoom[frameId]) state._wheelZoom[frameId] = { scale: 1.0 };
    if(state._wheelZoomBound.has(frameId)) return;
    const zoom = state._wheelZoom[frameId];
    cont.addEventListener('wheel', (ev) => {
      try {
        if(ev.ctrlKey) return; // Mantener zoom nativo del navegador con Ctrl
        ev.preventDefault();
        const delta = ev.deltaY < 0 ? 0.1 : -0.1;
        const next = Math.max(0.5, Math.min(3.0, (zoom.scale || 1.0) + delta));
        zoom.scale = next;
        const rect = cont.getBoundingClientRect();
        const ox = (ev.clientX - rect.left);
        const oy = (ev.clientY - rect.top);
        frame.style.transformOrigin = `${ox}px ${oy}px`;
        frame.style.transform = `scale(${zoom.scale})`;
      } catch(_){ /* noop */ }
    }, { passive: false });
    state._wheelZoomBound.add(frameId);
  } catch(_){ }
}
    async function openRutinaPreview(id){
      try{
        // Asegurar ejercicios cargados para los selects de agregar
        async function ensureEjerciciosLoaded(){
          if(Array.isArray(state.ejercicios) && state.ejercicios.length){ return; }
          try{
            const r = await fetch('/api/ejercicios', { headers:{ 'Accept':'application/json' } });
            if(r.status === 401){ showToast('Acceso restringido; inicie sesión en Gestión.', 'error', 4500); try{ window.location.href='/gestion/login'; }catch(e){} return; }
            const arr = await r.json().catch(()=>[]);
            state.ejercicios = Array.isArray(arr) ? arr : [];
          }catch(_){ state.ejercicios = []; }
        }
        await ensureEjerciciosLoaded();
        if(id != null){
          const res = await fetch(`/api/rutinas/${id}`, { headers:{ 'Accept':'application/json' } });
          if(res.status === 401){ showToast('Acceso restringido; inicie sesión en Gestión.', 'error', 4500); try{ window.location.href='/gestion/login'; }catch(e){} return; }
          const data = await res.json().catch(() => ({})); if(!res.ok){ showToast(data.detail || data.error || 'No se pudo cargar rutina', 'error', 4500); return; }
          state.rutinaPreview = data; state.rutinaPreviewDraft = _deepCopy(data);
          const nameEl = document.getElementById('rutina-preview-nombre'); if(nameEl) nameEl.value = (data.nombre_rutina || data.nombre || '') || '';
          const descEl = document.getElementById('rutina-preview-descripcion'); if(descEl) descEl.value = data.descripcion || '';
          const diasEl = document.getElementById('rutina-preview-dias'); if(diasEl) diasEl.value = String(Math.max(2, Math.min(5, Number(data.dias_semana||3))));
          const catEl = document.getElementById('rutina-preview-categoria'); if(catEl){
            const isPlantilla = (data.usuario_id == null) || (state.activeRutinaTab === 'plantillas');
            catEl.value = String(isPlantilla ? 'general' : (data.categoria || 'general'));
            catEl.disabled = !!isPlantilla;
            // Ocultar la tabla de ejercicios en rutinas de usuario (solo mostrar en plantillas)
            try{
              const excelTable = document.getElementById('rutina-preview-excel');
              if(excelTable){ excelTable.style.display = isPlantilla ? '' : 'none'; }
            }catch(_){ }
          }
          refreshPreviewDayOptions(Number(diasEl ? diasEl.value : 3));
        } else {
          const base = { id: null, usuario_id: null, nombre_rutina: '', descripcion: '', dias_semana: 3, categoria: 'general', ejercicios: [] };
          state.rutinaPreview = base; state.rutinaPreviewDraft = _deepCopy(base);
          const nameEl = document.getElementById('rutina-preview-nombre'); if(nameEl) nameEl.value = '';
          const descEl = document.getElementById('rutina-preview-descripcion'); if(descEl) descEl.value = '';
          const diasEl = document.getElementById('rutina-preview-dias'); if(diasEl) diasEl.value = '3';
          const catEl = document.getElementById('rutina-preview-categoria'); if(catEl){ catEl.value = 'general'; catEl.disabled = true; }
          refreshPreviewDayOptions(Number(diasEl ? diasEl.value : 3));
        }
        // Asegurar que los ejercicios estén cargados antes de poblar filtros y select
        (async () => {
          try {
            if(!Array.isArray(state.ejercicios) || state.ejercicios.length === 0){ await loadEjercicios(); }
          } catch(_){ }
          populateEjercicioFilters();
          const qvInit = (document.getElementById('rutina-preview-ejercicio-search')||{}).value || '';
          filterEjerciciosForPreview(qvInit);
          populateEjercicioSelectForPreview();
          renderRutinaPreview();
        })();
        openModal('modal-rutina-preview');
        try{ const st = document.getElementById('rutina-preview-status'); if(st) st.textContent=''; const ps = document.getElementById('rutina-preview-pdf-status'); if(ps) ps.style.display='none'; }catch(_){ }
        ensureRutinaAutoSave();
        // Colapsar inputs por defecto y primera carga de PDF
        try{
          const adv = document.getElementById('rutina-preview-advanced'); const btnPrevToggle = document.getElementById('rutina-preview-toggle-advanced');
          if(adv){ adv.style.display = 'none'; state.rutinaPreviewAdvancedHidden = true; }
          if(btnPrevToggle) btnPrevToggle.textContent = 'Mostrar opciones avanzadas';
        }catch(_){ }
        try{ updateRutinaPDFPreview(); }catch(_){ }
        // Bind inline once modal opens
        const closeBtn = document.getElementById('rutina-preview-close');
        const cancelBtn = document.getElementById('rutina-preview-cancel');
        const fApply = document.getElementById('rutina-preview-float-apply');
        function onKeyDown(ev){
          try{
            if(ev.key === 'Escape'){ ev.preventDefault(); closeModal('modal-rutina-preview'); cleanupKeys(); }
            else if((ev.ctrlKey || ev.metaKey) && String(ev.key||'').toLowerCase() === 's'){ ev.preventDefault(); const saveBtn = document.getElementById('rutina-preview-save'); if(saveBtn){ saveBtn.click(); } }
            else if(ev.key === 'Enter'){
              const float = document.getElementById('rutina-preview-float'); if(float && float.style.display === 'block' && fApply){ ev.preventDefault(); fApply.click(); }
            }
          }catch(_){ }
        }
        function cleanupKeys(){ document.removeEventListener('keydown', onKeyDown); }
        document.addEventListener('keydown', onKeyDown);
        if(closeBtn) closeBtn.onclick = async () => {
          try {
            const float = document.getElementById('rutina-preview-float');
            if(float && float.style.display === 'block') { try{ applyRutinaPreviewFloat(true); }catch(_){ } }
            if(state.rutinaPreviewDirty){ try{ await autoSaveRutinaDraft(); }catch(_){ } }
          } catch(_){ }
          cleanupKeys(); stopRutinaAutoSave(); closeModal('modal-rutina-preview');
        };
        if(cancelBtn) cancelBtn.onclick = async () => {
          try {
            const float = document.getElementById('rutina-preview-float');
            if(float && float.style.display === 'block') { try{ applyRutinaPreviewFloat(true); }catch(_){ } }
            if(state.rutinaPreviewDirty){ try{ await autoSaveRutinaDraft(); }catch(_){ } }
          } catch(_){ }
          cleanupKeys(); stopRutinaAutoSave(); closeModal('modal-rutina-preview');
        };
        const searchEl = document.getElementById('rutina-preview-ejercicio-search'); if(searchEl){
          const doFilter = () => { filterEjerciciosForPreview(searchEl.value || ''); populateEjercicioSelectForPreview(); };
          let qTimer = null;
          const debounced = () => { try{ if(qTimer) clearTimeout(qTimer); }catch(_){ }
            qTimer = setTimeout(() => { try{ doFilter(); }catch(_){ } }, 200);
          };
          searchEl.oninput = debounced;
          searchEl.onkeyup = debounced;
        }
        const grpSel = document.getElementById('rutina-preview-filter-group'); if(grpSel){ grpSel.onchange = () => { state.ejFilter = Object.assign({ q:'', group:'', objetivo:'' }, state.ejFilter||{}); state.ejFilter.group = String(grpSel.value||''); const qv = (document.getElementById('rutina-preview-ejercicio-search')||{}).value || ''; filterEjerciciosForPreview(qv); populateEjercicioSelectForPreview(); }; }
        const objSel = document.getElementById('rutina-preview-filter-objetivo'); if(objSel){ objSel.onchange = () => { state.ejFilter = Object.assign({ q:'', group:'', objetivo:'' }, state.ejFilter||{}); state.ejFilter.objetivo = String(objSel.value||''); const qv = (document.getElementById('rutina-preview-ejercicio-search')||{}).value || ''; filterEjerciciosForPreview(qv); populateEjercicioSelectForPreview(); }; }
        const addBtn = document.getElementById('rutina-preview-add'); if(addBtn) addBtn.onclick = () => {
          const esel = document.getElementById('rutina-preview-ejercicio'); const dsel = document.getElementById('rutina-preview-dia');
          const eid = esel ? (esel.value||'') : ''; const dia = dsel ? Number(dsel.value||'1') : 1;
          if(!eid) { showToast('Selecciona ejercicio', 'warning', 2500); return; }
          const d = state.rutinaPreviewDraft || state.rutinaPreview || {};
          const ejs = Array.isArray(d.ejercicios) ? d.ejercicios : [];
          const destItems = ejs.filter(x => Number(x.dia_semana||1) === Number(dia));
          if(destItems.length >= 8){ showToast('Máximo 8 ejercicios por día', 'warning', 2500); return; }
          const existsInDay = destItems.some(x => String(x.ejercicio_id) === String(eid));
          if(existsInDay){ showToast('El ejercicio ya está en este día', 'info', 2500); return; }
          const baseOrder = destItems.length ? Math.max(...destItems.map(x => Number(x.orden||1))) : 0;
          const ejMeta = (state.ejercicios||[]).find(x => String(x.id)===String(eid)) || { id: Number(eid) };
          ejs.push({ ejercicio_id: Number(eid), dia_semana: Number(dia), series: 3, repeticiones: 10, orden: Number(baseOrder+1), ejercicio: ejMeta });
          d.ejercicios = ejs; state.rutinaPreviewDraft = d; renderRutinaPreview(); markRutinaDirty();
        };
        const diasSel = document.getElementById('rutina-preview-dias'); if(diasSel) diasSel.onchange = () => { const d = state.rutinaPreviewDraft || state.rutinaPreview || {}; d.dias_semana = Number(diasSel.value||3); state.rutinaPreviewDraft = d; refreshPreviewDayOptions(Number(diasSel.value||3)); renderRutinaPreview(); markRutinaDirty(); };
        const weeksSel = document.getElementById('rutina-preview-semanas'); if(weeksSel) weeksSel.onchange = () => {
          try{ updateRutinaPDFPreview(); }catch(_){ }
          // Sincronizar inputs semanales en el editor flotante si está abierto
          try {
            const float = document.getElementById('rutina-preview-float');
            if(float && float.style.display === 'block'){
              const weeks = Math.max(1, Math.min(4, Number(weeksSel.value || 1)));
              ['s1','s2','s3','s4'].forEach((id, i) => { const el = document.getElementById(`rutina-preview-float-${id}`); if(el){ el.style.display = (i < weeks) ? '' : 'none'; } });
              ['r1','r2','r3','r4'].forEach((id, i) => { const el = document.getElementById(`rutina-preview-float-${id}`); if(el){ el.style.display = (i < weeks) ? '' : 'none'; } });
            }
          } catch(_){ }
        };
        const catSel = document.getElementById('rutina-preview-categoria'); if(catSel) catSel.onchange = () => { const d = state.rutinaPreviewDraft || state.rutinaPreview || {}; d.categoria = String(catSel.value || 'general'); state.rutinaPreviewDraft = d; renderRutinaPreview(); markRutinaDirty(); };
        const nameEl2 = document.getElementById('rutina-preview-nombre'); if(nameEl2) nameEl2.oninput = () => { const d = state.rutinaPreviewDraft || state.rutinaPreview || {}; d.nombre_rutina = String(nameEl2.value || ''); state.rutinaPreviewDraft = d; markRutinaDirty(); };
        const descEl2 = document.getElementById('rutina-preview-descripcion'); if(descEl2) descEl2.oninput = () => { const d = state.rutinaPreviewDraft || state.rutinaPreview || {}; d.descripcion = String(descEl2.value || ''); state.rutinaPreviewDraft = d; markRutinaDirty(); };
        if(fApply) fApply.onclick = () => applyRutinaPreviewFloat(false);
        const fRemove = document.getElementById('rutina-preview-float-remove'); if(fRemove) fRemove.onclick = removeRutinaPreviewItem;
        const fClose = document.getElementById('rutina-preview-float-close'); if(fClose) fClose.onclick = () => applyRutinaPreviewFloat(true);
        const fDup = document.getElementById('rutina-preview-float-dup'); if(fDup) fDup.onclick = duplicateRutinaPreviewItem;
        const fUp = document.getElementById('rutina-preview-float-up'); if(fUp) fUp.onclick = () => reorderRutinaPreviewItem('up');
        const fDown = document.getElementById('rutina-preview-float-down'); if(fDown) fDown.onclick = () => reorderRutinaPreviewItem('down');
        // Barra de herramientas de selección y vista
        const selMode = document.getElementById('rutina-preview-select-mode'); if(selMode){ selMode.checked = !!state.rutinaSelectMode; selMode.onchange = () => { state.rutinaSelectMode = !!selMode.checked; renderRutinaPreview(); }; }
        const selAll = document.getElementById('rutina-preview-select-all'); if(selAll){ selAll.onclick = () => { const d = state.rutinaPreviewDraft || state.rutinaPreview || {}; const ejs = Array.isArray(d.ejercicios) ? d.ejercicios : []; state.rutinaSelected = ejs.map(x => `${String(x.ejercicio_id)}#${Number(x.dia_semana||1)}#${Number(x.orden||1)}`); renderRutinaPreview(); showToast('Todos seleccionados', 'info', 1500); }; }
        const bulkMoveBtn = document.getElementById('rutina-preview-bulk-move'); if(bulkMoveBtn){ bulkMoveBtn.onclick = (ev) => openBulkDayPopover('move', ev.currentTarget); }
        const bulkDupBtn = document.getElementById('rutina-preview-bulk-dup'); if(bulkDupBtn){ bulkDupBtn.onclick = (ev) => openBulkDayPopover('dup', ev.currentTarget); }
        const bulkDelBtn = document.getElementById('rutina-preview-bulk-delete'); if(bulkDelBtn){ bulkDelBtn.onclick = () => bulkDeleteSelected(); }
        const compactBtn = document.getElementById('rutina-preview-toggle-compact'); if(compactBtn){ compactBtn.onclick = () => { state.rutinaCompact = !state.rutinaCompact; renderRutinaPreview(); compactBtn.textContent = state.rutinaCompact ? 'Vista normal' : 'Vista compacta'; }; }
        const collapseBtn = document.getElementById('rutina-preview-collapse-days'); if(collapseBtn){ collapseBtn.onclick = () => {
          const d = state.rutinaPreviewDraft || state.rutinaPreview || {}; const diasMax = Math.max(2, Math.min(5, Number(d.dias_semana||3)));
          const collapsed = state.rutinaDayCollapsed || {}; let anyExpanded = false; for(let i=1;i<=diasMax;i++){ if(!collapsed[i]) { anyExpanded = true; break; } }
          const next = anyExpanded ? true : false; state.rutinaDayCollapsed = {}; for(let i=1;i<=diasMax;i++){ state.rutinaDayCollapsed[i] = next; }
          renderRutinaPreview();
          // Expandir PDF a ancho completo si todos los días están colapsados
          const cols = document.getElementById('rutina-preview-columns');
          const grid = document.getElementById('rutina-preview-grid');
          if(cols){ cols.style.gridTemplateColumns = next ? '1fr' : '1.5fr 1fr'; }
          if(grid){ grid.parentElement.style.display = next ? 'none' : ''; }
        }; }
        const advBtn = document.getElementById('rutina-preview-excel-advanced-btn');
        if(advBtn){
          advBtn.onclick = async () => {
            try{ await (window.loadSheetJSLib ? window.loadSheetJSLib() : Promise.resolve(false)); }catch(_){ }
            const cont = document.getElementById('rutina-preview-excel-advanced');
            const simple = document.getElementById('rutina-preview-excel');
            if(cont && simple){
              const showingAdv = cont.style.display === '';
              const nextShowAdv = !showingAdv;
              cont.style.display = nextShowAdv ? '' : 'none';
              simple.style.display = nextShowAdv ? 'none' : '';
              advBtn.textContent = nextShowAdv ? 'Vista simple' : 'Vista Excel (SheetJS)';
              if(nextShowAdv){ renderRutinaSheetJSView(); }
            }
          };
        }
        const saveBtn = document.getElementById('rutina-preview-save'); if(saveBtn) saveBtn.onclick = async () => {
          const d = state.rutinaPreviewDraft || state.rutinaPreview || {};
          const payloadBase = {
            nombre_rutina: (document.getElementById('rutina-preview-nombre')||{}).value || (d.nombre_rutina||''),
            descripcion: (document.getElementById('rutina-preview-descripcion')||{}).value || d.descripcion || null,
            dias_semana: Math.max(2, Math.min(5, Number((document.getElementById('rutina-preview-dias')||{}).value || d.dias_semana || 3))),
            categoria: ((d.usuario_id == null) || (state.activeRutinaTab==='plantillas')) ? 'general' : (d.categoria || 'general'),
            ejercicios: (Array.isArray(d.ejercicios)? d.ejercicios: []).map(x => ({ ejercicio_id: Number(x.ejercicio_id), dia_semana: Number(x.dia_semana||1), series: x.series, repeticiones: x.repeticiones, orden: Number(x.orden||1) }))
          };
          try{
            if(d.id){
              const res = await fetch(`/api/rutinas/${d.id}`, { method:'PUT', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(payloadBase) });
              const data = await res.json().catch(()=>({})); if(!res.ok){ showToast(data.detail || data.error || 'No se pudo guardar rutina', 'error', 4500); return; }
              closeModal('modal-rutina-preview'); cleanupKeys(); showToast('Rutina actualizada', 'success', 2500);
              if(state.activeRutinaTab==='plantillas') await loadRutinasPlantillas(); else await loadRutinas();
            } else {
              // Crear como plantilla (usuario_id null)
              const payload = Object.assign({}, payloadBase, { usuario_id: null });
              const res = await fetch('/api/rutinas', { method:'POST', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(payload) });
              const data = await res.json().catch(()=>({})); if(!res.ok){ showToast(data.detail || data.error || 'No se pudo crear plantilla', 'error', 4500); return; }
              closeModal('modal-rutina-preview'); cleanupKeys(); showToast('Plantilla creada', 'success', 2500); await loadRutinasPlantillas();
            }
          }catch(e){ showToast('Error de red al guardar rutina', 'error', 4500); }
        };
      }catch(e){ showToast('Error de red al cargar rutina', 'error', 4500); }
    }

    // Vista tipo Excel dentro del preview: render y edición en tiempo real
    function renderRutinaExcelView(){
      const table = document.querySelector('#rutina-preview-excel-table tbody'); if(!table) return;
      const d = state.rutinaPreviewDraft || state.rutinaPreview || {};
      const ejs = Array.isArray(d.ejercicios) ? d.ejercicios.slice() : [];
      ejs.sort((a,b) => (Number(a.dia_semana||1) - Number(b.dia_semana||1)) || (Number(a.orden||1) - Number(b.orden||1)));
      table.innerHTML = '';
      const fmtEdit = (val) => {
        if(val == null) return '';
        if(typeof val === 'string') return val;
        return String(val);
      };
      ejs.forEach(item => {
        const tr = document.createElement('tr'); tr.setAttribute('data-ej-id', String(item.ejercicio_id));
        tr.innerHTML = `
          <td>${Number(item.dia_semana||1)}</td>
          <td>${(item.ejercicio && item.ejercicio.nombre) ? String(item.ejercicio.nombre) : ('Ejercicio ' + item.ejercicio_id)}</td>
          <td contenteditable="true">${fmtEdit(item.series!=null?item.series:3)}</td>
          <td contenteditable="true">${fmtEdit(item.repeticiones!=null?item.repeticiones:10)}</td>
          <td>${Number(item.orden||1)}</td>`;
        table.appendChild(tr);
      });
      // Edición en tiempo real: actualizar series/reps al escribir
      const tbl = document.getElementById('rutina-preview-excel-table');
      if(tbl){
        tbl.oninput = (ev) => {
          const cell = ev.target.closest('td'); if(!cell) return;
          const row = cell.parentElement; const eid = row ? row.getAttribute('data-ej-id') : '';
          if(!eid) return;
          const tds = row.querySelectorAll('td');
          const rawS = (tds[2]?.textContent || '').trim();
          const rawR = (tds[3]?.textContent || '').trim();
          const parseField = (raw) => {
            if(raw.includes(',')){
              return raw.split(',').map(p => String(Math.max(1, Number(p.trim())||1))).join(',');
            }
            return Math.max(1, Number(raw)||1);
          };
          const series = parseField(rawS);
          const reps = parseField(rawR);
          const d2 = state.rutinaPreviewDraft || state.rutinaPreview || {};
          const ejs2 = Array.isArray(d2.ejercicios) ? d2.ejercicios : [];
          const it = ejs2.find(x => String(x.ejercicio_id) === String(eid)); if(it){ it.series = series; it.repeticiones = reps; }
          // Mantener la grilla sincronizada
          markRutinaDirty(); renderRutinaPreview();
        };
      }
    }

    // Vista avanzada con SheetJS (HTML de hoja de cálculo, sin progresión por semanas)
    async function renderRutinaSheetJSView(){
      const cont = document.getElementById('rutina-preview-excel-advanced'); if(!cont) return;
      // Asegurar librería
      try { if(!window.XLSX){ await (window.loadSheetJSLib ? window.loadSheetJSLib() : Promise.resolve(false)); } } catch(_){ }
      const d = state.rutinaPreviewDraft || state.rutinaPreview || {};
      const ejs = Array.isArray(d.ejercicios) ? d.ejercicios.slice() : [];
      ejs.sort((a,b) => (Number(a.dia_semana||1) - Number(b.dia_semana||1)) || (Number(a.orden||1) - Number(b.orden||1)));
      const aoa = [['Día','Ejercicio','Series','Repeticiones','Orden']];
      ejs.forEach(it => {
        aoa.push([
          Number(it.dia_semana||1),
          (it.ejercicio && it.ejercicio.nombre) ? String(it.ejercicio.nombre) : ('Ejercicio ' + it.ejercicio_id),
          Number(it.series||3),
          Number(it.repeticiones||10),
          Number(it.orden||1)
        ]);
      });
      if(window.XLSX){
        const ws = XLSX.utils.aoa_to_sheet(aoa);
        const html = XLSX.utils.sheet_to_html(ws, { id: 'rutina-sheetjs-html', editable: false });
        cont.innerHTML = html;
      } else {
        // Fallback manual sin SheetJS
        const table = document.createElement('table');
        table.id = 'rutina-sheetjs-html';
        const thead = document.createElement('thead');
        const trh = document.createElement('tr');
        ['Día','Ejercicio','Series','Repeticiones','Orden'].forEach(h => { const th=document.createElement('th'); th.textContent=h; trh.appendChild(th); });
        thead.appendChild(trh);
        const tbody = document.createElement('tbody');
        aoa.slice(1).forEach(row => {
          const tr = document.createElement('tr');
          row.forEach(val => { const td=document.createElement('td'); td.textContent=String(val); tr.appendChild(td); });
          tbody.appendChild(tr);
        });
        table.appendChild(thead); table.appendChild(tbody);
        cont.innerHTML = ''; cont.appendChild(table);
      }
      const tbl = cont.querySelector('table'); if(tbl){ tbl.style.width = 'max-content'; tbl.style.minWidth = '100%'; tbl.style.borderCollapse = 'collapse'; }
      const ths = cont.querySelectorAll('th, td'); ths.forEach(el => { el.style.padding = '10px'; el.style.borderBottom = '1px solid var(--border)'; el.style.textAlign = 'left'; });
    }

    // ===== Exportar Excel desde preview =====
    function openRutinaExportModal(){
      const d = state.rutinaPreviewDraft || state.rutinaPreview || {};
      if(!d || !d.id){ showToast('Guarda la rutina/plantilla antes de exportar', 'warning', 3500); return; }
      const fname = (d.nombre_rutina || d.nombre || 'rutina') + '.xlsx';
      const fEl = document.getElementById('rutina-export-filename'); if(fEl) fEl.value = fname;
      const tbody = document.querySelector('#rutina-export-table tbody'); if(tbody){
        const ejs = Array.isArray(d.ejercicios) ? d.ejercicios.slice() : [];
        ejs.sort((a,b) => (Number(a.dia_semana||1) - Number(b.dia_semana||1)) || (Number(a.orden||1) - Number(b.orden||1)));
        tbody.innerHTML = '';
        ejs.forEach(item => {
          const tr = document.createElement('tr');
          tr.setAttribute('data-ej-id', String(item.ejercicio_id));
          tr.innerHTML = `
            <td>${Number(item.dia_semana||1)}</td>
            <td>${(item.ejercicio && item.ejercicio.nombre) ? String(item.ejercicio.nombre) : ('Ejercicio ' + item.ejercicio_id)}</td>
            <td contenteditable="true">${(item.series!=null? (typeof item.series==='string'? item.series : String(item.series)) : '3')}</td>
            <td contenteditable="true">${(item.repeticiones!=null? (typeof item.repeticiones==='string'? item.repeticiones : String(item.repeticiones)) : '10')}</td>
            <td>${Number(item.orden||1)}</td>`;
          tbody.appendChild(tr);
        });
      }
      const c1 = document.getElementById('rutina-export-close'); if(c1) c1.onclick = () => closeModal('modal-rutina-export');
      const c2 = document.getElementById('rutina-export-close-btn'); if(c2) c2.onclick = () => closeModal('modal-rutina-export');
      const applyAllBtn = document.getElementById('rutina-export-apply-all');
      if(applyAllBtn){
        applyAllBtn.onclick = () => {
          const sVal = Number((document.getElementById('rutina-export-all-series')||{}).value || '');
          const rVal = Number((document.getElementById('rutina-export-all-reps')||{}).value || '');
          const tbody3 = document.querySelector('#rutina-export-table tbody');
          if(tbody3){
            Array.from(tbody3.querySelectorAll('tr')).forEach(tr => {
              const tds = tr.querySelectorAll('td');
              if(!isNaN(sVal) && sVal > 0){ const tdS = tds[2]; if(tdS) tdS.textContent = String(sVal); }
              if(!isNaN(rVal) && rVal > 0){ const tdR = tds[3]; if(tdR) tdR.textContent = String(rVal); }
            });
          }
          // Actualizar previsualización tras aplicar
          const prevBtn = document.getElementById('rutina-export-preview-btn'); if(prevBtn) prevBtn.click();
        };
      }
      // Helper: construir payload desde la tabla para guardar
      function buildPayloadFromTable(){
        const dInner = state.rutinaPreviewDraft || state.rutinaPreview || {};
        const tbody2 = document.querySelector('#rutina-export-table tbody');
        const rows = Array.from(tbody2 ? tbody2.querySelectorAll('tr') : []);
        const map = new Map();
        rows.forEach(tr => {
          const eid = tr.getAttribute('data-ej-id'); if(!eid) return;
          const tds = tr.querySelectorAll('td');
          const rawS = (tds[2]?.textContent || '').trim();
          const rawR = (tds[3]?.textContent || '').trim();
          const parseField = (raw) => {
            if(raw.includes(',')){
              return raw.split(',').map(p => String(Math.max(1, Number(p.trim())||1))).join(',');
            }
            return Math.max(1, Number(raw)||1);
          };
          const series = parseField(rawS);
          const reps = parseField(rawR);
          map.set(String(eid), { series, repeticiones: reps });
        });
        const ejs = Array.isArray(dInner.ejercicios) ? dInner.ejercicios : [];
        ejs.forEach(item => { const m = map.get(String(item.ejercicio_id)); if(m){ item.series = m.series; item.repeticiones = m.repeticiones; } });
        const payload = {
          nombre_rutina: (document.getElementById('rutina-preview-nombre')||{}).value || (dInner.nombre_rutina||''),
          descripcion: (document.getElementById('rutina-preview-descripcion')||{}).value || dInner.descripcion || null,
          dias_semana: Math.max(2, Math.min(5, Number((document.getElementById('rutina-preview-dias')||{}).value || dInner.dias_semana || 3))),
          categoria: dInner.categoria || 'general',
          ejercicios: ejs.map(x => ({ ejercicio_id: Number(x.ejercicio_id), dia_semana: Number(x.dia_semana||1), series: x.series, repeticiones: x.repeticiones, orden: Number(x.orden||1) }))
        };
        return { dInner, payload };
      }

      // Guardar cambios explícitamente
      const saveBtn = document.getElementById('rutina-export-save-btn'); if(saveBtn){
        saveBtn.onclick = async () => {
          try{
            const { dInner, payload } = buildPayloadFromTable();
            const putRes = await fetch(`/api/rutinas/${dInner.id}`, { method:'PUT', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(payload) });
            const putData = await putRes.json().catch(()=>({})); if(!putRes.ok){ showToast(putData.detail || putData.error || 'No se pudo guardar', 'error', 4500); return; }
            showToast('Cambios guardados', 'success', 2000);
          }catch(_){ showToast('Error guardando cambios', 'error', 4500); }
        };
      }

      // Previsualización literal: guarda y renderiza desde backend XLSX
      async function updateExcelPreview(){
        try{
          const previewEl = document.getElementById('rutina-export-preview'); if(!previewEl) return;
          const { dInner, payload } = buildPayloadFromTable();
          // Guardar cambios para asegurar que el XLSX refleje exactamente la vista
          const putRes = await fetch(`/api/rutinas/${dInner.id}`, { method:'PUT', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(payload) });
          const putData = await putRes.json().catch(()=>({})); if(!putRes.ok){ showToast(putData.detail || putData.error || 'No se pudo guardar antes de previsualizar', 'error', 4500); return; }
          // Obtener XLSX del backend
          const weeks = Math.max(1, Math.min(4, Number((document.getElementById('rutina-export-weeks')||{}).value || 1)));
          const url = `/api/rutinas/${dInner.id}/export/excel?weeks=${encodeURIComponent(String(weeks))}`;
          const r = await fetch(url);
          if(!r.ok){ let msg = `Error ${r.status}`; try{ const err = await r.json(); msg = err.detail || err.error || msg; }catch(_){ } showToast(msg, 'error', 4500); return; }
          const blob = await r.blob();
          // Renderizar con SheetJS
          try{ await (window.loadSheetJSLib ? window.loadSheetJSLib() : Promise.resolve(false)); }catch(_){ }
          if(!window.XLSX){ previewEl.innerHTML = '<p class="muted">No se pudo cargar la librería de previsualización.</p>'; return; }
          const buf = await blob.arrayBuffer();
          let wb; try{ wb = XLSX.read(buf, { type:'array' }); }catch(_){ wb = null; }
          if(!wb || !wb.SheetNames || !wb.SheetNames.length){ previewEl.innerHTML = '<p class="muted">No se pudo interpretar el Excel.</p>'; return; }
          const ws = wb.Sheets[wb.SheetNames[0]];
          const html = XLSX.utils.sheet_to_html(ws, { id:'rutina-export-preview-table', editable:false });
          previewEl.innerHTML = html;
          const tbl = previewEl.querySelector('table'); if(tbl){ tbl.style.width = 'max-content'; tbl.style.minWidth = '100%'; tbl.style.borderCollapse = 'collapse'; }
          const cells = previewEl.querySelectorAll('th, td'); cells.forEach(el => { el.style.padding = '10px'; el.style.borderBottom = '1px solid var(--border)'; el.style.textAlign = 'left'; });
          showToast('Vista previa actualizada', 'success', 1200);
        }catch(_){ showToast('No se pudo generar la vista previa', 'error', 4500); }
      }

      const prevBtn = document.getElementById('rutina-export-preview-btn'); if(prevBtn){ prevBtn.onclick = updateExcelPreview; }
      const weeksEl = document.getElementById('rutina-export-weeks'); if(weeksEl){ weeksEl.onchange = updateExcelPreview; }
      const dBtn = document.getElementById('rutina-export-download'); if(dBtn){
        dBtn.onclick = async () => {
          try{
            const { dInner, payload } = buildPayloadFromTable();
            const putRes = await fetch(`/api/rutinas/${dInner.id}`, { method:'PUT', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(payload) });
            const putData = await putRes.json().catch(()=>({})); if(!putRes.ok){ showToast(putData.detail || putData.error || 'No se pudo guardar cambios antes de exportar', 'error', 4500); return; }
            // Exportar Excel desde backend (con selección de semanas)
            const weeks = Math.max(1, Math.min(4, Number((document.getElementById('rutina-export-weeks')||{}).value || 1)));
            const url = `/api/rutinas/${dInner.id}/export/excel?weeks=${encodeURIComponent(String(weeks))}`;
            const r = await fetch(url);
            if(!r.ok){ let msg = `Error ${r.status}`; try{ const err = await r.json(); msg = err.detail || err.error || msg; }catch(_){ } showToast(msg, 'error', 4500); return; }
            const blob = await r.blob();
            const fname2 = (document.getElementById('rutina-export-filename')||{}).value || ((dInner.nombre_rutina || dInner.nombre || 'rutina') + '.xlsx');
            const dlUrl = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = dlUrl; a.download = fname2;
            document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(dlUrl);
            showToast('Excel descargado', 'success', 2500);
            closeModal('modal-rutina-export');
          }catch(_){ showToast('No se pudo exportar Excel', 'error', 4500); }
        };
      }
      
      openModal('modal-rutina-export');
      // Opcional: cargar una previsualización inicial
      const prevBtn2 = document.getElementById('rutina-export-preview-btn'); if(prevBtn2){ prevBtn2.click(); }
    }

    function openRutinaBuilderNew(){
      // Abrir el builder en blanco para crear una plantilla nueva
      openRutinaPreview(null);
    }

    // ===== Rutinas por usuario =====
    async function loadRutinasPorUsuario(uid){
      const block = document.getElementById('rutinas-usuario-block'); const tbody = document.querySelector('#rutinas-usuario-table tbody');
      if(!block || !tbody){ return; }
      if(!uid){ block.style.display='none'; tbody.innerHTML=''; return; }
      try{
        const res = await fetch(`/api/rutinas?usuario_id=${encodeURIComponent(String(uid))}`, { headers:{ 'Accept':'application/json' } });
        const arr = await res.json().catch(()=>[]);
        tbody.innerHTML = '';
        (Array.isArray(arr)? arr: []).forEach(r => {
          const tr = document.createElement('tr'); tr.setAttribute('data-id', String(r.id));
          const acciones = `
            <button class="btn" data-action="preview" data-id="${r.id}">Abrir</button>
            <button class="btn" data-action="assign" data-id="${r.id}">Asignar</button>
            <button class="btn secondary" data-action="unassign" data-id="${r.id}">Desasignar</button>
            <button class="btn" data-action="delete" data-id="${r.id}">Eliminar</button>`;
          tr.innerHTML = `<td>${r.nombre_rutina || r.nombre || ''}</td><td>${r.dias_semana || ''}</td><td>${r.categoria || ''}</td><td>${r.activa ? 'Sí' : 'No'}</td><td>${acciones}</td>`;
          tr.addEventListener('click', (ev) => {
            const btn = ev.target.closest('button');
            if(btn){
              const action = btn.getAttribute('data-action'); const id = btn.getAttribute('data-id');
              if(action==='preview'){ if(id) openRutinaPreview(Number(id)); }
              else if(action==='assign'){ if(id) openAssignRutina(Number(id)); }
              else if(action==='unassign'){ if(id) openUnassignRutina(Number(id)); }
              else if(action==='delete'){ if(id) deleteRutina(Number(id)); }
            } else {
              // Seleccionar fila para actualizar panel lateral
              state.selectedRutina = r; updateRutinaSidePanel(r);
            }
          });
          tbody.appendChild(tr);
        });
        // Selección inicial para panel lateral
        if(Array.isArray(arr) && arr.length){
          state.selectedRutina = arr[0];
          updateRutinaSidePanel(arr[0]);
        } else {
          updateRutinaSidePanel(null);
        }
        block.style.display='';
      }catch(e){ block.style.display='none'; }
    }

    function updateRutinaSidePanel(r){
      const nombreEl = document.getElementById('rutina-side-nombre');
      const descEl = document.getElementById('rutina-side-descripcion');
      const btnEdit = document.getElementById('rutina-side-edit');
      const btnPrev = document.getElementById('rutina-side-preview');
      const btnDel = document.getElementById('rutina-side-delete');
      const btnAsn = document.getElementById('rutina-side-assign');
      const btnUn = document.getElementById('rutina-side-unassign');
      const none = '—';
      if(!nombreEl) return;
      if(r){
        nombreEl.textContent = r.nombre || r.nombre_rutina || none;
        descEl.textContent = r.descripcion || none;
        if(btnEdit) { btnEdit.disabled = false; btnEdit.textContent = 'Abrir'; btnEdit.onclick = () => openRutinaPreview(Number(r.id)); }
        if(btnPrev) { btnPrev.disabled = false; btnPrev.onclick = () => openRutinaPreview(Number(r.id)); }
        if(btnDel) { btnDel.disabled = false; btnDel.onclick = () => deleteRutina(r.id); }
        if(btnAsn) {
          btnAsn.disabled = false;
          if(state.activeRutinaTab === 'plantillas'){
            btnAsn.onclick = () => openAssignPlantilla(r.id);
            btnAsn.textContent = 'Asignar a usuario';
          } else {
            btnAsn.onclick = () => openAssignRutina(r.id);
            btnAsn.textContent = 'Asignar';
          }
        }
        if(btnUn) {
          const canUnassign = r.usuario_id != null;
          btnUn.disabled = !canUnassign;
          btnUn.onclick = canUnassign ? (() => openUnassignRutina(r.id)) : null;
        }
      } else {
        nombreEl.textContent = none;
        descEl.textContent = none;
        if(btnEdit) { btnEdit.disabled = true; btnEdit.onclick = null; }
        if(btnPrev) { btnPrev.disabled = true; btnPrev.onclick = null; }
        if(btnDel) { btnDel.disabled = true; btnDel.onclick = null; }
        if(btnAsn) { btnAsn.disabled = true; btnAsn.onclick = null; }
        if(btnUn) { btnUn.disabled = true; btnUn.onclick = null; }
      }
      // Bind de captura para ajustar la asignación según pestaña activa (una sola vez)
      const asnEl = document.getElementById('rutina-side-assign');
      if(asnEl && !state.__assignHandlerBound){
        asnEl.addEventListener('click', function(ev){
          ev.stopImmediatePropagation();
          if(state.selectedRutina){
            if(state.activeRutinaTab === 'plantillas'){ openAssignPlantilla(state.selectedRutina.id); }
            else { openAssignRutina(state.selectedRutina.id); }
          }
        }, true);
        state.__assignHandlerBound = true;
      }
    }
    function updateEjerciciosTable(){
      const tbody = document.querySelector('#ejercicios-table tbody');
      if(!tbody) return;
      tbody.innerHTML = '';
      const items = Array.isArray(state.ejercicios) ? state.ejercicios : [];
      items.forEach((e, idx) => {
        const tr = document.createElement('tr');
        tr.setAttribute('data-index', String(idx));
        tr.setAttribute('data-id', String(e.id || ''));
        tr.innerHTML = `
          <td>${e.nombre || ''}</td>
          <td>${e.grupo_muscular || ''}</td>
          <td>${e.objetivo || ''}</td>
          <td>${e.descripcion || ''}</td>
          <td>
            <button class="btn secondary" data-action="edit" data-index="${idx}" data-id="${e.id}">Editar</button>
            <button class="btn" data-action="delete" data-id="${e.id}">Eliminar</button>
          </td>`;
        tr.addEventListener('click', (ev) => {
          const isBtn = !!ev.target.closest('button');
          if(isBtn) return;
          state.selectedEjercicio = e;
          updateEjercicioSidePanel(e);
        });
        tbody.appendChild(tr);
      });
      const countEl = document.getElementById('ejercicios-count'); if(countEl) countEl.textContent = `${items.length} ejercicios`;
    }

    function bindEjerciciosEvents(){
      const btnRefresh = document.getElementById('ejercicios-refresh'); if(btnRefresh) btnRefresh.addEventListener('click', loadEjercicios);
      const qInput = document.getElementById('ejercicios-q'); if(qInput) qInput.addEventListener('keydown', (e) => { if(e.key === 'Enter') loadEjercicios(); });
      const objSel = document.getElementById('ejercicios-objetivo'); if(objSel) objSel.addEventListener('change', loadEjercicios);
      const grpSel = document.getElementById('ejercicios-grupo'); if(grpSel) grpSel.addEventListener('change', loadEjercicios);
      const btnNew = document.getElementById('ejercicios-new'); if(btnNew) btnNew.addEventListener('click', () => showEjercicioForm(null));

      const tbody = document.querySelector('#ejercicios-table tbody');
      if(tbody){
        tbody.addEventListener('click', (ev) => {
          const btn = ev.target.closest('button'); if(!btn) return;
          const action = btn.getAttribute('data-action');
          if(action === 'edit'){
            const idx = parseInt(btn.getAttribute('data-index') || '0', 10);
            const row = (state.ejercicios || [])[idx];
            showEjercicioForm(row || null);
          } else if(action === 'delete'){
            const id = btn.getAttribute('data-id');
            deleteEjercicio(id);
          }
        });
      }

      const btnSave = document.getElementById('save-ejercicio'); if(btnSave) btnSave.addEventListener('click', saveEjercicio);
      const btnCancel = document.getElementById('cancel-ejercicio'); if(btnCancel) btnCancel.addEventListener('click', hideEjercicioForm);
      const btnClose = document.getElementById('close-modal-ejercicio'); if(btnClose) btnClose.addEventListener('click', hideEjercicioForm);

      const delCancel = document.getElementById('ejercicio-delete-cancel'); if(delCancel) delCancel.addEventListener('click', () => closeModal('modal-ejercicio-delete'));
      const delConfirm = document.getElementById('ejercicio-delete-confirm'); if(delConfirm) delConfirm.addEventListener('click', confirmDeleteEjercicio);
      const delClose = document.getElementById('ejercicio-delete-close'); if(delClose) delClose.addEventListener('click', () => closeModal('modal-ejercicio-delete'));

      // Extras modal bindings
      const btnEditExtras = document.getElementById('ejercicio-side-edit-extras'); if(btnEditExtras) btnEditExtras.addEventListener('click', () => { if(state.selectedEjercicio) openExtrasModal(state.selectedEjercicio); });
      const btnSaveExtras = document.getElementById('save-extras'); if(btnSaveExtras) btnSaveExtras.addEventListener('click', saveExtras);
      const btnCancelExtras = document.getElementById('cancel-extras'); if(btnCancelExtras) btnCancelExtras.addEventListener('click', hideExtrasModal);
      const btnCloseExtras = document.getElementById('close-modal-extras'); if(btnCloseExtras) btnCloseExtras.addEventListener('click', hideExtrasModal);
    }

    function showEjercicioForm(e){
      state.editingEjercicioId = e && e.id ? Number(e.id) : null;
      openModal('modal-ejercicio-form');
      const nombreEl = document.getElementById('ejercicio-nombre'); if(nombreEl) nombreEl.value = e && e.nombre ? String(e.nombre) : '';
      const grupoEl = document.getElementById('ejercicio-grupo'); if(grupoEl) grupoEl.value = e && e.grupo_muscular ? String(e.grupo_muscular) : '';
      const objEl = document.getElementById('ejercicio-objetivo'); if(objEl) objEl.value = e && e.objetivo ? String(e.objetivo) : 'general';
      const descEl = document.getElementById('ejercicio-descripcion'); if(descEl) descEl.value = e && e.descripcion ? String(e.descripcion) : '';
    }
    function hideEjercicioForm(){ closeModal('modal-ejercicio-form'); }

    async function saveEjercicio(){
      const nombre = (document.getElementById('ejercicio-nombre') || {}).value || '';
      const grupo_muscular = (document.getElementById('ejercicio-grupo') || {}).value || '';
      const objetivo = (document.getElementById('ejercicio-objetivo') || {}).value || 'general';
      const descripcion = (document.getElementById('ejercicio-descripcion') || {}).value || '';
      if(!nombre.trim()){ showToast('El nombre es obligatorio', 'warning', 3000); return; }
      const body = { nombre, grupo_muscular, objetivo, descripcion };
      let url = '/api/ejercicios'; let method = 'POST';
      if(state.editingEjercicioId){ url = `/api/ejercicios/${state.editingEjercicioId}`; method = 'PUT'; }
      try{
        const res = await fetch(url, { method, headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(body) });
        if(res.status === 401){ showToast('Acceso restringido; inicie sesión en Gestión.', 'error', 4500); try{ window.location.href = '/gestion/login'; }catch(e){} return; }
        const data = await res.json().catch(() => ({}));
        if(!res.ok){ showToast(data.detail || data.error || 'No se pudo guardar', 'error', 4500); return; }
        closeModal('modal-ejercicio-form');
        showToast('Ejercicio guardado', 'success', 2500);
        await loadEjercicios();
      }catch(e){ showToast('Error de red al guardar', 'error', 4500); }
    }

    function deleteEjercicio(id){
      if(!id){ showToast('Ejercicio no encontrado', 'warning', 3000); return; }
      state.deleteEjercicioId = Number(id);
      openModal('modal-ejercicio-delete');
    }
    async function confirmDeleteEjercicio(){
      const id = state.deleteEjercicioId; if(!id) return;
      try{
        const res = await fetch(`/api/ejercicios/${id}`, { method:'DELETE', headers:{ 'Accept':'application/json' } });
        if(res.status === 401){ showToast('Acceso restringido; inicie sesión en Gestión.', 'error', 4500); try{ window.location.href = '/gestion/login'; }catch(e){} return; }
        const data = await res.json().catch(() => ({}));
        if(!res.ok){ showToast(data.detail || data.error || 'No se pudo eliminar', 'error', 4500); return; }
        closeModal('modal-ejercicio-delete');
        showToast('Ejercicio eliminado', 'success', 2500);
        await loadEjercicios();
      }catch(e){ showToast('Error de red al eliminar', 'error', 4500); }
    }

    // ===== Ejercicios: extras (equipamiento y variantes) =====
    function parseExtrasFromDescripcion(text){
      const lines = String(text || '').split(/\r?\n/);
      const equipamiento = []; const variantes = []; const base = [];
      for(const l of lines){
        const s = String(l).trim();
        if(/^Equipamiento:/i.test(s)){
          const rest = s.replace(/^Equipamiento:/i, '').trim();
          const items = rest.split(/[;,]/).map(x => x.trim()).filter(Boolean);
          equipamiento.push(...items);
        } else if(/^Variantes:/i.test(s)){
          const rest = s.replace(/^Variantes:/i, '').trim();
          const items = rest.split(/[;,]/).map(x => x.trim()).filter(Boolean);
          variantes.push(...items);
        } else {
          base.push(l);
        }
      }
      return { baseDescripcion: base.join('\n').trim(), equipamiento, variantes };
    }
    function composeDescripcionWithExtras(base, equip, vars){
      const parts = [String(base || '').trim()];
      const eq = Array.isArray(equip) ? equip.filter(Boolean) : [];
      const va = Array.isArray(vars) ? vars.filter(Boolean) : [];
      if(eq.length) parts.push('Equipamiento: ' + eq.join('; '));
      if(va.length) parts.push('Variantes: ' + va.join('; '));
      return parts.filter(Boolean).join('\n\n').trim();
    }
    function openExtrasModal(e){
      if(!e){ showToast('Selecciona un ejercicio', 'warning', 3000); return; }
      const extras = parseExtrasFromDescripcion(e.descripcion || '');
      const eqEl = document.getElementById('extras-equipamiento'); if(eqEl) eqEl.value = (extras.equipamiento || []).join('\n');
      const varEl = document.getElementById('extras-variantes'); if(varEl) varEl.value = (extras.variantes || []).join('\n');
      openModal('modal-ejercicio-extras');
    }
    function hideExtrasModal(){ closeModal('modal-ejercicio-extras'); }
    async function saveExtras(){
      const e = state.selectedEjercicio; if(!e){ showToast('Selecciona un ejercicio', 'warning', 3000); return; }
      const eqRaw = (document.getElementById('extras-equipamiento') || {}).value || '';
      const varRaw = (document.getElementById('extras-variantes') || {}).value || '';
      const equipos = eqRaw.split(/\r?\n|;/).map(x => x.trim()).filter(Boolean);
      const variantes = varRaw.split(/\r?\n|;/).map(x => x.trim()).filter(Boolean);
      const parsed = parseExtrasFromDescripcion(e.descripcion || '');
      const descripcion = composeDescripcionWithExtras(parsed.baseDescripcion || '', equipos, variantes);
      const body = { nombre: e.nombre || '', grupo_muscular: e.grupo_muscular || '', objetivo: e.objetivo || 'general', descripcion };
      try{
        const res = await fetch(`/api/ejercicios/${e.id}`, { method: 'PUT', headers: { 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(body) });
        if(res.status === 401){ showToast('Acceso restringido; inicie sesión en Gestión.', 'error', 4500); try{ window.location.href = '/gestion/login'; }catch(_e){} return; }
        const data = await res.json().catch(() => ({}));
        if(!res.ok){ showToast(data.detail || data.error || 'No se pudo guardar extras', 'error', 4500); return; }
        hideExtrasModal();
        showToast('Extras actualizados', 'success', 2500);
        await loadEjercicios();
      }catch(_){ showToast('Error de red al guardar extras', 'error', 4500); }
    }

    function updateEjercicioSidePanel(e){
      const nombreEl = document.getElementById('ejercicio-side-nombre');
      const objEl = document.getElementById('ejercicio-side-objetivo');
      const grpEl = document.getElementById('ejercicio-side-grupo');
      const descEl = document.getElementById('ejercicio-side-descripcion');
      const tipsEl = document.getElementById('ejercicio-side-tips');
      const eqEl = document.getElementById('ejercicio-side-equipos');
      const varEl = document.getElementById('ejercicio-side-variantes');
      const btnEdit = document.getElementById('ejercicio-side-edit');
      const btnDel = document.getElementById('ejercicio-side-delete');
      const none = '—';
      if(!nombreEl) return;
      if(e){
        nombreEl.textContent = e.nombre || none;
        objEl.textContent = e.objetivo || none;
        grpEl.textContent = e.grupo_muscular || none;
        descEl.textContent = e.descripcion || none;
        tipsEl.innerHTML = renderList(ejercicioTips(e.objetivo, e.grupo_muscular));
        const extras = parseExtrasFromDescripcion(e.descripcion || '');
        const equiposList = (extras.equipamiento && extras.equipamiento.length) ? extras.equipamiento : ejercicioEquipos(e.grupo_muscular);
        const variantesList = (extras.variantes && extras.variantes.length) ? extras.variantes : ejercicioVariantes(e.grupo_muscular);
        eqEl.innerHTML = renderList(equiposList);
        varEl.innerHTML = renderList(variantesList);
        if(btnEdit) btnEdit.disabled = false;
        if(btnDel) btnDel.disabled = false;
        if(btnEdit) btnEdit.onclick = () => showEjercicioForm(e);
        if(btnDel) btnDel.onclick = () => deleteEjercicio(e.id);
        const btnXtra = document.getElementById('ejercicio-side-edit-extras');
        if(btnXtra){ btnXtra.disabled = false; btnXtra.onclick = () => openExtrasModal(e); }
      } else {
        nombreEl.textContent = none;
        objEl.textContent = none;
        grpEl.textContent = none;
        descEl.textContent = none;
        tipsEl.innerHTML = '<li class="muted">Selecciona un ejercicio para ver consejos</li>';
        eqEl.innerHTML = '<li class="muted">—</li>';
        varEl.innerHTML = '<li class="muted">—</li>';
        if(btnEdit) btnEdit.disabled = true;
        if(btnDel) btnDel.disabled = true;
        if(btnEdit) btnEdit.onclick = null;
        if(btnDel) btnDel.onclick = null;
        const btnXtra = document.getElementById('ejercicio-side-edit-extras');
        if(btnXtra){ btnXtra.disabled = true; btnXtra.onclick = null; }
      }
    }
    function renderList(items){ const arr = Array.isArray(items) ? items : []; if(arr.length===0){ return '<li class="muted">—</li>'; } return arr.map(x => `<li>${x}</li>`).join(''); }
    function ejercicioTips(objetivo, grupo){
      const tips = {
        general: ['Calentamiento previo 5–10 min', 'Controla la técnica y rango de movimiento'],
        fuerza: ['Prioriza multiarticulares', 'Descansos largos 2–3 min entre series'],
        hipertrofia: ['Tempo controlado', 'Series de 8–12 reps', 'Progresión semanal del volumen'],
        resistencia: ['Circuitos con pausas cortas', 'Mantén respiración constante'],
        cardio: ['Intensidad moderada y sostenida', 'Hidratación en sesiones largas'],
        flexibilidad: ['No rebotes', 'Exhala en la fase de extensión']
      };
      const base = tips[String(objetivo || 'general')] || tips.general;
      const extra = {
        Piernas: ['En sentadillas, mantén columna neutra', 'Alinea rodillas con punta de pies'],
        Espalda: ['Retracción escapular antes de traccionar'],
        Pecho: ['Codos a ~45° en press', 'No hiperextiendas en banca'],
        Hombros: ['Evita elevación excesiva en laterales'],
        Brazos: ['No balancees en curls; usa control'],
        Core: ['Activa abdomen, evita hiperextensión lumbar'],
        'Full Body': ['Ordena del más demandante al más técnico']
      }[String(grupo || '')] || [];
      return base.concat(extra);
    }
    function ejercicioEquipos(grupo){
      const map = {
        Piernas: ['Barra', 'Mancuernas', 'Máquina prensa', 'Banda elástica'],
        Espalda: ['Polea', 'Barra', 'Mancuernas'],
        Pecho: ['Banco', 'Barra', 'Mancuernas'],
        Hombros: ['Mancuernas', 'Polea', 'Barra'],
        Brazos: ['Mancuernas', 'Polea'],
        Core: ['Esterilla', 'Rueda abdominal'],
        'Full Body': ['Barra', 'Mancuernas', 'Kettlebell']
      };
      return map[String(grupo || '')] || ['—'];
    }
    function ejercicioVariantes(grupo){
      const map = {
        Piernas: ['Sentadilla frontal', 'Zancadas', 'Prensa inclinada'],
        Espalda: ['Remo con barra', 'Dominadas supinas'],
        Pecho: ['Press inclinado', 'Fondos en paralelas'],
        Hombros: ['Press militar', 'Elevaciones frontales'],
        Brazos: ['Curl martillo', 'Extensiones sobre cabeza'],
        Core: ['Plancha lateral', 'Dead bug'],
        'Full Body': ['Thrusters', 'Complexes con barra']
      };
      return map[String(grupo || '')] || [];
    }

    function renderLoginInfo(){
      const el = document.getElementById('login-current');
      if(!el) return;
      const role = (el.getAttribute('data-role') || '').trim();
      if(role === 'dueño'){
        const base = 'Sesión: Dueño';
        el.textContent = base;
        el.setAttribute('data-base', base);
        const topEstadoEl = document.getElementById('prof-sesion-estado');
        if(topEstadoEl) topEstadoEl.style.display = 'none';
        return;
      }
      const pidRaw = el.getAttribute('data-prof-id') || '';
      const uidRaw = el.getAttribute('data-prof-uid') || '';
      const pid = pidRaw ? Number(pidRaw) : null;
      const uid = uidRaw ? Number(uidRaw) : null;
      const baseDefault = 'Sesión: Profesor';
      const topEstadoEl = document.getElementById('prof-sesion-estado');
      if(topEstadoEl) topEstadoEl.style.display = '';
      if(pid || uid){
        fetch('/api/profesores_basico', { headers: { 'Accept': 'application/json' } })
          .then(r => r.ok ? r.json() : [])
          .then(list => {
            const arr = Array.isArray(list) ? list : [];
            const profByPid = pid ? arr.find(x => String(x.profesor_id) === String(pid)) : null;
            const profByUid = (!profByPid && uid) ? arr.find(x => String(x.usuario_id) === String(uid)) : null;
            const prof = profByPid || profByUid;
            let base = baseDefault;
            if(prof && prof.nombre){ base = baseDefault + ' • ' + prof.nombre; }
            el.textContent = base;
            el.setAttribute('data-base', base);
            if(prof && prof.profesor_id){ el.setAttribute('data-prof-id', String(prof.profesor_id)); }
          })
          .catch(() => { el.textContent = baseDefault; el.setAttribute('data-base', baseDefault); });
      } else {
        el.textContent = baseDefault;
        el.setAttribute('data-base', baseDefault);
      }
    }

    function init(){
      document.querySelectorAll('.tab').forEach(btn => {
        btn.addEventListener('click', () => {
          const tab = btn.dataset.tab;
          switchTab(tab);
          if(tab === 'pagos') loadPayments();
          if(tab === 'usuarios') loadUsers();
          if(tab === 'profesores') loadProfesoresPanel();
          if(tab === 'ejercicios') loadEjercicios();
          if(tab === 'rutinas') loadRutinas();
          if(tab === 'configuracion') loadConfigData();
        });
      });
      const { start, end } = defaultRange();
      const startEl = document.getElementById('pagos-start');
      const endEl = document.getElementById('pagos-end');
      if(startEl && !startEl.value) startEl.value = start;
      if(endEl && !endEl.value) endEl.value = end;
      document.getElementById('pagos-refresh').addEventListener('click', loadPayments);
      document.getElementById('pagos-q').addEventListener('keydown', (e) => { if(e.key === 'Enter') loadPayments(); });
      document.getElementById('pagos-limit').addEventListener('change', loadPayments);
      const selPU = document.getElementById('pagos-usuario');
      if(selPU){
        selPU.addEventListener('change', () => {
          const val = selPU.value || '';
          const u = (state.usuarios || []).find(x => String(x.id) === String(val));
          const input = document.getElementById('pagos-q');
          if(u && input){
            input.value = String(u.dni || '') || (u.nombre || '');
          } else if(input){
            input.value = '';
          }
          loadPayments();
        });
      }
      bindPagosEvents();
      bindUsuariosEvents();
      bindConfiguracionEvents();
      bindEjerciciosEvents();
      bindRutinasEvents();
      bindProfesoresEvents();
      renderLoginInfo();
      refreshTopBarSesion();
      const roleEl = document.getElementById('login-current');
      const role = roleEl ? (roleEl.getAttribute('data-role') || '') : '';
      const btnProf = document.getElementById('tab-btn-profesores');
      if(btnProf && role !== 'dueño'){ btnProf.style.display = 'none'; }
      loadEstadoPlantillas();
      // Auto-ocultar header al hacer scroll
      const headerEl = document.getElementById('main-header');
      if(headerEl){
        let lastY = window.scrollY;
        let hidden = false;
        function onScroll(){
          const y = window.scrollY;
          if(y > lastY && y > 20){
            if(!hidden){ headerEl.classList.add('header--hidden'); hidden = true; }
          } else {
            if(hidden){ headerEl.classList.remove('header--hidden'); hidden = false; }
          }
          lastY = y;
        }
        window.addEventListener('scroll', onScroll, { passive: true });
      }
      // Precarga datos base para una UX fluida
      Promise.allSettled([
        loadConceptosPago(),
        loadMetodosPago(),
        loadTiposCuotaActivos(),
        ensureTiposCuotaCatalogo(),
      ]).catch(()=>{});
      // Cargar primer listado de Usuarios
      loadUsers();
      // Cargar pagos por defecto (últimos 30 días)
      loadPayments();
    }
    // ==== Profesores: estado y funciones ====
  function ensureProfesoresState(){
    if(!window.state) window.state = {};
    if(!state.profesores) state.profesores = { list: [], horarios: [], sesiones: [], horarioEditId: null, sesionEditId: null, activeSubtab: 'resumen', sesionTimerId: null, currentUsuario: null };
  }
  function bindProfesoresEvents(){
    const btnRefresh = document.getElementById('prof-refresh');
    const selProf = document.getElementById('profesor-select');
    const btnAdd = document.getElementById('horario-add');
    const btnCancel = document.getElementById('horario-cancel');
    const btnStart = document.getElementById('sesion-iniciar');
    const btnEnd = document.getElementById('sesion-finalizar');
    const btnSesRefresh = document.getElementById('prof-ses-refresh');
    const btnSesWeek = document.getElementById('prof-ses-week');
    const btnSesMonth = document.getElementById('prof-ses-month');
    const sesStartEl = document.getElementById('prof-ses-start');
    const sesEndEl = document.getElementById('prof-ses-end');
    const weekDate = document.getElementById('prof-week-date');
    const weekStart = document.getElementById('prof-week-start');
    if(!document.getElementById('panel-profesores')) return;
    if(btnRefresh) btnRefresh.onclick = () => loadProfesoresBasico(true);
    if(selProf) selProf.onchange = () => { ensureProfesoresState(); state.profesores.horarioEditId = null; resetHorarioForm(); loadProfesorDatos(); loadProfesorHorarios(); loadProfesorConfig(); refreshSesion(); if(state.profesores.activeSubtab==='resumen') loadProfesorResumen(); if(state.profesores.activeSubtab==='sesiones') loadProfesorSesiones(); };
    if(btnAdd) btnAdd.onclick = addOrUpdateHorario;
    if(btnCancel) btnCancel.onclick = () => { ensureProfesoresState(); state.profesores.horarioEditId = null; resetHorarioForm(); };
    if(btnStart) btnStart.onclick = startSesion;
    if(btnEnd) btnEnd.onclick = endSesion;
    if(btnSesRefresh) btnSesRefresh.onclick = loadProfesorSesiones;
    if(btnSesWeek) btnSesWeek.onclick = () => { const base = toISODate(new Date()); const mode = (document.getElementById('prof-week-start')?.value || 'mon'); const r = getWeekRange(base, mode); if(sesStartEl) sesStartEl.value = r.start; if(sesEndEl) sesEndEl.value = r.end; loadProfesorSesiones(); };
    if(btnSesMonth) btnSesMonth.onclick = () => { const r = getMonthRange(); if(sesStartEl) sesStartEl.value = r.start; if(sesEndEl) sesEndEl.value = r.end; loadProfesorSesiones(); };
    const btnDatosSave = document.getElementById('prof-datos-save');
    if(btnDatosSave) btnDatosSave.onclick = saveProfesorDatos;
    const btnConfigSave = document.getElementById('prof-config-save');
    if(btnConfigSave) btnConfigSave.onclick = saveProfesorConfig;
    if(weekDate) weekDate.onchange = loadProfesorResumen;
    if(weekStart) weekStart.onchange = loadProfesorResumen;
    if(document.getElementById('prof-subtabs')) bindProfesoresSubtabsEvents();
    // Inicializar semana con hoy
    const today = new Date();
    if(weekDate && !weekDate.value) weekDate.value = toISODate(today);
    // Eventos modal edición de sesión
    const sesSave = document.getElementById('sesion-save');
    const sesCancel = document.getElementById('sesion-form-cancel');
    const sesClose = document.getElementById('sesion-form-close');
    const sesFecha = document.getElementById('sesion-fecha');
    const sesInicio = document.getElementById('sesion-inicio');
    const sesFin = document.getElementById('sesion-fin');
    const sesMin = document.getElementById('sesion-minutos');
    const sesAuto = document.getElementById('sesion-auto');

    function calcMinutesFromInputs(){
      const dateStr = sesFecha?.value || toISODate(new Date());
      const iVal = sesInicio?.value || '';
      const fVal = sesFin?.value || '';
      if(!dateStr || !iVal || !fVal) return null;
      try{
        const sDate = new Date(`${dateStr}T${String(iVal).padStart(5,'0')}:00`);
        let eDate = new Date(`${dateStr}T${String(fVal).padStart(5,'0')}:00`);
        if(eDate < sDate){ eDate = new Date(eDate.getTime() + 24*60*60*1000); }
        const minutes = Math.max(0, Math.round((eDate - sDate) / 60000));
        return minutes;
      }catch(_){ return null; }
    }
    function updateSesionResumen(){
      const resMinEl = document.getElementById('sesion-resumen-min');
      const resHrsEl = document.getElementById('sesion-resumen-horas');
      const autoOn = !!(sesAuto && sesAuto.checked);
      const calc = calcMinutesFromInputs();
      if(autoOn && sesMin){ sesMin.value = calc != null ? String(calc) : ''; }
      if(resMinEl) resMinEl.textContent = calc != null ? String(calc) : '—';
      if(resHrsEl) resHrsEl.textContent = calc != null ? (calc/60).toFixed(2) : '—';
    }

    if(sesSave) sesSave.onclick = saveSesionEdit;
    if(sesCancel) sesCancel.onclick = () => { ensureProfesoresState(); state.profesores.sesionEditId = null; closeModal('modal-sesion-form'); };
    if(sesClose) sesClose.onclick = () => { ensureProfesoresState(); state.profesores.sesionEditId = null; closeModal('modal-sesion-form'); };

    if(sesAuto) sesAuto.onchange = () => { const on = sesAuto.checked; if(sesMin) sesMin.disabled = on; updateSesionResumen(); };
    if(sesFecha) sesFecha.onchange = updateSesionResumen;
    if(sesInicio) sesInicio.oninput = updateSesionResumen;
    if(sesFin) sesFin.oninput = updateSesionResumen;
    if(sesMin) sesMin.oninput = () => { const resHrsEl = document.getElementById('sesion-resumen-horas'); const v = Number(sesMin.value); if(!isFinite(v)) { if(resHrsEl) resHrsEl.textContent = '—'; return; } if(resHrsEl) resHrsEl.textContent = (Math.max(0, Math.round(v))/60).toFixed(2); };
  }
  function loadProfesoresPanel(){
    ensureProfesoresState();
    bindProfesoresEvents();
    loadProfesoresBasico();
  }
  function loadProfesoresBasico(){
    ensureProfesoresState();
    fetch('/api/profesores_basico')
      .then(r => r.json())
      .then(list => {
        state.profesores.list = Array.isArray(list) ? list : [];
        const sel = document.getElementById('profesor-select');
        if(!sel) return;
        const prev = sel.value;
        sel.innerHTML = state.profesores.list.map(p => `<option value="${p.profesor_id}">${p.nombre || ('Profesor ' + p.profesor_id)}</option>`).join('');
        const hasPrev = state.profesores.list.some(p => String(p.profesor_id) === String(prev));
        if(hasPrev) sel.value = prev;
        if(!sel.value && state.profesores.list.length) sel.value = String(state.profesores.list[0].profesor_id);
        loadProfesorDatos();
        loadProfesorHorarios();
        loadProfesorConfig();
        refreshSesion();
        loadProfesorResumen();
      })
      .catch(_ => {
        if (typeof showToast === 'function') showToast('Error cargando profesores', 'error');
      });
  }
  function loadProfesorHorarios(){
    ensureProfesoresState();
    const sel = document.getElementById('profesor-select');
    if(!sel || !sel.value) return;
    const pid = sel.value;
    fetch(`/api/profesor_horarios?profesor_id=${encodeURIComponent(pid)}`)
      .then(r => r.json())
      .then(list => {
        state.profesores.horarios = Array.isArray(list) ? list : [];
        renderHorariosTable();
      })
      .catch(_ => {
        if (typeof showToast === 'function') showToast('Error cargando horarios', 'error');
      });
  }
  function renderHorariosTable(){
    const tbody = document.querySelector('#prof-horarios-table tbody');
    const count = document.getElementById('horarios-count');
    if(!tbody) return;
    const rows = (state.profesores.horarios || []).map(h => {
      const disponibleTxt = h.disponible ? 'Sí' : 'No';
      const id = h.id ?? h.horario_id ?? '';
      const dia = h.dia ?? h.dia_semana ?? '';
      const inicio = (h.inicio || h.hora_inicio || '').toString().slice(0,5);
      const fin = (h.fin || h.hora_fin || '').toString().slice(0,5);
      return `<tr data-id="${id}">
        <td>${dia}</td>
        <td>${inicio}</td>
        <td>${fin}</td>
        <td>${disponibleTxt}</td>
        <td>
          <button class="btn tiny" data-action="edit">Editar</button>
          <button class="btn tiny danger" data-action="delete">Eliminar</button>
        </td>
      </tr>`;
    }).join('');
    tbody.innerHTML = rows;
    if(count) count.textContent = `${state.profesores.horarios.length} registros`;
    tbody.querySelectorAll('button[data-action="edit"]').forEach(btn => {
      btn.onclick = ev => {
        const tr = ev.target.closest('tr');
        const id = tr?.getAttribute('data-id');
        if(!id) return;
        handleEditHorario(id);
      };
    });
    tbody.querySelectorAll('button[data-action="delete"]').forEach(btn => {
      btn.onclick = ev => {
        const tr = ev.target.closest('tr');
        const id = tr?.getAttribute('data-id');
        if(!id) return;
        handleDeleteHorario(id);
      };
    });
  }
  function resetHorarioForm(){
    const addBtn = document.getElementById('horario-add');
    const cancelBtn = document.getElementById('horario-cancel');
    const diaSel = document.getElementById('horario-dia');
    const inicio = document.getElementById('horario-inicio');
    const fin = document.getElementById('horario-fin');
    const disp = document.getElementById('horario-disponible');
    if(addBtn) addBtn.textContent = 'Añadir';
    if(cancelBtn) cancelBtn.style.display = 'none';
    if(diaSel) diaSel.value = 'Lunes';
    if(inicio) inicio.value = '';
    if(fin) fin.value = '';
    if(disp) disp.checked = true;
  }
  function handleEditHorario(id){
    const h = (state.profesores.horarios || []).find(x => (String(x.id ?? x.horario_id) === String(id)));
    if(!h) return;
    state.profesores.horarioEditId = String(id);
    const addBtn = document.getElementById('horario-add');
    const cancelBtn = document.getElementById('horario-cancel');
    const diaSel = document.getElementById('horario-dia');
    const inicio = document.getElementById('horario-inicio');
    const fin = document.getElementById('horario-fin');
    const disp = document.getElementById('horario-disponible');
    if(addBtn) addBtn.textContent = 'Guardar';
    if(cancelBtn) cancelBtn.style.display = 'inline-block';
    if(diaSel) diaSel.value = h.dia ?? h.dia_semana ?? 'Lunes';
    if(inicio) inicio.value = (h.inicio || h.hora_inicio || '').toString().slice(0,5);
    if(fin) fin.value = (h.fin || h.hora_fin || '').toString().slice(0,5);
    if(disp) disp.checked = !!h.disponible;
  }
  function openSesionEdit(id){
    ensureProfesoresState();
    state.profesores.sesionEditId = String(id);
    const ses = (state.profesores.sesiones || []).find(x => String(x.id ?? x.sesion_id ?? x.id_sesion ?? x.SesionID) === String(id));
    if(!ses){ if (typeof showToast === 'function') showToast('No se encontró la sesión', 'error'); return; }
    const fecha = String(ses.fecha ?? ses.Fecha ?? ses.fecha_sesion ?? ses.fecha_numerica ?? ses.fecha_num ?? ses.date ?? ses.dia ?? ses.FechaSesion ?? '').slice(0,10);
    const inicioRaw = (ses.inicio ?? ses.hora_inicio ?? ses.Inicio ?? ses.entrada ?? ses.HoraInicio ?? ses.start_time ?? ses.horaEntrada ?? '');
    const finRaw = (ses.fin ?? ses.hora_fin ?? ses.Fin ?? ses.salida ?? ses.HoraFin ?? ses.end_time ?? ses.horaSalida ?? '');
    const tipoVal = (ses.tipo ?? ses.tipo_actividad ?? ses.Tipo ?? ses.actividad ?? '');
    const fEl = document.getElementById('sesion-fecha');
    const iEl = document.getElementById('sesion-inicio');
    const finEl = document.getElementById('sesion-fin');
    const tEl = document.getElementById('sesion-tipo');
    const minEl = document.getElementById('sesion-minutos');
    const autoEl = document.getElementById('sesion-auto');
    if(fEl) fEl.value = fecha || '';
    if(iEl) iEl.value = extractTime(inicioRaw).replace('—','');
    if(finEl) finEl.value = extractTime(finRaw).replace('—','');
    if(tEl) tEl.value = String(tipoVal || '');
    if(minEl) minEl.value = String(ses.minutos ?? ses.minutos_totales ?? '');
    if(autoEl){ autoEl.checked = true; if(minEl) minEl.disabled = true; }
    try{ if(iEl) iEl.dispatchEvent(new Event('input')); }catch(_){}
    openModal('modal-sesion-form');
  }
  async function saveSesionEdit(){
    try{
      ensureProfesoresState();
      const id = state.profesores.sesionEditId;
      if(!id){ if (typeof showToast === 'function') showToast('No hay sesión seleccionada', 'error'); return; }
      const fEl = document.getElementById('sesion-fecha');
      const iEl = document.getElementById('sesion-inicio');
      const finEl = document.getElementById('sesion-fin');
      const tEl = document.getElementById('sesion-tipo');
      const minEl = document.getElementById('sesion-minutos');
      const autoEl = document.getElementById('sesion-auto');
      let minutosPayload = null;
      if(autoEl && autoEl.checked){
        minutosPayload = null;
      } else {
        const mv = minEl ? Number(minEl.value) : null;
        minutosPayload = (mv != null && isFinite(mv)) ? Math.max(0, Math.round(mv)) : null;
      }
      const payload = {
        fecha: fEl ? fEl.value : null,
        inicio: iEl ? iEl.value : null,
        fin: finEl ? finEl.value : null,
        tipo: tEl ? String(tEl.value || '').trim() : null,
        minutos: minutosPayload
      };
      const r = await fetch(`/api/profesor_sesion/${encodeURIComponent(id)}`, {
        method: 'PUT',
        headers: { 'Content-Type':'application/json', 'Accept':'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await r.json().catch(()=> ({}));
      if(!r.ok){
        if (typeof showToast === 'function') showToast(data?.detail || data?.error || 'No se pudo actualizar la sesión', 'error');
        return;
      }
      if (typeof showToast === 'function') showToast('Sesión actualizada correctamente', 'success');
      closeModal('modal-sesion-form');
      state.profesores.sesionEditId = null;
      await loadProfesorSesiones();
    }catch(e){ if (typeof showToast === 'function') showToast('Error de red al actualizar sesión', 'error'); }
  }

  function addOrUpdateHorario(){
    const sel = document.getElementById('profesor-select');
    const diaSel = document.getElementById('horario-dia');
    const inicio = document.getElementById('horario-inicio');
    const fin = document.getElementById('horario-fin');
    const disp = document.getElementById('horario-disponible');
    const pid = sel?.value;
    if(!pid || !diaSel || !inicio || !fin || !disp) return;
    const payload = {
      profesor_id: Number(pid),
      dia: diaSel.value,
      inicio: inicio.value,
      fin: fin.value,
      disponible: !!disp.checked
    };
    const editId = state.profesores.horarioEditId;
    const url = editId ? `/api/profesor_horarios/${encodeURIComponent(editId)}` : '/api/profesor_horarios';
    const opts = {
      method: editId ? 'PUT' : 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    };
    fetch(url, opts)
      .then(r => r.json())
      .then(_ => {
        if (typeof showToast === 'function') showToast(editId ? 'Horario actualizado' : 'Horario creado', 'success');
        state.profesores.horarioEditId = null;
        resetHorarioForm();
        loadProfesorHorarios();
      })
      .catch(_ => {
        if (typeof showToast === 'function') showToast('Error guardando horario', 'error');
      });
  }
  function handleDeleteHorario(id){
    const sel = document.getElementById('profesor-select');
    const pid = sel?.value;
    if(!pid) return;
    const ok = confirm('¿Eliminar horario?');
    if(!ok) return;
    fetch(`/api/profesor_horarios/${encodeURIComponent(id)}`, { method: 'DELETE' })
      .then(r => r.json())
      .then(_ => {
        if (typeof showToast === 'function') showToast('Horario eliminado', 'success');
        loadProfesorHorarios();
      })
      .catch(_ => {
        if (typeof showToast === 'function') showToast('Error eliminando horario', 'error');
      });
  }

  let pendingDeleteSesionId = null;
  function openDeleteSesionModal(id){
    pendingDeleteSesionId = id;
    // Usar utilidades de modales consistentes
    try { openModal('modal-sesion-delete'); } catch(_) {
      const mb = document.getElementById('modal-sesion-delete');
      if(mb){ mb.classList.add('active'); mb.style.display = 'flex'; mb.setAttribute('aria-hidden','false'); }
    }
  }
  function closeDeleteSesionModal(){
    // Usar utilidades de modales consistentes
    try { closeModal('modal-sesion-delete'); } catch(_) {
      const mb = document.getElementById('modal-sesion-delete');
      if(mb){ mb.classList.remove('active'); mb.style.display = 'none'; mb.setAttribute('aria-hidden','true'); }
    }
    pendingDeleteSesionId = null;
  }
  function handleDeleteSesion(id){
    // Fallback: abrir el modal en lugar de confirm() nativo.
    openDeleteSesionModal(id);
  }
  // Eventos del modal de eliminación de sesión
  (function(){
    const btnClose = document.getElementById('sesion-delete-close');
    const btnCancel = document.getElementById('sesion-delete-cancel');
    const btnConfirm = document.getElementById('sesion-delete-confirm');
    if(btnClose) btnClose.onclick = closeDeleteSesionModal;
    if(btnCancel) btnCancel.onclick = closeDeleteSesionModal;
    if(btnConfirm) btnConfirm.onclick = () => {
      const id = pendingDeleteSesionId;
      if(!id){ closeDeleteSesionModal(); return; }
      const sel = document.getElementById('profesor-select');
      const pid = sel?.value;
      if(!pid){ closeDeleteSesionModal(); return; }
      fetch(`/api/profesor_sesion/${encodeURIComponent(id)}`, { method: 'DELETE', headers: { 'Accept':'application/json' } })
        .then(async r => {
          const data = await r.json().catch(() => ({}));
          if(!r.ok){
            if (typeof showToast === 'function') showToast(data?.detail || data?.error || 'No se pudo eliminar la sesión', 'error');
            return;
          }
          if (typeof showToast === 'function') showToast('Sesión eliminada correctamente', 'success');
          closeDeleteSesionModal();
          loadProfesorSesiones();
        })
        .catch(_ => {
          if (typeof showToast === 'function') showToast('Error de red al eliminar sesión', 'error');
        });
    };
  })();

  // ====== Profesores: Datos (usuario vinculado) ======
  function getSelectedProfesorUsuarioId(){
    ensureProfesoresState();
    const sel = document.getElementById('profesor-select');
    const pid = sel?.value;
    const prof = (state.profesores.list || []).find(p => String(p.profesor_id) === String(pid));
    return prof ? prof.usuario_id : null;
  }
  async function loadProfesorDatos(){
    try{
      ensureProfesoresState();
      const uid = getSelectedProfesorUsuarioId();
      const nomEl = document.getElementById('prof-dato-nombre');
      const dniEl = document.getElementById('prof-dato-dni');
      const telEl = document.getElementById('prof-dato-telefono');
      const pinEl = document.getElementById('prof-dato-pin');
      const actEl = document.getElementById('prof-dato-activo');
      const rolLabel = document.getElementById('prof-dato-rol-label');
      if(!uid || !nomEl || !dniEl || !telEl || !pinEl || !actEl) return;
      const r = await fetch(`/api/usuarios/${encodeURIComponent(uid)}`, { headers: { 'Accept':'application/json' } });
      if(!r.ok){ if (typeof showToast === 'function') showToast('No se pudo cargar datos del profesor', 'error'); return; }
      const data = await r.json().catch(()=> ({}));
      state.profesores.currentUsuario = data || null;
      nomEl.value = String(data?.nombre || '');
      dniEl.value = String(data?.dni || '');
      telEl.value = String(data?.telefono || '');
      pinEl.value = String(data?.pin || '');
      actEl.checked = !!data?.activo;
      if(rolLabel) rolLabel.textContent = `Rol: ${String(data?.rol || 'profesor').charAt(0).toUpperCase() + String(data?.rol || 'profesor').slice(1)}`;
    }catch(e){ console.error('Error cargando datos profesor', e); }
  }
  async function saveProfesorDatos(){
    try{
      ensureProfesoresState();
      const uid = getSelectedProfesorUsuarioId();
      if(!uid){ if (typeof showToast === 'function') showToast('Seleccione un profesor', 'error'); return; }
      const nomEl = document.getElementById('prof-dato-nombre');
      const dniEl = document.getElementById('prof-dato-dni');
      const telEl = document.getElementById('prof-dato-telefono');
      const pinEl = document.getElementById('prof-dato-pin');
      const actEl = document.getElementById('prof-dato-activo');
      if(!nomEl || !dniEl || !telEl || !pinEl || !actEl) return;
      const current = state.profesores.currentUsuario || {};
      const payload = {
        nombre: String(nomEl.value || '').trim().toUpperCase(),
        dni: String(dniEl.value || '').trim(),
        telefono: String(telEl.value || '').trim(),
        pin: String(pinEl.value || '').trim(),
        activo: !!actEl.checked,
        rol: 'profesor',
        tipo_cuota: current.tipo_cuota ?? null,
        notas: current.notas ?? null
      };
      if(!payload.nombre || !payload.dni){
        if (typeof showToast === 'function') showToast('Nombre y DNI son obligatorios', 'error');
        return;
      }
      const r = await fetch(`/api/usuarios/${encodeURIComponent(uid)}`, {
        method: 'PUT',
        headers: { 'Content-Type':'application/json', 'Accept':'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await r.json().catch(()=> ({}));
      if(!r.ok){
        if (typeof showToast === 'function') showToast(data?.detail || data?.error || 'No se pudo guardar', 'error');
        return;
      }
      if (typeof showToast === 'function') showToast('Datos del profesor guardados', 'success');
      await loadProfesorDatos();
      await loadProfesoresBasico();
    }catch(e){ if (typeof showToast === 'function') showToast('Error de red al guardar', 'error'); }
  }

  // ====== Profesores: Configuración lateral (usuario, salario, notas) ======
  async function loadUsuariosOptions(selectedId){
    try{
      const sel = document.getElementById('prof-config-usuario');
      if(!sel) return;
      sel.innerHTML = '<option value="">—</option>';
      const r = await fetch('/api/usuarios?limit=300');
      const list = await r.json().catch(()=> []);
      if(Array.isArray(list)){
        for(const u of list){
          const opt = document.createElement('option');
          opt.value = String(u.usuario_id);
          opt.textContent = (u.nombre && String(u.nombre).trim() !== '') ? `${String(u.nombre)}${u.dni? ' ('+u.dni+')':''}` : `Usuario ${u.usuario_id}`;
          sel.appendChild(opt);
        }
      }
      if(selectedId){ sel.value = String(selectedId); }
    }catch(_){ /* silencioso */ }
  }
  async function loadProfesorConfig(){
    try{
      const selProf = document.getElementById('profesor-select');
      const pid = selProf?.value;
      if(!pid) return;
      const r = await fetch(`/api/profesores/${encodeURIComponent(pid)}`);
      const d = await r.json().catch(()=> ({}));
      const usuarioEl = document.getElementById('prof-config-usuario');
      if(usuarioEl){
        const uid = d?.usuario_id ?? null;
        const uname = d?.usuario_nombre || '';
        const display = uid ? ((uname && uname.trim() !== '') ? `${uname} (ID ${uid})` : `Usuario ${uid}`) : '—';
        usuarioEl.value = display;
        usuarioEl.setAttribute('data-uid', uid ? String(uid) : '');
      }
      const salLabelEl = document.getElementById('prof-config-salario-label');
      const salInput = document.getElementById('prof-config-salario');
      const notasEl = document.getElementById('prof-config-notas');
      if(salLabelEl){
        let key = null;
        if(Object.prototype.hasOwnProperty.call(d, 'sueldo')){ key = 'sueldo'; }
        else if(Object.prototype.hasOwnProperty.call(d, 'salario')){ key = 'salario'; }
        else { key = 'sueldo'; }
        salLabelEl.textContent = 'Monto (ARS)';
        salLabelEl.setAttribute('data-key', String(key));
      }
      if(salInput){
        let val = null;
        if(Object.prototype.hasOwnProperty.call(d, 'tarifa_por_hora') && d.tarifa_por_hora != null){ val = d.tarifa_por_hora; }
        else if(Object.prototype.hasOwnProperty.call(d, 'sueldo')){ val = d.sueldo; }
        else if(Object.prototype.hasOwnProperty.call(d, 'salario')){ val = d.salario; }
        try {
          const num = (val !== null && val !== undefined) ? Number(String(val).replace(',', '.')) : null;
          salInput.value = (num !== null && Number.isFinite(num)) ? num.toFixed(2) : ((val !== null && val !== undefined) ? String(val) : '');
        } catch(_) {
          salInput.value = (val !== null && val !== undefined) ? String(val) : '';
        }
        const tipoMontoEl = document.getElementById('prof-monto-tipo');
        if(tipoMontoEl){
          const hasHora = Object.prototype.hasOwnProperty.call(d, 'tarifa_por_hora') && d.tarifa_por_hora != null;
          tipoMontoEl.value = hasHora ? 'hora' : 'mensual';
        }
      }
      if(notasEl){ notasEl.value = String(d?.notas || d?.usuario_notas || ''); }
      const espEl = document.getElementById('prof-config-especialidad');
      const expEl = document.getElementById('prof-config-experiencia');
      const certEl = document.getElementById('prof-config-certificaciones');
      if(espEl) espEl.value = String(d?.tipo || '');
      if(expEl) expEl.value = (d?.experiencia_años != null) ? String(d.experiencia_años) : '';
      if(certEl) certEl.value = String(d?.certificaciones || '');
    }catch(_){ /* silencioso */ }
  }
  async function saveProfesorConfig(){
    try{
      const selProf = document.getElementById('profesor-select');
      const pid = selProf?.value;
      if(!pid){ if (typeof showToast === 'function') showToast('Seleccione un profesor', 'error'); return; }
      const salLabelEl = document.getElementById('prof-config-salario-label');
      const salInput = document.getElementById('prof-config-salario');
      const notasEl = document.getElementById('prof-config-notas');
      const espEl = document.getElementById('prof-config-especialidad');
      const expEl = document.getElementById('prof-config-experiencia');
      const certEl = document.getElementById('prof-config-certificaciones');
      const payload = {};
      const key = salLabelEl ? (salLabelEl.getAttribute('data-key') || 'sueldo') : 'sueldo';
      const salVal = salInput ? String(salInput.value || '').trim() : '';
      const expVal = expEl ? String(expEl.value || '').trim() : '';

      const errors = [];
      const salNum = salVal !== '' ? Number(salVal.replace(',', '.')) : null;
      if(salVal !== '' && (!Number.isFinite(salNum) || salNum < 0)) errors.push('El monto debe ser un número ≥ 0');
      const expNum = expVal !== '' ? Number(expVal) : null;
      if(expVal !== '' && (!Number.isFinite(expNum) || expNum < 0 || Math.floor(expNum) !== expNum)) errors.push('Experiencia (años) debe ser un entero ≥ 0');
      if(errors.length){ if (typeof showToast === 'function') showToast(errors[0], 'error'); else alert(errors[0]); return; }

      const tipoMontoEl = document.getElementById('prof-monto-tipo');
      const tipoMonto = tipoMontoEl ? String(tipoMontoEl.value || 'mensual') : 'mensual';
      if(tipoMonto === 'hora'){
        payload['tarifa_por_hora'] = salVal !== '' ? salNum : null;
        payload['sueldo'] = null;
      } else {
        payload['sueldo'] = salVal !== '' ? salNum : null;
        payload['tarifa_por_hora'] = null;
      }
      payload['notas'] = notasEl ? String(notasEl.value || '') : '';
      payload['tipo'] = espEl ? String(espEl.value || '').trim() : '';
      payload['experiencia_años'] = expVal !== '' ? expNum : null;
      payload['certificaciones'] = certEl ? String(certEl.value || '') : '';
      const usuarioEl = document.getElementById('prof-config-usuario');
      const usuarioId = usuarioEl ? Number(usuarioEl.getAttribute('data-uid') || '') || null : null;
      payload['usuario_id'] = usuarioId;

      const r = await fetch(`/api/profesores/${encodeURIComponent(pid)}`, {
        method: 'PUT',
        headers: { 'Content-Type':'application/json', 'Accept':'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await r.json().catch(()=> ({}));
      if(!r.ok){ if (typeof showToast === 'function') showToast(data?.detail || data?.error || 'No se pudo guardar', 'error'); return; }
      if (typeof showToast === 'function') showToast('Configuración del profesor guardada', 'success');
      await loadProfesoresBasico();
      await loadProfesorDatos();
    }catch(_){ if (typeof showToast === 'function') showToast('Error al guardar configuración', 'error'); }
  }

  // ====== Profesores: Helpers y cargadores de Resumen/Sesiones ======
  function toISODate(d){ return fmtDate(d); }
  function extractTime(val){
    if(val === null || val === undefined) return '—';
    const s = String(val);
    const m = s.match(/(\d{2}:\d{2})/);
    if(m) return m[1];
    try {
      const dt = new Date(s);
      if(!isNaN(dt.getTime())){
        const hh = String(dt.getHours()).padStart(2,'0');
        const mm = String(dt.getMinutes()).padStart(2,'0');
        return `${hh}:${mm}`;
      }
    } catch(_){}
    return s.slice(0,5);
  }
  function getWeekRange(baseDate, startOn){
    const d = new Date(baseDate);
    if(isNaN(d.getTime())) return null;
    const v = String(startOn || 'mon').toLowerCase();
    const startMonday = (v === 'mon' || v === 'lunes' || v === 'monday');
    const day = d.getDay(); // 0=Domingo, 1=Lunes, ...
    const diff = startMonday ? (day === 0 ? -6 : (1 - day)) : -day;
    const start = new Date(d);
    start.setDate(d.getDate() + diff);
    const end = new Date(start);
    end.setDate(start.getDate() + 6);
    return { start: fmtDate(start), end: fmtDate(end), label: `${fmtDate(start)} — ${fmtDate(end)}` };
  }
  function getMonthRange(date){
    const d = date ? new Date(date) : new Date();
    const start = new Date(d.getFullYear(), d.getMonth(), 1);
    const end = new Date(d.getFullYear(), d.getMonth()+1, 0);
    return { start: fmtDate(start), end: fmtDate(end) };
  }
  function updateResumenCards(prefix, res){
    const set = (id, val) => {
      const el = document.getElementById(id);
      if(el){
        const n = Number(val);
        el.textContent = Number.isFinite(n) ? (Math.round(n*100)/100).toFixed(2) : '0.00';
      }
    };
    const hTrab = res?.horas_trabajadas ?? 0;
    const hProj = res?.horas_proyectadas ?? 0;
    const hExt = res?.horas_extras ?? 0;
    const hExtDisplay = Math.max(0, Number(hExt) || 0);
    set(`${prefix}-horas-trabajadas`, hTrab);
    set(`${prefix}-horas-proyectadas`, hProj);
    set(`${prefix}-horas-extra`, hExtDisplay);
  }
  async function loadProfesorResumen(){
    try {
      ensureProfesoresState();
      const sel = document.getElementById('profesor-select');
      const pid = sel?.value;
      if(!pid) return;
      // Mensual: mes actual
      const { start: ms, end: me } = getMonthRange();
      try {
        const qsM = new URLSearchParams({ profesor_id: String(pid), start: ms, end: me });
        const rM = await fetch('/api/profesor_resumen?' + qsM.toString());
        const resM = await rM.json().catch(() => ({}));
        updateResumenCards('prof-m', resM || {});
      } catch(_) { updateResumenCards('prof-m', {}); }
      // Semanal: basado en fecha y comienzo de semana
      const weekDate = document.getElementById('prof-week-date');
      const weekStart = document.getElementById('prof-week-start');
      const base = weekDate?.value || toISODate(new Date());
      const mode = (weekStart?.value || 'mon');
      const range = getWeekRange(base, mode);
      const rangeEl = document.getElementById('prof-week-range');
      if(rangeEl && range) rangeEl.textContent = range.label; else if(rangeEl) rangeEl.textContent = '—';
      if(range){
        try {
          const qsW = new URLSearchParams({ profesor_id: String(pid), start: range.start, end: range.end });
          const rW = await fetch('/api/profesor_resumen?' + qsW.toString());
          const resW = await rW.json().catch(() => ({}));
          updateResumenCards('prof-w', resW || {});
        } catch(_) { updateResumenCards('prof-w', {}); }
      } else {
        updateResumenCards('prof-w', {});
      }
    } catch(e){ console.error('Error cargando resumen profesor', e); }
  }
  async function loadProfesorSesiones(){
    try {
      const sel = document.getElementById('profesor-select');
      const pid = sel?.value;
      if(!pid) return;
      const s = document.getElementById('prof-ses-start')?.value || null;
      const e = document.getElementById('prof-ses-end')?.value || null;
      const qs = new URLSearchParams();
      qs.set('profesor_id', String(pid));
      if(s) qs.set('start', s);
      if(e) qs.set('end', e);
      const tbody = document.querySelector('#prof-sesiones-table tbody');
      if(tbody) tbody.innerHTML = `<tr><td colspan="7" class="empty">Cargando…</td></tr>`;
      const r = await fetch('/api/profesor_sesiones?' + qs.toString());
      if(!r.ok){
        let msg = `Error ${r.status}`;
        try { const err = await r.json(); msg = err?.detail || err?.error || msg; } catch(_){ }
        if(tbody) tbody.innerHTML = `<tr><td colspan="7" class="empty">${msg}</td></tr>`;
        return;
      }
      const data = await r.json();
      const arr = Array.isArray(data) ? data : (Array.isArray(data?.items) ? data.items : []);
      if(arr.length === 0){
        if(s || e){ if(tbody) tbody.innerHTML = `<tr><td colspan="7" class="empty">Sin datos en el rango</td></tr>`; return; }
        try {
          const qs2 = new URLSearchParams(); qs2.set('profesor_id', String(pid));
          const r2 = await fetch('/api/profesor_sesiones?' + qs2.toString());
          if(!r2.ok){ if(tbody) tbody.innerHTML = `<tr><td colspan="7" class="empty">Sin datos</td></tr>`; return; }
          const data2 = await r2.json();
          const arr2 = Array.isArray(data2) ? data2 : (Array.isArray(data2?.items) ? data2.items : []);
          if(arr2.length === 0){ if(tbody) tbody.innerHTML = `<tr><td colspan="7" class="empty">Sin datos</td></tr>`; return; }
          arr.push(...arr2);
        } catch(_){ if(tbody) tbody.innerHTML = `<tr><td colspan="7" class="empty">Sin datos</td></tr>`; return; }
      }
      if(tbody) tbody.innerHTML = '';
      ensureProfesoresState();
      state.profesores.sesiones = arr;
      arr.forEach(ses => {
        const fecha = (ses.fecha ?? ses.Fecha ?? ses.fecha_sesion ?? ses.fecha_numerica ?? ses.fecha_num ?? ses.date ?? ses.dia ?? ses.FechaSesion ?? '');
        const inicioRaw = (ses.inicio ?? ses.hora_inicio ?? ses.Inicio ?? ses.entrada ?? ses.HoraInicio ?? ses.start_time ?? ses.horaEntrada ?? '');
        const finRaw = (ses.fin ?? ses.hora_fin ?? ses.Fin ?? ses.salida ?? ses.HoraFin ?? ses.end_time ?? ses.horaSalida ?? '');
        const minutosVal = (ses.minutos ?? ses.minutos_totales ?? ses.Minutos ?? ses.duracion_min ?? ses.duracion ?? ses.mins ?? ses.minutos_trabajados ?? ses.minutes ?? 0);
        const horasVal = (ses.horas ?? ses.horas_totales ?? ses.Horas ?? ses.horas_trabajadas ?? ses.duracion_horas ?? ses.duration_hours ?? null);
        const tipoVal = (ses.tipo ?? ses.tipo_actividad ?? ses.Tipo ?? ses.actividad ?? ses.category ?? '');
        const tr = document.createElement('tr');
        const inicioText = extractTime(inicioRaw);
        const finText0 = extractTime(finRaw);
        const finText = (inicioText && finText0 && finText0 < inicioText) ? `${finText0} <span title="Termina después de medianoche">(+1d)</span>` : finText0;
        const idVal = (ses.id ?? ses.sesion_id ?? ses.id_sesion ?? ses.SesionID ?? '');
        tr.innerHTML = `
          <td>${String(fecha).slice(0,10)}</td>
          <td>${inicioText}</td>
          <td>${finText}</td>
          <td>${Number(minutosVal ?? 0)}</td>
          <td>${(horasVal!==undefined && horasVal!==null)?Number(horasVal).toFixed(2):'—'}</td>
          <td>${tipoVal || ''}</td>
          <td>
            <button class="btn tiny" data-action="edit-sesion" data-id="${idVal}">Editar</button>
            <button class="btn tiny danger" data-action="delete-sesion" data-id="${idVal}">Eliminar</button>
          </td>
        `;
        tbody?.appendChild(tr);
        const b = tr.querySelector('button[data-action="edit-sesion"]');
        if(b){ b.onclick = () => { const sid = b.getAttribute('data-id') || ''; if(sid) openSesionEdit(sid); }; }
        const bd = tr.querySelector('button[data-action="delete-sesion"]');
        if(bd){ bd.onclick = () => { const sid = bd.getAttribute('data-id') || ''; if(sid) openDeleteSesionModal(sid); }; }
      });
    } catch(e){ console.error('Error cargando sesiones profesor', e); }
  }
  function bindProfesoresSubtabsEvents(){
    const cont = document.getElementById('prof-subtabs');
    const contR = document.getElementById('prof-tab-resumen');
    const contH = document.getElementById('prof-tab-horarios');
    const contS = document.getElementById('prof-tab-sesiones');
    const buttons = cont ? Array.from(cont.querySelectorAll('button[data-subtab]')) : [];
    function setActive(which){
      ensureProfesoresState();
      state.profesores.activeSubtab = which;
      buttons.forEach(b => { if(b){ b.classList.toggle('active', b.getAttribute('data-subtab') === which); } });
      if(contR) contR.style.display = which==='resumen' ? '' : 'none';
      if(contH) contH.style.display = which==='horarios' ? '' : 'none';
      if(contS) contS.style.display = which==='sesiones' ? '' : 'none';
      const sel = document.getElementById('profesor-select'); const pid = sel?.value;
      if(!pid) return;
      if(which==='resumen') loadProfesorResumen();
      else if(which==='sesiones') loadProfesorSesiones();
    }
    buttons.forEach(b => { b.onclick = () => setActive(b.getAttribute('data-subtab') || 'resumen'); });
    ensureProfesoresState();
    const initial = state.profesores.activeSubtab || 'resumen';
    setActive(initial);
  }
  function updateTopBarDurationText(text){
    const el = document.getElementById('login-current');
    if(!el) return;
    const base = el.getAttribute('data-base') || el.textContent || '';
    el.textContent = text ? (base + ' • ' + text) : base;
  }
  function setupSesionTimer(active){
    ensureProfesoresState();
    const roleEl = document.getElementById('login-current');
    const role = roleEl ? (roleEl.getAttribute('data-role') || '') : '';
    if(state.profesores.sesionTimerId){ clearInterval(state.profesores.sesionTimerId); state.profesores.sesionTimerId = null; }
    if(active && role !== 'dueño'){
      state.profesores.sesionTimerId = setInterval(() => { try{ refreshSesionDuration(true); }catch(_){} }, 60000);
    }
  }
  // Refresca la sesión del profesor de login para la barra superior
  function refreshTopBarSesion(){
    try{
      const roleEl = document.getElementById('login-current');
      const role = roleEl ? (roleEl.getAttribute('data-role') || '') : '';
      const loginProfId = roleEl ? (roleEl.getAttribute('data-prof-id') || '') : '';
      if(role !== 'profesor' || !loginProfId){
        setupSesionTimer(false);
        updateTopBarDurationText('');
        return;
      }
      fetch(`/api/profesor_sesion_activa?profesor_id=${encodeURIComponent(loginProfId)}`)
        .then(r => r.json())
        .then(d => {
          const active = !!d?.activa;
          setupSesionTimer(active);
          refreshSesionDuration(active);
        })
        .catch(_ => { setupSesionTimer(false); updateTopBarDurationText(''); });
    }catch(_){ /* silencioso */ }
  }
  function refreshSesion(){
    const estadoSpan = document.getElementById('sesion-estado');
    const topEstado = document.getElementById('prof-sesion-estado');
    const sel = document.getElementById('profesor-select');
    const pid = sel?.value;
    if(!pid){
      if(estadoSpan) estadoSpan.textContent = '—';
      if(topEstado) topEstado.textContent = 'Sesión: —';
      setupSesionTimer(false);
      updateTopBarDurationText('');
      return;
    }
    fetch(`/api/profesor_sesion_activa?profesor_id=${encodeURIComponent(pid)}`)
      .then(r => r.json())
      .then(d => {
        const active = !!d?.activa;
        const tipo = d?.tipo_actividad || 'Trabajo';
        const texto = active ? `Activa (${tipo})` : 'Inactiva';
        if(estadoSpan) estadoSpan.textContent = texto;
        if(topEstado) topEstado.textContent = `Sesión: ${texto}`;
        setupSesionTimer(active);
        refreshSesionDuration(active);
      })
      .catch(_ => {
        if(estadoSpan) estadoSpan.textContent = '—';
        if(topEstado) topEstado.textContent = 'Sesión: —';
        setupSesionTimer(false);
        updateTopBarDurationText('');
      });
  }
  function refreshSesionDuration(onlyIfActive){
    const durSpan = document.getElementById('sesion-duracion');
    const sel = document.getElementById('profesor-select');
    const pidSel = sel?.value;
    const roleEl = document.getElementById('login-current');
    const loginProfId = roleEl ? (roleEl.getAttribute('data-prof-id') || '') : '';
    const role = roleEl ? (roleEl.getAttribute('data-role') || '') : '';
    const pid = pidSel || loginProfId;
    if(onlyIfActive === false || !pid){
      if(durSpan) durSpan.textContent = '—';
      updateTopBarDurationText('');
      return;
    }
    fetch(`/api/profesor_sesion_duracion?profesor_id=${encodeURIComponent(pid)}`)
      .then(r => r.json())
      .then(d => {
        const min = Number(d?.minutos || 0);
        const h = Math.floor(min / 60);
        const m = min % 60;
        const str = `${h}h ${m}m`;
        if(durSpan) durSpan.textContent = pidSel ? str : '—';
        if(role === 'profesor' && loginProfId && String(loginProfId) === String(pid)){
          updateTopBarDurationText(str);
        } else {
          updateTopBarDurationText('');
        }
      })
      .catch(_ => {
        if(durSpan) durSpan.textContent = '—';
        updateTopBarDurationText('');
      });
  }
  function startSesion(){
    try{
      const sel = document.getElementById('profesor-select');
      const pid = sel?.value;
      if(!pid){ if (typeof showToast==='function') showToast('Seleccione un profesor', 'warning'); return; }
      fetch('/api/profesor_sesion_inicio', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ profesor_id: pid, tipo: 'Trabajo' })
      })
      .then(r => r.json())
      .then(d => {
        if(d && d.success !== false && !d.error){
          if (typeof showToast==='function') showToast('Sesión iniciada', 'success');
          refreshSesion();
        } else {
          if (typeof showToast==='function') showToast('No se pudo iniciar la sesión', 'error');
        }
      })
      .catch(_ => { if (typeof showToast==='function') showToast('Error iniciando la sesión', 'error'); });
    }catch(_){}
  }
  function endSesion(){
    try{
      const sel = document.getElementById('profesor-select');
      const pid = sel?.value;
      if(!pid){ if (typeof showToast==='function') showToast('Seleccione un profesor', 'warning'); return; }
      fetch('/api/profesor_sesion_fin', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ profesor_id: pid })
      })
      .then(r => r.json())
      .then(d => {
        if(d && d.success){
          if (typeof showToast==='function') showToast('Sesión finalizada', 'success');
        } else {
          if (typeof showToast==='function') showToast('No se pudo finalizar la sesión', 'error');
        }
        refreshSesion();
      })
      .catch(_ => { if (typeof showToast==='function') showToast('Error finalizando la sesión', 'error'); });
    }catch(_){}
  }

  // --- Numeración de recibos (UI + API) ---
  async function updateReciboNextNumber(){
    try{
      const el = document.getElementById('recibo-next');
      if(!el) return;
      el.textContent = 'Recibo #…';
      const r = await fetch('/api/recibos/numero-proximo', { headers: { 'Accept': 'application/json' } });
      if(r.ok){
        let j = null; try{ j = await r.json(); }catch(_){}
        const num = (j && (j.numero || j.next || j.number)) ? (j.numero || j.next || j.number) : null;
        if(num){ el.textContent = `Recibo #${num}`; }
        else { el.textContent = 'Recibo #—'; }
      } else {
        el.textContent = 'Recibo #—';
      }
    }catch(_){
      const el = document.getElementById('recibo-next');
      if(el) el.textContent = 'Recibo #—';
    }
  }

  function _padLeft(n, len){ try{ const s = String(n||''); return s.length>=len ? s : ('0'.repeat(Math.max(0, len-s.length))+s); }catch(_){ return String(n||''); } }
  function computeReciboPreview(){
    try{
      const prefijo = document.getElementById('recibo-prefijo')?.value || 'REC';
      const sep = document.getElementById('recibo-separador')?.value || '-';
      const n0 = parseInt(document.getElementById('recibo-numero-inicial')?.value || '1', 10) || 1;
      const llen = parseInt(document.getElementById('recibo-longitud-numero')?.value || '6', 10) || 6;
      const y = document.getElementById('recibo-incluir-anio')?.checked ? (new Date().getFullYear()) : null;
      const m = document.getElementById('recibo-incluir-mes')?.checked ? (String(new Date().getMonth()+1).padStart(2,'0')) : null;
      const parts = [];
      if(prefijo) parts.push(prefijo);
      if(y || m){
        const dt = [];
        if(y) dt.push(String(y));
        if(m) dt.push(String(m));
        parts.push(dt.join(sep));
      }
      parts.push(_padLeft(n0, llen));
      const preview = parts.join(sep);
      const el = document.getElementById('recibo-config-preview');
      if(el) el.textContent = `Próximo ejemplo: ${preview}`;
    }catch(_){}
  }

  async function loadReciboConfig(){
    try{
      const r = await fetch('/api/recibos/config', { headers: { 'Accept': 'application/json' } });
      let j = null; try{ j = await r.json(); }catch(_){}
      const cfg = j && typeof j === 'object' ? j : {};
      const setVal = (id, v) => { const el = document.getElementById(id); if(el) el.value = (v ?? el.value ?? ''); };
      const setChk = (id, v) => { const el = document.getElementById(id); if(el) el.checked = !!v; };
      setVal('recibo-prefijo', (cfg.prefijo ?? 'REC'));
      setVal('recibo-separador', (cfg.separador ?? '-'));
      setVal('recibo-numero-inicial', (cfg.numero_inicial ?? 1));
      setVal('recibo-longitud-numero', (cfg.longitud_numero ?? 6));
      setChk('recibo-reiniciar-anual', (cfg.reiniciar_anual ?? false));
      setChk('recibo-incluir-anio', (cfg.incluir_año ?? true));
      setChk('recibo-incluir-mes', (cfg.incluir_mes ?? false));
      computeReciboPreview();
    }catch(_){ computeReciboPreview(); }
  }

  // --- Recibo preview helpers ---
  function addItemRow(data){
    try{
      const rows = document.getElementById('recibo-items-rows');
      if(!rows) return;
      const row = document.createElement('div');
      row.style.display = 'grid';
      row.style.gridTemplateColumns = '1fr 100px 140px 40px';
      row.style.gap = '8px';
      row.style.alignItems = 'center';
      const desc = document.createElement('input'); desc.type='text'; desc.placeholder='Descripción'; desc.style.width='100%'; desc.value = (data && (data.descripcion || data.concepto_nombre)) || '';
      desc.className = 'recibo-item-desc';
      const qty = document.createElement('input'); qty.type='number'; qty.step='1'; qty.inputMode='numeric'; qty.placeholder='1'; qty.value = (data && (data.cantidad != null) ? data.cantidad : 1);
      qty.className = 'recibo-item-cantidad';
      const price = document.createElement('input'); price.type='number'; price.step='0.01'; price.inputMode='decimal'; price.placeholder='0.00'; price.value = (data && (data.precio_unitario != null ? data.precio_unitario : (data.precio ?? 0))) || 0;
      price.className = 'recibo-item-precio';
      const del = document.createElement('button'); del.type='button'; del.className='btn icon-only recibo-item-del'; del.textContent='×'; del.title='Quitar';
      row.appendChild(desc); row.appendChild(qty); row.appendChild(price); row.appendChild(del);
      rows.appendChild(row);
      const onChange = () => { recalcTotalsFromItems(); };
      desc.oninput = onChange; qty.oninput = onChange; price.oninput = onChange;
      del.onclick = () => { try{ rows.removeChild(row); }catch(_){} recalcTotalsFromItems(); };
    }catch(_){ /* noop */ }
  }

  function getItemsArray(){
    try{
      const rows = document.getElementById('recibo-items-rows');
      if(!rows) return [];
      const arr = [];
      Array.from(rows.children || []).forEach((row) => {
        try{
          const inputs = row.querySelectorAll('input');
          const desc = (inputs[0]?.value || '').trim();
          const qty = parseFloat(inputs[1]?.value || '1');
          const price = parseFloat(inputs[2]?.value || '0');
          if(desc){ arr.push({ descripcion: desc, cantidad: isNaN(qty)?1:qty, precio_unitario: isNaN(price)?0:price }); }
        }catch(_){ /* skip row */ }
      });
      return arr;
    }catch(_){ return []; }
  }

  function recalcTotalsFromItems(){
    try{
      const items = getItemsArray();
      let subtotal = 0.0;
      for(const it of items){ subtotal += ((it.cantidad||1) * (it.precio_unitario||0)); }
      const subEl = document.getElementById('recibo-total-subtotal'); if(subEl) subEl.value = Number(subtotal||0).toFixed(2);
      const comEl = document.getElementById('recibo-total-comision'); const com = parseFloat(comEl?.value || '0');
      const totalEl = document.getElementById('recibo-total-total'); if(totalEl) totalEl.value = Number((subtotal||0) + (isNaN(com)?0:com)).toFixed(2);
    }catch(_){ /* noop */ }
  }

  function buildReciboParams(){
    const params = new URLSearchParams();
    const setIf = (k, v) => { try{ const s = String(v||'').trim(); if(s) params.set(k, s); }catch(_){ /* ignore */ } };
    setIf('numero', document.getElementById('recibo-preview-numero')?.value);
    setIf('observaciones', document.getElementById('recibo-preview-observaciones')?.value);
    setIf('emitido_por', document.getElementById('recibo-preview-emitidopor')?.value);
    setIf('titulo', document.getElementById('recibo-preview-titulo')?.value);
    // Fecha: enviar YYYY-MM-DD (backend convierte)
    setIf('fecha', document.getElementById('recibo-preview-fecha')?.value);
    setIf('gym_name', document.getElementById('recibo-preview-gym-nombre')?.value);
    setIf('gym_address', document.getElementById('recibo-preview-gym-direccion')?.value);
    setIf('usuario_nombre', document.getElementById('recibo-preview-usuario-nombre')?.value);
    setIf('usuario_dni', document.getElementById('recibo-preview-usuario-dni')?.value);
    setIf('metodo', document.getElementById('recibo-preview-metodo')?.value);
    // Tipo de cuota y periodo
    try{
      const fechaStr = document.getElementById('recibo-preview-fecha')?.value || '';
      if(fechaStr){
        const d = new Date(fechaStr);
        const meses = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
        const per = `${meses[d.getMonth()]} ${d.getFullYear()}`;
        setIf('periodo', per);
      } else if(state.previewPeriodo){ setIf('periodo', state.previewPeriodo); }
    }catch(_){}
    if(state.previewTipoCuota){ setIf('tipo_cuota', state.previewTipoCuota); }
    try{ params.set('mostrar_logo', document.getElementById('recibo-preview-mostrar-logo')?.checked ? '1':'0'); }catch(_){}
    try{ params.set('mostrar_metodo', document.getElementById('recibo-preview-mostrar-metodo')?.checked ? '1':'0'); }catch(_){}
    try{ params.set('mostrar_dni', document.getElementById('recibo-preview-mostrar-dni')?.checked ? '1':'0'); }catch(_){}
    try{
      const items = getItemsArray();
      if(Array.isArray(items) && items.length){ params.set('items', JSON.stringify(items)); }
    }catch(_){}
    try{
      const sv = document.getElementById('recibo-total-subtotal')?.value || '';
      const cv = document.getElementById('recibo-total-comision')?.value || '';
      const tv = document.getElementById('recibo-total-total')?.value || '';
      if(sv) params.set('subtotal', sv);
      if(cv) params.set('comision', cv);
      if(tv) params.set('total', tv);
    }catch(_){}
    return params;
  }

  function updatePeriodoLabel(){
    try{
      const lbl = document.getElementById('recibo-preview-periodo-label');
      if(!lbl) return;
      const fechaStr = document.getElementById('recibo-preview-fecha')?.value || '';
      let per = '';
      if(fechaStr){
        const d = new Date(fechaStr);
        if(!isNaN(d.getTime())){
          const meses = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
          per = `${meses[d.getMonth()]} ${d.getFullYear()}`;
        }
      }
      if(!per){ per = state.previewPeriodo || ''; }
      const tipo = (state.previewTipoCuota || '').trim();
      const parts = [];
      if(per) parts.push(`Periodo: ${per}`);
      if(tipo) parts.push(`Tipo: ${tipo}`);
      const text = parts.join(' · ');
      lbl.textContent = text;
      lbl.style.display = text ? 'block' : 'none';
      state.previewPeriodo = per || null;
    }catch(_){ /* noop */ }
  }

  async function saveReciboConfig(){
    try{
      const payload = {
        prefijo: document.getElementById('recibo-prefijo')?.value || 'REC',
        separador: document.getElementById('recibo-separador')?.value || '-',
        numero_inicial: parseInt(document.getElementById('recibo-numero-inicial')?.value || '1', 10) || 1,
        longitud_numero: parseInt(document.getElementById('recibo-longitud-numero')?.value || '6', 10) || 6,
        reiniciar_anual: !!document.getElementById('recibo-reiniciar-anual')?.checked,
        incluir_año: !!document.getElementById('recibo-incluir-anio')?.checked,
        incluir_mes: !!document.getElementById('recibo-incluir-mes')?.checked,
      };
      const r = await fetch('/api/recibos/config', { method: 'PUT', headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' }, body: JSON.stringify(payload) });
      let j = null; try{ j = await r.json(); }catch(_){}
      if(r.ok && j && (j.ok || j.success)){
        if (typeof showToast==='function') showToast('Configuración guardada', 'success');
        closeModal('modal-recibo-config');
        updateReciboNextNumber();
      } else {
        if (typeof showToast==='function') showToast(j?.detail || j?.error || 'No se pudo guardar la configuración', 'warning');
      }
    }catch(_){ if (typeof showToast==='function') showToast('Error guardando la configuración', 'error'); }
  }

  function bindReciboConfigEvents(){
    try{
      const btn = document.getElementById('recibo-config-btn');
      const closeBtn = document.getElementById('recibo-config-close');
      const cancelBtn = document.getElementById('recibo-config-cancel');
      const saveBtn = document.getElementById('recibo-config-save');
      const inputs = ['recibo-prefijo','recibo-separador','recibo-numero-inicial','recibo-longitud-numero','recibo-reiniciar-anual','recibo-incluir-anio','recibo-incluir-mes'];
      if(btn) btn.onclick = async () => { await loadReciboConfig(); openModal('modal-recibo-config'); };
      if(closeBtn) closeBtn.onclick = () => { closeModal('modal-recibo-config'); };
      if(cancelBtn) cancelBtn.onclick = () => { closeModal('modal-recibo-config'); };
      if(saveBtn) saveBtn.onclick = () => { saveReciboConfig(); };
      inputs.forEach(id => { const el = document.getElementById(id); if(el){ el.oninput = computeReciboPreview; el.onchange = computeReciboPreview; } });
    }catch(_){}
  }

  // Abrir modal de vista previa de recibo
  async function openReciboPreview(id){
    try {
      state.previewPagoId = id;
      const frame = document.getElementById('recibo-preview-frame');
      const numEl = document.getElementById('recibo-preview-numero');
      // Precargar el número sugerido manteniendo el placeholder
      if(numEl){
        try {
          const r = await fetch('/api/recibos/numero-proximo', { headers: { 'Accept': 'application/json' } });
          let j = null; try{ j = await r.json(); }catch(_){}
          const next = j && (j.numero || j.next || j.number);
          if(next) numEl.value = next;
        } catch(_){ /* mantener valor actual/placeholder */ }
      }
      // Prefill de branding del gimnasio y título por defecto
      try{
        const rg = await fetch('/api/gym/data', { headers: { 'Accept': 'application/json' } });
        let jg = null; try{ jg = await rg.json(); }catch(_){}
        if(rg.ok && jg){
          const gnameEl = document.getElementById('recibo-preview-gym-nombre'); if(gnameEl) gnameEl.value = (jg.gym_name || '').trim();
          const gaddrEl = document.getElementById('recibo-preview-gym-direccion'); if(gaddrEl) gaddrEl.value = (jg.gym_address || '').trim();
        }
      }catch(_){ /* continuar */ }
      try{ const titEl = document.getElementById('recibo-preview-titulo'); if(titEl && !titEl.value) titEl.value = 'RECIBO DE PAGO'; }catch(_){}
      // Prefill desde el pago: usuario, fecha y detalles
      try{
        const r2 = await fetch(`/api/pagos/${id}`, { headers: { 'Accept': 'application/json' } });
        let j2 = null; try{ j2 = await r2.json(); }catch(_){}
        if(r2.ok && j2 && typeof j2 === 'object'){
          const pago = j2.pago || {};
          const detalles = Array.isArray(j2.detalles) ? j2.detalles : [];
          const nombreEl = document.getElementById('recibo-preview-usuario-nombre'); if(nombreEl) nombreEl.value = pago.usuario_nombre || '';
          const dniEl = document.getElementById('recibo-preview-usuario-dni'); if(dniEl) dniEl.value = pago.dni || '';
          const fechaEl = document.getElementById('recibo-preview-fecha'); if(fechaEl){ const f = String(pago.fecha_pago || '').slice(0,10); if(f) fechaEl.value = f; }
          // Método de pago nombre
          try{
            const metodoId = String(pago.metodo_pago_id || pago.metodo_id || '').trim();
            if(metodoId){ const m = state.metodosPagoMap ? state.metodosPagoMap[metodoId] : null; const metEl = document.getElementById('recibo-preview-metodo'); if(metEl) metEl.value = m ? (m.nombre || '') : (metodoId || ''); }
          }catch(_){ /* continuar */ }
          // Tipo de cuota y periodo en estado
          try{
            const u = (state.usuarios || []).find(x => Number(x.id) === Number(pago.usuario_id));
            state.previewTipoCuota = u ? (u.tipo_cuota || null) : null;
          }catch(_){ state.previewTipoCuota = null; }
          try{
            const meses = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
            const per = `${meses[(pago.mes||1)-1]} ${pago.año||new Date().getFullYear()}`;
            state.previewPeriodo = per;
          }catch(_){ state.previewPeriodo = null; }
          // Limpiar ítems y precargar desde detalles
          const rows = document.getElementById('recibo-items-rows'); if(rows) rows.innerHTML = '';
          if(detalles.length){
            detalles.forEach(d => { addItemRow({ descripcion: d.concepto_nombre, cantidad: d.cantidad, precio_unitario: d.precio_unitario }); });
          } else {
            // Si no hay detalles, agregar un ítem vacío para edición rápida
            addItemRow({ descripcion: '', cantidad: 1, precio_unitario: Number(pago.monto||0) });
          }
          recalcTotalsFromItems();
        }
      }catch(_){ /* continuar */ }
      if(frame) { frame.src = `/api/pagos/${id}/recibo.pdf?preview=1#toolbar=0&navpanes=0`; try{ attachWheelZoom('recibo-preview-frame-wrap','recibo-preview-frame'); }catch(_){ } }
      updatePeriodoLabel();
      openModal('modal-recibo-preview');
    } catch(_){
      if (typeof showToast==='function') showToast('No se pudo abrir el recibo', 'error', 4500);
    }
  }

    document.addEventListener('DOMContentLoaded', () => {
      init();
      // Inicializar numeración de recibos (indicador y eventos)
      updateReciboNextNumber();
      bindReciboConfigEvents();
      try {
        const logoutLink = document.querySelector('a[href="/gestion/logout"]');
        if (logoutLink) {
          logoutLink.addEventListener('click', (e) => {
            try {
              const roleEl = document.getElementById('login-current');
              const role = roleEl ? (roleEl.getAttribute('data-role') || '') : '';
              const profId = roleEl ? (roleEl.getAttribute('data-prof-id') || '') : '';
              if(role === 'profesor' && profId){
                e.preventDefault();
                openModal('modal-sesion-fin');
              }
            } catch(_){}
          });
        }
        const closeBtn = document.getElementById('sesion-fin-close');
        const cancelBtn = document.getElementById('sesion-fin-cancel');
        const confirmBtn = document.getElementById('sesion-fin-confirm');
        if (closeBtn) closeBtn.onclick = () => { closeModal('modal-sesion-fin'); };
        if (cancelBtn) cancelBtn.onclick = () => { closeModal('modal-sesion-fin'); };
        if (confirmBtn) confirmBtn.onclick = async () => {
          try {
            confirmBtn.disabled = true;
            const r = await fetch('/api/profesor_sesion_fin', { method: 'POST', headers: { 'Accept': 'application/json' } });
            let ok = r.ok;
            let j = null;
            try { j = await r.json(); } catch(_){}
            if(ok && j && j.success){
              if(typeof showToast==='function') showToast('Sesión finalizada', 'success');
              closeModal('modal-sesion-fin');
              window.location.href = '/gestion/logout';
            } else {
              if(typeof showToast==='function') showToast(j?.detail || j?.error || 'No se pudo finalizar la sesión', 'warning');
              // No redirigir si falla
            }
          } catch(_){
            if(typeof showToast==='function') showToast('Error finalizando la sesión', 'error');
            // No redirigir si falla
          } finally {
            confirmBtn.disabled = false;
          }
        };
      } catch(e){ console.error('Error configurando salida con finalización', e); }
    });
  </script>
</body>
</html>