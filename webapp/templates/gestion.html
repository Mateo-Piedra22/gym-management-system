<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gestión • {{ gym_name }}</title>
  <link rel="stylesheet" href="/static/style.css" />
  <script>
    (function(){
      function loadScript(src){
        return new Promise(function(resolve, reject){
          try {
            var s = document.createElement('script');
            s.src = src; s.async = true;
            s.onload = function(){ resolve(true); };
            s.onerror = function(){ reject(new Error('Failed to load ' + src)); };
            document.head.appendChild(s);
          } catch(e){ reject(e); }
        });
      }
      async function loadQRCodeLib(){
        if (window.QRCode) return true;
        var sources = [
          'https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js',
          'https://unpkg.com/qrcode@1.5.1/build/qrcode.min.js',
          'https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.1/qrcode.min.js',
          '/static/libs/qrcode.min.js'
        ];
        for (var i=0; i<sources.length; i++){
          try {
            await loadScript(sources[i]);
            if (window.QRCode) return true;
          } catch(_){}
        }
        return false;
      }
      try { window.loadQRCodeLib = loadQRCodeLib; } catch(_){}
      // Intento inicial de carga (no bloqueante)
      try { loadQRCodeLib(); } catch(_){}
    })();
  </script>
  <script src="/static/js/toast.js"></script>
  <link rel="icon" href="{{ logo_url }}" />
  <meta name="theme-color" content="{{ theme['--primary'] if theme and '--primary' in theme else '#2b8a3e' }}">
  <meta name="color-scheme" content="dark light">
  <style>
    .layout { display:flex; flex-direction:column; min-height:100vh; min-height: 100dvh; }
    header { display:flex; flex-direction:column; gap:8px; padding:16px 24px; border-bottom:1px solid var(--border); backdrop-filter: blur(8px); position: sticky; top:0; z-index:10; background: rgba(17,24,39,0.75); transition: transform 160ms ease; }
    .brand { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .brand .info { display:flex; align-items:center; gap:8px; }
    .brand img { width:32px; height:32px; }
    .nav-actions { display:flex; gap:8px; align-items:center; }
    /* Logout más compacto */
    .nav-actions .btn.icon-only { padding: 4px; }
    .nav-actions img { width: 20px; height: 20px; }
    .tabs { display:flex; flex-wrap: wrap; gap:8px; padding: 8px 24px; border-bottom: 1px solid var(--border); max-width: 100%; }
    .tab { padding: 8px 12px; border-radius: 10px; background: rgba(255,255,255,.06); cursor:pointer; }
    .tab.active { background: var(--card); border:1px solid var(--border); }
    main { flex: 1; padding: 16px 24px; width: 100%; max-width: 100%; min-height: 0; overflow-x: hidden; overflow-y: auto; }
    .panel { display:none; }
    .panel.active { display:block; }
    .panel-controls { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom: 12px; }
    .panel-controls > * { min-width: 0; max-width: 100%; flex: 1 1 auto; }
    .panel-controls input[type="date"],
    .panel-controls input[type="text"],
    .panel-controls select { background: #0b1220; color: var(--text); border: 1px solid var(--border); border-radius: 10px; padding: 8px 10px; }
    table { width:100%; border-collapse: collapse; }
    th, td { padding: 10px; border-bottom: 1px solid var(--border); text-align: left; }
    th { color: var(--muted); font-weight: 600; }
    .muted { color: var(--muted); }
    *, *::before, *::after { box-sizing: border-box; }
    html, body { width: 100%; max-width: 100%; }
    /* Tarjetas y tablas mejoradas */
    .cards { display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 16px; align-items: stretch; max-width: 100%; }
    .cards > * { min-width: 0; }
    .card { padding: 12px; background: var(--card); border: 1px solid var(--border); border-radius: 12px; min-width: 0; }
    .card-title { font-size: 12px; color: var(--muted); }
    .card-value { font-size: 20px; font-weight: 600; margin-top: 6px; }
    .table-scroll { overflow:auto; overflow-x:auto; overflow-y:auto; width:100%; max-width:100%; max-height:60vh; border: 1px solid var(--border); border-radius: 12px; -webkit-overflow-scrolling: touch; }
     .table-scroll thead th { position: sticky; top: 0; background: rgba(17,24,39,0.9); backdrop-filter: blur(4px); }
     .table-scroll table { table-layout: auto; width: max-content; min-width: 100%; }
     .table-scroll th, .table-scroll td { overflow-wrap: normal; word-break: normal; white-space: normal; }
     .table-actions { display:flex; gap:8px; justify-content:flex-end; flex-wrap: nowrap; white-space: nowrap; min-width: max-content; }
     .table-actions .btn { margin: 0; flex: 0 0 auto; }
    /* Modales */
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 100; }
    .modal { width: 640px; max-width: 95vw; background: var(--card); border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 20px 30px rgba(0,0,0,0.35); overflow: hidden; display:flex; flex-direction:column; }
    .modal-header { display:flex; align-items:center; justify-content:space-between; padding: 12px 16px; border-bottom: 1px solid var(--border); }
    .modal-body { padding: 16px; flex: 1 1 auto; overflow-y: auto; }
    .modal-footer { display:flex; gap:8px; padding: 12px 16px; border-top: 1px solid var(--border); justify-content: flex-end; }
    .modal-backdrop.active { display:flex; }
    .input-row { display:flex; gap:8px; flex-wrap:wrap; }
    .input-row > * { min-width: 0; }
    /* Split panel layout */
    .split { display:grid; grid-template-columns: minmax(0,1fr) 380px; gap:16px; align-items:start; }
    .split-main { min-width: 0; }
    .split-side { position: sticky; top: 96px; height: calc(100dvh - 140px); overflow: auto; }
    .block { background: var(--card); border: 1px solid var(--border); border-radius: 12px; max-width: 100%; }
    .block-header { display:flex; align-items:center; justify-content:space-between; gap:8px; padding: 10px 12px; border-bottom: 1px solid var(--border); }
    .block-body { padding:12px; }
    .side-empty { color: var(--muted); padding: 16px; }
    .row-selectable tr:hover { background: rgba(255,255,255,.04); cursor: pointer; }
    .table-compact th, .table-compact td { padding: 8px; word-break: break-word; }
    @media (max-width: 960px){ .split { grid-template-columns: 1fr; } .split-side { position: static; height:auto; } }
    @media (max-width: 640px){
      header { padding: 12px; }
      main { padding: 12px; }
      .brand { flex-direction: column; align-items: flex-start; gap: 10px; }
      .nav-actions { width: 100%; justify-content: flex-end; }
      .modal { width: 95vw; margin: 0 8px; max-height: 90vh; }
      .input-row { flex-direction: column; }
      .input-row > * { flex: 1 1 100%; width: 100%; }
      .panel-controls { flex-direction: column; align-items: stretch; }
      .panel-controls > * { width: 100%; }
      .tabs { flex-wrap: wrap; width: 100%; }
      .table-scroll { max-height: 60vh; }
    }
    @media (max-width: 768px){
      .cards { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 480px){
      .cards { grid-template-columns: 1fr; }
    }
    /* Botón pequeño y variantes */
    .btn.sm { padding: 6px 10px; font-size: 12px; border-radius: 8px; }
    .btn.icon-only { padding: 6px; border-radius: 8px; background: transparent; }
    .btn.icon-only:hover { background: rgba(255,255,255,0.06); }
    .btn[disabled] { opacity: 0.55; cursor: not-allowed; }
    /* Toasts */
    .toast-container { position: fixed; top: 16px; right: 16px; display: flex; flex-direction: column; gap: 8px; z-index: 200; pointer-events: none; }
    .toast { pointer-events: all; background: var(--card); border: 1px solid var(--border); border-left: 4px solid var(--accent); border-radius: 10px; padding: 10px 12px; min-width: 240px; max-width: 400px; box-shadow: 0 12px 24px rgba(0,0,0,0.35); display: flex; align-items: center; justify-content: space-between; gap: 8px; }
    .toast .message { flex: 1; }
    .toast .actions { display: flex; gap: 8px; }
    .toast.success { border-left-color: #22c55e; }
    .toast.warning { border-left-color: #f59e0b; }
    .toast.error { border-left-color: #ef4444; }
    /* Tabs hover */
    .tab:hover { background: rgba(255,255,255,.12); }
    .header--hidden { transform: translateY(-100%); }

    /* Zebra stripes y selección */
    .table-scroll tbody tr:nth-child(odd){ background: rgba(255,255,255,.03); }
    .row-selectable tr.selected{ background: rgba(34,197,94,.14); outline: 1px solid rgba(34,197,94,.35); }
    /* Animaciones toast */
    @keyframes toast-in { from { opacity: 0; transform: translateY(-6px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes toast-out { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-6px); } }
    /* Animaciones modal */
    @keyframes modal-in { from { opacity: 0; transform: translateY(-6px) scale(.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
    @keyframes modal-out { from { opacity: 1; transform: translateY(0) scale(1); } to { opacity: 0; transform: translateY(-6px) scale(.98); } }
    .modal-backdrop.active .modal{ animation: modal-in 180ms ease-out; }
    .modal.closing{ animation: modal-out 160ms ease-in forwards; }
    /* Mini loader overlay */
    #usuario-side{ position: relative; }
    .loader-overlay{ position:absolute; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,0.35); backdrop-filter: blur(2px); z-index: 5; }
    .loader-overlay.active{ display:flex; }
    .loader-overlay .spinner{ width:24px; height:24px; border:3px solid var(--border); border-top-color:#22c55e; border-radius:50%; animation: spin .8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

  </style>
</head>
<body>
  <div class="layout">
    <header id="main-header">
      <div class="brand">
        <div class="info">
          <img src="{{ logo_url }}" alt="Logo" />
          <div>
            <h1 style="margin:0; font-size: 18px;">Gestión • {{ gym_name }}</h1>
            <p class="muted" style="margin:2px 0 0 0">Gestión centralizada</p>
          </div>
        </div>
        <div class="nav-actions">
          <a class="btn icon-only" href="/logout" title="Cerrar sesión" aria-label="Salir">
            <img src="/assets/salir.png" alt="Salir" />
          </a>
        </div>
      </div>
      <nav class="tabs">
        <button class="tab active" data-tab="usuarios">Usuarios</button>
        <button class="tab" data-tab="pagos">Pagos</button>
        <button class="tab" data-tab="configuracion">Configuración</button>
      </nav>
    </header>

    <main>
      <section id="panel-pagos" class="panel">
        <div class="split">
          <div class="split-main">
            <div class="panel-controls">
              <label>Desde</label>
              <input type="date" id="pagos-start" />
              <label>Hasta</label>
              <input type="date" id="pagos-end" />
              <label>Búsqueda</label>
              <input type="text" id="pagos-q" placeholder="Nombre / DNI / Método / Concepto" />
              <select id="pagos-limit">
                <option value="25">25</option>
                <option value="50" selected>50</option>
                <option value="100">100</option>
              </select>
              <button class="btn" id="pagos-refresh">Actualizar</button>
              <button class="btn secondary" id="pagos-filtros-btn">Filtros avanzados</button>
              <button class="btn" id="pagos-new">Nuevo Pago</button>
              <button class="btn secondary" id="pagos-export-csv">Exportar CSV</button>
              <span id="pagos-count" class="muted" style="margin-left:auto"></span>
            </div>
            <div class="cards" id="pagos-cards">
              <div class="card"><div class="card-title">Pagos mostrados</div><div class="card-value" id="pagos-card-count">0</div></div>
              <div class="card"><div class="card-title">Monto total</div><div class="card-value" id="pagos-card-monto">$0</div></div>
              <div class="card"><div class="card-title">Pagadores únicos</div><div class="card-value" id="pagos-card-unique">0</div></div>
              <div class="card"><div class="card-title">Promedio por pago</div><div class="card-value" id="pagos-card-average">$0</div></div>
            </div>
            <div class="table-scroll row-selectable">
              <table id="pagos-table">
                <thead>
                  <tr>
                    <th>Fecha</th>
                    <th>Usuario</th>
                    <th>DNI</th>
                    <th>Método</th>
                    <th>Concepto</th>
                    <th>Monto</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
          <aside class="split-side">
            <div class="block">
              <div class="block-header">
                <div style="display:flex; align-items:center; gap:8px">
                  <h3 style="margin:0; font-size:16px;">Pago seleccionado</h3>
                  <span id="pago-side-id" class="muted"></span>
                </div>
                <button class="btn secondary" id="pagos-clear-selection">Limpiar</button>
              </div>
              <div class="block-body">
                <div id="pago-side-empty" class="side-empty">Selecciona un pago para ver detalles.</div>
                <div id="pago-side" style="display:none">
                  <div class="input-row">
                    <div style="flex:1"><label class="muted">Fecha</label><div id="pago-side-fecha"></div></div>
                    <div style="flex:1"><label class="muted">Monto</label><div id="pago-side-monto"></div></div>
                  </div>
                  <div class="input-row">
                    <div style="flex:1"><label class="muted">Usuario</label><div id="pago-side-nombre"></div></div>
                    <div style="flex:1"><label class="muted">DNI</label><div id="pago-side-dni"></div></div>
                  </div>
                  <div class="input-row">
                    <div style="flex:1"><label class="muted">Método</label><div id="pago-side-metodo"></div></div>
                    <div style="flex:1"><label class="muted">Concepto</label><div id="pago-side-concepto"></div></div>
                  </div>
                  <div style="margin-top:12px">
                    <h4 style="margin:0 0 8px 0; font-size:14px;">Items</h4>
                    <div class="table-scroll table-compact">
                      <table id="pago-detalles-table">
                        <thead><tr><th>Concepto</th><th>Cantidad</th><th>Precio</th><th>Subtotal</th></tr></thead>
                        <tbody></tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="block" style="margin-top:12px">
              <div class="block-header"><h3 style="margin:0; font-size:16px;">Acciones rápidas</h3></div>
              <div class="block-body">
                <div class="input-row">
                  <button class="btn" id="pago-side-ver-usuario">Ver usuario</button>
                  <button class="btn secondary" id="pago-side-ver-detalle">Ver detalle</button>
                  <button class="btn" id="pago-side-editar">Editar pago</button>
                  <button class="btn secondary" id="pago-side-eliminar">Eliminar pago</button>
                </div>
              </div>
            </div>
            <div class="block" style="margin-top:12px">
              <div class="block-header"><h3 style="margin:0; font-size:16px;">Notas</h3></div>
              <div class="block-body"><div id="pago-side-notas" class="muted">—</div></div>
            </div>
          </aside>
        </div>
      </section>

      <section id="panel-usuarios" class="panel active">
        <div class="split">
          <div class="split-main">
            <div class="cards" id="usuarios-cards">
              <div class="card"><div class="card-title">Total usuarios mostrados</div><div class="card-value" id="usuarios-card-count">0</div></div>
              <div class="card"><div class="card-title">Activos</div><div class="card-value" id="usuarios-card-activos">0</div></div>
              <div class="card"><div class="card-title">Inactivos</div><div class="card-value" id="usuarios-card-inactivos">0</div></div>
              <div class="card"><div class="card-title">Profesores</div><div class="card-value" id="usuarios-card-profesores">0</div></div>
              <div class="card"><div class="card-title">Sin teléfono</div><div class="card-value" id="usuarios-card-sin-telefono">0</div></div>
              <div class="card"><div class="card-title">Con notas</div><div class="card-value" id="usuarios-card-con-notas">0</div></div>
            </div>
            <div class="panel-controls">
              <label>Búsqueda</label>
              <input type="text" id="usuarios-q" placeholder="Nombre o DNI" />
              <select id="usuarios-limit">
                <option value="25">25</option>
                <option value="50" selected>50</option>
                <option value="100">100</option>
              </select>
              <button class="btn" id="usuarios-refresh">Actualizar</button>
              <button class="btn" id="usuarios-new">Nuevo Usuario</button>
              <button class="btn secondary" id="usuarios-export-csv">Exportar CSV</button>
              <span id="usuarios-count" class="muted" style="margin-left:auto"></span>
            </div>
            <div class="table-scroll row-selectable">
              <table id="usuarios-table">
                <thead>
                  <tr>
                    <th>Nombre</th>
                    <th>DNI</th>
                    <th>Teléfono</th>
                    <th>Rol</th>
                    <th>Tipo Cuota</th>
                    <th>Activo</th>
                    <th>Hoy</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
          <aside class="split-side">
            <div class="block">
              <div class="block-header">
                <div style="display:flex; align-items:center; gap:8px">
                  <h3 style="margin:0; font-size:16px;">Usuario seleccionado</h3>
                  <span id="usuario-side-id" class="muted"></span>
                </div>
                <button class="btn secondary" id="usuarios-clear-selection">Limpiar</button>
              </div>
              <div class="block-body">
                <div id="usuario-side-empty" class="side-empty">Selecciona un usuario para ver sus datos y pagos.</div>
                <div id="usuario-side" style="display:none">
                  <div id="usuario-side-loader" class="loader-overlay"><div class="spinner"></div><span style="margin-left:8px">Cargando…</span></div>
                  <div class="cards" style="grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));">
                    <div class="card"><div class="card-title">Estado</div><div class="card-value" id="usuario-side-estado">—</div></div>
                    <div class="card"><div class="card-title">Próximo vencimiento</div><div class="card-value" id="usuario-side-vencimiento">—</div></div>
                    <div class="card"><div class="card-title">Cuotas vencidas</div><div class="card-value" id="usuario-side-cuotas-vencidas">—</div></div>
                    <div class="card"><div class="card-title">Asistencias recientes (30d)</div><div class="card-value" id="usuario-side-asistencias-recientes">—</div></div>
                  </div>
                  <div class="input-row" style="margin-top:8px">
                    <div style="flex:1"><label class="muted">Nombre</label><div id="usuario-side-nombre"></div></div>
                    <div style="flex:1"><label class="muted">DNI</label><div id="usuario-side-dni"></div></div>
                  </div>
                  <div class="input-row">
                    <div style="flex:1"><label class="muted">Teléfono</label><div id="usuario-side-telefono"></div></div>
                    <div style="flex:1"><label class="muted">Rol</label><div id="usuario-side-rol"></div></div>
                  </div>
                  <div class="input-row">
                    <div style="flex:1"><label class="muted">Tipo de cuota</label><div id="usuario-side-tipo-cuota"></div></div>
                    <div style="flex:1"><label class="muted">Último pago</label><div id="usuario-side-ultimo-pago"></div></div>
                  </div>
                  <div style="margin-top:12px">
                    <h4 style="margin:0 0 8px 0; font-size:14px;">Historial de pagos</h4>
                    <div class="table-scroll table-compact">
                      <table id="usuario-historial-table">
                        <thead><tr><th>Fecha</th><th>Método</th><th>Concepto</th><th>Monto</th></tr></thead>
                        <tbody></tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="block" style="margin-top:12px">
              <div class="block-header"><h3 style="margin:0; font-size:16px;">Acciones rápidas</h3></div>
              <div class="block-body">
                <div class="input-row">
                  <button class="btn" id="usuario-side-editar">Editar usuario</button>
                  <button class="btn secondary" id="usuario-side-eliminar">Eliminar</button>
                  <button class="btn" id="usuario-side-ver-pagos">Ver pagos</button>
                  <button class="btn secondary" id="usuario-side-toggle-activo">Activar/Inactivar</button>
                  <button class="btn" id="usuario-side-registrar">Registrar pago</button>
                  <button class="btn" id="usuario-side-qr">Emitir QR Check-in</button>
                  <button class="btn secondary" id="usuario-side-asistencia">Registrar asistencia</button>
                </div>
              </div>
            </div>
            <div class="block" style="margin-top:12px">
              <div class="block-header"><h3 style="margin:0; font-size:16px;">Notas</h3></div>
              <div class="block-body"><div id="usuario-side-notas" class="muted">—</div></div>
            </div>
          </aside>
        </div>
      </section>
      <section id="panel-configuracion" class="panel">
        <div class="split">
          <div class="split-main">
            <div class="block">
              <div class="block-header">
                <h3 style="margin:0; font-size:16px;">Tipos de cuota</h3>
                <div class="panel-controls" style="margin-left:auto">
                  <button class="btn" id="config-tipos-refresh">Actualizar</button>
                  <button class="btn" id="config-tipos-new">Nuevo</button>
                </div>
              </div>
              <div class="block-body">
                <div class="table-scroll row-selectable">
                  <table id="config-tipos-table">
                    <thead>
                      <tr>
                        <th>Nombre</th>
                        <th>Precio</th>
                        <th>Duración (días)</th>
                        <th>Activo</th>
                        <th>Acciones</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>

            <div class="block" style="margin-top:16px">
              <div class="block-header">
                <h3 style="margin:0; font-size:16px;">Conceptos de pago</h3>
                <div class="panel-controls" style="margin-left:auto">
                  <button class="btn" id="config-conceptos-refresh">Actualizar</button>
                  <button class="btn" id="config-conceptos-new">Nuevo</button>
                </div>
              </div>
              <div class="block-body">
                <div class="table-scroll row-selectable">
                  <table id="config-conceptos-table">
                    <thead>
                      <tr>
                        <th>Nombre</th>
                        <th>Precio base</th>
                        <th>Tipo</th>
                        <th>Activo</th>
                        <th>Categoría</th>
                        <th>Acciones</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>

            <div class="block" style="margin-top:16px">
              <div class="block-header">
                <h3 style="margin:0; font-size:16px;">Métodos de pago</h3>
                <div class="panel-controls" style="margin-left:auto">
                  <button class="btn" id="config-metodos-refresh">Actualizar</button>
                  <button class="btn" id="config-metodos-new">Nuevo</button>
                </div>
              </div>
              <div class="block-body">
                <div class="table-scroll row-selectable">
                  <table id="config-metodos-table">
                    <thead>
                      <tr>
                        <th>Nombre</th>
                        <th>Comisión (%)</th>
                        <th>Color</th>
                        <th>Activo</th>
                        <th>Acciones</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>

          </div>
        </div>
      </section>

    </main>

    <!-- Modal: Filtros avanzados de Pagos -->
    <div class="modal-backdrop" id="modal-pagos-filtros" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-pagos-filtros-title">
        <div class="modal-header">
          <h3 id="modal-pagos-filtros-title" style="margin:0; font-size:16px;">Filtros avanzados</h3>
          <button class="btn icon-only" id="pagos-filtros-close" aria-label="Cerrar">×</button>
        </div>
        <div class="modal-body">
          <div class="input-row">
            <div style="flex:1">
              <label class="muted">Método de pago</label>
              <select id="pagos-metodo" style="width:100%"></select>
            </div>
            <div style="flex:1">
              <label class="muted">Concepto</label>
              <select id="pagos-concepto" style="width:100%"></select>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn" id="pagos-filtros-aplicar">Aplicar</button>
          <button class="btn secondary" id="pagos-filtros-cancelar">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- Modal: Detalle de Pago -->
    <div class="modal-backdrop" id="modal-pago-detalle" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-pago-detalle-title">
        <div class="modal-header">
          <h3 id="modal-pago-detalle-title" style="margin:0; font-size:16px;">Detalle de pago</h3>
          <button class="btn icon-only" id="pago-detalle-close" aria-label="Cerrar">×</button>
        </div>
        <div class="modal-body">
          <div class="input-row">
            <div style="flex:1"><label class="muted">Fecha</label><div id="pago-detalle-fecha"></div></div>
            <div style="flex:1"><label class="muted">Usuario</label><div id="pago-detalle-nombre"></div></div>
          </div>
          <div class="input-row">
            <div style="flex:1"><label class="muted">DNI</label><div id="pago-detalle-dni"></div></div>
            <div style="flex:1"><label class="muted">Monto</label><div id="pago-detalle-monto"></div></div>
          </div>
          <div class="input-row">
            <div style="flex:1"><label class="muted">Método</label><div id="pago-detalle-metodo"></div></div>
            <div style="flex:1"><label class="muted">Concepto</label><div id="pago-detalle-concepto"></div></div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn secondary" id="pago-detalle-cerrar">Cerrar</button>
        </div>
      </div>
    </div>

    <!-- Modal: Usuario (Crear/Editar) -->
    <div class="modal-backdrop" id="modal-usuario" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-usuario-title">
        <div class="modal-header">
          <h3 id="modal-usuario-title" style="margin:0; font-size:16px;">Usuario</h3>
          <button class="btn icon-only" id="usuarios-modal-close" aria-label="Cerrar">×</button>
        </div>
        <div class="modal-body">
          <div class="input-row">
            <input id="u-nombre" type="text" placeholder="Nombre Completo" style="flex:1" />
            <input id="u-dni" type="text" placeholder="DNI" style="flex:1" />
          </div>
          <div class="input-row">
            <input id="u-telefono" type="text" placeholder="Teléfono" style="flex:1" />
            <input id="u-pin" type="text" placeholder="PIN (opcional)" style="flex:1" />
          </div>
          <div class="input-row">
            <select id="u-rol" style="flex:1">
              <option value="socio" selected>Socio</option>
              <option value="profesor">Profesor</option>
            </select>
            <select id="u-tipo-cuota" style="flex:1">
              <option value="">Tipo de cuota</option>
            </select>
            <label style="display:flex; align-items:center; gap:6px; flex:1">
              <input id="u-activo" type="checkbox" checked /> Activo
            </label>
          </div>
          <textarea id="u-notas" rows="3" placeholder="Notas" style="width:100%; margin-top:8px;"></textarea>
        </div>
        <div class="modal-footer">
          <button class="btn" id="usuarios-save">Guardar</button>
          <button class="btn secondary" id="usuarios-cancel">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- Modal: Confirmar eliminación de Usuario -->
    <div class="modal-backdrop" id="modal-usuarios-delete" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-usuarios-delete-title">
        <div class="modal-header">
          <h3 id="modal-usuarios-delete-title" style="margin:0; font-size:16px;">Eliminar usuario</h3>
          <button class="btn icon-only" id="usuarios-delete-close" aria-label="Cerrar">×</button>
        </div>
        <div class="modal-body">
          <p>¿Estás seguro? Esta acción es permanente.</p>
        </div>
        <div class="modal-footer">
          <button class="btn" id="usuarios-delete-confirm">Eliminar</button>
          <button class="btn secondary" id="usuarios-delete-cancel">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- Modal: Confirmar eliminación de Pago -->
    <div class="modal-backdrop" id="modal-pagos-delete" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-pagos-delete-title">
        <div class="modal-header">
          <h3 id="modal-pagos-delete-title" style="margin:0; font-size:16px;">Eliminar pago</h3>
          <button class="btn icon-only" id="pagos-delete-close" aria-label="Cerrar">×</button>
        </div>
        <div class="modal-body">
          <p>¿Estás seguro? Esta acción es permanente.</p>
        </div>
        <div class="modal-footer">
          <button class="btn" id="pagos-delete-confirm">Eliminar</button>
          <button class="btn secondary" id="pagos-delete-cancel">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- Modal: Pago (Crear/Editar) -->
    <div class="modal-backdrop" id="modal-pago-form" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="pago-form-title">
        <div class="modal-header">
          <h3 id="pago-form-title" style="margin:0; font-size:16px;">Pago</h3>
          <button class="btn icon-only" id="pago-form-close" aria-label="Cerrar">×</button>
        </div>
        <div class="modal-body">
          <div class="input-row">
            <select id="pago-usuario" style="flex:1">
              <option value="">Seleccionar usuario</option>
            </select>
            <input id="pago-monto" type="number" step="0.01" placeholder="Monto (auto)" style="flex:1" readonly />
          </div>
          <div class="input-row">
            <input id="pago-fecha" type="date" style="flex:1" />
            <input id="pago-mes" type="number" min="1" max="12" placeholder="Mes" style="flex:1" />
            <input id="pago-año" type="number" min="2000" max="2100" placeholder="Año" style="flex:1" />
          </div>
          <div class="input-row">
            <select id="pago-metodo" style="flex:1">
              <option value="">Método de pago (opcional)</option>
            </select>
          </div>
          <div class="input-row">
            <select id="pago-concepto" style="flex:1">
              <option value="">Concepto</option>
            </select>
          </div>
          <div id="pago-resumen" class="calc-summary" style="margin-top:8px; font-size:12px; color:#555">
            <div><strong>Concepto:</strong> <span id="pago-resumen-concepto">Cuota Mensual</span></div>
            <div><strong>Base:</strong> $<span id="pago-resumen-base">—</span></div>
            <div><strong>Comisión:</strong> $<span id="pago-resumen-comision">—</span> <span id="pago-resumen-comision-porcentaje"></span></div>
            <div><strong>Total:</strong> $<span id="pago-resumen-total">—</span></div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn" id="pago-save">Guardar</button>
          <button class="btn secondary" id="pago-form-cancel">Cancelar</button>
        </div>
      </div>
    </div>

  </div>

  <!-- Modal: Tipo de Cuota (Crear/Editar) -->
  <div class="modal-backdrop" id="modal-tipo-cuota" style="display:none" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-tipo-cuota-title">
      <div class="modal-header">
        <h3 id="modal-tipo-cuota-title">Tipo de Cuota</h3>
        <button class="modal-close" id="close-modal-tipo-cuota" aria-label="Cerrar">×</button>
      </div>
      <div class="modal-body">
        <div class="form-grid">
          <div class="form-row">
            <label>Nombre</label>
            <input type="text" id="tipo-nombre" placeholder="Mensual, Trimestral, ...">
          </div>
          <div class="form-row">
            <label>Precio</label>
            <input type="number" id="tipo-precio" min="0" step="0.01">
          </div>
          <div class="form-row">
            <label>Duración (días)</label>
            <input type="number" id="tipo-duracion" min="1" step="1">
          </div>
          <div class="form-row">
            <label>Activo</label>
            <select id="tipo-activo">
              <option value="true">Sí</option>
              <option value="false">No</option>
            </select>
          </div>
          <div class="form-row">
            <label>Descripción</label>
            <textarea id="tipo-descripcion"></textarea>
          </div>
          <div class="form-row">
            <label>Icono (ruta opcional)</label>
            <input type="text" id="tipo-icono" placeholder="/static/icons/monthly.svg">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" id="save-tipo-cuota">Guardar</button>
        <button class="btn" id="cancel-tipo-cuota">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal: Concepto de Pago (Crear/Editar) -->
  <div class="modal-backdrop" id="modal-concepto" style="display:none" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-concepto-title">
      <div class="modal-header">
        <h3 id="modal-concepto-title">Concepto de Pago</h3>
        <button class="modal-close" id="close-modal-concepto" aria-label="Cerrar">×</button>
      </div>
      <div class="modal-body">
        <div class="form-grid">
          <div class="form-row">
            <label>Nombre</label>
            <input type="text" id="concepto-nombre" placeholder="Cuota Mensual, Matrícula, ...">
          </div>
          <div class="form-row">
            <label>Precio base</label>
            <input type="number" id="concepto-precio-base" min="0" step="0.01">
          </div>
          <div class="form-row">
            <label>Tipo</label>
            <input type="text" id="concepto-tipo" placeholder="cuota, servicio">
          </div>
          <div class="form-row">
            <label>Activo</label>
            <select id="concepto-activo">
              <option value="true">Sí</option>
              <option value="false">No</option>
            </select>
          </div>
          <div class="form-row">
            <label>Categoría</label>
            <input type="text" id="concepto-categoria" placeholder="mensualidad, inscripción">
          </div>
          <div class="form-row">
            <label>Descripción</label>
            <textarea id="concepto-descripcion"></textarea>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" id="save-concepto">Guardar</button>
        <button class="btn" id="cancel-concepto">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal: Método de Pago (Crear/Editar) -->
  <div class="modal-backdrop" id="modal-metodo" style="display:none" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-metodo-title">
      <div class="modal-header">
        <h3 id="modal-metodo-title">Método de Pago</h3>
        <button class="modal-close" id="close-modal-metodo" aria-label="Cerrar">×</button>
      </div>
      <div class="modal-body">
        <div class="form-grid">
          <div class="form-row">
            <label>Nombre</label>
            <input type="text" id="metodo-nombre" placeholder="Efectivo, Tarjeta, ...">
          </div>
          <div class="form-row">
            <label>Comisión (%)</label>
            <input type="number" id="metodo-comision" min="0" step="0.01">
          </div>
          <div class="form-row">
            <label>Color</label>
            <input type="text" id="metodo-color" placeholder="#00AA66">
          </div>
          <div class="form-row">
            <label>Activo</label>
            <select id="metodo-activo">
              <option value="true">Sí</option>
              <option value="false">No</option>
            </select>
          </div>
          <div class="form-row">
            <label>Descripción</label>
            <textarea id="metodo-descripcion"></textarea>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" id="save-metodo">Guardar</button>
        <button class="btn" id="cancel-metodo">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal: QR Check-in Toast -->
  <div class="modal-backdrop" id="modal-qr-toast" style="display:none" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-qr-title">
      <div class="modal-header">
        <h3 id="modal-qr-title" style="margin:0; font-size:16px;">QR Check-in</h3>
        <button class="modal-close" id="qr-close-btn" aria-label="Cerrar">×</button>
      </div>
      <div class="modal-body" style="text-align:center">
        <div class="muted" id="qr-user-name" style="margin-bottom:6px">—</div>
        <canvas id="qr-canvas" width="240" height="240" style="display:inline-block; border-radius:8px; background:#fff; margin-bottom:8px"></canvas>
        <div class="muted" id="qr-token-masked" style="margin-top:4px">token: —</div>
        <div style="margin-top:8px">
          <strong>Tiempo restante:</strong> <span id="qr-countdown">—</span>
        </div>
        <div id="qr-status-msg" class="muted" style="margin-top:8px">Esperando confirmación…</div>
      </div>
      <div class="modal-footer">
        <button class="btn secondary" id="qr-close-footer">Cerrar</button>
      </div>
    </div>
  </div>

  <div id="toast-container" class="toast-container"></div>

  <script>
    let editingUserId = null;
    let editingPagoId = null;
    const state = { pagos: [], pagosFilters: { metodo: '', concepto: '' }, deleteUserId: null, deletePagoId: null, selectedPago: null, selectedUsuario: null, usuarioHistorial: [], configTipos: [], configConceptos: [], configMetodos: [], editingTipoId: null, editingConceptoId: null, editingMetodoId: null, deleteTipoId: null, deleteConceptoId: null, deleteMetodoId: null, tiposCuotaActivos: [], tiposCuotaMap: {}, metodosPago: [], metodosPagoMap: {} };

    function fmtDate(d){
      if(!d) return '';
      const dt = new Date(d);
      if(isNaN(dt.getTime())) return d;
      const y = dt.getFullYear();
      const m = String(dt.getMonth()+1).padStart(2,'0');
      const day = String(dt.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }
    function defaultRange(){
      const end = new Date();
      const start = new Date(end);
      start.setDate(end.getDate() - 30);
      return { start: fmtDate(start), end: fmtDate(end) };
    }
    function switchTab(tab){
      document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
      const panel = document.getElementById(`panel-${tab}`);
      if(panel) panel.classList.add('active');
    }

    function openModal(id){ const el = document.getElementById(id); if(el){ el.classList.add('active'); el.style.display = 'flex'; el.setAttribute('aria-hidden','false'); const modalEl = el.querySelector('.modal'); if(modalEl){ const labelId = modalEl.getAttribute('aria-labelledby'); if(labelId){ const labelEl = document.getElementById(labelId); if(labelEl){ labelEl.setAttribute('tabindex','-1'); labelEl.focus(); } } } } }
    function closeModal(id){
      const el = document.getElementById(id);
      if(!el) return;
      const m = el.querySelector('.modal');
      if(m){
        m.classList.add('closing');
        setTimeout(() => { el.classList.remove('active'); m.classList.remove('closing'); el.style.display = 'none'; el.setAttribute('aria-hidden','true'); }, 160);
      } else {
        el.classList.remove('active'); el.style.display = 'none'; el.setAttribute('aria-hidden','true');
      }
    }

    // Toasts de notificación — centralizado en /static/js/toast.js
    // Usa showToast(message, type='info', duration=3500, actionText='OK');
    if (typeof window.showToast !== 'function') {
      window.showToast = function(message, type = 'info', duration = 3500, actionText = 'OK') {
        try {
          const cont = document.getElementById('toast-container');
          if (!cont) { console[type === 'error' ? 'error' : 'log'](message); return; }
          const toast = document.createElement('div');
          toast.className = `toast ${type}`;
          toast.textContent = message;
          cont.appendChild(toast);
          setTimeout(() => { toast.classList.add('visible'); }, 10);
          setTimeout(() => { toast.classList.remove('visible'); toast.remove(); }, duration);
        } catch (e) { console.error(message); }
      };
    }

    // ===== QR Check-in (Gestión) =====
    let qrState = { token: null, expiresTs: 0, countdownInt: null, pollInt: null };
    function stopQRTimers(){ if(qrState.countdownInt){ clearInterval(qrState.countdownInt); qrState.countdownInt=null; } if(qrState.pollInt){ clearInterval(qrState.pollInt); qrState.pollInt=null; } }
    function formatCountdown(ms){ if(ms<=0) return '0:00'; const total = Math.floor(ms/1000); const m = Math.floor(total/60); const s = String(total%60).padStart(2,'0'); return `${m}:${s}`; }
    function updateQRCountdown(){ const el = document.getElementById('qr-countdown'); const now = Date.now(); const rem = Math.max(0, qrState.expiresTs - now); if(el) el.textContent = formatCountdown(rem); if(rem<=0){ const status = document.getElementById('qr-status-msg'); if(status) status.textContent = 'Token expirado'; stopQRTimers(); setTimeout(() => closeQRModal(), 1200); } }
    function pollTokenStatus(){ if(!qrState.token) return; fetch(`/api/checkin/token_status?token=${encodeURIComponent(qrState.token)}`, { headers:{ 'Accept':'application/json' } })
      .then(r => r.json()).then(j => {
        const status = document.getElementById('qr-status-msg');
        if(j && j.exists){
          const used = !!j.used; const expired = !!j.expired;
          if(status){ status.textContent = used ? '¡Asistencia registrada!' : (expired ? 'Token expirado' : 'Esperando confirmación…'); }
          if(used || expired){ stopQRTimers(); setTimeout(() => closeQRModal(), 1200); }
        } else {
          if(status) status.textContent = 'Token inválido o inexistente';
        }
      }).catch(() => {});
    }
    function closeQRModal(){ stopQRTimers(); qrState.token=null; qrState.expiresTs=0; const un = document.getElementById('qr-user-name'); if(un) un.textContent='—'; const tm = document.getElementById('qr-token-masked'); if(tm) tm.textContent='token: —'; closeModal('modal-qr-toast'); }
    async function emitirQRCheckin(){ const u = state.selectedUsuario; if(!u || !u.id){ showToast('Selecciona un usuario primero', 'warning', 4000); return; }
      const expires_minutes = 5;
      try{
        const res = await fetch('/api/checkin/create_token', { method:'POST', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify({ usuario_id: u.id, expires_minutes }) });
        if(!res.ok){ const err = await res.json().catch(() => ({})); throw new Error(err.detail || err.error || `Error ${res.status}`); }
        const data = await res.json();
        const token = String(data.token || '').trim(); if(!token){ throw new Error('No se generó token'); }
        qrState.token = token; qrState.expiresTs = Date.now() + (Number(data.expires_minutes||expires_minutes) * 60 * 1000);
        const un = document.getElementById('qr-user-name'); if(un) un.textContent = String(u.nombre || `Usuario #${u.id}`);
        const tm = document.getElementById('qr-token-masked'); if(tm) tm.textContent = `token: ***${token.slice(-4)}`;
        openModal('modal-qr-toast');
        showToast('Token de check-in generado', 'success', 2500);
        const statusEl = document.getElementById('qr-status-msg'); if(statusEl) statusEl.textContent = 'Generando QR…';
        const canvasEl = document.getElementById('qr-canvas');
        if(canvasEl){ const ctx = canvasEl.getContext('2d'); if(ctx){ ctx.clearRect(0,0,canvasEl.width,canvasEl.height); ctx.fillStyle='#f5f5f5'; ctx.fillRect(0,0,canvasEl.width,canvasEl.height); ctx.strokeStyle='#ddd'; for(let i=0;i<=12;i++){ ctx.beginPath(); ctx.moveTo(i*20,0); ctx.lineTo(i*20,240); ctx.stroke(); ctx.beginPath(); ctx.moveTo(0,i*20); ctx.lineTo(240,i*20); ctx.stroke(); } } }
        let qrLibReady = false;
        try{
          if(typeof window.loadQRCodeLib === 'function'){
            qrLibReady = await window.loadQRCodeLib();
          } else {
            qrLibReady = !!window.QRCode;
          }
        }catch(_){ qrLibReady = !!window.QRCode; }
        const canvas = document.getElementById('qr-canvas');
        if(canvas && qrLibReady && window.QRCode && typeof window.QRCode.toCanvas === 'function'){
          try { window.QRCode.toCanvas(canvas, token, { width: 240 }); } catch(_){}
        } else {
          const status = document.getElementById('qr-status-msg'); if(status) status.textContent = 'No se pudo cargar la librería de QR. Usa ingreso manual.';
          if(tm) tm.textContent = `token: ${token}`;
        }
        updateQRCountdown(); stopQRTimers(); qrState.countdownInt = setInterval(updateQRCountdown, 1000); qrState.pollInt = setInterval(pollTokenStatus, 2000);
      }catch(e){ showToast(`No se pudo emitir token: ${e.message}`, 'error', 4500); }
    }
    async function registrarAsistenciaQuick(){ const u = state.selectedUsuario; if(!u || !u.id){ showToast('Selecciona un usuario primero', 'warning', 4000); return; }
      try{
        const res = await fetch('/api/asistencias/registrar', { method:'POST', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify({ usuario_id: u.id }) });
        if(!res.ok){ const err = await res.json().catch(() => ({})); throw new Error(err.detail || err.error || `Error ${res.status}`); }
        const j = await res.json().catch(() => ({}));
        showToast('Asistencia registrada', 'success', 3000);
        await loadUsers(); const idx = (state.usuarios || []).findIndex(x => x.id === u.id); if(idx >= 0) selectUsuarioByIndex(idx);
      }catch(e){ showToast(`No se pudo registrar asistencia: ${e.message}`, 'error', 4500); }
    }

    async function eliminarAsistenciaQuick(){ const u = state.selectedUsuario; if(!u || !u.id){ showToast('Selecciona un usuario primero', 'warning', 4000); return; } const hoy = fmtDate(new Date()); try{ const res = await fetch('/api/asistencias/eliminar', { method:'DELETE', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify({ usuario_id: u.id, fecha: hoy }) }); if(!res.ok){ const err = await res.json().catch(() => ({})); throw new Error(err.detail || err.error || `Error ${res.status}`); } await res.json().catch(() => ({})); showToast('Asistencia eliminada', 'success', 3000); await loadUsers(); const idx = (state.usuarios || []).findIndex(x => x.id === u.id); if(idx >= 0) selectUsuarioByIndex(idx); }catch(e){ showToast(`No se pudo eliminar asistencia: ${e.message}`, 'error', 4500); } }

    function handleAsistenciaClick(){ const u = state.selectedUsuario; if(!u || !u.id){ showToast('Selecciona un usuario primero', 'warning', 4000); return; } const btn = document.getElementById('usuario-side-asistencia'); const hoy = fmtDate(new Date()); const arr = Array.isArray(state.usuarioAsistencias) ? state.usuarioAsistencias : []; const hasHoy = arr.some(a => { const f = a.fecha || a.fecha_asistencia || a.fechaAsistencia || ''; return fmtDate(f) === hoy; }); if(hasHoy){ eliminarAsistenciaQuick(); } else { registrarAsistenciaQuick(); } }

    function pagosAplicaFiltros(items){
      const metodo = (state.pagosFilters.metodo || '').trim().toLowerCase();
      const concepto = (state.pagosFilters.concepto || '').trim().toLowerCase();
      if(!metodo && !concepto) return items;
      return items.filter(row => {
        const m = String(row.metodo_pago || row.metodo || '').toLowerCase();
        const c = String(row.concepto_pago || row.concepto || '').toLowerCase();
        return (!metodo || m === metodo || m.includes(metodo)) && (!concepto || c === concepto || c.includes(concepto));
      });
    }

    async function loadPayments(){
      const start = document.getElementById('pagos-start').value || '';
      const end = document.getElementById('pagos-end').value || '';
      const q = document.getElementById('pagos-q').value || '';
      const limit = parseInt(document.getElementById('pagos-limit').value || '50', 10);
      const params = new URLSearchParams();
      if(start) params.append('start', start);
      if(end) params.append('end', end);
      if(q) params.append('q', q);
      params.append('limit', String(limit));
      params.append('offset', '0');
      const url = `/api/pagos_detalle?${params.toString()}`;
      try {
        const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
        const data = await res.json();
        const itemsRaw = Array.isArray(data.items) ? data.items : (Array.isArray(data) ? data : []);
        state.pagos = itemsRaw;
        const items = pagosAplicaFiltros(itemsRaw);
        const tbody = document.querySelector('#pagos-table tbody');
        tbody.innerHTML = '';
        items.forEach((row, idx) => {
          const tr = document.createElement('tr');
          tr.setAttribute('data-index', String(idx));
          const fecha = row.fecha_pago || row.fecha || row.fechaPago || null;
          const nombre = row.usuario_nombre || row.nombre || '';
          const dni = row.dni || '';
          const metodo = row.metodo_pago || row.metodo || '';
          const concepto = row.concepto_pago || row.concepto || '';
          const monto = row.monto != null ? row.monto : '';
          tr.innerHTML = `
            <td>${fecha ? fmtDate(fecha) : ''}</td>
            <td>${nombre}</td>
            <td>${dni}</td>
            <td>${metodo}</td>
            <td>${concepto}</td>
            <td>${monto}</td>
            <td class="table-actions">
              <button class="btn secondary" data-action="ver" data-index="${idx}">Ver</button>
              <button class="btn" data-action="editar" data-id="${row.id || row.pago_id || ''}" data-index="${idx}">Editar</button>
              <button class="btn secondary" data-action="eliminar" data-id="${row.id || row.pago_id || ''}" data-index="${idx}">Borrar</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
        const count = (data && typeof data.count === 'number') ? data.count : items.length;
        document.getElementById('pagos-count').textContent = `${count} pagos`;
        // Tarjetas
        const totalMonto = items.reduce((acc, r) => acc + (parseFloat(r.monto || 0) || 0), 0);
        const uniqueDni = new Set(items.map(r => String(r.dni || '')));
        document.getElementById('pagos-card-count').textContent = String(items.length);
        document.getElementById('pagos-card-monto').textContent = `$${totalMonto.toFixed(2)}`;
        document.getElementById('pagos-card-unique').textContent = String(Array.from(uniqueDni).filter(v => v).length);
        const avg = items.length ? (totalMonto / items.length) : 0;
        const avgEl = document.getElementById('pagos-card-average');
        if(avgEl) avgEl.textContent = `$${avg.toFixed(2)}`;
      } catch(err){
        console.error('Error cargando pagos:', err);
      }
    }

    async function loadMetodosPago(){
      try {
        const res = await fetch('/api/metodos_pago', { headers: { 'Accept': 'application/json' } });
        const met = await res.json();
        const sel = document.getElementById('pagos-metodo');
        sel.innerHTML = '<option value="">Todos</option>';
        (Array.isArray(met) ? met : []).forEach(m => {
          const opt = document.createElement('option');
          const nombre = m.nombre ?? '';
          opt.value = String(nombre).toLowerCase();
          opt.textContent = nombre;
          sel.appendChild(opt);
        });
        // Preselección actual
        if(state.pagosFilters.metodo){ sel.value = state.pagosFilters.metodo; }
      } catch(e){ console.warn('No se pudieron cargar métodos de pago:', e); }
    }
    async function loadConceptosPago(){
      try {
        const res = await fetch('/api/conceptos_pago', { headers: { 'Accept': 'application/json' } });
        const conc = await res.json();
        const sel = document.getElementById('pagos-concepto');
        sel.innerHTML = '<option value="">Todos</option>';
        (Array.isArray(conc) ? conc : []).forEach(c => {
          const nombre = c.nombre ?? '';
          const opt = document.createElement('option');
          opt.value = String(nombre).toLowerCase();
          opt.textContent = nombre;
          sel.appendChild(opt);
        });
        if(state.pagosFilters.concepto){ sel.value = state.pagosFilters.concepto; }
      } catch(e){ console.warn('No se pudieron cargar conceptos:', e); }
    }

    async function loadTiposCuotaActivos(){
      try {
        const res = await fetch('/api/tipos_cuota_activos', { headers: { 'Accept': 'application/json' } });
        const tipos = await res.json();
        const lista = Array.isArray(tipos) ? tipos : [];
        state.tiposCuotaActivos = lista;
        state.tiposCuotaMap = Object.fromEntries(lista.map(t => [String(t.id ?? t.nombre ?? ''), t]));
        const sel = document.getElementById('u-tipo-cuota');
        if(sel){
          sel.innerHTML = '<option value="">Tipo de cuota</option>' + lista.map(t => `<option value="${t.id ?? t.nombre ?? ''}">${t.nombre ?? String(t.id ?? '')}</option>`).join('');
        }
      } catch(e){ console.warn('No se pudieron cargar tipos de cuota activos:', e); }
    }

    function updateUsuariosCards(rows){
      const count = (Array.isArray(rows) ? rows.length : 0);
      const activos = (Array.isArray(rows) ? rows.filter(u => (u.activo === true || u.activo === 'true')).length : 0);
      const inactivos = (Array.isArray(rows) ? rows.filter(u => !(u.activo === true || u.activo === 'true')).length : 0);
      const profesores = (Array.isArray(rows) ? rows.filter(u => String(u.rol || '').toLowerCase() === 'profesor').length : 0);
      const sinTelefono = (Array.isArray(rows) ? rows.filter(u => !(u.telefono && String(u.telefono).trim())).length : 0);
      const conNotas = (Array.isArray(rows) ? rows.filter(u => !!(u.notas && String(u.notas).trim())).length : 0);
      const c1 = document.getElementById('usuarios-card-count');
      const c2 = document.getElementById('usuarios-card-activos');
      const c3 = document.getElementById('usuarios-card-inactivos');
      const c4 = document.getElementById('usuarios-card-profesores');
      const c5 = document.getElementById('usuarios-card-sin-telefono');
      const c6 = document.getElementById('usuarios-card-con-notas');
      if(c1) c1.textContent = String(count);
      if(c2) c2.textContent = String(activos);
      if(c3) c3.textContent = String(inactivos);
      if(c4) c4.textContent = String(profesores);
      if(c5) c5.textContent = String(sinTelefono);
      if(c6) c6.textContent = String(conNotas);
    }

    async function loadUsers(){
      const q = document.getElementById('usuarios-q').value || '';
      const limit = parseInt(document.getElementById('usuarios-limit').value || '50', 10);
      const params = new URLSearchParams();
      if(q) params.append('q', q);
      params.append('limit', String(limit));
      params.append('offset', '0');
      const url = `/api/usuarios?${params.toString()}`;
      try {
        const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
        const rows = await res.json();
        state.usuarios = Array.isArray(rows) ? rows : [];
        // Obtener set de IDs con asistencia hoy
        const hoySet = await (async () => {
          try {
            const r = await fetch('/api/asistencias_hoy_ids', { headers: { 'Accept': 'application/json' } });
            const arr = await r.json();
            const list = Array.isArray(arr) ? arr : [];
            return new Set(list.map(x => Number(x)));
          } catch(e) { return new Set(); }
        })();
        const tbody = document.querySelector('#usuarios-table tbody');
        tbody.innerHTML = '';
        (Array.isArray(rows) ? rows : []).forEach((u, idx) => {
          const tr = document.createElement('tr');
          tr.setAttribute('data-index', String(idx));
          const activo = (u.activo === true || u.activo === 'true');
          const asistioHoy = hoySet.has(Number(u.id));
          tr.innerHTML = `
            <td>${u.nombre || ''}</td>
            <td>${u.dni || ''}</td>
            <td>${u.telefono || ''}</td>
            <td>${(u.rol || '').toString().toLowerCase()}</td>
            <td>${u.tipo_cuota ?? ''}</td>
            <td>${activo ? 'Sí' : 'No'}</td>
            <td>${asistioHoy ? '<span style="padding:2px 8px;border-radius:10px;background:#27ae60;color:#fff;">Hoy</span>' : '<span class="muted">—</span>'}</td>
            <td>
              <button class="btn secondary" data-action="edit" data-id="${u.id}">Editar</button>
              <button class="btn secondary" data-action="delete" data-id="${u.id}">Borrar</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
        document.getElementById('usuarios-count').textContent = `${(Array.isArray(rows) ? rows.length : 0)} usuarios`;
        updateUsuariosCards(rows);
      } catch(err){
        console.error('Error cargando usuarios:', err);
      }
    }

    function showUserForm(user){
      editingUserId = user && user.id ? user.id : null;
      const f = (id) => document.getElementById(id);
      f('u-nombre').value = (user && user.nombre) || '';
      f('u-dni').value = (user && user.dni) || '';
      f('u-telefono').value = (user && user.telefono) || '';
      // Prefijo por defecto si no hay teléfono
      if(!user || !user.telefono){ const telEl = f('u-telefono'); if(telEl && !telEl.value) telEl.value = '+54'; }
      f('u-pin').value = (user && user.pin) || '';
      f('u-rol').value = (user && user.rol) ? String(user.rol).toLowerCase() : 'socio';
      f('u-activo').checked = user ? !!user.activo : true;
      f('u-notas').value = (user && user.notas) || '';
      loadTiposCuotaActivos().then(() => {
        const sel = f('u-tipo-cuota');
        const v = user ? (user.tipo_cuota ?? '') : '';
        if(sel && v !== undefined && v !== null){ sel.value = String(v); }
      });
      openModal('modal-usuario');
    }
    function hideUserForm(){
      editingUserId = null;
      ['u-nombre','u-dni','u-telefono','u-pin','u-notas'].forEach(id => { const el = document.getElementById(id); if(el) el.value=''; });
      const sel = document.getElementById('u-tipo-cuota'); if(sel) sel.value='';
      const rol = document.getElementById('u-rol'); if(rol) rol.value='socio';
      const act = document.getElementById('u-activo'); if(act) act.checked=true;
      closeModal('modal-usuario');
    }

    async function saveUser(){
      const f = (id) => document.getElementById(id);
      const payload = {
        nombre: f('u-nombre').value.trim().toUpperCase(),
        dni: f('u-dni').value.trim(),
        telefono: f('u-telefono').value.trim(),
        pin: f('u-pin').value.trim(),
        rol: f('u-rol').value,
        activo: f('u-activo').checked,
        tipo_cuota: f('u-tipo-cuota').value || null,
        notas: f('u-notas').value || null,
      };
      if(!payload.nombre || !payload.dni){ showToast('Nombre y DNI son obligatorios', 'warning', 3000); return; }
      try {
        const url = editingUserId ? `/api/usuarios/${editingUserId}` : '/api/usuarios';
        const method = editingUserId ? 'PUT' : 'POST';
        const res = await fetch(url, { method, headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' }, body: JSON.stringify(payload) });
        if(!res.ok){ const err = await res.json().catch(() => ({})); throw new Error(err.detail || err.error || `Error ${res.status}`); }
        hideUserForm();
        await loadUsers();
      } catch(e){ showToast(`No se pudo guardar: ${e.message}`, 'error', 4500); }
    }

    async function deleteUser(id){
      if(!id) return;
      try {
        const res = await fetch(`/api/usuarios/${id}`, { method: 'DELETE', headers: { 'Accept': 'application/json' } });
        if(!res.ok){ const err = await res.json().catch(() => ({})); throw new Error(err.detail || err.error || `Error ${res.status}`); }
        await loadUsers();
      } catch(e){ showToast(`No se pudo eliminar: ${e.message}`, 'error', 4500); }
    }

    function renderPagoSide(pago, detalles){
      const fecha = pago.fecha_pago || pago.fecha || pago.fechaPago || '';
      const nombre = pago.usuario_nombre || pago.nombre || '';
      const dni = pago.dni || '';
      const metodo = pago.metodo_pago || pago.metodo || '';
      const concepto = pago.concepto_pago || pago.concepto || '';
      const monto = pago.monto != null ? pago.monto : '';
      document.getElementById('pago-side-fecha').textContent = fecha ? fmtDate(fecha) : '';
      document.getElementById('pago-side-nombre').textContent = nombre;
      document.getElementById('pago-side-dni').textContent = dni;
      document.getElementById('pago-side-metodo').textContent = metodo;
      document.getElementById('pago-side-concepto').textContent = concepto;
      document.getElementById('pago-side-monto').textContent = monto;
      const notasEl = document.getElementById('pago-side-notas');
      if(notasEl) notasEl.textContent = (pago.notas && String(pago.notas).trim()) ? pago.notas : '—';
      const tbody = document.querySelector('#pago-detalles-table tbody');
      if(tbody){
        tbody.innerHTML = '';
        (Array.isArray(detalles) ? detalles : []).forEach(d => {
          const tr = document.createElement('tr');
          const concepto = d.concepto_nombre || d.concepto || d.descripcion || '';
          const cantidad = d.cantidad ?? 1;
          const precio = d.precio_unitario ?? d.precio ?? 0;
          const subtotal = d.subtotal ?? (cantidad * precio);
          tr.innerHTML = `<td>${concepto}</td><td>${cantidad}</td><td>${precio}</td><td>${subtotal}</td>`;
          tbody.appendChild(tr);
        });
      }
    }

    async function selectPagoByIndex(idx){
      const row = (state.pagos || [])[idx];
      if(!row) return;
      state.selectedPago = row;
      const id = row.id || row.pago_id || null;
      document.getElementById('pago-side-empty').style.display = 'none';
      document.getElementById('pago-side').style.display = 'block';
      document.getElementById('pago-side-id').textContent = id ? `#${id}` : '';
      try {
        if(id){
          const res = await fetch(`/api/pagos/${id}`, { headers: { 'Accept': 'application/json' } });
          const data = await res.json();
          const pago = data.pago || row;
          const detalles = Array.isArray(data.detalles) ? data.detalles : [];
          renderPagoSide(pago, detalles);
        } else {
          renderPagoSide(row, []);
        }
      } catch(e){
        console.warn('No se pudo cargar detalles del pago:', e);
        renderPagoSide(row, []);
      }
      const ptbody = document.querySelector('#pagos-table tbody');
      if(ptbody){ ptbody.querySelectorAll('tr').forEach(t => t.classList.remove('selected')); const tr = ptbody.querySelector(`tr[data-index="${idx}"]`); if(tr) tr.classList.add('selected'); }
    }

    function clearPagoSelection(){
      state.selectedPago = null;
      document.getElementById('pago-side-id').textContent = '';
      document.getElementById('pago-side').style.display = 'none';
      document.getElementById('pago-side-empty').style.display = 'block';
      const tbody = document.querySelector('#pago-detalles-table tbody');
      if(tbody) tbody.innerHTML = '';
    }

    function openPagoDetalleModal(){
      const p = state.selectedPago;
      if(!p){ showToast('Selecciona un pago primero', 'warning', 4000); return; }
      const fecha = p.fecha_pago || p.fecha || p.fechaPago || null;
      document.getElementById('pago-detalle-fecha').textContent = fecha ? fmtDate(fecha) : '';
      document.getElementById('pago-detalle-nombre').textContent = p.usuario_nombre || p.nombre || '';
      document.getElementById('pago-detalle-dni').textContent = p.dni || '';
      document.getElementById('pago-detalle-monto').textContent = (p.monto != null ? p.monto : '');
      document.getElementById('pago-detalle-metodo').textContent = p.metodo_pago || p.metodo || '';
      document.getElementById('pago-detalle-concepto').textContent = p.concepto_pago || p.concepto || '';
      openModal('modal-pago-detalle');
    }

    async function navigateToUsuarioDesdePago(){
      const pago = state.selectedPago;
      if(!pago){ showToast('Selecciona un pago primero', 'warning', 4000); return; }
      const dni = pago.dni ? String(pago.dni).trim() : '';
      if(!dni){ showToast('No se encuentra DNI del pago', 'error', 4500); return; }
      const findByDni = () => (state.usuarios || []).findIndex(u => String(u.dni || '').trim() === dni);
      let idx = findByDni();
      switchTab('usuarios');
      if(idx >= 0){ selectUsuarioByIndex(idx); return; }
      await loadUsers();
      idx = findByDni();
      if(idx >= 0) selectUsuarioByIndex(idx);
      else showToast('No se encontró el usuario del pago en la lista.', 'warning', 4000);
    }

    function bindPagosEvents(){
      const tbody = document.querySelector('#pagos-table tbody');
      tbody.addEventListener('click', (ev) => {
        const btn = ev.target.closest('button');
        if(btn){
          const action = btn.getAttribute('data-action');
          if(action === 'ver'){
            const idx = parseInt(btn.getAttribute('data-index') || '0', 10);
            if(isNaN(idx)) return;
            selectPagoByIndex(idx);
            return;
          }
          if(action === 'editar'){
            const idx = parseInt(btn.getAttribute('data-index') || '0', 10);
            if(isNaN(idx)) return;
            const row = (state.pagos || [])[idx];
            const id = btn.getAttribute('data-id');
            if(id){
              fetch(`/api/pagos/${id}`, { headers:{ 'Accept':'application/json' } })
                .then(r => r.json())
                .then(data => showPagoForm(data.pago || row))
                .catch(() => showToast('No se pudo cargar el pago', 'error', 4500));
            } else {
              showPagoForm(row);
            }
            return;
          }
          if(action === 'eliminar'){
            const id = btn.getAttribute('data-id');
            if(!id){ showToast('Pago inválido', 'error', 4500); return; }
            state.deletePagoId = parseInt(id, 10);
            openModal('modal-pagos-delete');
            return;
          }
        }
        const tr = ev.target.closest('tr');
        if(!tr) return;
        const idx = parseInt(tr.getAttribute('data-index') || 'NaN', 10);
        if(isNaN(idx)) return;
        selectPagoByIndex(idx);
      });
      const filtrosBtn = document.getElementById('pagos-filtros-btn');
      filtrosBtn.addEventListener('click', async () => {
        await Promise.all([loadMetodosPago(), loadConceptosPago()]);
        openModal('modal-pagos-filtros');
      });
      document.getElementById('pagos-filtros-close').addEventListener('click', () => closeModal('modal-pagos-filtros'));
      document.getElementById('pagos-filtros-cancelar').addEventListener('click', () => closeModal('modal-pagos-filtros'));
      document.getElementById('pagos-filtros-aplicar').addEventListener('click', () => {
        const metodo = document.getElementById('pagos-metodo').value || '';
        const concepto = document.getElementById('pagos-concepto').value || '';
        state.pagosFilters.metodo = metodo;
        state.pagosFilters.concepto = concepto;
        closeModal('modal-pagos-filtros');
        loadPayments();
      });
      document.getElementById('pagos-clear-selection').addEventListener('click', clearPagoSelection);
      const verUsuarioBtn = document.getElementById('pago-side-ver-usuario');
      if(verUsuarioBtn) verUsuarioBtn.addEventListener('click', navigateToUsuarioDesdePago);
      const verDetalleBtn = document.getElementById('pago-side-ver-detalle');
      if(verDetalleBtn) verDetalleBtn.addEventListener('click', openPagoDetalleModal);
      const exportBtn = document.getElementById('pagos-export-csv');
      if(exportBtn) exportBtn.addEventListener('click', exportPagosCSV);
      const editarPagoBtn = document.getElementById('pago-side-editar');
      if(editarPagoBtn) editarPagoBtn.addEventListener('click', () => {
        const p = state.selectedPago; if(!p) { showToast('Selecciona un pago primero', 'warning', 4000); return; }
        const id = p.id || p.pago_id;
        if(id){
          fetch(`/api/pagos/${id}`, { headers:{ 'Accept':'application/json' } })
            .then(r => r.json())
            .then(data => showPagoForm(data.pago || p))
            .catch(() => showToast('No se pudo cargar el pago', 'error', 4500));
        } else {
          showPagoForm(p);
        }
      });
      const eliminarPagoBtn = document.getElementById('pago-side-eliminar');
      if(eliminarPagoBtn) eliminarPagoBtn.addEventListener('click', () => {
        const p = state.selectedPago; if(!p || !(p.id || p.pago_id)) { showToast('Selecciona un pago válido', 'warning', 4000); return; }
        state.deletePagoId = p.id || p.pago_id;
        openModal('modal-pagos-delete');
      });
      const nuevoPagoBtn = document.getElementById('pagos-new');
      if(nuevoPagoBtn) nuevoPagoBtn.addEventListener('click', () => showPagoForm(null));
      const registrarPagoQuick = document.getElementById('usuario-side-registrar');
      if(registrarPagoQuick) registrarPagoQuick.addEventListener('click', () => showPagoForm(null));
      // Modal pago form controls
      const pagoClose = document.getElementById('pago-form-close'); if(pagoClose) pagoClose.addEventListener('click', hidePagoForm);
      const pagoCancel = document.getElementById('pago-form-cancel'); if(pagoCancel) pagoCancel.addEventListener('click', hidePagoForm);
      const pagoSave = document.getElementById('pago-save'); if(pagoSave) pagoSave.addEventListener('click', savePago);
      // Recalcular al cambiar usuario o método de pago
      const uSel = document.getElementById('pago-usuario'); if(uSel) uSel.addEventListener('change', () => recalcPagoTotal());
      const mSel = document.getElementById('pago-metodo'); if(mSel) mSel.addEventListener('change', () => recalcPagoTotal());
      const cSel = document.getElementById('pago-concepto'); if(cSel) cSel.addEventListener('change', () => recalcPagoTotal());
      // Modal delete pago controls
      document.getElementById('pagos-delete-close').addEventListener('click', () => closeModal('modal-pagos-delete'));
      document.getElementById('pagos-delete-cancel').addEventListener('click', () => closeModal('modal-pagos-delete'));
      document.getElementById('pagos-delete-confirm').addEventListener('click', deletePago);
    }

    async function populatePagoUsuarioSelect(selectedId){
      const sel = document.getElementById('pago-usuario');
      if(!sel) return;
      if(!Array.isArray(state.usuarios) || state.usuarios.length === 0){
        await loadUsers();
      }
      const usuarios = Array.isArray(state.usuarios) ? state.usuarios : [];
      sel.innerHTML = '<option value="">Seleccionar usuario</option>' + usuarios.map(u => `<option value="${u.id}">${u.nombre} (${u.dni || ''})</option>`).join('');
      const target = selectedId || (state.selectedUsuario && state.selectedUsuario.id) || '';
      if(target) sel.value = String(target);
    }

    async function populatePagoMetodoSelect(selectedId){
      const sel = document.getElementById('pago-metodo'); if(!sel) return;
      try {
        const res = await fetch('/api/metodos_pago', { headers:{ 'Accept':'application/json' } });
        const data = await res.json();
        const items = Array.isArray(data) ? data : (Array.isArray(data.metodos) ? data.metodos : []);
        state.metodosPago = items;
        state.metodosPagoMap = Object.fromEntries(items.map(m => [String(m.id), m]));
        sel.innerHTML = '<option value="">Método de pago (opcional)</option>' + items.map(m => `<option value="${m.id}">${m.nombre}</option>`).join('');
        if(selectedId) sel.value = String(selectedId);
      } catch(e) { console.warn('No se pudieron cargar métodos de pago:', e); }
    }

    async function populatePagoConceptoSelect(selectedId){
      const sel = document.getElementById('pago-concepto'); if(!sel) return;
      try{
        const res = await fetch('/api/conceptos_pago', { headers:{ 'Accept':'application/json' } });
        const data = await res.json();
        const items = Array.isArray(data?.items) ? data.items : (Array.isArray(data) ? data : []);
        state.conceptosPago = items;
        state.conceptosPagoMap = Object.fromEntries(items.map(c => [String(c.id), c]));
        sel.innerHTML = '<option value="">Concepto</option>' + items.map(c => `<option value="${c.id}">${c.nombre}</option>`).join('');
        let target = selectedId || '';
        if(!target){
          const monthly = items.find(c => String(c.nombre||'').trim().toLowerCase() === 'cuota mensual');
          if(monthly) target = String(monthly.id);
        }
        if(target) sel.value = String(target);
      } catch(e){ console.warn('No se pudieron cargar conceptos de pago:', e); }
    }

    // ---- cálculo dinámico de monto según tipo de cuota y comisión ----
    async function ensureMonthlyQuotaConceptVariableActive(){
      try {
        const res = await fetch('/api/conceptos_pago', { headers:{ 'Accept':'application/json' } });
        const conceptos = await res.json();
        const items = Array.isArray(conceptos) ? conceptos : [];
        const existing = items.find(c => String(c.nombre || '').trim().toLowerCase() === 'cuota mensual');
        if(!existing){
          await fetch('/api/conceptos_pago', {
            method:'POST', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' },
            body: JSON.stringify({ nombre: 'Cuota Mensual', descripcion: 'Pago mensual según tipo de cuota del usuario', precio_base: 0, tipo: 'variable', activo: true, categoria: 'cuota' })
          }).catch(()=>null);
        } else if(existing && (String(existing.tipo).toLowerCase() !== 'variable' || existing.activo === false)){
          await fetch(`/api/conceptos_pago/${existing.id}`, {
            method:'PUT', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' },
            body: JSON.stringify({ tipo: 'variable', activo: true })
          }).catch(()=>null);
        }
      } catch(e){ console.warn('No se pudo asegurar concepto Cuota Mensual variable/activo:', e); }
    }

    async function ensureTiposCuotaCatalogo(){
      try{
        if(Array.isArray(state.tiposCuotaCatalogo) && state.tiposCuotaCatalogo.length > 0){ return; }
        const res = await fetch('/api/tipos_cuota_catalogo', { headers:{ 'Accept':'application/json' } });
        const full = await res.json();
        const rows = Array.isArray(full.items) ? full.items : (Array.isArray(full) ? full : []);
        state.tiposCuotaCatalogo = rows;
        state.tiposCuotaCatalogoMap = Object.fromEntries(rows.map(t => [String(t.id ?? t.nombre ?? ''), t]));
      }catch(e){ console.warn('No se pudo cargar catálogo de tipos de cuota:', e); }
    }

    function resolveTipoCuota(val){
      if(val == null) return null;
      const sv = String(val).trim();
      if(!sv) return null;
      const activos = Array.isArray(state.tiposCuotaActivos) ? state.tiposCuotaActivos : [];
      let tipo = null;
      if(/^[0-9]+$/.test(sv)){
        tipo = activos.find(t => String(t.id) === sv);
      }
      if(!tipo){
        tipo = activos.find(t => String(t.nombre || '').trim().toLowerCase() === sv.toLowerCase());
      }
      if(tipo) return tipo;
      const catalogo = Array.isArray(state.tiposCuotaCatalogo) ? state.tiposCuotaCatalogo : [];
      if(/^[0-9]+$/.test(sv)){
        tipo = catalogo.find(t => String(t.id) === sv);
      }
      if(!tipo){
        tipo = catalogo.find(t => String(t.nombre || '').trim().toLowerCase() === sv.toLowerCase());
      }
      return tipo || null;
    }

    function round2(v){ const n = Number(v) || 0; return Math.round(n * 100) / 100; }

    function updatePagoResumen({ conceptoNombre, base, pct, comision, total }){
      const elConcepto = document.getElementById('pago-resumen-concepto'); if(elConcepto) elConcepto.textContent = conceptoNombre || 'Cuota Mensual';
      const elBase = document.getElementById('pago-resumen-base'); if(elBase) elBase.textContent = (base != null ? round2(base).toFixed(2) : '—');
      const elCom = document.getElementById('pago-resumen-comision'); if(elCom) elCom.textContent = (comision != null ? round2(comision).toFixed(2) : '—');
      const elPct = document.getElementById('pago-resumen-comision-porcentaje'); if(elPct) elPct.textContent = (pct ? `(${round2(pct)}%)` : '');
      const elTot = document.getElementById('pago-resumen-total'); if(elTot) elTot.textContent = (total != null ? round2(total).toFixed(2) : '—');
    }

    async function recalcPagoTotal(){
      try{
        await ensureMonthlyQuotaConceptVariableActive();
        if(!Array.isArray(state.tiposCuotaActivos) || state.tiposCuotaActivos.length === 0){
          await loadTiposCuotaActivos();
        }
        await ensureTiposCuotaCatalogo();
        const usuarioEl = document.getElementById('pago-usuario');
        const metodoEl = document.getElementById('pago-metodo');
        const conceptoEl = document.getElementById('pago-concepto');
        const montoEl = document.getElementById('pago-monto');
        const uid = usuarioEl && usuarioEl.value ? Number(usuarioEl.value) : null;
        const conceptoId = conceptoEl && conceptoEl.value ? String(conceptoEl.value) : '';
        const concepto = conceptoId ? (state.conceptosPagoMap ? state.conceptosPagoMap[conceptoId] : null) : null;
        let base = 0; let conceptoNombre = 'Cuota Mensual';
        if(concepto){ conceptoNombre = concepto.nombre || conceptoNombre; }
        if(uid){
          const u = (state.usuarios || []).find(x => Number(x.id) === uid);
          const tipoVal = u ? (u.tipo_cuota ?? null) : null;
          const tipoObj = resolveTipoCuota(tipoVal);
          if(concepto && String(concepto.nombre||'').trim().toLowerCase() === 'cuota mensual'){
            base = tipoObj ? Number(tipoObj.precio ?? tipoObj.precio_base ?? 0) : 0;
          } else {
            base = concepto ? Number(concepto.precio_base ?? 0) : (tipoObj ? Number(tipoObj.precio ?? tipoObj.precio_base ?? 0) : 0);
          }
        } else {
          base = concepto ? Number(concepto.precio_base ?? 0) : 0;
        }
        const metodoId = metodoEl && metodoEl.value ? String(metodoEl.value) : '';
        const metodo = metodoId ? (state.metodosPagoMap ? state.metodosPagoMap[metodoId] : null) : null;
        const pct = metodo ? Number(metodo.comision_porcentaje ?? metodo.comision ?? 0) : 0;
        const comision = round2(base * pct / 100);
        const total = round2(base + comision);
        if(montoEl){ montoEl.value = total > 0 ? String(total) : ''; }
        updatePagoResumen({ conceptoNombre, base, pct, comision, total });
      } catch(e){ console.warn('No se pudo recalcular el total del pago:', e); }
    }

    function resetPagoForm(){
      const f = document.getElementById('pago-fecha'); if(f) f.value = '';
      const m = document.getElementById('pago-mes'); if(m) m.value = '';
      const a = document.getElementById('pago-año'); if(a) a.value = '';
      const monto = document.getElementById('pago-monto'); if(monto) monto.value = '';
      const u = document.getElementById('pago-usuario'); if(u) u.value = '';
      const mp = document.getElementById('pago-metodo'); if(mp) mp.value = '';
      const cp = document.getElementById('pago-concepto'); if(cp) cp.value = '';
    }

    async function showPagoForm(p){
      editingPagoId = null;
      resetPagoForm();
      const titleEl = document.getElementById('pago-form-title');
      const now = new Date();
      await populatePagoUsuarioSelect(p && (p.usuario_id || (p.usuario && p.usuario.id)));
      await populatePagoMetodoSelect(p && (p.metodo_pago_id || p.metodo_id));
      await populatePagoConceptoSelect(p && p.concepto_id ? p.concepto_id : null);
      if(p && (p.id || p.pago_id)){
        editingPagoId = p.id || p.pago_id;
        if(titleEl) titleEl.textContent = `Editar pago #${editingPagoId}`;
        const montoEl = document.getElementById('pago-monto'); if(montoEl) montoEl.value = (p.monto != null ? p.monto : '');
        const fechaSrc = p.fecha_pago || p.fecha || p.fechaPago || null;
        const fechaEl = document.getElementById('pago-fecha'); if(fechaEl) fechaEl.value = fechaSrc ? fmtDate(fechaSrc) : '';
        const mesEl = document.getElementById('pago-mes'); const añoEl = document.getElementById('pago-año');
        if(mesEl && añoEl){
          const dt = fechaSrc ? new Date(fechaSrc) : now;
          mesEl.value = String(dt.getMonth()+1);
          añoEl.value = String(dt.getFullYear());
        }
        const uSel = document.getElementById('pago-usuario'); if(uSel && (p.usuario_id || (p.usuario && p.usuario.id))) uSel.value = String(p.usuario_id || (p.usuario && p.usuario.id));
        const mpSel = document.getElementById('pago-metodo'); if(mpSel && (p.metodo_pago_id || p.metodo_id)) mpSel.value = String(p.metodo_pago_id || p.metodo_id);
      } else {
        if(titleEl) titleEl.textContent = 'Registrar pago';
        const mesEl = document.getElementById('pago-mes'); const añoEl = document.getElementById('pago-año');
        if(mesEl) mesEl.value = String(now.getMonth()+1);
        if(añoEl) añoEl.value = String(now.getFullYear());
        const uSel = document.getElementById('pago-usuario'); if(uSel && state.selectedUsuario && state.selectedUsuario.id) uSel.value = String(state.selectedUsuario.id);
      }
      await recalcPagoTotal();
      openModal('modal-pago-form');
    }

    function hidePagoForm(){
      editingPagoId = null;
      closeModal('modal-pago-form');
    }

    async function savePago(){
      const usuarioEl = document.getElementById('pago-usuario');
      const montoEl = document.getElementById('pago-monto');
      const fechaEl = document.getElementById('pago-fecha');
      const mesEl = document.getElementById('pago-mes');
      const añoEl = document.getElementById('pago-año');
      const metodoEl = document.getElementById('pago-metodo');
      const usuario_id = usuarioEl && usuarioEl.value ? Number(usuarioEl.value) : null;
      const monto = montoEl && montoEl.value ? Number(montoEl.value) : null;
      const fecha_str = fechaEl && fechaEl.value ? fechaEl.value : null;
      let mes = mesEl && mesEl.value ? Number(mesEl.value) : null;
      let año = añoEl && añoEl.value ? Number(añoEl.value) : null;
      const metodo_pago_id = metodoEl && metodoEl.value ? Number(metodoEl.value) : null;
      if(!usuario_id || !monto){ showToast('Usuario y monto son obligatorios', 'warning', 4000); return; }
      let url = '/api/pagos'; let method = 'POST'; let body = {};
      const conceptoEl = document.getElementById('pago-concepto');
      const conceptoIdRaw = conceptoEl && conceptoEl.value ? String(conceptoEl.value) : '';
      const conceptoSel = conceptoIdRaw ? (state.conceptosPagoMap ? state.conceptosPagoMap[conceptoIdRaw] : null) : null;
      if(editingPagoId){
        url = `/api/pagos/${editingPagoId}`; method = 'PUT'; body = { usuario_id, monto, metodo_pago_id };
        if(fecha_str && fecha_str.trim()){ body['fecha_pago'] = fecha_str; }
        else if(mes != null && año != null){ body['mes'] = mes; body['año'] = año; }
      } else {
        // Crear pago avanzado con conceptos + fecha/mes-año
        let concepto_id_final = conceptoSel ? Number(conceptoSel.id) : null;
        if(!concepto_id_final){
          const items = Array.isArray(state.conceptosPago) ? state.conceptosPago : [];
          const monthly = items.find(c => String(c.nombre||'').trim().toLowerCase() === 'cuota mensual');
          if(monthly) concepto_id_final = Number(monthly.id);
        }
        // Determinar precio unitario según concepto (variable para cuota mensual)
        let precio_unitario = 0;
        const u = (state.usuarios || []).find(x => Number(x.id) === usuario_id);
        const tipoVal = u ? (u.tipo_cuota ?? null) : null;
        const tipoObj = resolveTipoCuota(tipoVal);
        if(conceptoSel && String(conceptoSel.nombre||'').trim().toLowerCase() === 'cuota mensual'){
          precio_unitario = tipoObj ? Number(tipoObj.precio ?? tipoObj.precio_base ?? 0) : 0;
        } else {
          precio_unitario = conceptoSel ? Number(conceptoSel.precio_base ?? 0) : (tipoObj ? Number(tipoObj.precio ?? tipoObj.precio_base ?? 0) : 0);
        }
        const conceptos = concepto_id_final ? [{ concepto_id: concepto_id_final, cantidad: 1, precio_unitario }] : [];
        body = { usuario_id, metodo_pago_id, conceptos };
        if(fecha_str && fecha_str.trim()){ body['fecha_pago'] = fecha_str; }
        else {
          if(!mes || !año){ const now = new Date(); mes = now.getMonth()+1; año = now.getFullYear(); }
          body['mes'] = mes; body['año'] = año;
        }
      }
      try{
        const res = await fetch(url, { method, headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(body) });
        if(!res.ok){ const err = await res.json().catch(()=>({})); showToast(err.detail || err.error || 'Error al guardar el pago', 'error', 4500); return; }
        await res.json().catch(()=>null);
        hidePagoForm();
        await loadPayments();
      } catch(e){ showToast('Error de red al guardar', 'error', 4500); }
    }

    async function deletePago(){
      const id = state.deletePagoId; if(!id){ closeModal('modal-pagos-delete'); return; }
      try{
        const res = await fetch(`/api/pagos/${id}`, { method:'DELETE', headers:{ 'Accept':'application/json' } });
        if(!res.ok){ const err = await res.json().catch(()=>({})); showToast(err.detail || err.error || 'No se pudo eliminar el pago', 'error', 4500); return; }
        await res.json().catch(()=>null);
        closeModal('modal-pagos-delete');
        if(state.selectedPago && (state.selectedPago.id === id || state.selectedPago.pago_id === id)) clearPagoSelection();
        await loadPayments();
      } catch(e){ showToast('Error de red al eliminar', 'error', 4500); }
    }

    function exportPagosCSV(){
      const items = Array.isArray(state.pagos) ? state.pagos : [];
      const headers = ['Fecha','Usuario','DNI','Método','Concepto','Monto'];
      const rows = items.map(p => [
        (p.fecha_pago || p.fecha || p.fechaPago) ? fmtDate(p.fecha_pago || p.fecha || p.fechaPago) : '',
        String(p.usuario_nombre || p.nombre || ''),
        String(p.dni || ''),
        String(p.metodo_pago || p.metodo || ''),
        String(p.concepto_pago || p.concepto || ''),
        String(p.monto != null ? p.monto : '')
      ]);
      const csv = [headers.join(','), ...rows.map(cols => cols.map(v => {
        const s = String(v ?? '');
        return /[",\n]/.test(s) ? '"' + s.replace(/"/g,'""') + '"' : s;
      }).join(','))].join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'pagos.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function renderUsuarioSide(u, historial){
      const estado = (u.activo === true || u.activo === 'true') ? 'Activo' : 'Inactivo';
      document.getElementById('usuario-side-estado').textContent = estado;
      const venc = u.fecha_proximo_vencimiento || u.proximo_vencimiento || null;
      document.getElementById('usuario-side-vencimiento').textContent = venc ? fmtDate(venc) : '—';
      document.getElementById('usuario-side-cuotas-vencidas').textContent = (u.cuotas_vencidas != null ? u.cuotas_vencidas : '—');
      document.getElementById('usuario-side-nombre').textContent = u.nombre || '';
      document.getElementById('usuario-side-dni').textContent = u.dni || '';
      document.getElementById('usuario-side-telefono').textContent = u.telefono || '';
      document.getElementById('usuario-side-rol').textContent = (u.rol || '').toString().toLowerCase();
      document.getElementById('usuario-side-tipo-cuota').textContent = (u.tipo_cuota ?? '');
      const up = u.ultimo_pago || u.fecha_ultimo_pago || null;
      document.getElementById('usuario-side-ultimo-pago').textContent = up ? fmtDate(up) : '—';
      const notasEl = document.getElementById('usuario-side-notas');
      if(notasEl) notasEl.textContent = (u.notas && String(u.notas).trim()) ? u.notas : '—';
      const tbody = document.querySelector('#usuario-historial-table tbody');
      if(tbody){
        tbody.innerHTML = '';
        (Array.isArray(historial) ? historial : []).forEach(p => {
          const tr = document.createElement('tr');
          const fecha = p.fecha_pago || p.fecha || p.fechaPago || null;
          const metodo = p.metodo_pago || p.metodo || '';
          const concepto = p.concepto_pago || p.concepto || '';
          const monto = p.monto != null ? p.monto : '';
          tr.innerHTML = `<td>${fecha ? fmtDate(fecha) : ''}</td><td>${metodo}</td><td>${concepto}</td><td>${monto}</td>`;
          tbody.appendChild(tr);
        });
      }
    }

    async function selectUsuarioByIndex(idx){
      const u = (state.usuarios || [])[idx];
      if(!u) return;
      state.selectedUsuario = u;
      const id = u.id || null;
      document.getElementById('usuario-side-empty').style.display = 'none';
      document.getElementById('usuario-side').style.display = 'block';
      document.getElementById('usuario-side-id').textContent = id ? `#${id}` : '';
      const btnQR = document.getElementById('usuario-side-qr'); if(btnQR) btnQR.disabled = false;
      const btnAsis = document.getElementById('usuario-side-asistencia'); if(btnAsis) btnAsis.disabled = false;
      const loader = document.getElementById('usuario-side-loader'); if(loader) loader.classList.add('active');
      try {
        const [detRes, histRes] = await Promise.all([
          id ? fetch(`/api/usuarios/${id}`, { headers: { 'Accept': 'application/json' } }) : Promise.resolve(null),
          id ? fetch(`/api/usuarios/${id}/pagos?limit=50&offset=0`, { headers: { 'Accept': 'application/json' } }) : Promise.resolve(null),
        ]);
        const det = detRes ? await detRes.json() : u;
        const histJson = histRes ? await histRes.json() : [];
        const historial = Array.isArray(histJson.items) ? histJson.items : (Array.isArray(histJson) ? histJson : []);
        state.usuarioHistorial = historial;
        renderUsuarioSide(det || u, historial);
        let recent = '—';
        let hasHoy = false;
        if(id){
          try{
            const aRes = await fetch(`/api/usuario_asistencias?usuario_id=${id}&limit=200&offset=0`, { headers: { 'Accept': 'application/json' } });
            const aData = await aRes.json();
            const arr = Array.isArray(aData) ? aData : (Array.isArray(aData?.items) ? aData.items : []);
            state.usuarioAsistencias = arr;
            const now = new Date(); const start = new Date(now); start.setDate(now.getDate()-30);
            recent = arr.filter(a => { const d = new Date(a.fecha||''); return !isNaN(d.getTime()) && d >= start && d <= now; }).length;
            const todayStr = fmtDate(new Date());
            hasHoy = arr.some(a => { const f = a.fecha || a.fecha_asistencia || a.fechaAsistencia || ''; return fmtDate(f) === todayStr; });
          }catch(_){ state.usuarioAsistencias = []; }
        }
        const asEl = document.getElementById('usuario-side-asistencias-recientes'); if(asEl) asEl.textContent = recent === '—' ? '—' : String(recent);
        const asBtn = document.getElementById('usuario-side-asistencia'); if(asBtn) asBtn.textContent = hasHoy ? 'Eliminar asistencia de hoy' : 'Registrar asistencia';
        const utbody = document.querySelector('#usuarios-table tbody'); if(utbody){ utbody.querySelectorAll('tr').forEach(t => t.classList.remove('selected')); const tr = utbody.querySelector(`tr[data-index="${idx}"]`); if(tr) tr.classList.add('selected'); }
      } catch(e){
        console.warn('No se pudo cargar detalles/historial del usuario:', e);
        renderUsuarioSide(u, []);
      } finally { if(loader) loader.classList.remove('active'); }
    }

    function clearUsuarioSelection(){
      state.selectedUsuario = null;
      document.getElementById('usuario-side-id').textContent = '';
      document.getElementById('usuario-side').style.display = 'none';
      document.getElementById('usuario-side-empty').style.display = 'block';
      const btnQR = document.getElementById('usuario-side-qr'); if(btnQR) btnQR.disabled = true;
      const btnAsis = document.getElementById('usuario-side-asistencia'); if(btnAsis) btnAsis.disabled = true;
      const tbody = document.querySelector('#usuario-historial-table tbody');
      if(tbody) tbody.innerHTML = '';
    }

    function bindUsuariosEvents(){
      const tbody = document.querySelector('#usuarios-table tbody');
      tbody.addEventListener('click', (ev) => {
        const btn = ev.target.closest('button');
        if(btn){
          const id = btn.getAttribute('data-id');
          const action = btn.getAttribute('data-action');
          if(action === 'edit'){
            fetch(`/api/usuarios/${id}`, { headers:{ 'Accept':'application/json' } })
              .then(r => r.json())
              .then(u => showUserForm(u))
              .catch(() => showToast('No se pudo cargar el usuario', 'error', 4500));
          } else if(action === 'delete'){
            state.deleteUserId = id;
            openModal('modal-usuarios-delete');
          }
          return;
        }
        const tr = ev.target.closest('tr');
        if(!tr) return;
        const idx = parseInt(tr.getAttribute('data-index') || 'NaN', 10);
        if(isNaN(idx)) return;
        selectUsuarioByIndex(idx);
      });
      document.getElementById('usuarios-clear-selection').addEventListener('click', clearUsuarioSelection);
      document.getElementById('usuarios-refresh').addEventListener('click', loadUsers);
      document.getElementById('usuarios-q').addEventListener('keydown', (e) => { if(e.key === 'Enter') loadUsers(); });
      document.getElementById('usuarios-new').addEventListener('click', () => showUserForm(null));
      document.getElementById('usuarios-save').addEventListener('click', saveUser);
      document.getElementById('usuarios-cancel').addEventListener('click', hideUserForm);
      document.getElementById('usuarios-modal-close').addEventListener('click', hideUserForm);
      document.getElementById('usuarios-delete-close').addEventListener('click', () => closeModal('modal-usuarios-delete'));
      document.getElementById('usuarios-delete-cancel').addEventListener('click', () => closeModal('modal-usuarios-delete'));
      document.getElementById('usuarios-delete-confirm').addEventListener('click', async () => {
        const id = state.deleteUserId;
        state.deleteUserId = null;
        closeModal('modal-usuarios-delete');
        await deleteUser(id);
      });
      const editarQuick = document.getElementById('usuario-side-editar');
      if(editarQuick){ editarQuick.addEventListener('click', () => { const u = state.selectedUsuario; if(u) showUserForm(u); }); }
      const eliminarQuick = document.getElementById('usuario-side-eliminar');
      if(eliminarQuick){ eliminarQuick.addEventListener('click', () => { const u = state.selectedUsuario; if(!u || !u.id) return; state.deleteUserId = u.id; openModal('modal-usuarios-delete'); }); }
      const verPagosQuick = document.getElementById('usuario-side-ver-pagos');
      if(verPagosQuick) verPagosQuick.addEventListener('click', verPagosDeUsuario);
      const toggleActivoQuick = document.getElementById('usuario-side-toggle-activo');
      if(toggleActivoQuick) toggleActivoQuick.addEventListener('click', toggleUsuarioActivo);
      const exportUsuariosBtn = document.getElementById('usuarios-export-csv');
      if(exportUsuariosBtn) exportUsuariosBtn.addEventListener('click', exportUsuariosCSV);
      const qrBtn = document.getElementById('usuario-side-qr');
      if(qrBtn) qrBtn.addEventListener('click', emitirQRCheckin);
      const asisBtn = document.getElementById('usuario-side-asistencia');
      if(asisBtn) asisBtn.addEventListener('click', handleAsistenciaClick);
      const qrCloseBtn = document.getElementById('qr-close-btn');
      if(qrCloseBtn) qrCloseBtn.addEventListener('click', closeQRModal);
      const qrCloseFooter = document.getElementById('qr-close-footer');
      if(qrCloseFooter) qrCloseFooter.addEventListener('click', closeQRModal);
    }

    function verPagosDeUsuario(){
      const u = state.selectedUsuario;
      if(!u){ showToast('Selecciona un usuario primero', 'warning', 4000); return; }
      const dni = String(u.dni || '').trim();
      switchTab('pagos');
      const input = document.getElementById('pagos-q');
      if(input) input.value = dni || (u.nombre || '');
      state.pagosFilters.metodo = '';
      state.pagosFilters.concepto = '';
      loadPayments();
    }

    function toggleUsuarioActivo(){
      const u = state.selectedUsuario;
      if(!u || !u.id){ showToast('Selecciona un usuario válido', 'warning', 3500); return; }
      const nombre = (document.getElementById('usuario-side-nombre').textContent || '').trim().toUpperCase();
      const dni = (document.getElementById('usuario-side-dni').textContent || '').trim();
      const telefono = (document.getElementById('usuario-side-telefono').textContent || '').trim();
      const rol = (document.getElementById('usuario-side-rol').textContent || '').trim().toLowerCase() || 'socio';
      const tipo_cuota_text = (document.getElementById('usuario-side-tipo-cuota').textContent || '').trim();
      const tipo_cuota = tipo_cuota_text || null;
      const notasText = (document.getElementById('usuario-side-notas').textContent || '').trim();
      const notas = notasText && notasText !== '—' ? notasText : null;
      if(!nombre || !dni){ showToast('Nombre y DNI son obligatorios', 'warning', 3000); return; }
      const nuevoActivo = !(u.activo === true || u.activo === 'true');
      const payload = { nombre, dni, telefono: telefono || null, pin: null, rol, activo: nuevoActivo, tipo_cuota, notas };
      fetch(`/api/usuarios/${u.id}`, { method:'PUT', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(payload) })
        .then(async res => { if(!res.ok){ const err = await res.json().catch(() => ({})); throw new Error(err.detail || err.error || `Error ${res.status}`); } return res; })
        .then(async () => { await loadUsers(); const idx = (state.usuarios || []).findIndex(x => x.id === u.id); if(idx >= 0) selectUsuarioByIndex(idx); })
        .catch(e => showToast(`No se pudo actualizar estado: ${e.message}`, 'error', 4500));
    }

    function exportUsuariosCSV(){
      const items = Array.isArray(state.usuarios) ? state.usuarios : [];
      const headers = ['Nombre','DNI','Teléfono','Rol','TipoCuota','Activo'];
      const rows = items.map(u => [
        String(u.nombre || '').trim(),
        String(u.dni || ''),
        String(u.telefono || ''),
        String((u.rol || '').toString().toLowerCase()),
        String(u.tipo_cuota ?? ''),
        String((u.activo === true || u.activo === 'true') ? 'SI' : 'NO')
      ]);
      const csv = [headers.join(','), ...rows.map(cols => cols.map(v => {
        const s = String(v ?? '');
        return /[",\n]/.test(s) ? '"' + s.replace(/"/g,'""') + '"' : s;
      }).join(','))].join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'usuarios.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    // ===== Configuración: Tipos de cuota, Conceptos y Métodos =====
    async function loadTiposCuotaAdmin(){
      try{
        const res = await fetch('/api/tipos_cuota_catalogo', { headers:{ 'Accept':'application/json' } });
        const data = await res.json();
        const rows = Array.isArray(data.items) ? data.items : (Array.isArray(data) ? data : []);
        state.configTipos = rows;
        state.configTiposMap = Object.fromEntries(rows.map(t => [String(t.id ?? t.nombre ?? ''), t]));
        renderTiposCuotaTable(rows);
      }catch(e){ console.warn('No se pudieron cargar tipos de cuota:', e); }
    }
    function renderTiposCuotaTable(rows){
      const tbody = document.querySelector('#config-tipos-table tbody');
      if(!tbody) return;
      tbody.innerHTML = '';
      (Array.isArray(rows) ? rows : []).forEach((t) => {
        const tr = document.createElement('tr');
        tr.setAttribute('data-id', String(t.id ?? ''));
        const isActivo = (t.activo === true || t.activo === 'true');
        tr.innerHTML = `
          <td>${t.nombre ?? ''}</td>
          <td>${t.precio != null ? t.precio : ''}</td>
          <td>${t.duracion_dias != null ? t.duracion_dias : ''}</td>
          <td>${isActivo ? 'Sí' : 'No'}</td>
          <td class="table-actions">
            <button class="btn" data-action="edit-tipo" data-id="${t.id ?? ''}">Editar</button>
            <button class="btn secondary" data-action="toggle-tipo-activo" data-id="${t.id ?? ''}">${isActivo ? 'Desactivar' : 'Activar'}</button>
            <button class="btn secondary" data-action="delete-tipo" data-id="${t.id ?? ''}">Borrar</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }
    function showTipoForm(t){
      state.editingTipoId = t && t.id ? t.id : null;
      document.getElementById('modal-tipo-cuota-title').textContent = t && t.id ? `Editar tipo #${t.id}` : 'Nuevo tipo de cuota';
      const nombre = document.getElementById('tipo-nombre'); if(nombre) nombre.value = t?.nombre ?? '';
      const precio = document.getElementById('tipo-precio'); if(precio) precio.value = t?.precio ?? '';
      const dur = document.getElementById('tipo-duracion'); if(dur) dur.value = t?.duracion_dias ?? '';
      const activo = document.getElementById('tipo-activo'); if(activo) activo.value = (t && (t.activo === true || t.activo === 'true')) ? 'true' : 'false';
      const desc = document.getElementById('tipo-descripcion'); if(desc) desc.value = t?.descripcion ?? '';
      const icono = document.getElementById('tipo-icono'); if(icono) icono.value = t?.icono_path ?? '';
      openModal('modal-tipo-cuota');
    }
    function hideTipoForm(){ state.editingTipoId = null; closeModal('modal-tipo-cuota'); }
    async function saveTipoCuota(){
      const nombre = (document.getElementById('tipo-nombre').value || '').trim();
      const precio = Number(document.getElementById('tipo-precio').value || '0');
      const duracion_dias = Number(document.getElementById('tipo-duracion').value || '0');
      const activoVal = document.getElementById('tipo-activo').value || 'true';
      const activo = (String(activoVal).toLowerCase() === 'true');
      const descripcion = (document.getElementById('tipo-descripcion').value || '').trim() || null;
      const icono_path = (document.getElementById('tipo-icono').value || '').trim() || null;
      if(!nombre){ showToast('El nombre es obligatorio', 'warning', 3000); return; }
      if(!(duracion_dias > 0)){ showToast('Duración debe ser mayor a 0', 'warning', 3000); return; }
      if(precio < 0){ showToast('Precio no puede ser negativo', 'warning', 3000); return; }
      let url = '/api/tipos_cuota'; let method = 'POST';
      const body = { nombre, precio, duracion_dias, activo, descripcion, icono_path };
      if(state.editingTipoId){ url = `/api/tipos_cuota/${state.editingTipoId}`; method = 'PUT'; }
      try{
        const res = await fetch(url, { method, headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(body) });
        if(!res.ok){ const err = await res.json().catch(()=>({})); showToast(err.detail || err.error || 'Error al guardar el tipo', 'error', 4500); return; }
        await res.json().catch(()=>null);
        hideTipoForm();
        showToast('Tipo de cuota guardado', 'success', 2500);
        await loadTiposCuotaAdmin();
      }catch(e){ showToast('Error de red al guardar tipo', 'error', 4500); }
    }

    async function deleteTipoCuota(id){
      if(!id) return;
      const conf = confirm('¿Eliminar tipo de cuota?'); if(!conf) return;
      try{
        const res = await fetch(`/api/tipos_cuota/${id}`, { method:'DELETE', headers:{ 'Accept':'application/json' } });
        if(!res.ok){ const err = await res.json().catch(()=>({})); showToast(err.detail || err.error || 'No se pudo eliminar', 'error', 4500); return; }
        await res.json().catch(()=>null);
        showToast('Tipo de cuota eliminado', 'success', 2500);
        await loadTiposCuotaAdmin();
      }catch(e){ showToast('Error de red al eliminar tipo', 'error', 4500); }
    }

    async function toggleTipoActivo(id){
      if(!id) return;
      const t = (state.configTipos || []).find(x => String(x.id) === String(id));
      if(!t){ showToast('Tipo no encontrado', 'warning', 3000); return; }
      const body = {
        nombre: t.nombre ?? '',
        precio: t.precio ?? 0,
        duracion_dias: t.duracion_dias ?? 0,
        activo: !(t.activo === true || t.activo === 'true'),
        descripcion: t.descripcion ?? null,
        icono_path: t.icono_path ?? null,
      };
      try{
        const res = await fetch(`/api/tipos_cuota/${id}`, { method:'PUT', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(body) });
        if(!res.ok){ const err = await res.json().catch(()=>({})); showToast(err.detail || err.error || 'No se pudo actualizar', 'error', 4500); return; }
        await res.json().catch(()=>null);
        showToast(body.activo ? 'Tipo activado' : 'Tipo desactivado', 'success', 2500);
        await loadTiposCuotaAdmin();
      }catch(e){ showToast('Error de red al actualizar tipo', 'error', 4500); }
    }

    async function loadConceptosAdmin(){
      try{
        const res = await fetch('/api/conceptos_pago', { headers:{ 'Accept':'application/json' } });
        const data = await res.json();
        const rows = Array.isArray(data.items) ? data.items : (Array.isArray(data) ? data : []);
        state.configConceptos = rows;
        renderConceptosTable(rows);
      }catch(e){ console.warn('No se pudieron cargar conceptos:', e); }
    }
    function renderConceptosTable(rows){
      const tbody = document.querySelector('#config-conceptos-table tbody'); if(!tbody) return;
      tbody.innerHTML = '';
      (Array.isArray(rows) ? rows : []).forEach(c => {
        const tr = document.createElement('tr');
        tr.setAttribute('data-id', String(c.id ?? ''));
        const isActivo = (c.activo === true || c.activo === 'true');
        const isDefaultMonthly = (String(c.nombre || '').trim().toLowerCase() === 'cuota mensual');
        const actions = `
            <button class="btn" data-action="edit-concepto" data-id="${c.id ?? ''}">Editar</button>
            <button class="btn secondary" data-action="toggle-concepto-activo" data-id="${c.id ?? ''}">${isActivo ? 'Desactivar' : 'Activar'}</button>
            ${isDefaultMonthly ? '' : `<button class="btn secondary" data-action="delete-concepto" data-id="${c.id ?? ''}">Borrar</button>`}
          `;
        tr.innerHTML = `
          <td>${c.nombre ?? ''}</td>
          <td>${c.precio_base != null ? c.precio_base : ''}</td>
          <td>${c.tipo ?? ''}</td>
          <td>${isActivo ? 'Sí' : 'No'}</td>
          <td>${c.categoria ?? ''}</td>
          <td class="table-actions">
            ${actions}
          </td>`;
        tbody.appendChild(tr);
      });
    }
    function showConceptoForm(c){
      state.editingConceptoId = c && c.id ? c.id : null;
      document.getElementById('modal-concepto-title').textContent = c && c.id ? `Editar concepto #${c.id}` : 'Nuevo concepto de pago';
      const nombre = document.getElementById('concepto-nombre'); if(nombre) nombre.value = c?.nombre ?? '';
      const precio = document.getElementById('concepto-precio-base'); if(precio) precio.value = c?.precio_base ?? '';
      const tipo = document.getElementById('concepto-tipo'); if(tipo) tipo.value = c?.tipo ?? '';
      const activo = document.getElementById('concepto-activo'); if(activo) activo.value = (c && (c.activo === true || c.activo === 'true')) ? 'true' : 'false';
      const cat = document.getElementById('concepto-categoria'); if(cat) cat.value = c?.categoria ?? '';
      const desc = document.getElementById('concepto-descripcion'); if(desc) desc.value = c?.descripcion ?? '';
      openModal('modal-concepto');
    }
    function hideConceptoForm(){ state.editingConceptoId = null; closeModal('modal-concepto'); }
    async function saveConcepto(){
      const nombre = (document.getElementById('concepto-nombre').value || '').trim();
      const precio_base = Number(document.getElementById('concepto-precio-base').value || '0');
      const tipo = (document.getElementById('concepto-tipo').value || '').trim();
      const activoVal = document.getElementById('concepto-activo').value || 'true';
      const activo = (String(activoVal).toLowerCase() === 'true');
      const categoria = (document.getElementById('concepto-categoria').value || '').trim() || null;
      const descripcion = (document.getElementById('concepto-descripcion').value || '').trim() || null;
      if(!nombre){ showToast('El nombre es obligatorio', 'warning', 3000); return; }
      if(precio_base < 0){ showToast('Precio base no puede ser negativo', 'warning', 3000); return; }
      const body = { nombre, precio_base, tipo, activo, categoria, descripcion };
      let url = '/api/conceptos_pago'; let method = 'POST';
      if(state.editingConceptoId){ url = `/api/conceptos_pago/${state.editingConceptoId}`; method = 'PUT'; }
      try{
        const res = await fetch(url, { method, headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(body) });
        if(!res.ok){ const err = await res.json().catch(()=>({})); showToast(err.detail || err.error || 'Error al guardar concepto', 'error', 4500); return; }
        await res.json().catch(()=>null);
        hideConceptoForm();
        showToast('Concepto guardado', 'success', 2500);
        await loadConceptosAdmin();
      }catch(e){ showToast('Error de red al guardar concepto', 'error', 4500); }
    }
    async function deleteConcepto(id){
      if(!id) return;
      const c = (state.configConceptos || []).find(x => String(x.id) === String(id));
      const isDefaultMonthly = c && String(c.nombre || '').trim().toLowerCase() === 'cuota mensual';
      if(isDefaultMonthly){
        showToast('No se puede eliminar el concepto "Cuota Mensual"', 'warning', 3500);
        return;
      }
      const conf = confirm('¿Eliminar concepto de pago?'); if(!conf) return;
      try{
        const res = await fetch(`/api/conceptos_pago/${id}`, { method:'DELETE', headers:{ 'Accept':'application/json' } });
        if(!res.ok){ const err = await res.json().catch(()=>({})); showToast(err.detail || err.error || 'No se pudo eliminar', 'error', 4500); return; }
        await res.json().catch(()=>null);
        showToast('Concepto eliminado', 'success', 2500);
        await loadConceptosAdmin();
      }catch(e){ showToast('Error de red al eliminar concepto', 'error', 4500); }
    }

    async function toggleConceptoActivo(id){
      if(!id) return;
      const c = (state.configConceptos || []).find(x => String(x.id) === String(id));
      if(!c){ showToast('Concepto no encontrado', 'warning', 3000); return; }
      const body = {
        nombre: c.nombre ?? '',
        precio_base: c.precio_base ?? 0,
        tipo: c.tipo ?? '',
        activo: !(c.activo === true || c.activo === 'true'),
        categoria: c.categoria ?? null,
        descripcion: c.descripcion ?? null,
      };
      try{
        const res = await fetch(`/api/conceptos_pago/${id}`, { method:'PUT', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(body) });
        if(!res.ok){ const err = await res.json().catch(()=>({})); showToast(err.detail || err.error || 'No se pudo actualizar', 'error', 4500); return; }
        await res.json().catch(()=>null);
        showToast(body.activo ? 'Concepto activado' : 'Concepto desactivado', 'success', 2500);
        await loadConceptosAdmin();
      }catch(e){ showToast('Error de red al actualizar concepto', 'error', 4500); }
    }

    async function loadMetodosAdmin(){
      try{
        const res = await fetch('/api/metodos_pago', { headers:{ 'Accept':'application/json' } });
        const data = await res.json();
        const rows = Array.isArray(data.items) ? data.items : (Array.isArray(data) ? data : []);
        state.configMetodos = rows;
        renderMetodosTable(rows);
      }catch(e){ console.warn('No se pudieron cargar métodos:', e); }
    }
    function renderMetodosTable(rows){
      const tbody = document.querySelector('#config-metodos-table tbody'); if(!tbody) return;
      tbody.innerHTML = '';
      (Array.isArray(rows) ? rows : []).forEach(m => {
        const tr = document.createElement('tr');
        const colorBadge = m.color ? `<span style=\"background:${m.color};display:inline-block;width:12px;height:12px;border-radius:3px;\"></span>` : '';
        tr.setAttribute('data-id', String(m.id ?? ''));
        const isActivo = (m.activo === true || m.activo === 'true');
        tr.innerHTML = `
          <td>${m.nombre ?? ''}</td>
          <td>${m.comision != null ? m.comision : ''}</td>
          <td>${m.color ?? ''} ${colorBadge}</td>
          <td>${isActivo ? 'Sí' : 'No'}</td>
          <td class="table-actions">
            <button class="btn" data-action="edit-metodo" data-id="${m.id ?? ''}">Editar</button>
            <button class="btn secondary" data-action="toggle-metodo-activo" data-id="${m.id ?? ''}">${isActivo ? 'Desactivar' : 'Activar'}</button>
            <button class="btn secondary" data-action="delete-metodo" data-id="${m.id ?? ''}">Borrar</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }
    function showMetodoForm(m){
      state.editingMetodoId = m && m.id ? m.id : null;
      document.getElementById('modal-metodo-title').textContent = m && m.id ? `Editar método #${m.id}` : 'Nuevo método de pago';
      const nombre = document.getElementById('metodo-nombre'); if(nombre) nombre.value = m?.nombre ?? '';
      const comision = document.getElementById('metodo-comision'); if(comision) comision.value = m?.comision ?? '';
      const color = document.getElementById('metodo-color'); if(color) color.value = m?.color ?? '';
      const activo = document.getElementById('metodo-activo'); if(activo) activo.value = (m && (m.activo === true || m.activo === 'true')) ? 'true' : 'false';
      const desc = document.getElementById('metodo-descripcion'); if(desc) desc.value = m?.descripcion ?? '';
      openModal('modal-metodo');
    }
    function hideMetodoForm(){ state.editingMetodoId = null; closeModal('modal-metodo'); }
    async function saveMetodo(){
      const nombre = (document.getElementById('metodo-nombre').value || '').trim();
      const comision = Number(document.getElementById('metodo-comision').value || '0');
      const color = (document.getElementById('metodo-color').value || '').trim() || null;
      const activoVal = document.getElementById('metodo-activo').value || 'true';
      const activo = (String(activoVal).toLowerCase() === 'true');
      const descripcion = (document.getElementById('metodo-descripcion').value || '').trim() || null;
      if(!nombre){ showToast('El nombre es obligatorio', 'warning', 3000); return; }
      if(comision < 0){ showToast('La comisión no puede ser negativa', 'warning', 3000); return; }
      const body = { nombre, comision, color, activo, descripcion };
      let url = '/api/metodos_pago'; let method = 'POST';
      if(state.editingMetodoId){ url = `/api/metodos_pago/${state.editingMetodoId}`; method = 'PUT'; }
      try{
        const res = await fetch(url, { method, headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(body) });
        if(!res.ok){ const err = await res.json().catch(()=>({})); showToast(err.detail || err.error || 'Error al guardar método', 'error', 4500); return; }
        await res.json().catch(()=>null);
        hideMetodoForm();
        showToast('Método de pago guardado', 'success', 2500);
        await loadMetodosAdmin();
      }catch(e){ showToast('Error de red al guardar método', 'error', 4500); }
    }
    async function deleteMetodo(id){
      if(!id) return; const conf = confirm('¿Eliminar método de pago?'); if(!conf) return;
      try{
        const res = await fetch(`/api/metodos_pago/${id}`, { method:'DELETE', headers:{ 'Accept':'application/json' } });
        if(!res.ok){ const err = await res.json().catch(()=>({})); showToast(err.detail || err.error || 'No se pudo eliminar', 'error', 4500); return; }
        await res.json().catch(()=>null);
        showToast('Método de pago eliminado', 'success', 2500);
        await loadMetodosAdmin();
      }catch(e){ showToast('Error de red al eliminar método', 'error', 4500); }
    }

    async function toggleMetodoActivo(id){
      if(!id) return;
      const m = (state.configMetodos || []).find(x => String(x.id) === String(id));
      if(!m){ showToast('Método no encontrado', 'warning', 3000); return; }
      const body = {
        nombre: m.nombre ?? '',
        comision: m.comision ?? 0,
        color: m.color ?? null,
        activo: !(m.activo === true || m.activo === 'true')
      };
      try{
        const res = await fetch(`/api/metodos_pago/${id}`, { method:'PUT', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify(body) });
        if(!res.ok){ const err = await res.json().catch(()=>({})); showToast(err.detail || err.error || 'No se pudo actualizar', 'error', 4500); return; }
        await res.json().catch(()=>null);
        showToast(body.activo ? 'Método activado' : 'Método desactivado', 'success', 2500);
        await loadMetodosAdmin();
      }catch(e){ showToast('Error de red al actualizar método', 'error', 4500); }
    }

    async function loadConfigData(){
      await Promise.all([loadTiposCuotaAdmin(), loadConceptosAdmin(), loadMetodosAdmin()]).catch(()=>{});
    }
    function bindConfiguracionEvents(){
      const tiposTbody = document.querySelector('#config-tipos-table tbody');
      if(tiposTbody){
        tiposTbody.addEventListener('click', (ev) => {
          const btn = ev.target.closest('button'); if(!btn) return;
          const id = btn.getAttribute('data-id'); const action = btn.getAttribute('data-action');
          if(action === 'edit-tipo'){
            const t = (state.configTipos || []).find(x => String(x.id) === String(id));
            showTipoForm(t || null);
          } else if(action === 'delete-tipo'){
            deleteTipoCuota(id);
          } else if(action === 'toggle-tipo-activo'){
            toggleTipoActivo(id);
          }
        });
      }
      const concTbody = document.querySelector('#config-conceptos-table tbody');
      if(concTbody){
        concTbody.addEventListener('click', (ev) => {
          const btn = ev.target.closest('button'); if(!btn) return;
          const id = btn.getAttribute('data-id'); const action = btn.getAttribute('data-action');
          if(action === 'edit-concepto'){
            const c = (state.configConceptos || []).find(x => String(x.id) === String(id));
            showConceptoForm(c || null);
          } else if(action === 'delete-concepto'){
            deleteConcepto(id);
          } else if(action === 'toggle-concepto-activo'){
            toggleConceptoActivo(id);
          }
        });
      }
      const metTbody = document.querySelector('#config-metodos-table tbody');
      if(metTbody){
        metTbody.addEventListener('click', (ev) => {
          const btn = ev.target.closest('button'); if(!btn) return;
          const id = btn.getAttribute('data-id'); const action = btn.getAttribute('data-action');
          if(action === 'edit-metodo'){
            const m = (state.configMetodos || []).find(x => String(x.id) === String(id));
            showMetodoForm(m || null);
          } else if(action === 'delete-metodo'){
            deleteMetodo(id);
          } else if(action === 'toggle-metodo-activo'){
            toggleMetodoActivo(id);
          }
        });
      }
      const btnTiposRefresh = document.getElementById('config-tipos-refresh'); if(btnTiposRefresh) btnTiposRefresh.addEventListener('click', loadTiposCuotaAdmin);
      const btnTiposNew = document.getElementById('config-tipos-new'); if(btnTiposNew) btnTiposNew.addEventListener('click', () => showTipoForm(null));
      const btnSaveTipo = document.getElementById('save-tipo-cuota'); if(btnSaveTipo) btnSaveTipo.addEventListener('click', saveTipoCuota);
      const btnCancelTipo = document.getElementById('cancel-tipo-cuota'); if(btnCancelTipo) btnCancelTipo.addEventListener('click', hideTipoForm);
      const btnCloseTipo = document.getElementById('close-modal-tipo-cuota'); if(btnCloseTipo) btnCloseTipo.addEventListener('click', hideTipoForm);

      const btnConcRefresh = document.getElementById('config-conceptos-refresh'); if(btnConcRefresh) btnConcRefresh.addEventListener('click', loadConceptosAdmin);
      const btnConcNew = document.getElementById('config-conceptos-new'); if(btnConcNew) btnConcNew.addEventListener('click', () => showConceptoForm(null));
      const btnSaveConc = document.getElementById('save-concepto'); if(btnSaveConc) btnSaveConc.addEventListener('click', saveConcepto);
      const btnCancelConc = document.getElementById('cancel-concepto'); if(btnCancelConc) btnCancelConc.addEventListener('click', hideConceptoForm);
      const btnCloseConc = document.getElementById('close-modal-concepto'); if(btnCloseConc) btnCloseConc.addEventListener('click', hideConceptoForm);

      const btnMetRefresh = document.getElementById('config-metodos-refresh'); if(btnMetRefresh) btnMetRefresh.addEventListener('click', loadMetodosAdmin);
      const btnMetNew = document.getElementById('config-metodos-new'); if(btnMetNew) btnMetNew.addEventListener('click', () => showMetodoForm(null));
      const btnSaveMet = document.getElementById('save-metodo'); if(btnSaveMet) btnSaveMet.addEventListener('click', saveMetodo);
      const btnCancelMet = document.getElementById('cancel-metodo'); if(btnCancelMet) btnCancelMet.addEventListener('click', hideMetodoForm);
      const btnCloseMet = document.getElementById('close-modal-metodo'); if(btnCloseMet) btnCloseMet.addEventListener('click', hideMetodoForm);
    }

    function init(){
      document.querySelectorAll('.tab').forEach(btn => {
        btn.addEventListener('click', () => {
          const tab = btn.dataset.tab;
          switchTab(tab);
          if(tab === 'pagos') loadPayments();
          if(tab === 'usuarios') loadUsers();
          if(tab === 'configuracion') loadConfigData();
        });
      });
      const { start, end } = defaultRange();
      const startEl = document.getElementById('pagos-start');
      const endEl = document.getElementById('pagos-end');
      if(startEl && !startEl.value) startEl.value = start;
      if(endEl && !endEl.value) endEl.value = end;
      document.getElementById('pagos-refresh').addEventListener('click', loadPayments);
      document.getElementById('pagos-q').addEventListener('keydown', (e) => { if(e.key === 'Enter') loadPayments(); });
      document.getElementById('pagos-limit').addEventListener('change', loadPayments);
      bindPagosEvents();
      bindUsuariosEvents();
      bindConfiguracionEvents();
      // Auto-ocultar header al hacer scroll
      const headerEl = document.getElementById('main-header');
      if(headerEl){
        let lastY = window.scrollY;
        let hidden = false;
        function onScroll(){
          const y = window.scrollY;
          if(y > lastY && y > 20){
            if(!hidden){ headerEl.classList.add('header--hidden'); hidden = true; }
          } else {
            if(hidden){ headerEl.classList.remove('header--hidden'); hidden = false; }
          }
          lastY = y;
        }
        window.addEventListener('scroll', onScroll, { passive: true });
      }
      loadPayments();
    }
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>