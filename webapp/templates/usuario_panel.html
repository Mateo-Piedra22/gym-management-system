<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel Usuario • {{ gym_name }}</title>
  <link rel="stylesheet" href="/static/style.css" />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
  <style>
    .screen { min-height: 100vh; padding: 24px; }
    .container { max-width: 1000px; margin: 0 auto; }
    .brand { display:flex; align-items:center; gap:12px; margin-bottom: 16px; }
    .brand img { width: 44px; height: 44px; }
    h1 { margin: 0; font-size: 20px; }
    .header { display:flex; align-items:center; justify-content:space-between; }
    .card { background: var(--card); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow: 0 10px 24px rgba(0,0,0,.25); }
    .cards { display:grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 16px; margin-top: 16px; }
    .muted { color: var(--muted); }
    .badge { display:inline-flex; align-items:center; gap:6px; padding: 4px 8px; border-radius: 10px; border:1px solid var(--border); }
.routine-name { margin:0; font-size:16px; line-height:1.2; max-width: 75%; overflow:hidden; text-overflow: ellipsis; display:-webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 2; line-clamp: 2; word-break: break-word; }
    .brand-actions .icon-only { display:inline-flex; align-items:center; justify-content:center; width:36px; height:36px; border-radius:10px; border:1px solid var(--border); color: var(--text); }
    .jwt-box { margin-top:10px; padding:10px; border:1px dashed var(--border); border-radius:10px; word-break: break-all; font-size:12px; }
    .status { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .chip { display:inline-flex; align-items:center; gap:6px; padding: 6px 10px; border-radius: 999px; border:1px solid var(--border); background: rgba(255,255,255,.06); }
    .chip.warn { background: rgba(199, 134, 60, .14); border-color: rgba(199,134,60,.55); }
    .chip.danger { background: rgba(255, 0, 0, .14); border-color: rgba(255,0,0,.6); }
    .chip.ok { background: rgba(166, 107, 190, .14); border-color: rgba(166,107,190,.55); }
    .chip.info { background: rgba(184, 115, 51, .14); border-color: rgba(184,115,51,.55); }
    .progress { width: 100%; height: 8px; border-radius: 999px; background: rgba(255,255,255,.08); border:1px solid var(--border); overflow: hidden; }
    .progress .bar { height: 100%; background: linear-gradient(90deg, #8e44ad, #a66bbe, #b87333); }
    .table { width: 100%; border-collapse: collapse; }
    .table th, .table td { border-bottom: 1px solid var(--border); padding: 8px; text-align: left; }
    .table th { color: var(--muted); font-weight: 600; }
    .qr-actions { display:flex; gap:8px; flex-wrap:wrap; }
    .btn { padding: 10px 12px; border-radius: 10px; border:1px solid var(--border); background: var(--card); color: var(--text); text-decoration: none; cursor: pointer; }
    .btn.primary { background: var(--accent); color: var(--text); border-color: var(--accent); }
    .reader { border:1px solid var(--border); border-radius:12px; overflow:hidden; }
    #qr-reader { width: 100%; max-width: 480px; min-height: 240px; background: rgba(255,255,255,.04); }
    .scan-results { margin-top: 12px; }
    .day { margin-top: 10px; }
    .exercise { display:flex; align-items:center; justify-content:space-between; padding:8px; border:1px solid var(--border); border-radius:10px; background: rgba(255,255,255,.04); cursor:pointer; }
    .exercise:hover { background: rgba(255,255,255,.08); }
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.6); display: none; align-items: center; justify-content: center; z-index: 50; }
    .modal { width: min(720px, 92vw); background: var(--card); border: 1px solid var(--border); border-radius: 16px; box-shadow: 0 10px 24px rgba(0,0,0,.25); }
    @media (max-width: 480px) {
      .brand { gap:10px; }
      h1 { font-size: 18px; }
      .badge { padding: 4px 8px; }
      .routine-name { max-width: 70%; }
      .table th, .table td { padding: 6px; }
      #qr-reader { max-width: 100%; min-height: 200px; }
    }
    .modal header { display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid var(--border); }
    .modal .content { padding: 16px; }
    .modal .content video, .modal .content img { width: 100%; height: auto; border-radius: 12px; }
    .sr-only { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0; }
    /* Skeleton shimmer */
    .skeleton { background: linear-gradient(90deg, #e6e6e6 0%, #f2f2f2 50%, #e6e6e6 100%); background-size: 200% 100%; animation: shimmer 1.2s infinite linear; }
    @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
    @media (prefers-reduced-motion: reduce) { .skeleton { animation: none; } }
    @media print {
      @page { size: A4 landscape; margin: 12mm; }
      .print-band { display:block; position: fixed; bottom: 0; left: 0; width: 100%; padding: 8mm 12mm; background: white; border-top: 1px solid #999; }
      .print-band-inner { display:flex; align-items:center; justify-content:space-between; gap: 12mm; }
      #print-qr { width: 40mm; height: 40mm; }
      .print-band .muted { color: #555; }
      .no-print { display:none !important; }
    }
    @media screen {
      .print-band { display:none; }
    }
  </style>
  <script src="/static/js/toast.js"></script>
  <link rel="icon" href="{{ logo_url }}" />
  <meta name="theme-color" content="{{ theme['--primary'] if theme and '--primary' in theme else '#2b8a3e' }}">
  <meta name="color-scheme" content="dark light">
  <meta name="robots" content="noindex, nofollow">
</head>
<body>
  <main class="screen">
    <div class="container">
      <div class="header">
        <div class="brand">
          <img src="{{ logo_url }}" alt="Logo" />
          <div>
            <h1>{{ gym_name }}</h1>
            <p class="muted">Panel del usuario</p>
          </div>
        </div>
        <div class="brand-actions" style="display:flex; align-items:center; gap:8px;">
          <a href="/usuario/logout" class="icon-only" title="Cerrar sesión" aria-label="Cerrar sesión">
            <i class="bi bi-box-arrow-right" aria-hidden="true"></i>
          </a>
          <a href="/" class="icon-only" title="Inicio" aria-label="Inicio">
            <i class="bi bi-house" aria-hidden="true"></i>
          </a>
        </div>
      </div>

      <section class="card" aria-labelledby="perfil-title">
<h2 id="perfil-title" style="margin:0 0 10px 0;">Hola, {{ usuario.nombre if usuario and usuario.nombre else 'Usuario' }}</h2>
        <p class="muted">Aquí verás tus rutinas activas y detalles.</p>
        <div style="display:flex; flex-wrap: wrap; gap:8px; margin-top:8px;">
          {% if activo_usuario is not none %}
            <span class="badge" aria-label="Estado del usuario">{{ 'Usuario activo' if activo_usuario else 'Usuario inactivo' }}</span>
          {% endif %}
          {% if cuotas_vencidas is not none and cuotas_vencidas|int > 0 %}
            <span class="badge" aria-label="Cuotas vencidas">{{ cuotas_vencidas }} cuotas vencidas</span>
          {% endif %}
          {% if dias_restantes is not none %}
            <span class="badge" aria-label="Días restantes">{{ dias_restantes }} días restantes</span>
          {% endif %}
        </div>
        {# JWT ocultado a pedido #}
      </section>

      <section class="card" aria-labelledby="estado-title" style="margin-top:16px;">
        <div style="display:flex; align-items:center; justify-content:space-between; gap: 8px;">
          <h3 id="estado-title" style="margin:0;">Estado de cuenta</h3>
          <div class="status" aria-live="polite">
            {% set dias = dias_restantes if dias_restantes is not none else 9999 %}
            {% set venc_badge_class = 'chip ok' %}
            {% if dias <= 0 %}
              {% set venc_badge_class = 'chip danger' %}
            {% elif dias <= 3 %}
              {% set venc_badge_class = 'chip danger' %}
            {% elif dias <= 7 %}
              {% set venc_badge_class = 'chip warn' %}
            {% endif %}
            <span class="{{ venc_badge_class }}" title="Próximo vencimiento">
              <i class="bi bi-calendar-event" aria-hidden="true"></i>
              <span>{% if proximo_vencimiento %}Vence: {{ proximo_vencimiento }}{% else %}Sin fecha de vencimiento{% endif %}</span>
            </span>
            {% if dias_restantes is not none %}
              <span class="chip" title="Días restantes"><i class="bi bi-hourglass-split" aria-hidden="true"></i>{{ dias_restantes }} días</span>
            {% endif %}
            {% if cuotas_vencidas is not none %}
              <span class="chip {{ 'danger' if cuotas_vencidas|int > 0 else '' }}" title="Cuotas vencidas"><i class="bi bi-exclamation-triangle" aria-hidden="true"></i>{{ cuotas_vencidas }} vencidas</span>
            {% endif %}
            {% if activo_usuario is not none %}
              <span class="chip {{ 'ok' if activo_usuario else 'danger' }}" title="Estado"><i class="bi bi-person-check" aria-hidden="true"></i>{{ 'Activo' if activo_usuario else 'Inactivo' }}</span>
            {% endif %}
          </div>
        </div>
        {% set ciclo = 30 %}
        {% if dias_restantes is not none %}
          {% set pct = (dias_restantes * 100 // ciclo) %}
          <div class="progress" style="margin-top:8px;" aria-hidden="true" title="Progreso del ciclo de cuota">
            <div class="bar" data-width="{{ 0 if pct < 0 else (100 if pct > 100 else pct) }}%"></div>
          </div>
        {% endif %}
        {% if dias_restantes is not none and dias_restantes|int <= 0 %}
          <p style="margin-top:8px;" class="muted"><span class="chip danger" title="Cuota vencida"><i class="bi bi-x-circle" aria-hidden="true"></i> Cuota vencida hace {{ (0 - dias_restantes)|int }} día(s)</span></p>
        {% elif dias_restantes is not none and dias_restantes|int <= 3 %}
          <p style="margin-top:8px;" class="muted"><span class="chip warn" title="Vencimiento cercano"><i class="bi bi-clock" aria-hidden="true"></i> Tu cuota vence en {{ dias_restantes }} día(s)</span></p>
        {% endif %}
        {% if ultimo_pago %}
          <p class="muted" style="margin-top:8px;">Último pago: {{ ultimo_pago }}</p>
        {% endif %}
      </section>

      <section class="card" aria-labelledby="pagos-title" style="margin-top:16px;">
        <h3 id="pagos-title" style="margin:0 0 8px 0;">Historial de pagos</h3>
        {% if pagos and pagos|length > 0 %}
          {% set total_pagos = (pagos|sum(attribute='monto')) %}
          {% set count_pagos = pagos|length %}
          {% set avg_pagos = (total_pagos / count_pagos) if count_pagos > 0 else 0.0 %}
          <div class="status" style="margin-bottom:8px; display:flex; flex-wrap:wrap; gap:8px; align-items:center;">
            <span class="chip ok" id="chip-total" title="Total pagado"><i class="bi bi-cash-coin" aria-hidden="true"></i> Total: ${{ '%.2f'|format(total_pagos) }}</span>
            <span class="chip info" id="chip-promedio" title="Promedio por pago"><i class="bi bi-graph-up" aria-hidden="true"></i> Promedio: ${{ '%.2f'|format(avg_pagos) }}</span>
            <span class="chip" id="chip-cantidad" title="Cantidad de pagos"><i class="bi bi-list-ol" aria-hidden="true"></i> Pagos: {{ count_pagos }}</span>
            <div id="metodos-summary" style="display:flex; flex-wrap:wrap; gap:8px; align-items:center;"></div>
          </div>
          <div style="overflow-x: auto;">
            <table class="table" aria-describedby="pagos-title">
              <thead>
                <tr>
                  <th scope="col">Fecha</th>
                  <th scope="col">Monto</th>
                  <th scope="col">Concepto</th>
                  <th scope="col">Método</th>
                </tr>
              </thead>
              <tbody>
                {% for p in pagos %}
                  {% set metodo_val = (p.metodo if p.metodo is defined and p.metodo else (p.metodo_pago if p.metodo_pago is defined and p.metodo_pago else (p.medio if p.medio is defined and p.medio else (p.forma if p.forma is defined and p.forma else (p.forma_pago if p.forma_pago is defined and p.forma_pago else '-'))))) %}
                  <tr>
                    <td>{{ p.fecha if p.fecha else '-' }}</td>
                    <td>${{ '%.2f'|format(p.monto if p.monto else 0.0) }}</td>
                    <td>{% if p.mes and p.anio %}Cuota {{ '%02d'|format(p.mes) }}/{{ p.anio }}{% else %}-{% endif %}</td>
                    <td>{{ metodo_val }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <div style="margin-top:12px;">
            <canvas id="pagosChart" height="80" aria-label="Gráfico de pagos" role="img"></canvas>
          </div>
        {% else %}
          <p class="muted">No hay pagos registrados aún.</p>
        {% endif %}
      </section>

      <section style="margin-top:16px;">
        <h3 style="margin:0 0 8px 0;">Tus rutinas</h3>
        {% if rutinas and rutinas|length > 0 %}
          <div class="cards">
            {% for r in rutinas %}
              <article class="card" aria-label="Rutina {{ r.nombre }}"
                data-activa="{{ 'true' if r.activa else 'false' }}"
                data-fecha-creacion="{{ r.fecha_creacion if r.fecha_creacion else '' }}"
                data-uuid-rutina="{{ r.uuid_rutina if r.uuid_rutina else '' }}"
                {% if r.activa %}
                role="button" tabindex="0" title="Tocar para desplegar lector QR" style="cursor:pointer;"
                onclick="onRutinaBadgeClick(this.getAttribute('data-activa') === 'true')"
                onkeydown="if (event.key === 'Enter' || event.key === ' ') { event.preventDefault(); onRutinaBadgeClick(this.getAttribute('data-activa') === 'true'); }"
                {% endif %}
              >
                <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:8px;">
                  <h4 class="routine-name">{{ r.nombre }}</h4>
                  <span
                    class="badge routine-badge"
                    data-activa="{{ 'true' if r.activa else 'false' }}"
                    role="{{ 'button' if r.activa else 'status' }}"
                    tabindex="{{ '0' if r.activa else '-1' }}"
                    title="{{ 'Tocar para abrir la rutina' if r.activa else 'Rutina inactiva' }}"
                    onclick="onRutinaBadgeClick(this.getAttribute('data-activa') === 'true')"
                    onkeydown="if (event.key === 'Enter' || event.key === ' ') { event.preventDefault(); onRutinaBadgeClick(this.getAttribute('data-activa') === 'true'); }"
                  >{{ 'Activa' if r.activa else 'Inactiva' }}</span>
                </div>
                <p class="muted" style="margin:8px 0 0 0;">Días: {{ r.dias }}</p>
                {% if r.ejercicios_por_dia and r.ejercicios_por_dia|length > 0 %}
                  <ul style="margin:10px 0 0 0; padding-left: 18px;">
                    {% for d, c in r.ejercicios_por_dia.items() %}
                      <li>Día {{ d }}: {{ c }} ejercicios</li>
                    {% endfor %}
                  </ul>
                {% endif %}
                <p class="muted" style="margin:10px 0 0 0;">Creada: {{ r.fecha_creacion if r.fecha_creacion else '-' }}</p>
                {# Se elimina acción directa; el acceso se realiza solo tras escanear el QR #}
              </article>
            {% endfor %}
          </div>
        {% else %}
          <div class="card">
            <p class="muted">No tienes rutinas asignadas actualmente.</p>
          </div>
        {% endif %}
      </section>

      <!-- Modal: Escaneo de QR de rutina -->
      <div class="modal-backdrop" id="qr-modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="qr-modal-title" style="display:none;">
        <div class="modal" role="document">
          <header>
            <h4 id="qr-modal-title" style="margin:0;">Escanear QR de rutina</h4>
            <button class="btn" type="button" onclick="cerrarModalQR()" aria-label="Cerrar"><i class="bi bi-x" aria-hidden="true"></i></button>
          </header>
          <div class="content">
            <div id="qr-reader-modal" class="reader" role="region" aria-label="Lector QR" aria-live="polite" style="min-height:260px"></div>
            <div id="qr-msg" class="muted" style="margin-top:8px;">Apunta la cámara al código QR de tu rutina.</div>
          </div>
        </div>
      </div>

      <!-- Resultados: Rutina escaneada -->
      <section id="rutina-scan-result" class="card no-print" aria-labelledby="rutina-scan-title" style="margin-top:16px; display:none;">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
          <h3 id="rutina-scan-title" style="margin:0;">Rutina escaneada</h3>
          {# Se elimina la acción directa; la rutina se muestra tras el escaneo exitoso #}
        </div>
        <div class="scan-results" id="scan-results" aria-live="polite"></div>
        <div id="scan-loading" class="muted" style="margin-top:8px; display:none;" aria-live="assertive" aria-busy="true">⏳ Cargando rutina…</div>
      </section>

      <div class="modal-backdrop" id="exercise-modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="exercise-modal-title">
        <div class="modal" role="document">
          <header>
            <h4 id="exercise-modal-title" style="margin:0;">Ejercicio</h4>
            <button class="btn" type="button" onclick="cerrarModalEjercicio()" aria-label="Cerrar"><i class="bi bi-x" aria-hidden="true"></i></button>
          </header>
          <div class="content">
            <h5 id="exercise-name" style="margin:0 0 8px 0;"></h5>
            <p id="exercise-desc" class="muted"></p>
            <div id="exercise-media" style="margin-top:10px;"></div>
          </div>
        </div>
      </div>

      <!-- Modal: Usuario inactivo (incerrable) -->
      <div class="modal-backdrop" id="inactive-modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="inactive-modal-title" style="display:none;">
        <div class="modal" role="document">
          <header>
            <h4 id="inactive-modal-title" style="margin:0;">Estado de cuenta</h4>
          </header>
          <div class="content">
            <p style="font-size:16px;">
              <span class="chip danger" style="font-weight:600;">
                <i class="bi bi-slash-circle" aria-hidden="true"></i>
                <span id="inactive-reason">Desactivado</span>
              </span>
            </p>
            <p class="muted">No puedes usar el panel mientras tu cuenta esté desactivada. Por favor, regulariza tu situación o contacta a administración.</p>
            <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:12px;">
              <a href="/usuario/logout" class="btn primary" aria-label="Cerrar sesión">Cerrar sesión</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <div class="print-band" aria-hidden="true">
    <div class="print-band-inner">
      <div id="print-qr" title="QR de rutina"></div>
      <div>
        <strong>{{ gym_name }}</strong>
        <div class="muted">Escanea para ver tu rutina completa</div>
      </div>
    </div>
  </div>

  <script>
    // Cargar script externo bajo demanda
    function cargarScript(src) {
      return new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = src;
        s.onload = () => resolve();
        s.onerror = () => reject(new Error('No se pudo cargar ' + src));
        document.head.appendChild(s);
      });
    }

    // Cargador resiliente de html5-qrcode con fallback a CDNs
    async function loadHtml5QrCode(){
      try {
        if (window.Html5Qrcode) return true;
        const sources = [
          '/static/libs/html5-qrcode.min.js',
          'https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/dist/html5-qrcode.min.js',
          'https://unpkg.com/html5-qrcode@2.3.8/dist/html5-qrcode.min.js'
        ];
        for (let i = 0; i < sources.length; i++){
          try { await cargarScript(sources[i]); if (window.Html5Qrcode) return true; } catch(_){ /* seguir con el próximo */ }
        }
        return !!window.Html5Qrcode;
      } catch(_) { return !!window.Html5Qrcode; }
    }

    // Precalentar permisos de cámara para asegurar el prompt del navegador
    async function prewarmCameraPermission(){
      try {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) return;
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        try { (stream.getTracks() || []).forEach(t => t.stop()); } catch(_){ }
      } catch(_){ /* si falla, igual intentaremos con Html5Qrcode */ }
    }

    // Ajustar anchos de barras de progreso desde data-attributes para evitar inline-Jinja en CSS
    (function(){
      try {
        const bars = Array.from(document.querySelectorAll('.progress .bar[data-width]'));
        bars.forEach(function(bar){
          const w = bar.getAttribute('data-width');
          if (w) { bar.style.width = String(w); }
        });
      } catch(_) { /* silencioso */ }
    })();

    let qrInstance = null;
    // Guardas para evitar múltiples disparos del mismo escaneo
    let qrScanBusy = false;
    let lastDecodedText = '';
    let lastScanTime = 0;
    // Cache de rutina para evitar recargas constantes
    let currentRoutineUuid = null;
    let currentRoutineData = null;
    let fetchInFlight = false;

    function showScanLoading(){
      const resSec = document.getElementById('rutina-scan-result');
      if (resSec) { resSec.style.display = ''; }
      const cont = document.getElementById('scan-results');
      if (cont) {
        cont.innerHTML = '';
        // Skeleton accesible para lista de días con shimmer
        const makeLine = (w) => `<div class="skeleton" style="height:14px; width:${w}%; border-radius:4px; margin:6px 0;"></div>`;
        const makeDay = () => `
          <div class="day" aria-hidden="true" style="padding:8px 0;">
            <div class="skeleton" style="height:20px; width:40%; border-radius:6px; margin-bottom:10px;"></div>
            <div>${makeLine(70)}${makeLine(60)}${makeLine(65)}${makeLine(50)}</div>
          </div>
        `;
        const skeletonWrap = document.createElement('div');
        skeletonWrap.setAttribute('aria-hidden', 'true');
        skeletonWrap.innerHTML = `${makeDay()}${makeDay()}${makeDay()}`;
        cont.appendChild(skeletonWrap);
      }
      const load = document.getElementById('scan-loading');
      if (load) { load.style.display = ''; }
    }
    function hideScanLoading(){
      const load = document.getElementById('scan-loading');
      if (load) { load.style.display = 'none'; }
    }
    async function activarLectorQR(){
      const activarBtn = document.getElementById('btn-activar-lector');
      const detenerBtn = document.getElementById('btn-detener-lector');
      try {
        if (!window.Html5Qrcode) { await loadHtml5QrCode(); }
        const readerElem = document.getElementById('qr-reader');
        if (!readerElem) return;
        await prewarmCameraPermission();
        qrInstance = new Html5Qrcode('qr-reader');
        activarBtn.disabled = true;
        detenerBtn.disabled = false;
        const config = { fps: 10, qrbox: { width: 280, height: 280 }, aspectRatio: 1.0 }; 
        const cameras = await Html5Qrcode.getCameras();
        let cameraId;
        if (cameras && cameras.length) {
          const rear = cameras.find(function(c){ return /back|rear/i.test(c.label); });
          cameraId = rear ? rear.id : cameras[0].id;
        }
        await qrInstance.start(
          cameraId || { facingMode: "environment" },
          config,
          (decodedText) => onScanSuccess(decodedText),
          (err) => { /* Ignorar errores de escaneo continuo */ }
        );
      } catch (e) {
        if (typeof window.showToast === 'function') { showToast('No se pudo activar el lector QR', 'error', 4500); }
        console.error(e);
      }
    }

    async function detenerLectorQR(){
      try {
        const activarBtn = document.getElementById('btn-activar-lector');
        const detenerBtn = document.getElementById('btn-detener-lector');
        detenerBtn.disabled = true;
        if (qrInstance) {
          await qrInstance.stop();
          await qrInstance.clear();
          qrInstance = null;
        }
        activarBtn.disabled = false;
      } catch (e) {
        console.error(e);
      }
    }

    // Modal QR: abrir/cerrar y activar lector dentro del modal
    async function activarLectorQRModal(){
      try {
        if (!window.Html5Qrcode) { await loadHtml5QrCode(); }
        const readerElem = document.getElementById('qr-reader-modal');
        if (!readerElem) return;
        if (qrInstance) { try { await qrInstance.stop(); await qrInstance.clear(); } catch(_){} }
        await prewarmCameraPermission();
        qrInstance = new Html5Qrcode('qr-reader-modal');
        const config = { fps: 10, qrbox: 260, aspectRatio: 1.0, rememberLastUsedCamera: true };
        const cameras = await Html5Qrcode.getCameras();
        let cameraId;
        if (cameras && cameras.length) {
          const rear = cameras.find(function(c){ return /back|rear/i.test(c.label); });
          cameraId = rear ? rear.id : cameras[0].id;
        }
        await qrInstance.start(
          cameraId || { facingMode: "environment" },
          config,
          (decodedText) => onScanSuccess(decodedText),
          (err) => { /* Ignorar errores de escaneo continuo */ }
        );
        const msgEl = document.getElementById('qr-msg');
        if (msgEl) { msgEl.textContent = 'Escaneando…'; }
      } catch (e) {
        const msgEl = document.getElementById('qr-msg');
        if (msgEl) {
          msgEl.textContent = 'No se pudo activar la cámara. Revisá permisos.';
        }
        if (typeof window.showToast === 'function') { showToast('No se pudo activar el lector QR', 'error', 4500); }
        console.error(e);
      }
    }

    function abrirModalQR(){
      const bd = document.getElementById('qr-modal-backdrop');
      if (!bd) return;
      bd.style.display = 'flex';
      const titleEl = document.getElementById('qr-modal-title');
      if (titleEl){ try { titleEl.setAttribute('tabindex','-1'); titleEl.focus(); } catch(_){ } }
      bd.addEventListener('click', (ev) => { if (ev.target === bd) cerrarModalQR(); });
      document.addEventListener('keydown', onEscCloseQR);
      activarLectorQRModal();
    }
    async function cerrarModalQR(){
      await detenerLectorQR();
      const bd = document.getElementById('qr-modal-backdrop');
      if (bd) { bd.style.display = 'none'; }
      document.removeEventListener('keydown', onEscCloseQR);
    }
    function onEscCloseQR(ev){ if (ev.key === 'Escape') cerrarModalQR(); }

    function extraerUuidYTipo(desde){
      const s = String(desde);
      // Aceptar QR real y preview
      const mReal = s.match(/\/api\/rutinas\/qr_scan\/(\w[\w-]+)/);
      if (mReal && mReal[1]) return { uuid: mReal[1], preview: false };
      const mPrev = s.match(/\/api\/rutinas\/preview\/qr_scan\/(\w[\w-]+)/);
      if (mPrev && mPrev[1]) return { uuid: mPrev[1], preview: true };
      // También aceptar un UUID puro
      const isUuid = /^[0-9a-fA-F-]{8,}$/.test(s);
      if (isUuid) return { uuid: s, preview: false };
      return { uuid: null, preview: false };
    }

    async function onScanSuccess(decodedText){
      const s = String(decodedText || '');
      const now = Date.now();
      // Evitar múltiples callbacks del mismo QR en ventana de 3s
      if (qrScanBusy) return;
      if (s === lastDecodedText && (now - lastScanTime) < 3000) return;
      lastDecodedText = s;
      lastScanTime = now;
      qrScanBusy = true;
      const isAbsolute = /^https?:\/\//i.test(s);
      const { uuid, preview } = extraerUuidYTipo(s);
      if (!uuid){
        if (typeof window.showToast === 'function') { showToast('QR inválido para rutina', 'warning', 3500); }
        qrScanBusy = false;
        return;
      }
      try {
        // Detener y cerrar el modal tras un escaneo válido para evitar duplicados
        await cerrarModalQR();
        showScanLoading();

        // Si ya tenemos la misma rutina cargada, no refetch y renderizamos cache
        if (uuid === currentRoutineUuid && currentRoutineData) {
          renderRutina(currentRoutineData);
          return;
        }

        if (fetchInFlight) { return; }
        fetchInFlight = true;

        // Normalizar URL: si es absoluta y de otro origen, usar ruta local
        let url = '';
        if (isAbsolute) {
          try {
            const abs = new URL(s, window.location.href);
            const pathMatch = abs.pathname.match(/\/api\/rutinas\/(preview\/)?qr_scan\/([\w-]+)/);
            if (abs.origin !== window.location.origin && pathMatch) {
              url = pathMatch[0];
            } else {
              url = abs.href;
            }
          } catch (_) {
            url = preview ? `/api/rutinas/preview/qr_scan/${uuid}` : `/api/rutinas/qr_scan/${uuid}`;
          }
        } else {
          url = preview ? `/api/rutinas/preview/qr_scan/${uuid}` : `/api/rutinas/qr_scan/${uuid}`;
        }

        const res = await fetch(url, { credentials: 'include' });
        const data = await res.json();
        if (!data.ok){
          if (typeof window.showToast === 'function') { showToast(data.error || 'No se pudo obtener la rutina', 'error', 4500); }
          return;
        }
        currentRoutineUuid = uuid;
        currentRoutineData = data.rutina;
        renderRutina(currentRoutineData);
      } catch (e){
        if (typeof window.showToast === 'function') { showToast('Error cargando rutina', 'error', 4500); }
        console.error(e);
      } finally {
        hideScanLoading();
        qrScanBusy = false;
        fetchInFlight = false;
      }
    }

    function onRutinaBadgeClick(esActiva){
      if (!esActiva){ if (typeof window.showToast === 'function') { showToast('Esta rutina está inactiva', 'info', 3000); } return; }
      abrirModalQR();
    }

    function renderRutina(rutina){
      const resSec = document.getElementById('rutina-scan-result');
      if (resSec) { resSec.style.display = ''; }
      const cont = document.getElementById('scan-results');
      if (!cont) return;
      hideScanLoading();
      cont.innerHTML = '';
      const h = document.createElement('h4');
      h.textContent = String(rutina.nombre_rutina || rutina.nombre || 'Rutina');
      h.style.marginBottom = '8px';
      cont.appendChild(h);
      const dias = Array.isArray(rutina.dias) ? rutina.dias : [];
      // Grid móvil-friendly por días
      const grid = document.createElement('div');
      grid.style.display = 'grid';
      grid.style.gap = '8px';
      grid.style.gridTemplateColumns = 'repeat(auto-fit, minmax(240px, 1fr))';
      dias.forEach(d => {
        const card = document.createElement('div');
        card.className = 'card';
        card.style.display = 'flex';
        card.style.flexDirection = 'column';
        card.style.gap = '8px';
        const head = document.createElement('div');
        head.style.display = 'flex';
        head.style.alignItems = 'center';
        head.style.justifyContent = 'space-between';
        head.style.gap = '8px';
        const title = document.createElement('strong');
        title.textContent = String(d.nombre || `Día ${d.numero}`);
        const ejercicios = Array.isArray(d.ejercicios) ? d.ejercicios : [];
        const count = document.createElement('span');
        count.textContent = `${ejercicios.length} ejercicios`;
        count.className = 'muted';
        head.appendChild(title);
        head.appendChild(count);
        card.appendChild(head);

        if (ejercicios.length === 0){
          const empty = document.createElement('p');
          empty.className = 'muted';
          empty.textContent = 'Sin ejercicios en este día';
          card.appendChild(empty);
        } else {
          const list = document.createElement('div');
          list.style.display = 'flex';
          list.style.flexDirection = 'column';
          list.style.gap = '6px';
          ejercicios.forEach(e => {
            const tile = document.createElement('div');
            tile.style.display = 'flex';
            tile.style.alignItems = 'center';
            tile.style.justifyContent = 'space-between';
            tile.style.gap = '8px';
            tile.style.padding = '8px 10px';
            tile.style.border = '1px solid var(--border)';
            tile.style.borderRadius = '10px';
            tile.style.background = 'var(--card)';
            tile.setAttribute('role','button');
            tile.setAttribute('tabindex','0');
            tile.setAttribute('aria-label', `Ver ejercicio ${String(e.nombre || 'Ejercicio')}`);
            const left = document.createElement('div');
            left.style.display = 'flex';
            left.style.flexDirection = 'column';
            left.style.gap = '2px';
            const n = document.createElement('div');
            n.textContent = String(e.nombre || 'Ejercicio');
            n.style.fontWeight = '600';
            const meta = document.createElement('div');
            meta.className = 'muted';
            const s = String(e.series || '-');
            const r = String(e.repeticiones || '-');
            meta.textContent = (s !== '-' && r !== '-') ? `${s} series · ${r} reps` : (s !== '-' ? `${s} series` : (r !== '-' ? `${r} reps` : '')); 
            left.appendChild(n);
            left.appendChild(meta);
            const action = document.createElement('button');
            action.className = 'btn';
            action.textContent = 'Ver';
            action.setAttribute('aria-label', `Ver ${String(e.nombre || 'Ejercicio')}`);
            action.addEventListener('click', (ev) => { ev.stopPropagation(); abrirModalEjercicio(e); });
            tile.addEventListener('click', () => abrirModalEjercicio(e));
            tile.addEventListener('keydown', (ev) => { if (ev.key === 'Enter' || ev.key === ' ') { ev.preventDefault(); abrirModalEjercicio(e); } });
            tile.appendChild(left);
            tile.appendChild(action);
            list.appendChild(tile);
          });
          card.appendChild(list);
        }
        grid.appendChild(card);
      });
      cont.appendChild(grid);
    }

    function abrirModalEjercicio(ej){
      const bd = document.getElementById('exercise-modal-backdrop');
      const name = document.getElementById('exercise-name');
      const desc = document.getElementById('exercise-desc');
      const media = document.getElementById('exercise-media');
      const titleEl = document.getElementById('exercise-modal-title');
      // Título en barra superior
      titleEl.textContent = String(ej.nombre || 'Ejercicio');
      // No duplicar título dentro del contenido
      name.textContent = '';
      desc.textContent = String(ej.descripcion || '');
      media.innerHTML = '';
      const url = ej.video_url;
      if (url && /\.gif(\?.*)?$/.test(url)){
        const img = document.createElement('img');
        img.src = url;
        img.alt = 'Animación del ejercicio';
        img.className = 'responsive-media';
        img.style.maxHeight = '280px';
        media.appendChild(img);
      } else if (url){
        const v = document.createElement('video');
        v.src = url;
        v.controls = true; v.playsInline = true; v.preload = 'metadata';
        v.setAttribute('controlsList','nodownload noplaybackrate');
        v.className = 'responsive-media';
        v.style.maxHeight = '280px';
        media.appendChild(v);
      } else {
        const p = document.createElement('p'); p.className = 'muted'; p.textContent = 'Sin video disponible'; media.appendChild(p);
      }
      // Asegurar que descripción vaya debajo del video y con separación
      desc.style.marginTop = '12px';
      bd.classList.add('active');
      if (titleEl){ try { titleEl.setAttribute('tabindex','-1'); titleEl.focus(); } catch(_){ } }
      bd.addEventListener('click', (ev) => { if (ev.target === bd) cerrarModalEjercicio(); });
      document.addEventListener('keydown', onEscClose);
    }
    function cerrarModalEjercicio(){
      const bd = document.getElementById('exercise-modal-backdrop');
      const m = bd ? bd.querySelector('.modal') : null;
      if(m){
        m.classList.add('closing');
        setTimeout(() => { bd.classList.remove('active'); m.classList.remove('closing'); }, 160);
      } else {
        bd.classList.remove('active');
      }
      document.removeEventListener('keydown', onEscClose);
    }
    function onEscClose(ev){ if (ev.key === 'Escape') cerrarModalEjercicio(); }

    // Banda de impresión: generar QR de rutina activa SOLO al imprimir para evitar intentos de carga innecesarios
    (function(){
      const data = "{{ rutina_activa_qr_url if rutina_activa_qr_url else '' }}";
      if (!data) return;
      async function ensureQrLib(){
        try { if (!window.QRCode) { await cargarScript('/static/libs/qrcode.min.js'); } } catch(_){ /* silencioso */ }
      }
      function renderQR(){
        try {
          const target = document.getElementById('print-qr');
          if (target && window.QRCode){ new QRCode(target, { text: String(data), width: 152, height: 152 }); }
        } catch(_){ /* silencioso */ }
      }
      // Cargar y renderizar al comenzar la impresión
      window.addEventListener('beforeprint', async function(){ try { await ensureQrLib(); renderQR(); } catch(_){} });
    })();
  </script>
  <script>
    // Clasificar rutinas por fecha relativa: la(s) más reciente(s) se quedan "Activa" si el flag lo indica;
    // el resto pasa a "Antigua" (si originalmente activa) o "Inactiva" (si originalmente inactiva).
    (function(){
      try{
        const cards = Array.from(document.querySelectorAll('article.card[data-activa]'));
        const times = cards.map(card => {
          const d = parseFecha(card.getAttribute('data-fecha-creacion') || '');
          return d ? d.getTime() : null;
        }).filter(t => typeof t === 'number');
        if (times.length === 0) return;
        const latest = Math.max.apply(null, times);
        cards.forEach(card => {
          const origActive = (card.getAttribute('data-activa') === 'true');
          const fc = card.getAttribute('data-fecha-creacion') || '';
          const d = parseFecha(fc);
          const isLatest = d ? (d.getTime() === latest) : false;
          const activeNow = origActive && isLatest;
          card.setAttribute('data-activa', activeNow ? 'true' : 'false');
          const badge = card.querySelector('.routine-badge');
          if(badge){
            badge.setAttribute('data-activa', activeNow ? 'true' : 'false');
            const label = activeNow ? 'Activa' : 'Inactiva';
            badge.textContent = label;
            badge.setAttribute('title', activeNow ? 'Tocar para abrir la rutina' : 'Rutina inactiva');
            badge.setAttribute('role', activeNow ? 'button' : 'status');
            badge.setAttribute('tabindex', activeNow ? '0' : '-1');
          }
          if(activeNow){
            card.setAttribute('role','button');
            card.setAttribute('tabindex','0');
            card.style.cursor = 'pointer';
          } else {
            card.removeAttribute('role');
            card.removeAttribute('tabindex');
            card.style.cursor = '';
          }
        });

        // Ordenar visualmente por fecha de creación (más nuevas primero)
        const wrap = document.querySelector('.cards');
        if (wrap) {
          const items = Array.from(wrap.children).filter(el => el.matches('article.card'));
          items.sort((a, b) => {
            const da = parseFecha(a.getAttribute('data-fecha-creacion') || '');
            const db = parseFecha(b.getAttribute('data-fecha-creacion') || '');
            const ta = da ? da.getTime() : 0;
            const tb = db ? db.getTime() : 0;
            return tb - ta; // más nuevas primero
          });
          items.forEach(el => wrap.appendChild(el));
        }
      }catch(e){ console.error(e); }
      function parseFecha(s){
        try{
          const str = String(s).trim();
          if(!str) return null;
          // Aceptar formatos comunes: 'YYYY-MM-DD', 'YYYY-MM-DDTHH:mm:ss', 'DD/MM/YYYY'
          const m = str.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
          if(m){
            const d = new Date(Number(m[3]), Number(m[2]) - 1, Number(m[1]));
            return isNaN(d.getTime()) ? null : d;
          }
          const d = new Date(str);
          return isNaN(d.getTime()) ? null : d;
        }catch(_){ return null; }
      }
    })();
    // (sin controles de activación en panel de usuario)
  </script>
  <script>
    // Mostrar modal incerrable si el usuario está inactivo
    (function(){
      try {
        var activo = "{{ 'true' if activo_usuario else 'false' }}" === "true";
        var cuotasVencidas = parseInt("{{ (cuotas_vencidas|int) if cuotas_vencidas is not none else 0 }}", 10) || 0;
        if (!activo) {
          var reason = (cuotasVencidas >= 3) ? "Desactivado por falta de pagos (3 o más cuotas vencidas)" : "Desactivado por administración";
          var txtEl = document.getElementById('inactive-reason');
          if (txtEl) txtEl.textContent = reason;
          var mb = document.getElementById('inactive-modal-backdrop');
          if (mb) {
            mb.style.display = 'flex';
            // Bloquear cierre por Escape o clic de fondo
            mb.addEventListener('click', function(e){
              if (e.target === mb) { e.preventDefault(); e.stopPropagation(); }
            }, {capture:true});
            document.addEventListener('keydown', function(e){ if (e.key === 'Escape') { e.preventDefault(); e.stopPropagation(); } }, true);
          }
        }
      } catch (e) {}
    })();
    // Gráfico de pagos: sparkline de área/linea con paleta lila/copper
    (function(){
      try {
        var pagosSection = document.getElementById('pagos-title');
        var tbl = pagosSection ? pagosSection.closest('section').querySelector('table') : null;
        var rows = tbl ? Array.from(tbl.querySelectorAll('tbody tr')) : [];
        var data = rows.map(function(r){
          var cell = (r && r.children && r.children.length > 1) ? r.children[1] : null;
          var montoTxt = (cell && cell.textContent) ? cell.textContent : '';
          var monto = parseFloat(String(montoTxt).replace('$','').trim());
          return isNaN(monto) ? 0 : monto;
        });
        var canvas = document.getElementById('pagosChart');
        if (canvas && data.length > 0) {
          var ctx = canvas.getContext('2d');
          var W = canvas.width = Math.max(300, canvas.offsetWidth);
          var H = canvas.height;
          var pad = 12;
          var maxV = Math.max.apply(null, data);
          var minV = Math.min.apply(null, data);
          var range = maxV - minV;
          var hasRange = range > 0;
          var stepX = (W - pad*2) / Math.max(1, data.length - 1);
          ctx.clearRect(0,0,W,H);

          // Fondo suave
          ctx.fillStyle = 'rgba(255,255,255,0.04)';
          ctx.fillRect(0,0,W,H);

          // Línea base
          ctx.strokeStyle = 'rgba(255,255,255,.2)';
          ctx.beginPath();
          ctx.moveTo(pad, H - pad);
          ctx.lineTo(W - pad, H - pad);
          ctx.stroke();

          // Gradiente área
          var grad = ctx.createLinearGradient(0, pad, 0, H - pad);
          grad.addColorStop(0, 'rgba(142, 68, 173, 0.35)');
          grad.addColorStop(1, 'rgba(184, 115, 51, 0.15)');

          // Trazo línea
          ctx.lineWidth = 2;
          ctx.strokeStyle = '#8e44ad';
          ctx.beginPath();
          for (var i = 0; i < data.length; i++) {
            var v = data[i];
            var x = pad + i * stepX;
            var pct = hasRange ? (v - minV) / range : 0.5; // si todos iguales, dibujar a mitad de altura
            var y = pad + (H - pad*2) * (1 - pct);
            if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
          }
          ctx.stroke();

          // Puntos en cada pago para mejorar legibilidad
          for (var k = 0; k < data.length; k++) {
            var vv_pt = data[k];
            var xx_pt = pad + k * stepX;
            var pct_pt = hasRange ? (vv_pt - minV) / range : 0.5;
            var yy_pt = pad + (H - pad*2) * (1 - pct_pt);
            ctx.beginPath();
            ctx.fillStyle = '#b87333'; // copper
            ctx.arc(xx_pt, yy_pt, 2.5, 0, Math.PI * 2);
            ctx.fill();
          }

          // Área bajo la línea
          ctx.fillStyle = grad;
          ctx.beginPath();
          for (var j = 0; j < data.length; j++) {
            var vv = data[j];
            var xx = pad + j * stepX;
            var pctA = hasRange ? (vv - minV) / range : 0.5;
            var yy = pad + (H - pad*2) * (1 - pctA);
            if (j === 0) ctx.moveTo(xx, yy); else ctx.lineTo(xx, yy);
          }
          ctx.lineTo(pad + (data.length - 1) * stepX, H - pad);
          ctx.lineTo(pad, H - pad);
          ctx.closePath();
          ctx.fill();
        }
      } catch (e) {}
    })();
    // Fallback: recalcular y actualizar chips de Total/Promedio/Cantidad desde la tabla para evitar 0.00
    (function(){
      try {
        var pagosSection = document.getElementById('pagos-title');
        var tbl = pagosSection ? pagosSection.closest('section').querySelector('table') : null;
        var rows = tbl ? Array.from(tbl.querySelectorAll('tbody tr')) : [];
        if (!rows.length) return;
        var sum = 0, count = 0;
        rows.forEach(function(r){
          var amtCell = (r && r.children && r.children.length > 1) ? r.children[1] : null;
          var txt = amtCell ? String(amtCell.textContent || '').replace('$','').trim() : '0';
          var v = parseFloat(txt);
          if (!isNaN(v)) { sum += v; count += 1; }
        });
        var avg = count > 0 ? (sum / count) : 0;
        var chipT = document.getElementById('chip-total');
        var chipP = document.getElementById('chip-promedio');
        var chipC = document.getElementById('chip-cantidad');
        if (chipT) chipT.innerHTML = '<i class="bi bi-cash-coin" aria-hidden="true"></i> Total: $' + sum.toFixed(2);
        if (chipP) chipP.innerHTML = '<i class="bi bi-graph-up" aria-hidden="true"></i> Promedio: $' + avg.toFixed(2);
        if (chipC) chipC.innerHTML = '<i class="bi bi-list-ol" aria-hidden="true"></i> Pagos: ' + String(count);
      } catch(e) {}
    })();
  </script>
  <script>
    // Resumen por método de pago (dinámico basado en tabla)
    (function(){
      try {
        var pagosSection = document.getElementById('pagos-title');
        var tbl = pagosSection ? pagosSection.closest('section').querySelector('table') : null;
        var rows = tbl ? Array.from(tbl.querySelectorAll('tbody tr')) : [];
        var totalsByMethod = {};
        rows.forEach(function(r){
          var methodCell = (r && r.children && r.children.length > 3) ? r.children[3] : null;
          var amountCell = (r && r.children && r.children.length > 1) ? r.children[1] : null;
          var m = methodCell ? String(methodCell.textContent || '').trim() : '';
          var amtTxt = amountCell ? String(amountCell.textContent || '').replace('$','').trim() : '0';
          var amt = parseFloat(amtTxt);
          if (isNaN(amt)) amt = 0;
          var key = m || 'Sin método';
          totalsByMethod[key] = (totalsByMethod[key] || 0) + amt;
        });
        var container = document.getElementById('metodos-summary');
        if (container) {
          container.innerHTML = '';
          Object.keys(totalsByMethod).sort().forEach(function(k){
            var chip = document.createElement('span');
            chip.className = 'chip info';
            chip.title = 'Total por método';
            chip.innerHTML = '<i class="bi bi-wallet2" aria-hidden="true"></i> ' + k + ': $' + totalsByMethod[k].toFixed(2);
            container.appendChild(chip);
          });
        }
      } catch(e) {}
    })();
  </script>
</body>
</html>
